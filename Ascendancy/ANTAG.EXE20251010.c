/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Watcom C++
*/

#include <math.h>
#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

void __noreturn sub_10000(); // weak
void __fastcall Q_BATCON_CPP_sub_10010(PANE *pane, int, int, int);
void __fastcall Q_BATCON_CPP_sub_10668(PANE *pane, char *a2, int powerState, int a4);
int __fastcall sub_10878(PANE *pPane, int a2, int a3, int a4);
int __fastcall Q_CompareListBoxItems_sub_10A14(P_ListBoxItem item1, P_ListBoxItem item2);
void __fastcall __spoils<> Q_Wnd19BC_Ctor_sub_10A3C(P_Wnd19BC pWnd19BC);
void __fastcall __spoils<edx> Q_Wnd19BC_Dtor_sub_10A80(P_Wnd19BC a1, char a2);
void __fastcall __spoils<> Q_Wnd19BC_Init_sub_10AC4(P_Wnd19BC a1);
int __fastcall Q_Wnd19BC_Proc3_sub_10B24(P_Wnd19BC pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd19BC_Proc4_sub_11870(P_Wnd19BC pWnd, int a2);
int __fastcall sub_11BA4(P_Wnd19BC pWnd19BC);
int __fastcall sub_12140(P_Wnd19BC pWnd19BC);
void __fastcall sub_12238(P_Wnd19BC pWnd19BC, int a2);
void __fastcall sub_1229C(P_Wnd19BC pWnd19BC, int a2);
int __fastcall sub_12368(P_Wnd19BC pWnd19BC, int a2);
void __fastcall sub_1240C(int, int);
char *__fastcall sub_12440(char *result);
int __fastcall sub_12480(float *, float *, float);
unsigned int __fastcall sub_12618(T_BatDisplayItem *);
void __fastcall sub_12674(P_Wnd04BM a1);
// T_Wnd04BM *__usercall sub_126F8@<eax>(T_Wnd04BM *@<eax>, int sfx2@<edx>, int@<ebp>);
P_BatDisplayItem __fastcall sub_12AE4(P_Wnd04BM pWnd04BM, P_TargetObject a2);
void __fastcall sub_12B4C(int, int);
unsigned int __fastcall sub_12C98(P_Wnd04BM a1, int a2, int a3);
unsigned int __fastcall sub_12E88(int);
// int __usercall sub_12F7C@<eax>(int@<eax>, int ebp0@<ebp>);
unsigned int __fastcall sub_13370(int, int, int);
unsigned int __fastcall sub_136C4(int);
unsigned int __fastcall sub_1380C(int);
void __fastcall sub_139E0(P_Wnd04BM a1, P_BatDisplayItem a2);
void __fastcall sub_13A28(P_Wnd04BM a1, P_BatDisplayItem a2);
void __fastcall sub_13AD8(P_Wnd04BM a1, P_BatDisplayItem a2);
void __fastcall __spoils<> Q_Vector3D_Copy_sub_13BC0(P_Vector3D dst, P_Vector3D src);
void __fastcall __spoils<> Q_Vector3D_Ctor_sub_13BF0(P_Vector3D a1);
unsigned int __fastcall sub_13C10(P_Wnd04BM pWnd04BM);
unsigned int __fastcall sub_14224(T_Wnd04BM *);
int __fastcall sub_142D8(int);
int __fastcall sub_14490(int);
unsigned int __fastcall sub_145C0(int);
unsigned int __fastcall sub_147CC(int);
unsigned int __fastcall sub_14B18(int, int, int);
unsigned int __fastcall sub_15078(T_Wnd04BM *);
unsigned int __fastcall sub_15164(int);
unsigned int __fastcall sub_152E4(int, int, int, int);
void __fastcall sub_15630(P_Wnd04BM a1, P_BatDisplayItem a2);
void __fastcall sub_156C0(P_BatDisplayItem a1, int a2, unsigned __int16 shpNum);
void __fastcall __spoils<> sub_1577C(T_Wnd04BMt3 *a1);
void __fastcall __spoils<> sub_15788(T_Wnd04BMt3 *result);
int __fastcall sub_15794(int result, int);
int __fastcall sub_157B4(P_Target a1, P_Target a2); // idb
void __fastcall sub_157EC(P_Wnd04BMt3 a1);
P_Target __fastcall sub_15808(P_Wnd04BMt3 a1, int a2, int a3);
int __fastcall sub_15948(P_Wnd04BMt3 a1, P_Wnd04BM a2);
void __fastcall __spoils<> sub_15D20(T_Wnd04BMt1 *a1);
void __fastcall __spoils<> sub_15D2C(T_Wnd04BMt1 *result);
int __fastcall sub_15D38(int result, const void *);
void __fastcall sub_15D74(P_Wnd04BMt1 a1, P_Wnd04BM a2);
void __fastcall sub_15DA4(P_Wnd04BMt1 a1, P_Wnd04BM a2, unsigned __int16 a3);
void __fastcall sub_15E1C(P_Wnd04BMt1 a1, P_Wnd04BM pWnd4BM);
void __fastcall __spoils<> Q_Wnd04BM_Ctor_sub_15ED4(P_Wnd04BM);
void __fastcall __spoils<edx> Q_Wnd04BM_Dtor_sub_1604C(P_Wnd04BM self, unsigned int a2);
int __fastcall Q_Wnd04BM_LoadBatfxTxt_sub_16120(P_Wnd04BM pWnd);
int __fastcall Q_Wnd04BM_Proc3_sub_16348(P_Wnd04BM pWnd, UWORD message, int param1, int param2);
void __fastcall sub_16D6C(P_Wnd04BM pWnd, int param1, int param2, int a4);
void __fastcall sub_16FC0(P_Wnd04BM pWnd04BM, int a2, int a3);
void __fastcall sub_171D0(int, int, int);
void __fastcall sub_17204(P_Wnd04BM pWnd, int a2, int a3);
void __fastcall sub_17260(P_Wnd04BM pWnd);
void __fastcall sub_172B0(P_Wnd04BM pWnd04BM);
int __fastcall sub_173F4(P_Wnd04BM pWnd04BM);
int __fastcall sub_17430(P_Wnd04BM pWnd04BM);
void __fastcall sub_17E50(P_Wnd04BM pWnd, int a2);
void __fastcall Q_Wnd04BM_SetTargetPosition_sub_17E88(P_Wnd04BM pWnd04BM, P_Target pTarget);
void __fastcall sub_17F54(P_Wnd04BM a1);
void __fastcall sub_17FF0(P_Wnd04BM a1);
void __fastcall sub_181F0(P_Wnd04BM a1);
void __fastcall sub_1826C(P_Wnd04BM a1, P_BatDisplayItem a2, unsigned __int16 a3, unsigned __int16 a4);
void __fastcall sub_182B8(P_Wnd04BM a1, int a2);
unsigned int __fastcall sub_18370(P_Wnd04BM pWnd);
void __fastcall sub_185CC(P_Wnd04BM pWnd4BM);
void __fastcall sub_186B8(P_Wnd04BM pWnd4BM, int a2, int a3);
int __fastcall sub_187EC(P_Wnd04BM a1);
void __fastcall sub_18C2C(P_Wnd04BM pWnd04BM, int a2);
void __fastcall Q_Wnd04BM_Proc4_sub_18CA8(P_Wnd04BM pWnd, int a2);
void __fastcall sub_1936C(P_Wnd04BM pWnd4BM);
void __fastcall sub_19AE8(P_Wnd04BM a1);
void __fastcall Q_Wnd04BM_Proc6_sub_19E2C(P_Wnd04BM pWnd, P_CFile pfi, BOOL read);
void __fastcall __spoils<edx> sub_1A9C0(void *result);
void __fastcall __spoils<edx> Q_DestructVectors_sub_1A9E0(P_Vector3D a1);
void __fastcall __spoils<edx> sub_1AA00(void *result);
void *__fastcall Q_NC_sub_1AA20(void *result);
void __fastcall Q_Type16_Copy_sub_1AA40(P_Type16 dst, P_Type16 src);
void __fastcall __spoils<edx> sub_1AA90(P_Type1 self, unsigned int a2);
P_Type1 __fastcall sub_1AAC0(P_Type1 result);
void __fastcall __spoils<> Q_Type16_Ctor_sub_1ABE0(P_Type16 a1);
void __fastcall Q_Vector3D_FromInt_sub_1AC70(P_Vector3D a1, int x, int y, int z);
void __fastcall Q_Vector3D_Clear_sub_1ACA0(P_Vector3D a1);
void __fastcall __spoils<> Q_Cache_Init_sub_1ACC0(P_Cache a1);
void __fastcall __spoils<> Q_Cache_Lock_sub_1ACE8(P_Cache a1);
void __fastcall __spoils<> sub_1ACF4(P_Cache a1);
void __fastcall Q_Cache_RegisterShapeCache_sub_1AD1C(P_Cache a1, int a2);
int __fastcall Q_Cache_AddFile_sub_1ADAC(P_Cache pCache, const char *filename);
unsigned int __fastcall sub_1AEB0(P_Cache pCache, UWORD index, char *filename);
void __fastcall Q_Cache_RemoveItem_sub_1B000(P_Cache pCache, UWORD index);
void *__fastcall Q_Cache_GetShapeTable_sub_1B084(P_Cache pCache, UWORD index);
int __fastcall Q_Cache_GetItemIndex_sub_1B270(P_Cache pCache, const char *filename, int addIfNotFound);
char *__fastcall sub_1B2DC(P_Cache a1, int size);
char *__fastcall Q_Cache_RemoveEntry_sub_1B354(P_Cache pCache, UWORD index);
void __fastcall Q_Cache_Clear_sub_1B498(P_Cache pCache);
void __fastcall Q_Cache_Free_sub_1B4D0(P_Cache pCache);
void __fastcall __spoils<> Q_Camera_ResetToIdentity_sub_1B4F0(P_Camera pCamera);
void __fastcall __spoils<> Q_Ret_sub_1B66C();
void __fastcall Q_Camera_ResetAndInit_sub_1B670(P_Camera pCamera, float fov, float nearClip, float farClip, int viewportDimension);
// void __userpurge Q_Camera_InitializeProjection_sub_1B808(P_Camera a1@<eax>, float fov, float nearClip, float farClip, int viewportDimension);
void __fastcall Q_Camera_CalcPerspectiveScaleFactor_sub_1B834(P_Camera pCamera, int viewportDimension);
void __fastcall __spoils<> Q_Camera_BuildTransform_sub_1B864(P_Camera pCamera);
void __fastcall __spoils<> Q_Camera_BuildTransformWithOffset_sub_1B958(P_Camera pCamera, P_Vector3D offset);
void __fastcall Q_Camera_RotateX_sub_1BA90(P_Camera pCamera, float degrees);
void __fastcall Q_Camera_RotateY_sub_1BAB0(P_Camera pCamera, float degrees);
void __fastcall Q_Camera_RotateYY_sub_1BAF0(P_Camera pCamera, float degrees);
FILE *__fastcall Q_OpenTextFile_sub_1BB10(const char *filename, fpos_t *pos);
void __fastcall __spoils<> Q_CFile_Ctor_sub_1BB78(P_CFile pCFile);
void __fastcall __spoils<> Q_CFile_Dtor_sub_1BBC8(P_CFile pCFile);
BOOL __fastcall Q_CFile_Open_sub_1BBFC(P_CFile pCFile, const char *filename, int oflags, BOOL preload);
BOOL __fastcall Q_CFile_Create_sub_1BCA8(P_CFile pCFile, const char *filename);
BOOL __fastcall Q_CFile_Open_sub_1BCBC(P_CFile pCFile, int oflags);
int __fastcall Q_CFile_Close_sub_1BE00(P_CFile a1);
int __fastcall Q_CFile_GetLength_sub_1BE28(P_CFile a1);
int __fastcall Q_CFile_GetPos_sub_1BEA0(P_CFile a1);
int __fastcall sub_1BECC(P_CFile a1, int offset, int a3);
int __fastcall Q_CFile_SetPos_sub_1BF0C(P_CFile a1, int offset);
void *__fastcall Q_CFile_Load_sub_1BF1C(P_CFile pCFile, void *a2);
int __fastcall Q_CFile_Read_sub_1BF94(P_CFile pfi, void *pBuf, ULONG aReadLen);
int __fastcall sub_1BFD4(P_CFile a1, void *buf, unsigned int a3, unsigned int a4, void (__fastcall *a5)(int, unsigned __int8));
unsigned int __fastcall Q_CFile_Write_sub_1C098(P_CFile pCFile, void *buf, unsigned int size);
void __fastcall Q_CobFiles_IndexOneCob_sub_1C278(P_CobFiles a1, char *CobFileName);
void __fastcall Q_CobFiles_Load_sub_1C3C4(P_CobFiles a1);
void Q_AtExitFunc_sub_1C410(void); // idb
int __fastcall main(int argc, char *argv[]);
void Q_Proc_sub_1CC94();
int Q_CORN_CPP_StaticTxtLoad_sub_1CD3C();
char *__fastcall Q_CORN_CPP_StaticTxtRead_sub_1CEA8(int aTextIndex);
void __fastcall Q_Game_StaticCtor_sub_1CEF0();
void __fastcall Q_SetPlayerRaceIndex_sub_1CF14(unsigned __int8 playerRaceIndex);
void __fastcall __spoils<> Q_Star_Ctor_sub_1CF40(P_Star self);
T_Lane *__fastcall Q_CreateStarLane_sub_1CF68(P_Star pStar1, P_Star pStar2);
__int16 __fastcall Q_Star_ChangePlanetOwnership_sub_1D234(P_Star pStar, P_Planet pPlanet, WORD newRaceIndex);
MACRO_VFX_BOOL __fastcall Q_Star_HandleShipArrival_sub_1D3E8(P_Star pStar, P_Ship pShip, int);
MACRO_VFX_BOOL __fastcall Q_HandleShipDeparture_sub_1D538(P_Location pLocation, P_Ship pShip);
void __fastcall sub_1D654(P_Location pLocation, P_Star pStar, P_Lane pLane);
int __fastcall sub_1D734(P_Star pStar, WORD *a2);
int __fastcall Q_FindShipsAtLocation_sub_1D794(P_Location pLocation, P_Ship *outShipsArray);
MACRO_VFX_BOOL __fastcall Q_Star_ShipsAreTravelingTowards_sub_1D834(P_Star pStar, WORD raceIndex);
void __fastcall Q_ReadWriteStar_sub_1D920(P_Star pStar, P_CFile pfi, int read);
WORD __fastcall Q_Star_GetDistanceToStar_sub_1DA04(P_Star pStar, P_Star pStar2);
int __fastcall Q_Star_CalculateStrategicValueForRace_sub_1DA4C(P_Star pStar, WORD raceIndex, P_ShipsList pShipsList, int shipIndex);
int __fastcall sub_1DB70(P_Star pStar, WORD raceIndex, P_ShipsList pShipsList, int a4);
void __fastcall __spoils<> Q_Game_Ctor_sub_1DE64(P_Game pGame);
void __fastcall __spoils<edx> Q_Game_Dtor_sub_1E03C(P_Game self, unsigned int a2);
void __fastcall sub_1E094(P_Game pGame);
void __fastcall sub_1E10C(P_Game pGame, WORD starsNum, WORD racesNum, unsigned __int8 a4);
void __fastcall sub_1E150(P_Game pGame, __int16 sectors);
void __fastcall Q_Game_GenerateStars_sub_1E2A0(P_Game pGame, WORD stars);
void __fastcall Q_Game_NewGame_sub_1E70C(P_Game pGame, WORD racesNum, UBYTE playerSpecies);
void __fastcall Q_Game_SetRacesRandomColors_sub_1EE08(P_Game pGame, BYTE playerColor);
void __fastcall sub_1EEA4(P_Game pGame);
void __fastcall sub_1EFC0(P_Game pGame);
void __fastcall Q_Game_InitializeStarConnections_sub_1F038(P_Game pGame);
int __fastcall sub_1F404(P_Game pGame);
void __fastcall Q_BuildStarLanes_sub_1F91C();
void __fastcall Q_Game_BuildStarConnectionGroups_sub_1FB34(P_Game pGame);
void __fastcall Q_Game_BuildConnectionGroupFromStar_sub_1FD18(P_Game pGame, P_Star pStar);
int __fastcall sub_1FD90(int, int, int);
int __fastcall sub_1FDF0(int, int, int, int);
int __fastcall sub_1FFE0(P_Game a1, int a2);
void __fastcall Q_Game_AddStarToConnectionGroup_sub_2016C(P_Game pGame, P_Star pStar, __int16 index);
void __fastcall sub_201D8(P_Game pGame);
P_Lane __fastcall Q_Game_AddLane_sub_205A0(P_Game pGame, P_Star pStar1, P_Star pStar2);
P_Ship __fastcall sub_20684(P_Game pGame, __int16 raceIndex);
void __fastcall Q_Game_RemoveShip_sub_20720(P_Game pGame, P_Ship pShip);
void __fastcall sub_207A0(P_Game);
T_Star *__fastcall sub_20B3C(P_Game pGame);
void __fastcall sub_20C94(P_Game pGame, int, int, int);
void __fastcall sub_2106C(P_Game pGame);
void __fastcall sub_21170(P_Game a1);
void __fastcall sub_211EC(P_Game pGame, P_Star pStar, int a3);
void __fastcall sub_21314(P_Game a1);
void __fastcall Q_Game_SaveGam_sub_21374(P_Game pGame, P_CFile pfi);
void __fastcall Q_Game_LoadGam_sub_21AA0(P_Game pGame, P_CFile pfi);
void __fastcall Q_Game_CalculateAverageHomeStarDistances_sub_220CC(P_Game pGame);
void __fastcall __spoils<edx> sub_22260(void *result);
void __fastcall __spoils<edx> sub_22280(void *);
void __fastcall __spoils<edx> sub_222A0(void *result);
void __fastcall __spoils<edx> sub_222C0(void *);
void __fastcall __spoils<edx> sub_222E0(void *);
void __fastcall __spoils<edx> sub_22300(void *result);
void __fastcall __spoils<edx> sub_22320(void *result);
P_Lane __fastcall sub_22360(P_Lane result);
void __fastcall __spoils<> Q_SectorCtor_sub_223B0(P_Sector pSector);
void __fastcall __spoils<> Q_Type09_Ctor_sub_223E0(P_Type09 self);
void __fastcall __spoils<> Q_PlanetCtor_sub_22400(P_Planet pPlanet);
int __fastcall Q_Compare_sub_22430(const void *, const void *); // idb
void __fastcall Q_Proc_sub_22468();
void __fastcall __spoils<> Q_Wnd02COSW_Ctor_sub_224A4(P_Wnd02COSW pWnd);
void __fastcall __spoils<edx> Q_Wnd02COSW_Dtor_sub_22588(P_Wnd02COSW self, unsigned int a2);
unsigned int __fastcall Q_Wnd02COSW_sub_22644(P_Wnd02COSW pWnd, const char *starShapes, const char *shipShapes);
void __fastcall Q_Wnd02COSW_InitializeCameraDefaults_sub_2280C(P_Wnd02COSW pWnd);
void __fastcall Q_Wnd02COSW_Proc4_sub_23BF0(P_Wnd02COSW pWnd, int a2);
int __fastcall sub_23FD4(int);
void __fastcall sub_24154(P_Wnd02COSW a1, int a2, float a3);
void __fastcall sub_24198(P_Wnd02COSW a1, int fovDelta);
void __fastcall sub_2422C(P_Wnd02COSW pWnd);
int __fastcall sub_24948(int result, int, int);
void __fastcall sub_24BE0(P_Wnd02COSW pWnd);
int __fastcall sub_24D30(P_Wnd02COSW pWnd);
void __fastcall Q_Wnd02COSW_Proc6_sub_24FCC(P_Wnd02COSW a1, P_CFile pfi, int read);
void __fastcall __spoils<> sub_254A4(T_Wnd02COSWt1 *a1);
void __fastcall __spoils<> sub_254B0(T_Wnd02COSWt1 *a1);
void __fastcall sub_254BC(T_Wnd02COSWt1 *a1, int a2);
void __fastcall sub_254DC(T_Wnd02COSWt1 *a1);
void __fastcall sub_254F8(int *, int);
void __fastcall __spoils<> Q_Wnd05RW_Ctor_sub_25BF8(P_WndA2 a1);
void __fastcall __spoils<edx> Q_Wnd05RW_Dtor_sub_25C08(P_WndA2 pWnd, unsigned int);
void __fastcall Q_Wnd05RW_Proc4_sub_25C4C(P_Wnd pWnd, int a2);
void __fastcall __spoils<> Q_Wnd06RSW_Ctor_sub_25CB8(P_Wnd06RSW result);
void __fastcall __spoils<edx> Q_Wnd06RSW_Dtor_sub_25CD4(P_WndA2 pWnd, unsigned int a2);
void __fastcall Q_Wnd06RSW_Proc4_sub_25D18(P_Wnd06RSW pWnd, int a2);
void __fastcall Q_Wnd06RSW_Proc5_sub_25FB4(P_Wnd06RSW pWnd, int a2);
int __fastcall Q_Wnd06RSW_Proc3_sub_26000(P_Wnd06RSW pWnd, UWORD message, int param1, int param2);
void sub_26140();
char *__fastcall sub_26150(char *result);
int Q_StopSystems_sub_26160();
void Q_debugbreak_sub_26194();
void __fastcall __noreturn Q_AssertLogBreakExit_sub_26198(int ignore, const char *sourcefile, int line);
void __fastcall Q_AssertLogBreakExit_sub_261A8(int ignore, const char *sourcefile, int line);
void __fastcall Q_PrintFailAndExit_sub_261B8(int ignore, const char *sourceFile, int line);
int sub_2620C(char *format, ...);
void __noreturn Q_debugbreak_exit_sub_2624C();
void __fastcall __spoils<edx,ebx> Q_RegisterDataInWinMgr_sub_2625C(void *aData, int category, char *name);
void __fastcall Q_RemoveWinDataFromWinMgr_sub_2627C(void *pdata);
void *__fastcall Q_Allocate_sub_2628C(size_t, int, char *);
void *__fastcall Q_AllocAndAddToWinMgr_sub_262B0(size_t num, size_t size, int category, char *name);
void __fastcall Q_RemoveWinDataFromWinMgr_sub_262CC(void *ptr);
void Q_InputSystem_StaticCtor_sub_262F0();
void __fastcall __spoils<> Q_InputSystem_Ctor_sub_26314(P_InputSystem self);
void __fastcall Q_InputSystem_Dtor_sub_2631C(T_InputSystem *);
void Q_Null_sub_26328();
void __fastcall Q_StopMouse_sub_2632C(P_InputSystem);
int __fastcall Q_StartMouse_sub_2633C(P_InputSystem);
void __fastcall Q_ProcessKeyboard_sub_26360();
void __fastcall Q_ProcessMouse_sub_264B4();
int __fastcall Q_ProcessInput_sub_2656C(P_InputSystem a1);
void __fastcall Q_WinEvent_ProcessInput_sub_265A8(P_WinEvent pWinEvent);
void __fastcall __spoils<> Q_Wnd23EW_Ctor_sub_267A0(P_Wnd23EW a1);
void __fastcall __spoils<> Q_Wnd23EW_Dtor_sub_267BC(P_Wnd23EW a1, char a2);
void __fastcall __spoils<> Q_WndEW_sub_26800(P_Wnd23EW result);
void __fastcall sub_26874(P_Wnd23EW a1, P_GameEvent pGameEvent);
int __fastcall sub_270F4(T_Wnd20HW *, __int16, LONG, LONG);
void __fastcall __spoils<> Q_Wnd30EW_Ctor_sub_2712C(T_WndA2 *a1);
void __fastcall __spoils<edx> Q_Wnd30EW_Dtor_sub_2713C(P_Wnd30EW self, unsigned int a2);
int __fastcall Q_Wnd30EW_Proc3_sub_27184(P_Wnd30EW pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd30EW_Proc4_sub_271FC(P_Wnd30EW pWnd, int a2);
void __fastcall __spoils<> Q_Wnd24EW_Ctor_sub_27BF8(P_WndA2 a1);
void __fastcall __spoils<edx> Q_Wnd24EW_Dtor_sub_27C08(P_Wnd24EW self, unsigned int a2);
int __fastcall Q_Wnd24EW_Proc3_sub_27C50(P_Wnd24EW pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd24EW_Proc4_sub_27D18(P_Wnd24EW pWnd, int a2);
void __cdecl Q_TimerCallback_sub_28C40(ULONG user);
int __fastcall Q_CompareSubtitleInstructions_sub_28C4C(P_SubtitleInstruction a1, P_SubtitleInstruction a2);
int __fastcall Q_NC_sub_28C58(int result, __int16);
void __fastcall __spoils<> Q_Type2_Init_sub_28C74(P_Type2 a1);
void __fastcall __spoils<> Q_Type2_Finalize_sub_28DA4(P_Type2 a1);
int __fastcall Q_Type2_sub_28EB4(P_Type2 a1, const char *flicName, void *pBuf, int a4, int a5);
unsigned int __fastcall Q_Type2_sub_29038(P_Type2 a1, size_t a2, unsigned int a3, int a4, int a5, void *pBuf);
unsigned int __fastcall Q_NC_sub_291F8(int);
unsigned int __fastcall Q_NC_sub_2936C(T_Type2 *);
unsigned int __fastcall Q_Type2_sub_296B4(P_Type2 a1);
void __fastcall Q_Type2_sub_29B24(P_Type2 a1);
void __fastcall sub_29C6C(P_Type2 a1, _WORD *a2);
int __fastcall sub_29D54(P_Type2 a1, unsigned __int8 *a2);
void __fastcall sub_29F58(P_Type2 a1, const void *pBuf);
void __fastcall Q_NC_sub_29FF8(int, _WORD *);
void __fastcall Q_Type2_LoadSubtitleTxt_sub_2A1DC(P_Type2 a1, const char *fileName);
void __fastcall sub_2AA88(P_Type2 a1);
int __fastcall Q_Type2_SetTimer_sub_2AC84(P_Type2 a1, ULONG hertz);
void __fastcall __spoils<> sub_2AD08(P_Type2 a1);
__int16 __cdecl sub_2AD40(unsigned __int16 *, int, LONG y);
int __cdecl Q_NC_sub_2AE48(unsigned __int16);
__int16 Q_NC_sub_2AE69();
void __fastcall __spoils<> Q_Wnd01FLIC_Ctor_sub_2AE80(P_Wnd01FLIC self);
void __fastcall __spoils<edx> Q_Wnd01FLIC_Dtor_sub_2AEB0(P_Wnd01FLIC self, unsigned int a2);
UBYTE *__fastcall Q_Wnd01FLIC_LoadFlicHeader_sub_2AF04(P_Wnd01FLIC a1, const char *flicName);
unsigned int __fastcall Q_Wnd01FLIC_sub_2AF3C(P_Wnd01FLIC pWnd);
int __fastcall Q_Wnd01FLIC_Proc3_sub_2AFF0(P_Wnd01FLIC pWnd, UWORD message, int param1, int param2);
void __fastcall __spoils<> Q_Font_Init_sub_2B2C0(P_Font a1);
void __fastcall __spoils<> sub_2B2E0(P_Font a1);
MACRO_VFX_BOOL __fastcall sub_2B2FC(P_Font pFont, const char *aFName);
MACRO_VFX_BOOL __fastcall sub_2B360(P_Font pFont, const char *aFName);
void __fastcall Q_Font_SetPaneRect_sub_2B3E0(P_Font pFont, int x1, int y1, int x2, int y2);
int __fastcall Q_Font_ParseTextColor_sub_2B3F4(P_Font pFont, char *input, char *output, int update);
int __fastcall Q_Font_GetTextWidth_sub_2B4F4(P_Font pFont, char *text);
LONG __fastcall Q_Font_GetHeight_sub_2B594(P_Font pFont);
int __fastcall sub_2B5BC(P_Font pFont, char *text);
void __fastcall Q_Font_RenderText_sub_2B610(P_Font pFont, LONG xOffset, LONG yOffset, char *text, char flags, __int16 a6, __int16 a7);
void __fastcall Q_NC_sub_2B804(LONG *, int);
LONG __fastcall Q_NC_sub_2B838(int, __int16, __int16);
int __fastcall Q_Font_DrawFormattedText_sub_2B8A8(P_Font pFont, int xOffset, int yOffset, const char *text, UWORD flags, WORD bgColor, WORD wipeColor, int maxWidth);
void Q_GSystem_StaticCtor_sub_2BB50();
void __fastcall Q_Pane_CopyOrDrawRectangle_sub_2BB74(PANE *pPane, LONG x0, LONG yTop, LONG x1, LONG yBottom, UBYTE color, int copy);
void __fastcall Q_Pane_CenterShape_sub_2BC40(PANE *pPane, void *shape_table, LONG shape_number, int *outHotX, int *outHotY);
void __fastcall sub_2BCF4(int, unsigned __int8); // idb
void __fastcall Q_GSystem_AdjustPalette_sub_2BD04(P_GSystem pGSystem, char fadeIntensity, RGB *pTargetColor);
void __fastcall __spoils<> Q_GSystem_Ctor_sub_2BD4C(P_GSystem self);
void __fastcall __spoils<edx> Q_GSystem_Dtor_sub_2BD7C(P_GSystem self, unsigned int a2);
MACRO_VFX_BOOL __fastcall Q_GSystem_Start_sub_2BD88(P_GSystem, const char *dirName, const char *driverName);
unsigned int __fastcall Q_GSYSTEM_CPP_sub_2BFDC(P_GSystem a1);
void __fastcall Q_AllocateHazeTables_sub_2C08C(P_GSystem a1, unsigned __int16 numTables);
int __fastcall Q_LoadHazeTables_sub_2C0C0(P_GSystem a1, const char *a2, unsigned __int16 num);
unsigned int __fastcall Q_LoadPal_sub_2C158(P_GSystem a1, const char *aFName, int a3, unsigned __int16 a4);
void __fastcall sub_2C1E0(P_GSystem a1, unsigned __int16 a2, unsigned __int16 a3, unsigned int a4);
void __fastcall Q_GSystem_PaletteSet_sub_2C224(P_GSystem a1, unsigned __int16 from, __int16 count, RGB *palette);
void __fastcall Q_NC_sub_2C264(T_GSystem *);
void __fastcall Q_NC_sub_2C280(P_GSystem, signed __int16, __int16);
void __fastcall Q_GSystem_PaletteGet_sub_2C2B0(P_GSystem a1, unsigned __int16 from, __int16 count, RGB *palette);
void __fastcall sub_2C2F8(T_GSystem *, char *);
void __fastcall sub_2C418(P_GSystem a1, int a2, __int16 a3);
void __fastcall sub_2C4C0(P_GSystem a1, int a2, int a3);
void __fastcall Q_NC_sub_2C5C0(T_GSystem *);
void __fastcall Q_GSystem_FadePalette_sub_2C5E4(P_GSystem, char);
void __fastcall sub_2C670(P_GSystem a1, int a2, int a3, RGB *triplet);
void __fastcall Q_GSystem_Stop_sub_2C6CC(P_GSystem a1);
void __fastcall Q_GSystem_PreloadMouseShp_sub_2C744(P_GSystem a1);
void __fastcall Q_GSystem_SetMousePointerShape_sub_2C7D0(P_GSystem pGSysytem, LONG mouseShapeNumber, void *table);
void __fastcall __spoils<> Q_WndA2_Ctor_sub_2C830(P_WndA2 a1);
void __fastcall __spoils<edx> Q_WndA2_Dtor_sub_2C848(P_WndA2 a1, char a2);
void __fastcall __spoils<> Q_Wnd_Init_sub_2C8E4(P_Wnd a1);
void __fastcall Q_RegisterWindowInWinMgr_sub_2C978(P_WndA2 a1);
unsigned int __fastcall Q_GWINDOW_CPP_LinkChild_sub_2C990(P_WndA2 a1, P_WndA2 a2);
unsigned int __fastcall sub_2CA0C(P_Wnd a1, P_Wnd a2, int a3);
int __fastcall Q_NC_sub_2CA58(int);
P_Wnd __fastcall Q_Wnd_Proc2TranslatePane_sub_2CA78(P_Wnd result, WORD xOffset, WORD yOffset);
void __fastcall sub_2CD24(unsigned int, int);
void __fastcall Q_Wnd_Proc5_sub_2CF28(P_Wnd pWnd, int a2);
P_Wnd __fastcall sub_2D0F4(P_Wnd pWnd, int a2);
void __fastcall sub_2D218(P_WndA2 pWnd);
void __fastcall Q_WndA2_CallChildrenProc3_sub_2D258(P_WndA2 pWnd, UWORD message, int param1, int param2);
int Q_LoadGwshareTxt_sub_2D2CC();
int __fastcall sub_2D334(const char *);
char *__fastcall sub_2D3D0(char *result);
unsigned int __fastcall sub_2D400(int, int);
void __fastcall __spoils<> Q_Wnd25TW_Ctor_sub_2D464(P_Wnd25TW a1);
void __fastcall __spoils<edx> Q_Wnd25TW_Dtor_sub_2D480(P_Wnd25TW a1, char a2);
void __fastcall __spoils<> Q_Wnd25TW_Init_sub_2D4C4(P_Wnd25TW result);
int __fastcall Q_Wnd25TW_Proc3_sub_2D4D0(P_Wnd25TW pWnd25TW, UWORD message, int param1, int param2);
void __fastcall Q_Wnd25TW_Proc4_sub_2D528(P_Wnd25TW pWnd, int a2);
void __fastcall Q_Wnd25TW_Proc5_sub_2D79C(P_Wnd25TW pWnd, int a2);
void __fastcall Q_Wnd25TW_Proc6_sub_2D99C(P_Wnd25TW pWnd, P_CFile pfi, BOOL read);
void __fastcall __spoils<> Q_Wnd03CTW_Ctor_sub_2D9C4(P_Wnd03CTW pWnd);
void __fastcall __spoils<edx> Q_Wnd03CTW_Dtor_sub_2D9FC(P_Wnd03CTW pWnd, char a2);
void __fastcall __spoils<> Q_Wnd03CTW_Init_sub_2DA60(P_Wnd pWnd);
void __fastcall Q_Wnd03CTW_Register_sub_2DA68(P_Wnd03CTW a1);
MACRO_VFX_BOOL __fastcall Q_Wnd03CTW_AllocateControls_sub_2DA80(P_Wnd03CTW, __int16 numControls);
MACRO_VFX_BOOL __fastcall Q_Wnd03CTW_SetControl_sub_2DAC8(P_Wnd03CTW pWnd, __int16 mask, __int16, P_Control pControl);
void __fastcall Q_Wnd03CTW_Proc2_sub_2DB54(P_Wnd03CTW pWnd, WORD xOffset, WORD yOffset);
int __fastcall Q_Wnd03CTW_sub_2DBE4(P_Wnd03CTW pWnd, int a2, int a3);
void __fastcall Q_Wnd03CTW_sub_2DCA0(P_Wnd03CTW pWnd, __int16 a2);
void __fastcall Q_Wnd03CTW_NC_sub_2DD2C(P_Wnd03CTW pWnd, __int16 a2, __int16 a3);
void __fastcall Q_Wnd03CTW_sub_2DD70(P_Wnd03CTW pWnd03CTW);
unsigned int __fastcall Q_Wnd03CTW_sub_2DDB8(P_Wnd03CTW pWnd, __int16 a2);
int __fastcall Q_Wnd03CTW_Proc3_sub_2DE68(P_Wnd03CTW pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd03CTW_Proc4_sub_2E084(P_Wnd03CTW pWnd, int a2);
void __fastcall Q_Wnd03CTW_Proc6_sub_2E1B4(P_Wnd03CTW pWnd, P_CFile pfi, BOOL read);
void __fastcall Q_DefaultDrawItemFunc_sub_2E208(PANE *pPane, void *pData, int param1, BOOL hovered);
void __fastcall __spoils<> Q_Wnd10LB_Ctor_sub_2E248(P_Wnd10LB pListBox);
T_WndA2 *__fastcall Q_Wnd10LB_Dtor_sub_2E264(T_WndA2 *, char);
void __fastcall Q_Wnd10LB_Init_sub_2E2B8(P_Wnd10LB pListBox);
void __fastcall Q_Wnd10LB_Register_sub_2E3BC(P_Wnd10LB a1);
int __fastcall Q_Wnd10LB_Proc3_sub_2E3D4(P_Wnd10LB pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd10LB_Proc4_sub_2E6C0(P_Wnd10LB pWnd, int a2);
void __fastcall Q_Wnd10LB_DrawScrollBar_sub_2E868(P_Wnd10LB pListBox, int refresh);
void __fastcall Q_Wnd10LB_InitScrollBar_sub_2E9CC(P_Wnd10LB pListBox, char large);
int __fastcall Q_Wnd10LB_AddItem_sub_2EA8C(P_Wnd10LB pListBox, BYTE *pData, WORD a3, BOOL bRedraw);
MACRO_VFX_BOOL __fastcall Q_Wnd10LB_SetItemValue_sub_2EC50(P_Wnd10LB pListBox, unsigned __int16 itemIndex, int value);
int __fastcall Q_Wnd10LB_GetItemValue_sub_2ECA4(P_Wnd10LB pListBox, unsigned __int16 itemIndex);
void __fastcall __spoils<> Q_Wnd10LB_SetSelectedIndex_sub_2ECDC(P_Wnd10LB pListBox, UWORD index);
void *__fastcall Q_Wnd10LB_GetItemData_sub_2ED14(P_Wnd10LB pListBox, unsigned __int16 itemIndex);
void __fastcall Q_Wnd10LB_Clear_sub_2ED4C(P_Wnd10LB pListBox);
void __fastcall Q_Wnd10LB_MouseMessage_sub_2EDC8(P_Wnd10LB pScrollBar, unsigned int mouseX, unsigned int mouseY);
void __fastcall sub_2F090(T_Wnd10LB *, unsigned int, unsigned int, __int16);
void __fastcall __spoils<> Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(P_Wnd10LB listBox, P_DrawItemFunc func);
void __fastcall __spoils<> Q_Wnd10LB_SetCompareProc_sub_2F1D8(P_Wnd10LB result, void *proc);
void __fastcall Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(P_Wnd10LB pListBox);
MACRO_VFX_BOOL __fastcall Q_Wnd10LB_InitMemPool_sub_2F228(P_Wnd10LB pListBox, int size, void *pMemPool);
void __fastcall Q_Wnd10LB_FinalizeMemPool_sub_2F2B4(P_Wnd10LB pListBox);
void __fastcall __spoils<> Q_Wnd15NT_Ctor_sub_2F2F4(P_Wnd15NT result);
void __fastcall __spoils<edx> Q_Wnd15NT_Dtor_sub_2F30C(P_WndA2 pWnd, unsigned int);
void __fastcall Q_Wnd15NT_Proc4_sub_2F354(P_Wnd pWnd, int a2);
void __fastcall Q_Wnd15NT_Proc5_sub_2F414(P_Wnd pWnd, int a2);
int __fastcall Q_Wnd26MW_Proc3_sub_2F420(P_WndA2 pWnd, UWORD message, int param1, int param2);
int __fastcall Q_WndA2_Proc3_sub_2F424(P_WndA2 pWndA2, UWORD message, int param1, int param2);
int __fastcall Q_Wnd15NT_Proc3_sub_2F478(P_WndA2 pWnd, UWORD message, int param1, int param2);
void __fastcall __spoils<> Q_WndEDITWND_Ctor_sub_2F48C(P_WndEDITWND pWnd);
void __fastcall __spoils<edx> Q_WndEDITWND_Dtor_sub_2F4A8(P_WndA2 pWnd, unsigned int);
void __fastcall __spoils<> Q_WndEDITWND_Init_sub_2F4EC(P_WndEDITWND pWnd);
void __fastcall Q_WndEDITWND_Proc4_sub_2F540(P_WndEDITWND pWnd, int a2);
int __fastcall Q_WndEDITWND_Proc3_sub_2F6B0(P_WndEDITWND pWnd, UWORD message, int param1, int param2);
void __fastcall Q_WndEDITWND_DeleteChar_sub_2F8A4(P_WndEDITWND pWnd, int pos);
void __fastcall Q_WndEDITWND_InsertChar_sub_2F8F8(P_WndEDITWND pWnd, WORD pos, char character);
void __fastcall Q_WndEDITWND_SetNewText_sub_2F9A4(P_WndEDITWND pWnd, const char *newText, WORD maxTextLength);
void __fastcall __spoils<> Q_Wnd26MW_Ctor_sub_2FA18(P_Wnd26MW a1);
void __fastcall __spoils<edx> Q_Wnd26MW_Dtor_sub_2FA34(P_WndA2 pWnd, unsigned int);
void __fastcall __spoils<> Q_Wnd26MW_Init_sub_2FA78(P_Wnd26MW result);
void __fastcall Q_Wnd26MW_Proc4_sub_2FA98(P_Wnd pWnd, int a2);
void __fastcall sub_2FBA4(int, int);
int __fastcall sub_2FC3C(int);
void __fastcall __spoils<> Q_Wnd20HW_Ctor_sub_2FC50(P_Wnd20HW self);
void __fastcall __spoils<edx> Q_Wnd20HW_Dtor_sub_2FC68(P_Wnd20HW self, unsigned int a2);
void __fastcall Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(P_Wnd20HW pHelpWnd, char *helpfile, char *helptopic);
int __fastcall Q_Wnd20HW_Proc3_sub_2FD68(P_Wnd20HW pWnd, UWORD message, int param1, int param2);
void __fastcall Q_HELPWIN_CPP_FgetsLine_sub_2FE58(FILE *fp, char *line);
int __fastcall sub_2FEB8(P_Wnd20HW pHelpWnd);
void __fastcall Q_Wnd20HW_Proc4_sub_30774(P_Wnd20HW pWnd, int a2);
void __fastcall sub_30A90(PANE *pPane, void *pData, int param1, int param2);
void __fastcall sub_31158(PANE *pPane, void *pData, int param1, int param2);
void __fastcall __spoils<> Q_Wnd11LW_Ctor_sub_31200(P_Wnd11LW result);
void __fastcall __spoils<edx> Q_Wnd11LW_Dtor_sub_3121C(P_Wnd11LW pWnd, unsigned int a2);
int __fastcall Q_Wnd11LW_Proc3_sub_31268(P_Wnd11LW pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd11LW_Proc4_sub_3160C(P_Wnd pWnd, int a2);
T_CFile *__fastcall sub_316A8(int);
int __fastcall sub_317D0(int);
int __fastcall sub_318A0(unsigned __int16, unsigned __int8);
char __fastcall sub_31934(int a1);
int __fastcall sub_31A34(unsigned __int16, char);
int sub_31B08();
void __fastcall Q_SaveScreenshot_sub_31C18(UBYTE *shadowBuffer, int size);
void __fastcall Q_AppendRomanNum_sub_31E60(char *a1, int number);
int __fastcall sub_31FB0(_DWORD *, const char *, int, int);
void __fastcall __spoils<> Q_WndNW_sub_3201C(P_WndNW a1);
T_WndA2 *__fastcall sub_32038(T_WndA2 *, char);
void __fastcall __spoils<> Q_WndNW_sub_3207C(P_WndNW result);
unsigned int __fastcall sub_320B8(int, __int16, LONG, LONG);
void __fastcall sub_32414(int);
void *__fastcall sub_32658(int);
int __fastcall sub_32714(int, int, __int16);
void __fastcall sub_32800(int, int);
__int64 __fastcall sub_32A1C(int);
__int64 __fastcall sub_32A48(int, int, __int16, int, int);
__int64 __fastcall sub_32B44(int, int, __int16);
__int64 __fastcall sub_32BDC(int, char);
__int64 __fastcall sub_32C14(int, char);
char *__fastcall sub_32C48(int, char, int, int);
int __fastcall sub_32E84(int, int, int, int);
int __fastcall sub_32FD8(int, FILE *, int);
void __fastcall sub_330DC(T_Type5 *, unsigned __int8 *);
void __fastcall __spoils<> Q_WndIW_sub_33598(P_WndIW a1);
T_WndA2 *__fastcall sub_335B4(T_WndA2 *, char);
void __fastcall __spoils<> Q_WndIW_sub_335F8(P_WndIW result);
int __fastcall sub_33604(int, __int16, LONG, LONG);
void __fastcall sub_33674(T_Wnd08SW *);
void __fastcall __spoils<> Q_Wnd22AW_Ctor_sub_33830(P_Wnd22AW self);
void __fastcall __spoils<edx> Q_Wnd22AW_Dtor_sub_33840(P_Wnd22AW self, unsigned int a2);
void __fastcall Q_Wnd22AW_ShowHelpTopicAbil_sub_33884(P_Wnd22AW pAbilWnd);
int __fastcall Q_Wnd22AW_Proc3_sub_338DC(P_Wnd22AW pAbilWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd22AW_Proc4_sub_33A68(P_WndA2 pWnd, int a2);
UWORD __fastcall Q_Planet_Initialize_sub_33AF0(P_Planet pPlanet, UWORD planetSize, UWORD planetType, P_Square pSquaresArray);
void __fastcall Q_PLANET_CPP_LoadPlanItemTxt_sub_33D30();
int __fastcall Q_Planet_CountAvailableBuildSquares_sub_3407C(P_Planet pPlanet);
int __fastcall Q_Planet_CountTerraformableSquares_sub_3420C(P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall Q_Planet_CanPlaceItem_sub_34368(P_Planet pPlanet, UBYTE planetItemIndex, unsigned __int16 squareIndex);
void __fastcall Q_Planet_StartConstruction_sub_34774(P_Planet pPlanet, UBYTE planetItemIndex, int squareIndex, BOOL _immediate);
int __fastcall Q_Planet_FindOptimalBuildLocation_sub_347CC(P_Planet pPlanet, UBYTE planetItemIndex);
void __fastcall Q_Planet_CountBuildableSquaresByColor_sub_34A44(P_Planet pPlanet, LONG *outResearch, LONG *outIndustry, LONG *outFertility);
int __fastcall Q_Planet_BuildAtOptimalLocation_sub_34AE4(P_Planet pPlanet, UBYTE planetItemIndex, BOOL _immediate);
MACRO_VFX_BOOL __fastcall Q_Planet_HandleItemConstruction_sub_34B0C(P_Planet pPlanet, UWORD squareIndex, unsigned __int8 planetItemIndex, unsigned __int8 actionType);
void __fastcall Q_Planet_CalcPoints_sub_34E70(P_Planet pPlanet);
void __fastcall sub_352E0(P_Planet pPlanet);
UWORD __fastcall Q_Planet_GetItemCost_sub_3583C(P_Planet pPlanet, unsigned __int16 a2, unsigned __int8 planetItemIndex);
int __fastcall Q_Planet_GetDaysToCompleteItem_sub_358BC(P_Planet pPlanet);
int __fastcall Q_Planet_CountSurfaceBuildings_sub_358F0(P_Planet pPlanet);
UWORD __fastcall Q_Planet_GetSquareWithItem_sub_35930(P_Planet pPlanet, UBYTE planetItemIndex);
int __fastcall Q_Planet_GetSquareIndex_sub_35968(P_Planet pPlanet, int column, int row);
T_SquareGridCoord __fastcall Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(P_Planet pPlanet, unsigned __int16 squareIndex);
P_Ship __fastcall Q_Planet_GetShipAtSquare_sub_35A70(P_Planet pPlanet, UWORD squareIndex);
void __fastcall Q_Planet_AssignShipToOrbitalSquare_sub_35B04(P_Planet pPlanet, unsigned __int16 squareIndex, P_Ship pShip);
MACRO_VFX_BOOL __fastcall Q_Planet_TryPlaceShipInOrbit_sub_35BB4(P_Planet pPlanet, P_Ship pShip);
MACRO_VFX_BOOL __fastcall Q_Planet_LaunchShip_sub_35C38(P_Planet pPlanet, P_Ship pShip);
char __fastcall Q_Planet_GetBestAvailableOrbitalShield_sub_35DA4(P_Planet pPlanet);
char __fastcall Q_Planet_GetBestAvailableOrbitalWeapon_sub_35E24(P_Planet pPlanet);
int __fastcall Q_Planet_GetMaxOrbitalDefenseRange_sub_35ED8(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateOrbitalDefenseStrength_sub_360D8(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateSurfaceShieldStrength_sub_36158(P_Planet pPlanet);
int __fastcall Q_Planet_HasOrbitalDefense_sub_361B8(P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall sub_3623C(P_Planet pPlanet);
void __fastcall Q_Planet_SetPosition_sub_362C8(P_Planet pPlanet, P_Vector3D newPosition);
MACRO_VFX_BOOL __fastcall Q_Planet_CanBuildShip_sub_362E0(P_Planet pPlanet);
int __fastcall Q_Planet_GetSquaresValue_sub_3636C(P_Planet pPlanet, BOOL withBlack);
int __fastcall Q_Planet_GetTotalValue_sub_363B0(P_Planet pPlanet);
int __fastcall Q_Planet_GetVisibleValueForRace_sub_364B4(P_Planet pPlanet, WORD raceIndex);
void __fastcall Q_Planet_GetOrbitalWeaponStats_sub_366C8(P_Planet pPlanet, UBYTE planetItemIndex, LONG *outRange, LONG *outDamage, LONG *outNumUses);
int __fastcall sub_3676C(P_Planet pPlanet, int);
void __fastcall sub_36A5C(P_Planet pPlanet, int a2, WORD raceIndex);
MACRO_VFX_BOOL __fastcall Q_Planet_TryInvade_sub_36CD4(P_Planet pPlanet, unsigned __int16 squareIndex_1, int *outModulesUse);
void __fastcall Q_Planet_Abandon_sub_37040(P_Planet pPlanet);
void __fastcall Q_Planet_ReadWrite_sub_370B8(P_Planet pPlanet, P_CFile pfi, int read);
void __fastcall __spoils<> Q_Wnd7PW_Ctor_sub_372B0(P_Wnd07PW pWnd7PW);
void __fastcall __spoils<edx> Q_Wnd7PW_Dtor_sub_372CC(P_Wnd07PW a1, char a2);
void __fastcall Q_Wnd7PW_Init_sub_37310(P_Wnd07PW pWnd7PW);
T_SquareGridCoord __fastcall Q_ScreenToSurfaceSquareGridCoord_sub_37380(int screenX, int screenY);
int __fastcall Q_GetSquareIndexAtScreen_sub_373E0(int screenX, int screenY);
void __fastcall Q_DrawItemFunc_sub_3745C(PANE *pPane, void *pData, int param1, BOOL hovered);
int __fastcall Q_Wnd07PW_Proc3_sub_37568(P_Wnd07PW pWnd7PW, UWORD message, int param1, int param2);
void __fastcall Q_Wnd07PW_Proc4_sub_384B0(P_Wnd07PW pPlanetWnd, int a2);
void __fastcall sub_39390(P_Wnd07PW pWnd7PW, UBYTE a2, UWORD *pCacheIndex, UWORD *a4);
__int16 __fastcall sub_393F4(P_Wnd07PW pWnd, UWORD squareIndex, UWORD *a3, _WORD *a4);
void __fastcall sub_394BC(P_Wnd07PW pWnd07PW);
void __fastcall Q_Wnd07PW_Proc6_sub_395C4(P_Wnd07PW pWnd7PW, P_CFile pfi, BOOL read);
void __fastcall __spoils<> Q_Wnd29GSW_Ctor_sub_395EC(P_Wnd29GSW result);
void __fastcall __spoils<edx> Q_Wnd29GSW_Dtor_sub_395FC(P_Wnd29GSW self, unsigned int a2);
int __fastcall Q_Wnd29GSW_Proc3_sub_39644(P_Wnd29GSW pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd29GSW_Proc4_sub_396F0(P_Wnd29GSW pWnd, int a2);
void __fastcall __spoils<> Q_Wnd14PSW_Ctor_sub_39D80(P_Wnd14PSW pWnd14PSW);
void __fastcall __spoils<edx> Q_Wnd14PSW_Dtor_sub_39D9C(P_Wnd14PSW pWnd14PSW, char a2);
void __fastcall Q_ReadPlanetTexts_sub_39DE0();
int __fastcall Q_Wnd14PSW_Proc3_sub_39E3C(P_Wnd14PSW pWnd14PSW, UWORD message, int param1, int param2);
void __fastcall Q_Wnd14PSW_Proc4_sub_3A6BC(P_Wnd14PSW pWnd14PSW);
void __fastcall Q_RaceCtor_sub_3B120(P_Race pRace);
void __fastcall Q_Race_Init_sub_3B188(P_Race pRace);
void __fastcall Q_Race_InitAndSetSpecies_sub_3B1FC(P_Race pRace, UBYTE raceIndex, WORD species);
void __fastcall sub_3B220(P_Race pRace);
char __fastcall Q_NC_sub_3B38C(P_Race pRace);
int __fastcall sub_3B56C(P_Race pRace, P_Location pLocation);
void __fastcall sub_3B5B8(T_Race *);
MACRO_VFX_BOOL __fastcall Q_Race_ShouldUpgradeShip_sub_3C12C(P_Race pRace, P_Ship pShip);
char __fastcall sub_3C1C0(P_Race pRace, P_ShipsList shipsArray, int a3);
int __fastcall sub_3C2E8(T_Race *a1, P_ShipsList a2, int a3);
void __fastcall Q_NC_sub_3C4EC(P_Race pRace, int a2);
void __fastcall sub_3C670(P_Race pRace);
void __fastcall sub_3C968(P_Race pRace);
int __fastcall sub_3CB60(P_Race pRace, P_Planet pPlanet, unsigned __int8 a3);
unsigned int __fastcall Q_NC_sub_3CC90(_BYTE *, unsigned __int8);
unsigned int __fastcall sub_3CCE4(P_Race pRace, P_Planet pPlanet);
void __fastcall Q_Race_ManagePlanetDevelopment_sub_3D8F0(P_Race pRace, P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall Q_Race_ReplaceOrbitalPlanetItem_sub_3E020(P_Race pRace, P_Planet pPlanet, UBYTE newItemIndex);
int __fastcall Q_Race_BuildOptimalOrbitalPlanetItem_sub_3E1CC(P_Race pRace, P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall Q_Race_HandleAdvancedPlanetDevelopment_sub_3E520(P_Race pRace, P_Planet pPlanet);
int __fastcall sub_3E800(_BYTE *, unsigned __int16 *);
__int16 __fastcall sub_3EA7C(P_Race pRace);
void __fastcall sub_3EBDC(P_Race pRace, P_Ship pShip);
int __fastcall Q_Race_GetMoreAllowedShips_sub_3EFE0(P_Race pRace);
void __fastcall Q_Race_DetermineAndBuildOptimalShip_sub_3F060(P_Race pRace, P_Ship pShip, P_Planet pPlanet, unsigned __int8 a4);
void __fastcall Q_Race_BuildSmallShip_sub_3F324(P_Race pRace, char generator, char drive, char weapon, char shield, char lane, P_Ship pShip, unsigned __int8 a8);
void __fastcall Q_Race_BuildMediumShip_sub_3F3F8(P_Race pRace, char generator, char drive, char weapon, char shield, char lane, P_Ship pShip, unsigned __int8 a8);
void __fastcall Q_Race_BuildLargeShip_sub_3F784(P_Race pRace, BYTE a2, BYTE a3, BYTE a4, BYTE a5, BYTE a6, P_Ship pShip, unsigned __int8 a8);
void __fastcall Q_Race_BuildEnormousShip_sub_3FBAC(T_Race *eax0, char, char, char, char, char, _DWORD *pShip, unsigned __int8);
void __fastcall sub_40084(P_Race pRace, P_Ship pShip, int startCell, BYTE restGizmoIndex);
T_Ship *__fastcall sub_40144(P_Race pRace, P_Planet pPlanet);
int __fastcall Q_CompareShipsByDayBuilt_sub_40218(P_Ship *ppShip1, P_Ship *ppShip2); // idb
int __fastcall Q_Race_GetShips_sub_40224(P_Race pRace, P_ShipsList pShipsList, int *totalSize);
int __fastcall Q_Race_GetPlanetsNum_sub_402E0(P_Race pRace);
P_Planet __fastcall Q_Race_GetMostInterestingPlanet_sub_403C0(P_Race pRace, P_Star pStar);
MACRO_VFX_BOOL __fastcall Q_Race_HasDiscoveredAllTechs_sub_40590(P_Race pRace);
unsigned int __fastcall sub_405F4(P_Race pRace);
int __fastcall Q_Race_GetTechsNum_sub_40664(P_Race ppRace);
int __fastcall sub_406C4(P_Race pRace, P_Star pStar, P_Target pTarget);
// int __userpurge sub_41268@<eax>(T_Race *@<eax>, __int16@<dx>, int ecx0@<ecx>, int@<ebx>, P_TargetObject@<ebp>, int, __int16, int, int, int, T_Star *, int);
unsigned int __fastcall sub_43184(int, int, int);
char __fastcall Q_Race_GetEnemyRacesMask_sub_43374(P_Race pRace, int threshold);
MACRO_VFX_BOOL __fastcall Q_Race_DecayRelations_sub_433E0(P_Race pRace, WORD raceIndex, P_Star pStar);
MACRO_VFX_BOOL __fastcall Q_Race_UseAbility_sub_434E4(P_Race pRace, int doUse);
int __fastcall Q_Race_GetRateFromAttitude_sub_43B7C(P_Race pRace, WORD raceIndex);
void __fastcall Q_Race_ReadWriteFile_sub_43BDC(P_Race pRace, P_CFile fi, int read);
void __fastcall Q_Race_LoadDIPFile_sub_43C80(P_Race pRace);
unsigned int __fastcall sub_44024(_BYTE *, char);
T_Race *__fastcall sub_44080(P_Race a1);
int __fastcall sub_44238(int, __int16, _BYTE *, __int16);
char __fastcall sub_44434(P_Race pRace, __int16 a2, _DWORD *a3);
int __fastcall sub_44A2C(_BYTE *, int, char, _BYTE *);
char __fastcall sub_44BCC(T_Race *, __int16 *, char, int, int *);
void __fastcall sub_450B0(P_Race a1, __int16 a2, char a3, char a4, int a5, int a6);
// int __usercall sub_45848@<eax>(unsigned __int8 *@<eax>, int@<edx>, int@<ebx>, __int16 *@<edi>);
int __fastcall Q_Race_CalculateShipsAtLocation_sub_45958(P_Race pRace, BYTE treaty, P_Location targetLocation, LONG *strengthOut);
int __fastcall sub_45A0C(_BYTE *, int, int, __int16);
unsigned int __fastcall Q_Race_HandlePlayerShipArrivalAtStar_sub_45A54(P_Race pRace, P_Star pStar, P_Ship pShip);
MACRO_VFX_BOOL __fastcall Q_Race_HandleStarSystemEntry_sub_45D50(P_Race pRace, P_Star pStar, P_Ship pShip);
unsigned int __fastcall sub_45E64(_BYTE *, __int16);
void __fastcall sub_45F60(_BYTE *, __int16, int);
unsigned int __fastcall sub_46034(_BYTE *, __int16);
void __fastcall sub_46130(_BYTE *, __int16, int);
unsigned int __fastcall sub_46208(_BYTE *, __int16);
int __fastcall sub_46304(_BYTE *, __int16, int);
void Q_Research_StaticCtor_sub_46470();
void __fastcall __spoils<eax,edx> Q_Research_LoadResTreeTxt_sub_46480(P_Research pResearch, const char *fname);
int __fastcall Q_Research_DoProgress_sub_466FC(P_Research pResearch);
void __fastcall Q_Research_CheckAllTechForShip_sub_468BC(P_Research pResearch);
MACRO_VFX_BOOL __fastcall Q_Research_HasAllTechsForShip_sub_46900(P_Research pResearch, char raceIndex);
MACRO_VFX_BOOL __fastcall Q_ResTree_TechIsAvailableToRace_sub_4694C(P_Research pResTree, unsigned __int16 techIndex, __int16 raceIndex);
int __fastcall sub_469F0(P_Research pResTree, unsigned __int16 raceIndex);
__int16 __fastcall sub_46A94(P_Research a1, unsigned __int16 raceIndex, int a3);
void __fastcall Q_ReadWriteResTree_sub_46BB0(P_Research a1, P_CFile a2, int read);
void __fastcall __spoils<> Q_ResTreeCtor_sub_46C10(P_Research a1);
int __fastcall Q_GetTurnsToComplete_sub_46C20(int cost, int done, int production);
void __fastcall __spoils<edx> Q_Wnd9RWDtor_sub_46C48(P_Wnd9RW, char);
void __fastcall sub_46CAC(P_Wnd9RW a1);
int __fastcall sub_47088(P_Wnd9RW);
unsigned int __fastcall sub_47224(P_Wnd9RW a1, UWORD message, int param1, ULONG param2);
int __fastcall compar(WORD *a1, WORD *a2); // idb
void __fastcall sub_47ABC(P_Wnd9RW pWnd9RW);
int __fastcall sub_48B14(int, unsigned int count, int);
void __fastcall __spoils<> Q_Wnd9RWCtor_sub_48B40(P_Wnd9RW a1);
void __fastcall __spoils<> Q_Ship_Ctor_sub_48B90(P_Ship pShip);
int __cdecl Q_ShipDtor_sub_48C58();
void __fastcall sub_48C5C(P_Ship pShip, char hullSize);
void __fastcall Q_Ship_LoadGizmosTxt_sub_48C84(P_Ship pShip);
void __fastcall sub_48EAC(P_Ship pShip);
void __fastcall Q_Ship_SetSize_sub_49148(P_Ship pShip, char hullSize);
MACRO_VFX_BOOL __fastcall Q_Ship_PutNewGizmoIntoCell_sub_492AC(P_Ship pShip, BYTE gizmoIndex, int hullCellIndex);
MACRO_VFX_BOOL __fastcall Q_Ship_RemoveGizmoFromCell_sub_492F8(P_Ship pShip, int hullCellIndex);
int __fastcall Q_Ship_FindFirstCellWithCat_sub_49328(P_Ship pShip, BYTE category);
int __fastcall Q_Ship_FindGizmoHullCellIndex_sub_4937C(P_Ship pShip, UBYTE gizmoIndex);
MACRO_VFX_BOOL __fastcall Q_Ship_ChangeHullSize_sub_493BC(P_Ship pShip, BYTE newHullSize);
void __fastcall Q_Ship_MoveIntoOrbit_sub_49494(P_Ship pShip, P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall Q_Ship_CanTraverseStarLane_sub_4960C(P_Ship pShip, P_Lane pLane);
void __fastcall Q_Ship_EnterStarLane_sub_49648(P_Ship pShip, P_Lane pLane);
void __fastcall Q_Ship_SetPositionAndSnapToGrid_sub_496BC(P_Ship pShip, P_Vector3D newPosition);
void __fastcall Q_Ship_RecalcStats_sub_496E0(P_Ship pShip);
void __fastcall sub_49828(P_Ship pShip);
void __fastcall Q_Ship_RemoveFromTheGame_sub_49940(P_Ship pShip);
void __fastcall Q_Ship_SetAllShieldsState_sub_49A40(P_Ship pShip, BOOL active);
void __fastcall Q_Ship_ToggleGizmo_sub_49A8C(P_Ship pShip, P_HullCell pHulleCell);
int __fastcall sub_49B3C(P_Ship pShip, int a2);
int __fastcall sub_49B68(P_Ship pShip, int a2);
int __fastcall sub_49CC4(P_Ship pShip, int a2);
int __fastcall sub_4A0D0(P_Ship pShip, int a2);
int __fastcall Q_Ship_GetGizmosCost_sub_4A144(P_Ship pShip);
int __fastcall Q_Ship_GetCost_sub_4A18C(P_Ship pShip);
int __fastcall Q_Ship_UpgradePotential_sub_4A1CC(P_Ship pShip, WORD raceIndex);
char __fastcall Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(P_Ship pShip, BYTE cat, WORD raceIndex);
int __fastcall Q_Ship_GizmoIsResearchedByRace_sub_4A404(P_Ship pShip, BYTE gizmoIndex);
P_HullCell __fastcall sub_4A480(P_Ship pShip, unsigned __int16 a2, P_TargetObject a3);
MACRO_VFX_BOOL __fastcall Q_Ship_HasGizmo_sub_4A534(P_Ship pShip, BYTE gizmoIndex);
unsigned int __fastcall sub_4A564(int);
void __fastcall Q_Ship_RecalculateTurnResources_sub_4A5B8(P_Ship pShip);
void __fastcall Q_Ship_Turn_sub_4A6AC(P_Ship pShip);
int __fastcall Q_Ship_GetRank_sub_4A8CC(P_Ship pShip);
int __fastcall Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(P_Ship pShip);
int __fastcall Q_Ship_CalculateCombatRating_sub_4A988(P_Ship pShip);
int __fastcall Q_Ship_OrderToStar_sub_4AA78(P_Ship pShip, P_Star pStar);
int __fastcall Q_Ship_CheckScannedInSystemByRace_sub_4AAEC(P_Ship pShip, int byRaceIndex);
void __fastcall Q_Ship_ReadWrite_sub_4AE8C(P_Ship pShip, P_CFile pfi, int read);
void __fastcall Q_HullCell_Copy_sub_4B5C0(P_HullCell dst, P_HullCell src);
void __fastcall Q_Ship_Copy_sub_4B5E0(P_Ship dst, P_Ship src);
void __fastcall Q_HullCell_Copy_sub_4B780(P_HullCell tgt, P_HullCell src);
int __fastcall Q_Ship_ApplyDamage_sub_4B7A0(P_Ship pShip, int makeChanges, int requestedDamage, WORD attackerRaceIndex);
int __fastcall sub_4B944(P_Ship pShip, int makeChanges);
int __fastcall Q_Ship_ActivatePlanetGizmo_sub_4C7FC(P_Ship pShip, int bShouldConsumePower);
int __fastcall Q_Ship_ActivateLaneGizmo_sub_4CAB8(P_Ship pShip, int a2);
int __fastcall Q_Ship_ActivateNoTargetGizmo_sub_4CDF8(P_Ship pShip, int a2);
void Q_Ship_StaticCtor_sub_4D700();
int __fastcall sub_4D724(PANE *pPane, int a2, LONG shapeNumber, int bWipe);
unsigned int __fastcall Q_GetHullCellIndexAtPos_sub_4D7A8(int x, int y, int hullSize);
P_Wnd08SW __fastcall Q_Wnd8SWCtor_sub_4D92C(P_Wnd08SW pWnd);
T_WndA2 *__fastcall Q_Wnd08SWDtor_sub_4DA08(int, char, int, int);
void __fastcall __spoils<> sub_4DA5C(P_Wnd08SW pWnd);
int __fastcall sub_4DA7C(P_Wnd08SW pWnd8SW, P_Ship pShip, int a3, int a4);
void __fastcall sub_4DD14(int);
int __fastcall Q_Wnd08SW_Proc3_sub_4DDB0(P_Wnd08SW pWnd08SW, UWORD message, int param1, int param2);
int __fastcall sub_4E644(int result, char, int, int);
unsigned int __fastcall sub_4E69C(int);
void __fastcall Q_Wnd08SW_Proc4_sub_4E758(P_Wnd08SW pWnd, int a2);
int __fastcall Q_Wnd08SW_CalculateShipRefitCost_sub_4EE00(P_Wnd08SW pWnd08SW);
void __fastcall Q_SSystem_StaticCtor_sub_4EE50();
void __fastcall __spoils<> Q_SSystem_Ctor_sub_4EE74(P_SSystem self);
T_SSystem *__fastcall Q_SSystem_Dtor_sub_4EF94(T_SSystem *);
LONG __fastcall Q_SSystem_Start_sub_4EFB0(P_SSystem a1, int aDIG, int aMDI);
HMDIDRIVER __fastcall sub_4F028(P_SSystem a1, char *a2, char *a3, char *a4, char *a5);
HMDIDRIVER __fastcall Q_SSystem_MIDI_sub_4F088(P_SSystem a1, char *a2, char *a3, char *a4);
void __fastcall Q_SSystem_MIDI_sub_4F184(P_SSystem a1, int a2);
void __fastcall Q_SSystem_StartSequence_sub_4F32C(P_SSystem a1, __int16 track, int a3);
void __fastcall Q_SSystem_EndSequence_sub_4F45C(P_SSystem a1, __int16 index);
void __fastcall Q_SSystem_MIDI_sub_4F4D4(P_SSystem a1, __int16 a2);
HDIGDRIVER __fastcall Q_SSystem_StartDIG_sub_4F534(P_SSystem a1, const char *dirName, const char *fileName);
int __fastcall Q_SSystem_AllocateSamples_sub_4F5E8(P_SSystem a1, int a2);
unsigned int __fastcall Q_SSystem_LoadMusic_sub_4F65C(P_SSystem a1, const char *aMusicFName);
MACRO_VFX_BOOL __fastcall sub_4F8CC(P_SSystem, __int16 track, int setpos);
void __fastcall Q_SSystem_StopSample_sub_4FA1C(P_SSystem a1);
void __fastcall Q_SSystem_PlayMusic_sub_4FAB4(P_SSystem pSSystem);
void __fastcall Q_SSystem_StartSample_sub_4FB90(P_SSystem a1, __int16 a2);
void __fastcall Q_SSystem_Stop_sub_4FE8C(P_SSystem a1);
void __fastcall Q_SSystem_SetNoSound_sub_4FF08(P_SSystem a1);
void __fastcall sub_4FF1C(P_SSystem a1);
void __fastcall sub_4FF28(P_SSystem a1);
void __fastcall Q_SSystem_SetVolume_sub_4FF4C(P_SSystem a1, char newVolume);
int __fastcall Q_SSystem_LoadSoundfxTxt_sub_4FF94(P_SSystem a1);
char *__fastcall sub_50140(P_SSystem, __int16);
UWORD __fastcall sub_50530(T_Type5 *a1, P_Planet pPlanet, int a3, int a4);
void __fastcall sub_50D70(PPANE pPANE, P_Ship pShip, int a3, int a4);
void __fastcall sub_51610(PPANE pPane, LONG shapeNumber, int a3, BOOL bWipe);
void __fastcall __spoils<> Q_Wnd16SW_Ctor_sub_51674(P_Wnd16SW a1);
T_WndA2 *__fastcall Q_Wnd16SW_Dtor_sub_51690(T_WndA2 *, char);
void __fastcall __spoils<> Q_A11_sub_516D4(P_TypeA11 result);
void __fastcall Q_Wnd16SW_Proc4_sub_516E0(_DWORD *);
int __fastcall Q_Wnd16SW_Proc3_sub_51894(int, __int16, __int16, LONG);
void __fastcall __spoils<> Q_Wnd17FW_Ctor_sub_51B64(P_Wnd17FW a1);
T_WndA2 *__fastcall Q_Wnd17FW_Dtor_sub_51B80(T_WndA2 *, char);
void __fastcall Q_Wnd17FW_Proc4_sub_51BC4(P_Wnd17FW pWnd, int a2);
int __fastcall Q_Wnd17FW_Proc3_sub_51D24(P_Wnd17FW pWnd, UWORD message, int param1, int param2);
void __fastcall __spoils<> Q_WndNGCtor_sub_520EC(P_Wnd18NG a1);
T_WndA2 *__fastcall Q_Wnd18NG_Dtor_sub_52108(T_WndA2 *, char);
void __fastcall Q_WndNG_sub_5214C(P_Wnd18NG result);
int __fastcall Q_Wnd18NG_LoadSpeciesDescriptions_sub_52174(P_Wnd18NG pWnd18NG);
void __fastcall Q_Wnd18NG_Proc4_sub_521C0(P_Wnd18NG pWnd18NG, int a2);
MACRO_VFX_BOOL __fastcall Q_Wnd18NG_IsMouseInBeginNewGameButton_sub_526D8(P_Wnd18NG pWnd);
int __fastcall sub_52714(P_Wnd18NG pWnd);
int __fastcall Q_Wnd18NG_Proc3_sub_5294C(P_Wnd18NG pWnd18NG, UWORD message, int param1, int param2);
void __fastcall Q_Vector3D_Normalize_sub_53000(P_Vector3D pVector);
void __fastcall Q_Vector3D_SetLength_sub_53054(P_Vector3D pVector, float length);
MACRO_VFX_BOOL __fastcall Q_Vector3D_IsZero_sub_53078(P_Vector3D v);
double __fastcall Q_Vector3D_AngleBetween_sub_5309C(P_Vector3D a1, P_Vector3D a2);
void __fastcall __spoils<> Q_M33xV_sub_53114(P_Vector3D v, T_Matrix3x3 *m);
void __fastcall Q_Vector3D_RotateX_sub_5323C(P_Vector3D v, float degrees);
void __fastcall Q_Vector3D_RotateY_sub_532AC(T_Vector3D *vector, float degrees);
void __fastcall Q_Vector3D_RotateZ_sub_53318(P_Vector3D vector, float degrees);
void __fastcall __spoils<> Q_M34xV_sub_53384(P_Vector3D v, T_Matrix3x4 *trs, P_Vector3D result);
void __fastcall Q_Project3DTo2D_sub_533D4(P_Vector3D v, float scaleFactor, int xOffset, int yOffset, WORD *outX, WORD *outY);
void __fastcall Q_Vector3D_SnapToGrid_sub_53440(P_Vector3D pVector);
void __fastcall Q_Matrix_RotateX_sub_5353C(P_Matrix3x3D mat, float degrees);
void __fastcall Q_Matrix_RotateY_sub_53564(P_Matrix3x3D mat, float degrees);
void __fastcall Q_Matrix_RotateZ_sub_5358C(P_Matrix3x3D mat, float degrees);
void __fastcall Q_Matrix_RotateXX_sub_535B4(P_Matrix3x3D mat, float degrees);
// void __userpurge Q_Matrix_RotateYY_sub_535E4(P_Matrix3x3D mat@<eax>, float degrees);
void __fastcall Q_Matrix_Orthonormalize1_sub_53644(P_Matrix3x3D a1);
void __fastcall Q_Matrix_Orthonormalize2_sub_53754(P_Matrix3x3D mat);
void __fastcall Q_Matrix_Orthonormalize3_sub_53864(P_Matrix3x3D mat);
void __fastcall __spoils<> Q_BuildTransformMatrix_sub_53B08(T_Matrix3x4 *trs, T_Matrix3x3 *a, T_Matrix3x3 *r, P_Vector3D t);
int __cdecl sub_53D22(int);
void Q_WinMgr_StaticCtor_sub_53DC0();
void __cdecl Q_TimerIncrease_sub_53DE4();
int Q_CheckFreeMemory_sub_53DEC();
void __fastcall Q_DrawRaceFlagTinted_sub_53E38(PANE *pane, LONG hotX, LONG hotY, WORD raceIndex);
void __fastcall Q_DrawRaceTintedShape_sub_53EB8(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY, WORD raceIndex);
void __fastcall Q_DrawTintedShape_sub_53F40(PANE *pPane, void *shapeTable, LONG shapeNumber, LONG hotX, LONG hotY, char colorSet);
void __fastcall Q_LoadGam_sub_53FB0(const char *fname);
T_CFile *__fastcall Q_SaveGam_sub_54048(const char *fname);
LONG __fastcall Q_CopyPaneToBuffer_sub_54208(PANE *sourcePane);
LONG __fastcall Q_CopyBufferToPane_sub_542B0(PANE *targetPane);
void __fastcall __spoils<> Q_WinMgr_Ctor_sub_54344(P_WinMgr a1);
void __fastcall Q_WinMgrDtor_sub_54374(P_WinMgr pWinMgr);
T_WinData *__fastcall Q_WinMgr_Init_sub_54448(P_WinMgr pWinMgr);
unsigned int __fastcall Q_WINMGR_CPP_StartTimer_sub_545EC(P_WinMgr a1);
void __fastcall Q_WinMgr_StopAndReleaseAILTimer_sub_54664(P_WinMgr pWinMgr);
int __fastcall sub_5469C(P_WinMgr pWinMgr);
unsigned int __fastcall Q_WinMgr_AltScanCodes_sub_54D64(P_WinMgr pWinMgr);
void __fastcall Q_WinMgr_OverlayEffects_sub_5508C(P_WinMgr pWinMgr);
void __fastcall Q_WinMgr_WipeAndAddDirtyArea_sub_55214(P_WinMgr pWinMgr, LONG x0, LONG y0, LONG x1, int y1);
void __fastcall Q_WinMgr_AddDirtyArea_sub_55274(P_WinMgr pWinMgr, int x0, int y0, int x1, int y1);
void __fastcall Q_WinMgr_AddDirtyArea_sub_552CC(P_WinMgr pWinMgr, PANE *pPane);
int __fastcall sub_552F8(P_WinMgr pWinMgr, P_WndA2 a2, int a3);
void __fastcall sub_55554(int, _DWORD *);
void __fastcall sub_55618(P_WinMgr a1);
void __fastcall Q_WinMgr_ShowMsgBox_sub_556CC(P_WinMgr pWinMgr, char *a2);
char *__fastcall sub_557D4(T_WinMgr *pWinMgr, char *wndName, const char *newText, WORD maxTextLength);
MACRO_VFX_BOOL __fastcall Q_WinMgr_AddGameEvent_sub_55AEC(P_WinMgr pWinMgr, int eventId, int p1, int p2);
void __fastcall sub_55B74(P_WinMgr pWinMgr);
void __fastcall sub_55E80(P_WinMgr pWinMgr);
void __fastcall Q_WinMgr_sub_56400(T_WinMgr *pWinMgr, int a2, __int16 a3, int a4, int a5, int a6);
void __fastcall Q_WinMgr_sub_564C0(T_WinMgr *pWinMgr, int a2, __int16 a3);
int __fastcall sub_56528(P_WinMgr pWinMgr, int a2, __int16 a3);
unsigned int __fastcall sub_56564(P_WinMgr pWinMgr, int a2, __int16 a3, int a4);
int __fastcall sub_56694(T_WinMgr *);
void __fastcall Q_WinMgr_AddWinEventSmall_sub_56728(P_WinMgr pWinMgr, int hwnd, int f, WORD msg, int p1, int p2);
void __fastcall Q_WinMgr_RemoveWinEventSmall_sub_567BC(P_WinMgr a1, int hwnd, WORD message);
void __fastcall sub_56824(P_WinMgr pWinMgr);
void __fastcall sub_5691C(P_WinMgr pWinMgr);
void __fastcall Q_WinMgr_QueueMessage_sub_56B60(P_WinMgr pWinMgr, WORD message, LONG param1, LONG param2);
void __fastcall sub_56BE8(P_WinMgr pWinMgr, UWORD message, int param1, int param2, int a5);
int __fastcall Q_WinMgr_DispatchMessageProc3_sub_56D30(P_WinMgr pWinMgr, int wndIndex, WORD message, LONG param1, LONG param2);
T_WndA2 *__fastcall Q_WinMgr_DispatchMessageProc3_sub_56D70(P_WinMgr pWinMgr, char *wndName, WORD message, LONG param1, LONG param2);
T_WndA2 *__fastcall Q_WinMgr_FindWnd_sub_56DA8(P_WinMgr pWinMgr, char *name, WORD *outIndex);
T_WndA2 *__fastcall Q_WinMgr_FindWndWithState_sub_56E18(P_WinMgr pWinMgr, char *name, WORD state, WORD *outIndex);
void __fastcall sub_56E9C(P_WinMgr pWinMgr, WORD stateIndex, BOOL a3);
int __fastcall sub_570AC(P_WinMgr pWinMgr, BOOL a2);
int __fastcall Q_WinMgr_RegisterWindow_sub_571B8(P_WinMgr pWinMgr, P_WndA2 pWnd);
MACRO_VFX_BOOL __fastcall Q_WinMgr_AddWindowToState_sub_57220(P_WinMgr pWinMgr, int windowIndex, WORD state);
MACRO_VFX_BOOL __fastcall sub_57310(P_WinMgr pWinMgr, int a2, WORD stateIndex, int a4);
unsigned int __fastcall sub_5748C(P_WinMgr a1, __int16 stateNumber, __int16 a3);
void __fastcall Q_WinMgr_SetStateProc1_sub_574F0(P_WinMgr pWinMgr, WORD stateIndex, void *proc);
void __fastcall Q_WinMgr_SetStateProc2_sub_57510(P_WinMgr pWinMgr, WORD stateIndex, void *proc);
void __fastcall sub_57530(P_WinMgr pWinMgr, int wndIndex, int a3);
void __fastcall sub_575BC(P_WinMgr);
void __fastcall Q_WINMGR_CPP_LoadWindowsTxt_sub_57670(P_WinMgr pWinMgr, const char *fname);
void __fastcall Q_LoadAscendCfg_sub_59828(P_WinMgr);
void __fastcall Q_SaveAscendCfg_sub_5989C(P_WinMgr pWinMgr);
void __fastcall __spoils<> sub_59908(P_WinMgr pWinMgr);
void __fastcall Q_WinMgr_RecordWinEvents_sub_59934(P_WinMgr pWinMgr, int toTxt);
MACRO_VFX_BOOL __fastcall Q_WinMgr_PlayWinEvents_sub_59988(P_WinMgr, char *wineventBinFileName, int);
P_WinMgr __fastcall sub_59A54(P_WinMgr a1);
void __fastcall sub_59B80(P_WinMgr pWinMgr);
void __fastcall Q_WinMgr_sub_59C80(P_WinMgr pWinMgr, int hwnd, WORD eventType, WORD msg, int p1, int p2, int f);
MACRO_VFX_BOOL __fastcall sub_59CFC(P_WinMgr, const char *);
void __fastcall Q_WINMGR_CPP_WriteWinEventBin_sub_59DE0(P_WinMgr a1);
void __fastcall Q_WINMGR_CPP_WinEventBinToTxt_sub_59E88(P_WinMgr pWinMgr, char *binname, char *txtname);
void __fastcall Q_WinMgr_AddWinData_sub_5A094(P_WinMgr pWinMgr, void *pData, int category, char *name);
void __fastcall Q_WinMgr_RemoveWinData_sub_5A144(P_WinMgr pWinMgr, void *pData);
char *__fastcall sub_5A194(P_WinMgr pWinMgr, void *a2, int *outCategory, int *outTime);
void __fastcall Q_WinMgr_SetMousePointerShape_sub_5A270(P_WinMgr pWinMgr, int mouseShapeNumber, void *table, BOOL bForce);
void __fastcall Q_WinMgr_CallProc6_sub_5A294(P_WinMgr a1, P_CFile pfi, int read);
void __fastcall Q_Proc_sub_5A320(__int16);
void __fastcall sub_5A47C(PANE *pPane, void *pData, int param1, BOOL hovered);
LONG __fastcall sub_5A4E4(PANE *a1, LONG a2, int a3, int a4);
void __fastcall __spoils<> Q_Wnd13DBGWND_Ctor_sub_5A594(P_Wnd13DBGWND a1);
void __fastcall __spoils<edx> Q_Wnd13DBGWND_Dtor_sub_5A5AC(P_Wnd13DBGWND self, unsigned int a2);
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_5A5F4(P_Wnd a1);
MACRO_VFX_BOOL __fastcall Q_Wnd13DBGWND_Proc3_sub_5A60C(P_Wnd13DBGWND pWnd13DBGWND, UWORD message, int param1, int param2);
void __fastcall Q_Wnd13DBGWND_Proc4_sub_5AA08(P_Wnd13DBGWND pWnd13DBGWND, int a2);
int __fastcall proc(const char **, const char **);
void __fastcall sub_5AB2C(P_Wnd13DBGWND a1, P_Wnd10LB result);
int __fastcall sub_5AE68(P_Wnd13DBGWND pDbgWnd, P_Wnd10LB pListBox);
MACRO_VFX_BOOL __fastcall sub_5AF30(int, T_Wnd10LB *);
int __fastcall sub_5B200(P_Wnd13DBGWND a1, T_Wnd10LB *a2);
int __fastcall sub_5B244(int result, T_Wnd10LB *);
T_WndA2 *__fastcall sub_5B2B0(T_WndA2 *, char);
T_WndA2 *__fastcall sub_5B2F0(T_WndA2 *result);
T_WndA2 *__fastcall sub_5B300(T_WndA2 *, char);
T_WndA2 *__fastcall sub_5B340(T_WndA2 *result);
// PANE_LIST *__fastcall VFX_pane_list_construct(LONG n_entries);
// void __fastcall VFX_pane_list_clear(PANE_LIST *list);
// LONG __fastcall VFX_pane_list_add_area(PANE_LIST *list, WINDOW *window, LONG x0, LONG y0, LONG x1, LONG y1);
// void __fastcall VFX_pane_list_refresh(PANE_LIST *list);
// BYTE *__cdecl VFX_driver_name(void *VFXScanDLL);
// LONG __cdecl VFX_register_driver(void *DLLbase);
// LONG __cdecl VFX_pixel_write(PANE *pane, LONG x, LONG y, ULONG color);
// LONG __cdecl VFX_pixel_read(PANE *pane, LONG x, LONG y);
// LONG __cdecl VFX_line_draw(PANE *pane, LONG x0, LONG y0, LONG x1, LONG y1, LONG mode, LONG parm);
// void __cdecl VFX_shape_draw(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY);
// void __cdecl VFX_shape_lookaside(UBYTE *table);
// void __cdecl VFX_shape_translate_draw(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY);
// void __cdecl VFX_shape_transform(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY, void *buffer, LONG rot, LONG x_scale, LONG y_scale, LONG flags);
// void __cdecl VFX_shape_visible_rectangle(void *shape_table, LONG shape_number, LONG hotX, LONG hotY, LONG mirror, RECT *rectangle);
// LONG __cdecl VFX_pane_wipe(PANE *pane, LONG color);
// LONG __cdecl VFX_pane_copy(PANE *source, LONG sx, LONG sy, PANE *target, LONG tx, LONG ty, LONG fill);
// void __cdecl VFX_ellipse_draw(PANE *pane, LONG xc, LONG yc, LONG width, LONG height, LONG color);
// void __cdecl VFX_ellipse_fill(PANE *pane, LONG xc, LONG yc, LONG width, LONG height, LONG color);
// LONG __cdecl VFX_font_height(VFX_FONT *font);
// LONG __cdecl VFX_character_width(void *font, LONG character);
// LONG __cdecl VFX_character_draw(PANE *pane, LONG x, LONG y, void *font, LONG character, UBYTE *color_translate);
// void __cdecl VFX_string_draw(PANE *pane, LONG x, LONG y, void *font, char *string, UBYTE *color_translate);
// LONG __cdecl VFX_GIF_draw(PANE *pane, UBYTE *GIF_buffer, void *GIF_scratch);
// LONG __cdecl VFX_shape_resolution(void *shape_table, LONG shape_num);
// LONG __cdecl VFX_shape_count(void *shape_table);
// void __cdecl VFX_window_fade(WINDOW *buffer, RGB *palette, LONG intervals);
// void __cdecl VFX_flat_polygon(PANE *pane, LONG vcnt, SCRNVERTEX *vlist);
// void __cdecl VFX_translate_polygon(PANE *pane, LONG vcnt, SCRNVERTEX *vlist, void *lookaside);
// void MOUSE_show(void);
// void MOUSE_hide(void);
// void __fastcall MOUSE_set_pointer(void *table, LONG shape);
// void __fastcall MOUSE_status(LONG *mx, LONG *my, LONG *ml, LONG *mr, LONG *mc);
// void __fastcall MOUSE_force_move(LONG new_x, LONG new_y);
// void __fastcall MOUSE_pane_list_refresh(PANE_LIST *list);
// LONG __fastcall MOUSE_init(LONG xsize, LONG ysize);
// void MOUSE_shutdown(void);
// void *__cdecl DLL_load(void *source, ULONG flags, void *dll);
// void __cdecl AIL_startup();
// void __cdecl AIL_shutdown();
// HTIMER __cdecl AIL_register_timer(AILTIMERCB callback_fn);
// void __cdecl AIL_set_timer_frequency(HTIMER timer, ULONG hertz);
// void __cdecl AIL_start_timer(HTIMER timer);
// void __cdecl AIL_stop_timer(HTIMER timer);
// void __cdecl AIL_release_timer_handle(HTIMER timer);
// LONG __cdecl AIL_install_DIG_INI();
// HDIGDRIVER __cdecl AIL_install_DIG_driver_file(BYTE *filename, IO_PARMS *IO);
// HSAMPLE __cdecl AIL_allocate_sample_handle(HDIGDRIVER dig);
// void __cdecl AIL_init_sample(HSAMPLE S);
// void __cdecl AIL_set_sample_address(HSAMPLE S, void *start, ULONG len);
// void __cdecl AIL_set_sample_type(HSAMPLE S, LONG format, ULONG flags);
// void __cdecl AIL_start_sample(HSAMPLE S);
// void __cdecl AIL_stop_sample(HSAMPLE S);
// void __cdecl AIL_set_sample_playback_rate(HSAMPLE S, LONG playback_rate);
// void __cdecl AIL_set_sample_volume(HSAMPLE S, LONG volume);
// void __cdecl AIL_set_sample_loop_count(HSAMPLE S, LONG loop_count);
// ULONG __cdecl AIL_sample_status(HSAMPLE S);
// LONG __cdecl AIL_minimum_sample_buffer_size(HDIGDRIVER dig, LONG playback_rate, LONG format);
// LONG __cdecl AIL_sample_buffer_ready(HSAMPLE S);
// void __cdecl AIL_load_sample_buffer(HSAMPLE S, ULONG buff_num, void *buffer, ULONG len);
// LONG __cdecl AIL_install_MDI_INI();
// HMDIDRIVER __cdecl AIL_install_MDI_driver_file(BYTE *filename, IO_PARMS *IO);
// HSEQUENCE __cdecl AIL_allocate_sequence_handle(HMDIDRIVER mdi);
// void __cdecl AIL_start_sequence(HSEQUENCE S);
// void __cdecl AIL_stop_sequence(HSEQUENCE S);
// void __cdecl AIL_end_sequence(HSEQUENCE S);
// ULONG __cdecl AIL_sequence_status(HSEQUENCE S);
// void __cdecl AIL_set_GTL_filename_prefix(BYTE *prefix);
// __int16 UVB_sub_7501C();
// FILE *__usercall UVB_sub_75098@<eax>(int@<eax>, int@<edx>, int@<ecx>, int@<ebx>, char *, int);
// int sprintf(char *s, const char *format, ...);
// char *__fastcall _wcpp_2_dtor_array_store_(void *a1, rt_type_sig_clss *a2);
// void __fastcall operator delete[](void *); weak
// void __fastcall operator delete(void *); weak
// int __fastcall strcmp(const char *s1, const char *s2);
// double __fastcall sqrt(double x);
// void _CHP();
// void __fastcall __spoils<edx> memset(void *s, int c, size_t n);
// void __fastcall qsort(void *base, size_t nmemb, size_t size, int (__fastcall *compar)(const void *, const void *));
// void __fastcall __spoils<edx,ebx> _wcpp_2_ctor_array_(void *array, unsigned int count, rt_type_sig_clss *sig);
// int sscanf(const char *s, const char *format, ...);
// int __fastcall fclose(FILE *fp);
// double __fastcall cos(double x);
// double __fastcall sin(double x);
// double __fastcall tan(double x);
// void *__fastcall operator new[](size_t size);
// void __fastcall __spoils<edx,ebx> _wcpp_2_dtor_array_(void *array, int count, rt_type_sig_clss *a3);
// int __fastcall stricmp(const char *s1, const char *s2);
// FILE *__fastcall fdopen(int handle, const char *mode);
// int __fastcall fgetpos(FILE *fp, fpos_t *pos);
// char *__fastcall strncpy(char *s1, const char *s2, size_t n);
// int __fastcall filelength(int handle);
// int open(const char *path, int oflag, ...);
// int __fastcall lseek(int handle, int offset, int origin);
// int __fastcall close(int handle);
// int __fastcall tell(int handle);
// volatile int *__fastcall _get_errno_ptr();
// int __fastcall read(int handle, void *buf, unsigned int len);
// unsigned int __usercall dos_write@<eax>(int handle@<eax>, const void *buf@<ebx>, unsigned int count@<edx>, unsigned int *bytes);
// void __fastcall _assert(int, char *, char *, int);
// int __fastcall write(int handle, const void *buf, unsigned int len);
// FILE *__fastcall fopen(const char *filename, const char *mode);
// int fscanf(FILE *fp, const char *format, ...);
// clock_t clock(void);
// int printf(const char *format, ...);
// int __fastcall atexit(void (*func)(void));
// int getch(void);
// void __fastcall exit(int status);
// int heapchk(void);
// time_t __fastcall time(time_t *timer);
// int rand(void);
// void __fastcall srand(unsigned int seed);
// int __fastcall access(const char *path, int mode);
// char *__fastcall fgets(char *s, int n, FILE *fp);
// void __fastcall __spoils<> _wcpp_2_mod_register_(RW_DTREG *rw);
// int fprintf(FILE *fp, const char *format, ...);
// int __fastcall vsprintf(char *s, const char *format, __va_list arg);
// void *__fastcall malloc(size_t size);
// void *__fastcall calloc(size_t n, size_t size);
// void __fastcall free(void *ptr);
// int __fastcall strnicmp(const char *s1, const char *s2, size_t n);
// int __fastcall atoi(const char *nptr);
// char *__fastcall strdup(const char *string);
// void __fastcall delay(unsigned int milliseconds);
// unsigned int __fastcall dos_getftime(int handle, unsigned __int16 *date, unsigned __int16 *time);
// int __fastcall strncmp(const char *s1, const char *s2, size_t n);
// double __fastcall pow(double x, double y);
// void *__fastcall _wcpp_2_assign_array_(void *tgt_array, void *src_array, unsigned int count, unsigned int size, pFUNcopy opeq);
// void __fastcall __spoils<edx,ebx> _wcpp_2_copy_array_(void *arrayd, void *arrays, int count, rt_type_sig_clss *sig);
// double __fastcall acos(double x);
// void *__fastcall operator new(size_t size);
// char *__fastcall strupr(char *string);
// int __fastcall heapwalk(struct _heapinfo *entry);
// char *__fastcall strcpy(char *dst, const char *src);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_24D9B; // weak
_UNKNOWN loc_24D9E; // weak
_UNKNOWN loc_27281; // weak
__int16 word_53CEA = 0; // weak
__int16 word_53D02 = 0; // weak
__int16 word_53D06 = 0; // weak
__int16 word_53D0A = 0; // weak
__int16 DMPI_real_mode_segment_base_word_53D0C = 0; // weak
__int16 word_53D0E = 0; // weak
int DMPI_selector_dword_53D1C = 0; // weak
double dbl_91DD9 = 4000000.0; // weak
_UNKNOWN unk_920AA; // weak
_UNKNOWN unk_92696; // weak
_UNKNOWN unk_92C97; // weak
rt_type_sig_clss C_Wnd19BC =
{
  0,
  &Q_Wnd19BC_Ctor_sub_10A3C,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd19BC_Dtor_sub_10A80,
  264,
  ""
};
T_Procs Wnd19BC_Procs =
{
  &Q_Wnd19BC_Dtor_sub_10A80,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd19BC_Proc3_sub_10B24,
  &Q_Wnd19BC_Proc4_sub_11870,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Vector3D =
{
  0,
  &Q_Vector3D_Ctor_sub_13BF0,
  &Q_Vector3D_Copy_sub_13BC0,
  &Q_Vector3D_Dtor_sub_13BE0,
  12,
  ""
}; // idb
rt_type_sig_clss C_Wnd04BM =
{
  0,
  &Q_Wnd04BM_Ctor_sub_15ED4,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd04BM_Dtor_sub_1604C,
  20558,
  ""
};
rt_type_sig_clss C_Type16 =
{
  0,
  &Q_Type16_Ctor_sub_1ABE0,
  &Q_Type16_Copy_sub_1AA40,
  &Q_Type16_Dtor_sub_1ABD0,
  36,
  ""
}; // idb
T_Procs Wnd04BM_Procs =
{
  &Q_Wnd04BM_Dtor_sub_1604C,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd04BM_Proc3_sub_16348,
  &Q_Wnd04BM_Proc4_sub_18CA8,
  &Q_Wnd_Proc5_sub_2CF28,
  &Q_Wnd04BM_Proc6_sub_19E2C
};
rt_type_sig_clss C_Type09 =
{
  0,
  &Q_Type09_Ctor_sub_223E0,
  &_wcpp_2_undefed_cdtor_,
  &Q_Type09_Dtor_sub_223D0,
  414,
  ""
};
rt_type_sig_clss C_Sector =
{
  0,
  &Q_SectorCtor_sub_223B0,
  &_wcpp_2_undefed_cdtor_,
  &Q_SectorDtor_sub_223A0,
  13,
  ""
};
rt_type_sig_clss C_Ship =
{
  0,
  &Q_Ship_Ctor_sub_48B90,
  &Q_Ship_Copy_sub_4B5E0,
  &Q_ShipDtor_sub_48C58,
  354,
  ""
};
rt_type_sig_clss C_Planet =
{
  0,
  &Q_PlanetCtor_sub_22400,
  &_wcpp_2_undefed_cdtor_,
  &Q_PlanetDtor_sub_22340,
  123,
  ""
};
rt_type_sig_clss C_Lane = { 0, &sub_22360, &_wcpp_2_undefed_cdtor_, &sub_22350, 39, "" };
rt_type_sig_clss C_Race =
{
  0,
  &Q_RaceCtor_sub_3B120,
  &_wcpp_2_undefed_cdtor_,
  &Q_RaceDtor_3B184,
  494,
  ""
};
rt_type_sig_clss C_Star =
{
  0,
  &Q_Star_Ctor_sub_1CF40,
  &_wcpp_2_undefed_cdtor_,
  &Q_StarDtor_1CF64,
  96,
  ""
};
rt_type_sig_clss C_Wnd06RSW =
{
  0,
  &Q_Wnd06RSW_Ctor_sub_25CB8,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd06RSW_Dtor_sub_25CD4,
  177,
  ""
};
rt_type_sig_clss C_Wnd05RW =
{
  0,
  &Q_Wnd05RW_Ctor_sub_25BF8,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd05RW_Dtor_sub_25C08,
  171,
  ""
};
rt_type_sig_clss C_Wnd02COSW =
{
  0,
  &Q_Wnd02COSW_Ctor_sub_224A4,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd02COSW_Dtor_sub_22588,
  1430,
  ""
};
T_Procs Wnd06RSW_Procs =
{
  &Q_Wnd06RSW_Dtor_sub_25CD4,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd06RSW_Proc3_sub_26000,
  &Q_Wnd06RSW_Proc4_sub_25D18,
  &Q_Wnd06RSW_Proc5_sub_25FB4,
  &locret_2D460
};
T_Procs Wnd05RW_Procs =
{
  &Q_Wnd05RW_Dtor_sub_25C08,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_WndA2_Proc3_sub_2F424,
  &Q_Wnd05RW_Proc4_sub_25C4C,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs Wnd02COSW_Procs =
{
  &Q_Wnd02COSW_Dtor_sub_22588,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &frame_is_wrong_sub_228A4,
  &Q_Wnd02COSW_Proc4_sub_23BF0,
  &Q_Wnd_Proc5_sub_2CF28,
  &Q_Wnd02COSW_Proc6_sub_24FCC
};
rt_type_sig_clss C_Wnd24EW =
{
  0,
  &Q_Wnd24EW_Ctor_sub_27BF8,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd24EW_Dtor_sub_27C08,
  171,
  ""
};
rt_type_sig_clss C_Wnd30EW =
{
  0,
  &Q_Wnd30EW_Ctor_sub_2712C,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd30EW_Dtor_sub_2713C,
  171,
  ""
};
rt_type_sig_clss C_Wnd23EW =
{
  0,
  &Q_Wnd23EW_Ctor_sub_267A0,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd23EW_Dtor_sub_267BC,
  3507,
  ""
};
T_Procs Wnd24EW_Procs =
{
  &Q_Wnd24EW_Dtor_sub_27C08,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd24EW_Proc3_sub_27C50,
  &Q_Wnd24EW_Proc4_sub_27D18,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs Wnd30EW_Procs =
{
  &Q_Wnd30EW_Dtor_sub_2713C,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd30EW_Proc3_sub_27184,
  &Q_Wnd30EW_Proc4_sub_271FC,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs Wnd23EW_Procs =
{
  &Q_Wnd23EW_Dtor_sub_267BC,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &sub_270F4,
  &sub_27124,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd01FLIC =
{
  0,
  &Q_Wnd01FLIC_Ctor_sub_2AE80,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd01FLIC_Dtor_sub_2AEB0,
  2569,
  ""
};
T_Procs Wnd01FLIC_Procs =
{
  &Q_Wnd01FLIC_Dtor_sub_2AEB0,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd01FLIC_Proc3_sub_2AFF0,
  &locret_2B2BC,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd26MW =
{
  0,
  &Q_Wnd26MW_Ctor_sub_2FA18,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd26MW_Dtor_sub_2FA34,
  179,
  ""
};
rt_type_sig_clss C_WndEDITWND =
{
  0,
  &Q_WndEDITWND_Ctor_sub_2F48C,
  &_wcpp_2_undefed_cdtor_,
  &Q_WndEDITWND_Dtor_sub_2F4A8,
  193,
  ""
};
rt_type_sig_clss C_Wnd15NT =
{
  0,
  &Q_Wnd15NT_Ctor_sub_2F2F4,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd15NT_Dtor_sub_2F30C,
  175,
  ""
};
rt_type_sig_clss C_Wnd10LB =
{
  0,
  &Q_Wnd10LB_Ctor_sub_2E248,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd10LB_Dtor_sub_2E264,
  2306,
  ""
};
rt_type_sig_clss C_Wnd03CTW =
{
  0,
  &Q_Wnd03CTW_Ctor_sub_2D9C4,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd03CTW_Dtor_sub_2D9FC,
  179,
  ""
};
rt_type_sig_clss C_Wnd25TW =
{
  0,
  &Q_Wnd25TW_Ctor_sub_2D464,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd25TW_Dtor_sub_2D480,
  175,
  ""
};
rt_type_sig_clss C_WndA2 =
{
  0,
  &Q_WndA2_Ctor_sub_2C830,
  &_wcpp_2_undefed_cdtor_,
  &Q_WndA2_Dtor_sub_2C848,
  171,
  ""
};
T_Procs Wnd26MW_Procs =
{
  &Q_Wnd26MW_Dtor_sub_2FA34,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd26MW_Proc3_sub_2F420,
  &Q_Wnd26MW_Proc4_sub_2FA98,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs WndEDITWND_Procs =
{
  &Q_WndEDITWND_Dtor_sub_2F4A8,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_WndEDITWND_Proc3_sub_2F6B0,
  &Q_WndEDITWND_Proc4_sub_2F540,
  &locret_2F6AC,
  &locret_2D460
};
T_Procs Wnd15NT_Procs =
{
  &Q_Wnd15NT_Dtor_sub_2F30C,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd15NT_Proc3_sub_2F478,
  &Q_Wnd15NT_Proc4_sub_2F354,
  &Q_Wnd15NT_Proc5_sub_2F414,
  &locret_2D460
};
T_Procs Wnd10LB_Procs =
{
  &Q_Wnd10LB_Dtor_sub_2E264,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd10LB_Proc3_sub_2E3D4,
  &Q_Wnd10LB_Proc4_sub_2E6C0,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs Wnd03CTW_Procs =
{
  &Q_Wnd03CTW_Dtor_sub_2D9FC,
  &Q_Wnd03CTW_Proc2_sub_2DB54,
  &Q_Wnd03CTW_Proc3_sub_2DE68,
  &Q_Wnd03CTW_Proc4_sub_2E084,
  &Q_Wnd_Proc5_sub_2CF28,
  &Q_Wnd03CTW_Proc6_sub_2E1B4
};
T_Procs Wnd25TW_Procs =
{
  &Q_Wnd25TW_Dtor_sub_2D480,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd25TW_Proc3_sub_2D4D0,
  &Q_Wnd25TW_Proc4_sub_2D528,
  &Q_Wnd25TW_Proc5_sub_2D79C,
  &Q_Wnd25TW_Proc6_sub_2D99C
};
T_Procs WndA2_Procs =
{
  &Q_WndA2_Dtor_sub_2C848,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_WndA2_Proc3_sub_2F424,
  &sub_2CD24,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd20HW =
{
  0,
  &Q_Wnd20HW_Ctor_sub_2FC50,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd20HW_Dtor_sub_2FC68,
  3503,
  ""
};
T_Procs Wnd20HW_Procs =
{
  &Q_Wnd20HW_Dtor_sub_2FC68,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd20HW_Proc3_sub_2FD68,
  &Q_Wnd20HW_Proc4_sub_30774,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd11LW =
{
  0,
  &Q_Wnd11LW_Ctor_sub_31200,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd11LW_Dtor_sub_3121C,
  4064,
  ""
};
T_Procs Wnd11LW_Procs =
{
  &Q_Wnd11LW_Dtor_sub_3121C,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd11LW_Proc3_sub_31268,
  &Q_Wnd11LW_Proc4_sub_3160C,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd22AW =
{
  0,
  &Q_Wnd22AW_Ctor_sub_33830,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd22AW_Dtor_sub_33840,
  3503,
  ""
};
_UNKNOWN unk_95EC4; // weak
_UNKNOWN unk_95ED8; // weak
T_Procs Wnd22AW_Procs =
{
  &Q_Wnd22AW_Dtor_sub_33840,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd22AW_Proc3_sub_338DC,
  &Q_Wnd22AW_Proc4_sub_33A68,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
int (__fastcall *off_95F04)(P_WndA2 a1) = &sub_335B4; // weak
int (__fastcall *off_95F1C)(P_WndA2 a1) = &sub_32038; // weak
rt_type_sig_clss stru_95F44 =
{
  0,
  &Q_Wnd29GSW_Ctor_sub_395EC,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd29GSW_Dtor_sub_395FC,
  171,
  ""
};
rt_type_sig_clss C_Wnd7PW =
{
  0,
  &Q_Wnd7PW_Ctor_sub_372B0,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd7PW_Dtor_sub_372CC,
  396,
  ""
};
T_Procs Wnd29GSW_Procs =
{
  &Q_Wnd29GSW_Dtor_sub_395FC,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd29GSW_Proc3_sub_39644,
  &Q_Wnd29GSW_Proc4_sub_396F0,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs Wnd7PW_Procs =
{
  &Q_Wnd7PW_Dtor_sub_372CC,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd07PW_Proc3_sub_37568,
  &Q_Wnd07PW_Proc4_sub_384B0,
  &Q_Wnd_Proc5_sub_2CF28,
  &Q_Wnd07PW_Proc6_sub_395C4
};
rt_type_sig_clss C_Wnd14PSW =
{
  0,
  &Q_Wnd14PSW_Ctor_sub_39D80,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd14PSW_Dtor_sub_39D9C,
  173,
  ""
};
T_Procs Wnd14PSW_Procs =
{
  &Q_Wnd14PSW_Dtor_sub_39D9C,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd14PSW_Proc3_sub_39E3C,
  &Q_Wnd14PSW_Proc4_sub_3A6BC,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd9RW =
{
  0,
  &Q_Wnd9RWCtor_sub_48B40,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd9RWDtor_sub_46C48,
  2525,
  ""
};
T_Procs Wnd9RW_Procs =
{
  &Q_Wnd9RWDtor_sub_46C48,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &sub_47224,
  &sub_47ABC,
  &Q_Wnd_Proc5_sub_2CF28,
  &sub_48B14
};
rt_type_sig_clss C_HullCell =
{
  0,
  &_wcpp_2_undefed_cdtor_,
  &Q_HullCell_Copy_sub_4B5C0,
  &_wcpp_2_undefed_cdtor_,
  7,
  ""
};
rt_type_sig_clss C_Wnd8SW =
{
  0,
  &Q_Wnd8SWCtor_sub_4D92C,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd08SWDtor_sub_4DA08,
  567,
  ""
};
T_Procs Wnd08SW_Procs =
{
  &Q_Wnd08SWDtor_sub_4DA08,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd08SW_Proc3_sub_4DDB0,
  &Q_Wnd08SW_Proc4_sub_4E758,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd18NG =
{
  0,
  &Q_WndNGCtor_sub_520EC,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd18NG_Dtor_sub_52108,
  189,
  ""
};
rt_type_sig_clss C_Wnd17FW =
{
  0,
  &Q_Wnd17FW_Ctor_sub_51B64,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd17FW_Dtor_sub_51B80,
  177,
  ""
};
rt_type_sig_clss C_Wnd16SW =
{
  0,
  &Q_Wnd16SW_Ctor_sub_51674,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd16SW_Dtor_sub_51690,
  177,
  ""
};
T_Procs Wnd18NG_Procs =
{
  &Q_Wnd18NG_Dtor_sub_52108,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd18NG_Proc3_sub_5294C,
  &Q_Wnd18NG_Proc4_sub_521C0,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs Wnd17FW_Procs =
{
  &Q_Wnd17FW_Dtor_sub_51B80,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd17FW_Proc3_sub_51D24,
  &Q_Wnd17FW_Proc4_sub_51BC4,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs Wnd16SW_Procs =
{
  &Q_Wnd16SW_Dtor_sub_51690,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd16SW_Proc3_sub_51894,
  &Q_Wnd16SW_Proc4_sub_516E0,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd13DBGWND =
{
  0,
  &Q_Wnd13DBGWND_Ctor_sub_5A594,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd13DBGWND_Dtor_sub_5A5AC,
  192,
  ""
};
rt_type_sig_clss stru_96184 = { 0, &sub_5B2F0, &_wcpp_2_undefed_cdtor_, &sub_5B2B0, 171, "" };
rt_type_sig_clss stru_96198 = { 0, &sub_5B340, &_wcpp_2_undefed_cdtor_, &sub_5B300, 171, "" };
T_Procs Win13DBGWND_Procs =
{
  &Q_Wnd13DBGWND_Dtor_sub_5A5AC,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd13DBGWND_Proc3_sub_5A60C,
  &Q_Wnd13DBGWND_Proc4_sub_5AA08,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
T_Procs stru_961C4 =
{
  &sub_5B2B0,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_WndA2_Proc3_sub_2F424,
  &sub_1240C,
  &sub_2FC3C,
  &locret_2D460
};
T_Procs stru_961DC =
{
  &sub_5B300,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_WndA2_Proc3_sub_2F424,
  &sub_2FBA4,
  &sub_2FC3C,
  &locret_2D460
};
char aDataRacea03Haz[17] = "DATA\\RACEA03.HAZ"; // weak
T_Name20 V_OrdersTexts[10] =
{
  {
    'S',
    'O',
    'N',
    'o',
    't',
    'h',
    'i',
    'n',
    'g',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0'
  },
  "SOGoStar",
  "SOColonize",
  "SOOrbitPlanet",
  "SOPatrol",
  "SODefendPlanet",
  "SOAttack",
  "SOGoSpace",
  "BAD",
  "BAD"
};
int off_964E0 = 592479; // idb
RW_DTREG_BASE_STATIC stru_964E4 = { NULL, &unk_95A80, 0u };
__int16 word_964F0[5] = { 10, 25, 40, 55, 70 };
__int16 word_964FA[13] = { 30, 30, 30, 30, 20, 20, 20, 20, 20, 20, 15, 15, 15 };
WORD V_StarTypeWeights[13] = { 16, 4, 6, 4, 8, 13, 11, 8, 5, 6, 2, 9, 8 };
__int16 V_MaxLanesPerStarType[13] = { 6, 6, 6, 6, 4, 4, 4, 4, 4, 4, 3, 3, 3 };
int dword_96548[21] = { 4, 4, 3, 4, 3, 4, 3, 3, 4, 3, 3, 3, 4, 4, 4, 3, 4, 3, 2, 3, 3 }; // weak
int dword_9659C[21] = { 5, 1, 1, 6, 3, 2, 8, 6, 4, 4, 10, 2, 7, 8, 9, 7, 3, 5, 3, 7, 9 }; // weak
char byte_965F8[5] = { '\x05', '\x05', '\x05', '\x0E', '\x0E' }; // weak
int dword_965FD = -33549042; // weak
T_Name12 V_Atmospheres[3] =
{
  { 'P', 'e', 'a', 'c', 'e', 'f', 'u', 'l', '\0', '\0', '\0', '\0' },
  "Neutral",
  "Hostile"
};
T_Name10 V_Treaties[4] =
{
  { 'U', 'n', 'k', 'n', 'o', 'w', 'n', '\0', '\0', '\0' },
  "Peace",
  "War",
  "Alliance"
};
_DWORD dword_96654[5] = { 0, 0, 0, 0, 0 }; // weak
char aThank[] = "Thank you for playing Ascendancy."; // idb
RW_DTREG_BASE_STATIC stru_96768 = { NULL, &stru_95BDC, 0u };
int Q_GameLoop_dword_96774 = -1; // weak
char byte_96778 = '\xF3'; // weak
char byte_96779[7] = { '\x13', '\x17', '\x1B', '\x1F', '#', '\'', '+' }; // weak
RW_DTREG_BASE_STATIC stru_96780 = { NULL, &stru_95CDC, 0u };
char V_Romans100[10][5] =
{
  { '\0', '\0', '\0', '\0', '\0' },
  "C",
  "CC",
  "CCC",
  "CD",
  "D",
  "DC",
  "DCC",
  "DCCC",
  "CM"
};
char V_Romans10[10][5] =
{
  { '\0', '\0', '\0', '\0', '\0' },
  "X",
  "XX",
  "XXX",
  "XL",
  "L",
  "LX",
  "LXX",
  "LXXX",
  "XC"
};
char V_Romans1[10][5] =
{
  { '\0', '\0', '\0', '\0', '\0' },
  "I",
  "II",
  "III",
  "IV",
  "V",
  "VI",
  "VII",
  "VIII",
  "IX"
};
__int16 word_9682E[5] = { 207, 297, 252, 207, 297 }; // weak
__int16 word_96838[4] = { 358, 358, 403, 442 }; // weak
int dword_96840 = -65094; // weak
int V_PopGrowthAmount50 = 100; // weak
char *off_96850[5] = { "PLRES", "PLIND", "PLPRO", "PLPOP", "PLBUILD" }; // weak
_DWORD dword_96864[2] = { 50397184, 33686273 }; // weak
_UNKNOWN unk_9686C; // weak
_UNKNOWN unk_968A8; // weak
char V_PlayerRaceMask = '\x01'; // weak
char byte_968DD = '\xFF'; // weak
UWORD V_AbilityDays[21] =
{
  0u,
  0u,
  0u,
  0u,
  0u,
  60u,
  100u,
  62u,
  77u,
  90u,
  150u,
  140u,
  63u,
  66u,
  72u,
  0u,
  92u,
  100u,
  0u,
  89u,
  68u
};
_UNKNOWN unk_96912; // weak
char V_Items[5] = { '\f', '\r', '\x0E', '\x0F', '%' };
__int16 word_9691E[23] =
{
  2,
  0,
  1,
  3,
  6,
  5,
  8,
  9,
  25,
  28,
  47,
  18,
  21,
  19,
  10,
  14,
  22,
  26,
  31,
  52,
  40,
  38,
  30
};
_UNKNOWN unk_9696C; // weak
int V_SquareColors[3] = { 2, 3, 4 };
WORD V_HullCells[4] = { 5, 10, 15, 25 };
UBYTE byte_969A8[16] = { 0u, 0u, 1u, 2u, 3u, 4u, 5u, 5u, 4u, 3u, 2u, 1u, 2u, 3u, 0u, 0u };
UBYTE byte_969B8[16] = { 2u, 3u, 3u, 3u, 3u, 3u, 3u, 4u, 5u, 5u, 5u, 5u, 3u, 1u, 0u, 0u };
UBYTE byte_969C8[16] = { 3u, 7u, 7u, 7u, 7u, 7u, 7u, 15u, 31u, 31u, 31u, 31u, 7u, 1u, 0u, 0u };
_DWORD V_HullsBaseCost[4] = { 70, 170, 240, 410 }; // weak
T_Name15 V_Locations[7] =
{
  {
    'I',
    'n',
    'V',
    'o',
    'i',
    'd',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0'
  },
  "InShipyard",
  "InShipdock",
  "InOrbit",
  "InSystem",
  "InStarLane",
  "BOGUS"
};
T_Name15 V_Locations[7] =
{
  {
    'I',
    'n',
    'V',
    'o',
    'i',
    'd',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0'
  },
  "InShipyard",
  "InShipdock",
  "InOrbit",
  "InSystem",
  "InStarLane",
  "BOGUS"
};
RW_DTREG_BASE_STATIC stru_96AC0 = { NULL, &stru_9605C, 0u };
int dword_96ACC = -1; // weak
int V_SelectedHullCellIndex = -1; // weak
_UNKNOWN unk_96AD4; // weak
RW_DTREG_BASE_STATIC stru_96B08 = { NULL, &stru_96094, 0u };
int word_96B2A = -1; // idb
int word_96B2C = 65535; // idb
_UNKNOWN unk_96B30; // weak
__int16 word_96B6C = 6166; // weak
UWORD smshipShpCacheIndex = 65535u; // idb
UWORD sunsShpCacheIndex = 65535u; // idb
UWORD planetsShpCacheIndex = 65535u; // idb
_DWORD dword_96B74[5] = { 15, 25, 50, 75, 100 }; // weak
int V_GridSize = 5; // weak
RW_DTREG_BASE_STATIC stru_96B8C = { NULL, &stru_96150, 0u };
int dword_96BAC = -1; // weak
__int16 word_96BB0 = -1; // weak
int dword_96BB4 = -1; // weak
int dword_96BB8 = -1; // weak
int dword_96BBC = 1065353216; // weak
int dword_96BC0 = -1; // weak
__int16 word_96BC4[8] = { 243, 19, 27, 31, 23, 39, 35, 15 }; // weak
VFX_DESC *(__cdecl *VFX_describe_driver)() = NULL;
void (__cdecl *VFX_init_driver)() = NULL;
void (__cdecl *VFX_shutdown_driver)() = NULL;
void (__cdecl *VFX_area_wipe)(LONG x0, LONG y0, LONG x1, LONG y1, LONG color) = NULL;
void (__cdecl *VFX_wait_vblank_leading)() = NULL;
void (__cdecl *VFX_window_read)(WINDOW *destination, LONG x0, LONG y0, LONG x1, LONG y1) = NULL;
void (__cdecl *VFX_DAC_read)(LONG color_number, RGB *triplet) = NULL;
void (__cdecl *VFX_DAC_write)(LONG color_number, RGB *triplet) = NULL;
void (__cdecl *VFX_pane_refresh)(PANE *target, LONG x0, LONG y0, LONG x1, LONG y1) = NULL;
void (__cdecl *VFX_line_address)(LONG x, LONG y, UBYTE **addr, ULONG *nbytes) = NULL;
void (__fastcall *MEM_free)(void *ptr) = &free;
int dword_9A234 = 0; // weak
int dword_9A238 = 0; // weak
PANE pPane = { NULL, 0, 0, 0, 0 }; // idb
int V_CobFilesLoaded = 0; // weak
T_CobFiles V_CobFiles =
{
  {
    {
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0'
    },
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    {  }
  }
};
int dword_A0CF8; // weak
MACRO_VFX_BOOL V_CheatMode;
MACRO_VFX_BOOL V_SelfPlayMode;
T_StaticStrings V_StaticStrings_dword_A0D04;
T_Game V_Game;
__int16 word_D845C; // weak
char byte_D8460[100]; // weak
T_Name20 V_StarTypeTexts_D84C4[13];
_UNKNOWN unk_D85C8; // weak
__int16 word_D85CA[13]; // weak
PANE stru_D85E4; // idb
T_InputSystem V_InputSystem;
T_Keyboard V_Keyboard;
T_Mouse V_Mouse;
int dword_D8650; // weak
T_GSystem V_GSystem;
UBYTE V_BigBuffer[94816]; // weak
UWORD GwshareShpCacheIndexes[45];
char byte_FFF04[251]; // weak
int dword_100302; // weak
int dword_100308; // weak
WINDOW V_Window1; // idb
void *buf; // idb
int dword_100324; // weak
int dword_100328; // weak
void *dword_10032C; // idb
__int16 word_100330; // weak
__int16 word_100332; // weak
char byte_100334; // weak
char byte_100335; // weak
int dword_100338; // weak
int V_ScreenshotCounter; // weak
char byte_100340[16]; // weak
__int16 word_100350; // weak
_UNKNOWN unk_100744; // weak
_UNKNOWN unk_100EC4; // weak
char byte_101DC4[16]; // weak
_UNKNOWN unk_101DD4; // weak
_UNKNOWN unk_102554; // weak
_UNKNOWN unk_103454; // weak
__int16 word_103F94; // weak
T_PlanetItems V_PlanetItems;
T_PlanetCfg V_PlanetCfg;
char *V_ShipNameText;
char *dword_104680; // idb
int dword_104684; // weak
char *PlanetSizeTexts[5];
char *PlanetTypeTexts[11];
char *PlanetButtonTexts[8];
int dword_1046E8[100]; // weak
int dword_104878[100]; // weak
int dword_104A08[100]; // weak
int dword_104B98[]; // weak
int dword_104BC0[9]; // weak
__int16 word_104BE8; // weak
UBYTE V_PlayerRaceIndex;
int dword_104BEC[100]; // weak
int dword_104D7C[99]; // weak
int dword_104F09; // weak
int dword_104F6D; // weak
int dword_104FD1; // weak
int dword_105035; // weak
int V_AllTechsKnownCache; // weak
MACRO_VFX_BOOL V_AllTechsKnownResult;
T_Name20 V_SpecNames[21];
int V_Day1; // weak
int V_Day2; // weak
int V_Day3; // weak
int V_ResTreeTxtLoaded; // weak
T_Research V_Research;
__int16 word_106FB4[7]; // weak
int dword_106FC2; // weak
int dword_106FCC; // weak
int dword_106FD0; // weak
int dword_106FD4; // weak
int dword_106FD8; // weak
WORD *dword_106FDC;
UBYTE byte_106FE0[56];
__int16 word_107018; // weak
int dword_10701C; // weak
T_Gizmos V_Gizmos;
T_Name20 V_HullNames[4];
T_Ship V_Ship;
T_SSystem V_SSystem;
T_Text200 V_SpeciesDescriptions[21];
T_FPS V_FPS;
int dword_10AE6C; // weak
T_WinMgr WinMgr;
LONG V_DebugPickedColor;
int dword_132B14; // weak
int dword_132B18; // weak
int V_TutorialInfoIndex; // weak
char byte_132B20[20]; // weak
int dword_132B34; // weak
char byte_132B38[32]; // weak
int V_Timer_dword_132B58; // weak
int V_ShowMousePosition; // weak
int V_FadeEffect; // weak
int V_FadeIndex; // weak


//----- (00010000) --------------------------------------------------------
void __noreturn sub_10000()
{
  while ( 1 )
  {
    __debugbreak();
  }
}
// 10000: using guessed type void __noreturn sub_10000();

//----- (00010010) --------------------------------------------------------
void __fastcall Q_BATCON_CPP_sub_10010(PANE *pane, int a2, int a3, int a4)
{
  void *ShapeTable_sub_1B084; // eax
  void *v6; // ebp
  LONG v7; // edi
  int v8; // ecx
  UWORD v9; // dx
  void *v10; // esi
  int raceIndex; // eax
  PANE *v12; // esi
  void *v13; // ebp
  int v14; // esi
  int v15; // esi
  int v16; // edx
  int v17; // ebx
  int k; // kr1C_4
  __int16 v19; // si
  int i; // esi
  LONG v21; // [esp-4h] [ebp-90h]
  PANE v22; // [esp+0h] [ebp-8Ch] BYREF
  int v23[5]; // [esp+14h] [ebp-78h]
  int v24[2]; // [esp+28h] [ebp-64h]
  LONG v25[2]; // [esp+30h] [ebp-5Ch]
  int v26[2]; // [esp+38h] [ebp-54h]
  int hotX; // [esp+40h] [ebp-4Ch] BYREF
  int hotY; // [esp+44h] [ebp-48h] BYREF
  int v29; // [esp+48h] [ebp-44h]
  int v30; // [esp+4Ch] [ebp-40h]
  int v31; // [esp+50h] [ebp-3Ch]
  int Rank_sub_4A8CC; // [esp+54h] [ebp-38h]
  int v33; // [esp+58h] [ebp-34h]
  P_Ship pShip; // [esp+5Ch] [ebp-30h]
  LONG x1; // [esp+60h] [ebp-2Ch]
  int v36; // [esp+64h] [ebp-28h]
  int j; // [esp+68h] [ebp-24h]
  int v38; // [esp+6Ch] [ebp-20h]
  LONG shape_number; // [esp+70h] [ebp-1Ch]
  LONG v40; // [esp+74h] [ebp-18h]
  PANE *panea; // [esp+78h] [ebp-14h]
  unsigned int v42; // [esp+7Ch] [ebp-10h]

  panea = pane;
  v33 = 0;
  if ( a4 )
  {
    VFX_pane_wipe(pane, 0x96);
    v33 = 0x96;
  }
  if ( a3 < 0 )
  {
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1D]);// 29: data\planets.shp
    v6 = ShapeTable_sub_1B084;
    if ( !ShapeTable_sub_1B084 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x46);
    }
    v7 = 5 * *(unsigned __int16 *)(a2 + 0x16) + *(unsigned __int16 *)(a2 + 0x14);
    Q_Pane_CenterShape_sub_2BC40(panea, ShapeTable_sub_1B084, v7, &hotX, &hotY);
    v29 = a2;
    VFX_shape_draw(panea, v6, v7, hotX, hotY);
    v8 = *(unsigned __int8 *)(a2 + 0x57);
    v30 = 0xF3;
    if ( v8 != 0xFF )
    {
      Q_DrawRaceFlagTinted_sub_53E38(panea, 2, 4, v8);
      v30 = 4 * V_Game.races[*(unsigned __int8 *)(a2 + 0x57)].colorSet + 0x13;
    }
    WinMgr.SmallFont.pane = *panea;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x12, 7, (const char *)(v29 + 0x24), 0, v30, 0xFF, 0);
    return;
  }
  v9 = GwshareShpCacheIndexes[*(__int16 *)(a2 + 0x56) + 0xE];
  pShip = (P_Ship)a2;
  v10 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v9);
  if ( !v10 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x5C);
  }
  raceIndex = pShip->raceIndex;
  v31 = 0;
  if ( raceIndex == V_PlayerRaceIndex || Q_Ship_CheckScannedInSystemByRace_sub_4AAEC(pShip, V_PlayerRaceIndex) > 0 )
  {
    v31 = 0xFFFFFFFF;
  }
  Q_Pane_CenterShape_sub_2BC40(panea, v10, pShip->hullSize, &hotX, &hotY);
  if ( v31 != 0xFFFFFFFF )
  {
    goto LABEL_25;
  }
  if ( pShip->availablePower > 0 )
  {
    if ( 4 * pShip->hullIntegrity < pShip->fullHullIntegrity || pShip->hullIntegrity < 5 )
    {
      VFX_shape_lookaside((*V_GSystem.hazeTables)[8]);
      VFX_shape_translate_draw(panea, v10, pShip->hullSize, hotX, hotY);
      goto LABEL_26;
    }
    if ( !V_Game.races[pShip->raceIndex].species )
    {
      VFX_shape_lookaside((*V_GSystem.hazeTables)[3]);
      VFX_shape_translate_draw(panea, v10, pShip->hullSize, hotX, hotY);
      goto LABEL_26;
    }
    if ( V_Game.races[pShip->raceIndex].species != 0xD )
    {
      VFX_shape_lookaside((*V_GSystem.hazeTables)[6]);
      VFX_shape_translate_draw(panea, v10, pShip->hullSize, hotX, hotY);
      goto LABEL_26;
    }
LABEL_25:
    VFX_shape_draw(panea, v10, pShip->hullSize, hotX, hotY);
    goto LABEL_26;
  }
  VFX_shape_lookaside((*V_GSystem.hazeTables)[0x16]);
  VFX_shape_translate_draw(panea, v10, pShip->hullSize, hotX, hotY);
LABEL_26:
  v12 = panea;
  Q_DrawRaceFlagTinted_sub_53E38(panea, 2, 4, pShip->raceIndex);
  WinMgr.SmallFont.pane = *v12;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x12, 7, pShip->name, 0, 0xF, 0xFF, 0);
  v13 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x23]);// 35: data\shipicon.shp
  if ( !v13 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0xA4);
  }
  if ( v31 == 0xFFFFFFFF )
  {
    Rank_sub_4A8CC = Q_Ship_GetRank_sub_4A8CC(pShip);
    for ( i = 0; i < 0xA; ++i )
    {
      if ( i >= Rank_sub_4A8CC )
      {
        break;
      }
      Q_DrawRaceTintedShape_sub_53EB8(panea, v13, 0, 5 * i + 0x12, 0x11, pShip->raceIndex);
    }
    v23[0] = pShip->totalWeaponDamage;
    v23[1] = pShip->totalShieldStrength;
    v23[2] = pShip->totalDriveMaxDistance;
    v23[3] = pShip->totalScannerRangePerTurn;
    v40 = 0x1F;
    v23[4] = pShip->totalGeneratorPower;
    v36 = 0;
    v22 = *panea;
    for ( j = 0; j < 5; ++j )
    {
      v22.x1 = v22.x0 + 1;
      v14 = v23[j];
      if ( v14 > 0 )
      {
        v22.x1 += 8 * v14 / 4;
      }
      v15 = 0;
      shape_number = j + 1;
      do
      {
        VFX_shape_draw(&v22, v13, shape_number, 8 * v15++ + 2, 9 * j + 0x1F);
      }
      while ( v15 < 0xF );
    }
    v24[0] = pShip->hullIntegrity;
    v24[1] = pShip->availablePower;
    v26[0] = pShip->fullHullIntegrity;
    v38 = 0;
    v26[1] = Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(pShip);
    v25[0] = 2;
    v25[1] = 5;
    x1 = 0x82;
    for ( k = 0; k != 2; ++k )
    {
      v16 = v26[k];
      if ( v16 > 0 )
      {
        v17 = v24[k];
        if ( v17 >= 0 )
        {
          if ( v17 > v16 )
          {
            v24[k] = v26[k];
          }
          v42 = 4 * k;
          v19 = 0;
        }
        else
        {
          v24[k] = 0;
          v42 = 4 * k;
          v19 = 0;
        }
        while ( v19 < 9 )
        {
          v21 = 8 * v19++ + 9;
          VFX_shape_draw(panea, v13, v25[v42 / 4], 8 * k + 0x7C, v21);
        }
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(
          panea,
          8 * k + 0x7C,
          8,
          8 * k + 0x82,
          0x50 - 0x48 * v24[v42 / 4] / v26[v42 / 4],
          v33,
          0xFFFFFFFF);
      }
    }
  }
}

//----- (00010668) --------------------------------------------------------
void __fastcall Q_BATCON_CPP_sub_10668(PANE *pane, char *a2, int powerState, int a4)
{
  void *shapeTable; // edi
  char *v6; // esi
  UBYTE colorSet; // al
  int v8; // eax
  char *text; // eax
  char s[68]; // [esp+0h] [ebp-60h] BYREF
  LONG hotY; // [esp+50h] [ebp-10h] BYREF
  LONG hotX; // [esp+54h] [ebp-Ch] BYREF
  int ps; // [esp+58h] [ebp-8h]
  char *shapeNumber; // [esp+5Ch] [ebp-4h]

  shapeNumber = a2;
  ps = powerState;
  shapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);
  if ( !shapeTable )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0xEA);
  }
  v6 = shapeNumber;
  if ( a4 && !ps && (V_Gizmos[*shapeNumber].flags & 0x80) == 0 )
  {
    VFX_pane_wipe(pane, 0x96);
  }
  if ( *shapeNumber == (char)0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0xFB);
  }
  Q_Pane_CenterShape_sub_2BC40(pane, shapeTable, *shapeNumber, &hotX, &hotY);
  if ( ps == 2 || ps == 3 )
  {
    VFX_shape_lookaside((*V_GSystem.hazeTables)[7]);
    VFX_shape_translate_draw(pane, shapeTable, *v6, hotX, hotY);
  }
  else
  {
    VFX_shape_draw(pane, shapeTable, *v6, hotX, hotY);
  }
  if ( *(_DWORD *)(v6 + 3) )
  {
    if ( (V_Gizmos[*v6].flags & 0x20) != 0 )
    {
      Q_Pane_CopyOrDrawRectangle_sub_2BB74(
        pane,
        1,
        1,
        pane->x1 - pane->x0 - 1,
        pane->y1 - pane->y0 - 1,
        4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13,
        0);
    }
  }
  sprintf(s, "%s", V_Gizmos[*v6].name);
  colorSet = V_Game.races[V_PlayerRaceIndex].colorSet;
  WinMgr.SmallFont.pane = *pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 2, s, 0, 4 * colorSet + 0x13, 0xFF, 0);
  if ( ps == 2 )
  {
    v8 = 0;                                            // 0: "(depleted)"
  }
  else
  {
    if ( ps != 3 )
    {
      return;
    }
    v8 = 1;                                            // 1: "(insufficient power)"
  }
  text = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v8);
  WinMgr.SmallFont.pane = *pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 0xC, text, 0, 0xF, 0xFF, 0);
}

//----- (00010878) --------------------------------------------------------
int __fastcall sub_10878(PANE *pPane, int a2, int a3, int a4)
{
  void *ShapeTable_sub_1B084; // edi
  UBYTE colorSet; // al
  int result; // eax
  __int16 v8; // dx
  char *sub_1CEA8; // eax
  char s[80]; // [esp+0h] [ebp-68h] BYREF
  int hotX; // [esp+50h] [ebp-18h] BYREF
  int hotY; // [esp+54h] [ebp-14h] BYREF
  int v13; // [esp+58h] [ebp-10h]

  v13 = a3;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1E]);
  if ( !ShapeTable_sub_1B084 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x122);
  }
  if ( a4 && !v13 )
  {
    VFX_pane_wipe(pPane, 0x96);
  }
  Q_Pane_CenterShape_sub_2BC40(pPane, ShapeTable_sub_1B084, *(unsigned __int8 *)(a2 + 1), &hotX, &hotY);
  if ( v13 == 1 )
  {
    VFX_shape_lookaside((*V_GSystem.hazeTables)[7]);
    VFX_shape_translate_draw(pPane, ShapeTable_sub_1B084, *(unsigned __int8 *)(a2 + 1), hotX, hotY);
  }
  else
  {
    VFX_shape_draw(pPane, ShapeTable_sub_1B084, *(unsigned __int8 *)(a2 + 1), hotX, hotY);
  }
  sprintf(s, "%s", V_PlanetItems.item[*(unsigned __int8 *)(a2 + 1)].name);
  colorSet = V_Game.races[V_PlayerRaceIndex].colorSet;
  WinMgr.SmallFont.pane = *pPane;
  result = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 2, s, 0, 4 * colorSet + 0x13, 0xFF, 0);
  if ( v13 == 1 )
  {
    v8 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet;
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0); // 0: "(depleted)"
    WinMgr.SmallFont.pane = *pPane;
    return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 0xC, sub_1CEA8, 0, v8 + 0x13, 0xFF, 0);
  }
  return result;
}

//----- (00010A14) --------------------------------------------------------
int __fastcall Q_CompareListBoxItems_sub_10A14(P_ListBoxItem item1, P_ListBoxItem item2)
{
  int value; // ecx
  int v3; // esi
  int result; // eax

  value = item1->value;
  v3 = item2->value;
  result = -1u;
  if ( value > v3 )
  {
    return 1;
  }
  if ( value == v3 )
  {
    return 0;
  }
  return result;
}

//----- (00010A3C) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd19BC_Ctor_sub_10A3C(P_Wnd19BC pWnd19BC)
{
  Q_WndA2_Ctor_sub_2C830(&pWnd19BC->a2);
  pWnd19BC->Unknown_C8.x = 0.0;
  pWnd19BC->Unknown_C8.y = 0.0;
  pWnd19BC->Unknown_C8.z = 0.0;
  pWnd19BC->a2.pProcs = &Wnd19BC_Procs;
  Q_Wnd19BC_Init_sub_10AC4(pWnd19BC);
}

//----- (00010A80) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd19BC_Dtor_sub_10A80(P_Wnd19BC a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd19BC);
    operator delete[](v3);
  }
  else
  {
    a1->a2.pProcs = &Wnd19BC_Procs;
    Q_WndA2_Dtor_sub_2C848(&a1->a2, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00010AC4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd19BC_Init_sub_10AC4(P_Wnd19BC a1)
{
  a1->target.type = 0;
  a1->target.pObject.pPlanet = 0;
  a1->Unknown_B0 = 0;
  a1->Unknown_B1 = 0;
  a1->pWnd10LB = 0;
  a1->Unknown_B9 = 0;
  a1->Unknown_BF = 0;
}

//----- (00010B24) --------------------------------------------------------
int __fastcall Q_Wnd19BC_Proc3_sub_10B24(P_Wnd19BC pWnd, UWORD message, int param1, int param2)
{
  int result; // eax
  T_Wnd04BM *Wnd_sub_56DA8; // eax
  T_Wnd10LB *v9; // eax
  P_Star pCurStar; // ebx
  int v11; // eax
  __int16 i; // ax
  int v13; // edx
  int Unknown_BF; // edx
  int v15; // eax
  BYTE v16; // al
  BYTE type; // al
  int v18; // ecx
  BYTE targetType; // bh
  P_Ship v20; // edx
  T_Type22 *p_t22; // edi
  P_Star v22; // eax
  P_Ship pShip_1; // edx
  P_Ship pShip; // eax
  P_Procs pProcs; // ebx
  char v26; // al
  void *ItemData_sub_2ED14; // eax
  P_Wnd04BM pWnd04BM; // edx
  void *v29; // eax
  P_BatDisplayItem v30; // eax
  T_HullCell *v31; // eax
  T_HullCell *v32; // esi
  T_Gizmo *v33; // eax
  int v34; // edx
  int *p_invincible; // edx
  void *v36; // eax
  P_Wnd04BM v37; // edx
  LONG v38; // ebx
  LONG v39; // ebx
  BYTE targetType_; // cl
  T_Vector3D *p_Unknown_C8; // ecx
  LONG v42; // [esp-4h] [ebp-9Ch]
  char v43; // [esp+0h] [ebp-98h] BYREF
  T_HullCell *Unknown_B1; // [esp+1h] [ebp-97h]
  BYTE targetType__; // [esp+5h] [ebp-93h]
  P_TargetObject pTargetObject; // [esp+6h] [ebp-92h]
  T_Vector3D v47[2]; // [esp+Ah] [ebp-8Eh] BYREF
  int v48; // [esp+22h] [ebp-76h]
  char v49; // [esp+28h] [ebp-70h]
  int v50; // [esp+29h] [ebp-6Fh]
  char v51; // [esp+2Dh] [ebp-6Bh]
  int v52; // [esp+2Eh] [ebp-6Ah]
  int v53; // [esp+32h] [ebp-66h]
  int v54; // [esp+36h] [ebp-62h]
  int v55; // [esp+3Ah] [ebp-5Eh]
  int v56; // [esp+3Eh] [ebp-5Ah]
  int v57; // [esp+42h] [ebp-56h]
  int v58; // [esp+46h] [ebp-52h]
  int v59; // [esp+4Ah] [ebp-4Eh]
  char v60; // [esp+50h] [ebp-48h]
  T_HullCell *v61; // [esp+51h] [ebp-47h]
  T_Target v62; // [esp+55h] [ebp-43h]
  T_Vector3D v63[2]; // [esp+5Ah] [ebp-3Eh] BYREF
  int v64; // [esp+72h] [ebp-26h]
  T_Type23 *v65; // [esp+78h] [ebp-20h]
  T_Type23 *v66; // [esp+7Ch] [ebp-1Ch]
  T_Ship *v67; // [esp+80h] [ebp-18h]
  int param1a; // [esp+84h] [ebp-14h]
  char v69; // [esp+88h] [ebp-10h]

  param1a = param1;
  if ( message < 0x327u )
  {
    if ( message >= 0x322u )
    {
      if ( message > 0x322u )
      {
        if ( message < 0x325u )
        {
          if ( message != 0x324 )
          {
            return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
          }
          if ( pWnd->Unknown_B9 != 1 )
          {
            pWnd->Unknown_B9 = 1;
            sub_12140(pWnd);
            pWnd->a2.pProcs->proc4_draw(&pWnd->a2, 0);
          }
          return 0xFFFFFFFF;
        }
        else if ( message <= 0x325u )
        {
          if ( pWnd->Unknown_B9 != 4 )
          {
            pWnd->Unknown_B9 = 4;
            sub_12140(pWnd);
            pWnd->a2.pProcs->proc4_draw(&pWnd->a2, 0);
          }
          return 0xFFFFFFFF;
        }
        else
        {
          pWnd->Unknown_BF = 0;
          if ( !param1 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x2E1);
          }
          if ( !param2 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x2E2);
          }
          if ( pWnd->Unknown_D4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x2E4);
          }
          targetType_ = pWnd->target.type;
          if ( targetType_ == 3 )
          {
            memset(v47, 0, sizeof(v47));
            v43 = 2;
            pWnd->target.pObject.pShip->order = ASCEND_SO_0_NOTHING;
            p_Unknown_C8 = (T_Vector3D *)param2;
            if ( pWnd->Unknown_B0 )
            {
              v43 = 1;
              Unknown_B1 = (T_HullCell *)pWnd->Unknown_B1;
              targetType__ = 0;
              pTargetObject.pPlanet = (P_Planet)pWnd->target.pObject;
            }
            else
            {
              v43 = 0;
              v69 = param1a;
              switch ( (_BYTE)param1a )
              {
                case 5:
                  targetType__ = 3;
                  v47[0] = *(T_Vector3D *)param2;
                  pWnd->Unknown_C8 = *(T_Vector3D *)param2;
                  p_Unknown_C8 = &pWnd->Unknown_C8;
                  pWnd->target.pObject.pShip->order = ASCEND_SO_7_GOSPACE;
                  pWnd->target.pObject.pShip->_orderTargetObject.pPlanet = 0;
                  break;
                case 2:
                  pTargetObject.pPlanet = (P_Planet)param2;
                  targetType__ = 1;
                  pWnd->target.pObject.pShip->order = ASCEND_SO_3_ORBITPLANET;
                  pWnd->target.pObject.pShip->_orderTargetObject.pPlanet = (P_Planet)param2;
                  break;
                case 4:
                  targetType__ = 2;
                  pTargetObject.pStar = (P_Star)param2;
                  pWnd->target.pObject.pShip->order = ASCEND_SO_1_GOSTAR;
                  v22 = *(P_Star *)param2;
                  if ( *(P_Star *)param2 == V_Game.pCurStar )
                  {
                    v22 = *(P_Star *)(param2 + 4);
                  }
                  pWnd->target.pObject.pShip->_orderTargetObject.pStar = v22;
                  break;
              }
              pShip_1 = pWnd->target.pObject.pShip;
              pShip_1->Unknown_62 = v43;
              pShip_1->pCurHullCell = Unknown_B1;
              pShip_1->_target.type = targetType__;
              pShip_1->_target.pObject = pTargetObject;
              pShip_1->Unknown_6C = v47[0];
              pShip_1->Unknown_78 = v47[1];
              pShip_1->Unknown_84 = v48;
              sub_49B3C(pWnd->target.pObject.pShip, 0);
              pShip = pWnd->target.pObject.pShip;
              if ( (pShip->Unknown_84 & 8) == 0 )
              {
                pWnd->Unknown_BF = (int)pShip;
                pWnd->j1 = (int)p_Unknown_C8;
                pWnd->z = v69;
              }
            }
          }
          else if ( targetType_ == 2 )
          {
            if ( pWnd->Unknown_B0 != 2 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x33B);
            }
            if ( (_BYTE)param1a != 3 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x33C);
            }
          }
          pWnd->Unknown_B9 = 1;
          sub_12140(pWnd);
          pWnd->Unknown_B0 = 0;
          pProcs = pWnd->a2.pProcs;
          pWnd->Unknown_B1 = 0;
          pProcs->proc4_draw(&pWnd->a2, 0);
          sub_12674(pWnd->pWnd04BM);
          return 0;
        }
      }
      // 0x322
      v18 = 0;
      targetType = pWnd->target.type;
      pWnd->Unknown_BF = 0;
      if ( targetType == ASCEND_TARGET_TYPE_3_LANE && (_BYTE)param1a )
      {
        memset(v63, 0, 0xC);
        *(_DWORD *)(&v43 + 0xFFFFFFF6 + 0x70) = 0;
        *(_DWORD *)(&v43 + 0xFFFFFFF6 + 0x74) = 0;
        *(_DWORD *)(&v43 + 0xFFFFFFF6 + 0x78) = 0;
        v60 = 1;
        v61 = (T_HullCell *)pWnd->Unknown_B1;
        v62.type = 5;
        if ( (unsigned __int8)param1a < 3u )
        {
          if ( (_BYTE)param1a == 2 )
          {
            v62.type = 1;
            v62.pObject.pPlanet = (P_Planet)param2;
          }
        }
        else if ( (unsigned __int8)param1a <= 3u )
        {
          v62.pObject.pPlanet = (P_Planet)param2;
          v62.type = 0;
        }
        else if ( (_BYTE)param1a == 4 && pWnd->Unknown_B0 == 1 )
        {
          v62.pObject.pPlanet = (P_Planet)param2;
          v62.type = 2;
        }
        v20 = pWnd->target.pObject.pShip;
        v20->Unknown_62 = v60;
        v20->pCurHullCell = v61;
        v20->_target = v62;
        v20->Unknown_6C = v63[0];
        v20->Unknown_78 = v63[1];
        v20->Unknown_84 = v64;
        sub_49B3C(pWnd->target.pObject.pShip, 0);
        if ( (BYTE1(pWnd->target.pObject.pPlanet[1].position.z) & 1) == 0 )
        {
          return v18;
        }
      }
      else
      {
        if ( pWnd->target.type != 2 )
        {
          return v18;
        }
        if ( (_BYTE)param1a != 3 )
        {
          return v18;
        }
        v66 = (T_Type23 *)param2;
        p_t22 = &pWnd->target.pObject.pPlanet->t22;
        v65 = (T_Type23 *)pWnd->Unknown_B1;
        p_t22->pt23 = v65;
        p_t22 = (T_Type22 *)((char *)p_t22 + 4);
        p_t22->pt23 = v66;
        p_t22->pShip = v67;
        sub_3676C(pWnd->target.pObject.pPlanet, 0);
        if ( (pWnd->target.pObject.pPlanet->t22.Unknown_8 & 1) == 0 )
        {
          return v18;
        }
      }
      return 0xFFFFFFFF;
    }
    if ( message < 0xDu )
    {
      if ( message != 1 )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
      }
      Wnd_sub_56DA8 = (T_Wnd04BM *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "BatModeWnd", 0);
      pWnd->pWnd04BM = Wnd_sub_56DA8;
      if ( !Wnd_sub_56DA8 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x184);
      }
      v9 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "BatListWnd", 0);
      pWnd->pWnd10LB = v9;
      if ( !v9 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x187);
      }
      pWnd->pWnd10LB->Unknown_AB = 0;
      Q_Wnd10LB_InitScrollBar_sub_2E9CC(pWnd->pWnd10LB, 0);
      pWnd->pWnd10LB->Unknown_C5 = 0;
      Q_Wnd10LB_Clear_sub_2ED4C(pWnd->pWnd10LB);
      pWnd->a2.Unknown_39 = 0xFFFFFFFF;
      pCurStar = V_Game.pCurStar;
      pWnd->a2.Unknown_35 = 0xFFFFFFFF;
      pWnd->Unknown_BF = 0;
      v11 = sub_1D734(pCurStar, pWnd->Unknown_DA);
      pWnd->Unknown_D4 = 0;
      pWnd->Unknown_104 = 0;
      pWnd->Unknown_D6 = v11;
      if ( ((1 << V_PlayerRaceIndex) & (pCurStar->shipsRacesBits | pCurStar->planetsRacesBits)) != 0 )
      {
        pWnd->Unknown_B9 = 1;
      }
      else
      {
        pWnd->Unknown_B9 = 4;
      }
      pWnd->h = 0;
      for ( i = 0; ; ++i )
      {
        v13 = i;
        if ( i >= pWnd->Unknown_D6 )
        {
          break;
        }
        pWnd->Unknown_E8[v13] = 0xFFFFFFFF;
      }
      Q_WndA2_CallChildrenProc3_sub_2D258(&pWnd->a2, message, param1a, param2);
      sub_12140(pWnd);
      pWnd->a2.pProcs->proc4_draw((P_WndA2)pWnd, 0);
      return 0;
    }
    if ( message <= 0xDu )
    {
      pWnd->a2.pProcs->proc4_draw((P_WndA2)pWnd, 0);
      return 0;
    }
    if ( message != 0x320 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
    }
    pWnd->Unknown_B0 = 0;
    v16 = param1a;
    pWnd->Unknown_B1 = 0;
    pWnd->target.type = v16;
    type = pWnd->target.type;
    pWnd->target.pObject.pPlanet = (P_Planet)param2;
    if ( (unsigned __int8)type < 2u )
    {
      if ( !type )
      {
        pWnd->Unknown_B9 = 1;
        goto LABEL_55;
      }
    }
    else
    {
      if ( (unsigned __int8)type <= 2u )
      {
        pWnd->Unknown_B9 = 3;
        goto LABEL_55;
      }
      if ( type == 3 )
      {
        pWnd->Unknown_B9 = 2;
        goto LABEL_55;
      }
    }
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batcon.cpp", 0x263);
LABEL_55:
    sub_12140(pWnd);
    pWnd->a2.pProcs->proc4_draw(&pWnd->a2, 0);
    return 0xFFFFFFFF;
  }
  if ( message <= 0x327u )
  {
    if ( pWnd->pWnd04BM->Unknown_B7 != 4
      && ((1 << V_PlayerRaceIndex) & (V_Game.pCurStar->planetsRacesBits | V_Game.pCurStar->shipsRacesBits)) != 0
      && !pWnd->Unknown_104
      && !pWnd->Unknown_D4 )
    {
      sub_1229C(pWnd, 0xFFFFFFFF);
      return 0;
    }
    return 0;
  }
  if ( message < 0x32Bu )
  {
    if ( message < 0x329u )
    {
      if ( pWnd->pWnd04BM->Unknown_B7 != 4
        && ((1 << V_PlayerRaceIndex) & (V_Game.pCurStar->shipsRacesBits | V_Game.pCurStar->planetsRacesBits)) != 0
        && !pWnd->Unknown_104
        && !pWnd->Unknown_D4 )
      {
        pWnd->Unknown_D4 = 0xFFFF;
        pWnd->Unknown_104 = 0xFFFFFFFF;
        sub_1229C(pWnd, 0xFFFFFFFF);
        return 0;
      }
    }
    else
    {
      if ( message > 0x329u )
      {
        if ( pWnd->h )
        {
          pWnd->h = 0;
          sub_11BA4(pWnd);
        }
        return 0xFFFFFFFF;
      }
      if ( pWnd->pWnd04BM->Unknown_B7 != 4 )
      {
        Unknown_BF = pWnd->Unknown_BF;
        if ( Unknown_BF )
        {
          if ( *(_BYTE *)(Unknown_BF + 0x58) == 4 && V_Game.pCurStar == *(P_Star *)(pWnd->Unknown_BF + 0x59) )
          {
            pWnd->target.type = 3;
            pWnd->Unknown_B0 = 0;
            v15 = pWnd->Unknown_BF;
            pWnd->Unknown_B1 = 0;
            pWnd->target.pObject.pPlanet = (P_Planet)v15;
            pWnd->a2.pProcs->proc3_msg(&pWnd->a2, 0x326u, pWnd->z, pWnd->j1);
            return 0;
          }
        }
      }
    }
    return 0;
  }
  if ( message <= 0x32Bu )
  {
    if ( pWnd->h != 1 )
    {
      pWnd->h = 1;
      sub_11BA4(pWnd);
    }
    return 0xFFFFFFFF;
  }
  if ( message < 0x32Du )
  {
    if ( pWnd->h != 4 )
    {
      pWnd->h = 4;
      sub_11BA4(pWnd);
    }
    return 0xFFFFFFFF;
  }
  if ( message <= 0x32Du )
  {
    if ( pWnd->h != 5 )
    {
      pWnd->h = 5;
      sub_11BA4(pWnd);
    }
    return 0xFFFFFFFF;
  }
  if ( message < 0x1C01u )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
  }
  if ( message <= 0x1C01u )
  {
    if ( pWnd->pWnd04BM->Unknown_B7 != 4 )
    {
      v26 = pWnd->Unknown_B9 - 1;
      pWnd->Unknown_BF = 0;
      switch ( v26 )
      {
        case 0:
        case 3:
          if ( param2 == 4 )
          {
            if ( Q_Wnd10LB_GetItemValue_sub_2ECA4(pWnd->pWnd10LB, param1a) >= 0 )
            {
              pWnd->target.type = 3;
              pWnd->Unknown_B9 = 2;
            }
            else
            {
              pWnd->target.type = 2;
              pWnd->Unknown_B9 = 3;
            }
            sub_12140(pWnd);
            ItemData_sub_2ED14 = Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
            v42 = 0;
            pWnd04BM = pWnd->pWnd04BM;
            pWnd->target.pObject.pPlanet = (P_Planet)ItemData_sub_2ED14;
            Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd04BM->a2.index, 0x53, 0, v42);
            ((void (*)(void))pWnd->a2.pProcs->proc4_draw)();
            result = 0xFFFFFFFF;
          }
          else
          {
            v29 = Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
            v30 = sub_12AE4(pWnd->pWnd04BM, (P_TargetObject)v29);
            if ( !v30 )
            {
              return 0xFFFFFFFF;
            }
            Q_Wnd04BM_SetTargetPosition_sub_17E88(pWnd->pWnd04BM, &v30->target);
            sub_18C2C(pWnd->pWnd04BM, 0);
            result = 0xFFFFFFFF;
          }
          break;
        case 1:
          if ( Q_Wnd10LB_GetItemValue_sub_2ECA4(pWnd->pWnd10LB, param1a) )
          {
            return 0xFFFFFFFF;
          }
          v31 = (T_HullCell *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
          v32 = v31;
          if ( v31->gizmoIndex == (BYTE)0xFF )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x39C);
          }
          v33 = &V_Gizmos[v31->gizmoIndex];
          if ( (v33->flags & 0x80) != 0 )
          {
            return 0xFFFFFFFF;
          }
          v34 = v33->flags & 0x20;
          if ( (_BYTE)v34 )
          {
            Q_Ship_ToggleGizmo_sub_49A8C(pWnd->target.pObject.pShip, v32);
          }
          else
          {
            pWnd->Unknown_B0 = 1;
            pWnd->Unknown_B1 = (int)v32;
            if ( (v33->flags & 0x40) != 0 )
            {
              v53 = v34;
              v54 = v34;
              v55 = v34;
              v56 = v34;
              v57 = v34;
              v58 = v34;
              v49 = 1;
              v50 = pWnd->Unknown_B1;
              v51 = 5;
              p_invincible = &pWnd->target.pObject.pPlanet->invincible;
              *(_BYTE *)p_invincible = 1;
              *(int *)((char *)p_invincible + 1) = v50;
              *((_BYTE *)p_invincible + 5) = v51;
              *(int *)((char *)p_invincible + 6) = v52;
              *(int *)((char *)p_invincible + 0xA) = v53;
              *(int *)((char *)p_invincible + 0xE) = v54;
              *(int *)((char *)p_invincible + 0x12) = v55;
              *(int *)((char *)p_invincible + 0x16) = v56;
              *(int *)((char *)p_invincible + 0x1A) = v57;
              *(int *)((char *)p_invincible + 0x1E) = v58;
              *(int *)((char *)p_invincible + 0x22) = v59;
              pWnd->Unknown_B0 = 0;
              pWnd->Unknown_B1 = 0;
              pWnd->Unknown_B9 = 1;
              sub_12140(pWnd);
              sub_12674(pWnd->pWnd04BM);
            }
            else
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd->pWnd04BM->a2.index, 0x51, 0, v34);
            }
          }
          ((void (*)(void))pWnd->a2.pProcs->proc4_draw)();
          return 0xFFFFFFFF;
        case 2:
          if ( Q_Wnd10LB_GetItemValue_sub_2ECA4(pWnd->pWnd10LB, param1a) )
          {
            return 0xFFFFFFFF;
          }
          v36 = Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
          v42 = 0;
          pWnd->Unknown_B0 = 2;
          v37 = pWnd->pWnd04BM;
          pWnd->Unknown_B1 = (int)v36;
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v37->a2.index, 0x51, 0, v42);
          return 0xFFFFFFFF;
        default:
          return 0xFFFFFFFF;
      }
      return result;
    }
    return 0;
  }
  if ( message != 0x1C02 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
  }
  switch ( pWnd->Unknown_B9 )
  {
    case 2:
      v38 = *(char *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, v38, 4);
      result = 0xFFFFFFFF;
      break;
    case 3:
      v39 = *((unsigned __int8 *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a) + 1);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, v39, 5);
      goto LABEL_122;
    default:
LABEL_122:
      result = 0xFFFFFFFF;
      break;
  }
  return result;
}

//----- (00011870) --------------------------------------------------------
void __fastcall Q_Wnd19BC_Proc4_sub_11870(P_Wnd19BC pWnd, int a2)
{
  LONG v3; // esi
  BYTE Unknown_B9; // ah
  int pPlanet; // edx
  int v6; // ebx
  void *ShapeTable_sub_1B084; // eax
  BYTE v8; // bl
  void *v9; // eax
  UBYTE planetsRacesBits; // cl
  WORD v11; // ax
  int type; // [esp-20h] [ebp-A0h]
  char s[40]; // [esp+0h] [ebp-80h] BYREF
  PANE v14; // [esp+28h] [ebp-58h] BYREF
  PANE pPane; // [esp+3Ch] [ebp-44h] BYREF
  PANE pane; // [esp+50h] [ebp-30h] BYREF
  WORD v17; // [esp+64h] [ebp-1Ch]
  WORD v18; // [esp+68h] [ebp-18h]

  if ( a2 != 0x1C01 )
  {
    sub_11BA4(pWnd);
  }
  pane.window = pWnd->a2.pane.window;
  pane.x0 = 0x1D2;
  pane.y0 = 0;
  pane.x1 = 0x27F;
  pane.y1 = 0x8D;
  VFX_pane_wipe(&pane, 0);
  v3 = 0xA;
  Unknown_B9 = pWnd->Unknown_B9;
  if ( Unknown_B9 == 2 || Unknown_B9 == 3 )
  {
    v14 = pWnd->pWnd10LB->a2.pane;
    v14.y0 = 7;
    v14.y1 = pWnd->pWnd10LB->_defaultItemHeight + 8;
    if ( pWnd->Unknown_B9 == 2 )
    {
      pPlanet = (int)pWnd->target.pObject.pPlanet;
      v6 = 0;
      v3 = 0xB;
    }
    else
    {
      v6 = 0xFFFFFFFF;
      pPlanet = (int)pWnd->target.pObject.pPlanet;
      v3 = 0x13;
    }
    Q_BATCON_CPP_sub_10010(&v14, pPlanet, v6, 0);
  }
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.shapeCacheIndex);
  VFX_shape_draw(&pane, ShapeTable_sub_1B084, v3, 0, 0);
  sub_2D218(&pWnd->a2);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
  v8 = pWnd->Unknown_B9;
  if ( v8 == 1 || v8 == 4 )
  {
    pPane.window = pWnd->a2.pane.window;
    pPane.x0 = 474;
    pPane.y0 = 7;
    pPane.x1 = 632;
    pPane.y1 = 37;
    type = V_Game.pCurStar->type;
    v9 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->pWnd04BM->Unknown_19C6[1]);
    VFX_shape_transform(&pPane, v9, type, 0xF, 0xF, V_BigBuffer, 0, 0x3333, 0x3333, 0);
    v18 = 243;
    v17 = 0xFFFF;
    v11 = 0;
    if ( V_Game.racesNum > 0 )
    {
      while ( 1 )
      {
        if ( V_Game.races[v11].extinct != TRUE )
        {
          planetsRacesBits = V_Game.pCurStar->planetsRacesBits;
          if ( planetsRacesBits )
          {
            if ( ((1 << v11) | planetsRacesBits) == 1 << v11
              || V_Game.pCurStar == V_Game.races[v11].homeStar && ((1 << v11) & planetsRacesBits) != 0 )
            {
              break;
            }
          }
        }
        if ( ++v11 >= V_Game.racesNum )
        {
          goto LABEL_20;
        }
      }
      v17 = v11;
    }
LABEL_20:
    if ( v17 != 0xFFFFFFFF )
    {
      v18 = 4 * V_Game.races[v11].colorSet + 0x13;
      Q_DrawRaceFlagTinted_sub_53E38(&pPane, 0x8D, 3, v11);
    }
    sprintf(s, "%s", V_Game.pCurStar->name);
    WinMgr.LargeFont.pane = pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x28, 5, s, 0, v18, 0xFF, 0x6C);
    sprintf(s, "%s", V_StarTypeTexts_D84C4[V_Game.pCurStar->type]);
    WinMgr.SmallFont.pane = pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x28, 0x12, s, 0, 0xF3, 0xFF, 0x6C);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
  }
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00011BA4) --------------------------------------------------------
int __fastcall sub_11BA4(P_Wnd19BC pWnd19BC)
{
  int ShipsAtLocation_sub_1D794; // ebp
  P_Ship v3; // edi
  unsigned __int16 v4; // ax
  WORD j; // di
  BYTE *v6; // edx
  unsigned __int16 v7; // ax
  T_HullCell *hullCells; // kr04_4
  int v10; // kr08_4
  int v11; // ebx
  BYTE cat; // ah
  int gizmoIndex; // ebp
  BYTE v14; // al
  T_Gizmo *v15; // ebp
  unsigned __int16 v16; // dx
  T_Planet *pPlanet; // edi
  int v18; // edx
  int v19; // ebp
  int v20; // ebp
  int v21; // edx
  unsigned __int16 v22; // ax
  WORD n; // di
  BYTE *v24; // edx
  unsigned __int16 v25; // ax
  __int16 m; // di
  P_Ship ships[107]; // [esp+0h] [ebp-39Ch] BYREF
  int v28[107]; // [esp+1ACh] [ebp-1F0h] BYREF
  int raceIndex; // [esp+358h] [ebp-44h]
  int availablePower; // [esp+35Ch] [ebp-40h]
  int a3; // [esp+360h] [ebp-3Ch] BYREF
  int a4; // [esp+364h] [ebp-38h] BYREF
  LONG v33; // [esp+368h] [ebp-34h] BYREF
  P_Ship result_4; // [esp+36Ch] [ebp-30h]
  unsigned int v35; // [esp+370h] [ebp-2Ch]
  int v36; // [esp+374h] [ebp-28h]
  int v37; // [esp+378h] [ebp-24h]
  __int16 i; // [esp+37Ch] [ebp-20h]
  __int16 k; // [esp+380h] [ebp-1Ch]

  Q_Wnd10LB_Clear_sub_2ED4C(pWnd19BC->pWnd10LB);
  switch ( pWnd19BC->Unknown_B9 )
  {
    case 1:
      pWnd19BC->pWnd10LB->_defaultItemHeight = 0x54;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pWnd19BC->pWnd10LB, (P_DrawItemFunc)Q_BATCON_CPP_sub_10010);
      ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)V_Game.pCurStar, ships);
      for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
      {
        v3 = ships[i];
        if ( v3->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
        {
          if ( v3->raceIndex >= 7 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x4AC);
          }
          if ( v3->raceIndex == V_PlayerRaceIndex )
          {
            v4 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, (BYTE *)ships[i], 0xFFFF, 0);
            Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v4, i);
          }
        }
      }
      for ( j = 0; j < V_Game.pCurStar->planetsNum; ++j )
      {
        v6 = (BYTE *)V_Game.pCurStar->planets[j];
        if ( v6[0x57] == V_PlayerRaceIndex )
        {
          v7 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, v6, 0xFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v7, j | 0x80000000);
        }
      }
      goto LABEL_15;
    case 2:
      if ( pWnd19BC->target.type != ASCEND_TARGET_TYPE_3_LANE )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x4D8);
      }
      if ( !pWnd19BC->target.pObject.pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x4D9);
      }
      pWnd19BC->pWnd10LB->_defaultItemHeight = 0x54;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pWnd19BC->pWnd10LB, (P_DrawItemFunc)Q_BATCON_CPP_sub_10668);
      result_4 = pWnd19BC->target.pObject.pShip;
      availablePower = result_4->availablePower;
      if ( result_4->raceIndex == V_PlayerRaceIndex || Q_Ship_CheckScannedInSystemByRace_sub_4AAEC(result_4, V_PlayerRaceIndex) == 2 )
      {
        hullCells = result_4->hullCells;
        v10 = 0;
        LOWORD(v37) = 0;
        while ( (__int16)v37 < result_4->hullCellsNum )
        {
          if ( hullCells[v10].gizmoIndex != (BYTE)0xFF )
          {
            if ( (gizmoIndex = hullCells[v10].gizmoIndex, v14 = V_Gizmos[gizmoIndex].cat, v15 = &V_Gizmos[gizmoIndex], v14 == pWnd19BC->h)
              && (v15->flags & 0x80) == 0
              || pWnd19BC->h == 4 && (v15->flags & 0x80) != 0 )
            {
              v16 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, &hullCells[v10].gizmoIndex, 0xFFFF, 0);
              raceIndex = result_4->raceIndex;
              v11 = 0;
              if ( V_PlayerRaceIndex == raceIndex )
              {
                if ( (v15->flags & 0x20) == 0 )
                {
                  if ( !v15->numUses || hullCells[v10]._usesPerTurnLeft )
                  {
                    if ( availablePower < v15->power )
                    {
                      v11 = 3;
                    }
                  }
                  else
                  {
                    v11 = 2;
                  }
                }
              }
              else
              {
                v11 = 1;
              }
              if ( (v15->flags & 0x80) != 0 )
              {
                v11 = hullCells[v10].gizmoIndex + 0x1F4;
              }
              cat = v15->cat;
              if ( cat == 2 )
              {
                v11 = hullCells[v10].gizmoIndex + 0x258;
              }
              else if ( cat == 4 )
              {
                v11 = hullCells[v10].gizmoIndex + 0x2BC;
              }
              Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v16, v11);
            }
          }
          LOWORD(v37) = v37 + 1;
          ++v10;
        }
      }
      goto LABEL_15;
    case 3:
      pWnd19BC->pWnd10LB->_defaultItemHeight = 0x54;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pWnd19BC->pWnd10LB, (P_DrawItemFunc)sub_10878);
      pPlanet = pWnd19BC->target.pObject.pPlanet;
      if ( pWnd19BC->target.type != ASCEND_TARGET_TYPE_2_SHIP )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x51F);
      }
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x520);
      }
      if ( V_PlayerRaceIndex == pPlanet->raceIndex )
      {
        for ( k = 0; k < (int)pPlanet->totalSquaresNum; ++k )
        {
          v18 = (int)&pPlanet->pSquares[k];
          v35 = 4 * k;
          v19 = 0;
          if ( (*(_WORD *)(v18 + 2) & 1) != 0 && (V_PlanetItems.item[*(unsigned __int8 *)(v18 + 1)].flags & 4) != 0 )
          {
            v36 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, (BYTE *)v18, 0xFFFF, 0);
            Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, pPlanet->pSquares[v35 / 4].planetItemIndex, &a3, &a4, &v33);
            if ( v33 && !((int)pPlanet->pSquares[v35 / 4].flags >> 8) )
            {
              v19 = 1;
            }
            Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v36, v19);
          }
        }
      }
      goto LABEL_15;
    case 4:
      pWnd19BC->pWnd10LB->_defaultItemHeight = 0x54;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pWnd19BC->pWnd10LB, (P_DrawItemFunc)Q_BATCON_CPP_sub_10010);
      v20 = Q_FindShipsAtLocation_sub_1D794((P_Location)V_Game.pCurStar, (P_Ship *)v28);
      for ( m = 0; m < v20; ++m )
      {
        v21 = v28[m];
        if ( *(_BYTE *)(v21 + 0x58) == 4 && *(_WORD *)(v21 + 0x56) != V_PlayerRaceIndex )
        {
          v22 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, (BYTE *)v21, 0xFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v22, m);
        }
      }
      for ( n = 0; n < V_Game.pCurStar->planetsNum; ++n )
      {
        v24 = (BYTE *)V_Game.pCurStar->planets[n];
        if ( V_PlayerRaceIndex != v24[0x57] )
        {
          v25 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, v24, 0xFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v25, n | 0x80000000);
        }
      }
LABEL_15:
      Q_Wnd10LB_SetCompareProc_sub_2F1D8(pWnd19BC->pWnd10LB, Q_CompareListBoxItems_sub_10A14);
      Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(pWnd19BC->pWnd10LB);
      break;
    default:
      return ((int (*)(void))pWnd19BC->pWnd10LB->a2.pProcs->proc4_draw)();
  }
  return ((int (*)(void))pWnd19BC->pWnd10LB->a2.pProcs->proc4_draw)();
}
// 11BA4: using guessed type int var_1F0[107];

//----- (00012140) --------------------------------------------------------
int __fastcall sub_12140(P_Wnd19BC pWnd19BC)
{
  WORD i; // si
  unsigned int v3; // edx
  BYTE Unknown_B9; // ah
  __int16 j; // bx
  int v6; // eax
  int result; // eax
  int v8; // eax
  unsigned int v9; // [esp+4h] [ebp-1Ch]

  for ( i = 0; i < pWnd19BC->a2.childrenNum; ++i )
  {
    if ( !strcmp((*pWnd19BC->a2.children)[i]->name, "My^Items") )
    {
      break;
    }
  }
  if ( i >= pWnd19BC->a2.childrenNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x58C);
  }
  v3 = 0xFFFFFFFF;
  Unknown_B9 = pWnd19BC->Unknown_B9;
  v9 = 0;
  if ( Unknown_B9 == 2 )
  {
    v3 = 0;
  }
  else if ( Unknown_B9 == 3 )
  {
    v9 = 0xFFFFFFFF;
  }
  for ( j = 0; ; ++j )
  {
    result = j;
    if ( j >= 9 )
    {
      break;
    }
    if ( v9 )
    {
      v6 = i + j;
      (*pWnd19BC->a2.children)[v6]->Unknown_35 = 0;
      (*pWnd19BC->a2.children)[v6]->Unknown_39 = 0;
    }
    else
    {
      v8 = i + j;
      if ( j >= 5 )
      {
        (*pWnd19BC->a2.children)[v8]->Unknown_35 = ~v3;
        (*pWnd19BC->a2.children)[v8]->Unknown_39 = ~v3;
      }
      else
      {
        (*pWnd19BC->a2.children)[v8]->Unknown_35 = v3;
        (*pWnd19BC->a2.children)[v8]->Unknown_39 = v3;
      }
    }
  }
  return result;
}

//----- (00012238) --------------------------------------------------------
void __fastcall sub_12238(P_Wnd19BC pWnd19BC, int a2)
{
  if ( pWnd19BC->target.type == ASCEND_TARGET_TYPE_3_LANE )
  {
    sub_49B3C(pWnd19BC->target.pObject.pShip, 1);
  }
  else if ( pWnd19BC->target.type == ASCEND_TARGET_TYPE_2_SHIP )
  {
    sub_3676C(pWnd19BC->target.pObject.pPlanet, 1);
  }
  pWnd19BC->target.type = 0;
  pWnd19BC->target.pObject.pPlanet = 0;
  if ( a2 == 0xFFFFFFFF )
  {
    sub_11BA4(pWnd19BC);
  }
  sub_1229C(pWnd19BC, a2);
}

//----- (0001229C) --------------------------------------------------------
void __fastcall sub_1229C(P_Wnd19BC pWnd19BC, int a2)
{
  T_Star *pCurStar; // esi
  T_Target target; // [esp+0h] [ebp-8h] BYREF

  pCurStar = V_Game.pCurStar;
  while ( ++pWnd19BC->Unknown_D4 < pWnd19BC->Unknown_D6 || sub_12368(pWnd19BC, a2) )
  {
    target.type = 0;
    pWnd19BC->Unknown_E8[pWnd19BC->Unknown_D4] = sub_406C4(&V_Game.races[pWnd19BC->Unknown_DA[pWnd19BC->Unknown_D4]], pCurStar, &target);
    if ( target.type )
    {
      pWnd19BC->target = target;
      if ( target.type == 3 )
      {
        sub_49B3C((P_Ship)target.pObject.pPlanet, 0);
      }
      else
      {
        sub_3676C(target.pObject.pPlanet, 0);
      }
      if ( a2 == 0xFFFFFFFF )
      {
        sub_12674(pWnd19BC->pWnd04BM);
      }
      else
      {
        sub_12238(pWnd19BC, a2);
      }
      return;
    }
  }
}
// 1229C: using guessed type T_Target anonymous_0;

//----- (00012368) --------------------------------------------------------
int __fastcall sub_12368(P_Wnd19BC pWnd19BC, int a2)
{
  P_Star pCurStar; // esi
  int v4; // edi
  __int16 i; // ax
  T_Star *v6; // eax
  int v7; // eax
  T_Race *v8; // eax
  __int16 j; // cx

  pCurStar = V_Game.pCurStar;
  v4 = 0;
  if ( pWnd19BC->Unknown_104 == 0xFFFFFFFF )
  {
    for ( i = 0; i < pWnd19BC->Unknown_D6; ++i )
    {
      if ( pWnd19BC->Unknown_E8[i] == 0xFFFFFFFF )
      {
        v4 = 0xFFFFFFFF;
        break;
      }
    }
  }
  v6 = V_Game.pCurStar;
  pWnd19BC->Unknown_104 = v4;
  v7 = sub_1D734(v6, pWnd19BC->Unknown_DA);
  pWnd19BC->Unknown_D4 = 0;
  pWnd19BC->Unknown_D6 = v7;
  for ( j = 0; j < pWnd19BC->Unknown_D6; ++j )
  {
    v8 = &V_Game.races[pWnd19BC->Unknown_DA[j]];
    sub_3B56C(v8, (P_Location)pCurStar);
  }
  if ( a2 == 0xFFFFFFFF )
  {
    pWnd19BC->a2.pProcs->proc4_draw((P_WndA2)pWnd19BC, 0);
  }
  return v4;
}

//----- (0001240C) --------------------------------------------------------
void __fastcall sub_1240C(int a1, int a2)
{
  sub_2FBA4(a1, a2);
  Q_DrawRaceFlagTinted_sub_53E38((PANE *)(a1 + 4), 3, 3, V_PlayerRaceIndex);
}

//----- (00012440) --------------------------------------------------------
char *__fastcall sub_12440(char *result)
{
  *(_DWORD *)(result + 0xA) = 0;
  *(_DWORD *)(result + 0xE) = 0;
  *(_DWORD *)(result + 0x12) = 0;
  *(_DWORD *)(result + 0x1A) = 0;
  *(_DWORD *)(result + 0x1E) = 0;
  *(_DWORD *)(result + 0x16) = 0;
  return result;
}

//----- (00012480) --------------------------------------------------------
int __fastcall sub_12480(float *a1, float *a2, float a3)
{
  double v6; // st7
  double v7; // st7
  float v9; // [esp+8h] [ebp-80h] BYREF
  float v10; // [esp+Ch] [ebp-7Ch]
  float v11; // [esp+10h] [ebp-78h]
  float v12; // [esp+14h] [ebp-74h] BYREF
  float v13; // [esp+18h] [ebp-70h]
  float v14; // [esp+1Ch] [ebp-6Ch]
  int v15[3]; // [esp+20h] [ebp-68h] BYREF
  float v16; // [esp+2Ch] [ebp-5Ch]
  int v17; // [esp+30h] [ebp-58h]
  int v18; // [esp+34h] [ebp-54h]
  float v19; // [esp+38h] [ebp-50h]
  float v20; // [esp+3Ch] [ebp-4Ch]
  float v21; // [esp+40h] [ebp-48h]
  int v22[3]; // [esp+44h] [ebp-44h] BYREF
  float v23; // [esp+50h] [ebp-38h]
  float v24; // [esp+54h] [ebp-34h]
  float v25; // [esp+58h] [ebp-30h]
  float v26; // [esp+5Ch] [ebp-2Ch]
  int v27; // [esp+60h] [ebp-28h]
  int v28; // [esp+64h] [ebp-24h]
  int *v29; // [esp+68h] [ebp-20h]
  float *v30; // [esp+6Ch] [ebp-1Ch]
  int *v31; // [esp+70h] [ebp-18h]
  float *v32; // [esp+74h] [ebp-14h]
  float v33; // [esp+7Ch] [ebp-Ch]

  v30 = &v12;
  v23 = 0.0;
  v24 = 0.0;
  v25 = 0.0;
  v23 = *a2 - *a1;
  v24 = a2[1] - a1[1];
  v25 = a2[2] - a1[2];
  v12 = v23;
  v13 = v24;
  v14 = v25;
  v33 = sqrt(v24 * v24 + v23 * v23 + v25 * v25);
  if ( a3 >= (double)v33 )
  {
    *a1 = *a2;
    a1[1] = a2[1];
    a1[2] = a2[2];
    return 0xFFFFFFFF;
  }
  else
  {
    v26 = v12 * a3;
    *(float *)&v27 = v13 * a3;
    *(float *)&v28 = a3 * v14;
    v6 = 1.0 / v33;
    v29 = v22;
    *(float *)v22 = v26;
    v22[1] = v27;
    v22[2] = v28;
    v16 = v26 * v6;
    v31 = v15;
    *(float *)&v17 = *(float *)&v27 * v6;
    *(float *)v15 = v16;
    v19 = 0.0;
    v15[1] = v17;
    *(float *)&v18 = v6 * *(float *)&v28;
    v20 = 0.0;
    v15[2] = v18;
    v21 = 0.0;
    v32 = &v9;
    v19 = *a1 + v16;
    v20 = a1[1] + *(float *)&v17;
    v7 = a1[2];
    v9 = v19;
    v21 = v7 + *(float *)&v18;
    v10 = v20;
    v11 = v21;
    *a1 = v19;
    a1[1] = v10;
    a1[2] = v11;
    return 0;
  }
}

//----- (00012618) --------------------------------------------------------
unsigned int __fastcall sub_12618(T_BatDisplayItem *a1)
{
  int shapeNumber; // esi
  void *ShapeTable_sub_1B084; // eax
  unsigned int v4; // ebp
  unsigned __int16 shapeCacheIndex; // [esp+0h] [ebp-1Ch]

  shapeCacheIndex = a1->shapeCacheIndex;
  shapeNumber = a1->shapeNumber;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, shapeCacheIndex);
  v4 = 0;
  if ( shapeNumber + 1 >= VFX_shape_count(ShapeTable_sub_1B084) )
  {
    v4 = 0xFFFFFFFF;
    LOWORD(shapeNumber) = 0;
  }
  sub_156C0(a1, shapeCacheIndex, shapeNumber);
  return v4;
}

//----- (00012674) --------------------------------------------------------
void __fastcall sub_12674(P_Wnd04BM a1)
{
  a1->Unknown_4F37 = 0xFF;
  a1->pTarget2 = 0;
  a1->Unknown_5034 = 0;
  a1->Unknown_B7 = 4;
  Q_WinMgr_sub_56400(&WinMgr, a1->a2.index, 0x52, 0, 0, 0);
}

//----- (000126F8) --------------------------------------------------------
T_Wnd04BM *__usercall sub_126F8@<eax>(T_Wnd04BM *a1@<eax>, int sfx2@<edx>, int a3@<ebp>)
{
  unsigned int v4; // edi
  P_Wnd19BC pWnd19BC; // edx
  char v6; // al
  char type; // bl
  T_Target *p_target; // edx
  P_TargetObject v9; // edx
  int *p_invincible; // edx
  char v11; // al
  T_Wnd04BM *result; // eax
  int index; // edx
  int i; // ebx
  int j; // ebx
  int k; // kr14_4

  v4 = 0;
  if ( a1->Unknown_4F37 != (char)0xFF )
  {
    goto LABEL_42;
  }
  sub_187EC(a1);
  sub_18C2C(a1, 0);
  pWnd19BC = a1->pWnd19BC;
  a1->Unknown_4F38[0] = 0;
  v6 = 0;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    if ( type != 2 )
    {
      goto LABEL_41;
    }
    v6 = 0x34;
    if ( p_target->pObject.pPlanet->t22.pt23->planetItemIndex == 0x11 )
    {
      a1->Unknown_4F37 = 3;
      goto LABEL_41;
    }
    goto LABEL_40;
  }
  v9.pPlanet = (P_Planet)p_target->pObject;
  type = v9.pPlanet->invincible;
  p_invincible = &v9.pPlanet->invincible;
  if ( type )
  {
    if ( type != 1 )
    {
      goto LABEL_41;
    }
    v6 = **(_BYTE **)((char *)p_invincible + 1);
    switch ( v6 )
    {
      case '4':
        a1->Unknown_4F37 = 3;
        goto LABEL_41;
      case '7':
        a1->Unknown_4F37 = 4;
        goto LABEL_41;
      case ' ':
        a1->Unknown_4F37 = 5;
        goto LABEL_41;
      case '8':
      case 'J':
        a1->Unknown_4F37 = 6;
        goto LABEL_41;
      case ':':
        a1->Unknown_4F37 = 7;
        goto LABEL_41;
      case '.':
        a1->Unknown_4F37 = 8;
        goto LABEL_41;
      case '<':
        a1->Unknown_4F37 = 9;
        goto LABEL_41;
      case ';':
      case 'D':
        a1->Unknown_4F37 = 0xA;
        goto LABEL_41;
      case '-':
        a1->Unknown_4F37 = 0xB;
        goto LABEL_41;
      case '(':
      case '\'':
        a1->Unknown_4F37 = 0xC;
        goto LABEL_41;
      case '$':
        a1->Unknown_4F37 = 0xD;
        goto LABEL_41;
      case 'H':
        a1->Unknown_4F37 = 0xE;
        goto LABEL_41;
      case '&':
        a1->Unknown_4F37 = 0xF;
        goto LABEL_41;
    }
    if ( (V_Gizmos[v6].flags & 0x40) == 0 )
    {
      a1->Unknown_4F37 = 2;
      goto LABEL_41;
    }
LABEL_40:
    a1->Unknown_4F37 = type;
    goto LABEL_41;
  }
  a1->Unknown_4F37 = 0;
LABEL_41:
  Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a1->Unknown_19C6[a1->gvShape[v6].shape1]);
  Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a1->Unknown_19C6[a1->gvShape[v11].shape2]);
  sub_50140(&V_SSystem, a1->gvSfx[v11].sfx1);
  sfx2 = a1->gvSfx[v11].sfx2;
  sub_50140(&V_SSystem, sfx2);
LABEL_42:
  for ( i = 0; i < a1->Unknown_5034; ++i )
  {
    sfx2 = a1->Unknown_4F38[i + 3];
    sub_12B4C((int)a1, sfx2);
  }
  switch ( a1->Unknown_4F37 )
  {
    case 0xFF:
      v4 = 0xFFFFFFFF;
      break;
    case 0:
      v4 = sub_12C98(a1, sfx2, i);
      break;
    case 1:
      v4 = sub_12E88((int)a1);
      break;
    case 2:
      v4 = sub_12F7C((int)a1, a3);
      break;
    case 3:
      v4 = sub_13370((int)a1, sfx2, i);
      break;
    case 4:
      v4 = sub_136C4((int)a1);
      break;
    case 5:
      v4 = sub_1380C((int)a1);
      break;
    case 6:
      v4 = sub_13C10(a1);
      break;
    case 7:
      v4 = sub_14224(a1);
      break;
    case 8:
      v4 = sub_142D8((int)a1);
      break;
    case 9:
      v4 = sub_14490((int)a1);
      break;
    case 0xA:
      v4 = sub_145C0((int)a1);
      break;
    case 0xB:
      v4 = sub_147CC((int)a1);
      break;
    case 0xC:
      v4 = sub_14B18((int)a1, sfx2, i);
      break;
    case 0xD:
      v4 = sub_15078(a1);
      break;
    case 0xE:
      v4 = sub_15164((int)a1);
      break;
    case 0xF:
      v4 = sub_152E4((int)a1, sfx2, i, (int)a1);
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0xF8);
      break;
  }
  if ( *(_DWORD *)a1->Unknown_5036 == 0xFFFFFFFF )
  {
    v4 = 0xFFFFFFFF;
    *(_DWORD *)a1->Unknown_5036 = 0;
  }
  sub_18C2C(a1, 1);
  for ( j = 0; j < a1->Unknown_5034; ++j )
  {
    sub_12B4C((int)a1, a1->Unknown_4F38[j + 3]);
  }
  result = (T_Wnd04BM *)((int (__fastcall *)(T_Wnd04BM *, int))a1->a2.pProcs->proc4_draw)(a1, 1);
  ++a1->Unknown_4F38[0];
  if ( v4 == 0xFFFFFFFF )
  {
    index = a1->a2.index;
    a1->Unknown_B7 = 0;
    Q_WinMgr_sub_564C0(&WinMgr, index, 0x52);
    sub_12238(a1->pWnd19BC, 0xFFFFFFFF);
    sub_187EC(a1);
    sub_18C2C(a1, 0);
    a1->Unknown_4F37 = 0xFF;
    result = a1;
    for ( k = 0; k < a1->Unknown_5034; ++k )
    {
      *(_BYTE *)(a1->Unknown_4F38[k + 3] + 0x33) &= 1u;
    }
  }
  return result;
}

//----- (00012AE4) --------------------------------------------------------
P_BatDisplayItem __fastcall sub_12AE4(P_Wnd04BM pWnd04BM, P_TargetObject a2)
{
  T_BatDisplayItem *v3; // edi
  int v4; // edx
  P_BatDisplayItem pBatDisplayItems; // kr00_4

  if ( !a2.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x122);
  }
  v3 = 0;
  if ( pWnd04BM->Unknown_1D32 > 0 )
  {
    pBatDisplayItems = pWnd04BM->pBatDisplayItems;
    v4 = 0;
    while ( a2.pPlanet != pBatDisplayItems[v4].target.pObject.pPlanet )
    {
      if ( ++v4 >= pWnd04BM->Unknown_1D32 )
      {
        goto LABEL_10;
      }
    }
    v3 = &pBatDisplayItems[v4];
  }
LABEL_10:
  if ( !v3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x12F);
  }
  return v3;
}

//----- (00012B4C) --------------------------------------------------------
void __fastcall sub_12B4C(int a1, int a2)
{
  int v2; // ebx
  int v3; // esi
  int v4; // ecx
  LONG v5; // eax
  int v6; // eax
  LONG v7; // ebx
  double v8; // st7
  double v9; // st6
  double v10; // st5
  int v11; // [esp+Ch] [ebp-18h]

  if ( *(_BYTE *)a2 == 8 )
  {
    v2 = *(_DWORD *)(a2 + 1);
    if ( *(_WORD *)(a2 + 0x27) >= *(_WORD *)(v2 + 0x27) )
    {
      v3 = *(_DWORD *)(a1 + 8);
      pPane.x0 = v3 + *(__int16 *)(v2 + 0x27);
      v4 = *(__int16 *)(a2 + 0x27);
    }
    else
    {
      v3 = *(__int16 *)(v2 + 0x27);
      pPane.x0 = *(_DWORD *)(a1 + 8) + *(__int16 *)(a2 + 0x27);
      v4 = *(_DWORD *)(a1 + 8);
    }
    pPane.x1 = v3 + v4;
    if ( *(_WORD *)(a2 + 0x29) >= *(_WORD *)(v2 + 0x29) )
    {
      v6 = *(_DWORD *)(a1 + 0xC);
      v7 = *(__int16 *)(v2 + 0x29) + v6;
      v5 = *(__int16 *)(a2 + 0x29) + v6;
      pPane.y0 = v7;
    }
    else
    {
      pPane.y0 = *(__int16 *)(a2 + 0x29) + *(_DWORD *)(a1 + 0xC);
      v5 = *(__int16 *)(v2 + 0x29) + *(_DWORD *)(a1 + 0xC);
    }
    pPane.y1 = v5;
  }
  else
  {
    v11 = *(__int16 *)(a2 + 0x29) + *(_DWORD *)(a1 + 0xC);
    v8 = (double)*(unsigned int *)(a2 + 0xF) * 0.0000152587890625;
    v9 = (double)(*(__int16 *)(a2 + 0x27) + *(_DWORD *)(a1 + 8));
    pPane.x0 = (int)((double)*(__int16 *)(a2 + 0x13) * v8 + v9);
    v10 = (double)v11;
    pPane.y0 = (int)((double)*(__int16 *)(a2 + 0x15) * v8 + v10);
    pPane.x1 = (int)(v9 + (double)*(__int16 *)(a2 + 0x17) * v8);
    pPane.y1 = (int)(v8 * (double)*(__int16 *)(a2 + 0x19) + v10);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
}

//----- (00012C98) --------------------------------------------------------
unsigned int __fastcall sub_12C98(P_Wnd04BM a1, int a2, int a3)
{
  P_Wnd19BC pWnd19BC; // edi
  unsigned int v5; // ebp
  BYTE type; // ah
  T_Target *p_target; // edi
  P_TargetObject v8; // edi
  char dayColonized; // dl
  P_BatDisplayItem v10; // eax
  P_BatDisplayItem v11; // eax
  int v13; // edi
  void *ShapeTable_sub_1B084; // eax
  int v15; // edi
  int v16; // ecx
  unsigned __int16 v17; // [esp+0h] [ebp-1Ch]

  pWnd19BC = a1->pWnd19BC;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x16B);
  }
  v5 = 0;
  v8.pPlanet = (P_Planet)p_target->pObject;
  dayColonized = v8.pPlanet->dayColonized;
  if ( dayColonized != 3 && dayColonized != 1 && dayColonized != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x171);
  }
  if ( !a1->Unknown_4F38[0] )
  {
    a1->Unknown_5034 = 1;
    v10 = sub_12AE4(a1, v8);
    a1->Unknown_4F44 = v10;
    v10->Unknown_33 = 0x12;
    *((_BYTE *)a1->Unknown_4F44 + 0x34) = 0;
    a1->vectors3[0].x = *(float *)((char *)&v8.pPlanet[1].Unknown_22 + 1);
    a1->vectors3[0].y = *(float *)&v8.pPlanet[1].name[3];
    a1->vectors3[0].z = *(float *)&v8.pPlanet[1].name[7];
    a1->Unknown_4F38[1] = 0;
    if ( *(_DWORD *)((char *)&v8.pPlanet[1].surfaceSquaresNum + 1) )
    {
      if ( *(_DWORD *)((char *)&v8.pPlanet[1].starIndex + 1) )
      {
        Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 7);
      }
    }
  }
  if ( a1->Unknown_4F38[1] )
  {
    v17 = 7;
    if ( (*(_BYTE *)(*(int *)((char *)&v8.pPlanet->dayColonized + 1) + 0x23) & 1) != 0 )
    {
      v17 = 8;
    }
    v13 = a1->Unknown_4F38[1];
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a1->Unknown_19C6[v17]);
    v15 = v13 >> 2;
    v16 = VFX_shape_count(ShapeTable_sub_1B084) - 1;
    if ( v15 <= v16 || v15 > 2 * v16 )
    {
      if ( v15 > 2 * v16 )
      {
        v5 = 0xFFFFFFFF;
        LOWORD(v15) = 0;
      }
    }
    else
    {
      LOWORD(v15) = 2 * v16 - v15;
    }
    sub_1826C(a1, (P_BatDisplayItem)a1->Unknown_4F48, v17, v15);
    ++a1->Unknown_4F38[1];
  }
  else if ( sub_12480(&a1->vectors3[0].x, (float *)((char *)&v8.pPlanet->Unknown_77 + 1), 20.0) == 0xFFFFFFFF )
  {
    if ( (v8.pShip->Unknown_84 & 8) == 0
      || v8.pShip->_target.type != 2
      || Q_Ship_CanTraverseStarLane_sub_4960C(v8.pShip, (P_Lane)v8.pShip->_target.pObject.pShip) != 0xFFFFFFFF )
    {
      return 0xFFFFFFFF;
    }
    *((_BYTE *)a1->Unknown_4F44 + 0x33) |= 8u;
    a1->Unknown_5034 = 2;
    v11 = sub_12AE4(a1, *(P_TargetObject *)((char *)&v8.pPlanet->dayColonized + 1));
    a1->Unknown_4F38[1] = 1;
    a1->Unknown_4F48 = (int)v11;
  }
  return v5;
}

//----- (00012E88) --------------------------------------------------------
unsigned int __fastcall sub_12E88(int a1)
{
  int v2; // ebp
  int v3; // edi
  char v4; // ah
  int v5; // ebp
  int v6; // eax
  char v7; // bl
  _BYTE *v8; // edx

  v2 = *(_DWORD *)(a1 + 0xAB);
  v4 = *(_BYTE *)(v2 + 0xAB);
  v5 = v2 + 0xAB;
  if ( v4 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x1BA);
  }
  v3 = 0;
  v6 = *(_DWORD *)(v5 + 1);
  v7 = **(_BYTE **)(v6 + 0x63);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    v8 = *(_BYTE **)(a1 + 0x1D2A);
    *(_WORD *)(a1 + 0x5034) = 1;
    v8 += 0x35;
    *(_DWORD *)(a1 + 0x4F44) = v8;
    *v8 = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)(v6 + 0x9E);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)(v6 + 0xA2);
    *(float *)(a1 + 0x4F88) = *(float *)(v6 + 0xA6);
    sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F44), *(_WORD *)(a1 + 4 * v7 + 0x1A92), 0);
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 4 * v7 + 0x1BCE));
  }
  if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618(*(T_BatDisplayItem **)(a1 + 0x4F44)) == 0xFFFFFFFF )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (00012F7C) --------------------------------------------------------
int __usercall sub_12F7C@<eax>(int a1@<eax>, int ebp0@<ebp>)
{
  int v3; // edx
  char v4; // bl
  int v5; // ebp
  int v6; // ebp
  int *v7; // edi
  int v8; // ebp
  UBYTE v9; // al
  char v10; // cl
  int v11; // eax
  int v12; // edi
  __int16 v14; // di
  unsigned __int16 v15; // ax
  _BYTE *v16; // eax
  char v17; // bl
  int v18; // eax
  float x_4; // [esp+4h] [ebp-7Ch]
  float v20; // [esp+8h] [ebp-78h] BYREF
  _DWORD *a2; // [esp+Ch] [ebp-74h]
  _DWORD *a3; // [esp+10h] [ebp-70h]
  _DWORD *a4; // [esp+14h] [ebp-6Ch]
  float v24; // [esp+18h] [ebp-68h]
  float v25; // [esp+1Ch] [ebp-64h]
  int v26[3]; // [esp+20h] [ebp-60h] BYREF
  float v27; // [esp+2Ch] [ebp-54h]
  int v28; // [esp+30h] [ebp-50h]
  int v29; // [esp+34h] [ebp-4Ch]
  int v30; // [esp+38h] [ebp-48h] BYREF
  __int64 result; // [esp+3Ch] [ebp-44h] BYREF
  _DWORD v32[2]; // [esp+48h] [ebp-38h] BYREF
  int v33; // [esp+50h] [ebp-30h]
  float v34; // [esp+54h] [ebp-2Ch]
  int v35; // [esp+58h] [ebp-28h]
  int v36; // [esp+5Ch] [ebp-24h]
  _BYTE *v37; // [esp+60h] [ebp-20h]
  char v38; // [esp+64h] [ebp-1Ch]

  v33 = 0;
  v3 = *(_DWORD *)(a1 + 0xAB) + 0xAB;
  *(float *)&a4 = 0.0;
  v24 = 0.0;
  v25 = 0.0;
  v20 = 0.0;
  *(float *)&a2 = 0.0;
  *(float *)&a3 = 0.0;
  v32[0] = 0;
  v4 = *(_BYTE *)v3;
  v38 = 0;
  if ( v4 == 3 )
  {
    v5 = *(_DWORD *)(v3 + 1);
    a4 = *(_DWORD **)(v5 + 0x9E);
    v24 = *(float *)(v5 + 0xA2);
    v25 = *(float *)(v5 + 0xA6);
    v20 = *(float *)(v5 + 0x78);
    a2 = *(_DWORD **)(v5 + 0x7C);
    a3 = *(_DWORD **)(v5 + 0x80);
    v36 = **(char **)(v5 + 0x63);
    v35 = *(_DWORD *)(v5 + 0x84);
    v38 = *(_BYTE *)(v5 + 0x67);
    ebp0 = *(_DWORD *)(v5 + 0x68);
    v32[0] = V_Gizmos[v36].range;
  }
  else if ( v4 == 2 )
  {
    v6 = *(_DWORD *)(v3 + 1);
    a4 = *(_DWORD **)v6;
    v24 = *(float *)(v6 + 4);
    v7 = (int *)(v6 + 0x6B);
    v25 = *(float *)(v6 + 8);
    v8 = *(_DWORD *)(v6 + 0x6F);
    v20 = *(float *)(v8 + 0x9E);
    a2 = *(_DWORD **)(v8 + 0xA2);
    a3 = *(_DWORD **)(v8 + 0xA6);
    v35 = v7[2];
    ebp0 = v7[1];
    v9 = *(_BYTE *)(*v7 + 1);
    HIDWORD(result) = *(_DWORD *)(v3 + 1);
    Q_Planet_GetOrbitalWeaponStats_sub_366C8((P_Planet)HIDWORD(result), v9, v32, &v30, (LONG *)&result);
    v10 = *(_BYTE *)(*v7 + 1);
    switch ( v10 )
    {
      case 0x1C:
        v36 = 0x4C;
        break;
      case 0x1D:
        v36 = 0x4D;
        break;
      case 0x1E:
        v36 = 0x4E;
        break;
    }
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0x20E);
  }
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v11 = *(_DWORD *)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F44) = v11 + 0x35;
    *(_BYTE *)(v11 + 0x35) = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = *(float *)&a4;
    *(float *)(a1 + 0x4F84) = v24;
    v12 = v36;
    *(float *)(a1 + 0x4F88) = v25;
    sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F44), *(_WORD *)(a1 + 4 * v12 + 0x1A92), 0);
    *(_DWORD *)(a1 + 0x4F48) = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)ebp0);
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 4 * v12 + 0x1BCE));
  }
  if ( *(_DWORD *)(a1 + 0x4F3C) )
  {
    v14 = 1;
    v34 = 1.0;
    v15 = 4;
    if ( (v35 & 4) != 0 || v36 == 0x3D )
    {
      v16 = *(_BYTE **)(a1 + 0x4F48);
      if ( *v16 == 2 )
      {
        LOWORD(v16) = *(char *)(ebp0 + 0xAA);
        v37 = v16;
        v34 = (double)(__int16)v16 * 0.3333333333333333 + 1.0;
      }
      v14 = 5;
      v17 = v36;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 8u;
      v15 = (char)(((v17 & 1) == 0) + 5);
      if ( v36 != 0x3D )
      {
        goto LABEL_29;
      }
      v18 = 0x3D;
    }
    else
    {
      if ( (v35 & 2) == 0 && (v35 & 0x10) == 0 && v38 != 1 && v38 != 2 )
      {
        goto LABEL_29;
      }
      v18 = v36;
    }
    v14 = *(_WORD *)(a1 + 4 * v18 + 0x1BD0);
    v15 = *(_WORD *)(a1 + 4 * v18 + 0x1A94);
LABEL_29:
    if ( *(_DWORD *)(a1 + 0x4F3C) == 1 )
    {
      sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F44), v15, 0);
      Q_SSystem_StartSample_sub_4FB90(&V_SSystem, v14);
      *(_DWORD *)(a1 + 0x4F3C) = 2;
    }
    if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618(*(T_BatDisplayItem **)(a1 + 0x4F44)) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 8u;
      v33 = 0xFFFFFFFF;
    }
    *(float *)(*(_DWORD *)(a1 + 0x4F44) + 0xB) = v34;
    return v33;
  }
  v27 = v20 - *(float *)&a4;
  v32[1] = v26;
  *(float *)&v28 = *(float *)&a2 - v24;
  *(float *)&v29 = *(float *)&a3 - v25;
  *(float *)v26 = v27;
  v26[1] = v28;
  v26[2] = v29;
  x_4 = sqrt(*(float *)&v28 * *(float *)&v28 + v27 * v27 + *(float *)&v29 * *(float *)&v29) * 0.015625 + 20.0;
  if ( sub_12480((float *)(a1 + 0x4F80), &v20, x_4) != 0xFFFFFFFF )
  {
    sub_12618(*(T_BatDisplayItem **)(a1 + 0x4F44));
    return v33;
  }
  *(_DWORD *)(a1 + 0x4F3C) = 1;
  return v33;
}

//----- (00013370) --------------------------------------------------------
unsigned int __fastcall sub_13370(int a1, int a2, int a3)
{
  int v4; // ebp
  int v5; // eax
  P_TargetObject v6; // esi
  char v7; // dl
  int v8; // edi
  int *v9; // ebx
  int v10; // eax
  P_BatDisplayItem v11; // eax
  int v12; // eax
  double v13; // st7
  double v14; // st7
  float v16; // [esp+8h] [ebp-6Ch] BYREF
  float v17; // [esp+Ch] [ebp-68h]
  float v18; // [esp+10h] [ebp-64h]
  T_Vector3D v19; // [esp+14h] [ebp-60h] BYREF
  T_Vector3D v20; // [esp+20h] [ebp-54h] BYREF
  float v21; // [esp+2Ch] [ebp-48h]
  float v22; // [esp+30h] [ebp-44h]
  float v23; // [esp+34h] [ebp-40h]
  float v24; // [esp+38h] [ebp-3Ch]
  float v25; // [esp+3Ch] [ebp-38h]
  float v26; // [esp+40h] [ebp-34h]
  int v27; // [esp+44h] [ebp-30h]
  T_Vector3D *v28; // [esp+48h] [ebp-2Ch]
  float *v29; // [esp+4Ch] [ebp-28h]
  float v30; // [esp+50h] [ebp-24h]
  P_BatDisplayItem v31; // [esp+54h] [ebp-20h]
  float v32; // [esp+58h] [ebp-1Ch]

  v4 = 0;
  v5 = *(_DWORD *)(a1 + 0xAB) + 0xAB;
  v21 = 0.0;
  v22 = 0.0;
  v23 = 0.0;
  v6.pPlanet = 0;
  v7 = *(_BYTE *)v5;
  v31 = 0;
  if ( v7 == 3 )
  {
    v8 = *(_DWORD *)(v5 + 1);
    if ( *(_BYTE *)(v8 + 0x67) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x27D);
    }
    v6.pPlanet = *(P_Planet *)(v8 + 0x68);
    v31 = sub_12AE4((P_Wnd04BM)a1, *(P_TargetObject *)(v5 + 1));
    v21 = *(float *)(v8 + 0x9E);
    v22 = *(float *)(v8 + 0xA2);
    v23 = *(float *)(v8 + 0xA6);
    v27 = 0x20 * V_Gizmos[0x34].special1;
    v30 = (float)(0x20 * V_Gizmos[0x34].special1);
  }
  else if ( v7 == 2 )
  {
    v9 = *(int **)(v5 + 1);
    v6.pPlanet = *(P_Planet *)((char *)v9 + 0x6F);
    v31 = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)v9);
    v21 = *(float *)v9;
    v22 = *((float *)v9 + 1);
    v23 = *((float *)v9 + 2);
    v30 = 3200.0;
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0x28E);
  }
  sub_12AE4((P_Wnd04BM)a1, v6);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v10 = *(_DWORD *)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F44) = v10 + 0x35;
    *(_BYTE *)(v10 + 0x35) = 8;
    *(_DWORD *)(*(_DWORD *)(a1 + 0x4F44) + 1) = v31;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = v21;
    *(float *)(a1 + 0x4F84) = v22;
    *(float *)(a1 + 0x4F88) = v23;
    v11 = sub_12AE4((P_Wnd04BM)a1, v6);
    *(_DWORD *)(a1 + 0x4F48) = v11;
    v11->Unknown_33 = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v6.pPlanet[1].Unknown_22 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v6.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v6.pPlanet[1].name[7];
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 1);
  }
  v12 = *(_DWORD *)(a1 + 0x4F3C);
  if ( !v12 )
  {
    if ( sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), 40.0) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 2u;
      memset(&v19, 0, sizeof(v19));
      v28 = &v20;
      v19.x = *(float *)(a1 + 0x4F8C) - v21;
      v19.y = *(float *)(a1 + 0x4F90) - v22;
      v19.z = *(float *)(a1 + 0x4F94) - v23;
      v20 = v19;
      v13 = sqrt(v19.y * v19.y + v19.x * v19.x + v19.z * v19.z);
      v14 = v13 - v30;
      v32 = v14;
      if ( v14 < 1280.0 )
      {
        v32 = 1280.0;
      }
      Q_Vector3D_SetLength_sub_53054(&v20, v32);
      v29 = &v16;
      v24 = v21 + v20.x;
      v16 = v24;
      v25 = v22 + v20.y;
      v17 = v25;
      v26 = v23 + v20.z;
      v18 = v26;
      *(float *)(a1 + 0x4F98) = v24;
      *(float *)(a1 + 0x4F9C) = v17;
      *(float *)(a1 + 0x4FA0) = v18;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
      return 0;
    }
    return v4;
  }
  if ( v12 != 1 )
  {
    return 0xFFFFFFFF;
  }
  if ( sub_12480((float *)(a1 + 0x4F8C), (float *)(a1 + 0x4F98), 4.0) == 0xFFFFFFFF )
  {
    *(_DWORD *)(a1 + 0x4F3C) = 2;
  }
  *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)(a1 + 0x4F8C);
  *(float *)(a1 + 0x4F84) = *(float *)(a1 + 0x4F90);
  *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)(a1 + 0x4F94);
  return 0;
}

//----- (000136C4) --------------------------------------------------------
unsigned int __fastcall sub_136C4(int a1)
{
  int v2; // edi
  int v3; // esi
  char v4; // ah
  int v5; // edi
  _DWORD *v6; // ebx
  P_TargetObject v7; // edi
  P_BatDisplayItem v8; // eax
  P_BatDisplayItem v9; // eax
  int v10; // ebx
  int v12; // [esp+0h] [ebp-24h]
  int v13; // [esp+4h] [ebp-20h]
  int v14; // [esp+8h] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  v4 = *(_BYTE *)(v2 + 0xAB);
  v5 = v2 + 0xAB;
  if ( v4 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x2D8);
  }
  v3 = 0;
  v6 = *(_DWORD **)(v5 + 1);
  v7.pPlanet = (P_Planet)v6[0x1A];
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v8 = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)v6);
    *(_DWORD *)(a1 + 0x4F44) = v8;
    v8->Unknown_33 = 0x14;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)((char *)v6 + 0x9E);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)((char *)v6 + 0xA2);
    *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)((char *)v6 + 0xA6);
    v9 = sub_12AE4((P_Wnd04BM)a1, v7);
    *(_DWORD *)(a1 + 0x4F48) = v9;
    v9->Unknown_33 = 0x14;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v7.pPlanet[1].Unknown_22 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v7.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v7.pPlanet[1].name[7];
  }
  v10 = *(_DWORD *)(a1 + 0x4F38);
  if ( v10 == 0x14 )
  {
    v12 = *(_DWORD *)(a1 + 0x4F8C);
    v13 = *(_DWORD *)(a1 + 0x4F90);
    v14 = *(_DWORD *)(a1 + 0x4F94);
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)(a1 + 0x4F80);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)(a1 + 0x4F84);
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)(a1 + 0x4F88);
    *(_DWORD *)(a1 + 0x4F80) = v12;
    *(_DWORD *)(a1 + 0x4F84) = v13;
    *(_DWORD *)(a1 + 0x4F88) = v14;
  }
  else if ( v10 == 0x29 )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (0001380C) --------------------------------------------------------
unsigned int __fastcall sub_1380C(int a1)
{
  int v2; // ecx
  int v3; // edi
  int v4; // eax
  P_TargetObject v5; // ebp
  int v6; // edx
  int v7; // eax
  int v8; // eax
  double v9; // st7
  int v10; // eax
  int v11; // edx
  int v12; // ebx
  _BYTE *v13; // eax
  int v15[3]; // [esp+0h] [ebp-30h] BYREF
  int v16; // [esp+Ch] [ebp-24h]
  int v17; // [esp+10h] [ebp-20h]
  char v18; // [esp+14h] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x30D);
  }
  v4 = *(_DWORD *)(v2 + 0xAC);
  v17 = v4;
  if ( *(_BYTE *)(v4 + 0x67) != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x312);
  }
  v3 = 0;
  v5.pPlanet = *(P_Planet *)(v4 + 0x68);
  v15[0] = *(_DWORD *)(v4 + 0x78);
  v15[1] = *(_DWORD *)(v4 + 0x7C);
  v15[2] = *(_DWORD *)(v4 + 0x80);
  v6 = *(_DWORD *)(a1 + 0x4F38);
  v18 = **(_BYTE **)(v4 + 0x63);
  if ( !v6 )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v7 = *(_DWORD *)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F44) = v7 + 0x35;
    *(_BYTE *)(v7 + 0x35) = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    v8 = v17 + 0x9E;
    *(float *)(a1 + 0x4F80) = *(float *)(v17 + 0x9E);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)(v8 + 4);
    v9 = *(float *)(v8 + 8);
    v10 = 4 * v18;
    *(float *)(a1 + 0x4F88) = v9;
    v16 = a1 + v10;
    sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F44), *(_WORD *)(a1 + v10 + 0x1A92), 0);
    v11 = v16;
    *(_DWORD *)(a1 + 0x4F48) = sub_12AE4((P_Wnd04BM)a1, v5);
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(v11 + 0x1BCE));
  }
  v12 = *(_DWORD *)(a1 + 0x4F3C);
  if ( v12 )
  {
    *(_DWORD *)(a1 + 0x4F3C) = v12 + 1;
    if ( v12 + 1 > 0x14 )
    {
      return 0xFFFFFFFF;
    }
  }
  else if ( sub_12480((float *)(a1 + 0x4F80), (float *)v15, 40.0) == 0xFFFFFFFF )
  {
    v13 = *(_BYTE **)(a1 + 0x4F44);
    *(_DWORD *)(a1 + 0x4F3C) = 1;
    *v13 = 0xFF;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 4u;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 4 * v18 + 0x1BD0));
  }
  return v3;
}

//----- (000139E0) --------------------------------------------------------
void __fastcall sub_139E0(P_Wnd04BM a1, P_BatDisplayItem a2)
{
  switch ( a1->Unknown_4F37 )
  {
    case 4:
      sub_13A28(a1, a2);
      break;
    case 5:
      sub_13AD8(a1, a2);
      break;
    case 7:
    case 0xA:
    case 0xC:
    case 0xD:
    case 0xE:
      sub_15630(a1, a2);
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0x362);
      break;
  }
}

//----- (00013A28) --------------------------------------------------------
void __fastcall sub_13A28(P_Wnd04BM a1, P_BatDisplayItem a2)
{
  double v3; // st7
  void *ShapeTable_sub_1B084; // eax
  int shapeNumber; // [esp-20h] [ebp-3Ch]
  LONG Unknown_27; // [esp-1Ch] [ebp-38h]
  LONG Unknown_29; // [esp-18h] [ebp-34h]
  LONG v8; // [esp-Ch] [ebp-28h]
  float v9; // [esp+8h] [ebp-14h]

  if ( a2->target.type != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x36B);
  }
  if ( a1->Unknown_4F38[0] >= 0x14 )
  {
    v3 = (double)a1->Unknown_4F38[0] + -20.0;
  }
  else
  {
    v3 = 20.0 - (double)a1->Unknown_4F38[0];
  }
  v9 = v3 * 0.05;
  v8 = (int)((double)a2->_scale * v9);
  Unknown_29 = a2->Unknown_29;
  Unknown_27 = a2->Unknown_27;
  shapeNumber = a2->shapeNumber;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a2->shapeCacheIndex);
  VFX_shape_transform(&a1->a2.pane, ShapeTable_sub_1B084, shapeNumber, Unknown_27, Unknown_29, V_BigBuffer, 0, v8, v8, 0);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00013AD8) --------------------------------------------------------
void __fastcall sub_13AD8(P_Wnd04BM a1, P_BatDisplayItem a2)
{
  void *ShapeTable_sub_1B084; // eax
  int shapeNumber; // [esp-20h] [ebp-44h]
  LONG Unknown_27; // [esp-1Ch] [ebp-40h]
  LONG Unknown_29; // [esp-18h] [ebp-3Ch]
  int scale; // [esp-8h] [ebp-2Ch]
  LONG width; // [esp+10h] [ebp-14h]
  int widtha; // [esp+10h] [ebp-14h]

  width = a1->Unknown_4F38[1];
  if ( width > 0xA )
  {
    width = 0x14 - width;
    sub_1826C(a1, a2, a1->gvShape[0x20].shape2, 2u);
  }
  scale = a2->_scale;
  Unknown_29 = a2->Unknown_29;
  Unknown_27 = a2->Unknown_27;
  shapeNumber = a2->shapeNumber;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a2->shapeCacheIndex);
  VFX_shape_transform(&a1->a2.pane, ShapeTable_sub_1B084, shapeNumber, Unknown_27, Unknown_29, V_BigBuffer, 0, scale, scale, 0);
  widtha = (int)((double)(unsigned int)a2->_scale * 0.0000152587890625 * (double)((a2->x1 - a2->x0) * width) * 0.050000001);
  VFX_ellipse_fill(&a1->a2.pane, a2->Unknown_27, a2->Unknown_29, widtha, widtha, 0x96);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00013BC0) --------------------------------------------------------
void __fastcall __spoils<> Q_Vector3D_Copy_sub_13BC0(P_Vector3D dst, P_Vector3D src)
{
  *dst = *src;
}

//----- (00013BF0) --------------------------------------------------------
void __fastcall __spoils<> Q_Vector3D_Ctor_sub_13BF0(P_Vector3D a1)
{
  a1->x = 0.0;
  a1->y = 0.0;
  a1->z = 0.0;
}

//----- (00013C10) --------------------------------------------------------
unsigned int __fastcall sub_13C10(P_Wnd04BM pWnd04BM)
{
  P_Wnd19BC pWnd19BC; // ecx
  P_Ship pShip_1; // ecx
  P_Ship v4; // ebp
  BYTE gizmoIndex; // al
  char gizmoIndex__; // bl
  int shipsNum; // edi
  P_BatDisplayItem v8; // eax
  int i; // kr04_4
  P_Ship pShip; // edx
  P_BatDisplayItem v11; // eax
  P_Ship v12; // ecx
  T_Vector3D *v13; // edx
  int v14; // eax
  T_Vector3D *p_position; // edx
  int v16; // ebp
  char *Unknown_4F44; // eax
  int v19; // eax
  double special1; // st7
  double v21; // st7
  T_Vector3D *v22; // edi
  int v23; // kr14_4
  int v24; // edx
  int v25; // edx
  double v26; // st7
  double v27; // st7
  char *v28; // edx
  int j; // kr10_4
  P_Ship ships[107]; // [esp+8h] [ebp-238h] BYREF
  T_Vector3D v31; // [esp+1B4h] [ebp-8Ch] BYREF
  float v32; // [esp+1C0h] [ebp-80h]
  float v33; // [esp+1C4h] [ebp-7Ch]
  float v34; // [esp+1C8h] [ebp-78h]
  T_Vector3D v35; // [esp+1CCh] [ebp-74h] BYREF
  float v36; // [esp+1D8h] [ebp-68h] BYREF
  float v37; // [esp+1DCh] [ebp-64h]
  float v38; // [esp+1E0h] [ebp-60h]
  float x; // [esp+1E4h] [ebp-5Ch]
  float y; // [esp+1E8h] [ebp-58h]
  float z; // [esp+1ECh] [ebp-54h]
  T_Vector3D *v42; // [esp+1F0h] [ebp-50h]
  int v43; // [esp+1F4h] [ebp-4Ch]
  float v44; // [esp+1F8h] [ebp-48h]
  float *v45; // [esp+1FCh] [ebp-44h]
  int v46; // [esp+200h] [ebp-40h]
  float v47; // [esp+204h] [ebp-3Ch]
  int v48; // [esp+208h] [ebp-38h]
  T_Vector3D *vectors3; // [esp+20Ch] [ebp-34h]
  int v50; // [esp+210h] [ebp-30h]
  float v51; // [esp+214h] [ebp-2Ch]
  float v52; // [esp+218h] [ebp-28h]
  float v53; // [esp+21Ch] [ebp-24h]
  int v54; // [esp+220h] [ebp-20h]
  char gizmoIndex_; // [esp+224h] [ebp-1Ch]

  pWnd19BC = pWnd04BM->pWnd19BC;
  if ( pWnd19BC->target.type != ASCEND_TARGET_TYPE_3_LANE )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x31);
  }
  v46 = 0;
  pShip_1 = *(P_Ship *)((char *)&pWnd19BC->a2.magic12345678 + 1);
  v4 = 0;
  gizmoIndex = pShip_1->pCurHullCell->gizmoIndex;
  v48 = 1;
  gizmoIndex_ = gizmoIndex;
  if ( gizmoIndex == ASCEND_GIZMO_74_MASS_CONDENSOR )
  {
    if ( pShip_1->_target.type )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x3A);
    }
    v4 = pShip_1->_target.pObject.pShip;
    v48 = 2;
  }
  if ( !pWnd04BM->Unknown_4F38[0] )
  {
    gizmoIndex__ = gizmoIndex_;
    shipsNum = Q_FindShipsAtLocation_sub_1D794(pShip_1->pLocation, ships);
    pWnd04BM->Unknown_5034 = 1;
    if ( gizmoIndex__ == ASCEND_GIZMO_74_MASS_CONDENSOR )
    {
      pWnd04BM->Unknown_5034 = 2;
      pWnd04BM->Unknown_4F44 = sub_12AE4(pWnd04BM, (P_TargetObject)v4);
      v8 = pWnd04BM->pBatDisplayItems + 1;
      pWnd04BM->Unknown_4F48 = (int)v8;
      v8->target.type = 7;
      *(_BYTE *)(pWnd04BM->Unknown_4F48 + 0x33) = 0x12;
      *(_BYTE *)(pWnd04BM->Unknown_4F48 + 0x34) = 1;
      pWnd04BM->vectors3[1] = pShip_1->position;
      sub_1826C(pWnd04BM, (P_BatDisplayItem)pWnd04BM->Unknown_4F48, pWnd04BM->gvShape[gizmoIndex_].shape1, 0);
      if ( shipsNum <= 0 )
      {
        goto LABEL_18;
      }
    }
    else
    {
      pWnd04BM->Unknown_4F44 = sub_12AE4(pWnd04BM, (P_TargetObject)pShip_1->pLocation.pPlanet);
      if ( shipsNum <= 0 )
      {
LABEL_18:
        v14 = gizmoIndex_;
        pWnd04BM->Unknown_4F38[1] = 0;
        Q_SSystem_StartSample_sub_4FB90(&V_SSystem, pWnd04BM->gvSfx[v14].sfx1);
        goto LABEL_19;
      }
    }
    vectors3 = pWnd04BM->vectors3;
    v50 = 4 * shipsNum;
    for ( i = 0; i < shipsNum; ++i )
    {
      if ( pWnd04BM->Unknown_5034 >= 0xF )
      {
        break;
      }
      pShip = ships[i];
      if ( pShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM && pShip != v4 )
      {
        v11 = sub_12AE4(pWnd04BM, (P_TargetObject)pShip);
        v11->Unknown_33 |= 0x12u;
        v11->Unknown_34 = pWnd04BM->Unknown_5034;
        v12 = ships[i];
        v13 = &pWnd04BM->vectors3[v11->Unknown_34];
        v13->x = v12->position.x;
        v13->y = v12->position.y;
        v13->z = v12->position.z;
        LOWORD(v13) = pWnd04BM->Unknown_5034;
        pWnd04BM->Unknown_5034 = (_WORD)v13 + 1;
        pWnd04BM->Unknown_4F38[(__int16)v13 + 3] = (int)v11;
      }
    }
    goto LABEL_18;
  }
LABEL_19:
  p_position = &v4->position;
  v16 = pWnd04BM->Unknown_4F38[1];
  if ( v16 )
  {
    if ( v16 == 1 )
    {
      *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) = *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) + 0.039999999;
      Unknown_4F44 = (char *)pWnd04BM->Unknown_4F44;
      dword_9A234 = 0;
      if ( *(float *)(Unknown_4F44 + 0xB) >= 2.0 )
      {
        pWnd04BM->Unknown_4F38[1] = 2;
        return v46;
      }
    }
    else if ( v16 == 2 )
    {
      x = 0.0;
      y = 0.0;
      z = 0.0;
      if ( gizmoIndex_ == 0x4A )
      {
        x = p_position->x;
        y = p_position->y;
        z = p_position->z;
      }
      v19 = gizmoIndex_;
      special1 = (double)V_Gizmos[v19].special1;
      v54 = 0x20 * V_Gizmos[v19].special2;
      v47 = special1;
      v44 = (float)v54;
      v21 = v47 - *(float *)&dword_9A234;
      v51 = v21;
      if ( v21 > 0.2 )
      {
        v51 = 0.2;
      }
      v22 = pWnd04BM->vectors3;
      v43 = 0xFFFFFFFF;
      v23 = v48;
      *(float *)&dword_9A234 = *(float *)&dword_9A234 + v51;
      for ( j = 0; v23 + j < pWnd04BM->Unknown_5034; ++j )
      {
        v25 = *(char *)(pWnd04BM->Unknown_4F38[v48 + 3 + j] + 0x34);
        v42 = &v35;
        memset(&v31, 0, sizeof(v31));
        v31.x = v22[v25].x - x;
        v31.y = v22[v25].y - y;
        v31.z = v22[v25].z - z;
        v35 = v31;
        v26 = sqrt(v31.y * v31.y + v31.x * v31.x + v31.z * v31.z);
        v52 = v26;
        if ( v26 > v44 )
        {
          v27 = v52 - v51 * 32.0;
          v53 = v27;
          if ( v27 >= v44 )
          {
            v43 = 0;
          }
          else
          {
            v53 = v44;
          }
          v24 = v25;
          Q_Vector3D_SetLength_sub_53054(&v35, v53);
          v45 = &v36;
          v32 = x + v35.x;
          v36 = v32;
          v33 = y + v35.y;
          v37 = v33;
          v34 = z + v35.z;
          v38 = v34;
          v22[v24].x = v32;
          v22[v24].y = v37;
          v22[v24].z = v38;
        }
      }
      if ( *(float *)&dword_9A234 >= (double)v47 || v43 == 0xFFFFFFFF )
      {
        pWnd04BM->Unknown_4F38[1] = 3;
        return v46;
      }
    }
    else
    {
      *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) = *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) + -0.039999999;
      v28 = (char *)pWnd04BM->Unknown_4F44;
      if ( *(float *)(v28 + 0xB) <= 1.0 )
      {
        *(_DWORD *)(v28 + 0xB) = 0x3F800000;
        return 0xFFFFFFFF;
      }
    }
  }
  else
  {
    if ( gizmoIndex_ == 0x4A )
    {
      if ( sub_12480(&pWnd04BM->vectors3[1].x, &p_position->x, 10.0) != 0xFFFFFFFF )
      {
        sub_12618((T_BatDisplayItem *)pWnd04BM->Unknown_4F48);
        return v46;
      }
      *(_BYTE *)(pWnd04BM->Unknown_4F48 + 0x33) |= 8u;
    }
    pWnd04BM->Unknown_4F38[1] = 1;
  }
  return v46;
}
// 9A234: using guessed type int dword_9A234;

//----- (00014224) --------------------------------------------------------
unsigned int __fastcall sub_14224(T_Wnd04BM *a1)
{
  P_Wnd19BC pWnd19BC; // edi
  int v3; // esi
  BYTE type; // ah
  T_Target *p_target; // edi
  P_TargetObject v6; // edx
  char v7; // bl
  P_BatDisplayItem v8; // eax
  int v9; // eax

  pWnd19BC = a1->pWnd19BC;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0xCC);
  }
  v3 = 0;
  v6.pPlanet = (P_Planet)p_target->pObject;
  v7 = **(_BYTE **)((char *)&v6.pPlanet->invincible + 1);
  if ( !a1->Unknown_4F38[0] )
  {
    a1->Unknown_5034 = 1;
    v8 = sub_12AE4(a1, v6);
    a1->Unknown_4F44 = v8;
    v8->Unknown_33 |= 4u;
    a1->Unknown_4F38[1] = 0;
    a1->Unknown_4F38[2] = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, a1->gvSfx[v7].sfx1);
  }
  v9 = a1->Unknown_4F38[0];
  a1->Unknown_4F38[2] += v9 & 1;
  if ( v9 == 0x24 )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (000142D8) --------------------------------------------------------
int __fastcall sub_142D8(int a1)
{
  int v2; // esi
  P_TargetObject v3; // ebx
  int v4; // edx
  P_BatDisplayItem v5; // eax
  double v6; // st7
  int v7; // edx
  double v8; // st7
  double v9; // st6
  float v11; // [esp+8h] [ebp-40h] BYREF
  float v12; // [esp+Ch] [ebp-3Ch]
  float v13; // [esp+10h] [ebp-38h]
  float v14; // [esp+14h] [ebp-34h]
  float v15; // [esp+18h] [ebp-30h]
  float v16; // [esp+1Ch] [ebp-2Ch]
  float *v17; // [esp+20h] [ebp-28h]
  float v18; // [esp+24h] [ebp-24h]
  float v19; // [esp+28h] [ebp-20h]
  float v20; // [esp+2Ch] [ebp-1Ch]
  char v21; // [esp+30h] [ebp-18h]

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0xF5);
  }
  v3.pPlanet = *(P_Planet *)(v2 + 0xAC);
  v4 = *(_DWORD *)(a1 + 0x4F38);
  v21 = **(_BYTE **)((char *)&v3.pPlanet->invincible + 1);
  if ( !v4 )
  {
    *(_WORD *)(a1 + 0x5034) = 1;
    v5 = sub_12AE4((P_Wnd04BM)a1, v3);
    *(_DWORD *)(a1 + 0x4F44) = v5;
    v5->Unknown_33 |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = *(float *)((char *)&v3.pPlanet[1].Unknown_22 + 1);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)&v3.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)&v3.pPlanet[1].name[7];
    v14 = 0.0;
    v15 = 0.0;
    v16 = 0.0;
    v17 = &v11;
    v14 = -*(float *)((char *)&v3.pPlanet[1].Unknown_22 + 1);
    v15 = -*(float *)&v3.pPlanet[1].name[3];
    v6 = -*(float *)&v3.pPlanet[1].name[7];
    v11 = v14;
    v16 = v6;
    v12 = v15;
    v13 = v16;
    *(float *)(a1 + 0x4F8C) = v14;
    *(float *)(a1 + 0x4F90) = v12;
    *(float *)(a1 + 0x4F94) = v13;
    v7 = v21;
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 4 * v7 + 0x1BCE));
  }
  v8 = *(float *)(a1 + 0x4F90) * *(float *)(a1 + 0x4F90) + *(float *)(a1 + 0x4F8C) * *(float *)(a1 + 0x4F8C);
  v9 = *(float *)(a1 + 0x4F94) * *(float *)(a1 + 0x4F94);
  v20 = 0.0;
  v19 = sqrt(v8 + v9);
  v18 = sqrt(
          *(float *)(a1 + 0x4F84) * *(float *)(a1 + 0x4F84)
        + *(float *)(a1 + 0x4F80) * *(float *)(a1 + 0x4F80)
        + *(float *)(a1 + 0x4F88) * *(float *)(a1 + 0x4F88));
  if ( v19 > 1.0 )
  {
    v20 = (v19 - v18) * 96.0 / v19;
  }
  if ( v20 < 3.2 )
  {
    v20 = 3.2;
  }
  return sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), v20);
}

//----- (00014490) --------------------------------------------------------
int __fastcall sub_14490(int a1)
{
  int v2; // esi
  P_TargetObject v3; // esi
  _DWORD *v4; // ebx
  P_BatDisplayItem v5; // eax
  float v7; // [esp+0h] [ebp-1Ch]
  char v8; // [esp+4h] [ebp-18h]

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x127);
  }
  v3.pPlanet = *(P_Planet *)(v2 + 1);
  if ( LOBYTE(v3.pPlanet->dayColonized) != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x12B);
  }
  v4 = *(_DWORD **)((char *)&v3.pPlanet->dayColonized + 1);
  v8 = **(_BYTE **)((char *)&v3.pPlanet->invincible + 1);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 1;
    v5 = sub_12AE4((P_Wnd04BM)a1, v3);
    *(_DWORD *)(a1 + 0x4F44) = v5;
    v5->Unknown_33 |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)((char *)&v3.pPlanet[1].Unknown_22 + 1);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)&v3.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)&v3.pPlanet[1].name[7];
    *(_DWORD *)(a1 + 0x4F8C) = v4[5];
    *(_DWORD *)(a1 + 0x4F90) = v4[6];
    *(_DWORD *)(a1 + 0x4F94) = v4[7];
    if ( *(_DWORD *)&v3.pPlanet->byte59 == *v4 )
    {
      *(_DWORD *)(a1 + 0x4F8C) = v4[2];
      *(_DWORD *)(a1 + 0x4F90) = v4[3];
      *(_DWORD *)(a1 + 0x4F94) = v4[4];
    }
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 4 * v8 + 0x1BCE));
  }
  v7 = (double)*(int *)(a1 + 0x4F38) * 3.2;
  return sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), v7);
}

//----- (000145C0) --------------------------------------------------------
unsigned int __fastcall sub_145C0(int a1)
{
  int v2; // ecx
  P_TargetObject v3; // ecx
  P_TargetObject v4; // edi
  char v5; // bl
  P_BatDisplayItem v6; // eax
  _BYTE *v7; // eax
  P_BatDisplayItem v8; // eax
  int v9; // eax
  int v10; // edi
  int v12; // ebx
  int v13; // [esp+0h] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x158);
  }
  v3.pPlanet = *(P_Planet *)(v2 + 1);
  if ( LOBYTE(v3.pPlanet->dayColonized) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x15C);
  }
  v13 = 0;
  v4.pPlanet = *(P_Planet *)((char *)&v3.pPlanet->dayColonized + 1);
  v5 = **(_BYTE **)((char *)&v3.pPlanet->invincible + 1);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 3;
    v6 = sub_12AE4((P_Wnd04BM)a1, v3);
    *(_DWORD *)(a1 + 0x4F44) = v6;
    v6->Unknown_33 |= 4u;
    v7 = (_BYTE *)(*(_DWORD *)(a1 + 0x1D2A) + 0x35);
    *(_DWORD *)(a1 + 0x4F48) = v7;
    *v7 = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) = 0x1A;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v3.pPlanet[1].Unknown_22 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v3.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v3.pPlanet[1].name[7];
    sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F48), *(_WORD *)(a1 + 4 * v5 + 0x1A92), 0);
    v8 = sub_12AE4((P_Wnd04BM)a1, v4);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F40) = 0;
    *(_DWORD *)(a1 + 0x4F4C) = v8;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 4 * v5 + 0x1BCE));
  }
  v9 = *(_DWORD *)(a1 + 0x4F3C);
  if ( !v9 )
  {
    v10 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
    *(_DWORD *)(a1 + 0x4F40) = v10;
    if ( v10 == 0x12 )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) &= ~4u;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) &= ~8u;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
      *(_DWORD *)(a1 + 0x4F40) = 0;
    }
    return v13;
  }
  if ( v9 != 1 )
  {
    v12 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
    *(_DWORD *)(a1 + 0x4F40) = v12;
    if ( v12 == 0x12 )
    {
      return 0xFFFFFFFF;
    }
    return v13;
  }
  if ( sub_12480((float *)(a1 + 0x4F8C), (float *)((char *)&v4.pPlanet[1].Unknown_22 + 1), 20.0) == 0xFFFFFFFF )
  {
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 8u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F4C) + 0x33) |= 4u;
    *(_DWORD *)(a1 + 0x4F3C) = 2;
  }
  else
  {
    sub_12618(*(T_BatDisplayItem **)(a1 + 0x4F48));
  }
  return 0;
}

//----- (000147CC) --------------------------------------------------------
unsigned int __fastcall sub_147CC(int a1)
{
  int v2; // edi
  char v3; // ah
  int v4; // edi
  int v5; // ecx
  int v6; // edx
  P_TargetObject v7; // ebp
  int v8; // eax
  P_BatDisplayItem v9; // eax
  double v10; // st7
  double v11; // st7
  int v12; // edx
  float *v13; // edx
  double v14; // st7
  float v16; // [esp+4h] [ebp-84h]
  int v17[3]; // [esp+8h] [ebp-80h] BYREF
  float v18; // [esp+14h] [ebp-74h] BYREF
  float v19; // [esp+18h] [ebp-70h]
  float v20; // [esp+1Ch] [ebp-6Ch]
  float v21; // [esp+20h] [ebp-68h] BYREF
  float v22; // [esp+24h] [ebp-64h]
  float v23; // [esp+28h] [ebp-60h]
  float v24; // [esp+2Ch] [ebp-5Ch]
  float v25; // [esp+30h] [ebp-58h]
  float v26; // [esp+34h] [ebp-54h]
  float v27; // [esp+38h] [ebp-50h]
  float v28; // [esp+3Ch] [ebp-4Ch]
  float v29; // [esp+40h] [ebp-48h]
  float v30; // [esp+44h] [ebp-44h]
  float v31; // [esp+48h] [ebp-40h]
  float v32; // [esp+4Ch] [ebp-3Ch]
  float *v33; // [esp+50h] [ebp-38h]
  int *v34; // [esp+54h] [ebp-34h]
  T_Gizmo *v35; // [esp+58h] [ebp-30h]
  int v36; // [esp+5Ch] [ebp-2Ch]
  int v37; // [esp+60h] [ebp-28h]
  float v38; // [esp+64h] [ebp-24h]
  float *v39; // [esp+68h] [ebp-20h]
  int v40; // [esp+6Ch] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  v3 = *(_BYTE *)(v2 + 0xAB);
  v4 = v2 + 0xAB;
  if ( v3 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x1AC);
  }
  v5 = *(_DWORD *)(v4 + 1);
  if ( *(_BYTE *)(v5 + 0x67) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x1B0);
  }
  v37 = 0;
  v6 = **(char **)(v5 + 0x63);
  v35 = &V_Gizmos[v6];
  v7.pPlanet = *(P_Planet *)(v5 + 0x68);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    v8 = *(_DWORD *)(a1 + 0x1D2A);
    *(_WORD *)(a1 + 0x5034) = 2;
    *(_DWORD *)(a1 + 0x4F44) = v8 + 0x35;
    *(_BYTE *)(v8 + 0x35) = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = *(float *)(v5 + 0x9E);
    *(float *)(a1 + 0x4F84) = *(float *)(v5 + 0xA2);
    *(float *)(a1 + 0x4F88) = *(float *)(v5 + 0xA6);
    v36 = a1 + 4 * v6;
    sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F44), *(_WORD *)(v36 + 0x1A92), 0);
    v9 = sub_12AE4((P_Wnd04BM)a1, v7);
    *(_DWORD *)(a1 + 0x4F48) = v9;
    v9->Unknown_33 |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(float *)(a1 + 0x4F8C) = *(float *)((char *)&v7.pPlanet[1].Unknown_22 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v7.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v7.pPlanet[1].name[7];
    v39 = &v18;
    v30 = 0.0;
    v31 = 0.0;
    v32 = 0.0;
    v30 = *(float *)(a1 + 0x4F8C) - *(float *)(a1 + 0x4F80);
    v31 = *(float *)(a1 + 0x4F90) - *(float *)(a1 + 0x4F84);
    v10 = *(float *)(a1 + 0x4F94) - *(float *)(a1 + 0x4F88);
    v18 = v30;
    v32 = v10;
    v19 = v31;
    v20 = v32;
    *(float *)(a1 + 0x4F98) = v30;
    *(float *)(a1 + 0x4F9C) = v19;
    *(float *)(a1 + 0x4FA0) = v20;
    v40 = 0x20 * v35->special1;
    v16 = (float)v40;
    Q_Vector3D_SetLength_sub_53054((P_Vector3D)(a1 + 0x4F98), v16);
    v24 = 0.0;
    v25 = 0.0;
    v26 = 0.0;
    v33 = &v21;
    v24 = *(float *)(a1 + 0x4F8C) + *(float *)(a1 + 0x4F98);
    v25 = *(float *)(a1 + 0x4F90) + *(float *)(a1 + 0x4F9C);
    v11 = *(float *)(a1 + 0x4F94) + *(float *)(a1 + 0x4FA0);
    v21 = v24;
    v26 = v11;
    v22 = v25;
    v23 = v26;
    *(float *)(a1 + 0x4F98) = v24;
    *(float *)(a1 + 0x4F9C) = v22;
    *(float *)(a1 + 0x4FA0) = v23;
    v12 = v36;
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(v12 + 0x1BCE));
  }
  v13 = (float *)(a1 + 0x4F8C);
  if ( *(_DWORD *)(a1 + 0x4F3C) )
  {
    v34 = v17;
    v27 = 0.0;
    v28 = 0.0;
    v29 = 0.0;
    v27 = *(float *)(a1 + 0x4F98) - *v13;
    v28 = *(float *)(a1 + 0x4F9C) - *(float *)(a1 + 0x4F90);
    v29 = *(float *)(a1 + 0x4FA0) - *(float *)(a1 + 0x4F94);
    *(float *)v17 = v27;
    *(float *)&v17[1] = v28;
    *(float *)&v17[2] = v29;
    v14 = sqrt(v28 * v28 + v27 * v27 + v29 * v29) * 0.050000001;
    v38 = v14;
    if ( v14 >= 3.2 )
    {
      if ( v38 > 50.0 )
      {
        v38 = 50.0;
      }
    }
    else
    {
      v38 = 3.2;
    }
    if ( sub_12480((float *)(a1 + 0x4F8C), (float *)(a1 + 0x4F98), v38) == 0xFFFFFFFF )
    {
      return 0xFFFFFFFF;
    }
  }
  else
  {
    sub_12618(*(T_BatDisplayItem **)(a1 + 0x4F44));
    if ( sub_12480((float *)(a1 + 0x4F80), v13, 50.0) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 8u;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
    }
  }
  return v37;
}

//----- (00014B18) --------------------------------------------------------
unsigned int __fastcall sub_14B18(int a1, int a2, int a3)
{
  int v4; // ecx
  P_TargetObject v5; // ecx
  P_TargetObject v6; // ebp
  int ShipsAtLocation_sub_1D794; // edi
  _BYTE *v8; // eax
  char v9; // bl
  int i; // kr04_4
  _BYTE *v11; // edx
  P_BatDisplayItem v12; // eax
  char *v13; // ecx
  float *v14; // edx
  char v15; // bh
  int v16; // eax
  float *v17; // edx
  int v18; // ebp
  int v19; // eax
  int v21; // edi
  int v22; // edx
  int v23; // edx
  double v24; // st7
  int v25; // ecx
  int j; // kr10_4
  float v27; // [esp+4h] [ebp-228h]
  void *v28[107]; // [esp+8h] [ebp-224h] BYREF
  T_Vector3D v29; // [esp+1B4h] [ebp-78h] BYREF
  float v30; // [esp+1C0h] [ebp-6Ch]
  float v31; // [esp+1C4h] [ebp-68h]
  float v32; // [esp+1C8h] [ebp-64h]
  T_Vector3D v33; // [esp+1CCh] [ebp-60h] BYREF
  float v34; // [esp+1D8h] [ebp-54h] BYREF
  float v35; // [esp+1DCh] [ebp-50h]
  float v36; // [esp+1E0h] [ebp-4Ch]
  float v37; // [esp+1E4h] [ebp-48h]
  float v38; // [esp+1E8h] [ebp-44h]
  float v39; // [esp+1ECh] [ebp-40h]
  int v40; // [esp+1F0h] [ebp-3Ch]
  T_Vector3D *v41; // [esp+1F4h] [ebp-38h]
  float special1; // [esp+1F8h] [ebp-34h]
  float *v43; // [esp+1FCh] [ebp-30h]
  int v44; // [esp+200h] [ebp-2Ch]
  int v45; // [esp+204h] [ebp-28h]
  int v46; // [esp+208h] [ebp-24h]
  float v47; // [esp+20Ch] [ebp-20h]
  char v48; // [esp+210h] [ebp-1Ch]

  v4 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v4 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x1F9);
  }
  v44 = 0;
  v5.pPlanet = *(P_Planet *)(v4 + 1);
  v6.pPlanet = v5.pPlanet;
  v48 = **(_BYTE **)((char *)&v5.pPlanet->invincible + 1);
  if ( v48 == 0x28 )
  {
    if ( LOBYTE(v5.pPlanet->dayColonized) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x201);
    }
    v6.pPlanet = *(P_Planet *)((char *)&v5.pPlanet->dayColonized + 1);
  }
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(*(P_Location *)&v5.pPlanet->byte59, (P_Ship *)v28);
    *(_WORD *)(a1 + 0x5034) = 2;
    *(_DWORD *)(a1 + 0x4F44) = sub_12AE4((P_Wnd04BM)a1, v6);
    v8 = (_BYTE *)(*(_DWORD *)(a1 + 0x1D2A) + 0x35);
    *(_DWORD *)(a1 + 0x4F48) = v8;
    v9 = v48;
    *v8 = 0xFF;
    if ( v9 == 0x28 )
    {
      **(_BYTE **)(a1 + 0x4F48) = 7;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) = 0x12;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
      *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v5.pPlanet[1].Unknown_22 + 1);
      *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v5.pPlanet[1].name[3];
      *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v5.pPlanet[1].name[7];
      sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F48), *(_WORD *)(a1 + 4 * v48 + 0x1A92), 0);
    }
    if ( ShipsAtLocation_sub_1D794 > 0 )
    {
      v40 = a1 + 0x4F80;
      v46 = 4 * ShipsAtLocation_sub_1D794;
      for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
      {
        if ( *(__int16 *)(a1 + 0x5034) >= 0xF )
        {
          break;
        }
        v11 = v28[i];
        if ( v11[0x58] == 4 && v11 != (_BYTE *)v6.pPlanet )
        {
          v12 = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)v11);
          v12->Unknown_33 |= 0x12u;
          v12->Unknown_34 = *(_BYTE *)(a1 + 0x5034);
          v13 = (char *)v28[i];
          v14 = (float *)(a1 + 0x4F80 + 0xC * v12->Unknown_34);
          *v14 = *(float *)(v13 + 0x9E);
          v14[1] = *(float *)(v13 + 0xA2);
          v14[2] = *(float *)(v13 + 0xA6);
          LOWORD(v14) = *(_WORD *)(a1 + 0x5034);
          *(_WORD *)(a1 + 0x5034) = (_WORD)v14 + 1;
          *(_DWORD *)(a1 + 4 * (__int16)v14 + 0x4F44) = v12;
        }
      }
    }
    v15 = v48;
    *(_DWORD *)(a1 + 0x4F3C) = 1;
    if ( v15 == 0x28 )
    {
      *(_DWORD *)(a1 + 0x4F3C) = 0;
    }
    v16 = v48;
    *(_DWORD *)(a1 + 0x4F40) = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 4 * v16 + 0x1BCE));
    dword_9A238 = 0;
  }
  v17 = (float *)((char *)&v6.pPlanet[1].Unknown_22 + 1);
  v18 = *(_DWORD *)(a1 + 0x4F3C);
  if ( v18 )
  {
    if ( v18 == 1 )
    {
      v19 = *(_DWORD *)(a1 + 0x4F44);
      *(_DWORD *)(a1 + 0x4F40) += *(_DWORD *)(a1 + 0x4F38) & 1;
      *(_BYTE *)(v19 + 0x33) |= 4u;
      if ( *(_DWORD *)(a1 + 0x4F40) == 9 )
      {
        *(_DWORD *)(a1 + 0x4F3C) = 2;
        return v44;
      }
    }
    else if ( v18 == 2 )
    {
      v37 = *v17;
      v38 = v17[1];
      v39 = v17[2];
      v21 = a1 + 0x4F80;
      special1 = (float)V_Gizmos[v48].special1;
      v45 = 0xFFFFFFFF;
      *(float *)&dword_9A238 = *(float *)&dword_9A238 + 0.2;
      for ( j = 0; j + 2 < *(__int16 *)(a1 + 0x5034); ++j )
      {
        v23 = *(char *)(*(_DWORD *)(a1 + 8 + 4 * j + 0x4F44) + 0x34);
        v41 = &v33;
        memset(&v29, 0, sizeof(v29));
        v29.x = *(float *)(v21 + 0xC * v23) - v37;
        v29.y = *(float *)(v21 + 0xC * v23 + 4) - v38;
        v29.z = *(float *)(v21 + 0xC * v23 + 8) - v39;
        v33 = v29;
        v24 = sqrt(v29.y * v29.y + v29.x * v29.x + v29.z * v29.z) * 0.03125 + 0.2;
        v47 = v24;
        if ( v24 < special1 )
        {
          v45 = 0;
        }
        else
        {
          v47 = special1;
        }
        v22 = 0xC * v23;
        v27 = v47 * 32.0;
        Q_Vector3D_SetLength_sub_53054(&v33, v27);
        v43 = &v34;
        v30 = v37 + v33.x;
        v34 = v30;
        v31 = v38 + v33.y;
        v35 = v31;
        v32 = v39 + v33.z;
        v36 = v32;
        *(float *)(v22 + v21) = v30;
        *(float *)(v22 + v21 + 4) = v35;
        *(float *)(v22 + v21 + 8) = v36;
      }
      if ( *(float *)&dword_9A238 >= (double)special1 || v45 == 0xFFFFFFFF )
      {
        *(_DWORD *)(a1 + 0x4F3C) = 3;
        return v44;
      }
    }
    else
    {
      v25 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
      *(_DWORD *)(a1 + 0x4F40) = v25;
      if ( v25 == 0x12 )
      {
        return 0xFFFFFFFF;
      }
    }
  }
  else
  {
    sub_12618(*(T_BatDisplayItem **)(a1 + 0x4F48));
    if ( sub_12480((float *)(a1 + 0x4F8C), v17, 10.0) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 8u;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
    }
  }
  return v44;
}
// 9A238: using guessed type int dword_9A238;
// 14B18: using guessed type P_Ship var_224[107];

//----- (00015078) --------------------------------------------------------
unsigned int __fastcall sub_15078(T_Wnd04BM *a1)
{
  P_Wnd19BC pWnd19BC; // edi
  int v3; // esi
  BYTE type; // ah
  T_Target *p_target; // edi
  P_TargetObject v6; // edx
  char v7; // bl
  P_BatDisplayItem v8; // eax

  pWnd19BC = a1->pWnd19BC;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x283);
  }
  v3 = 0;
  v6.pPlanet = (P_Planet)p_target->pObject;
  v7 = **(_BYTE **)((char *)&v6.pPlanet->invincible + 1);
  if ( !a1->Unknown_4F38[0] )
  {
    a1->Unknown_5034 = 1;
    v8 = sub_12AE4(a1, v6);
    a1->Unknown_4F44 = v8;
    v8->Unknown_33 |= 4u;
    a1->Unknown_4F38[1] = 0;
    a1->Unknown_4F38[2] = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, a1->gvSfx[v7].sfx1);
  }
  if ( a1->Unknown_4F38[1] )
  {
    *(float *)((char *)a1->Unknown_4F44 + 0xB) = *(float *)((char *)a1->Unknown_4F44 + 0xB) + -0.039999999;
    if ( *(float *)((char *)a1->Unknown_4F44 + 0xB) < 0.04 )
    {
      return 0xFFFFFFFF;
    }
  }
  else
  {
    a1->Unknown_4F38[2] += (a1->Unknown_4F38[0] & 3) == 0;
    if ( a1->Unknown_4F38[2] == 9 )
    {
      a1->Unknown_4F38[1] = 1;
    }
  }
  return v3;
}

//----- (00015164) --------------------------------------------------------
unsigned int __fastcall sub_15164(int a1)
{
  int v2; // ecx
  unsigned int v3; // edi
  P_TargetObject v4; // ebx
  P_BatDisplayItem v5; // eax
  _BYTE *v6; // eax
  int v7; // ebp
  int v8; // edx

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x2B5);
  }
  v3 = 0;
  v4.pPlanet = *(P_Planet *)(v2 + 0xAC);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v5 = sub_12AE4((P_Wnd04BM)a1, v4);
    *(_DWORD *)(a1 + 0x4F44) = v5;
    v5->Unknown_33 |= 4u;
    v6 = (_BYTE *)(*(_DWORD *)(a1 + 0x1D2A) + 0x35);
    *(_DWORD *)(a1 + 0x4F48) = v6;
    *v6 = 0xFF;
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F40) = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 0x1CEE));
  }
  v7 = *(_DWORD *)(a1 + 0x4F3C);
  if ( v7 )
  {
    if ( v7 == 1 )
    {
      if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618(*(T_BatDisplayItem **)(a1 + 0x4F48)) == 0xFFFFFFFF )
      {
        v3 = 0xFFFFFFFF;
      }
      *(_DWORD *)(*(_DWORD *)(a1 + 0x4F48) + 0xB) = 0x40A00000;
    }
  }
  else
  {
    v8 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
    *(_DWORD *)(a1 + 0x4F40) = v8;
    if ( v8 == 9 )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 8u;
      **(_BYTE **)(a1 + 0x4F48) = 7;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 0x10u;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
      *(float *)(a1 + 0x4F8C) = *(float *)((char *)&v4.pPlanet[1].Unknown_22 + 1);
      *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v4.pPlanet[1].name[3];
      *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v4.pPlanet[1].name[7];
      sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F48), *(_WORD *)(a1 + 0x1BB2), 0);
      *(_DWORD *)(*(_DWORD *)(a1 + 0x4F48) + 0xB) = 0x40A00000;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
      return 0;
    }
  }
  return v3;
}

//----- (000152E4) --------------------------------------------------------
unsigned int __fastcall sub_152E4(int a1, int a2, int a3, int a4)
{
  int v5; // esi
  int v6; // ebx
  _BYTE *v7; // eax
  int v8; // edx
  int ShipsAtLocation_sub_1D794; // eax
  int v10; // esi
  int v11; // kr04_4
  int v12; // kr00_4
  int v13; // ebp
  int v14; // edx
  int v15; // ebx
  int v16; // ebx
  T_BatDisplayItem *v17; // eax
  int v19; // eax
  unsigned __int16 v20; // si
  char v21; // al
  int v22; // eax
  void *v23[107]; // [esp+0h] [ebp-1DCh] BYREF
  T_Gizmo *v24; // [esp+1ACh] [ebp-30h]
  int v25; // [esp+1B0h] [ebp-2Ch]
  int v26; // [esp+1B4h] [ebp-28h]
  int v27; // [esp+1B8h] [ebp-24h]
  int v28; // [esp+1BCh] [ebp-20h]
  char v29; // [esp+1C0h] [ebp-1Ch]

  v5 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v5 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x2FA);
  }
  v25 = 0;
  v26 = *(_DWORD *)(v5 + 0xAC);
  v6 = *(_DWORD *)(a1 + 0x4F38);
  v29 = 0x26;
  v24 = &V_Gizmos[0x26];
  if ( !v6 )
  {
    *(_WORD *)(a1 + 0x5034) = 1;
    v7 = *(_BYTE **)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F44) = v7;
    *v7 = 0xFF;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 0x12u;
    v8 = v26 + 0x9E;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)v8;
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)(v8 + 4);
    *(float *)(a1 + 0x4F88) = *(float *)(v8 + 8);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, *(_WORD *)(a1 + 0x1C66));
  }
  if ( **(_BYTE **)(a1 + 0x4F44) == 0xFF )
  {
    ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(*(P_Location *)(v26 + 0x59), (P_Ship *)v23);
    v10 = (unsigned __int8)*(_DWORD *)(a1 + 0x4F3C);
    if ( v10 < ShipsAtLocation_sub_1D794 )
    {
      v12 = 4 * v10;
      v13 = *(__int16 *)(v26 + 0x56);
      v27 = 4 * ShipsAtLocation_sub_1D794;
      v11 = 0;
      while ( 1 )
      {
        v14 = *(int *)((char *)&v23[v11] + v12);
        v15 = *(__int16 *)(v14 + 0x56);
        if ( *(_BYTE *)(v14 + 0x58) == 4 && v13 != v15 && V_Game.races[v13].treaties[v15] == 2 )
        {
          break;
        }
        ++v11;
        if ( v12 + 4 * v11 >= 4 * ShipsAtLocation_sub_1D794 )
        {
          goto LABEL_15;
        }
      }
      *(_WORD *)(a1 + 0x5034) = 2;
      v16 = *(int *)((char *)&v23[v11] + v12);
      *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)(v16 + 0x9E);
      *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)(v16 + 0xA2);
      *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)(v16 + 0xA6);
      **(_BYTE **)(a1 + 0x4F44) = 7;
      *(_DWORD *)(a1 + 0x4F48) = sub_12AE4((P_Wnd04BM)a1, *(P_TargetObject *)((char *)&v23[v11] + v12));
      sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F44), *(_WORD *)(a1 + 4 * v29 + 0x1A92), 0);
      *(_DWORD *)(a1 + 0x4F3C) = v10 + v11 + 1;
    }
LABEL_15:
    if ( **(_BYTE **)(a1 + 0x4F44) == 0xFF )
    {
      v25 = 0xFFFFFFFF;
    }
  }
  v17 = *(T_BatDisplayItem **)(a1 + 0x4F44);
  if ( v17->target.type == (BYTE)0xFF )
  {
    return 0xFFFFFFFF;
  }
  if ( (*(_BYTE *)(a1 + 0x4F3D) & 1) != 0 )
  {
    if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618(v17) == 0xFFFFFFFF )
    {
      **(_BYTE **)(a1 + 0x4F44) = 0xFF;
      *(_DWORD *)(a1 + 0x4F3C) = (unsigned __int8)*(_DWORD *)(a1 + 0x4F3C);
      return v25;
    }
  }
  else
  {
    sub_12618(v17);
    if ( sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), 50.0) == 0xFFFFFFFF )
    {
      v19 = *(_DWORD *)(a1 + 0x4F48);
      LOWORD(v28) = 1;
      v20 = 4;
      v21 = Q_Ship_ApplyDamage_sub_4B7A0(*(P_Ship *)(v19 + 1), 0, v24->special1, *(_WORD *)(v26 + 0x56));
      if ( (v21 & 4) != 0 )
      {
        v22 = *(_DWORD *)(a1 + 0x4F48);
        LOWORD(v28) = 5;
        v20 = 5;
        *(_BYTE *)(v22 + 0x33) |= 8u;
      }
      else if ( (v21 & 2) != 0 )
      {
        v20 = *(_WORD *)(a1 + 4 * v29 + 0x1A94);
        LOWORD(v28) = *(_WORD *)(a1 + 4 * v29 + 0x1BD0);
      }
      sub_1826C((P_Wnd04BM)a1, *(P_BatDisplayItem *)(a1 + 0x4F44), v20, 0);
      Q_SSystem_StartSample_sub_4FB90(&V_SSystem, v28);
      *(_BYTE *)(a1 + 0x4F3D) |= 1u;
    }
  }
  return v25;
}
// 152E4: using guessed type P_Ship var_1DC[107];

//----- (00015630) --------------------------------------------------------
void __fastcall sub_15630(P_Wnd04BM a1, P_BatDisplayItem a2)
{
  int v3; // eax
  void *ShapeTable_sub_1B084; // eax
  int shapeNumber; // [esp-20h] [ebp-30h]
  LONG Unknown_27; // [esp-1Ch] [ebp-2Ch]
  LONG Unknown_29; // [esp-18h] [ebp-28h]
  int scale; // [esp-8h] [ebp-18h]

  v3 = a1->Unknown_4F38[2];
  if ( v3 > 9 )
  {
    v3 = 0x12 - v3;
  }
  if ( v3 >= 0 )
  {
    if ( v3 > 9 )
    {
      v3 = 9;
    }
  }
  else
  {
    v3 = 0;
  }
  VFX_shape_lookaside((*V_GSystem.hazeTables)[v3 + 0xB]);
  scale = a2->_scale;
  Unknown_29 = a2->Unknown_29;
  Unknown_27 = a2->Unknown_27;
  shapeNumber = a2->shapeNumber;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a2->shapeCacheIndex);
  VFX_shape_transform(&a1->a2.pane, ShapeTable_sub_1B084, shapeNumber, Unknown_27, Unknown_29, V_BigBuffer, 0, scale, scale, 1);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (000156C0) --------------------------------------------------------
void __fastcall sub_156C0(P_BatDisplayItem a1, int a2, unsigned __int16 shpNum)
{
  void *ShapeTable_sub_1B084; // ebp
  RECT rect; // [esp+0h] [ebp-24h] BYREF
  int v6; // [esp+10h] [ebp-14h]

  v6 = a2;
  a1->Unknown_B = 0x3F800000;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v6);
  if ( shpNum >= VFX_shape_count(ShapeTable_sub_1B084) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x38);
  }
  VFX_shape_visible_rectangle(ShapeTable_sub_1B084, shpNum, 0, 0, 0, &rect);
  if ( rect.x0 > 1000000 || rect.x0 < -1000000 )
  {
    memset(&rect, 0, sizeof(rect));
  }
  a1->x0 = rect.x0;
  a1->y0 = rect.y0;
  a1->x1 = rect.x1;
  a1->y1 = rect.y1;
  a1->shapeCacheIndex = v6;
  a1->shapeNumber = shpNum;
}

//----- (0001577C) --------------------------------------------------------
void __fastcall __spoils<> sub_1577C(T_Wnd04BMt3 *a1)
{
  sub_15788(a1);
}

//----- (00015788) --------------------------------------------------------
void __fastcall __spoils<> sub_15788(T_Wnd04BMt3 *result)
{
  result->num = 0;
}

//----- (00015794) --------------------------------------------------------
int __fastcall sub_15794(int result, int a2)
{
  int v2; // ebx

  v2 = *(_DWORD *)(result + 0x800);
  if ( v2 < 0x200 )
  {
    if ( a2 )
    {
      *(_DWORD *)(result + 4 * v2) = a2;
      ++*(_DWORD *)(result + 0x800);
    }
  }
  return result;
}

//----- (000157B4) --------------------------------------------------------
int __fastcall sub_157B4(P_Target a1, P_Target a2)
{
  int v2; // edx
  float v4; // [esp+0h] [ebp-8h]
  float v5; // [esp+4h] [ebp-4h]

  v5 = *(float *)(*(_DWORD *)&a1->type + 0x2F);
  v4 = *(float *)(*(_DWORD *)&a2->type + 0x2F);
  v2 = 0;
  if ( v5 > (double)v4 )
  {
    return 0xFFFFFFFF;
  }
  if ( v5 < (double)v4 )
  {
    return 1;
  }
  return v2;
}

//----- (000157EC) --------------------------------------------------------
void __fastcall sub_157EC(P_Wnd04BMt3 a1)
{
  qsort(a1, a1->num, 4u, (int (__fastcall *)(const void *, const void *))sub_157B4);
}

//----- (00015808) --------------------------------------------------------
P_Target __fastcall sub_15808(P_Wnd04BMt3 a1, int a2, int a3)
{
  int v3; // edi
  P_Target *v4; // esi
  P_Target v5; // ecx
  float v7; // [esp+Ch] [ebp-24h]
  float v8; // [esp+10h] [ebp-20h]
  float v9; // [esp+18h] [ebp-18h]
  float v10; // [esp+1Ch] [ebp-14h]
  float pPlanet_low; // [esp+20h] [ebp-10h]

  v3 = a1->num - 1;
  v4 = &a1->_targets[v3];
  while ( (v3 & 0x8000u) == 0 )
  {
    if ( !v4 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x9E);
    }
    v5 = *v4;
    if ( (*v4)->type >= 9 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0xA2);
    }
    if ( v5->type == 5 )
    {
      if ( (*(__int16 *)((char *)&v5[7].pObject.pStar + 3) - a2) * (*(__int16 *)((char *)&v5[7].pObject.pStar + 3) - a2)
         + (SLOWORD(v5[8].pObject.pPlanet) - a3) * (SLOWORD(v5[8].pObject.pPlanet) - a3) < 0x50 )
      {
        return *v4;
      }
    }
    else if ( v5->type != 4 )
    {
      v8 = (double)*(unsigned int *)&v5[3].type * 0.000015258789;
      v7 = (float)*(__int16 *)((char *)&v5[7].pObject.pStar + 3);
      v9 = (float)a2;
      if ( (double)*(__int16 *)((char *)&v5[3].pObject.pStar + 3) * v8 + v7 <= v9 )
      {
        pPlanet_low = (float)SLOWORD(v5[8].pObject.pPlanet);
        v10 = (float)a3;
        if ( (double)SLOWORD(v5[4].pObject.pPlanet) * v8 + pPlanet_low <= v10
          && (double)SHIWORD(v5[4].pObject.pShip) * v8 + v7 >= v9
          && (double)*(__int16 *)&v5[5].type * v8 + pPlanet_low >= v10 )
        {
          return *v4;
        }
      }
    }
    LOWORD(v3) = v3 - 1;
    v4 += 0xFFFFFFFF;
  }
  return 0;
}

//----- (00015948) --------------------------------------------------------
int __fastcall sub_15948(P_Wnd04BMt3 a1, P_Wnd04BM a2)
{
  P_Wnd04BMt3 v2; // kr00_4
  PANE *p_pane; // ebp
  int v4; // kr04_4
  unsigned int v5; // eax
  LONG v6; // eax
  unsigned __int16 shapeCacheIndex; // dx
  P_TargetObject v8; // edi
  __int64 v9; // rax
  double v10; // st7
  void *ShapeTable_sub_1B084; // eax
  int result; // eax
  P_BatDisplayItem v13; // esi
  int shapeNumber; // [esp-20h] [ebp-88h]
  LONG Unknown_27; // [esp-1Ch] [ebp-84h]
  LONG Unknown_29; // [esp-18h] [ebp-80h]
  int scale; // [esp-8h] [ebp-70h]
  int v18; // [esp-4h] [ebp-6Ch]
  int v20; // [esp+Ch] [ebp-5Ch]
  int v21; // [esp+18h] [ebp-50h]
  float v23; // [esp+20h] [ebp-48h]
  int v24; // [esp+24h] [ebp-44h]
  int v25; // [esp+30h] [ebp-38h]
  __int16 i; // [esp+40h] [ebp-28h]

  v2 = a1;
  p_pane = &a2->a2.pane;
  v4 = 0;
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= a1->num )
    {
      break;
    }
    v13 = (P_BatDisplayItem)v2->_targets[v4];
    if ( (v13->target.type != 4 || a2->Unknown_504A) && v13->target.type != (BYTE)0xFF )
    {
      if ( v13->Unknown_23 && (a2->Unknown_5042 || v13->target.type == 6) && (v13->Unknown_33 & 2) == 0 )
      {
        v5 = 0xFFFFFFFF;
      }
      else
      {
        v5 = 0;
      }
      if ( v5 )
      {
        v6 = 0x72;
        if ( v13->Unknown_1F )
        {
          v6 = 0x90;
        }
        if ( v13->target.type == 6 && a2->Unknown_B7 == 3 )
        {
          v6 = 0xF3;
        }
        VFX_line_draw(p_pane, v13->Unknown_2B, v13->Unknown_2D, v13->Unknown_27, v13->Unknown_29, 0, v6);
      }
      if ( (v13->Unknown_33 & 8) == 0 )
      {
        if ( (v13->Unknown_33 & 4) != 0 )
        {
          sub_139E0(a2, v13);
        }
        else
        {
          shapeCacheIndex = v13->shapeCacheIndex;
          if ( shapeCacheIndex != 0xFFFF )
          {
            if ( v13->target.type == 8 )
            {
              v25 = v13->Unknown_33 & 4;
              v8.pPlanet = (P_Planet)v13->target.pObject;
              v24 = v25;
              v9 = v13->Unknown_27 - *(__int16 *)&v8.pPlanet->name[3];
              v20 = (HIDWORD(v9) ^ v9) - HIDWORD(v9);
              if ( v20 )
              {
                v10 = 2.5 / (double)(2 * v20);
                v25 = (int)((double)v20 * v10 + 0.5);
                v24 = (int)(v10 * (double)v20 + 0.5);
              }
              VFX_line_draw(
                p_pane,
                v25 + v13->Unknown_27,
                v24 + v13->Unknown_29,
                v25 + *(__int16 *)&v8.pPlanet->name[3],
                v24 + *(__int16 *)&v8.pPlanet->name[5],
                0,
                0x6A);
              VFX_line_draw(
                p_pane,
                v13->Unknown_27 - v25,
                v13->Unknown_29 - v24,
                *(__int16 *)&v8.pPlanet->name[3] - v25,
                *(__int16 *)&v8.pPlanet->name[5] - v24,
                0,
                0x6A);
              VFX_line_draw(
                p_pane,
                v13->Unknown_27,
                v13->Unknown_29,
                *(__int16 *)&v8.pPlanet->name[3],
                *(__int16 *)&v8.pPlanet->name[5],
                0,
                0x6D);
            }
            else
            {
              v18 = v13->Unknown_33 & 4;
              scale = v13->_scale;
              Unknown_29 = v13->Unknown_29;
              Unknown_27 = v13->Unknown_27;
              shapeNumber = v13->shapeNumber;
              ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, shapeCacheIndex);
              VFX_shape_transform(p_pane, ShapeTable_sub_1B084, shapeNumber, Unknown_27, Unknown_29, V_BigBuffer, v18, scale, scale, v18);
            }
          }
        }
      }
      v23 = (double)(unsigned int)v13->_scale * 0.000015258789;
      if ( v13->target.type == 1 && Q_Planet_HasOrbitalDefense_sub_361B8(v13->target.pObject.pPlanet) == 0xFFFFFFFF )
      {
        v21 = (int)((double)v13->x1 * v23 + 2.0);
        VFX_ellipse_draw(
          p_pane,
          v13->Unknown_27,
          v13->Unknown_29,
          (__int16)v21,
          (__int16)v21,
          4 * V_Game.races[v13->target.pObject.pPlanet->raceIndex].colorSet + 0x13);
      }
      if ( v13 == (P_BatDisplayItem)a2->pTarget2 )
      {
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(
          p_pane,
          (__int16)(int)((double)v13->x0 * v23 + (double)v13->Unknown_27),
          (__int16)(int)((double)v13->y0 * v23 + (double)v13->Unknown_29),
          (__int16)(int)((double)v13->Unknown_27 + (double)v13->x1 * v23),
          (__int16)(int)(v23 * (double)v13->y1 + (double)v13->Unknown_29),
          0xF3u,
          0);
      }
    }
    ++v4;
  }
  return result;
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00015D20) --------------------------------------------------------
void __fastcall __spoils<> sub_15D20(T_Wnd04BMt1 *a1)
{
  sub_15D2C(a1);
}

//----- (00015D2C) --------------------------------------------------------
void __fastcall __spoils<> sub_15D2C(T_Wnd04BMt1 *result)
{
  result->num = 0;
}

//----- (00015D38) --------------------------------------------------------
int __fastcall sub_15D38(int result, const void *a2)
{
  int v2; // ebx
  int v4; // edx

  v2 = result;
  v4 = *(_DWORD *)(result + 0x1900);
  if ( v4 < 0x40 )
  {
    result = 0x64 * v4;
    qmemcpy((void *)(v2 + 0x64 * v4), a2, 0x64u);
    ++*(_DWORD *)(v2 + 0x1900);
  }
  return result;
}

//----- (00015D74) --------------------------------------------------------
void __fastcall sub_15D74(P_Wnd04BMt1 a1, P_Wnd04BM a2)
{
  int i; // ecx

  for ( i = 0; i < a1->num; ++i )
  {
    sub_15DA4(a1, a2, i);
  }
}

//----- (00015DA4) --------------------------------------------------------
void __fastcall sub_15DA4(P_Wnd04BMt1 a1, P_Wnd04BM a2, unsigned __int16 a3)
{
  SCRNVERTEX *vertices; // edx
  int x; // ecx
  int v6; // eax

  if ( a3 < a1->num )
  {
    vertices = a1->a[a3].vertices;
    x = vertices[4].x;
    if ( x < 0 || x >= 7 )
    {
      v6 = 0;
    }
    else
    {
      v6 = V_Game.races[x].colorSet + 1;
    }
    VFX_translate_polygon(&a2->a2.pane, 4, vertices, a2->pBatHazes[v6 + 0x1F]);
  }
}

//----- (00015E1C) --------------------------------------------------------
void __fastcall sub_15E1C(P_Wnd04BMt1 a1, P_Wnd04BM pWnd4BM)
{
  int raceIndex; // eax
  int j; // edi
  int i; // [esp+4h] [ebp-20h]
  int solidColor; // [esp+Ch] [ebp-18h]

  for ( i = 0; i < a1->num; ++i )
  {
    raceIndex = a1->a[i].raceIndex;
    if ( raceIndex < 0 || raceIndex >= 7 )
    {
      solidColor = 0x6D;
    }
    else
    {
      solidColor = 4 * V_Game.races[raceIndex].colorSet + 0x13;
    }
    for ( j = 0; j < 4; ++j )
    {
      VFX_line_draw(
        &pWnd4BM->a2.pane,
        a1->a[i].vertices[j].x,
        a1->a[i].vertices[j].y,
        a1->a[i].vertices[j & 3].x,
        a1->a[i].vertices[j & 3].y,
        LD_DRAW,
        solidColor);
    }
  }
}

//----- (00015ED4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd04BM_Ctor_sub_15ED4(P_Wnd04BM a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a2);
  _wcpp_2_ctor_array_(a1->vectors1, 100u, &C_Vector3D);
  _wcpp_2_ctor_array_(a1->someFloats, 100u, &C_Type16);
  _wcpp_2_ctor_array_(a1->vectors2, 100u, &C_Vector3D);
  a1->Unknown_1D0A = 0;
  a1->Unknown_1D0E = 0.0;
  a1->Unknown_1D12[0] = 0;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  a1->targetPosition.x = 0.0;
  sub_1577C(&a1->Unknown_1D36);
  sub_1577C(&a1->Unknown_253A);
  sub_1577C(&a1->Unknown_2D3E);
  sub_15D20(&a1->Unknown_3542);
  Q_Camera_ResetToIdentity_sub_1B4F0(&a1->camera);
  a1->vector_4EDE.x = 0.0;
  a1->vector_4EDE.y = 0.0;
  a1->vector_4EDE.z = 0.0;
  a1->matrix_4EEA.vector1.x = 0.0;
  a1->matrix_4EEA.vector1.y = 0.0;
  a1->matrix_4EEA.vector1.z = 0.0;
  a1->matrix_4EEA.vector2.x = 0.0;
  a1->matrix_4EEA.vector2.y = 0.0;
  a1->matrix_4EEA.vector2.z = 0.0;
  a1->matrix_4EEA.vector3.x = 0.0;
  a1->matrix_4EEA.vector3.y = 0.0;
  a1->matrix_4EEA.vector3.z = 0.0;
  a1->matrix_4EEA.vector1.y = 0.0;
  a1->matrix_4EEA.vector1.z = 0.0;
  a1->matrix_4EEA.vector1.x = 1.0;
  a1->matrix_4EEA.vector2.x = 0.0;
  a1->matrix_4EEA.vector2.y = 1.0;
  a1->matrix_4EEA.vector2.z = 0.0;
  a1->matrix_4EEA.vector3.x = 0.0;
  a1->matrix_4EEA.vector3.y = 0.0;
  a1->matrix_4EEA.vector3.z = 1.0;
  _wcpp_2_ctor_array_(a1->vectors3, 15u, &C_Vector3D);
  a1->a2.pProcs = &Wnd04BM_Procs;
  Q_Wnd04BM_LoadBatfxTxt_sub_16120(a1);
}

//----- (0001604C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd04BM_Dtor_sub_1604C(P_Wnd04BM self, unsigned int a2)
{
  char v3; // cl
  char *v4; // eax
  T_HazeTable *pBatHazes; // edx

  v3 = a2;
  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(self, &C_Wnd04BM);
    operator delete[](v4);
  }
  else
  {
    pBatHazes = self->pBatHazes;
    self->a2.pProcs = &Wnd04BM_Procs;
    if ( pBatHazes )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(pBatHazes);
    }
    operator delete[](self->pBatHazes);
    sub_1A9C0(self->vectors3);
    Q_Ret_sub_1B66C();
    sub_15D2C(&self->Unknown_3542);
    sub_15788(&self->Unknown_2D3E);
    sub_15788(&self->Unknown_253A);
    sub_15788(&self->Unknown_1D36);
    Q_DestructVectors_sub_1A9E0(self->vectors2);
    sub_1AA00(self->someFloats);
    Q_DestructVectors_sub_1A9E0(self->vectors1);
    Q_WndA2_Dtor_sub_2C848(&self->a2, 1);
    if ( (v3 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00016120) --------------------------------------------------------
int __fastcall Q_Wnd04BM_LoadBatfxTxt_sub_16120(P_Wnd04BM pWnd)
{
  int i; // kr04_4
  FILE *fp; // eax
  FILE *fp_; // ecx
  int v5; // eax
  int j; // kr14_4
  int v8; // edi
  char s[200]; // [esp+0h] [ebp-12Ch] BYREF
  char bufc[60]; // [esp+C8h] [ebp-64h] BYREF
  int bufi1; // [esp+104h] [ebp-28h] BYREF
  int bufi2; // [esp+108h] [ebp-24h] BYREF
  int bufi3; // [esp+10Ch] [ebp-20h] BYREF
  int bufi4; // [esp+110h] [ebp-1Ch] BYREF

  pWnd->pWnd19BC = 0;
  pWnd->pBatDisplayItems = 0;
  pWnd->pBatHazes = 0;
  for ( i = 0; i != 0x64; ++i )
  {
    pWnd->Unknown_137E[i] = 0;
  }
  pWnd->targetPosition.x = 0.0;
  pWnd->targetPosition.y = 0.0;
  pWnd->targetPosition.z = 0.0;
  pWnd->pTarget2 = 0;
  pWnd->pBatDisplayItem = 0;
  pWnd->Unknown_B7 = 0;
  pWnd->backgroundColor = 0;
  pWnd->cursorShape = 2;
  pWnd->Unknown_BC = 0xFFFF;
  pWnd->Unknown_4F2F = 0;
  pWnd->Unknown_4F33 = 0;
  pWnd->Unknown_503A = 0xFFFFFFFF;
  pWnd->Unknown_5042 = 0xFFFFFFFF;
  pWnd->Unknown_5046 = 0xFFFFFFFF;
  pWnd->Unknown_504A = 0xFFFFFFFF;
  fp = Q_OpenTextFile_sub_1BB10("batfx.txt", 0);
  fp_ = fp;
  if ( !fp )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x1E4);
  }
  Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, s);
  // // here are the names
  // 81
  sscanf(s, "%d", &bufi1);
  v5 = bufi1;
  pWnd->batfxNamesNum = bufi1;
  if ( v5 >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x1EA);
  }
  // SHP files
  if ( pWnd->batfxNamesNum > 0 )
  {
    v8 = 0;
    do
    {
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp_, s);
      sscanf(s, "%s", bufc);
      pWnd->Unknown_19C6[v8++] = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, bufc, 0xFFFFFFFF);
    }
    while ( v8 < pWnd->batfxNamesNum );
  }
  // // here are the gizmo vals
  // // shape1 shape2 sfx1 sfx2

  // // sfx #s refer to list in
  // // soundfx.txt
  for ( j = 0; j != 0x4F; ++j )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp_, s);
    sscanf(s, "%d %d %d %d", &bufi1, &bufi2, &bufi3, &bufi4);
    pWnd->gvShape[j].shape1 = bufi1;
    pWnd->gvShape[j].shape2 = bufi2;
    pWnd->gvSfx[j].sfx1 = bufi3;
    pWnd->gvSfx[j].sfx2 = bufi4;
  }
  return fclose(fp_);
}
// 16120: using guessed type char bufc[60];

//----- (00016348) --------------------------------------------------------
int __fastcall Q_Wnd04BM_Proc3_sub_16348(P_Wnd04BM pWnd, UWORD message, int param1, int param2)
{
  int result; // eax
  int index; // edx
  char v8; // ah
  int v9; // ebx
  int v10; // edx
  P_Wnd19BC v11; // edx
  T_Wnd04BM *v12; // eax
  P_Wnd19BC v13; // edx
  P_Wnd19BC pWnd19BC; // edx
  int x0; // ebx
  int y0; // esi
  int v18; // edi
  int v19; // ecx
  char Unknown_B7; // ah
  P_BatDisplayItem pBatDisplayItem; // edx
  BYTE type; // bl
  char v23; // al
  LONG v24; // edi
  int v25; // eax
  char Unknown_4F2F; // ah
  char v27; // ch
  char v28; // bl
  char v29; // dl
  char v30; // bl
  int v31; // edx
  char v32; // cl
  int v33; // edx
  int v34; // ecx
  P_BatDisplayItem v35; // eax
  int Unknown_27; // edx
  int Unknown_29; // ebx
  P_Target pTarget2; // eax
  P_TargetObject v39; // eax
  P_BatDisplayItem v40; // [esp-4h] [ebp-24h]
  P_BatDisplayItem v41; // [esp-4h] [ebp-24h]
  _BYTE v42[5]; // [esp+8h] [ebp-18h]

  if ( message < 0x3Au )
  {
    if ( message >= 6u )
    {
      if ( message <= 6u )
      {
        Q_WinMgr_SetMousePointerShape_sub_5A270(&WinMgr, 0, 0, 0);
        Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWnd->a2.index, 8);
        return 0xFFFFFFFF;
      }
      if ( message < 0xDu )
      {
        if ( message <= 7u )
        {
          if ( !WinMgr.wnds[dword_96BAC].pWndA2 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x3B7);
          }
          sub_17260(pWnd);
          Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, pWnd->a2.index, 4, 8, 0, 0);
          return 0xFFFFFFFF;
        }
        if ( message != 8 )
        {
          return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
        }
        if ( pWnd->Unknown_B7 != 4 )
        {
          x0 = pWnd->a2.pane.x0;
          if ( param1 < x0 || param1 > pWnd->a2.pane.x1 || (y0 = pWnd->a2.pane.y0, param2 < y0) || param2 > pWnd->a2.pane.y1 )
          {
            pWnd->pBatDisplayItem = 0;
            pWnd->Unknown_1D0E = 1000000.0;
            sub_18C2C(pWnd, 0);
            return 0;
          }
          if ( !pWnd->Unknown_4F2F )
          {
            v18 = param2 - y0;
            v19 = param1 - x0;
            sub_17204(pWnd, param1 - x0, v18);
            if ( !pWnd->pBatDisplayItem )
            {
              Unknown_B7 = pWnd->Unknown_B7;
              if ( Unknown_B7 == 2 )
              {
                sub_16FC0(pWnd, v19, v18);
              }
              else if ( Unknown_B7 == 3 )
              {
                sub_171D0((int)pWnd, v19, v18);
              }
            }
            sub_18C2C(pWnd, 0);
            if ( pWnd->Unknown_B7 == 1 )
            {
              pBatDisplayItem = pWnd->pBatDisplayItem;
              if ( pBatDisplayItem )
              {
                type = pBatDisplayItem->target.type;
                v23 = 0;
                if ( pBatDisplayItem->target.type == 2 )
                {
                  v23 = 3;
                }
                else if ( type == 3 )
                {
                  v23 = 4;
                }
                else if ( type == 1 )
                {
                  v23 = 2;
                }
                v24 = 0x6B;
                if ( Q_WinMgr_DispatchMessageProc3_sub_56D30(
                       &WinMgr,
                       pWnd->pWnd19BC->a2.index,
                       0x322,
                       v23,
                       (LONG)pWnd->pBatDisplayItem->target.pObject.pPlanet) == 0xFFFFFFFF )
                {
                  v24 = 0xF3;
                }
                VFX_line_draw(
                  &pWnd->a2.pane,
                  *(__int16 *)((char *)&pWnd->pTarget2[7].pObject.pStar + 3),
                  SLOWORD(pWnd->pTarget2[8].pObject.pPlanet),
                  pWnd->pBatDisplayItem->Unknown_27,
                  pWnd->pBatDisplayItem->Unknown_29,
                  0,
                  v24);
                return 0;
              }
            }
          }
        }
      }
      else
      {
        if ( message > 0xDu )
        {
          if ( message < 0x32u || message > 0x33u && (message < 0x36u || message > 0x37u) )
          {
            return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
          }
          if ( pWnd->a2.Unknown_39 != 0xFFFFFFFF )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x2E5);
          }
          v25 = 0;
          if ( message == 0x32 )
          {
            Unknown_4F2F = pWnd->Unknown_4F2F;
            if ( (Unknown_4F2F & 1) != 0 )
            {
              if ( (Unknown_4F2F & 2) != 0 )
              {
                LOBYTE(pWnd->Unknown_4F2F) = Unknown_4F2F & 0xFD;
              }
              else
              {
                LOBYTE(pWnd->Unknown_4F2F) = Unknown_4F2F & 0xFE;
                sub_18C2C(pWnd, 0);
              }
            }
            else
            {
              LOBYTE(pWnd->Unknown_4F2F) = Unknown_4F2F & 0xFC | 1;
            }
            v25 = 3;
          }
          if ( message == 0x33 )
          {
            v27 = pWnd->Unknown_4F2F;
            if ( (v27 & 1) != 0 )
            {
              if ( (v27 & 2) != 0 )
              {
                LOBYTE(pWnd->Unknown_4F2F) = v27 & 0xFE;
                sub_18C2C(pWnd, 0);
              }
              else
              {
                LOBYTE(pWnd->Unknown_4F2F) = v27 | 2;
              }
            }
            else
            {
              LOBYTE(pWnd->Unknown_4F2F) = v27 | 3;
            }
            v25 = 3;
          }
          if ( message == 0x36 )
          {
            v28 = pWnd->Unknown_4F2F;
            if ( (v28 & 4) != 0 )
            {
              if ( (v28 & 8) != 0 )
              {
                LOBYTE(pWnd->Unknown_4F2F) = v28 & 0xF7;
              }
              else
              {
                LOBYTE(pWnd->Unknown_4F2F) = v28 & 0xFB;
              }
            }
            else
            {
              LOBYTE(pWnd->Unknown_4F2F) = v28 & 0xF3 | 4;
            }
            v25 = 0xC;
          }
          if ( message == 0x37 )
          {
            v29 = pWnd->Unknown_4F2F;
            if ( (v29 & 4) != 0 )
            {
              if ( (v29 & 8) != 0 )
              {
                LOBYTE(pWnd->Unknown_4F2F) = v29 & 0xFB;
              }
              else
              {
                LOBYTE(pWnd->Unknown_4F2F) = v29 | 8;
              }
            }
            else
            {
              LOBYTE(pWnd->Unknown_4F2F) = v29 | 0xC;
            }
            v25 = 0xC;
          }
          if ( param1 == 4 )
          {
            Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, pWnd->a2.index, 1, 0x3B, v25, 0);
          }
          return 0xFFFFFFFF;
        }
        if ( pWnd->Unknown_B7 != 4 )
        {
          sub_187EC(pWnd);
          sub_18C2C(pWnd, 0);
          return 0;
        }
      }
      return 0;
    }
    if ( message < 3u )
    {
      if ( !message )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
      }
      if ( message <= 1u )
      {
        pWnd->pWnd19BC = (T_Wnd19BC *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "BatControlWnd", 0);
        index = pWnd->a2.index;
        Q_WinMgr_sub_56400(&WinMgr, index, 0x3A, 0, 0, 0);
        sub_186B8(pWnd, index, param1);
        Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
        pWnd->Unknown_4F2F = 0;
        return 0;
      }
      else
      {
        if ( pWnd->Unknown_B7 == 4 )
        {
          sub_12238(pWnd->pWnd19BC, 0);
        }
        Q_WinMgr_sub_564C0(&WinMgr, pWnd->a2.index, 0xFFFFFFFF);
        sub_185CC(pWnd);
        Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
        return 0;
      }
    }
    if ( message <= 3u )
    {
      if ( (unsigned int)param2 < 0xD )
      {
        if ( param2 != 0xC )
        {
          return 0;
        }
        if ( WinMgr.j > 0.1 )
        {
          WinMgr.j = WinMgr.j * 0.8;
          return 0;
        }
      }
      else if ( (unsigned int)param2 <= 0xD )
      {
        if ( WinMgr.j < 10.0 )
        {
          WinMgr.j = WinMgr.j * 1.25;
          return 0;
        }
      }
      else if ( (unsigned int)param2 >= 0x1C )
      {
        if ( (unsigned int)param2 > 0x1C && param2 != 0x39 )
        {
          return 0;
        }
        if ( pWnd->Unknown_B7 == 4 )
        {
          *(_DWORD *)pWnd->Unknown_5036 = 0xFFFFFFFF;
        }
      }
      return 0;
    }
    if ( message > 4u )
    {
      if ( pWnd->Unknown_B7 == 4 )
      {
        result = 0xFFFFFFFF;
        *(_DWORD *)pWnd->Unknown_5036 = 0xFFFFFFFF;
        return result;
      }
      if ( param1 >= pWnd->a2.pane.x0 && param1 <= pWnd->a2.pane.x1 && param2 >= pWnd->a2.pane.y0 && param2 <= pWnd->a2.pane.y1 )
      {
        Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 0);
        if ( pWnd->pBatDisplayItem )
        {
          sub_16D6C(pWnd, param1, param2, 0);
        }
        else if ( pWnd->pTarget2 )
        {
          v41 = pWnd->pBatDisplayItem;
          pWnd19BC = pWnd->pWnd19BC;
          pWnd->pTarget2 = 0;
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd19BC->a2.index, 0x320, 0, (LONG)v41);
          pWnd->Unknown_B7 = 0;
        }
        sub_18C2C(pWnd, 0);
        sub_17260(pWnd);
        return 0xFFFFFFFF;
      }
      return 0;
    }
    if ( pWnd->Unknown_B7 == 4 )
    {
      return 0xFFFFFFFF;
    }
    if ( param1 < pWnd->a2.pane.x0 || param1 > pWnd->a2.pane.x1 || param2 < pWnd->a2.pane.y0 || param2 > pWnd->a2.pane.y1 )
    {
      return 0;
    }
    Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 0);
    if ( pWnd->pBatDisplayItem )
    {
      sub_16D6C(pWnd, param1, param2, 1);
    }
    else
    {
      v8 = pWnd->Unknown_B7;
      if ( v8 == 2 )
      {
        if ( (unsigned __int16)pWnd->Unknown_BC == 0xFFFF )
        {
          pWnd->Unknown_B7 = 0;
        }
        else
        {
          v9 = param2 - pWnd->a2.pane.y0;
          v10 = param1 - pWnd->a2.pane.x0;
          pWnd->Unknown_B7 = 3;
          sub_171D0((int)pWnd, v10, v9);
        }
      }
      else
      {
        if ( v8 == 3 )
        {
          v11 = pWnd->pWnd19BC;
          pWnd->Unknown_B7 = 0;
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v11->a2.index, 0x326, 5, (LONG)&pWnd->Unknown_1D0A);
          pWnd->pTarget2 = 0;
          sub_187EC(pWnd);
          v12 = pWnd;
LABEL_43:
          sub_18C2C(v12, 0);
          return 0xFFFFFFFF;
        }
        if ( v8 )
        {
          return 0xFFFFFFFF;
        }
        v40 = pWnd->pBatDisplayItem;
        v13 = pWnd->pWnd19BC;
        pWnd->pTarget2 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v13->a2.index, 0x320, 0, (LONG)v40);
      }
    }
    v12 = pWnd;
    goto LABEL_43;
  }
  if ( message <= 0x3Au )
  {
    v30 = pWnd->Unknown_4F2F;
    if ( (v30 & 1) != 0 )
    {
      if ( (v30 & 2) != 0 )
      {
        v31 = 2;
      }
      else
      {
        v31 = 0xFFFFFFFE;
      }
      sub_17E50(pWnd, v31);
    }
    v32 = pWnd->Unknown_4F2F;
    if ( (v32 & 4) != 0 )
    {
      if ( (v32 & 8) != 0 )
      {
        v33 = 0xA;
      }
      else
      {
        v33 = 0xFFFFFFF6;
      }
      sub_182B8(pWnd, v33);
    }
    if ( (pWnd->Unknown_4F2F & 5) != 0 )
    {
      goto LABEL_123;
    }
    return 0;
  }
  if ( message < 0x4Cu )
  {
    if ( message >= 0x47u )
    {
      if ( message <= 0x47u )
      {
        pWnd->Unknown_4F2F = 0;
        sub_17F54(pWnd);
        sub_18C2C(pWnd, 0);
        return 0xFFFFFFFF;
      }
      else
      {
        if ( message < 0x4Au )
        {
          return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
        }
        if ( message <= 0x4Au )
        {
          pWnd->Unknown_503A = ~pWnd->Unknown_503A;
          sub_18C2C(pWnd, 0);
        }
        return 0;
      }
    }
    if ( message <= 0x3Bu )
    {
      pWnd->Unknown_4F2F &= ~param1;
      if ( (param1 & 1) != 0 )
      {
        sub_18C2C(pWnd, 0);
      }
      Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWnd->a2.index, 0x3B);
      return 0xFFFFFFFF;
    }
    if ( message != 0x46 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
    }
    return 0;
  }
  if ( message <= 0x4Cu )
  {
    v34 = ~pWnd->Unknown_5042;
    pWnd->Unknown_5046 = v34;
    pWnd->Unknown_5042 = v34;
    sub_18C2C(pWnd, 0);
    return 0;
  }
  if ( message < 0x52u )
  {
    if ( message < 0x50u )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
    }
    if ( message > 0x50u )
    {
      pWnd->Unknown_B7 = 1;
      return 0;
    }
    if ( param1 >= 1 && V_Game.pCurStar->planetsNum >= param1 )
    {
      V_Game.pCurPlanet = *(P_Planet *)((char *)&V_Game.pCurStar->lanes[param1 + 5] + 2);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
      return 0;
    }
    return 0;
  }
  if ( message <= 0x52u )
  {
    sub_126F8(pWnd, param1, (int)pWnd);
    return 0;
  }
  if ( message <= 0x53u )
  {
    *(_DWORD *)v42 = *(_DWORD *)&pWnd->pWnd19BC->target.type;
    if ( !v42[0] )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x39A);
    }
    v42[4] = HIBYTE(pWnd->pWnd19BC->target.pObject.pStar);
    v35 = sub_12AE4(pWnd, *(P_TargetObject *)&v42[1]);
    pWnd->pTarget2 = &v35->target;
    Unknown_27 = v35->Unknown_27;
    if ( Unknown_27 < 0
      || (Unknown_29 = v35->Unknown_29, Unknown_29 < 0)
      || Unknown_27 > pWnd->a2.pane.x1 - pWnd->a2.pane.x0
      || Unknown_29 > pWnd->a2.pane.y1 - pWnd->a2.pane.y0 )
    {
      Q_Wnd04BM_SetTargetPosition_sub_17E88(pWnd, pWnd->pTarget2);
    }
    pTarget2 = pWnd->pTarget2;
    if ( pTarget2->type == 2 )
    {
      v39.pPlanet = (P_Planet)pTarget2->pObject;
      if ( *(UWORD *)((char *)&v39.pPlanet->maximumPopulation2 + 1) == V_PlayerRaceIndex
        && *(int *)((char *)&v39.pPlanet[1].starIndex + 1) > 0 )
      {
        pWnd->Unknown_B7 = 2;
      }
    }
LABEL_123:
    sub_18C2C(pWnd, 0);
    return 0;
  }
  if ( message != 0x54 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
  }
  sub_172B0(pWnd);
  return 0;
}
// 96BAC: using guessed type int dword_96BAC;

//----- (00016D6C) --------------------------------------------------------
void __fastcall sub_16D6C(P_Wnd04BM pWnd, int param1, int param2, int a4)
{
  unsigned int v5; // ebp
  BYTE targetType; // bh
  char v7; // al
  LONG v8; // edi
  P_BatDisplayItem pBatDisplayItem; // eax
  BYTE type; // dl
  P_TargetObject v11; // eax
  char Unknown_B7; // ch
  P_Target pTarget2; // ebx
  char v14; // bh
  LONG pPlanet; // eax
  P_Wnd19BC pWnd19BC; // edx
  char v17; // al
  BYTE v18; // ah

  if ( !pWnd->pBatDisplayItem )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x3D7);
  }
  v5 = 0;
  if ( !a4 )
  {
    Q_Wnd04BM_SetTargetPosition_sub_17E88(pWnd, &pWnd->pBatDisplayItem->target);
    goto LABEL_32;
  }
  if ( pWnd->Unknown_B7 == 1 )
  {
    targetType = pWnd->pBatDisplayItem->target.type;
    v7 = 0;
    switch ( targetType )
    {
      case ASCEND_TARGET_TYPE_2_SHIP:
        v7 = 3;
        break;
      case ASCEND_TARGET_TYPE_1_PLANET:
        v7 = 2;
        break;
      case ASCEND_TARGET_TYPE_3_LANE:
        v7 = 4;
        break;
    }
    v8 = v7;
    if ( Q_WinMgr_DispatchMessageProc3_sub_56D30(
           &WinMgr,
           pWnd->pWnd19BC->a2.index,
           0x322,
           v7,
           (LONG)pWnd->pBatDisplayItem->target.pObject.pPlanet) == TRUE )
    {
      pWnd->Unknown_B7 = 0;
      Q_WinMgr_DispatchMessageProc3_sub_56D30(
        &WinMgr,
        pWnd->pWnd19BC->a2.index,
        0x326,
        v8,
        (LONG)pWnd->pBatDisplayItem->target.pObject.pPlanet);
      pWnd->pTarget2 = 0;
    }
  }
  else
  {
    pBatDisplayItem = pWnd->pBatDisplayItem;
    type = pBatDisplayItem->target.type;
    if ( pBatDisplayItem->target.type != 2 )
    {
      if ( type == 1 )
      {
        Unknown_B7 = pWnd->Unknown_B7;
        if ( Unknown_B7 != 2 && Unknown_B7 != 3 )
        {
          pTarget2 = pWnd->pTarget2;
          if ( pBatDisplayItem != (P_BatDisplayItem)pTarget2 || Unknown_B7 )
          {
            v5 = 0xFFFFFFFF;
            pWnd->pTarget2 = &pWnd->pBatDisplayItem->target;
          }
          else
          {
            V_Game.pCurPlanet = pTarget2->pObject.pPlanet;
            pWnd->pBatDisplayItem = 0;
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
          }
          goto LABEL_32;
        }
        pWnd->Unknown_B7 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(
          &WinMgr,
          pWnd->pWnd19BC->a2.index,
          0x326,
          2,
          (LONG)pWnd->pBatDisplayItem->target.pObject.pPlanet);
      }
      else
      {
        if ( type != 3 )
        {
          goto LABEL_32;
        }
        v14 = pWnd->Unknown_B7;
        pPlanet = (LONG)pBatDisplayItem->target.pObject.pPlanet;
        if ( v14 != 2 && v14 != 3 )
        {
          goto LABEL_32;
        }
        pWnd19BC = pWnd->pWnd19BC;
        pWnd->Unknown_B7 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd19BC->a2.index, 0x326, 4, pPlanet);
      }
      sub_187EC(pWnd);
      sub_18C2C(pWnd, 0);
      goto LABEL_32;
    }
    if ( !pWnd->Unknown_B7 )
    {
      pWnd->pTarget2 = &pBatDisplayItem->target;
      v11.pPlanet = (P_Planet)pBatDisplayItem->target.pObject;
      v5 = 0xFFFFFFFF;
      if ( *(UWORD *)((char *)&v11.pPlanet->maximumPopulation2 + 1) == V_PlayerRaceIndex
        && *(int *)((char *)&v11.pPlanet[1].starIndex + 1) > 0 )
      {
        pWnd->Unknown_B7 = 2;
      }
    }
  }
LABEL_32:
  if ( v5 == 0xFFFFFFFF )
  {
    v17 = 0;
    v18 = pWnd->pTarget2->type;
    if ( v18 == 2 )
    {
      v17 = 3;
    }
    else if ( v18 == 1 )
    {
      v17 = 2;
    }
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd->pWnd19BC->a2.index, 0x320, v17, (LONG)pWnd->pTarget2->pObject.pPlanet);
  }
  sub_17260(pWnd);
}

//----- (00016FC0) --------------------------------------------------------
void __fastcall sub_16FC0(P_Wnd04BM pWnd04BM, int a2, int a3)
{
  int yOffset; // eax
  double v5; // st7
  float v6; // [esp+0h] [ebp-90h]
  float v7; // [esp+4h] [ebp-8Ch]
  int v8; // [esp+8h] [ebp-88h]
  int v9; // [esp+Ch] [ebp-84h]
  T_Vector3D vector3; // [esp+10h] [ebp-80h] BYREF
  T_Vector3D v11; // [esp+1Ch] [ebp-74h] BYREF
  float v12; // [esp+28h] [ebp-68h]
  float v13; // [esp+2Ch] [ebp-64h]
  int v14; // [esp+30h] [ebp-60h]
  T_Vector3D vector; // [esp+34h] [ebp-5Ch] BYREF
  T_Vector3D v16; // [esp+40h] [ebp-50h] BYREF
  int v17[3]; // [esp+4Ch] [ebp-44h] BYREF
  int v18[3]; // [esp+58h] [ebp-38h] BYREF
  T_Vector3D v19; // [esp+64h] [ebp-2Ch] BYREF
  int v20; // [esp+70h] [ebp-20h]
  int v21; // [esp+74h] [ebp-1Ch]
  int *v22; // [esp+78h] [ebp-18h]
  float Unknown_4F16; // [esp+7Ch] [ebp-14h]
  int *v24; // [esp+80h] [ebp-10h]
  T_Vector3D *v25; // [esp+84h] [ebp-Ch]
  float degrees; // [esp+88h] [ebp-8h]

  v20 = a2 - pWnd04BM->_xOffset;
  yOffset = pWnd04BM->_yOffset;
  vector.x = (float)v20;
  v22 = v17;
  v21 = yOffset - a3;
  vector.y = 0.0;
  vector.z = (float)(yOffset - a3);
  Unknown_4F16 = pWnd04BM->Unknown_4F16;
  v12 = vector.x * Unknown_4F16;
  v13 = 0.0 * Unknown_4F16;
  *(float *)v17 = v12;
  *(float *)&v14 = vector.z * Unknown_4F16;
  *(float *)&v17[1] = v13;
  vector.x = v12 * 0.00125;
  v17[2] = v14;
  vector.y = v13;
  vector.z = *(float *)&v14 * 0.0020000001;
  vector3 = pWnd04BM->camera.matrix_00.vector3;
  vector3.y = 0.0;
  v19.x = 0.0;
  v19.z = 1.0;
  v19.y = 0.0;
  degrees = Q_Vector3D_AngleBetween_sub_5309C(&vector3, &v19);
  v7 = vector3.y * v19.z - vector3.z * v19.y;
  *(float *)&v8 = vector3.z * v19.x - vector3.x * v19.z;
  v24 = v18;
  *(float *)v18 = v7;
  v18[1] = v8;
  *(float *)&v9 = vector3.x * v19.y - vector3.y * v19.x;
  v18[2] = v9;
  if ( *(float *)&v8 >= 0.0 )
  {
    v6 = -degrees;
    Q_Vector3D_RotateY_sub_532AC(&vector, v6);
  }
  else
  {
    Q_Vector3D_RotateY_sub_532AC(&vector, degrees);
  }
  v25 = &v11;
  memset(&v16, 0, sizeof(v16));
  v16.x = vector.x + pWnd04BM->targetPosition.x;
  v16.y = vector.y + pWnd04BM->targetPosition.y;
  v5 = vector.z + pWnd04BM->targetPosition.z;
  v11 = v16;
  v16.z = v5;
  pWnd04BM->Unknown_1D0A = LODWORD(v16.x);
  pWnd04BM->Unknown_1D0E = v11.y;
  pWnd04BM->Unknown_1D12[0] = LODWORD(v11.z);
  Q_Vector3D_SnapToGrid_sub_53440((P_Vector3D)&pWnd04BM->Unknown_1D0A);
}

//----- (000171D0) --------------------------------------------------------
void __fastcall sub_171D0(int a1, int a2, int a3)
{
  *(float *)(a1 + 0x1D0E) = (double)(a3 - 0xF0) * *(float *)(a1 + 0x4F16) * 0.00125 + *(float *)(a1 + 0x1D22);
  Q_Vector3D_SnapToGrid_sub_53440((P_Vector3D)(a1 + 0x1D0A));
}

//----- (00017204) --------------------------------------------------------
void __fastcall sub_17204(P_Wnd04BM pWnd, int a2, int a3)
{
  T_BatDisplayItem *v4; // eax

  v4 = (T_BatDisplayItem *)sub_15808(&pWnd->Unknown_1D36, a2, a3);
  pWnd->pBatDisplayItem = v4;
  if ( !v4 )
  {
    pWnd->pBatDisplayItem = (P_BatDisplayItem)sub_15808(&pWnd->Unknown_253A, a2, a3);
  }
  if ( !pWnd->pBatDisplayItem )
  {
    pWnd->pBatDisplayItem = (P_BatDisplayItem)sub_15808(&pWnd->Unknown_2D3E, a2, a3);
  }
}

//----- (00017260) --------------------------------------------------------
void __fastcall sub_17260(P_Wnd04BM pWnd)
{
  char Unknown_B7; // bl
  int cursorShape; // edx

  if ( WinMgr._wndIndex == pWnd->a2.index )
  {
    Unknown_B7 = pWnd->Unknown_B7;
    cursorShape = pWnd->cursorShape;
    if ( Unknown_B7 == 1 )
    {
      cursorShape += 8;
    }
    else if ( Unknown_B7 == 2 || Unknown_B7 == 3 )
    {
      cursorShape += 6;
    }
    if ( pWnd->pBatDisplayItem )
    {
      ++cursorShape;
    }
    Q_WinMgr_SetMousePointerShape_sub_5A270(&WinMgr, cursorShape, 0, 0);
  }
}

//----- (000172B0) --------------------------------------------------------
void __fastcall sub_172B0(P_Wnd04BM pWnd04BM)
{
  P_Target pTarget2; // edx
  P_Target pShip; // eax
  char *helptopic; // esi
  char *objectname; // edi
  P_Ship v6; // eax
  P_Target v7; // eax
  P_Planet pPlanet; // eax
  P_Wnd20HW Wnd_sub_56DA8; // ecx
  P_Target target_; // eax
  P_Wnd19BC pWnd19BC; // edx
  char s[176]; // [esp+0h] [ebp-B0h] BYREF

  pTarget2 = pWnd04BM->pTarget2;
  if ( pTarget2 )
  {
    pShip = pWnd04BM->pTarget2;
    helptopic = 0;
    objectname = 0;
    if ( pTarget2->type == ASCEND_TARGET_TYPE_2_SHIP && (v6 = pShip->pObject.pShip, v6->raceIndex == V_PlayerRaceIndex) )
    {
      helptopic = "abanship";
      objectname = v6->name;
    }
    else
    {
      v7 = pWnd04BM->pTarget2;
      if ( v7->type == ASCEND_TARGET_TYPE_1_PLANET )
      {
        pPlanet = v7->pObject.pPlanet;
        if ( V_PlayerRaceIndex == pPlanet->raceIndex )
        {
          helptopic = "abanplan";
          objectname = pPlanet->name;
        }
      }
    }
    if ( helptopic )
    {
      Wnd_sub_56DA8 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "HELPWINDOW", 0);
      Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, "help.txt", helptopic);
      sprintf(s, Wnd_sub_56DA8->helpItems[0].pText, objectname);
      strcpy(Wnd_sub_56DA8->helpItems[0].pText, s);
      if ( sub_552F8(&WinMgr, &Wnd_sub_56DA8->super, 0) )
      {
        target_ = pWnd04BM->pTarget2;
        if ( target_->type == ASCEND_TARGET_TYPE_2_SHIP )
        {
          Q_Ship_RemoveFromTheGame_sub_49940(target_->pObject.pShip);
        }
        else
        {
          Q_Planet_Abandon_sub_37040(target_->pObject.pPlanet);
        }
        pWnd04BM->pTarget2 = 0;
        pWnd19BC = pWnd04BM->pWnd19BC;
        pWnd04BM->Unknown_B7 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd19BC->a2.index, 0x320, 0, 0);
        sub_187EC(pWnd04BM);
        sub_18C2C(pWnd04BM, 0);
      }
    }
  }
}
// 172B0: using guessed type char s[176];

//----- (000173F4) --------------------------------------------------------
int __fastcall sub_173F4(P_Wnd04BM pWnd04BM)
{
  Q_Camera_BuildTransformWithOffset_sub_1B958(&pWnd04BM->camera, &pWnd04BM->targetPosition);
  return sub_17430(pWnd04BM);
}

//----- (00017430) --------------------------------------------------------
int __fastcall sub_17430(P_Wnd04BM pWnd04BM)
{
  P_BatDisplayItem pBatDisplayItems; // esi
  int v3; // kr08_4
  int v4; // eax
  int Unknown_1D32; // ebx
  int v6; // kr10_4
  char Unknown_B7; // dl
  BYTE type; // bh
  float z; // eax
  int v10; // eax
  int v11; // edx
  int v12; // eax
  double v13; // st7
  BYTE v14; // al
  double v15; // st7
  float *p_x; // edx
  float v17; // eax
  int Unknown_23; // eax
  double v19; // st7
  int v20; // eax
  int i; // kr18_4
  int v22[24]; // [esp+14h] [ebp-16Ch] BYREF
  int v23; // [esp+74h] [ebp-10Ch]
  T_Vector3D vectors[4]; // [esp+78h] [ebp-108h] BYREF
  T_Vector3D v25; // [esp+A8h] [ebp-D8h] BYREF
  T_Vector3D v26; // [esp+B4h] [ebp-CCh] BYREF
  float v27; // [esp+C0h] [ebp-C0h]
  float v28; // [esp+C4h] [ebp-BCh]
  float v29; // [esp+C8h] [ebp-B8h]
  T_Vector3D position; // [esp+CCh] [ebp-B4h] BYREF
  T_Vector3D v1; // [esp+D8h] [ebp-A8h] BYREF
  T_Vector3D v32; // [esp+E4h] [ebp-9Ch] BYREF
  T_Vector3D result; // [esp+F0h] [ebp-90h] BYREF
  T_Vector3D v34; // [esp+FCh] [ebp-84h] BYREF
  float v35; // [esp+108h] [ebp-78h] BYREF
  float v36; // [esp+10Ch] [ebp-74h]
  float v37; // [esp+110h] [ebp-70h]
  __int64 v38; // [esp+114h] [ebp-6Ch]
  float v39; // [esp+11Ch] [ebp-64h]
  float *v40; // [esp+120h] [ebp-60h]
  T_Vector3D *v41; // [esp+124h] [ebp-5Ch]
  int v42; // [esp+128h] [ebp-58h]
  T_Vector3D *v43; // [esp+12Ch] [ebp-54h]
  int v44; // [esp+130h] [ebp-50h]
  T_Vector3D *v45; // [esp+134h] [ebp-4Ch]
  T_Wnd04BMt3 *p_Unknown_1D36; // [esp+138h] [ebp-48h]
  T_Vector3D *vectors3; // [esp+13Ch] [ebp-44h]
  T_Wnd04BMt3 *p_Unknown_253A; // [esp+140h] [ebp-40h]
  T_Matrix3x3 *a2; // [esp+144h] [ebp-3Ch]
  T_Wnd04BMt3 *p_Unknown_2D3E; // [esp+148h] [ebp-38h]
  float v51; // [esp+14Ch] [ebp-34h]
  T_Wnd04BMt1 *p_Unknown_3542; // [esp+150h] [ebp-30h]
  float v53; // [esp+154h] [ebp-2Ch]
  T_Vector3D *p_targetPosition; // [esp+158h] [ebp-28h]
  float v55; // [esp+15Ch] [ebp-24h]
  int a6; // [esp+160h] [ebp-20h] BYREF
  __int16 a5[14]; // [esp+164h] [ebp-1Ch] BYREF

  pBatDisplayItems = pWnd04BM->pBatDisplayItems;
  memset(&v1, 0, sizeof(v1));
  memset(&result, 0, sizeof(result));
  memset(&position, 0, sizeof(position));
  _wcpp_2_ctor_array_(vectors, 4u, &C_Vector3D);
  memset(&result, 0, sizeof(result));
  Q_M34xV_sub_53384(&result, &pWnd04BM->camera.trs, &v1);
  vectors[0].x = 16.0;
  vectors[0].z = 16.0;
  vectors[1].x = 16.0;
  result = v1;
  vectors[3].z = 16.0;
  vectors[0].y = 0.0;
  vectors[1].y = 0.0;
  vectors[2].y = 0.0;
  vectors[1].z = -16.0;
  vectors[2].x = -16.0;
  vectors[2].z = -16.0;
  vectors[3].x = -16.0;
  vectors[3].y = 0.0;
  v45 = &v25;
  v3 = 0;
  do
  {
    Q_M34xV_sub_53384(&vectors[v3], &pWnd04BM->camera.trs, &v1);
    v40 = &v35;
    v27 = v1.x - result.x;
    v35 = v27;
    v28 = v1.y - result.y;
    v36 = v28;
    v29 = v1.z - result.z;
    v37 = v29;
    vectors[v3].x = v27;
    vectors[v3].y = v36;
    v4 = LODWORD(v37);
    vectors[v3++].z = v37;
  }
  while ( &vectors[v3] != v45 );
  Unknown_1D32 = pWnd04BM->Unknown_1D32;
  v51 = pWnd04BM->Unknown_4F2A * 0.5;
  if ( Unknown_1D32 > 0 )
  {
    v44 = 0;
    p_Unknown_1D36 = &pWnd04BM->Unknown_1D36;
    p_Unknown_253A = &pWnd04BM->Unknown_253A;
    p_Unknown_3542 = &pWnd04BM->Unknown_3542;
    p_Unknown_2D3E = &pWnd04BM->Unknown_2D3E;
    a2 = (T_Matrix3x3 *)&pWnd04BM->camera;
    p_targetPosition = &pWnd04BM->targetPosition;
    vectors3 = pWnd04BM->vectors3;
    v6 = 0;
    do
    {
      if ( pBatDisplayItems[v6].target.type != 6
        || ((Unknown_B7 = pWnd04BM->Unknown_B7, Unknown_B7 == 2) || Unknown_B7 == 3)
        && !pWnd04BM->pBatDisplayItem
        && LODWORD(pWnd04BM->Unknown_1D0E) != 0x49742400 )
      {
        if ( pBatDisplayItems[v6].target.type != (BYTE)0xFF )
        {
          type = pBatDisplayItems[v6].target.type;
          pBatDisplayItems[v6].Unknown_1B = 0xFFFFFFFF;
          if ( type == 4 )
          {
            v1 = *(T_Vector3D *)((char *)&pBatDisplayItems[v6].target.pObject.pPlanet->position + 1);
            Q_M33xV_sub_53114(&v1, a2);
            if ( v1.z > 0.0 )
            {
              Q_Project3DTo2D_sub_533D4(&v1, pWnd04BM->camera._scaleFactor, pWnd04BM->_xOffset, pWnd04BM->_yOffset, a5, (WORD *)&a6);
              pBatDisplayItems[v6].Unknown_27 = a5[0];
              pBatDisplayItems[v6].Unknown_29 = a6;
              z = v1.z;
              pBatDisplayItems[v6].Unknown_1B = 0;
              pBatDisplayItems[v6].Unknown_23 = 0;
              pBatDisplayItems[v6].Unknown_2F = z;
              v10 = (int)p_Unknown_2D3E;
              pBatDisplayItems[v6]._scale = 0x10000;
              sub_15794(v10, (int)&pBatDisplayItems[v6]);
            }
          }
          else
          {
            v12 = pBatDisplayItems[v6].Unknown_33 & 0x10;
            v42 = 0xFFFFFFFF;
            if ( v12 )
            {
              position = vectors3[pBatDisplayItems[v6].Unknown_34];
            }
            else
            {
              switch ( pBatDisplayItems[v6].target.type )
              {
                case ASCEND_TARGET_TYPE_0_STAR:
                  memset(&position, 0, sizeof(position));
                  break;
                case ASCEND_TARGET_TYPE_1_PLANET:
                  position = *(T_Vector3D *)&pBatDisplayItems[v6].target.pObject.pShip->totalWeaponDamage;
                  break;
                case ASCEND_TARGET_TYPE_2_SHIP:
                  position = *(T_Vector3D *)((char *)&pBatDisplayItems[v6].target.pObject.pPlanet[1].Unknown_22 + 1);
                  v42 = *(__int16 *)((char *)&pBatDisplayItems[v6].target.pObject.pPlanet->maximumPopulation2 + 1);
                  break;
                case ASCEND_TARGET_TYPE_3_LANE:
                  p_x = &pBatDisplayItems[v6].target.pObject.pPlanet->position.x;
                  if ( (pBatDisplayItems[v6].Unknown_33 & 1) != 0 )
                  {
                    position.x = p_x[2];
                    position.y = p_x[3];
                    v17 = p_x[4];
                  }
                  else
                  {
                    position.x = p_x[5];
                    position.y = p_x[6];
                    v17 = p_x[7];
                  }
                  position.z = v17;
                  break;
                case ASCEND_TARGET_TYPE_6:
                  position = *(T_Vector3D *)&pWnd04BM->Unknown_1D0A;
                  Q_Vector3D_SnapToGrid_sub_53440(&position);
                  break;
                default:
                  Q_AssertLogBreakExit_sub_261A8(0, "..\\batmode.cpp", 0x53E);
                  break;
              }
            }
            result = position;
            Q_M34xV_sub_53384(&result, &pWnd04BM->camera.trs, &v1);
            result.y = pWnd04BM->targetPosition.y;
            v41 = &v26;
            memset(&v32, 0, sizeof(v32));
            v32.x = result.x - p_targetPosition->x;
            v32.y = result.y - p_targetPosition->y;
            v32.z = result.z - p_targetPosition->z;
            v26 = v32;
            result = v32;
            v13 = sqrt(v32.y * v32.y + v32.x * v32.x + v32.z * v32.z);
            pBatDisplayItems[v6].Unknown_23 = (v13 >= v51) - 1;
            if ( v1.z > (double)pWnd04BM->camera.nearClip && v1.z < (double)pWnd04BM->camera.farClip )
            {
              Q_Project3DTo2D_sub_533D4(&v1, pWnd04BM->camera._scaleFactor, pWnd04BM->_xOffset, pWnd04BM->_yOffset, a5, (WORD *)&a6);
              pBatDisplayItems[v6].Unknown_27 = a5[0];
              pBatDisplayItems[v6].Unknown_29 = a6;
              pBatDisplayItems[v6].Unknown_2F = v1.z;
              v14 = pBatDisplayItems[v6].target.type;
              pBatDisplayItems[v6].Unknown_1B = 0;
              if ( v14 == 7 )
              {
                pBatDisplayItems[v6].Unknown_2F = pBatDisplayItems[v6].Unknown_2F + -1.0;
              }
              v15 = pWnd04BM->Unknown_4F1A * 16384.0;
              v55 = 131072.0;
              v53 = v15;
              if ( pBatDisplayItems[v6].Unknown_2F >= (double)pWnd04BM->camera.nearClip )
              {
                v55 = v53 / pBatDisplayItems[v6].Unknown_2F;
              }
              if ( v55 >= 16384.0 )
              {
                if ( v55 > 131072.0 )
                {
                  v55 = 131072.0;
                }
              }
              else
              {
                v55 = 16384.0;
              }
              v38 = (__int64)(v55 * *(float *)&pBatDisplayItems[v6].Unknown_B);
              pBatDisplayItems[v6]._scale = v38;
              Unknown_23 = pBatDisplayItems[v6].Unknown_23;
              v39 = pWnd04BM->Unknown_4F16 * 0.125 + pWnd04BM->targetPosition.y;
              if ( Unknown_23 )
              {
                if ( (pBatDisplayItems[v6].Unknown_33 & 2) == 0 )
                {
                  result.x = position.x;
                  result.z = position.z;
                  result.y = v39;
                  Q_M34xV_sub_53384(&result, &pWnd04BM->camera.trs, &v1);
                  result = v1;
                  Q_Project3DTo2D_sub_533D4(&v1, pWnd04BM->camera._scaleFactor, pWnd04BM->_xOffset, pWnd04BM->_yOffset, a5, (WORD *)&a6);
                  pBatDisplayItems[v6].Unknown_2B = a5[0];
                  pBatDisplayItems[v6].Unknown_2D = a6;
                  for ( i = 0; i != 4; ++i )
                  {
                    v43 = &v34;
                    memset(&v25, 0, sizeof(v25));
                    v25.x = result.x + vectors[i].x;
                    v25.y = result.y + vectors[i].y;
                    v19 = result.z + vectors[i].z;
                    v34 = v25;
                    v25.z = v19;
                    v1 = v25;
                    Q_Project3DTo2D_sub_533D4(&v1, pWnd04BM->camera._scaleFactor, pWnd04BM->_xOffset, pWnd04BM->_yOffset, a5, (WORD *)&a6);
                    v22[6 * i] = a5[0];
                    v22[6 * i + 1] = (__int16)a6;
                  }
                  v23 = v42;
                  sub_15D38((int)p_Unknown_3542, v22);
                  if ( pBatDisplayItems[v6].target.type == 6 )
                  {
                    pWnd04BM->Unknown_BC = LOWORD(pWnd04BM->Unknown_3542.num) - 1;
                  }
                }
              }
              if ( position.y - v39 > 0.0 )
              {
                v20 = (int)p_Unknown_253A;
                pBatDisplayItems[v6].Unknown_1F = 0;
              }
              else
              {
                v20 = (int)p_Unknown_1D36;
                pBatDisplayItems[v6].Unknown_1F = 0xFFFFFFFF;
              }
              sub_15794(v20, (int)&pBatDisplayItems[v6]);
            }
          }
        }
      }
      v4 = v44 + 1;
      v11 = pWnd04BM->Unknown_1D32;
      v44 = v4;
      ++v6;
    }
    while ( v4 < v11 );
  }
  return v4;
}
// 17430: using guessed type __int16 a5[14];
// 17430: using guessed type _DWORD var_16C[24];

//----- (00017E50) --------------------------------------------------------
void __fastcall sub_17E50(P_Wnd04BM pWnd, int a2)
{
  float v2; // [esp+0h] [ebp-8h]

  v2 = (double)a2 * WinMgr.j;
  Q_Camera_RotateYY_sub_1BAF0(&pWnd->camera, v2);
}

//----- (00017E88) --------------------------------------------------------
void __fastcall Q_Wnd04BM_SetTargetPosition_sub_17E88(P_Wnd04BM pWnd04BM, P_Target pTarget)
{
  P_Lane pLane; // ecx
  double x; // st7
  T_Vector3D *p_vector1; // ecx

  if ( !pTarget )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x5BD);
  }
  switch ( pTarget->type )
  {
    case ASCEND_TARGET_TYPE_0_STAR:
      pWnd04BM->targetPosition.x = 0.0;
      pWnd04BM->targetPosition.y = 0.0;
      pWnd04BM->targetPosition.z = 0.0;
      break;
    case ASCEND_TARGET_TYPE_1_PLANET:
      pWnd04BM->targetPosition = pTarget->pObject.pPlanet->position;
      break;
    case ASCEND_TARGET_TYPE_2_SHIP:
      pWnd04BM->targetPosition = pTarget->pObject.pShip->position;
      break;
    case ASCEND_TARGET_TYPE_3_LANE:
      pLane = pTarget->pObject.pLane;
      if ( V_Game.pCurStar == pLane->pStar1 )
      {
        x = pLane->vector1.x;
        p_vector1 = &pLane->vector1;
      }
      else
      {
        x = pLane->vector2.x;
        p_vector1 = &pLane->vector2;
      }
      pWnd04BM->targetPosition.x = x;
      pWnd04BM->targetPosition.y = p_vector1->y;
      pWnd04BM->targetPosition.z = p_vector1->z;
      break;
    default:
      JUMPOUT(0x15ED0);
  }
}
// 17EBC: control flows out of bounds to 15ED0

//----- (00017F54) --------------------------------------------------------
void __fastcall sub_17F54(P_Wnd04BM a1)
{
  a1->targetPosition.x = 0.0;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  a1->Unknown_4F16 = a1->Unknown_4F1A;
  a1->camera.position = a1->vector_4EDE;
  a1->camera.matrix_00 = a1->matrix_4EEA;
  sub_181F0(a1);
}

//----- (00017FF0) --------------------------------------------------------
void __fastcall sub_17FF0(P_Wnd04BM a1)
{
  double v2; // st6
  double v3; // st7
  float a2; // [esp+0h] [ebp-3Ch]
  int x_4; // [esp+Ch] [ebp-30h]
  float x_4a; // [esp+Ch] [ebp-30h]
  double v7; // [esp+10h] [ebp-2Ch]

  a1->targetPosition.x = 0.0;
  LODWORD(a1->Unknown_4F26) = 0x23;
  v2 = (double)SLODWORD(a1->Unknown_4F26) * 0.017453292;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  v7 = *(float *)&a1->Unknown_4F1E;
  v3 = v7 / tan(v2 * 0.5);
  x_4 = a1->_xOffset;
  a1->Unknown_4F16 = v3;
  a1->Unknown_4F1A = v3;
  a2 = (float)SLODWORD(a1->Unknown_4F26);
  Q_Camera_InitializeProjection_sub_1B808(&a1->camera, a2, 1.0, 100000.0, x_4);
  a1->vector_4EDE.z = a1->camera._scaleFactor;
  HIBYTE(a1->vector_4EDE.z) ^= 0x80u;
  a1->vector_4EDE.y = a1->vector_4EDE.z * 0.33333334;
  x_4a = a1->Unknown_4F16;
  a1->vector_4EDE.x = 0.0;
  Q_Vector3D_SetLength_sub_53054(&a1->vector_4EDE, x_4a);
  a1->camera.matrix_00.vector1.x = 1.0;
  a1->camera.matrix_00.vector1.y = 0.0;
  a1->camera.matrix_00.vector1.z = 0.0;
  a1->camera.matrix_00.vector2.x = 0.0;
  a1->camera.matrix_00.vector2.y = 1.0;
  a1->camera.matrix_00.vector2.z = 0.0;
  a1->camera.matrix_00.vector3.x = 0.0;
  a1->camera.matrix_00.vector3.y = 0.0;
  a1->camera.matrix_00.vector3.z = 1.0;
  a1->matrix_4EEA = a1->camera.matrix_00;
  a1->matrix_4EEA.vector3.x = -a1->vector_4EDE.x;
  a1->matrix_4EEA.vector3.y = -a1->vector_4EDE.y;
  a1->matrix_4EEA.vector3.z = -a1->vector_4EDE.z;
  Q_Matrix_Orthonormalize3_sub_53864(&a1->matrix_4EEA);
  a1->camera.matrix_00 = a1->matrix_4EEA;
  a1->camera.position = a1->vector_4EDE;
  sub_181F0(a1);
}

//----- (000181F0) --------------------------------------------------------
void __fastcall sub_181F0(P_Wnd04BM a1)
{
  a1->Unknown_4F2A = tan((double)SLODWORD(a1->Unknown_4F26) * 0.017453292 * 0.5);
  a1->Unknown_4F2A = a1->Unknown_4F16 * a1->Unknown_4F2A * 2.0;
  a1->Unknown_4F12 = a1->Unknown_4F1A * 0.5 + a1->Unknown_4F16;
  a1->Unknown_4F0E = a1->Unknown_4F16 - a1->Unknown_4F2A * 0.5;
}

//----- (0001826C) --------------------------------------------------------
void __fastcall sub_1826C(P_Wnd04BM a1, P_BatDisplayItem a2, unsigned __int16 a3, unsigned __int16 a4)
{
  if ( a3 >= a1->batfxNamesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x62B);
  }
  sub_156C0(a2, (unsigned __int16)a1->Unknown_19C6[a3], a4);
}

//----- (000182B8) --------------------------------------------------------
void __fastcall sub_182B8(P_Wnd04BM a1, int a2)
{
  double v3; // st7
  double v4; // st7
  float scaleFactor; // eax
  float v6; // [esp+4h] [ebp-8h]
  float v7; // [esp+4h] [ebp-8h]
  float v8; // [esp+4h] [ebp-8h]

  v3 = (double)a2;
  v6 = v3;
  if ( v3 <= 50.0 )
  {
    if ( v6 < -50.0 )
    {
      v6 = -50.0;
    }
  }
  else
  {
    v6 = 50.0;
  }
  v7 = v6 * 0.0099999998 * WinMgr.j;
  v8 = v7 + 1.0;
  v4 = a1->Unknown_4F16 * v8;
  a1->Unknown_4F16 = v4;
  if ( v4 < a1->camera._scaleFactor )
  {
    scaleFactor = a1->camera._scaleFactor;
LABEL_9:
    a1->Unknown_4F16 = scaleFactor;
    goto LABEL_10;
  }
  if ( a1->Unknown_4F16 > (double)a1->Unknown_4F1A )
  {
    scaleFactor = a1->Unknown_4F1A;
    goto LABEL_9;
  }
LABEL_10:
  Q_Vector3D_SetLength_sub_53054(&a1->camera.position, a1->Unknown_4F16);
  sub_181F0(a1);
}

//----- (00018370) --------------------------------------------------------
unsigned int __fastcall sub_18370(P_Wnd04BM pWnd)
{
  __int16 v2; // ax
  __int16 y0; // cx
  __int16 v4; // bx
  __int16 y1; // ax
  T_BatDisplayItem *v6; // eax
  void *v7; // eax
  T_HazeTable *pBatHazes; // kr00_4
  UBYTE *v9; // ebp
  int v10; // kr04_4
  int v11; // kr14_4
  int v13; // kr0C_4
  T_CFile cfile; // [esp+0h] [ebp-144h] BYREF
  char v15[16]; // [esp+118h] [ebp-2Ch] BYREF
  char v16[20]; // [esp+12Ch] [ebp-18h] BYREF
  int i; // [esp+140h] [ebp-4h]

  v2 = LOWORD(pWnd->a2.pane.x1) - LOWORD(pWnd->a2.pane.x0);
  y0 = pWnd->a2.pane.y0;
  pWnd->_xOffset = v2;
  v4 = v2;
  y1 = pWnd->a2.pane.y1;
  pWnd->_xOffset = v4 >> 1;
  pWnd->_yOffset = (__int16)(y1 - y0) >> 1;
  pWnd->targetPosition.x = 0.0;
  pWnd->targetPosition.y = 0.0;
  pWnd->targetPosition.z = 0.0;
  if ( pWnd->pBatDisplayItems )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x65E);
  }
  if ( pWnd->pBatHazes )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x65F);
  }
  pWnd->batDisplayItemsNum = 128;
  v6 = (T_BatDisplayItem *)operator new[](0x35 * pWnd->batDisplayItemsNum);
  Q_RegisterDataInWinMgr_sub_2625C(v6, 1, "BATDISPLAYITEMS");
  pWnd->pBatDisplayItems = v6;
  if ( !v6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x669);
  }
  pWnd->batHazesNum = 39;
  v7 = operator new[](pWnd->batHazesNum << 8);
  Q_RegisterDataInWinMgr_sub_2625C(v7, 1, "BATHAZE");
  pWnd->pBatHazes = (T_HazeTable *)v7;
  if ( !v7 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x66F);
  }
  pBatHazes = pWnd->pBatHazes;
  Q_CFile_Ctor_sub_1BB78(&cfile);
  for ( i = 0; i < 31; ++i )
  {
    sprintf(v15, "DATA\\BLACK%.2d.HAZ", i);
    if ( Q_CFile_Open_sub_1BBFC(&cfile, v15, 0x200, 0) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\batmode.cpp", 0x67B);
    }
    Q_CFile_Load_sub_1BF1C(&cfile, pBatHazes[i]);
  }
  v10 = i;
  if ( Q_CFile_Open_sub_1BBFC(&cfile, "DATA\\SLANE03.HAZ", 0x200, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batmode.cpp", 0x680);
  }
  v9 = pBatHazes[v10];
  Q_CFile_Load_sub_1BF1C(&cfile, v9);
  i = 'A';
  strcpy(v16, "DATA\\RACEA03.HAZ");
  v16[0x11] = aDataRacea03Haz[0x11];
  *(_WORD *)&v16[0x12] = *(_WORD *)&aDataRacea03Haz[0x12];
  v11 = 0;
  v13 = 0;
  do
  {
    v16[9] = i;
    ++v11;
    if ( Q_CFile_Open_sub_1BBFC(&cfile, v16, 0x200, 0) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x68A);
    }
    Q_CFile_Load_sub_1BF1C(&cfile, &v9[0x100 * v11]);
    ++v13;
  }
  while ( v13 + 'A' < 'H' );
  Q_CFile_Dtor_sub_1BBC8(&cfile);
  return 0xFFFFFFFF;
}

//----- (000185CC) --------------------------------------------------------
void __fastcall sub_185CC(P_Wnd04BM pWnd4BM)
{
  int index; // esi
  int v3; // edi
  T_Vector3D *v4; // eax

  index = V_Game.pCurStar->index;
  if ( index >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x697);
  }
  v3 = index;
  pWnd4BM->vectors1[v3] = pWnd4BM->camera.position;
  v4 = (T_Vector3D *)&pWnd4BM->someFloats[index];
  v4->x = pWnd4BM->camera.matrix_00.vector1.x;
  v4->y = pWnd4BM->camera.matrix_00.vector1.y;
  v4->z = pWnd4BM->camera.matrix_00.vector1.z;
  v4[1] = pWnd4BM->camera.matrix_00.vector2;
  v4[2] = pWnd4BM->camera.matrix_00.vector3;
  pWnd4BM->vectors2[v3] = pWnd4BM->targetPosition;
  pWnd4BM->Unknown_4F2F = 0;
  pWnd4BM->Unknown_B7 = 0;
  pWnd4BM->pTarget2 = 0;
}

//----- (000186B8) --------------------------------------------------------
void __fastcall sub_186B8(P_Wnd04BM pWnd4BM, int a2, int a3)
{
  int index; // esi
  T_Vector3D *v5; // ebx

  sub_187EC(pWnd4BM);
  index = V_Game.pCurStar->index;
  if ( index >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x6AE);
  }
  if ( pWnd4BM->Unknown_137E[index] )
  {
    pWnd4BM->camera.position = pWnd4BM->vectors1[index];
    v5 = (T_Vector3D *)&pWnd4BM->someFloats[index];
    pWnd4BM->camera.matrix_00.vector1.x = v5->x;
    pWnd4BM->camera.matrix_00.vector1.y = v5->y;
    pWnd4BM->camera.matrix_00.vector1.z = v5->z;
    pWnd4BM->camera.matrix_00.vector2 = v5[1];
    pWnd4BM->camera.matrix_00.vector3 = v5[2];
    pWnd4BM->targetPosition = pWnd4BM->vectors2[index];
    pWnd4BM->Unknown_4F16 = sqrt(
                              pWnd4BM->camera.position.y * pWnd4BM->camera.position.y
                            + pWnd4BM->camera.position.x * pWnd4BM->camera.position.x
                            + pWnd4BM->camera.position.z * pWnd4BM->camera.position.z);
    sub_181F0(pWnd4BM);
  }
  else
  {
    sub_17FF0(pWnd4BM);
    pWnd4BM->Unknown_137E[index] = 0xFFFFFFFF;
  }
  sub_18C2C(pWnd4BM, 0);
}

//----- (000187EC) --------------------------------------------------------
int __fastcall sub_187EC(P_Wnd04BM a1)
{
  __int16 i; // si
  int v3; // eax
  P_BatDisplayItem pBatDisplayItems; // esi
  T_BatDisplayItem *v5; // esi
  unsigned __int16 *pCurStar; // eax
  int v7; // ebx
  P_Planet v8; // eax
  signed __int16 v9; // cx
  float *p_x; // eax
  float z; // eax
  int v12; // ebp
  P_Star v13; // eax
  P_Lane v14; // ebp
  unsigned __int16 v15; // ax
  int v16; // ebp
  int v17; // eax
  __int16 v18; // bx
  int result; // eax
  int v20; // ecx
  __int16 j; // ax
  __int16 k; // cx
  int v23[107]; // [esp+8h] [ebp-1E4h] BYREF
  float x; // [esp+1B4h] [ebp-38h]
  float y; // [esp+1B8h] [ebp-34h]
  float v26; // [esp+1BCh] [ebp-30h]
  int v27; // [esp+1C0h] [ebp-2Ch]
  int ShipsAtLocation_sub_1D794; // [esp+1C4h] [ebp-28h]
  int v29; // [esp+1C8h] [ebp-24h]
  int v30; // [esp+1CCh] [ebp-20h]
  int v31; // [esp+1D0h] [ebp-1Ch]

  for ( i = 0; i < a1->batDisplayItemsNum; ++i )
  {
    v3 = i;
    a1->pBatDisplayItems[v3].Unknown_33 = 0;
  }
  pBatDisplayItems = a1->pBatDisplayItems;
  a1->Unknown_1D32 = 0;
  pBatDisplayItems->target.type = 6;
  a1->Unknown_1D12[1] = (int)pBatDisplayItems;
  pBatDisplayItems->shapeCacheIndex = 0xFFFF;
  v5 = pBatDisplayItems + 1;
  ++a1->Unknown_1D32;
  for ( j = 0; j < 1; ++j )
  {
    v5->target.type = 0xFF;
    ++v5;
    ++a1->Unknown_1D32;
  }
  v5->target.type = 0;
  pCurStar = (unsigned __int16 *)V_Game.pCurStar;
  v5->target.pObject.pPlanet = (P_Planet)V_Game.pCurStar;
  sub_1826C(a1, v5, 1u, *pCurStar);
  ++a1->Unknown_1D32;
  LOWORD(v30) = 0;
  while ( (__int16)v30 < V_Game.pCurStar->planetsNum )
  {
    if ( a1->Unknown_1D32 >= a1->batDisplayItemsNum )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x6FC);
    }
    v8 = V_Game.pCurStar->planets[(__int16)v30];
    v5[1].target.type = 1;
    v5[1].target.pObject.pPlanet = v8;
    ++v5;
    v9 = v8->size + 5 * v8->type;
    if ( v9 >= 0x37 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x706);
    }
    sub_1826C(a1, v5, 0, v9);
    v7 = a1->Unknown_1D32 + 1;
    LOWORD(v30) = v30 + 1;
    a1->Unknown_1D32 = v7;
  }
  p_x = &v5->target.pObject.pPlanet->position.x;
  *(float *)&a1->Unknown_4F1E = sqrt(p_x[1] * p_x[1] + *p_x * *p_x + p_x[2] * p_x[2]);
  LOWORD(v31) = 0;
  while ( 1 )
  {
    v13 = V_Game.pCurStar;
    if ( (__int16)v31 >= V_Game.pCurStar->lanesNum )
    {
      break;
    }
    if ( a1->Unknown_1D32 >= a1->batDisplayItemsNum )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x716);
    }
    v14 = V_Game.pCurStar->lanes[(__int16)v31];
    v5[1].target.type = 3;
    v5[1].target.pObject.pPlanet = (P_Planet)v14;
    ++v5;
    v15 = (v14->flags & 1) != 0;
    if ( (v14->flags & 2) != 0 )
    {
      v15 += 2;
    }
    sub_1826C(a1, v5, 2u, v15);
    x = 0.0;
    y = 0.0;
    v26 = 0.0;
    if ( V_Game.pCurStar == v14->pStar1 )
    {
      v5->Unknown_33 |= 1u;
      x = v14->vector1.x;
      y = v14->vector1.y;
      z = v14->vector1.z;
    }
    else
    {
      v5->Unknown_33 &= ~1u;
      x = v14->vector2.x;
      y = v14->vector2.y;
      z = v14->vector2.z;
    }
    v26 = z;
    *(float *)&v27 = sqrt(y * y + x * x + z * z);
    if ( *(float *)&a1->Unknown_4F1E < (double)*(float *)&v27 )
    {
      a1->Unknown_4F1E = v27;
    }
    v12 = a1->Unknown_1D32 + 1;
    LOWORD(v31) = v31 + 1;
    a1->Unknown_1D32 = v12;
  }
  *(float *)&a1->Unknown_4F1E = *(float *)&a1->Unknown_4F1E + 32.0;
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)v13, (P_Ship *)v23);
  for ( k = 0; k < ShipsAtLocation_sub_1D794; ++k )
  {
    v16 = v23[k];
    if ( *(_BYTE *)(v16 + 0x58) == 4 )
    {
      if ( a1->Unknown_1D32 >= a1->batDisplayItemsNum )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x750);
      }
      v5[1].target.pObject.pPlanet = (P_Planet)v16;
      v5[1].target.type = 2;
      sub_156C0(++v5, GwshareShpCacheIndexes[*(__int16 *)(v16 + 0x56) + 0xE], *(char *)(v16 + 0xAA));
      ++a1->Unknown_1D32;
    }
  }
  if ( V_Game.sectorsNum > 0 )
  {
    LOWORD(v29) = 0;
    do
    {
      if ( a1->Unknown_1D32 >= a1->batDisplayItemsNum )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x761);
      }
      v17 = (__int16)v29;
      v5[1].target.type = 4;
      v5[1].target.pObject.pPlanet = (P_Planet)&V_Game.sectors[v17];
      sub_1826C(a1, ++v5, 3u, V_Game.sectors[v17].n);
      v18 = v29;
      ++a1->Unknown_1D32;
      LOWORD(v29) = v18 + 1;
    }
    while ( (__int16)(v18 + 1) < V_Game.sectorsNum );
  }
  for ( result = 0; (__int16)result < a1->Unknown_1D32; ++result )
  {
    v20 = (__int16)result;
    a1->pBatDisplayItems[v20].Unknown_33 &= ~4u;
  }
  return result;
}
// 187EC: using guessed type int var_1E4[107];

//----- (00018C2C) --------------------------------------------------------
void __fastcall sub_18C2C(P_Wnd04BM pWnd04BM, int a2)
{
  T_Wnd04BMt3 *p_Unknown_1D36; // ecx

  p_Unknown_1D36 = &pWnd04BM->Unknown_1D36;
  sub_15788(&pWnd04BM->Unknown_1D36);
  sub_15788(&pWnd04BM->Unknown_253A);
  sub_15788(&pWnd04BM->Unknown_2D3E);
  sub_15D2C(&pWnd04BM->Unknown_3542);
  sub_173F4(pWnd04BM);
  sub_157EC(p_Unknown_1D36);
  sub_157EC(&pWnd04BM->Unknown_253A);
  if ( !a2 )
  {
    pWnd04BM->a2.pProcs->proc4_draw((P_WndA2)pWnd04BM, 0);
  }
}

//----- (00018CA8) --------------------------------------------------------
void __fastcall Q_Wnd04BM_Proc4_sub_18CA8(P_Wnd04BM pWnd, int a2)
{
  char Unknown_B7; // ah
  P_BatDisplayItem pBatDisplayItem; // eax
  char *format; // eax MAPDST
  int v6; // ebx
  int v7; // edx
  P_Ship pShip__; // edx
  WORD v9; // bx
  int order; // edx
  char *v11; // ecx
  P_Planet pPlanet; // ebx
  int raceIndex; // eax
  __int16 v16; // dx
  P_Ship pShip_; // ebx
  char *v18; // esi
  char *v19; // eax
  char *v20; // eax
  char *v21; // eax
  P_BatDisplayItem v22; // eax
  P_Star pStar; // ebx
  char *sub_1CEA8; // esi
  P_BatDisplayItem v25; // eax
  BYTE v26; // dl
  const char *p_freeSurfaceSquaresNum; // ecx
  WORD v28; // [esp-Ch] [ebp-198h]
  char *starName; // [esp-4h] [ebp-190h]
  char *specName; // [esp-4h] [ebp-190h]
  T_Name20 ordersTexts[10]; // [esp+0h] [ebp-18Ch] BYREF
  char v32[80]; // [esp+C8h] [ebp-C4h] BYREF
  char s[60]; // [esp+118h] [ebp-74h] BYREF
  char v34[32]; // [esp+154h] [ebp-38h] BYREF
  T_Ship *pShip; // [esp+174h] [ebp-18h]

  if ( !a2 )
  {
    pPane = pWnd->a2.pane;
  }
  VFX_pane_wipe(&pWnd->a2.pane, pWnd->backgroundColor);
  sub_15948(&pWnd->Unknown_2D3E, pWnd);
  sub_19AE8(pWnd);
  sub_15948(&pWnd->Unknown_253A, pWnd);
  if ( pWnd->Unknown_5046 )
  {
    sub_15D74(&pWnd->Unknown_3542, pWnd);
  }
  if ( !pWnd->pBatDisplayItem )
  {
    Unknown_B7 = pWnd->Unknown_B7;
    if ( Unknown_B7 == 2 || Unknown_B7 == 3 )
    {
      sub_15DA4(&pWnd->Unknown_3542, pWnd, pWnd->Unknown_BC);
    }
  }
  if ( pWnd->Unknown_503A && (pWnd->Unknown_4F2F & 1) == 0 )
  {
    sub_1936C(pWnd);
  }
  if ( pWnd->Unknown_5046 )
  {
    sub_15E1C(&pWnd->Unknown_3542, pWnd);
  }
  sub_15948(&pWnd->Unknown_1D36, pWnd);
  Q_DrawRaceFlagTinted_sub_53E38(&pWnd->a2.pane, 3, 3, V_PlayerRaceIndex);
  if ( !WinMgr.wnds[dword_96BAC].pWndA2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x7AC);
  }
  pBatDisplayItem = pWnd->pBatDisplayItem;
  pShip = 0;
  if ( pBatDisplayItem )
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(2); // 2: "Unknown"
    strcpy(s, sub_1CEA8);
    v25 = pWnd->pBatDisplayItem;
    v16 = 0xF3;
    switch ( v25->target.type )
    {
      case ASCEND_TARGET_TYPE_0_STAR:
        starName = v25->target.pObject.pStar->name;
        format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(3);// 3: "Sun %s"
        sprintf(s, format, starName);
        break;
      case ASCEND_TARGET_TYPE_1_PLANET:
        pPlanet = v25->target.pObject.pPlanet;
        format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(4);// 4: "Planet %s"
        sprintf(s, format, pPlanet->name);
        raceIndex = pPlanet->raceIndex;
        if ( raceIndex != 0xFF )
        {
          specName = V_SpecNames[V_Game.races[raceIndex].species];
          format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(5);// 5: "\nOwned by %s"
          sprintf(v34, format, specName);
          strcat(s, v34);
          v16 = 4 * V_Game.races[pPlanet->raceIndex].colorSet + 0x13;
        }
        break;
      case ASCEND_TARGET_TYPE_2_SHIP:
        pShip = v25->target.pObject.pShip;
        pShip_ = pShip;
        sprintf(s, "%s %s", V_SpecNames[V_Game.races[pShip->raceIndex].species], pShip->name);
        if ( pShip_->raceIndex == V_PlayerRaceIndex && pShip_->order )
        {
          v18 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(6); // 6: "\nMoving to Star Lane"
          v19 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(7); // 7: "\nMoving to Planet"
          if ( pShip_->order != ASCEND_SO_1_GOSTAR )
          {
            v18 = v19;
          }
          strcat(s, v18);
        }
        v16 = 4 * V_Game.races[pShip_->raceIndex].colorSet + 0x13;
        break;
      case ASCEND_TARGET_TYPE_3_LANE:
        v20 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(8);   // 8: "Star Lane"
        strcpy(s, v20);
        if ( (pWnd->pBatDisplayItem->target.pObject.pLane->flags & ASCEND_LANE_FLAGS_1_RED_LINK) != 0 )
        {
          v21 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(9); // 9: "Red Link"
          strcpy(s, v21);
        }
        v22 = pWnd->pBatDisplayItem;
        if ( (v22->Unknown_33 & 1) != 0 )
        {
          pStar = v22->target.pObject.pLane->pStar2;
        }
        else
        {
          pStar = v22->target.pObject.pLane->pStar1;
        }
        if ( ((1 << V_PlayerRaceIndex) & pStar->exploredBits) != 0 )
        {
          strcat(s, Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xA));// 10: " to "
          strcat(s, pStar->name);
        }
        break;
      default:
        break;
    }
    v28 = v16;
    v6 = pWnd->a2.pane.y1 - 0x1E;
    v7 = pWnd->a2.pane.x1 - 0xC8;
    WinMgr.LargeFont.pane = V_GSystem.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v7, v6, s, 0, v28, 0xFF, 0);
  }
  pShip__ = pShip;
  sub_17260(pWnd);
  if ( pShip__ )
  {
    v9 = V_CheatMode;
    if ( V_CheatMode == TRUE )
    {
      sprintf(v32, "%s %s", V_SpecNames[V_Game.races[pShip__->raceIndex].species], pShip__->name);
      WinMgr.SmallFont.pane = V_GSystem.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xFA, 0xA, v32, 0, v9, v9, 0);
      sprintf(v32, "POWER %d MOVES %d INTEGRITY %d", pShip->availablePower, pShip->availableMoves, pShip->hullIntegrity);
      WinMgr.SmallFont.pane = V_GSystem.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xFA, 0x14, v32, 0, 0xFFFF, 0xFFFF, 0);
      qmemcpy(ordersTexts, V_OrdersTexts, sizeof(ordersTexts));
      strcpy(v32, "INVALID ORDER");
      order = pShip->order;
      if ( order >= 0 && pShip->order <= 7 )
      {
        v11 = ordersTexts[order];
      }
      else
      {
        v11 = v32;
      }
      WinMgr.SmallFont.pane = V_GSystem.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xFA, 0x1E, v11, 0, 0xFFFF, 0xFFFF, 0);
      v26 = pShip->order;
      if ( v26 == 1 )
      {
        p_freeSurfaceSquaresNum = (const char *)&pShip->_orderTargetObject.pPlanet->freeSurfaceSquaresNum;
LABEL_46:
        WinMgr.SmallFont.pane = V_GSystem.pane;
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x140, 0x1E, p_freeSurfaceSquaresNum, 0, 0xFFFF, 0xFFFF, 0);
        goto LABEL_47;
      }
      if ( v26 == 2 )
      {
        p_freeSurfaceSquaresNum = pShip->_orderTargetObject.pPlanet->name;
        goto LABEL_46;
      }
    }
  }
LABEL_47:
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
}
// 96BAC: using guessed type int dword_96BAC;
// 18CA8: using guessed type char s[60];

//----- (0001936C) --------------------------------------------------------
void __fastcall sub_1936C(P_Wnd04BM pWnd4BM)
{
  double v2; // st7
  int v3; // eax
  int v4; // edx
  double Unknown_4F2A; // st7
  int v6; // ebp
  T_Vector3D *p_targetPosition; // edi
  double v8; // st7
  double v9; // st7
  T_Matrix3x4 *v10; // edx
  int v11; // ecx
  int v12; // ebx
  T_Vector3D *v13; // edi
  double v14; // st7
  double v15; // st7
  T_Matrix3x4 *v16; // edx
  int v17; // ecx
  int v18; // ebx
  int i; // ebp
  T_Vector3D v20[4]; // [esp+8h] [ebp-110h] BYREF
  T_Vector3D result; // [esp+38h] [ebp-E0h] BYREF
  T_Vector3D v; // [esp+44h] [ebp-D4h] BYREF
  T_Vector3D v23; // [esp+50h] [ebp-C8h] BYREF
  T_Vector3D v24[2]; // [esp+5Ch] [ebp-BCh] BYREF
  T_Vector3D v25; // [esp+74h] [ebp-A4h] BYREF
  T_Vector3D v26; // [esp+80h] [ebp-98h] BYREF
  float v27; // [esp+8Ch] [ebp-8Ch]
  T_Vector3D *v28; // [esp+90h] [ebp-88h]
  T_Vector3D *v29; // [esp+94h] [ebp-84h]
  int v30; // [esp+98h] [ebp-80h]
  float v31; // [esp+9Ch] [ebp-7Ch]
  T_Vector3D *v32; // [esp+A0h] [ebp-78h]
  T_Vector3D *v33; // [esp+A4h] [ebp-74h]
  int v34; // [esp+A8h] [ebp-70h]
  PANE *p_pane; // [esp+ACh] [ebp-6Ch]
  PANE *pane; // [esp+B0h] [ebp-68h]
  int v37; // [esp+B4h] [ebp-64h]
  T_Matrix3x4 *trs; // [esp+B8h] [ebp-60h]
  T_Matrix3x4 *p_trs; // [esp+BCh] [ebp-5Ch]
  LONG parm; // [esp+C0h] [ebp-58h]
  int v41; // [esp+C4h] [ebp-54h]
  float v42; // [esp+C8h] [ebp-50h]
  int v43; // [esp+CCh] [ebp-4Ch]
  int v44; // [esp+D0h] [ebp-48h]
  int v45; // [esp+D4h] [ebp-44h]
  int v46; // [esp+D8h] [ebp-40h]
  float v47; // [esp+DCh] [ebp-3Ch]
  T_Vector3D v48; // [esp+E0h] [ebp-38h]
  float v49; // [esp+ECh] [ebp-2Ch]
  WORD v50; // [esp+F0h] [ebp-28h] BYREF
  WORD outX; // [esp+F4h] [ebp-24h] BYREF
  WORD outY; // [esp+F8h] [ebp-20h] BYREF
  WORD v53[14]; // [esp+FCh] [ebp-1Ch] BYREF

  memset(&v, 0, sizeof(v));
  memset(&v23, 0, sizeof(v23));
  memset(&result, 0, sizeof(result));
  v2 = pWnd4BM->Unknown_4F2A * 0.5;
  v42 = v2;
  v42 = v2 * v42;
  v30 = (int)(pWnd4BM->Unknown_4F2A * 0.03125);
  v43 = v30 + 2;
  v3 = 0x20 * ((v30 + 2) / 2);
  v30 = (int)(pWnd4BM->Unknown_4F2A * 0.0062500001);
  v34 = v3 + 0x10;
  v4 = (v30 + 2) / 2;
  v37 = 0x68;
  parm = 0x61;
  v44 = 0xA0 * v4 + 0x10;
  if ( v44 > v3 + 0x10 )
  {
    v44 = 0xA0 * v4 - 0x90;
  }
  Unknown_4F2A = pWnd4BM->Unknown_4F2A;
  v45 = 0xFFFFFFFF;
  v41 = 0;
  if ( Unknown_4F2A < 960.0 )
  {
    v41 = 0xFFFFFFFF;
  }
  v6 = 0;
  v48.y = pWnd4BM->Unknown_4F16 * 0.125;
  v49 = (float)v34;
  if ( v43 > 0 )
  {
    p_targetPosition = &pWnd4BM->targetPosition;
    pane = &pWnd4BM->a2.pane;
    trs = &pWnd4BM->camera.trs;
    do
    {
      if ( (double)v44 == v49 )
      {
        v45 = v6;
      }
      v47 = v42 - v49 * v49;
      if ( v47 > 0.0 )
      {
        v47 = sqrt(v47);
        v.x = v49;
        v.y = v48.y;
        memset(&v24[1], 0, sizeof(T_Vector3D));
        v.z = v47;
        v23.x = v49;
        v27 = -v47;
        v23.y = v48.y;
        v23.z = v27;
        v29 = v24;
        v24[1].x = v49 + p_targetPosition->x;
        v24[1].y = v48.y + pWnd4BM->targetPosition.y;
        v8 = v47 + pWnd4BM->targetPosition.z;
        v24[0] = v24[1];
        v24[1].z = v8;
        v = v24[1];
        memset(&v20[3], 0, sizeof(T_Vector3D));
        v28 = &v25;
        v20[3].x = v49 + p_targetPosition->x;
        v20[3].y = v48.y + pWnd4BM->targetPosition.y;
        v9 = v27 + pWnd4BM->targetPosition.z;
        v25 = v20[3];
        v20[3].z = v9;
        v23 = v20[3];
        Q_M34xV_sub_53384(&v, trs, &result);
        v10 = trs;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->camera._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, &outX, &outY);
        Q_M34xV_sub_53384(&v23, v10, &result);
        v11 = v45;
        v12 = 0xFFFFFFFF;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->camera._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, v53, &v50);
        if ( v11 < 0 || (v6 - v11) % 5 )
        {
          if ( v41 )
          {
            v12 = v37;
          }
        }
        else
        {
          v12 = parm;
        }
        if ( v12 != 0xFFFFFFFF )
        {
          VFX_line_draw(pane, outX, outY, v53[0], v50, 0, v12);
        }
      }
      ++v6;
      v49 = v49 + -32.0;
    }
    while ( v6 < v43 );
  }
  v48.z = (float)v34;
  v46 = 0xFFFFFFFF;
  if ( v43 > 0 )
  {
    v13 = &pWnd4BM->targetPosition;
    p_pane = &pWnd4BM->a2.pane;
    p_trs = &pWnd4BM->camera.trs;
    for ( i = 0; i < v43; ++i )
    {
      if ( (double)v44 == v48.z )
      {
        v46 = i;
      }
      v48.x = v42 - v48.z * v48.z;
      if ( v48.x > 0.0 )
      {
        v48.x = sqrt(v48.x);
        v = v48;
        v31 = -v48.x;
        v23.x = v31;
        v23.y = v48.y;
        v23.z = v48.z;
        v32 = &v26;
        memset(&v20[2], 0, sizeof(T_Vector3D));
        v20[2].x = v48.x + v13->x;
        v20[2].y = v48.y + pWnd4BM->targetPosition.y;
        v14 = v48.z + pWnd4BM->targetPosition.z;
        v26 = v20[2];
        v20[2].z = v14;
        v = v20[2];
        memset(&v20[1], 0, sizeof(T_Vector3D));
        v33 = v20;
        v20[1].x = v31 + v13->x;
        v20[1].y = v48.y + pWnd4BM->targetPosition.y;
        v15 = v48.z + pWnd4BM->targetPosition.z;
        v20[0] = v20[1];
        v20[1].z = v15;
        v23 = v20[1];
        Q_M34xV_sub_53384(&v, p_trs, &result);
        v16 = p_trs;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->camera._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, &outX, &outY);
        Q_M34xV_sub_53384(&v23, v16, &result);
        v17 = v46;
        v18 = 0xFFFFFFFF;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->camera._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, v53, &v50);
        if ( v17 < 0 || (i - v17) % 5 )
        {
          if ( v41 )
          {
            v18 = v37;
          }
        }
        else
        {
          v18 = parm;
        }
        if ( v18 != 0xFFFFFFFF )
        {
          VFX_line_draw(p_pane, outX, outY, v53[0], v50, 0, v18);
        }
      }
      v48.z = v48.z + -32.0;
    }
  }
}

//----- (00019AE8) --------------------------------------------------------
void __fastcall sub_19AE8(P_Wnd04BM a1)
{
  __int16 v1; // ax
  double v2; // st7
  __int16 type; // bx
  int i; // ebp
  float v5[100]; // [esp+8h] [ebp-384h]
  __int16 screenY[100]; // [esp+198h] [ebp-1F4h] BYREF
  __int16 screenX[100]; // [esp+260h] [ebp-12Ch] BYREF
  T_Vector3D v8; // [esp+328h] [ebp-64h] BYREF
  T_Vector3D v9; // [esp+334h] [ebp-58h] BYREF
  T_Vector3D starCoord; // [esp+340h] [ebp-4Ch] BYREF
  T_Vector3D *v11; // [esp+34Ch] [ebp-40h]
  T_Matrix3x3 *a2; // [esp+350h] [ebp-3Ch]
  PANE *pane; // [esp+354h] [ebp-38h]
  T_WndA2 *pWndA2; // [esp+358h] [ebp-34h]
  WORD *a6; // [esp+35Ch] [ebp-30h]
  WORD *a5; // [esp+360h] [ebp-2Ch]
  P_Wnd04BM v17; // [esp+364h] [ebp-28h]
  int v18; // [esp+368h] [ebp-24h]
  int v19; // [esp+36Ch] [ebp-20h]
  __int16 v20; // [esp+370h] [ebp-1Ch]

  v17 = a1;
  memset(&starCoord, 0, sizeof(starCoord));
  pWndA2 = WinMgr.wnds[dword_96BAC].pWndA2;
  if ( !pWndA2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x8E7);
  }
  pane = &v17->a2.pane;
  a2 = (T_Matrix3x3 *)&v17->camera;
  a5 = screenX;
  v18 = 0;
  a6 = screenY;
  for ( i = 0; i < V_Game.starsNum; ++i )
  {
    starCoord = V_Game.stars[i].position;
    v11 = &v9;
    memset(&v8, 0, sizeof(v8));
    v8.x = starCoord.x - V_Game.pCurStar->position.x;
    v8.y = starCoord.y - V_Game.pCurStar->position.y;
    v2 = starCoord.z - V_Game.pCurStar->position.z;
    v9 = v8;
    v8.z = v2;
    starCoord = v8;
    v5[i] = 0.0;
    if ( Q_Vector3D_IsZero_sub_53078(&starCoord) == FALSE )
    {
      Q_M33xV_sub_53114(&starCoord, a2);
      v5[i] = starCoord.z;
      if ( v5[i] > 0.0 )
      {
        Q_Project3DTo2D_sub_533D4(&starCoord, v17->camera._scaleFactor, v17->_xOffset, v17->_yOffset, &screenX[i], &screenY[i]);
        type = V_Game.stars[i].type;
        v19 = (int)(sqrt(starCoord.y * starCoord.y + starCoord.x * starCoord.x + starCoord.z * starCoord.z) + -440.0);
        v20 = v19;
        v1 = 3;
        if ( (__int16)v19 <= 220 )
        {
          if ( v20 <= 0 )
          {
            if ( v20 > -220 )
            {
              v1 = 2;
            }
          }
          else
          {
            v1 = 1;
          }
        }
        else
        {
          v1 = 0;
        }
        VFX_shape_draw(pane, (void *)pWndA2[1].magic12345678, v1 + 4 * type, screenX[i], screenY[i]);
      }
    }
  }
}
// 96BAC: using guessed type int dword_96BAC;
// 19AE8: using guessed type WORD screenY[100];
// 19AE8: using guessed type float var_384[100];

//----- (00019E2C) --------------------------------------------------------
void __fastcall Q_Wnd04BM_Proc6_sub_19E2C(P_Wnd04BM pWnd, P_CFile pfi, BOOL read)
{
  T_Vector3D *vectors1; // edi
  P_Vector3D v5; // edx
  T_Camera *v6; // edx
  T_Camera *v7; // edx
  T_Camera *v8; // edx
  T_Matrix3x3 *v9; // edx
  float *v10; // edx
  float *v11; // edx
  T_Vector3D *v12; // edx
  T_Vector3D v13[100]; // [esp+0h] [ebp-3460h] BYREF
  char v14[3600]; // [esp+4B0h] [ebp-2FB0h] BYREF
  char v15[400]; // [esp+12C0h] [ebp-21A0h] BYREF
  T_Vector3D v16[101]; // [esp+1450h] [ebp-2010h] BYREF
  T_Camera v17; // [esp+190Ch] [ebp-1B54h] BYREF
  float x; // [esp+19A4h] [ebp-1ABCh]
  float y; // [esp+19A8h] [ebp-1AB8h]
  float z; // [esp+19ACh] [ebp-1AB4h]
  T_Vector3D vector1; // [esp+19B0h] [ebp-1AB0h] BYREF
  T_Vector3D v22; // [esp+19BCh] [ebp-1AA4h] BYREF
  T_Vector3D v23; // [esp+19C8h] [ebp-1A98h] BYREF
  float Unknown_4F0E; // [esp+19D4h] [ebp-1A8Ch]
  float Unknown_4F12; // [esp+19D8h] [ebp-1A88h]
  float Unknown_4F16; // [esp+19DCh] [ebp-1A84h]
  float Unknown_4F1A; // [esp+19E0h] [ebp-1A80h]
  int Unknown_4F1E; // [esp+19E4h] [ebp-1A7Ch]
  __int16 xOffset; // [esp+19E8h] [ebp-1A78h]
  __int16 yOffset; // [esp+19EAh] [ebp-1A76h]
  float Unknown_4F26; // [esp+19ECh] [ebp-1A74h]
  float Unknown_4F2A; // [esp+19F0h] [ebp-1A70h]
  int Unknown_503A; // [esp+19F4h] [ebp-1A6Ch]
  int Unknown_503E; // [esp+19F8h] [ebp-1A68h]
  int Unknown_5042; // [esp+19FCh] [ebp-1A64h]
  int Unknown_5046; // [esp+1A00h] [ebp-1A60h]
  int Unknown_504A; // [esp+1A04h] [ebp-1A5Ch]
  T_Vector3D array[100]; // [esp+1A08h] [ebp-1A58h] BYREF
  char result[3600]; // [esp+1EB8h] [ebp-15A8h] BYREF
  char v40[400]; // [esp+2CC8h] [ebp-798h] BYREF
  T_Vector3D a1[101]; // [esp+2E58h] [ebp-608h] BYREF
  T_Camera v42; // [esp+3314h] [ebp-14Ch] BYREF
  float v43; // [esp+33ACh] [ebp-B4h]
  float v44; // [esp+33B0h] [ebp-B0h]
  float v45; // [esp+33B4h] [ebp-ACh]
  T_Vector3D v46; // [esp+33B8h] [ebp-A8h] BYREF
  T_Vector3D v47; // [esp+33C4h] [ebp-9Ch] BYREF
  T_Vector3D v48; // [esp+33D0h] [ebp-90h] BYREF
  float v49; // [esp+33DCh] [ebp-84h]
  float v50; // [esp+33E0h] [ebp-80h]
  float v51; // [esp+33E4h] [ebp-7Ch]
  float v52; // [esp+33E8h] [ebp-78h]
  int v53; // [esp+33ECh] [ebp-74h]
  __int16 v54; // [esp+33F0h] [ebp-70h]
  __int16 v55; // [esp+33F2h] [ebp-6Eh]
  float v56; // [esp+33F4h] [ebp-6Ch]
  float v57; // [esp+33F8h] [ebp-68h]
  int v58; // [esp+33FCh] [ebp-64h]
  int v59; // [esp+3400h] [ebp-60h]
  int v60; // [esp+3404h] [ebp-5Ch]
  int v61; // [esp+3408h] [ebp-58h]
  int v62; // [esp+340Ch] [ebp-54h]
  P_CFile pfi_; // [esp+3410h] [ebp-50h]
  T_Type16 *someFloats; // [esp+3414h] [ebp-4Ch]
  int *Unknown_137E; // [esp+3418h] [ebp-48h]
  T_Vector3D *vectors2; // [esp+341Ch] [ebp-44h]
  float *v67; // [esp+3420h] [ebp-40h]
  float *v68; // [esp+3424h] [ebp-3Ch]
  T_Vector3D *p_vector2; // [esp+3428h] [ebp-38h]
  T_Vector3D *p_vector3; // [esp+342Ch] [ebp-34h]
  T_Vector3D *p_position; // [esp+3430h] [ebp-30h]
  T_Vector3D *v72; // [esp+3434h] [ebp-2Ch]
  T_Vector3D *v73; // [esp+3438h] [ebp-28h]
  T_Matrix3x3D *p_matrix_4EEA; // [esp+343Ch] [ebp-24h]
  T_Vector3D *p_vector_4EDE; // [esp+3440h] [ebp-20h]
  T_Matrix3x3 *p_viewMatrix; // [esp+3444h] [ebp-1Ch]
  P_Vector3D pTargetPosition; // [esp+3448h] [ebp-18h]
  T_Camera *p_camera; // [esp+344Ch] [ebp-14h]

  pfi_ = pfi;
  p_matrix_4EEA = &pWnd->matrix_4EEA;
  p_vector_4EDE = &pWnd->vector_4EDE;
  p_camera = &pWnd->camera;
  pTargetPosition = &pWnd->targetPosition;
  vectors2 = pWnd->vectors2;
  Unknown_137E = pWnd->Unknown_137E;
  vectors1 = pWnd->vectors1;
  someFloats = pWnd->someFloats;
  p_vector3 = &pWnd->matrix_4EEA.vector3;
  p_vector2 = &pWnd->matrix_4EEA.vector2;
  p_viewMatrix = &pWnd->camera._viewMatrix;
  p_position = &pWnd->camera.position;
  v72 = &pWnd->camera.matrix_00.vector3;
  v73 = &pWnd->camera.matrix_00.vector2;
  v68 = pWnd->camera._viewMatrix._[2];
  v67 = pWnd->camera._viewMatrix._[1];
  if ( read == TRUE )
  {
    _wcpp_2_ctor_array_(array, 0x64u, &C_Vector3D);
    _wcpp_2_ctor_array_(result, 0x64u, &C_Type16);
    _wcpp_2_ctor_array_(a1, 0x64u, &C_Vector3D);
    memset(&a1[0x64], 0, sizeof(T_Vector3D));
    Q_Camera_ResetToIdentity_sub_1B4F0(&v42);
    v44 = 0.0;
    v45 = 0.0;
    v43 = 0.0;
    Q_Vector3D_Clear_sub_1ACA0(&v46);
    Q_Vector3D_Clear_sub_1ACA0(&v47);
    Q_Vector3D_Clear_sub_1ACA0(&v48);
    Q_Vector3D_FromInt_sub_1AC70(&v46, 1, 0, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v47, 0, 1, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v48, 0, 0, 1);
    Q_CFile_Read_sub_1BF94(pfi_, array, 0x1A08u);
    qmemcpy(vectors1, array, 0x4B0u);
    qmemcpy(someFloats, result, 0xE10u);
    qmemcpy(Unknown_137E, v40, 0x190u);
    v5 = pTargetPosition;
    qmemcpy(vectors2, a1, 0x4B0u);
    *v5 = a1[0x64];
    v6 = p_camera;
    p_camera->matrix_00.vector1.x = v42.matrix_00.vector1.x;
    v6->matrix_00.vector1.y = v42.matrix_00.vector1.y;
    v6->matrix_00.vector1.z = v42.matrix_00.vector1.z;
    *v73 = v42.matrix_00.vector2;
    *v72 = v42.matrix_00.vector3;
    v7 = p_camera;
    p_camera->FOV = v42.FOV;
    v7->_scaleFactor = v42._scaleFactor;
    v7->nearClip = v42.nearClip;
    v7->farClip = v42.farClip;
    *p_position = v42.position;
    v8 = p_camera;
    p_camera->trs = v42.trs;
    v8->_projectionScale = v42._projectionScale;
    v9 = p_viewMatrix;
    p_viewMatrix->_[0][0] = v42._viewMatrix._[0][0];
    v9->_[0][1] = v42._viewMatrix._[0][1];
    v9->_[0][2] = v42._viewMatrix._[0][2];
    v10 = v67;
    *v67 = v42._viewMatrix._[1][0];
    v10[1] = v42._viewMatrix._[1][1];
    v10[2] = v42._viewMatrix._[1][2];
    v11 = v68;
    *v68 = v42._viewMatrix._[2][0];
    v11[1] = v42._viewMatrix._[2][1];
    v11[2] = v42._viewMatrix._[2][2];
    v12 = p_vector_4EDE;
    p_vector_4EDE->x = v43;
    v12->y = v44;
    v12->z = v45;
    p_matrix_4EEA->vector1 = v46;
    *p_vector2 = v47;
    *p_vector3 = v48;
    pWnd->Unknown_4F0E = v49;
    pWnd->Unknown_4F12 = v50;
    pWnd->Unknown_4F16 = v51;
    pWnd->Unknown_4F1A = v52;
    pWnd->Unknown_4F1E = v53;
    pWnd->_xOffset = v54;
    pWnd->_yOffset = v55;
    pWnd->Unknown_4F26 = v56;
    pWnd->Unknown_4F2A = v57;
    pWnd->Unknown_503A = v58;
    pWnd->Unknown_503E = v59;
    pWnd->Unknown_5042 = v60;
    pWnd->Unknown_5046 = v61;
    pWnd->Unknown_504A = v62;
    Q_Ret_sub_1B66C();
    Q_DestructVectors_sub_1A9E0(a1);
    sub_1AA00(result);
    Q_DestructVectors_sub_1A9E0(array);
  }
  else
  {
    _wcpp_2_ctor_array_(v13, 0x64u, &C_Vector3D);
    _wcpp_2_ctor_array_(v14, 0x64u, &C_Type16);
    _wcpp_2_ctor_array_(v16, 0x64u, &C_Vector3D);
    memset(&v16[0x64], 0, sizeof(T_Vector3D));
    Q_Camera_ResetToIdentity_sub_1B4F0(&v17);
    y = 0.0;
    z = 0.0;
    x = 0.0;
    Q_Vector3D_Clear_sub_1ACA0(&vector1);
    Q_Vector3D_Clear_sub_1ACA0(&v22);
    Q_Vector3D_Clear_sub_1ACA0(&v23);
    Q_Vector3D_FromInt_sub_1AC70(&vector1, 1, 0, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v22, 0, 1, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v23, 0, 0, 1);
    qmemcpy(v13, vectors1, sizeof(v13));
    qmemcpy(v14, someFloats, sizeof(v14));
    qmemcpy(v15, Unknown_137E, sizeof(v15));
    qmemcpy(v16, vectors2, 0x4B0u);
    v16[0x64] = *pTargetPosition;
    v17.matrix_00.vector1.x = p_camera->matrix_00.vector1.x;
    v17.matrix_00.vector1.y = p_camera->matrix_00.vector1.y;
    v17.matrix_00.vector1.z = p_camera->matrix_00.vector1.z;
    v17.matrix_00.vector2 = *v73;
    v17.matrix_00.vector3 = *v72;
    v17.FOV = p_camera->FOV;
    v17._scaleFactor = p_camera->_scaleFactor;
    v17.nearClip = p_camera->nearClip;
    v17.farClip = p_camera->farClip;
    v17.position = *p_position;
    v17.trs = p_camera->trs;
    v17._projectionScale = p_camera->_projectionScale;
    v17._viewMatrix._[0][0] = p_viewMatrix->_[0][0];
    v17._viewMatrix._[0][1] = p_viewMatrix->_[0][1];
    v17._viewMatrix._[0][2] = p_viewMatrix->_[0][2];
    v17._viewMatrix._[1][0] = *v67;
    v17._viewMatrix._[1][1] = v67[1];
    v17._viewMatrix._[1][2] = v67[2];
    v17._viewMatrix._[2][0] = *v68;
    v17._viewMatrix._[2][1] = v68[1];
    v17._viewMatrix._[2][2] = v68[2];
    x = p_vector_4EDE->x;
    y = p_vector_4EDE->y;
    z = p_vector_4EDE->z;
    vector1 = p_matrix_4EEA->vector1;
    v22 = *p_vector2;
    v23 = *p_vector3;
    Unknown_4F0E = pWnd->Unknown_4F0E;
    Unknown_4F12 = pWnd->Unknown_4F12;
    Unknown_4F16 = pWnd->Unknown_4F16;
    Unknown_4F1A = pWnd->Unknown_4F1A;
    Unknown_4F1E = pWnd->Unknown_4F1E;
    xOffset = pWnd->_xOffset;
    yOffset = pWnd->_yOffset;
    Unknown_4F26 = pWnd->Unknown_4F26;
    Unknown_4F2A = pWnd->Unknown_4F2A;
    Unknown_503A = pWnd->Unknown_503A;
    Unknown_503E = pWnd->Unknown_503E;
    Unknown_5042 = pWnd->Unknown_5042;
    Unknown_5046 = pWnd->Unknown_5046;
    Unknown_504A = pWnd->Unknown_504A;
    Q_CFile_Write_sub_1C098(pfi_, v13, 0x1A08u);
    Q_Ret_sub_1B66C();
    Q_DestructVectors_sub_1A9E0(v16);
    sub_1AA00(v14);
    Q_DestructVectors_sub_1A9E0(v13);
  }
}

//----- (0001A9C0) --------------------------------------------------------
void __fastcall __spoils<edx> sub_1A9C0(void *result)
{
  _wcpp_2_dtor_array_(result, 15, &C_Vector3D);
}

//----- (0001A9E0) --------------------------------------------------------
void __fastcall __spoils<edx> Q_DestructVectors_sub_1A9E0(P_Vector3D a1)
{
  _wcpp_2_dtor_array_(a1, 100, &C_Vector3D);
}

//----- (0001AA00) --------------------------------------------------------
void __fastcall __spoils<edx> sub_1AA00(void *result)
{
  _wcpp_2_dtor_array_(result, 100, &C_Type16);
}

//----- (0001AA20) --------------------------------------------------------
void *__fastcall Q_NC_sub_1AA20(void *result)
{
  _wcpp_2_dtor_array_(result, 4, &C_Vector3D);
  return result;
}

//----- (0001AA40) --------------------------------------------------------
void __fastcall Q_Type16_Copy_sub_1AA40(P_Type16 dst, P_Type16 src)
{
  *dst = *src;
}

//----- (0001AA90) --------------------------------------------------------
void __fastcall __spoils<edx> sub_1AA90(P_Type1 self, unsigned int a2)
{
  Q_Ret_sub_1B66C();
  Q_DestructVectors_sub_1A9E0(self->vectors2);
  sub_1AA00(self->t16);
  Q_DestructVectors_sub_1A9E0(self->vectors1);
}

//----- (0001AAC0) --------------------------------------------------------
P_Type1 __fastcall sub_1AAC0(P_Type1 result)
{
  _wcpp_2_ctor_array_(result, 100u, &C_Vector3D);
  _wcpp_2_ctor_array_(result->t16, 100u, &C_Type16);
  _wcpp_2_ctor_array_(result->vectors2, 100u, &C_Vector3D);
  result->Unknown_1900 = 0;
  result->Unknown_1904 = 0;
  result->Unknown_1908 = 0;
  Q_Camera_ResetToIdentity_sub_1B4F0(&result->pCamera);
  result->z2[0] = 0.0;
  result->z2[1] = 0.0;
  result->z2[2] = 0.0;
  result->z2[3] = 0.0;
  result->z2[4] = 0.0;
  result->z2[5] = 0.0;
  result->z2[6] = 0.0;
  result->z2[7] = 0.0;
  result->z2[8] = 0.0;
  result->z2[9] = 0.0;
  result->z2[0xA] = 0.0;
  result->z2[0xB] = 0.0;
  result->z2[4] = 0.0;
  result->z2[5] = 0.0;
  result->z2[3] = 1.0;
  result->z2[6] = 0.0;
  result->z2[7] = 1.0;
  result->z2[8] = 0.0;
  result->z2[9] = 0.0;
  result->z2[0xA] = 0.0;
  result->z2[0xB] = 1.0;
  return result;
}

//----- (0001ABE0) --------------------------------------------------------
void __fastcall __spoils<> Q_Type16_Ctor_sub_1ABE0(P_Type16 a1)
{
  a1->Unknown_00 = 0.0;
  a1->Unknown_04 = 0.0;
  a1->Unknown_08 = 0.0;
  a1->Unknown_0C = 0.0;
  a1->Unknown_10 = 0.0;
  a1->Unknown_14 = 0.0;
  a1->Unknown_18 = 0.0;
  a1->Unknown_1C = 0.0;
  a1->Unknown_20 = 0.0;
  a1->Unknown_04 = 0.0;
  a1->Unknown_08 = 0.0;
  a1->Unknown_00 = 1.0;
  a1->Unknown_0C = 0.0;
  a1->Unknown_10 = 1.0;
  a1->Unknown_14 = 0.0;
  a1->Unknown_18 = 0.0;
  a1->Unknown_1C = 0.0;
  a1->Unknown_20 = 1.0;
}

//----- (0001AC70) --------------------------------------------------------
void __fastcall Q_Vector3D_FromInt_sub_1AC70(P_Vector3D a1, int x, int y, int z)
{
  a1->x = (float)x;
  a1->y = (float)y;
  a1->z = (float)z;
}

//----- (0001ACA0) --------------------------------------------------------
void __fastcall Q_Vector3D_Clear_sub_1ACA0(P_Vector3D a1)
{
  a1->x = 0.0;
  a1->y = 0.0;
  a1->z = 0.0;
}

//----- (0001ACC0) --------------------------------------------------------
void __fastcall __spoils<> Q_Cache_Init_sub_1ACC0(P_Cache a1)
{
  a1->pShapeCache = 0;
  a1->size = 0;
  a1->count = 0;
  a1->activeCount = 0;
  Q_Cache_Lock_sub_1ACE8(a1);
}

//----- (0001ACE8) --------------------------------------------------------
void __fastcall __spoils<> Q_Cache_Lock_sub_1ACE8(P_Cache a1)
{
  a1->locked = TRUE;
}

//----- (0001ACF4) --------------------------------------------------------
void __fastcall __spoils<> sub_1ACF4(P_Cache a1)
{
  Q_RemoveWinDataFromWinMgr_sub_262CC(a1->pShapeCache);
  a1->pShapeCache = 0;
  a1->size = 0;
}

//----- (0001AD1C) --------------------------------------------------------
void __fastcall Q_Cache_RegisterShapeCache_sub_1AD1C(P_Cache a1, int a2)
{
  void *v3; // eax
  int i; // kr04_4
  int size; // [esp+0h] [ebp-4h]

  size = a2 + 3;
  LOBYTE(size) = (a2 + 3) & 0xFC;
  v3 = operator new[](size);
  Q_RegisterDataInWinMgr_sub_2625C(v3, 5, "SHAPE CACHE");
  a1->pShapeCache = v3;
  if ( !v3 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x41);
  }
  a1->count = 0;
  a1->activeCount = 0;
  a1->size = size;
  for ( i = 0; i != 0xC8; ++i )
  {
    a1->_pointers[i] = 0;
    a1->names[i][0] = 0;
    a1->sizes[i] = 0;
  }
}

//----- (0001ADAC) --------------------------------------------------------
int __fastcall Q_Cache_AddFile_sub_1ADAC(P_Cache pCache, const char *filename)
{
  int len; // kr04_4
  int index; // edx

  if ( !pCache->pShapeCache )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x53);
  }
  len = strlen(filename) + 1;
  if ( len - 1 <= 0 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x59);
  }
  if ( len - 1 >= 50 )
  {
    sub_2620C("Cache filename too long: %s", filename);
    Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0x5B);
  }
  if ( pCache->count >= 200 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x5C);
  }
  for ( index = 0; index < 200; ++index )
  {
    if ( !pCache->names[index][0] )
    {
      strcpy(pCache->names[index], filename);
      ++pCache->count;
      return index;
    }
  }
  return 0xFFFF;
}

//----- (0001AEB0) --------------------------------------------------------
unsigned int __fastcall sub_1AEB0(P_Cache pCache, UWORD index, char *filename)
{
  unsigned int v4; // kr04_4
  int index_; // eax
  unsigned int result; // eax

  if ( !pCache->pShapeCache )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x70);
  }
  v4 = strlen(filename) + 1;
  if ( (int)(v4 - 1) <= 0 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x74);
  }
  if ( (int)(v4 - 1) >= 50 )
  {
    sub_2620C("Cache filename too long: %s", filename);
    Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0x76);
  }
  if ( pCache->count >= 200 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x77);
  }
  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x78);
  }
  index_ = index;
  if ( pCache->names[index_][0] )
  {
    if ( !stricmp(filename, pCache->names[index_]) )
    {
      return 0xFFFFFFFF;
    }
    Q_Cache_RemoveItem_sub_1B000(pCache, index);
  }
  strcpy(pCache->names[index], filename);
  result = 0xFFFFFFFF;
  ++pCache->count;
  return result;
}

//----- (0001B000) --------------------------------------------------------
void __fastcall Q_Cache_RemoveItem_sub_1B000(P_Cache pCache, UWORD index)
{
  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x95);
  }
  if ( !pCache->names[index][0] )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x96);
  }
  Q_Cache_RemoveEntry_sub_1B354(pCache, index);
  pCache->names[index][0] = 0;
  --pCache->count;
}

//----- (0001B084) --------------------------------------------------------
void *__fastcall Q_Cache_GetShapeTable_sub_1B084(P_Cache pCache, UWORD index)
{
  __int16 v4; // edx^2
  int fileLength; // eax
  int fileLength4; // ecx
  int v7; // ebx
  void *v8; // edx
  int v10; // kr10_4
  int activeCount; // ebx
  int j; // kr0C_4
  int i; // eax
  T_CFile fi; // [esp+0h] [ebp-12Ch] BYREF

  if ( !pCache->locked )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0xA2);
  }
  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0xA6);
  }
  if ( !pCache->names[index][0] )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0xA7);
  }
  if ( pCache->_pointers[index] )
  {
    for ( i = 0; i < pCache->activeCount && index != pCache->usageOrder[i]; ++i )
    {
      ;
    }
    v10 = i;
    for ( j = 0; ; ++j )
    {
      activeCount = pCache->activeCount;
      if ( i >= activeCount )
      {
        break;
      }
      ++i;
      pCache->usageOrder[v10 + j] = pCache->usageOrder[v10 + 1 + j];
    }
    *((_WORD *)&pCache->sizes[199] + activeCount + 1) = index;
    return pCache->_pointers[index];
  }
  else
  {
    Q_CFile_Ctor_sub_1BB78(&fi);
    Q_CFile_Open_sub_1BBFC(&fi, pCache->names[index], O_BINARY, 0);
    fileLength = Q_CFile_GetLength_sub_1BE28(&fi);
    fileLength4 = fileLength + 3;
    LOBYTE(fileLength4) = (fileLength + 3) & 0xFC;
    if ( fileLength4 >= pCache->size )
    {
      v4 = 0;
      sub_2620C("Single item too big for cache: %s, %d", pCache->names[index], fileLength4);
      Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0xB8);
    }
    v7 = index;
    pCache->_pointers[index] = sub_1B2DC(pCache, fileLength4);
    v8 = pCache->_pointers[index];
    pCache->sizes[index] = fileLength4;
    if ( !Q_CFile_Load_sub_1BF1C(&fi, v8) )
    {
      sub_2620C("Cache unable to load file: %s", pCache->names[v7]);
      Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0xC0);
    }
    pCache->usageOrder[pCache->activeCount++] = index;
    Q_CFile_Dtor_sub_1BBC8(&fi);
    return pCache->_pointers[index];
  }
}

//----- (0001B270) --------------------------------------------------------
int __fastcall Q_Cache_GetItemIndex_sub_1B270(P_Cache pCache, const char *filename, int addIfNotFound)
{
  T_Name50 *names; // kr00_4
  int i; // ecx
  int index; // [esp+0h] [ebp-14h]

  names = pCache->names;
  index = 0xFFFF;
  for ( i = 0; i < pCache->count; ++i )
  {
    if ( !stricmp(filename, names[i]) )
    {
      index = i;
      break;
    }
  }
  if ( addIfNotFound == TRUE && (unsigned __int16)index == 0xFFFF )
  {
    return Q_Cache_AddFile_sub_1ADAC(pCache, filename);
  }
  return index;
}

//----- (0001B2DC) --------------------------------------------------------
char *__fastcall sub_1B2DC(P_Cache a1, int size)
{
  int v4; // esi
  int i; // kr04_4
  char *result; // eax
  int v7; // esi
  UWORD v8; // dx
  int j; // edi

  v4 = 0;
  for ( i = 0; i != 0xC8; ++i )
  {
    v4 += a1->sizes[i];
  }
  result = (char *)a1->pShapeCache + v4;
  v7 = a1->size - v4;
  for ( j = 0; v7 <= size; result = Q_Cache_RemoveEntry_sub_1B354(a1, v8) )
  {
    if ( j >= a1->count )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0xFF);
    }
    v8 = a1->usageOrder[0];
    v7 += a1->sizes[v8];
    ++j;
  }
  return result;
}

//----- (0001B354) --------------------------------------------------------
// Removes a cache entry at the given index and compacts remaining data
// Returns pointer to the new end of used memory, or NULL if entry was empty
char *__fastcall Q_Cache_RemoveEntry_sub_1B354(P_Cache pCache, UWORD index)
{
  int totalUsedSize; // edx
  int i; // kr04_4
  void *freedPtr; // edx
  _BYTE *offsetPtr; // ebx
  int j; // kr0C_4
  int v9; // kr20_4
  int v10; // kr1C_4
  int searchIndex; // eax
  void **entryPtr; // [esp+0h] [ebp-20h]
  char *oldMemEnd; // [esp+4h] [ebp-1Ch]
  char *newMemEnd; // [esp+4h] [ebp-1Ch]

  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x10D);
  }
  if ( !pCache->_pointers[index] )
  {
    return 0;
  }
  // Calculate total used size by summing all entry sizes
  totalUsedSize = 0;
  for ( i = 0; i != 0xC8; ++i )
  {
    totalUsedSize += pCache->sizes[i];
  }
  // Calculate current end of used memory
  oldMemEnd = (char *)pCache->pShapeCache + totalUsedSize;
  // Get references to the entry being removed
  entryPtr = &pCache->_pointers[index];
  freedPtr = *entryPtr;
  offsetPtr = entryPtr[200];
  // Compact memory: move data after our entry up to fill the gap
  qmemcpy(*entryPtr, &offsetPtr[(_DWORD)*entryPtr], oldMemEnd - &offsetPtr[(_DWORD)*entryPtr]);
  *entryPtr = 0;
  entryPtr[200] = 0;
  // Adjust pointers for entries that were after the removed one
  for ( j = 0; j != 0xC8; ++j )
  {
    if ( freedPtr < pCache->_pointers[j] )
    {
      // Shift pointer back by the size of removed entry
      pCache->_pointers[j] = (void *)((char *)pCache->_pointers[j] - offsetPtr);
    }
  }
  newMemEnd = (char *)(oldMemEnd - offsetPtr);
  // Decrement active entry counter
  --pCache->activeCount;
  // Find and remove the index from the usage tracking array
  for ( searchIndex = 0; searchIndex < pCache->activeCount && index != pCache->usageOrder[searchIndex]; ++searchIndex )
  {
    ;
  }
  v9 = searchIndex;
  v10 = 0;
  while ( searchIndex < pCache->activeCount )
  {
    ++searchIndex;
    pCache->usageOrder[v9 + v10] = pCache->usageOrder[v9 + 1 + v10];
    ++v10;
  }
  return newMemEnd;
}
/* Orphan comments:
Shift remaining entries down to fill the gap
*/

//----- (0001B498) --------------------------------------------------------
void __fastcall Q_Cache_Clear_sub_1B498(P_Cache pCache)
{
  int i; // edx

  for ( i = 0; i < pCache->count; ++i )
  {
    pCache->_pointers[i] = 0;
    pCache->sizes[i] = 0;
  }
  pCache->activeCount = 0;
}

//----- (0001B4D0) --------------------------------------------------------
void __fastcall Q_Cache_Free_sub_1B4D0(P_Cache pCache)
{
  Q_Cache_Clear_sub_1B498(pCache);
  pCache->locked = FALSE;
}

//----- (0001B4F0) --------------------------------------------------------
void __fastcall __spoils<> Q_Camera_ResetToIdentity_sub_1B4F0(P_Camera pCamera)
{
  pCamera->matrix_00.vector1.x = 0.0;
  pCamera->matrix_00.vector1.y = 0.0;
  pCamera->matrix_00.vector1.z = 0.0;
  pCamera->matrix_00.vector2.x = 0.0;
  pCamera->matrix_00.vector2.y = 0.0;
  pCamera->matrix_00.vector2.z = 0.0;
  pCamera->matrix_00.vector3.x = 0.0;
  pCamera->matrix_00.vector3.y = 0.0;
  pCamera->matrix_00.vector3.z = 0.0;
  pCamera->matrix_00.vector1.y = 0.0;
  pCamera->matrix_00.vector1.z = 0.0;
  pCamera->matrix_00.vector1.x = 1.0;
  pCamera->matrix_00.vector2.x = 0.0;
  pCamera->matrix_00.vector2.y = 1.0;
  pCamera->matrix_00.vector2.z = 0.0;
  pCamera->matrix_00.vector3.x = 0.0;
  pCamera->matrix_00.vector3.y = 0.0;
  pCamera->matrix_00.vector3.z = 1.0;
  pCamera->position.x = 0.0;
  pCamera->position.y = 0.0;
  pCamera->position.z = 0.0;
  pCamera->trs._[2][2] = 1.0;
  pCamera->trs._[2][3] = 0.0;
  pCamera->trs._[1][1] = pCamera->trs._[2][2];
  pCamera->trs._[0][0] = pCamera->trs._[1][1];
  pCamera->trs._[2][1] = pCamera->trs._[2][3];
  pCamera->trs._[2][0] = pCamera->trs._[2][1];
  pCamera->trs._[1][3] = pCamera->trs._[2][0];
  pCamera->trs._[1][2] = pCamera->trs._[1][3];
  pCamera->trs._[1][0] = pCamera->trs._[1][2];
  pCamera->trs._[0][3] = pCamera->trs._[1][0];
  pCamera->trs._[0][2] = pCamera->trs._[0][3];
  pCamera->trs._[0][1] = pCamera->trs._[0][2];
  pCamera->_viewMatrix._[0][0] = 0.0;
  pCamera->_viewMatrix._[0][1] = 0.0;
  pCamera->_viewMatrix._[0][2] = 0.0;
  pCamera->_viewMatrix._[1][0] = 0.0;
  pCamera->_viewMatrix._[1][1] = 0.0;
  pCamera->_viewMatrix._[1][2] = 0.0;
  pCamera->_viewMatrix._[2][1] = 0.0;
  pCamera->_viewMatrix._[2][2] = 0.0;
  pCamera->_viewMatrix._[2][0] = 0.0;
  pCamera->_viewMatrix._[0][0] = 1.0;
  pCamera->_viewMatrix._[0][1] = 0.0;
  pCamera->_viewMatrix._[0][2] = 0.0;
  pCamera->_viewMatrix._[1][0] = 0.0;
  pCamera->_viewMatrix._[1][1] = 1.0;
  pCamera->_viewMatrix._[1][2] = 0.0;
  pCamera->_viewMatrix._[2][0] = 0.0;
  pCamera->_viewMatrix._[2][1] = 0.0;
  pCamera->_viewMatrix._[2][2] = 1.0;
}

//----- (0001B670) --------------------------------------------------------
void __fastcall Q_Camera_ResetAndInit_sub_1B670(P_Camera pCamera, float fov, float nearClip, float farClip, int viewportDimension)
{
  pCamera->matrix_00.vector1.x = 0.0;
  pCamera->matrix_00.vector1.y = 0.0;
  pCamera->matrix_00.vector1.z = 0.0;
  pCamera->matrix_00.vector2.x = 0.0;
  pCamera->matrix_00.vector2.y = 0.0;
  pCamera->matrix_00.vector2.z = 0.0;
  pCamera->matrix_00.vector3.x = 0.0;
  pCamera->matrix_00.vector3.y = 0.0;
  pCamera->matrix_00.vector3.z = 0.0;
  pCamera->matrix_00.vector1.y = 0.0;
  pCamera->matrix_00.vector1.z = 0.0;
  pCamera->matrix_00.vector1.x = 1.0;
  pCamera->matrix_00.vector2.x = 0.0;
  pCamera->matrix_00.vector2.y = 1.0;
  pCamera->matrix_00.vector2.z = 0.0;
  pCamera->matrix_00.vector3.x = 0.0;
  pCamera->matrix_00.vector3.y = 0.0;
  pCamera->matrix_00.vector3.z = 1.0;
  pCamera->position.x = 0.0;
  pCamera->position.y = 0.0;
  pCamera->position.z = 0.0;
  pCamera->trs._[2][2] = 1.0;
  pCamera->trs._[2][3] = 0.0;
  pCamera->trs._[1][1] = pCamera->trs._[2][2];
  pCamera->trs._[0][0] = pCamera->trs._[1][1];
  pCamera->trs._[2][1] = pCamera->trs._[2][3];
  pCamera->trs._[2][0] = pCamera->trs._[2][1];
  pCamera->trs._[1][3] = pCamera->trs._[2][0];
  pCamera->trs._[1][2] = pCamera->trs._[1][3];
  pCamera->trs._[1][0] = pCamera->trs._[1][2];
  pCamera->trs._[0][3] = pCamera->trs._[1][0];
  pCamera->trs._[0][2] = pCamera->trs._[0][3];
  pCamera->trs._[0][1] = pCamera->trs._[0][2];
  pCamera->_viewMatrix._[0][0] = 0.0;
  pCamera->_viewMatrix._[0][1] = 0.0;
  pCamera->_viewMatrix._[0][2] = 0.0;
  pCamera->_viewMatrix._[1][0] = 0.0;
  pCamera->_viewMatrix._[1][1] = 0.0;
  pCamera->_viewMatrix._[1][2] = 0.0;
  pCamera->_viewMatrix._[2][1] = 0.0;
  pCamera->_viewMatrix._[2][2] = 0.0;
  pCamera->_viewMatrix._[2][0] = 0.0;
  pCamera->_viewMatrix._[0][0] = 1.0;
  pCamera->_viewMatrix._[0][1] = 0.0;
  pCamera->_viewMatrix._[0][2] = 0.0;
  pCamera->_viewMatrix._[1][0] = 0.0;
  pCamera->_viewMatrix._[1][1] = 1.0;
  pCamera->_viewMatrix._[1][2] = 0.0;
  pCamera->_viewMatrix._[2][0] = 0.0;
  pCamera->_viewMatrix._[2][1] = 0.0;
  pCamera->_viewMatrix._[2][2] = 1.0;
  Q_Camera_InitializeProjection_sub_1B808(pCamera, fov, nearClip, farClip, viewportDimension);
}

//----- (0001B808) --------------------------------------------------------
void __userpurge Q_Camera_InitializeProjection_sub_1B808(
        P_Camera a1@<eax>,
        float fov,
        float nearClip,
        float farClip,
        int viewportDimension)
{
  a1->FOV = fov;
  a1->nearClip = nearClip;
  a1->farClip = farClip;
  a1->_projectionScale = 1.0;
  Q_Camera_CalcPerspectiveScaleFactor_sub_1B834(a1, viewportDimension);
}

//----- (0001B834) --------------------------------------------------------
// Calculates perspective projection scale factor
void __fastcall Q_Camera_CalcPerspectiveScaleFactor_sub_1B834(P_Camera pCamera, int viewportDimension)
{
  // Convert FOV from degrees to radians, take half, compute tangent
  // Then calculate: scale = viewport_dimension / tan(half_fov_radians)
  pCamera->_scaleFactor = (double)viewportDimension / tan(pCamera->FOV * 0.017453292 * 0.5);
}

//----- (0001B864) --------------------------------------------------------
void __fastcall __spoils<> Q_Camera_BuildTransform_sub_1B864(P_Camera pCamera)
{
  double v1; // st7
  T_Matrix3x3 viewMatrix; // [esp+0h] [ebp-70h] BYREF
  T_Matrix3x3 a; // [esp+24h] [ebp-4Ch] BYREF
  T_Vector3D v4; // [esp+48h] [ebp-28h] BYREF
  T_Vector3D v; // [esp+54h] [ebp-1Ch] BYREF
  T_Vector3D *p_v; // [esp+60h] [ebp-10h]

  p_v = &v;
  memset(&v4, 0, sizeof(v4));
  v4.x = -pCamera->position.x;
  v4.y = -pCamera->position.y;
  v1 = -pCamera->position.z;
  v = v4;
  v4.z = v1;
  viewMatrix = pCamera->_viewMatrix;
  a = (T_Matrix3x3)pCamera->matrix_00;
  Q_BuildTransformMatrix_sub_53B08(&pCamera->trs, &a, &viewMatrix, &v);
}

//----- (0001B958) --------------------------------------------------------
void __fastcall __spoils<> Q_Camera_BuildTransformWithOffset_sub_1B958(P_Camera pCamera, P_Vector3D offset)
{
  T_Matrix3x3D m2; // [esp+0h] [ebp-88h] BYREF
  T_Matrix3x3 m1; // [esp+24h] [ebp-64h] BYREF
  T_Vector3D vector4; // [esp+48h] [ebp-40h] BYREF
  T_Vector3D vector3; // [esp+54h] [ebp-34h]
  T_Vector3D vector2; // [esp+60h] [ebp-28h] BYREF
  T_Vector3D vector1; // [esp+6Ch] [ebp-1Ch] BYREF
  P_Vector3D pVector2; // [esp+78h] [ebp-10h]
  P_Vector3D pVector1; // [esp+7Ch] [ebp-Ch]

  pVector2 = &vector4;
  memset(&vector2, 0, sizeof(vector2));
  vector2.x = offset->x + pCamera->position.x;
  vector2.y = offset->y + pCamera->position.y;
  vector2.z = offset->z + pCamera->position.z;
  vector4 = vector2;
  vector3.x = -vector2.x;
  vector3.y = -vector2.y;
  pVector1 = &vector1;
  vector1 = vector3;
  vector3.z = -vector2.z;
  m1 = pCamera->_viewMatrix;
  m2 = pCamera->matrix_00;
  Q_BuildTransformMatrix_sub_53B08(&pCamera->trs, (T_Matrix3x3 *)&m2, &m1, &vector1);
}

//----- (0001BA90) --------------------------------------------------------
void __fastcall Q_Camera_RotateX_sub_1BA90(P_Camera pCamera, float degrees)
{
  Q_Vector3D_RotateX_sub_5323C(&pCamera->position, degrees);
  Q_Matrix_RotateX_sub_5353C(&pCamera->matrix_00, degrees);
}

//----- (0001BAB0) --------------------------------------------------------
void __fastcall Q_Camera_RotateY_sub_1BAB0(P_Camera pCamera, float degrees)
{
  Q_Vector3D_RotateY_sub_532AC(&pCamera->position, degrees);
  Q_Matrix_RotateY_sub_53564(&pCamera->matrix_00, degrees);
}

//----- (0001BAF0) --------------------------------------------------------
void __fastcall Q_Camera_RotateYY_sub_1BAF0(P_Camera pCamera, float degrees)
{
  Q_Vector3D_RotateY_sub_532AC(&pCamera->position, degrees);
  Q_Matrix_RotateYY_sub_535E4(&pCamera->matrix_00, degrees);
}

//----- (0001BB10) --------------------------------------------------------
FILE *__fastcall Q_OpenTextFile_sub_1BB10(const char *filename, fpos_t *pos)
{
  FILE *v2; // eax
  FILE *v3; // edi
  T_CFile pCFile; // [esp+0h] [ebp-128h] BYREF

  Q_CFile_Ctor_sub_1BB78(&pCFile);
  Q_CFile_Open_sub_1BBFC(&pCFile, filename, O_TEXT, FALSE);
  v2 = fdopen(pCFile.fh, "r");
  v3 = v2;
  if ( pos )
  {
    fgetpos(v2, pos);
    *pos += Q_CFile_GetLength_sub_1BE28(&pCFile);
  }
  pCFile.fh = 0xFFFFFFFF;
  Q_CFile_Dtor_sub_1BBC8(&pCFile);
  return v3;
}
// 1BB10: using guessed type T_CFile pCFile;

//----- (0001BB78) --------------------------------------------------------
void __fastcall __spoils<> Q_CFile_Ctor_sub_1BB78(P_CFile pCFile)
{
  if ( !V_CobFilesLoaded )
  {
    Q_CobFiles_Load_sub_1C3C4(&V_CobFiles);
    V_CobFilesLoaded = TRUE;
  }
  pCFile->fh = 0xFFFFFFFF;
  pCFile->fname[0] = 0;
  pCFile->d = 0;
  pCFile->Unknown_110 = 0;
  pCFile->index = 0xFFFFFFFF;
}
// 9A250: using guessed type int V_CobFilesLoaded;

//----- (0001BBC8) --------------------------------------------------------
void __fastcall __spoils<> Q_CFile_Dtor_sub_1BBC8(P_CFile pCFile)
{
  Q_CFile_Close_sub_1BE00(pCFile);
  if ( pCFile->Unknown_110 == 0xFFFFFFFF && pCFile->d )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(pCFile->d);
  }
  operator delete[](pCFile->d);
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0001BBFC) --------------------------------------------------------
BOOL __fastcall Q_CFile_Open_sub_1BBFC(P_CFile pCFile, const char *filename, int oflags, BOOL preload)
{
  BOOL result; // eax
  int len; // eax
  ULONG v7; // ecx
  void *pData; // eax

  if ( pCFile->fh != 0xFFFFFFFF )
  {
    Q_CFile_Close_sub_1BE00(pCFile);
  }
  pCFile->Unknown_110 = 0;
  strncpy(pCFile->fname, filename, 0x100u);
  pCFile->fname[0xFF] = 0;
  result = Q_CFile_Open_sub_1BCBC(pCFile, oflags);
  if ( !result )
  {
    if ( preload == TRUE )
    {
      len = filelength(pCFile->fh);
      v7 = len;
      if ( len > 0 )
      {
        pData = operator new[](len);
        Q_RegisterDataInWinMgr_sub_2625C(pData, 1, "CFILE PRELOAD");
        pCFile->d = pData;
        if ( pData )
        {
          if ( !Q_CFile_Read_sub_1BF94(pCFile, pData, v7) )
          {
            pCFile->Unknown_110 = 0xFFFFFFFF;
            return 0;
          }
          Q_RemoveWinDataFromWinMgr_sub_2627C(pCFile->d);
          operator delete[](pCFile->d);
          pCFile->d = 0;
        }
      }
    }
    return 0;
  }
  return result;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0001BCA8) --------------------------------------------------------
BOOL __fastcall Q_CFile_Create_sub_1BCA8(P_CFile pCFile, const char *filename)
{
  return Q_CFile_Open_sub_1BBFC(pCFile, filename, O_CREAT|O_WRONLY, FALSE);
}

//----- (0001BCBC) --------------------------------------------------------
BOOL __fastcall Q_CFile_Open_sub_1BCBC(P_CFile pCFile, int oflags)
{
  int fh; // eax MAPDST
  int cindex_1; // edi
  int v4; // ecx
  MACRO_VFX_BOOL found; // [esp+0h] [ebp-20h]
  int oflag; // [esp+4h] [ebp-1Ch]

  oflag = oflags;
  if ( pCFile->fh != 0xFFFFFFFF )
  {
    Q_CFile_Close_sub_1BE00(pCFile);
  }
  if ( (oflags & O_CREAT) != 0 )
  {
    LOWORD(oflag) = oflags | O_BINARY|O_TRUNC;
    fh = open(pCFile->fname, oflag, S_IREADWRITE);
LABEL_19:
    pCFile->fh = fh;
    goto LABEL_20;
  }
  found = FALSE;
  if ( (oflags & (O_RDWR|O_WRONLY)) == 0 && V_CobFiles.totalfiles > 0 )
  {
    cindex_1 = 0;
    v4 = 0;
    while ( 1 )
    {
      if ( v4 == V_CobFiles.nextcobstart[cindex_1] )
      {
        ++cindex_1;
      }
      if ( !stricmp(pCFile->fname, V_CobFiles.fnames[v4]) )
      {
        break;
      }
      if ( ++v4 >= V_CobFiles.totalfiles )
      {
        goto LABEL_17;
      }
    }
    pCFile->index = v4;
    fh = open(V_CobFiles.cobnames[cindex_1], oflags);
    pCFile->fh = fh;
    if ( fh == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cfile.cpp", 0xC4);
    }
    lseek(pCFile->fh, V_CobFiles.foffsets[v4], SEEK_SET);
    found = TRUE;
  }
LABEL_17:
  if ( found == FALSE )
  {
    fh = open(pCFile->fname, oflags);
    goto LABEL_19;
  }
LABEL_20:
  pCFile->d4 = oflag;
  return pCFile->fh == 0xFFFFFFFF;
}

//----- (0001BE00) --------------------------------------------------------
int __fastcall Q_CFile_Close_sub_1BE00(P_CFile a1)
{
  int v3; // ebx

  if ( a1->fh == 0xFFFFFFFF )
  {
    return 0;
  }
  v3 = close(a1->fh);
  if ( !v3 )
  {
    a1->fh = 0xFFFFFFFF;
  }
  return v3;
}

//----- (0001BE28) --------------------------------------------------------
int __fastcall Q_CFile_GetLength_sub_1BE28(P_CFile a1)
{
  int index; // ecx
  int offset; // esi
  int v4; // kr04_4

  if ( a1->fh == 0xFFFFFFFF )
  {
    return 0xFFFFFFFF;
  }
  index = a1->index;
  if ( index == 0xFFFFFFFF )
  {
    // A separate file
    return filelength(a1->fh);
  }
  offset = V_CobFiles.foffsets[index + 1];
  if ( V_CobFiles.totalcobs > 0 )
  {
    v4 = 0;
    do
    {
      if ( V_CobFiles.nextcobstart[v4] - 1 == a1->index )
      {
        offset = V_CobFiles.coblengths[v4];
      }
      ++v4;
    }
    while ( v4 < V_CobFiles.totalcobs );
  }
  return offset - V_CobFiles.foffsets[index];
}

//----- (0001BEA0) --------------------------------------------------------
int __fastcall Q_CFile_GetPos_sub_1BEA0(P_CFile a1)
{
  int fpos; // eax
  int v3; // ebx
  int index; // ecx

  fpos = tell(a1->fh);
  v3 = fpos;
  if ( fpos != 0xFFFFFFFF )
  {
    index = a1->index;
    if ( index != 0xFFFFFFFF )
    {
      return fpos - V_CobFiles.foffsets[index];
    }
  }
  return v3;
}

//----- (0001BECC) --------------------------------------------------------
int __fastcall sub_1BECC(P_CFile a1, int offset, int a3)
{
  int index; // esi
  int v4; // ecx

  if ( a1->Unknown_110 && a3 != 0xFFFFFFFF )
  {
    return (int)a1->d + offset;
  }
  index = a1->index;
  v4 = offset;
  if ( index != 0xFFFFFFFF )
  {
    v4 = offset + V_CobFiles.foffsets[index];
  }
  return lseek(a1->fh, v4, 0);
}

//----- (0001BF0C) --------------------------------------------------------
int __fastcall Q_CFile_SetPos_sub_1BF0C(P_CFile a1, int offset)
{
  return lseek(a1->fh, offset, SEEK_CUR);
}

//----- (0001BF1C) --------------------------------------------------------
void *__fastcall Q_CFile_Load_sub_1BF1C(P_CFile pCFile, void *a2)
{
  void *v3; // ecx
  int Length_sub_1BE28; // eax
  ULONG v5; // edi
  unsigned int v6; // ebp
  void *result; // eax

  v3 = a2;
  if ( pCFile->fh != 0xFFFFFFFF )
  {
    Length_sub_1BE28 = Q_CFile_GetLength_sub_1BE28(pCFile);
    v5 = Length_sub_1BE28;
    if ( Length_sub_1BE28 > 0 )
    {
      v6 = 0;
      if ( !a2 )
      {
        result = operator new[](Length_sub_1BE28);
        Q_RegisterDataInWinMgr_sub_2625C(result, 5, "CFILE LOAD");
        v3 = result;
        if ( !result )
        {
          return result;
        }
        v6 = 0xFFFFFFFF;
      }
      if ( Q_CFile_Read_sub_1BF94(pCFile, v3, v5) == v5 )
      {
        return v3;
      }
      if ( v6 == 0xFFFFFFFF )
      {
        Q_RemoveWinDataFromWinMgr_sub_2627C(v3);
      }
      operator delete[](v3);
      _get_errno_ptr();
    }
  }
  return 0;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0001BF94) --------------------------------------------------------
// Returns the number of bytes of data transmitted from the file to the buffer
int __fastcall Q_CFile_Read_sub_1BF94(P_CFile pfi, void *pBuf, ULONG aReadLen)
{
  int index; // esi
  int pos; // esi
  unsigned int filelength; // eax

  index = pfi->index;
  if ( index != 0xFFFFFFFF )
  {
    pos = tell(pfi->fh) - V_CobFiles.foffsets[index];
    filelength = Q_CFile_GetLength_sub_1BE28(pfi);
    if ( pos + aReadLen > filelength )
    {
      aReadLen = filelength - pos;
    }
  }
  return read(pfi->fh, pBuf, aReadLen);
}

//----- (0001BFD4) --------------------------------------------------------
int __fastcall sub_1BFD4(P_CFile a1, void *buf, unsigned int a3, unsigned int a4, void (__fastcall *a5)(int, unsigned __int8))
{
  unsigned int v6; // edx
  int result; // eax
  int v8; // kr04_4
  unsigned int v9; // ebp
  unsigned int len; // [esp+Ch] [ebp-14h]
  int v12; // [esp+10h] [ebp-10h]

  len = a3 / a4;
  v12 = 0;
  v9 = 0;
  if ( a4 == 1 )
  {
LABEL_9:
    result = read(a1->fh, buf, a3 - v12);
    if ( result != 0xFFFFFFFF )
    {
      v12 += result;
      a5(a4, v9);
      return v12;
    }
  }
  else
  {
    while ( 1 )
    {
      result = read(a1->fh, buf, len);
      if ( result == 0xFFFFFFFF )
      {
        break;
      }
      v12 += result;
      if ( result < len )
      {
        v8 = 0;
        if ( v9 < a4 )
        {
          do
          {
            a5(a4, v9 + v8++);
          }
          while ( v9 + v8 < a4 );
        }
        return v12;
      }
      v6 = v9++;
      buf = (char *)buf + result;
      a5(a4, v6);
      if ( v9 >= a4 - 1 )
      {
        goto LABEL_9;
      }
    }
  }
  return result;
}

//----- (0001C098) --------------------------------------------------------
unsigned int __fastcall Q_CFile_Write_sub_1C098(P_CFile pCFile, void *buf, unsigned int size)
{
  unsigned int size_; // edi
  unsigned int chunksize; // esi
  int handle; // eax
  unsigned int result; // eax
  unsigned int byteswritten; // [esp+0h] [ebp-20h] BYREF
  P_CFile pcfile_; // [esp+4h] [ebp-1Ch]
  unsigned int v10; // [esp+8h] [ebp-18h]
  unsigned int v11; // [esp+Ch] [ebp-14h]

  pcfile_ = pCFile;
  size_ = size;
  if ( !size )
  {
    return v10;
  }
  while ( 1 )
  {
    chunksize = size_ <= 0xFFF0 ? size_ : 0xFFF0;
    handle = pcfile_->fh;
    v11 = chunksize;
    result = dos_write(handle, buf, chunksize, &byteswritten);
    v10 = result;
    if ( result )
    {
      break;
    }
    if ( chunksize != byteswritten )
    {
      _assert(0, "chunksize==byteswritten", "..\\cfile.cpp", 0x244);
    }
    buf = (char *)buf + v11;
    size_ -= v11;
    if ( !size_ )
    {
      return v10;
    }
  }
  return result;
}

//----- (0001C278) --------------------------------------------------------
void __fastcall Q_CobFiles_IndexOneCob_sub_1C278(P_CobFiles a1, char *CobFileName)
{
  int totalcobs; // ebx
  int fh; // edi MAPDST
  int totalfiles; // edx
  int firstfileindex; // esi
  int filesInCob; // [esp+0h] [ebp-18h] BYREF

  if ( a1->totalcobs >= 5 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cfile.cpp", 0x28C);
  }
  totalcobs = a1->totalcobs;
  if ( totalcobs < 5 )
  {
    strncpy(a1->cobnames[totalcobs], CobFileName, 50u);
    fh = open(CobFileName, O_BINARY);
    if ( fh != 0xFFFFFFFF )
    {
      a1->coblengths[a1->totalcobs] = filelength(fh);
      read(fh, &filesInCob, 4u);
      if ( 500 - a1->totalfiles < filesInCob )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cfile.cpp", 0x2A0);
      }
      totalfiles = a1->totalfiles;
      if ( 500 - totalfiles >= filesInCob )
      {
        read(fh, a1->fnames[totalfiles], 50 * filesInCob);
        read(fh, &a1->foffsets[a1->totalfiles], 4 * filesInCob);
        close(fh);
        firstfileindex = filesInCob + a1->totalfiles;
        a1->totalfiles = firstfileindex;
        a1->nextcobstart[a1->totalcobs++] = firstfileindex;
      }
    }
  }
}

//----- (0001C3C4) --------------------------------------------------------
void __fastcall Q_CobFiles_Load_sub_1C3C4(P_CobFiles a1)
{
  FILE *v2; // ecx
  char v3[100]; // [esp+0h] [ebp-64h] BYREF

  v2 = fopen("cob.cfg", "r");
  if ( v2 )
  {
    while ( fscanf(v2, "%s", v3) != 0xFFFFFFFF )
    {
      Q_CobFiles_IndexOneCob_sub_1C278(a1, v3);
    }
    fclose(v2);
  }
}
// 1C3C4: using guessed type char anonymous_0[100];

//----- (0001C410) --------------------------------------------------------
void Q_AtExitFunc_sub_1C410(void)
{
  Q_StopSystems_sub_26160();
  UVB_sub_7501C();
}

//----- (0001C424) --------------------------------------------------------
int __fastcall main(int argc, char *argv[])
{
  clock_t v3; // edx
  char *sub_1CEA8; // esi
  char *v5; // eax
  int v6; // eax
  int v7; // edx
  char *v8; // eax
  char *v9; // eax
  BOOL v10; // edx
  char *v11; // eax
  int v12; // eax
  char *v13; // eax
  UBYTE *v14; // ebx
  FILE *fp; // eax MAPDST
  char *v17; // eax
  unsigned int v18; // eax
  FILE *v20; // edi
  int i; // esi
  int v22; // kr04_4
  int result; // eax
  int v24; // [esp-4h] [ebp-574h]
  int v25; // [esp-4h] [ebp-574h]
  T_Palette black_palette; // [esp+0h] [ebp-570h] BYREF
  T_CFile v1Type1; // [esp+300h] [ebp-270h] BYREF
  T_CFile v1; // [esp+418h] [ebp-158h] BYREF
  char tmp; // [esp+530h] [ebp-40h] BYREF
  int stars; // [esp+544h] [ebp-2Ch] BYREF
  __int16 num; // [esp+548h] [ebp-28h] BYREF
  int races; // [esp+54Ch] [ebp-24h] BYREF
  unsigned int seed; // [esp+550h] [ebp-20h] BYREF
  MACRO_VFX_BOOL forceUNIVBE; // [esp+554h] [ebp-1Ch]
  char **__attribute__((__org_arrdim(0,0))) v48; // [esp+558h] [ebp-18h]

  v48 = argv;
  v3 = clock();
  printf("\nAscendancy\nCopyright (c) 1995 The Logic Factory, Inc.\nAll rights reserved\n");
  while ( clock() - v3 < 0xFA )
  {
    ;
  }
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAB);// 171: "Thank you for playing Ascendancy."
  strcpy("Thank you for playing Ascendancy.", sub_1CEA8);
  atexit(Q_AtExitFunc_sub_1C410);
  if ( argc > 1 && *v48[1] == 'v' )
  {
    v24 = off_964E0;
    v5 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAC);     // 172: "\n\nAscendancy version %s\n\n"
    printf(v5, v24);
    getch();
  }
  forceUNIVBE = FALSE;
  if ( argc > 1 && *v48[1] == 'u' )
  {
    forceUNIVBE = TRUE;
  }
  v6 = Q_CheckFreeMemory_sub_53DEC();
  v7 = v6;
  if ( argc > 1 && *v48[1] == 'm' )
  {
    v25 = v6;
    v8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAD);     // 173: "\n\nFree memory: %ld\n\n"
    printf(v8, v25);
    getch();
  }
  if ( v7 < 0x300000 )
  {
    v9 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAE);     // 174: "Your computer does not have enough free extended memory to run\n
                                                       // Ascendancy.  You will need an additional %ldK bytes of free extended memory."
    sprintf(
      "Thank you for playing Ascendancy.",
      v9,
      ((0x300000 - v7 - (__CFSHL__((0x300000 - v7) >> 0x1F, 0xA) + ((0x300000 - v7) >> 0x1F << 0xA))) >> 0xA) + 1);
    exit(1);
  }
  Q_CFile_Ctor_sub_1BB78(&v1Type1);
  v10 = Q_CFile_Open_sub_1BBFC(&v1Type1, "data\\theme00.raw", O_BINARY, 0);
  Q_CFile_Close_sub_1BE00(&v1Type1);
  if ( v10 )
  {
    v11 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAF);    // 175: "Please place the Ascendancy CD in your CDROM drive."
    strcpy("Thank you for playing Ascendancy.", v11);
    exit(1);
  }
  Q_CFile_Dtor_sub_1BBC8(&v1Type1);
  v12 = sub_53D22(0x101);
  if ( (!v12 || forceUNIVBE == TRUE) && !UVB_sub_75098(v12, 0, 0, O_BINARY, ".\\", 1) )
  {
    v13 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xB0);    // 176: "\n\nAscendancy was unable to find VESA support for your\n
                                                       // video card.  To configure the VESA driver that comes with\n
                                                       // Ascendancy, run the UVCONFIG program in this directory, and\n
                                                       // then try running Ascendancy again.  If this solution does\n
                                                       // not work, you may have to install the VESA driver supplied\n
                                                       // with your video card.  Consult your video card documentation\n
                                                       // for further information."
    printf(v13);
    aThank[0] = 0;
    exit(1);
  }
  if ( Q_GSystem_Start_sub_2BD88(&V_GSystem, "DATA", "VESA480.DLL") == FALSE )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\corn.cpp", 0x9B);
  }
  VFX_area_wipe(0, 0, 639, 479, 0);
  Q_LoadPal_sub_2C158(&V_GSystem, "data\\logo.pal", 0, 256u);
  memset(black_palette, 0, sizeof(black_palette));
  Q_GSystem_PaletteSet_sub_2C224(&V_GSystem, 0, 256, black_palette);
  Q_CFile_Ctor_sub_1BB78(&v1);
  Q_CFile_Open_sub_1BBFC(&v1, "data\\logo.gif", O_BINARY, 0);
  v14 = &V_BigBuffer[Q_CFile_GetLength_sub_1BE28(&v1)];
  Q_CFile_Load_sub_1BF1C(&v1, V_BigBuffer);
  VFX_GIF_draw(&V_GSystem.pane, V_BigBuffer, v14);
  VFX_pane_refresh(&V_GSystem.pane, 0, 0, 0x27F, 0x1DF);
  VFX_window_fade(&V_GSystem.window, V_GSystem.palette2, 25);
  if ( Q_SSystem_Start_sub_4EFB0(&V_SSystem, TRUE, FALSE) )
  {
    if ( V_SSystem.DIG_installed == TRUE && !Q_SSystem_LoadMusic_sub_4F65C(&V_SSystem, "music.txt") )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xBB);
    }
  }
  else
  {
    Q_SSystem_SetNoSound_sub_4FF08(&V_SSystem);
  }
  fp = fopen("nougat.lf", "r");
  if ( fp )
  {
    V_CheatMode = TRUE;
    fclose(fp);
  }
  fp = fopen("flash.pop", "r");
  if ( fp )
  {
    V_SelfPlayMode = TRUE;
    fclose(fp);
  }
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xD8);
  }
  if ( Q_WINMGR_CPP_StartTimer_sub_545EC(&WinMgr) != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\corn.cpp", 0xE1);
  }
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xE3);
  }
  if ( !Q_StartMouse_sub_2633C(&V_InputSystem) )
  {
    v17 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xB1);    // 177: "Ascendancy could not find a mouse driver.  Please make sure your\n
                                                       // mouse driver is loaded, and then run Ascendancy again."
    strcpy("Thank you for playing Ascendancy.", v17);
    exit(1);
  }
  Q_GSystem_PreloadMouseShp_sub_2C744(&V_GSystem);
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xEE);
  }
  v18 = time(0);
  srand(v18);
  Q_SetPlayerRaceIndex_sub_1CF14(0);
  fp = fopen("cosmos.txt", "r");
  v20 = fp;
  if ( fp )
  {
    fscanf(fp, "%s %d %s %d %s %d", &tmp, &stars, &tmp, &races, &tmp, &seed);
    i = 0;
    if ( seed != -1u )
    {
      srand(seed);
    }
    sub_1E10C(&V_Game, stars, races, 0);
    sub_1F404(&V_Game);
    v22 = 0;
    while ( fscanf(v20, "%d", &num) != 0xFFFFFFFF && i < races )
    {
      ++i;
      *((_BYTE *)&V_StaticStrings_dword_A0D04 + 0x1EE * v22++ + 0x226F) = num;
    }
    fclose(v20);
  }
  else
  {
    sub_1E10C(&V_Game, 50, 7, 0);
    sub_1F404(&V_Game);
  }
  Q_Game_SetRacesRandomColors_sub_1EE08(&V_Game, 0);
  if ( access("resume.gam", 0) )
  {
    Q_Game_InitializeStarConnections_sub_1F038(&V_Game);
  }
  WinMgr.window = (WINDOW *)&V_GSystem;
  sub_575BC(&WinMgr);
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x11F);
  }
  sub_1EEA4(&V_Game);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0, Q_Proc_sub_1CC94);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 1, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc2_sub_57510(&WinMgr, 1, Q_Proc_sub_22468);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 2, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 3, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 4, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 7, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 8, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 9, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0xA, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0xC, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0xD, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0xE, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0xF, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0x10, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0x12, Q_Proc_sub_5A320);
  Q_WinMgr_SetStateProc1_sub_574F0(&WinMgr, 0x14, Q_Proc_sub_5A320);
  Q_LoadAscendCfg_sub_59828(&WinMgr);
  VFX_window_fade(&V_GSystem.window, black_palette, 0x32);
  V_FadeEffect = TRUE;
  VFX_area_wipe(0, 0, 0x27F, 0x1DF, 0);
  Q_LoadPal_sub_2C158(&V_GSystem, "DATA\\game.pal", 0, 0x100u);
  Q_GSystem_PaletteSet_sub_2C224(&V_GSystem, 0, 0x100, black_palette);
  sub_56E9C(&WinMgr, 0, 0xFFFFFFFF);
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x146);
  }
  if ( argc == 4 && Q_WinMgr_PlayWinEvents_sub_59988(&WinMgr, v48[3], 0) != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\corn.cpp", 0x14C);
  }
  MOUSE_show();
  // Main game loop
  while ( Q_GameLoop_dword_96774 == TRUE )
  {
    if ( WinMgr.bbb == TRUE )
    {
      sub_59B80(&WinMgr);
    }
    else
    {
      Q_ProcessInput_sub_2656C(&V_InputSystem);
    }
    sub_5469C(&WinMgr);
    Q_WinMgr_OverlayEffects_sub_5508C(&WinMgr);
    if ( WinMgr.bbb )
    {
      sub_59A54(&WinMgr);
    }
  }
  Q_SaveAscendCfg_sub_5989C(&WinMgr);
  Q_SaveGam_sub_54048("resume.gam");
  result = (int)&v1;
  Q_CFile_Dtor_sub_1BBC8(&v1);
  return result;
}
// 1CC7C: returning address of temporary local variable '%v1'
// 96774: using guessed type int Q_GameLoop_dword_96774;
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 132B60: using guessed type int V_FadeEffect;

//----- (0001CC94) --------------------------------------------------------
void Q_Proc_sub_1CC94()
{
  void *v0; // edi
  UBYTE *v1; // esi
  T_CFile v2; // [esp+0h] [ebp-128h] BYREF

  v0 = Q_AllocAndAddToWinMgr_sub_262B0(0x502Eu, 1u, 1, "GIF SCRATCH");
  Q_CFile_Ctor_sub_1BB78(&v2);
  Q_CFile_Open_sub_1BBFC(&v2, "DATA\\0OPENING.GIF", O_BINARY, 0);
  v1 = (UBYTE *)Q_CFile_Load_sub_1BF1C(&v2, 0);
  if ( !v1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x180);
  }
  Q_CFile_Dtor_sub_1BBC8(&v2);
  if ( v0 )
  {
    VFX_GIF_draw(&V_GSystem.pane, v1, v0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, 0);
  }
  Q_RemoveWinDataFromWinMgr_sub_2627C(v1);
  operator delete(v1);
  Q_RemoveWinDataFromWinMgr_sub_262CC(v0);
}
// 1CCF9: conditional instruction was optimized away because esi.4!=0
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0001CD3C) --------------------------------------------------------
int Q_CORN_CPP_StaticTxtLoad_sub_1CD3C()
{
  FILE *fp; // edi
  char *pText; // esi
  char *pLetter; // ecx
  unsigned int v3; // ebp
  char letter; // dl
  int count; // eax
  char v6; // bh
  char line[201]; // [esp+1h] [ebp-E5h] BYREF
  int endOfFile; // [esp+CAh] [ebp-1Ch]

  fp = Q_OpenTextFile_sub_1BB10("static.txt", 0);
  if ( !fp )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1A0);
  }
  pText = V_StaticStrings_dword_A0D04.buffer;
  V_StaticStrings_dword_A0D04.count = 0;
  endOfFile = 0;
  do
  {
    if ( V_StaticStrings_dword_A0D04.count >= 200 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1AE);
    }
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, &line[1]);
    if ( !stricmp(&line[1], "end\n") )
    {
      endOfFile = 0xFFFFFFFF;
      continue;
    }
    if ( line[1] == '"' )
    {
      pLetter = &line[1];
      v3 = 0;
      V_StaticStrings_dword_A0D04.index[V_StaticStrings_dword_A0D04.count] = pText;
      do
      {
        ++pLetter;
        if ( pText - V_StaticStrings_dword_A0D04.buffer >= 8000 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1C6);
        }
        letter = *pLetter;
        if ( *pLetter == '"' )
        {
          v3 = 0xFFFFFFFF;
          count = V_StaticStrings_dword_A0D04.count;
          *pText++ = 0;
          V_StaticStrings_dword_A0D04.count = count + 1;
        }
        else if ( letter != '\n' )
        {
          if ( letter )
          {
            if ( letter != '\\' )
            {
              *pText++ = letter;
              continue;
            }
            v6 = *++pLetter;
            if ( v6 == 'n' )
            {
              *pText++ = '\n';
              continue;
            }
            if ( v6 )
            {
              *pText++ = v6;
              continue;
            }
          }
          pLetter = line;
          fgets(&line[1], 200, fp);
        }
      }
      while ( !v3 );
    }
  }
  while ( !endOfFile );
  V_StaticStrings_dword_A0D04.loaded = 0xFFFFFFFF;
  return fclose(fp);
}

//----- (0001CEA8) --------------------------------------------------------
char *__fastcall Q_CORN_CPP_StaticTxtRead_sub_1CEA8(int aTextIndex)
{
  if ( !V_StaticStrings_dword_A0D04.loaded )
  {
    Q_CORN_CPP_StaticTxtLoad_sub_1CD3C();
  }
  if ( aTextIndex < 0 || aTextIndex >= V_StaticStrings_dword_A0D04.count )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1F3);
  }
  return V_StaticStrings_dword_A0D04.index[aTextIndex];
}

//----- (0001CEF0) --------------------------------------------------------
void __fastcall Q_Game_StaticCtor_sub_1CEF0()
{
  _wcpp_2_mod_register_((RW_DTREG *)&stru_964E4);
  Q_Game_Ctor_sub_1DE64(&V_Game);
  stru_964E4.state_var = 1;
}

//----- (0001CF14) --------------------------------------------------------
void __fastcall Q_SetPlayerRaceIndex_sub_1CF14(unsigned __int8 playerRaceIndex)
{
  unsigned __int8 v1; // dh
  char v2; // dl

  if ( playerRaceIndex == 0xFF )
  {
    v1 = 0;
    v2 = 0xFF;
  }
  else
  {
    v1 = playerRaceIndex;
    v2 = 1 << playerRaceIndex;
  }
  V_PlayerRaceIndex = v1;
  V_PlayerRaceMask = v2;
}
// 968DC: using guessed type char V_PlayerRaceMask;

//----- (0001CF40) --------------------------------------------------------
void __fastcall __spoils<> Q_Star_Ctor_sub_1CF40(P_Star self)
{
  self->position.x = 0.0;
  self->position.y = 0.0;
  self->position.z = 0.0;
}

//----- (0001CF68) --------------------------------------------------------
T_Lane *__fastcall Q_CreateStarLane_sub_1CF68(P_Star pStar1, P_Star pStar2)
{
  int lanesNum; // eax
  int v5; // eax
  T_Lane *pResultLane; // ebx
  T_Lane *pNewLane; // eax
  T_Lane *pLane; // edx
  double distance; // st7
  T_Vector3D v11; // [esp+8h] [ebp-A4h] BYREF
  T_Vector3D v12; // [esp+14h] [ebp-98h] BYREF
  T_Vector3D direction; // [esp+20h] [ebp-8Ch] BYREF
  T_Vector3D v14; // [esp+2Ch] [ebp-80h]
  T_Vector3D v15; // [esp+38h] [ebp-74h] BYREF
  T_Vector3D star2Position; // [esp+44h] [ebp-68h]
  float v17; // [esp+50h] [ebp-5Ch]
  float v18; // [esp+54h] [ebp-58h]
  float v19; // [esp+58h] [ebp-54h]
  float v20; // [esp+5Ch] [ebp-50h] BYREF
  float v21; // [esp+60h] [ebp-4Ch]
  float v22; // [esp+64h] [ebp-48h]
  T_Vector3D v23; // [esp+68h] [ebp-44h] BYREF
  T_Vector3D v24; // [esp+74h] [ebp-38h]
  T_Vector3D *v25; // [esp+80h] [ebp-2Ch]
  T_Vector3D *pStar; // [esp+88h] [ebp-24h]
  T_Vector3D *v27; // [esp+8Ch] [ebp-20h]
  float *v28; // [esp+90h] [ebp-1Ch]
  float v29; // [esp+98h] [ebp-14h]

  lanesNum = pStar1->lanesNum;
  if ( lanesNum < 0 || lanesNum >= 6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7F);
  }
  v5 = pStar2->lanesNum;
  if ( v5 < 0 || v5 >= 6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x81);
  }
  pResultLane = 0;
  if ( pStar1->lanesNum != V_MaxLanesPerStarType[pStar1->type] && pStar2->lanesNum != V_MaxLanesPerStarType[pStar2->type] )
  {
    pNewLane = Q_Game_AddLane_sub_205A0(&V_Game, pStar1, pStar2);
    pLane = pNewLane;
    pResultLane = pNewLane;
    if ( pNewLane )
    {
      pStar1->lanes[pStar1->lanesNum++] = pNewLane;
      pStar2->lanes[pStar2->lanesNum++] = pNewLane;
      memset(&v15, 0, sizeof(v15));
      star2Position = pStar2->position;
      memset(&direction, 0, sizeof(direction));
      v25 = &v11;
      direction.x = star2Position.x - pStar1->position.x;
      direction.y = star2Position.y - pStar1->position.y;
      direction.z = star2Position.z - pStar1->position.z;
      v11 = direction;
      star2Position = direction;
      distance = sqrt(direction.y * direction.y + direction.x * direction.x + direction.z * direction.z);
      pStar = &v12;
      v24.x = star2Position.x * (1.0 / distance);
      v24.y = star2Position.y * (1.0 / distance);
      v24.z = 1.0 / distance * star2Position.z;
      v12 = v24;
      v29 = distance * 0.0011363636;
      star2Position = v24;
      v29 = v29 * 1000.0 + 2000.0;
      v14.x = v24.x * v29;
      v27 = &v23;
      v14.y = v24.y * v29;
      v23 = v14;
      v14.z = v24.z * v29;
      v15 = v14;
      // Set lane's first vector (direction from star1 to star2)
      pLane->vector1.x = v14.x;
      pLane->vector1.y = v15.y;
      pLane->vector1.z = v15.z;
      // Calculate inverse vector (direction from star2 to star1)
      v17 = -v15.x;
      v28 = &v20;
      v18 = -v15.y;
      v20 = v17;
      v19 = -v15.z;
      v21 = v18;
      v22 = v19;
      pLane->vector2.x = v17;
      pLane->vector2.y = v21;
      pLane->vector2.z = v22;
    }
  }
  return pResultLane;
}

//----- (0001D234) --------------------------------------------------------
__int16 __fastcall Q_Star_ChangePlanetOwnership_sub_1D234(P_Star pStar, P_Planet pPlanet, WORD newRaceIndex)
{
  int raceIndex; // eax
  WORD planetsNum; // bx
  P_Star homeStar; // ebx
  int planetsRacesBits; // edx
  UBYTE buildingPlanetItemIndex; // bh
  P_Ship vpShip; // eax
  __int16 i; // ax
  __int16 planetRaceIndex; // [esp+2h] [ebp-10h]

  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB3);
  }
  if ( newRaceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB4);
  }
  if ( pPlanet->raceIndex == newRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB5);
  }
  if ( pPlanet->raceIndex == 0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB7);
  }
  planetRaceIndex = pPlanet->raceIndex;
  raceIndex = pPlanet->raceIndex;
  if ( raceIndex != 0xFF )
  {
    if ( newRaceIndex == 0xFFFFFFFF )
    {
      pPlanet->raceIndex = 0xFF;
    }
    else
    {
      pPlanet->raceIndex = newRaceIndex;
      pStar->planetsRacesBits |= 1 << newRaceIndex;
    }
    planetsNum = pStar->planetsNum;
    pStar->planetsRacesBits &= ~(1 << planetRaceIndex);
    i = 0;
    if ( planetsNum > 0 )
    {
      while ( pStar->planets[i]->raceIndex != planetRaceIndex )
      {
        if ( ++i >= pStar->planetsNum )
        {
          goto LABEL_18;
        }
      }
      pStar->planetsRacesBits |= 1 << planetRaceIndex;
    }
LABEL_18:
    LOWORD(raceIndex) = planetRaceIndex;
    homeStar = V_Game.races[planetRaceIndex].homeStar;
    if ( pStar == homeStar )
    {
      planetsRacesBits = homeStar->planetsRacesBits;
      raceIndex = 1 << planetRaceIndex;
      if ( ((1 << planetRaceIndex) & planetsRacesBits) == 0 )
      {
        pStar->planetsRacesBits = planetsRacesBits & 0x7F;
      }
    }
  }
  buildingPlanetItemIndex = pPlanet->buildingPlanetItemIndex;
  if ( buildingPlanetItemIndex != 0xFF )
  {
    if ( buildingPlanetItemIndex == ASCEND_PI_23_SHIP )
    {
      vpShip = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, pPlanet->_squareIndex);
      if ( planetRaceIndex != vpShip->raceIndex )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xE0);
      }
      Q_Ship_RemoveFromTheGame_sub_49940(vpShip);
    }
    raceIndex = pPlanet->_squareIndex;
    if ( (unsigned __int16)raceIndex != 0xFFFF && pPlanet->buildingPlanetItemIndex != 0x23 )
    {
      pPlanet->pSquares[raceIndex].planetItemIndex = 0xFF;
      raceIndex = pPlanet->_squareIndex;
      pPlanet->pSquares[raceIndex].flags = 0;
    }
    pPlanet->buildingPlanetItemIndex = 0xFF;
    pPlanet->buildingProgress = 0;
    pPlanet->_squareIndex = 0xFFFF;
  }
  return raceIndex;
}

//----- (0001D3E8) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Star_HandleShipArrival_sub_1D3E8(P_Star pStar, P_Ship pShip, int a3)
{
  UBYTE locationType; // ah
  P_Lane pLane; // eax
  int i; // edx
  P_Lane pConnectedLane; // eax
  T_Vector3D arrivalPosition; // [esp+0h] [ebp-1Ch] BYREF
  int v11; // [esp+Ch] [ebp-10h]

  if ( a3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xFD);
  }
  locationType = pShip->locationType;
  // Handle different arrival scenarios
  if ( locationType == ASCEND_LOCATION_TYPE_STARLANE )
  {
    // Calculate arrival position from star lane
    pLane = pShip->pLocation.pLane;
    memset(&arrivalPosition, 0, sizeof(arrivalPosition));
    if ( pStar == pLane->pStar1 )
    {
      arrivalPosition = pLane->vector1;
    }
    else if ( pStar == pLane->pStar2 )
    {
      arrivalPosition = pLane->vector2;
    }
    else
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0x10A);
    }
    // Add random offset near the lane endpoint
    arrivalPosition.y = arrivalPosition.y + -200.0;    // Move away from lane
    arrivalPosition.z = (double)(rand() % 200) + arrivalPosition.z;
    v11 = rand() % 200;
    arrivalPosition.x = (double)v11 + arrivalPosition.x;
    // Position ship and update location
    Q_Ship_SetPositionAndSnapToGrid_sub_496BC(pShip, &arrivalPosition);
    pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
  }
  else if ( locationType != ASCEND_LOCATION_TYPE_SYSTEM )
  {
    goto UPDATE_PRESENCE;
  }
  // Set ship's current star
  pShip->pLocation.pStar = pStar;
UPDATE_PRESENCE:
  // Update exploration and presence flags
  pStar->shipsRacesBits |= 1 << LOBYTE(pShip->raceIndex);
  pStar->exploredBits |= 1 << LOBYTE(pShip->raceIndex);
  // Update all connected star lanes
  for ( i = 0; (__int16)i < pStar->lanesNum; ++i )
  {
    pConnectedLane = pStar->lanes[(__int16)i];
    pConnectedLane->exploredBits |= 1 << LOBYTE(pShip->raceIndex);
    pConnectedLane->pStar1->exploredPathToBits |= 1 << LOBYTE(pShip->raceIndex);
    pConnectedLane->pStar2->exploredPathToBits |= 1 << LOBYTE(pShip->raceIndex);
  }
  return TRUE;
}

//----- (0001D538) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_HandleShipDeparture_sub_1D538(P_Location pLocation, P_Ship pShip)
{
  UBYTE locationType; // ah
  int starIndex; // edx
  int shipsNum; // esi
  MACRO_VFX_BOOL isLastOfRace; // ebp
  __int16 i; // dx
  P_Ship currentShip; // eax
  P_Ship nearbyShips[107]; // [esp+0h] [ebp-1C4h] BYREF
  WORD raceIndex; // [esp+1ACh] [ebp-18h]

  raceIndex = pShip->raceIndex;
  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x139);
  }
  locationType = pShip->locationType;
  // Try to launch the ship from planetary location
  if ( (locationType == ASCEND_LOCATION_TYPE_ORBIT
     || locationType == ASCEND_LOCATION_TYPE_SHIPYARD
     || locationType == ASCEND_LOCATION_TYPE_SHIPDOCK)
    && Q_Planet_LaunchShip_sub_35C38(pShip->pLocation.pPlanet, pShip) == FALSE )
  {
    // Fallback: Move directly to star system if launch fails
    starIndex = pShip->pLocation.pPlanet->starIndex;
    pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
    pShip->pLocation.pStar = &V_Game.stars[starIndex];
  }
  // Verify ship is now in system and at correct location
  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM || pLocation.pPlanet != pShip->pLocation.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x149);
  }
  // Find all ships at this location
  shipsNum = Q_FindShipsAtLocation_sub_1D794(pLocation, nearbyShips);
  if ( shipsNum <= 0 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0x14E);
  }
  // Check if any other ships of same race remain (excluding current ship and shipyard ships
  isLastOfRace = TRUE;
  for ( i = 0; i < shipsNum; ++i )
  {
    currentShip = nearbyShips[i];
    if ( currentShip->raceIndex == raceIndex && currentShip != pShip && currentShip->locationType != ASCEND_LOCATION_TYPE_SHIPYARD )
    {
      isLastOfRace = FALSE;
      break;
    }
  }
  // If this was the last ship of its race, update star system flags
  if ( isLastOfRace == TRUE )
  {
    pLocation.pStar->shipsRacesBits &= ~(1 << raceIndex);
  }
  return TRUE;
}

//----- (0001D654) --------------------------------------------------------
void __fastcall sub_1D654(P_Location pLocation, P_Star pStar, P_Lane pLane)
{
  P_Ship pShip; // ecx
  __int16 i; // si
  P_Ship shipsArray[107]; // [esp+0h] [ebp-1C4h] BYREF
  int ShipsAtLocation_sub_1D794; // [esp+1ACh] [ebp-18h]
  P_Lane pLane_; // [esp+1B0h] [ebp-14h]

  pLane_ = pLane;
  if ( !pStar || !pLane )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x16C);
  }
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(pLocation, shipsArray);
  for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
  {
    pShip = shipsArray[i];
    if ( pShip->raceIndex == V_PlayerRaceIndex )
    {
      Q_HandleShipDeparture_sub_1D538(pLocation, pShip);
      pShip->pLocation.pLane = pLane_;
      pShip->locationType = ASCEND_LOCATION_TYPE_STARLANE;
      Q_Star_HandleShipArrival_sub_1D3E8(pStar, pShip, 0);
    }
  }
}
// 1D654: could not find valid save-restore pair for ebx

//----- (0001D734) --------------------------------------------------------
int __fastcall sub_1D734(P_Star pStar, WORD *a2)
{
  int j; // ebx
  WORD raceIndex; // ax
  int v4; // kr04_4
  UBYTE v6; // [esp+0h] [ebp-14h]

  j = 0;
  v6 = pStar->planetsRacesBits | pStar->shipsRacesBits;
  raceIndex = 0;
  if ( V_Game.racesNum > 0 )
  {
    v4 = 0;
    do
    {
      if ( (v6 & (unsigned __int8)(1 << raceIndex)) != 0 )
      {
        ++j;
        a2[v4++] = raceIndex;
      }
      ++raceIndex;
    }
    while ( raceIndex < V_Game.racesNum );
  }
  return j;
}

//----- (0001D794) --------------------------------------------------------
// Finds all ships at a given location and optionally stores them in an output array
// Returns the number of ships found at the location
int __fastcall Q_FindShipsAtLocation_sub_1D794(P_Location pLocation, P_Ship *outShipsArray)
{
  P_Ship *v2; // kr08_4
  int shipsFoundCount; // edi
  int validShipsChecked; // esi
  int shipArrayIndex; // kr04_4
  int v6; // kr0C_4
  UBYTE locationType; // cl
  __int16 i; // dx

  v2 = outShipsArray;
  shipsFoundCount = 0;
  validShipsChecked = 0;
  shipArrayIndex = 0;
  v6 = 0;
  for ( i = 0; i < 107 && validShipsChecked < V_Game.shipsNum; ++i )
  {
    if ( V_Game.ships[shipArrayIndex].raceIndex != 0xFFFFFFFF )
    {
      // Check if ship is at target location either:
      // 1. In orbit/shipyard/dock at same star, or
      // 2. In same star system
      if ( ((locationType = V_Game.ships[shipArrayIndex].locationType, ++validShipsChecked, locationType == ASCEND_LOCATION_TYPE_ORBIT)
         || locationType == ASCEND_LOCATION_TYPE_SHIPYARD
         || locationType == ASCEND_LOCATION_TYPE_SHIPDOCK)
        && &V_Game.stars[V_Game.ships[shipArrayIndex].pLocation.pPlanet->starIndex] == pLocation.pStar
        || V_Game.ships[shipArrayIndex].locationType == ASCEND_LOCATION_TYPE_SYSTEM
        && pLocation.pStar == V_Game.ships[shipArrayIndex].pLocation.pStar )
      {
        if ( outShipsArray )
        {
          v2[v6] = &V_Game.ships[shipArrayIndex];
        }
        ++shipsFoundCount;
        ++v6;
      }
    }
    ++shipArrayIndex;
  }
  return shipsFoundCount;
}

//----- (0001D834) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Star_ShipsAreTravelingTowards_sub_1D834(P_Star pStar, WORD raceIndex)
{
  int shipToCheck; // kr04_4
  int raceToCheck; // eax
  __int16 laneIndex; // dx
  __int16 i; // di
  WORD shipsChecked; // [esp+6h] [ebp-18h]

  shipsChecked = 0;
  shipToCheck = 0;
  for ( i = 0; ; ++i )
  {
    if ( i >= 107 || shipsChecked >= V_Game.shipsNum )
    {
      // Nothing found
      return FALSE;
    }
    raceToCheck = V_Game.ships[shipToCheck].raceIndex;
    if ( raceToCheck != 0xFFFFFFFF )
    {
      ++shipsChecked;
      if ( V_Game.ships[shipToCheck].locationType == ASCEND_LOCATION_TYPE_STARLANE
        && (V_Game.races[raceIndex].treaties[raceToCheck] == ASCEND_TREATY_WAR
         || raceToCheck == V_PlayerRaceIndex
         || raceIndex == V_Game.ships[shipToCheck].raceIndex) )
      {
        // If ship is in starlane AND:
        // 1. At war with checking race, OR
        // 2. Belongs to player, OR
        // 3. Belongs to the same race we're checking for
        laneIndex = 0;
        // Check lanes, if star has any
        if ( pStar->lanesNum > 0 )
        {
          break;
        }
      }
    }
CONTINUE_SEARCHING:
    ++shipToCheck;
  }
  while ( V_Game.ships[shipToCheck].pLocation.pLane != pStar->lanes[laneIndex]
       || (pStar != pStar->lanes[laneIndex]->pStar1 || V_Game.ships[shipToCheck].position.y)
       && (pStar != pStar->lanes[laneIndex]->pStar2 || V_Game.ships[shipToCheck].position.y != 1.0) )
  {
    if ( ++laneIndex >= pStar->lanesNum )
    {
      goto CONTINUE_SEARCHING;
    }
  }
  // If ship in starlane and moving towards this star
  // (this Star is Star1 and ship is moving Star2->Star1
  // or
  // this Star is Star2 and ship is moving Star1->Star2)
  return TRUE;
}

//----- (0001D920) --------------------------------------------------------
void __fastcall Q_ReadWriteStar_sub_1D920(P_Star pStar, P_CFile pfi, int read)
{
  int z2; // eax
  T_Star vStar; // [esp+0h] [ebp-70h] BYREF

  if ( read == TRUE )
  {
    Q_Star_Ctor_sub_1CF40(&vStar);
    Q_CFile_Read_sub_1BF94(pfi, &vStar, sizeof(T_Star));
    pStar->type = vStar.type;
    pStar->index = vStar.index;
    pStar->connectionGroupIndex = vStar.connectionGroupIndex;
    pStar->position = vStar.position;
    pStar->planetsRacesBits = vStar.planetsRacesBits;
    pStar->shipsRacesBits = vStar.shipsRacesBits;
    pStar->exploredPathToBits = vStar.exploredPathToBits;
    pStar->exploredBits = vStar.exploredBits;
    pStar->Unknown_18 = vStar.Unknown_18;
    *(_DWORD *)pStar->name = *(_DWORD *)vStar.name;
    *(_DWORD *)&pStar->name[4] = *(_DWORD *)&vStar.name[4];
    *(_DWORD *)&pStar->name[8] = *(_DWORD *)&vStar.name[8];
    *(_DWORD *)&pStar->name[0xC] = *(_DWORD *)&vStar.name[0xC];
    qmemcpy(pStar->lanes, vStar.lanes, sizeof(pStar->lanes));
    pStar->lanesNum = vStar.lanesNum;
    pStar->planets[0] = vStar.planets[0];
    pStar->planets[1] = vStar.planets[1];
    pStar->planets[2] = vStar.planets[2];
    pStar->planets[3] = vStar.planets[3];
    pStar->planets[4] = vStar.planets[4];
    pStar->planetsNum = vStar.planetsNum;
    z2 = vStar.z2;
    pStar->lanesNum = 0;
    pStar->z2 = z2;
    pStar->planetsNum = 0;
  }
  else
  {
    Q_CFile_Write_sub_1C098(pfi, pStar, 0x60u);
  }
}

//----- (0001DA04) --------------------------------------------------------
WORD __fastcall Q_Star_GetDistanceToStar_sub_1DA04(P_Star pStar, P_Star pStar2)
{
  if ( !pStar2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x21A);
  }
  return V_Game.starDistanceMatrix[pStar->index][pStar2->index];
}

//----- (0001DA4C) --------------------------------------------------------
// Calculates the strategic value of a star system for a specific race
int __fastcall Q_Star_CalculateStrategicValueForRace_sub_1DA4C(P_Star pStar, WORD raceIndex, P_ShipsList pShipsList, int shipIndex)
{
  int totalValue; // ebx
  P_Planet *starPlanets; // kr00_4
  P_Star pOtherHomeStar; // ecx
  int i; // edi
  int otherRaceIndex; // eax

  if ( raceIndex > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x248);
  }
  if ( shipIndex >= 107 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x249);
  }
  totalValue = 0;
  if ( ((1 << raceIndex) & pStar->exploredPathToBits) == 0 )
  {
    return 700;
  }
  // Calculate value from all planets in the system not owned by this race
  starPlanets = pStar->planets;
  for ( i = 0; i < pStar->planetsNum; ++i )
  {
    if ( starPlanets[i]->raceIndex != raceIndex )
    {
      totalValue += Q_Planet_GetVisibleValueForRace_sub_364B4(starPlanets[i], raceIndex);
    }
  }
  for ( otherRaceIndex = 0; otherRaceIndex < V_Game.racesNum; ++otherRaceIndex )
  {
    if ( otherRaceIndex != raceIndex )
    {
      pOtherHomeStar = V_Game.races[otherRaceIndex].homeStar;
      if ( pStar == pOtherHomeStar
        && (pOtherHomeStar->planetsRacesBits & 0x80) != 0
        && V_Game.races[raceIndex].treaties[otherRaceIndex] == ASCEND_TREATY_WAR )
      {
        // Triple value and add bonus for enemy home systems at war
        totalValue = 3 * totalValue + 200;
      }
    }
  }
  // Double value for unclaimed systems (no races present)
  if ( !pStar->planetsRacesBits )
  {
    totalValue *= 2;
  }
  if ( totalValue < 0 )
  {
    totalValue = 0;
  }
  // If system isn't fully explored, apply exploration modifier
  if ( ((1 << raceIndex) & pStar->exploredBits) == 0 )
  {
    return 4 * totalValue + 300;
  }
  return totalValue;
}

//----- (0001DB70) --------------------------------------------------------
int __fastcall sub_1DB70(P_Star pStar, WORD raceIndex, P_ShipsList pShipsList, int a4)
{
  UBYTE shipsRacesBits; // al
  int ShipsAtLocation_sub_1D794; // eax
  int i; // kr04_4
  int v9; // kr08_4
  P_Ship v10; // ecx
  int v11; // ebp
  int v12; // kr10_4
  P_Ship v13; // ecx
  P_Planet *planets; // kr14_4
  int v15; // edx
  int v16; // edx
  int v17; // ebx
  T_Planet *v18; // eax
  int j; // ebp
  T_ShipsList v21; // [esp+0h] [ebp-1D4h] BYREF
  P_ShipsList v22; // [esp+1ACh] [ebp-28h]
  int v23; // [esp+1B0h] [ebp-24h]
  int v24; // [esp+1B4h] [ebp-20h]
  int v25; // [esp+1B8h] [ebp-1Ch]
  int v26; // [esp+1BCh] [ebp-18h]
  P_ShipsList v27; // [esp+1C0h] [ebp-14h]
  float v28; // [esp+1C4h] [ebp-10h]

  v27 = pShipsList;
  v26 = a4;
  if ( raceIndex > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x2BD);
  }
  v23 = 0;
  if ( ((1 << raceIndex) & pStar->exploredPathToBits) != 0 && ((1 << raceIndex) & pStar->planetsRacesBits) != 0 )
  {
    shipsRacesBits = pStar->shipsRacesBits;
    v28 = 0.0;
    if ( shipsRacesBits )
    {
      if ( v27 && v26 >= 0 )
      {
        v11 = 0;
        if ( v26 > 0 )
        {
          v22 = v27;
          v12 = 0;
          do
          {
            v13 = v27[v12];
            if ( !v13 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x2F1);
            }
            if ( (v13->locationType == ASCEND_LOCATION_TYPE_SYSTEM && pStar == v13->pLocation.pStar
               || v13->locationType == ASCEND_LOCATION_TYPE_ORBIT && pStar->index == v13->pLocation.pPlanet->starIndex)
              && raceIndex != v13->raceIndex
              && V_Game.races[raceIndex].treaties[v13->raceIndex] == 2 )
            {
              v24 = Q_Ship_CalculateCombatRating_sub_4A988(v27[v12]);
              v28 = (double)v24 + v28;
            }
            ++v11;
            ++v12;
          }
          while ( v11 < v26 );
        }
      }
      else
      {
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)pStar, v21);
        if ( ShipsAtLocation_sub_1D794 > 0 )
        {
          v9 = ShipsAtLocation_sub_1D794;
          v25 = 4 * ShipsAtLocation_sub_1D794;
          for ( i = 0; i < v9; ++i )
          {
            v10 = v21[i];
            if ( !v10 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x2D6);
            }
            if ( (v10->locationType == 4 && pStar == v10->pLocation.pStar
               || v10->locationType == 3 && pStar->index == v10->pLocation.pPlanet->starIndex)
              && raceIndex != v10->raceIndex
              && V_Game.races[raceIndex].treaties[v10->raceIndex] == 2 )
            {
              v24 = Q_Ship_CalculateCombatRating_sub_4A988(v21[i]);
              v28 = (double)v24 + v28;
            }
          }
        }
      }
      v28 = v28 * 4.0 * 0.0099999998;
    }
    if ( v28 > 0.0 )
    {
      planets = pStar->planets;
      for ( j = 0; j < pStar->planetsNum; ++j )
      {
        if ( planets[j]->raceIndex == raceIndex )
        {
          v15 = v23;
          v16 = Q_Planet_GetTotalValue_sub_363B0(planets[j]) + v15;
          v17 = v16 - 0xA * Q_Planet_CalculateOrbitalDefenseStrength_sub_360D8(planets[j]);
          v18 = planets[j];
          v23 = v16;
          v23 = v17 - 5 * Q_Planet_CalculateSurfaceShieldStrength_sub_36158(v18);
        }
      }
      if ( pStar == V_Game.races[raceIndex].homeStar )
      {
        v23 += 20000;
      }
      v23 = (int)((double)v23 * v28);
    }
    if ( v23 < 0 )
    {
      v23 = 0;
    }
  }
  return 5 * v23;
}

//----- (0001DE64) --------------------------------------------------------
void __fastcall __spoils<> Q_Game_Ctor_sub_1DE64(P_Game pGame)
{
  _wcpp_2_ctor_array_(pGame->races, 7u, &C_Race);
  _wcpp_2_ctor_array_(pGame->stars, 100u, &C_Star);
  _wcpp_2_ctor_array_(pGame->lanes, 148u, &C_Lane);
  _wcpp_2_ctor_array_(pGame->planets, 500u, &C_Planet);
  _wcpp_2_ctor_array_(pGame->ships, 107u, &C_Ship);
  _wcpp_2_ctor_array_(pGame->sectors, 9u, &C_Sector);
  _wcpp_2_ctor_array_(pGame->connectionGroups, 24u, &C_Type09);
  sub_1E094(pGame);
}

//----- (0001E03C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Game_Dtor_sub_1E03C(P_Game self, unsigned int a2)
{
  sub_222C0(self->connectionGroups);
  sub_222E0(self->sectors);
  sub_222A0(self->ships);
  sub_22300(self->planets);
  sub_22320(self->lanes);
  sub_22280(self->stars);
  sub_22260(self->races);
}

//----- (0001E094) --------------------------------------------------------
void __fastcall sub_1E094(P_Game pGame)
{
  char *sub_1CEA8; // eax
  int i; // kr04_4

  for ( i = 0; i != 0xD; ++i )
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(i + 0xB2);// 178: "Blue Giant"
    strcpy(V_StarTypeTexts_D84C4[i], sub_1CEA8);
  }
  pGame->starsNum = 0;
  pGame->lanesNum = 0;
  pGame->racesNum = 0;
  pGame->shipsNum = 0;
  pGame->atmosphere = 1;
}

//----- (0001E10C) --------------------------------------------------------
void __fastcall sub_1E10C(P_Game pGame, WORD starsNum, WORD racesNum, unsigned __int8 a4)
{
  pGame->Unknown_4 = 0;
  V_GridSize = 0x20;
  Q_Game_GenerateStars_sub_1E2A0(pGame, starsNum);
  sub_1E150(pGame, 9);
  sub_1EFC0(pGame);
  Q_Game_NewGame_sub_1E70C(pGame, racesNum, a4);
}
// 96B88: using guessed type int V_GridSize;

//----- (0001E150) --------------------------------------------------------
void __fastcall sub_1E150(P_Game pGame, __int16 sectors)
{
  int v3; // ebx
  T_Vector3D *p_v; // kr08_4
  int angle0; // edi
  P_Game v6; // kr00_4
  int i; // ecx
  float degrees; // [esp+0h] [ebp-44h]
  T_Vector3D vector; // [esp+10h] [ebp-34h] BYREF
  int angle2; // [esp+1Ch] [ebp-28h]
  int angle1; // [esp+20h] [ebp-24h]
  int v12; // [esp+24h] [ebp-20h]
  int v13; // [esp+28h] [ebp-1Ch]
  __int16 sectors_1; // [esp+2Ch] [ebp-18h]

  sectors_1 = sectors;
  if ( sectors > 9 )
  {
    sectors_1 = 9;
  }
  v3 = sectors_1;
  pGame->sectorsNum = 0;
  memset(&vector, 0, sizeof(vector));
  v12 = 360 / v3;
  angle1 = 3 * (360 / v3) / 4;
  p_v = &pGame->sectors[0].v;
  angle0 = 0;
  v6 = pGame;
  angle2 = angle1 / 2;
  for ( i = 0; i < sectors_1; ++i )
  {
    v6->sectors[i].n = i;
    vector.x = 1000.0;
    vector.y = 300.0;
    vector.z = 0.0;
    v13 = angle0 + rand() % angle1 - angle2;
    degrees = (float)v13;
    Q_Vector3D_RotateY_sub_532AC(&vector, degrees);
    v13 = rand() % 600 - 300;
    vector.y = (double)v13 + vector.y;
    *(T_Vector3D *)((char *)p_v + 0xD * i) = vector;
    angle0 += v12;
    ++pGame->sectorsNum;
  }
}

//----- (0001E2A0) --------------------------------------------------------
void __fastcall Q_Game_GenerateStars_sub_1E2A0(P_Game pGame, WORD stars)
{
  FILE *v2; // ebp
  __int16 j; // ax
  int typeWeight; // edx
  P_Game pGame__; // eax
  P_Game pGame___; // edx
  int currentIndex; // ecx
  T_Star *pStar; // ebp
  __int16 currentStarIndex_; // ax
  char *selectedName; // edx
  double currentRadius; // st7
  __int64 remainingStars; // rax
  __int16 accumulatedWeight; // bx
  __int16 randomWeight; // si
  __int16 k; // dx
  __int16 v16; // cx
  P_Game v17; // edx
  __int16 starsNum; // si
  __int16 i; // bx
  T_Name20 names[100]; // [esp+0h] [ebp-828h] BYREF
  float z; // [esp+7D0h] [ebp-58h] BYREF
  T_Vector3D vector; // [esp+7D4h] [ebp-54h]
  fpos_t endOffset; // [esp+7E0h] [ebp-48h]
  float pos; // [esp+7E4h] [ebp-44h]
  T_Vector3D vec1; // [esp+7E8h] [ebp-40h] BYREF
  int end; // [esp+7F4h] [ebp-34h] BYREF
  int v1; // [esp+7F8h] [ebp-30h] BYREF
  T_Star *gameStars; // [esp+7FCh] [ebp-2Ch]
  int v29; // [esp+800h] [ebp-28h]
  float *v30; // [esp+804h] [ebp-24h]
  FILE *fp; // [esp+808h] [ebp-20h]
  P_Game pGame_; // [esp+80Ch] [ebp-1Ch]
  int totalTypeWeight; // [esp+810h] [ebp-18h]
  int halfStars; // [esp+814h] [ebp-14h]
  char *namePoolPtr; // [esp+818h] [ebp-10h]
  int namesRemaining; // [esp+81Ch] [ebp-Ch]
  float spawnRadius; // [esp+820h] [ebp-8h]
  __int16 currentStarIndex; // [esp+824h] [ebp-4h]

  pGame_ = pGame;
  memset(&vec1, 0, sizeof(vec1));
  totalTypeWeight = 0;
  fp = Q_OpenTextFile_sub_1BB10("names.txt", &end);
  spawnRadius = 440.0;
  v2 = fp;
  for ( i = 0; i < 100; ++i )
  {
    fgetpos(fp, &v1);
    if ( end > v1 )
    {
      fscanf(v2, "%s", names[i]);
    }
    else
    {
      sprintf(names[i], "XM%02d", i);
    }
  }
  fclose(fp);
  namesRemaining = 100;
  pGame_->starsNum = stars;
  halfStars = stars / 2;
  for ( j = 0; j < 13; ++j )
  {
    typeWeight = V_StarTypeWeights[j];
    totalTypeWeight += typeWeight;
  }
  pGame__ = pGame_;
  pGame_->planetsNum = 0;
  pGame___ = pGame_;
  pGame__->squaresNum = 0;
  pGame___->day = 0;
  pGame___->pCurStar = pGame__->stars;
  pGame___->pCurPlanet = pGame___->planets;
  if ( pGame_->starsNum > 0 )
  {
    currentStarIndex = 0;
    gameStars = pGame__->stars;
    namePoolPtr = names[namesRemaining];
    do
    {
      currentIndex = currentStarIndex;
      pStar = &gameStars[currentStarIndex];
      pStar->planetsRacesBits = 0;
      pStar->shipsRacesBits = 0;
      pStar->exploredPathToBits = 0;
      pStar->exploredBits = 0;
      pStar->lanesNum = 0;
      pStar->connectionGroupIndex = 0xFFFF;
      currentStarIndex_ = currentStarIndex;
      pStar->planetsNum = 0;
      pStar->index = currentStarIndex_;
      // Assign random name (without replacement)
      selectedName = names[rand() % namesRemaining];
      strcpy(pStar->name, selectedName);
      // Remove used name from pool by swapping
      strcpy(selectedName, namePoolPtr + 20);
      namePoolPtr -= 20;
      --namesRemaining;
      // Reduce spawn radius after passing halfway point
      if ( currentIndex > halfStars )
      {
        currentRadius = spawnRadius + -75.0;
        spawnRadius = currentRadius;
        if ( currentRadius < 50.0 )
        {
          // Minimum radius
          spawnRadius = 50.0;
        }
        // Recalculate halfway point for remaining stars
        remainingStars = pGame_->starsNum - currentStarIndex;
        halfStars += ((int)remainingStars - HIDWORD(remainingStars)) >> 1;
      }
      pStar->type = 12;
      // Determine star type based on weighted distribution
      accumulatedWeight = 0;
      randomWeight = rand() % totalTypeWeight + 1;
      for ( k = 0; k < 13; ++k )
      {
        accumulatedWeight += V_StarTypeWeights[k];
        if ( randomWeight <= accumulatedWeight )
        {
          pStar->type = k;
          break;
        }
      }
      v29 = rand() % 1000 - 500;
      vec1.x = (float)v29;
      v29 = rand() % 1000 - 500;
      vec1.y = (float)v29;
      v29 = rand() % 1000 - 500;
      vec1.z = (float)v29;
      Q_Vector3D_Normalize_sub_53000(&vec1);
      v30 = &z;
      vector.z = vec1.x * spawnRadius;
      z = vector.z;
      *(float *)&endOffset = vec1.y * spawnRadius;
      LODWORD(vector.x) = endOffset;
      pos = spawnRadius * vec1.z;
      vector.y = pos;
      vec1.x = vector.z;
      LODWORD(vec1.y) = endOffset;
      vec1.z = pos;
      pStar->position.x = vector.z;
      pStar->position.y = vec1.y;
      v16 = currentStarIndex;
      v17 = pGame_;
      pStar->position.z = vec1.z;
      starsNum = v17->starsNum;
      currentStarIndex = v16 + 1;
    }
    while ( (__int16)(v16 + 1) < starsNum );
  }
  fclose(fp);
}

//----- (0001E70C) --------------------------------------------------------
void __fastcall Q_Game_NewGame_sub_1E70C(P_Game pGame, WORD racesNum, UBYTE playerSpecies)
{
  int v4; // eax
  int v5; // edi
  int v6; // eax
  int starsNum; // eax
  WORD k; // di
  int v9; // eax
  WORD m; // ax
  P_Lane v11; // edx
  P_Star pStar1; // ecx
  P_Star homeStar; // edx
  int starsNum_; // ebx
  T_Star *pNewHomeStar; // edx
  char raceMask; // bl
  P_Lane pLane; // eax
  P_Star pStar1_; // ecx
  P_Star pHomeStar_; // eax
  WORD jj; // cx
  unsigned __int8 randomSpecies; // bl
  UBYTE v22; // dl
  T_Race *v23; // eax
  MACRO_VFX_BOOL foundUniqueSpecies; // edi
  __int16 jjj; // ax
  int nn; // edx
  int raceIndex; // eax
  int v28; // edi
  WORD v29; // cx
  WORD v30; // cx
  WORD v31; // cx
  int kk; // edx
  int v33; // eax
  int v34; // edi
  WORD proposePeace; // cx
  WORD acceptAlliance; // cx
  WORD startAttitude; // cx
  int mm; // edx
  int v39; // eax
  int v40; // edi
  WORD v41; // cx
  WORD v42; // cx
  WORD v43; // cx
  BYTE gameAtmosphere; // al
  int shipIndex; // eax
  int v46; // kr18_4
  BYTE ability; // ch
  WORD ii; // dx
  int i2; // kr04_4
  int i3; // eax
  int i4; // ecx
  int v52; // [esp+8h] [ebp-24h]
  WORD v54; // [esp+10h] [ebp-1Ch]
  int v55; // [esp+14h] [ebp-18h]
  WORD i; // [esp+14h] [ebp-18h]
  WORD j; // [esp+14h] [ebp-18h]
  __int16 i1; // [esp+14h] [ebp-18h]
  WORD v59; // [esp+14h] [ebp-18h]
  WORD n; // [esp+18h] [ebp-14h]

  pGame->Unknown_306FC = 0xFFFFFFFF;
  pGame->endingCondition = 0;
  pGame->racesNum = racesNum;
  v52 = 0;
  for ( i = 0; i < pGame->starsNum; ++i )
  {
    v4 = i;
    pGame->stars[v4].planetsRacesBits = 0;
    pGame->stars[v4].shipsRacesBits = 0;
    pGame->stars[v4].exploredPathToBits = 0;
    pGame->stars[v4].exploredBits = 0;
  }
  for ( j = 0; j < pGame->lanesNum; ++j )
  {
    pGame->lanes[j].exploredBits = 0;
  }
  v5 = 0;
  Q_Research_LoadResTreeTxt_sub_46480(&V_Research, NULL);
  while ( 1 )
  {
    LOWORD(v55) = v5;
    v6 = (__int16)v5;
    if ( (__int16)v5 >= 7 )
    {
      break;
    }
    V_Research.current.project[(__int16)v5] = 0xFFFF;
    v5 = v55 + 1;
    word_106FB4[v6] = 0;
  }
  v54 = 600;
  starsNum = pGame->starsNum;
  pGame->_averageHomeStarDistance = 0;
  if ( starsNum < 25 )
  {
    v54 = 450;
  }
  while ( v54 > pGame->_averageHomeStarDistance )
  {
    if ( v52 )
    {
      for ( k = 0; k < pGame->racesNum; ++k )
      {
        v9 = k;
        pGame->races[v9].homeStar->planetsRacesBits = 0;
        pGame->races[v9].homeStar->exploredBits = 0;
        for ( m = 0; ; ++m )
        {
          homeStar = pGame->races[k].homeStar;
          if ( m >= homeStar->lanesNum )
          {
            break;
          }
          v11 = homeStar->lanes[m];
          pStar1 = v11->pStar1;
          v11->exploredBits = 0;
          pStar1->exploredPathToBits = 0;
          v11->pStar2->exploredPathToBits = 0;
        }
      }
    }
    // Find home star for the race
    for ( n = 0; n < pGame->racesNum; ++n )
    {
      starsNum_ = pGame->starsNum;
      pNewHomeStar = &pGame->stars[rand() % starsNum_];
      pGame->races[n].homeStar = pNewHomeStar;
      if ( pNewHomeStar->planetsRacesBits )
      {
        // If star is already occupied, then try again
        --n;
      }
      else
      {
        // Setup all presence/explored bits
        pNewHomeStar->planetsRacesBits = 0x80;
        raceMask = 1 << n;
        pGame->races[n].homeStar->planetsRacesBits |= 1 << n;
        pGame->races[n].index = n;
        pGame->races[n].homeStar->exploredBits |= 1 << n;
        // Lanes
        for ( ii = 0; ; ++ii )
        {
          pHomeStar_ = pGame->races[n].homeStar;
          if ( ii >= pHomeStar_->lanesNum )
          {
            break;
          }
          pLane = pHomeStar_->lanes[ii];
          pStar1_ = pLane->pStar1;
          pLane->exploredBits |= raceMask;
          pStar1_->exploredPathToBits |= raceMask;
          pLane->pStar2->exploredPathToBits |= raceMask;
        }
      }
    }
    v5 = v52 + 1;
    Q_Game_CalculateAverageHomeStarDistances_sub_220CC(pGame);
    ++v52;
  }
  // Set random species for races
  for ( jj = 0; jj < pGame->racesNum; ++jj )
  {
    if ( jj )
    {
      // Computer races
      do
      {
        foundUniqueSpecies = FALSE;
        randomSpecies = rand() % 21;
        jjj = 0;
        if ( jj > 0 )
        {
          while ( randomSpecies != pGame->races[jjj].species )
          {
            if ( ++jjj >= jj )
            {
              goto TRY_SPECIES_AGAIN;
            }
          }
          foundUniqueSpecies = TRUE;
        }
TRY_SPECIES_AGAIN:
        ;
      }
      while ( foundUniqueSpecies );
    }
    else
    {
      // Set chosen player species
      randomSpecies = playerSpecies;
    }
    v22 = jj;
    HIWORD(v5) = (unsigned int)pGame->races >> 0x10;
    v23 = &pGame->races[jj];
    Q_Race_InitAndSetSpecies_sub_3B1FC(v23, v22, randomSpecies);
  }
  Q_Game_SetRacesRandomColors_sub_1EE08(pGame, pGame->races[0].colorSet);
  gameAtmosphere = pGame->atmosphere;
  if ( gameAtmosphere )
  {
    if ( (unsigned __int8)gameAtmosphere <= (unsigned int)ASCEND_ATMOSPHERE_NEUTRAL )
    {
      for ( kk = 0; (__int16)kk < pGame->racesNum; ++kk )
      {
        v33 = (__int16)kk;
        LOWORD(v5) = pGame->races[v33].acceptPeace;
        pGame->races[v33].declareWar = pGame->races[v33].declareWar;
        v34 = v5 + 30;
        proposePeace = pGame->races[v33].proposePeace;
        pGame->races[v33].acceptPeace = v34;
        LOWORD(v34) = pGame->races[v33].breakAlliance;
        pGame->races[v33].proposePeace = proposePeace;
        v34 += 30;
        acceptAlliance = pGame->races[v33].acceptAlliance;
        pGame->races[v33].breakAlliance = v34;
        LOWORD(v34) = pGame->races[v33].proposeAlliance;
        pGame->races[v33].acceptAlliance = acceptAlliance;
        v5 = v34 + 40;
        startAttitude = pGame->races[v33].startAttitude;
        pGame->races[v33].proposeAlliance = v5;
        pGame->races[v33].startAttitude = startAttitude - 30;
      }
    }
    else if ( gameAtmosphere == ASCEND_ATMOSPHERE_HOSTILE )
    {
      for ( mm = 0; (__int16)mm < pGame->racesNum; ++mm )
      {
        v39 = (__int16)mm;
        LOWORD(v5) = pGame->races[v39].acceptPeace;
        pGame->races[v39].declareWar = pGame->races[v39].declareWar;
        v40 = v5 + 20;
        v41 = pGame->races[v39].proposePeace;
        pGame->races[v39].acceptPeace = v40;
        LOWORD(v40) = pGame->races[v39].breakAlliance;
        pGame->races[v39].proposePeace = v41;
        v40 += 20;
        v42 = pGame->races[v39].acceptAlliance;
        pGame->races[v39].breakAlliance = v40;
        LOWORD(v40) = pGame->races[v39].proposeAlliance;
        pGame->races[v39].acceptAlliance = v42;
        v5 = v40 + 30;
        v43 = pGame->races[v39].startAttitude;
        pGame->races[v39].proposeAlliance = v5;
        pGame->races[v39].startAttitude = v43 - 20;
      }
    }
  }
  else
  {
    // ASCEND_ATMOSPHERE_PEACEFUL
    for ( nn = 0; (__int16)nn < pGame->racesNum; ++nn )
    {
      raceIndex = (__int16)nn;
      LOWORD(v5) = pGame->races[raceIndex].acceptPeace;
      pGame->races[raceIndex].declareWar = pGame->races[raceIndex].declareWar;
      v28 = v5 + 20;
      v29 = pGame->races[raceIndex].proposePeace;
      pGame->races[raceIndex].acceptPeace = v28;
      LOWORD(v28) = pGame->races[raceIndex].breakAlliance;
      pGame->races[raceIndex].proposePeace = v29;
      v28 += 20;
      v30 = pGame->races[raceIndex].acceptAlliance;
      pGame->races[raceIndex].breakAlliance = v28;
      LOWORD(v28) = pGame->races[raceIndex].proposeAlliance;
      pGame->races[raceIndex].acceptAlliance = v30;
      v5 = v28 + 30;
      v31 = pGame->races[raceIndex].startAttitude;
      pGame->races[raceIndex].proposeAlliance = v5;
      pGame->races[raceIndex].startAttitude = v31 - 20;
    }
  }
  // Set current star as player's star system
  pGame->pCurStar = pGame->races[0].homeStar;
  // Clear all ships
  pGame->shipsNum = 0;
  for ( i1 = 0; i1 < 107; ++i1 )
  {
    shipIndex = i1;
    pGame->ships[shipIndex].raceIndex = 0xFFFF;
    pGame->ships[shipIndex].locationType = 0;
    pGame->ships[shipIndex].pLocation.pPlanet = 0;
  }
  if ( pGame->racesNum > 0 )
  {
    v59 = 0;
    do
    {
      if ( pGame->races[v59].ability == ASCEND_SA_KNOW_HOME_WORLDS && v59 == V_PlayerRaceIndex )
      {
        // The Kambuchka can sense life forms from far away.  You can see all
        // alien home stars.
        v46 = V_PlayerRaceIndex ^ v59;
        for ( i2 = 0; v46 + i2 < pGame->racesNum; ++i2 )
        {
          pGame->races[i2].homeStar->exploredBits |= 1 << v59;
        }
      }
      else
      {
        ability = pGame->races[v59].ability;
        if ( ability == ASCEND_SA_KNOW_STAR_LANES )
        {
          // The Oculons are ancient astronomers.  You can see all star lanes.
          for ( i3 = 0; i3 < pGame->lanesNum; ++i3 )
          {
            pGame->lanes[i3].exploredBits |= 1 << v59;
          }
        }
        else if ( ability == ASCEND_SA_KNOW_RACES )
        {
          // The Hanshaks are telepathic communicators.  You can talk to all other races
          // from the start of the game.
          for ( i4 = 0; i4 < pGame->racesNum; ++i4 )
          {
            if ( v59 != i4 )
            {
              pGame->races[v59].attitudes[i4] = pGame->races[v59].startAttitude;
              pGame->races[v59].treaties[i4] = ASCEND_TREATY_PEACE;
              pGame->races[i4].attitudes[v59] = pGame->races[i4].startAttitude;
              pGame->races[i4].treaties[v59] = ASCEND_TREATY_PEACE;
            }
          }
        }
      }
      ++v59;
    }
    while ( v59 < pGame->racesNum );
  }
}
// 1E7E7: variable 'v55' is possibly undefined
// 106FB4: using guessed type __int16 word_106FB4[7];

//----- (0001EE08) --------------------------------------------------------
void __fastcall Q_Game_SetRacesRandomColors_sub_1EE08(P_Game pGame, BYTE playerColor)
{
  WORD v3; // cx
  unsigned int v4; // edi
  __int16 v5; // ax
  __int16 randomColor; // [esp+2h] [ebp-14h]

  pGame->races[0].colorSet = playerColor;
  v3 = 1;
  v4 = 0xFFFFFFFF;
  if ( pGame->racesNum > 1 )
  {
    do
    {
LABEL_4:
      while ( v4 )
      {
        v4 = 0;
        randomColor = rand() % 7;
        v5 = 0;
        if ( v3 > 0 )
        {
          while ( pGame->races[v5].colorSet != randomColor )
          {
            if ( ++v5 >= v3 )
            {
              goto LABEL_4;
            }
          }
          v4 = 0xFFFFFFFF;
        }
      }
      pGame->races[v3++].colorSet = randomColor;
      v4 = 0xFFFFFFFF;
    }
    while ( v3 < pGame->racesNum );
  }
}
// 1EE3C: variable 'randomColor' is possibly undefined

//----- (0001EEA4) --------------------------------------------------------
void __fastcall sub_1EEA4(P_Game pGame)
{
  int v2; // edx
  __int16 species; // si
  int v4; // esi
  WORD racesNum; // ax
  int v6; // ecx
  char s[24]; // [esp+0h] [ebp-38h] BYREF
  int v8; // [esp+18h] [ebp-20h]
  int v9; // [esp+1Ch] [ebp-1Ch]

  if ( pGame->racesNum > 0 )
  {
    v9 = 21;
    v8 = 7;
    v6 = 0;
    do
    {
      v2 = (__int16)v6;
      species = pGame->races[v2].species;
      sprintf(s, "DATA\\SMRACE%02d.SHP", pGame->races[v2].species);
      sub_1AEB0(&WinMgr.cache, v6, s);
      sprintf(s, "DATA\\LGRACE%02d.SHP", species);
      sub_1AEB0(&WinMgr.cache, v8, s);
      sprintf(s, "DATA\\SMSHIP%02d.SHP", species);
      sub_1AEB0(&WinMgr.cache, 14u, s);
      ++v6;
      sprintf(s, "DATA\\DKSHIP%02d.SHP", species);
      v4 = v8;
      sub_1AEB0(&WinMgr.cache, v9, s);
      racesNum = pGame->racesNum;
      v8 = v4 + 1;
    }
    while ( (__int16)v6 < racesNum );
  }
}

//----- (0001EFC0) --------------------------------------------------------
void __fastcall sub_1EFC0(P_Game pGame)
{
  int i; // eax

  memset(pGame->lanes, 0, sizeof(pGame->lanes));
  pGame->lanesNum = 0;
  Q_BuildStarLanes_sub_1F91C();
  pGame->connectionGroupsNum = 2;
  while ( pGame->connectionGroupsNum > 1 )
  {
    for ( i = 0; (__int16)i < pGame->starsNum; ++i )
    {
      pGame->stars[(__int16)i].connectionGroupIndex = 0xFFFF;
    }
    Q_Game_BuildStarConnectionGroups_sub_1FB34(pGame);
    sub_201D8(pGame);
  }
}

//----- (0001F038) --------------------------------------------------------
// Initializes and calculates star system connectivity and path distances
void __fastcall Q_Game_InitializeStarConnections_sub_1F038(P_Game pGame)
{
  int v2; // edi
  UBYTE *v3; // edx
  int i; // ecx
  int j; // kr04_4
  T_Lane *lanes; // kr10_4
  unsigned __int8 starIndex1; // bl
  int starIndex2_; // edx
  unsigned __int8 v9; // bh
  unsigned __int8 v10; // bh
  unsigned __int8 connectionCountStar2; // bh
  unsigned __int8 connectionCountStar1; // al
  UBYTE *v13; // kr18_4
  UBYTE *v14; // edx
  int v15; // kr1C_4
  int v16; // kr00_4
  UBYTE *currentConnection; // ebp
  __int16 intermediate; // ax
  int fromStar_; // ebx
  int toStar_; // edx
  UBYTE currentDistance_; // cl
  UBYTE *v22; // eax
  int v23; // edx
  int k; // ecx
  int m; // ecx
  int v26; // kr24_4
  char connectionList[100][10]; // [esp+0h] [ebp-474h]
  char connectionCount[100]; // [esp+3E8h] [ebp-8Ch]
  int currentDistance; // [esp+44Ch] [ebp-28h]
  UBYTE *connectionBuffer; // [esp+450h] [ebp-24h]
  int v31; // [esp+454h] [ebp-20h]
  int v32; // [esp+458h] [ebp-1Ch]
  int remainingConnections; // [esp+45Ch] [ebp-18h]
  UBYTE *lastConnection; // [esp+460h] [ebp-14h]
  int processedCountPlusOne; // [esp+464h] [ebp-10h]
  UBYTE toStar; // [esp+468h] [ebp-Ch]
  UBYTE fromStar; // [esp+46Ch] [ebp-8h]
  unsigned __int8 starIndex2; // [esp+470h] [ebp-4h]

  if ( pGame->connectionGroupsNum != 1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5BA);
  }
  v2 = (pGame->starsNum - 1) * pGame->starsNum;
  connectionBuffer = V_BigBuffer;
  if ( !V_BigBuffer )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5C2);
  }
  v3 = connectionBuffer;
  for ( i = 0; i < pGame->starsNum; ++i )
  {
    for ( j = 0; i + 1 + j < pGame->starsNum; ++j )
    {
      v3[1] = i + 1;
      *v3 = i;
      v3 += 2;
    }
  }
  if ( v3 - connectionBuffer != v2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5D1);
  }
  // Initialize connection matrix with default values (0xFF)
  memset(pGame->starDistanceMatrix, 0xFF, sizeof(pGame->starDistanceMatrix));
  remainingConnections = v2 >> 1;
  for ( k = 0; k < pGame->starsNum; ++k )
  {
    // Initialize direct connections (distance 0 for same star)
    pGame->starDistanceMatrix[k][k] = 0;
    // Tracks number of connections per star
    connectionCount[k] = 0;
  }
  // Process starlanes (direct connections between stars)
  lanes = pGame->lanes;
  for ( m = 0; m < pGame->lanesNum; ++m )
  {
    starIndex1 = lanes[m].pStar1->index;
    starIndex2 = lanes[m].pStar2->index;
    starIndex2_ = starIndex2;
    // Set direct connection distance (1 jump)
    pGame->starDistanceMatrix[starIndex1][starIndex2] = 1;
    pGame->starDistanceMatrix[starIndex2_][starIndex1] = 1;
    // Update connection lists
    v9 = connectionCount[starIndex1];
    v31 = v9;
    connectionCount[starIndex1] = v9 + 1;
    v10 = connectionCount[starIndex2_];
    // Stores connected stars for each star
    connectionList[starIndex1][v31] = starIndex2_;
    v31 = v10;
    connectionCountStar2 = v10 + 1;
    connectionCount[starIndex2_] = connectionCountStar2;
    connectionCountStar1 = connectionCount[starIndex1];
    connectionList[starIndex2_][v31] = starIndex1;
    if ( connectionCountStar1 >= 10u || connectionCountStar2 >= 10u )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5F3);
    }
  }
  v13 = connectionBuffer;
  v14 = &connectionBuffer[2 * remainingConnections - 2];
  v15 = 0;
  if ( v14 >= connectionBuffer )
  {
    do
    {
      if ( pGame->starDistanceMatrix[v13[2 * v15]][v13[2 * v15 + 1]] == 1 )
      {
        v13[2 * v15] = *v14;
        v13[2 * v15 + 1] = v14[1];
        v14 -= 2;
        --remainingConnections;
      }
      else
      {
        ++v15;
      }
    }
    while ( &v13[2 * v15] <= v14 );
  }
  // Calculate multi-hop connections using Floyd-Warshall-like algorithm
  currentDistance = 2;
  if ( remainingConnections > 0 )
  {
    v16 = currentDistance;
    v32 = 1;
    v26 = 0;
    do
    {
      if ( pGame->starsNum <= v16 + v26 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x610);
      }
      currentConnection = connectionBuffer;
      lastConnection = &connectionBuffer[2 * remainingConnections - 2];
      if ( connectionBuffer <= lastConnection )
      {
        processedCountPlusOne = v26 + 1;
        do
        {
          fromStar = *currentConnection;
          toStar = currentConnection[1];
          // Check for intermediate connections that would make this path shorter
          for ( intermediate = 0; intermediate < (int)(unsigned __int8)connectionCount[fromStar]; ++intermediate )
          {
            fromStar_ = fromStar;
            toStar_ = toStar;
            if ( pGame->starDistanceMatrix[(unsigned __int8)connectionList[fromStar][intermediate]][toStar] == processedCountPlusOne )
            {
              // Update connection distance
              currentDistance_ = currentDistance;
              pGame->starDistanceMatrix[fromStar][toStar] = currentDistance;
              v22 = lastConnection;
              pGame->starDistanceMatrix[toStar_][fromStar_] = currentDistance_;
              *currentConnection = *v22;
              v23 = remainingConnections;
              currentConnection[1] = lastConnection[1];
              currentConnection -= 2;
              remainingConnections = v23 - 1;
              lastConnection += -2u;
              break;
            }
          }
          currentConnection += 2;
        }
        while ( currentConnection <= lastConnection );
      }
      ++v26;
    }
    while ( remainingConnections > 0 );
  }
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (0001F404) --------------------------------------------------------
int __fastcall sub_1F404(P_Game pGame)
{
  T_Star *kr18_4_1; // kr18_4
  T_Planet *planet; // ebp
  char *v3; // kr00_4
  double v4; // st7
  char *v5; // kr10_4
  int v6; // ebx
  int v7; // edx
  unsigned __int8 v8; // dl
  WORD v9; // ax
  P_Game v10; // ecx
  UWORD v11; // ax
  P_Game v12; // edx
  double v13; // st7
  P_Game v14; // edx
  int v1; // eax
  int v16; // kr14_4
  float angle; // [esp-4h] [ebp-11Ch]
  int v18[21]; // [esp+0h] [ebp-118h] BYREF
  int v19[21]; // [esp+54h] [ebp-C4h] BYREF
  T_Vector3D vector; // [esp+A8h] [ebp-70h]
  float v21[3]; // [esp+B4h] [ebp-64h] BYREF
  T_Vector3D vec1; // [esp+C0h] [ebp-58h] BYREF
  float v23; // [esp+CCh] [ebp-4Ch]
  float *v24; // [esp+D0h] [ebp-48h]
  P_Star v25; // [esp+D4h] [ebp-44h]
  T_Square *squares; // [esp+D8h] [ebp-40h]
  char *v27; // [esp+DCh] [ebp-3Ch]
  int v28; // [esp+E0h] [ebp-38h]
  int v29; // [esp+E4h] [ebp-34h]
  float v30; // [esp+E8h] [ebp-30h]
  int j; // [esp+ECh] [ebp-2Ch]
  T_Star *stars; // [esp+F0h] [ebp-28h]
  int numPlanets; // [esp+F4h] [ebp-24h]
  int v34; // [esp+F8h] [ebp-20h]
  T_Star *v35; // [esp+FCh] [ebp-1Ch]
  int v36; // [esp+100h] [ebp-18h]
  int v37; // [esp+104h] [ebp-14h]
  int v38; // [esp+108h] [ebp-10h]
  char *name; // [esp+10Ch] [ebp-Ch]
  P_Game v40; // [esp+110h] [ebp-8h]
  int i; // [esp+114h] [ebp-4h]

  v40 = pGame;
  stars = pGame->stars;
  kr18_4_1 = pGame->stars;
  squares = pGame->squares;
  planet = pGame->planets;
  v25 = (P_Star)pGame->stars[0].name;
  v3 = pGame->stars[0].name;
  for ( j = 0; ; ++j )
  {
    v1 = v40->starsNum;
    if ( v1 <= j )
    {
      break;
    }
    numPlanets = rand() % 5 + 1;
    if ( numPlanets > 5 )
    {
      numPlanets = 5;
    }
    v38 = 0xFFFFFFFF;
    for ( i = 0; v40->racesNum > i; ++i )
    {
      if ( &kr18_4_1[j] == v40->races[i].homeStar )
      {
        v38 = i;
        break;
      }
    }
    if ( v38 >= 0 && !numPlanets )
    {
      numPlanets = 1;
    }
    v34 = 0;
    if ( v38 >= 0 )
    {
      v34 = rand() % numPlanets;
    }
    kr18_4_1[j].planetsNum = numPlanets;
    memset(&vec1, 0, sizeof(vec1));
    v4 = (double)word_964FA[kr18_4_1[j].type];
    v36 = 0;
    i = 0;
    v30 = v4;
    v28 = 360 / numPlanets;
    if ( numPlanets > 0 )
    {
      v27 = &v3[0x60 * j];
      v37 = 0;
      v35 = &kr18_4_1[j];
      v29 = (int)v40 + 0x1EE * v38;
      name = planet->name;
      v5 = planet->name;
      v16 = 0;
      do
      {
        kr18_4_1[j].planets[v16] = planet;
        LOWORD(v6) = rand() % 5;
        LOWORD(v7) = rand() % 0xB;
        if ( v38 >= 0 && v34 == i )
        {
          qmemcpy(v18, dword_96548, sizeof(v18));
          qmemcpy(v19, dword_9659C, sizeof(v19));
          v8 = *(_BYTE *)(v29 + 7);
          v6 = v18[v8];
          v7 = v19[v8];
        }
        planet->totalSquaresNum = 0;
        planet->pSquares = 0;
        v9 = j;
        planet->Unknown_5A = 0;
        planet->starIndex = v9;
        v10 = v40;
        planet->Unknown_E = i;
        v11 = Q_Planet_Initialize_sub_33AF0(planet, v6, v7, &squares[v10->squaresNum]);
        v12 = v40;
        v40->squaresNum += v11;
        if ( v12->squaresNum > 20000 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x67B);
        }
        sprintf(&v5[0x7B * v16], "%s ", v27);
        Q_AppendRomanNum_sub_31E60(&v5[0x7B * v16], i + 1);
        v13 = ((double)word_964F0[v16] + v30) * 2000.0 * 0.011111111;
        v24 = v21;
        v23 = v13;
        vector.x = v23;
        vector.y = 0.0 * v23;
        vector.z = vector.y;
        v21[0] = v23;
        v21[1] = vector.y;
        v21[2] = vector.y;
        vec1.x = v23;
        vec1.y = vector.y;
        vec1.z = vector.y;
        angle = (float)v36;
        Q_Vector3D_RotateY_sub_532AC(&vec1, angle);
        Q_Planet_SetPosition_sub_362C8(planet, &vec1);
        if ( v38 >= 0 && v34 == i )
        {
          planet->raceIndex = v38;
          planet->population = 2;
          Q_Planet_BuildAtOptimalLocation_sub_34AE4(planet, 5u, 0xFFFFFFFF);
        }
        ++planet;
        ++i;
        v36 += v28;
        ++v16;
      }
      while ( i < numPlanets );
    }
    v14 = v40;
    v40->planetsNum += numPlanets;
    if ( v14->planetsNum >= 0x1F4 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x697);
    }
  }
  return v1;
}
// 96548: using guessed type int dword_96548[21];
// 9659C: using guessed type int dword_9659C[21];

//----- (0001F91C) --------------------------------------------------------
void __fastcall Q_BuildStarLanes_sub_1F91C()
{
  int i; // eax
  T_Star *pStar; // edx
  int type; // eax
  int v3; // esi
  WORD starsNum; // ax
  T_Vector3D *p_position; // ebx
  WORD v6; // dx
  T_Star *v7; // eax
  double v8; // st7
  WORD v9; // dx
  T_Vector3D v10; // [esp+14h] [ebp-48h] BYREF
  T_Vector3D v11; // [esp+20h] [ebp-3Ch] BYREF
  T_Vector3D *v12; // [esp+2Ch] [ebp-30h]
  P_Star v13; // [esp+30h] [ebp-2Ch]
  T_Star *stars; // [esp+34h] [ebp-28h]
  int v15; // [esp+38h] [ebp-24h]
  int v16; // [esp+3Ch] [ebp-20h]
  WORD v17; // [esp+40h] [ebp-1Ch]

  memset(V_Game.starDistanceMatrix, 0, sizeof(V_Game.starDistanceMatrix));
  for ( i = 0; (__int16)i < V_Game.starsNum; ++i )
  {
    V_Game.starDistanceMatrix[(__int16)i][(__int16)i] = 1;
  }
  if ( V_Game.starsNum > 0 )
  {
    LOWORD(v16) = 0;
    stars = V_Game.stars;
    do
    {
      pStar = &stars[(__int16)v16];
      type = pStar->type;
      v13 = pStar;
      if ( pStar->lanesNum != V_MaxLanesPerStarType[type] )
      {
        v3 = 5000;
        starsNum = V_Game.starsNum;
        v17 = 0xFFFF;
        p_position = &v13->position;
        v9 = 0;
        if ( starsNum > 0 )
        {
          do
          {
            if ( !V_Game.starDistanceMatrix[(__int16)v16][v9] )
            {
              v7 = &stars[v9];
              if ( v7->lanesNum != V_MaxLanesPerStarType[v7->type] )
              {
                v12 = &v10;
                memset(&v11, 0, sizeof(v11));
                v11.x = p_position->x - v7->position.x;
                v11.y = p_position->y - v7->position.y;
                v11.z = p_position->z - v7->position.z;
                v10 = v11;
                v8 = sqrt(v11.y * v11.y + v11.x * v11.x + v11.z * v11.z);
                v15 = (int)v8;
                if ( v3 > (int)v8 )
                {
                  v3 = (int)v8;
                  v17 = v9;
                }
              }
            }
            ++v9;
          }
          while ( v9 < V_Game.starsNum );
        }
        if ( v17 != 0xFFFFFFFF && !Q_CreateStarLane_sub_1CF68(v13, &stars[v17]) )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x6D0);
        }
      }
      v6 = V_Game.starsNum;
      LOWORD(v16) = v16 + 1;
    }
    while ( (__int16)v16 < v6 );
  }
}

//----- (0001FB34) --------------------------------------------------------
void __fastcall Q_Game_BuildStarConnectionGroups_sub_1FB34(P_Game pGame)
{
  WORD i; // bx
  int ii; // eax
  WORD connectionGroupsNum; // dx
  T_Type09 *pConGrp; // ecx
  P_Vector3D pCentroidPosition; // edx
  P_Star pStar; // eax
  double v8; // st7
  double inverseStarCount; // st7
  double v10; // st7
  __int16 v11; // bx
  WORD starsNum; // ax
  WORD averageStarsPerGroup; // dx
  WORD v14; // cx
  int j; // ebx
  T_Vector3D v16; // [esp+0h] [ebp-58h] BYREF
  T_Vector3D v17; // [esp+Ch] [ebp-4Ch] BYREF
  T_Vector3D v18; // [esp+18h] [ebp-40h] BYREF
  T_Vector3D v19; // [esp+24h] [ebp-34h] BYREF
  T_Vector3D *v20; // [esp+30h] [ebp-28h]
  T_Vector3D *v21; // [esp+34h] [ebp-24h]
  int v22; // [esp+38h] [ebp-20h]
  int v23; // [esp+3Ch] [ebp-1Ch]

  pGame->connectionGroupsNum = 0;
  memset(pGame->connectionGroups, 0, sizeof(pGame->connectionGroups));
  for ( i = 0; i < pGame->starsNum; ++i )
  {
    ii = i;
    if ( pGame->stars[ii].connectionGroupIndex == -1 )
    {
      Q_Game_BuildConnectionGroupFromStar_sub_1FD18(pGame, &pGame->stars[ii]);
      ++pGame->connectionGroupsNum;
    }
  }
  pGame->averageStarsPerGroup = 0;
  connectionGroupsNum = pGame->connectionGroupsNum;
  LOWORD(v23) = 0;
  if ( connectionGroupsNum > 0 )
  {
    do
    {
      pConGrp = &pGame->connectionGroups[(__int16)v23];
      pCentroidPosition = &pConGrp->centroidPosition;
      for ( j = 0; (__int16)j < pConGrp->starsNum; ++j )
      {
        pStar = pConGrp->stars[(__int16)j];
        v20 = &v16;
        memset(&v17, 0, sizeof(v17));
        v17.x = pCentroidPosition->x + pStar->position.x;
        v17.y = pConGrp->centroidPosition.y + pStar->position.y;
        v8 = pConGrp->centroidPosition.z + pStar->position.z;
        v16 = v17;
        v17.z = v8;
        pCentroidPosition->x = v17.x;
        pConGrp->centroidPosition.y = v16.y;
        pConGrp->centroidPosition.z = v16.z;
      }
      // Calculate centroid (average position) of the group
      inverseStarCount = 1.0 / (double)pConGrp->starsNum;
      v21 = &v18;
      memset(&v19, 0, sizeof(v19));
      v19.x = pCentroidPosition->x * inverseStarCount;
      v19.y = pConGrp->centroidPosition.y * inverseStarCount;
      v10 = inverseStarCount * pConGrp->centroidPosition.z;
      v18 = v19;
      v19.z = v10;
      pCentroidPosition->x = v19.x;
      pConGrp->centroidPosition.y = v18.y;
      v11 = v23;
      pConGrp->centroidPosition.z = v18.z;
      ++v11;
      starsNum = pConGrp->starsNum;
      averageStarsPerGroup = pGame->averageStarsPerGroup;
      LOWORD(v23) = v11;
      v14 = pGame->connectionGroupsNum;
      pGame->averageStarsPerGroup = starsNum + averageStarsPerGroup;
    }
    while ( v11 < v14 );
  }
  v22 = (int)((double)pGame->averageStarsPerGroup / (double)pGame->connectionGroupsNum);
  pGame->averageStarsPerGroup = v22;
}

//----- (0001FD18) --------------------------------------------------------
// Performs a depth-first search traversal of the star network
// Marks stars with connection group identifiers
void __fastcall Q_Game_BuildConnectionGroupFromStar_sub_1FD18(P_Game pGame, P_Star pStar)
{
  WORD i; // bx
  P_Star pStar1; // edx
  P_Star pStar2; // edx

  pStar->connectionGroupIndex = pGame->connectionGroupsNum;
  Q_Game_AddStarToConnectionGroup_sub_2016C(pGame, pStar, pGame->connectionGroupsNum);
  for ( i = 0; i < pStar->lanesNum; ++i )
  {
    pStar1 = pStar->lanes[i]->pStar1;
    if ( pStar1->connectionGroupIndex == -1 )
    {
      Q_Game_BuildConnectionGroupFromStar_sub_1FD18(pGame, pStar1);
    }
    pStar2 = pStar->lanes[i]->pStar2;
    if ( pStar2->connectionGroupIndex == -1 )
    {
      Q_Game_BuildConnectionGroupFromStar_sub_1FD18(pGame, pStar2);
    }
  }
}

//----- (0001FD90) --------------------------------------------------------
int __fastcall sub_1FD90(int a1, int a2, int a3)
{
  int v6; // eax
  WORD starsNum; // bx
  int v8; // edx

  if ( !a2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x71E);
  }
  v6 = 0;
  if ( V_Game.starsNum > 0 )
  {
    do
    {
      starsNum = V_Game.starsNum;
      v8 = (__int16)v6++;
      *(_BYTE *)(v8 + a2) = 0;
    }
    while ( (__int16)v6 < starsNum );
  }
  return sub_1FDF0(a1, *(_DWORD *)(a1 + 0x1EE * a3 + 0xD), a2, a3);
}

//----- (0001FDF0) --------------------------------------------------------
int __fastcall sub_1FDF0(int a1, int a2, int a3, int a4)
{
  int result; // eax
  int v5; // esi
  _BYTE *v6; // ebp
  WORD v7; // dx
  __int16 j; // bx
  int raceIndex; // eax
  int v11; // [esp+4h] [ebp-24h]
  WORD i; // [esp+14h] [ebp-14h]
  __int16 v15; // [esp+14h] [ebp-14h]
  char v16; // [esp+18h] [ebp-10h]

  v16 = 0;
  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    if ( *(_BYTE *)(0x1EE * a4 + a1 + i + 0x1C6) == 3 )
    {
      v16 |= 1 << i;
    }
  }
  result = a2;
  if ( *(__int16 *)(a2 + 0x44) > 0 )
  {
    v15 = 0;
    v11 = 1 << a4;
    do
    {
      v5 = *(_DWORD *)(a2 + 4 * v15 + 0x2C);
      result = *(__int16 *)(v5 + 0x21);
      if ( result != a4 )
      {
        if ( *(_DWORD *)v5 == a2 )
        {
          v6 = *(_BYTE **)(v5 + 4);
        }
        else
        {
          v6 = *(_BYTE **)v5;
        }
        if ( ((unsigned __int8)v11 & v6[0x17]) != 0 )
        {
          if ( (~v11 & ((unsigned __int8)(v6[0x15] & ~v16) | (unsigned __int8)(~v16 & v6[0x14])) & 0x7F) != 0 )
          {
            result = a3 + *(__int16 *)(a2 + 4);
            ++*(_BYTE *)result;
          }
          else
          {
            v7 = 0;
            for ( j = 0; j < 0x6B; ++j )
            {
              if ( v7 >= V_Game.shipsNum )
              {
                break;
              }
              raceIndex = V_Game.ships[j].raceIndex;
              if ( raceIndex != 0xFFFFFFFF )
              {
                ++v7;
                if ( (P_Planet)v5 == V_Game.ships[j].pLocation.pPlanet
                  && raceIndex != a4
                  && *(_BYTE *)(0x1EE * a4 + a1 + raceIndex + 0x1C6) != 3 )
                {
                  break;
                }
              }
            }
            if ( v7 < V_Game.shipsNum )
            {
              result = a3 + *(__int16 *)(a2 + 4);
              ++*(_BYTE *)result;
            }
            else
            {
              *(_WORD *)(v5 + 0x21) = a4;
              result = sub_1FDF0(a1, (int)v6, a3, a4);
            }
          }
        }
        else
        {
          result = a3 + *(__int16 *)(a2 + 4);
          ++*(_BYTE *)result;
        }
      }
      ++v15;
    }
    while ( v15 < *(__int16 *)(a2 + 0x44) );
  }
  return result;
}

//----- (0001FFE0) --------------------------------------------------------
int __fastcall sub_1FFE0(P_Game a1, int a2)
{
  int result; // eax
  _BYTE *v4; // edi
  WORD v5; // dx
  __int16 j; // bx
  int v7; // esi
  WORD i; // [esp+4h] [ebp-1Ch]
  __int16 v10; // [esp+4h] [ebp-1Ch]
  char v11; // [esp+8h] [ebp-18h]

  v11 = 0;
  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    if ( V_Game.races[V_PlayerRaceIndex].treaties[i] == 3 )
    {
      v11 |= 1 << i;
    }
  }
  result = a2;
  if ( *(__int16 *)(a2 + 0x44) > 0 )
  {
    v10 = 0;
    do
    {
      result = a2 + 4 * v10;
      v7 = *(_DWORD *)(result + 0x2C);
      if ( !*(_WORD *)(v7 + 0x21) )
      {
        v4 = *(_DWORD *)v7 == a2 ? *(_BYTE **)(v7 + 4) : *(_BYTE **)v7;
        result = (unsigned __int8)v4[0x17];
        if ( ((1 << V_PlayerRaceIndex) & result) != 0 )
        {
          result = ((unsigned __int8)(v4[0x15] & ~v11) | (unsigned __int8)(~v11 & v4[0x14])) & 0x7F;
          if ( (~(1 << V_PlayerRaceIndex) & result) == 0 )
          {
            v5 = 0;
            for ( j = 0; ; ++j )
            {
              result = j;
              if ( j >= 0x6B )
              {
                break;
              }
              if ( v5 >= V_Game.shipsNum )
              {
                break;
              }
              result = V_Game.ships[j].raceIndex;
              if ( result != 0xFFFFFFFF )
              {
                ++v5;
                if ( (P_Planet)v7 == V_Game.ships[j].pLocation.pPlanet
                  && result != V_PlayerRaceIndex
                  && V_Game.races[V_PlayerRaceIndex].treaties[result] != 3 )
                {
                  break;
                }
              }
            }
            if ( v5 >= V_Game.shipsNum )
            {
              *(_WORD *)(v7 + 0x21) = 1;
              ++a1->starsControlled;
              result = sub_1FFE0(a1, (int)v4);
            }
          }
        }
      }
      ++v10;
    }
    while ( v10 < *(__int16 *)(a2 + 0x44) );
  }
  return result;
}

//----- (0002016C) --------------------------------------------------------
void __fastcall Q_Game_AddStarToConnectionGroup_sub_2016C(P_Game pGame, P_Star pStar, __int16 index)
{
  T_Type09 *pConnectionGroup; // ecx

  if ( index >= 24 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7BB);
  }
  pConnectionGroup = &pGame->connectionGroups[index];
  if ( pConnectionGroup->starsNum >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7BE);
  }
  pConnectionGroup->stars[pConnectionGroup->starsNum++] = pStar;
}

//----- (000201D8) --------------------------------------------------------
void __fastcall sub_201D8(P_Game pGame)
{
  T_Type09 *v1; // ecx
  T_Type09 *v2; // esi
  int starsNum; // eax
  P_Star pStar1; // edi
  T_Star *v5; // eax
  int type; // ebx
  WORD i; // dx
  T_Type09 *v8; // ebx
  double distance; // st7
  __int16 j; // bx
  P_Star v11; // edx
  double v12; // st7
  int v13; // eax
  T_Lane *StarLane_sub_1CF68; // eax
  P_Star v15; // eax
  WORD v16; // dx
  T_Vector3D v17; // [esp+8h] [ebp-88h]
  T_Vector3D v18; // [esp+14h] [ebp-7Ch]
  T_Vector3D v19; // [esp+20h] [ebp-70h] BYREF
  T_Vector3D v20; // [esp+2Ch] [ebp-64h] BYREF
  T_Vector3D v21; // [esp+38h] [ebp-58h] BYREF
  int v22; // [esp+44h] [ebp-4Ch]
  T_Vector3D *v23; // [esp+48h] [ebp-48h]
  T_Vector3D *v24; // [esp+4Ch] [ebp-44h]
  T_Type09 *connectionGroups; // [esp+50h] [ebp-40h]
  P_Star pStar2; // [esp+54h] [ebp-3Ch]
  int v27; // [esp+58h] [ebp-38h]
  int v28; // [esp+5Ch] [ebp-34h]
  P_Game pGame_; // [esp+60h] [ebp-30h]
  int v30; // [esp+64h] [ebp-2Ch]
  int v31; // [esp+68h] [ebp-28h]
  int lanesNum; // [esp+6Ch] [ebp-24h]
  __int16 v33; // [esp+70h] [ebp-20h]
  int v34; // [esp+74h] [ebp-1Ch]

  pGame_ = pGame;
  memset(&v21, 0, sizeof(v21));
  if ( !pGame->connectionGroupsNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7DD);
  }
  if ( pGame_->connectionGroupsNum != 1 && pGame_->connectionGroupsNum > 0 )
  {
    v1 = 0;
    connectionGroups = pGame_->connectionGroups;
    LOWORD(v34) = 0;
    do
    {
      v2 = &connectionGroups[(__int16)v34];
      v27 = 99999;
      v28 = 99999;
      pStar2 = 0;
      starsNum = (unsigned __int16)v2->starsNum;
      v33 = 0;
      pStar1 = 0;
      v16 = 0;
      if ( (__int16)starsNum > 0 )
      {
        do
        {
          v5 = v2->stars[v16];
          type = v5->type;
          v22 = V_MaxLanesPerStarType[type];
          lanesNum = v5->lanesNum;
          v22 -= lanesNum;
          lanesNum = v33;
          if ( v22 > v33 )
          {
            pStar1 = v5;
            v33 = V_MaxLanesPerStarType[type] - v5->lanesNum;
          }
          ++v16;
        }
        while ( v16 < v2->starsNum );
      }
      if ( !pStar1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7FF);
      }
      for ( i = 0; i < pGame_->connectionGroupsNum; ++i )
      {
        if ( i != (_WORD)v34 )
        {
          v8 = &connectionGroups[i];
          v24 = &v19;
          v17.x = pStar1->position.x - v8->centroidPosition.x;
          v17.y = pStar1->position.y - v8->centroidPosition.y;
          v17.z = pStar1->position.z - v8->centroidPosition.z;
          v19 = v17;
          v21 = v17;
          distance = sqrt(v17.y * v17.y + v17.x * v17.x + v17.z * v17.z);
          v31 = (int)distance;
          if ( (int)distance < v27 )
          {
            v1 = v8;
            v27 = (int)distance;
          }
        }
      }
      if ( !v1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x813);
      }
      for ( j = 0; j < v1->starsNum; ++j )
      {
        v11 = v1->stars[j];
        if ( !pGame_->starDistanceMatrix[pStar1->index][v11->index] )
        {
          v23 = &v20;
          v18.x = pStar1->position.x - v11->position.x;
          v18.y = pStar1->position.y - v11->position.y;
          v18.z = pStar1->position.z - v11->position.z;
          v20 = v18;
          v21 = v18;
          v12 = sqrt(v18.y * v18.y + v18.x * v18.x + v18.z * v18.z);
          lanesNum = V_MaxLanesPerStarType[v11->type];
          v13 = v11->lanesNum;
          v30 = (int)v12;
          if ( lanesNum != v13 && v30 < v28 )
          {
            pStar2 = v11;
            v28 = v30;
          }
        }
      }
      if ( !pStar2 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x82C);
      }
      StarLane_sub_1CF68 = Q_CreateStarLane_sub_1CF68(pStar1, pStar2);
      if ( !StarLane_sub_1CF68 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x832);
      }
      StarLane_sub_1CF68->flags |= 1u;
      v15 = pStar2;
      LOBYTE(pStar1->Unknown_18) |= 1u;
      LOBYTE(v15->Unknown_18) |= 1u;
      LOWORD(v34) = v34 + 1;
    }
    while ( (__int16)v34 < pGame_->connectionGroupsNum );
  }
}

//----- (000205A0) --------------------------------------------------------
P_Lane __fastcall Q_Game_AddLane_sub_205A0(P_Game pGame, P_Star pStar1, P_Star pStar2)
{
  int lanesNum; // ebx
  T_Lane *pLane; // edx

  if ( !pStar1 || !pStar2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x83F);
  }
  lanesNum = pGame->lanesNum;
  if ( lanesNum == 148 || pGame->starDistanceMatrix[pStar1->index][pStar2->index] )
  {
    return 0;
  }
  pLane = &pGame->lanes[lanesNum];
  pLane->exploredBits = 0;
  pLane->pStar1 = pStar1;
  pLane->pStar2 = pStar2;
  ++pGame->lanesNum;
  pGame->starDistanceMatrix[pStar1->index][pStar2->index] = 1;
  pGame->starDistanceMatrix[pStar2->index][pStar1->index] = 1;
  return pLane;
}

//----- (00020684) --------------------------------------------------------
P_Ship __fastcall sub_20684(P_Game pGame, __int16 raceIndex)
{
  T_Ship *ships; // kr00_4
  int v5; // kr04_4
  P_Ship result; // eax
  __int16 i; // dx

  if ( raceIndex < 0 || raceIndex >= pGame->racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x863);
  }
  if ( pGame->shipsNum >= 107 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x864);
  }
  ships = pGame->ships;
  v5 = 0;
  for ( i = 0; i < 107; ++i )
  {
    if ( ships[v5].raceIndex == 0xFFFFFFFF )
    {
      sub_48C5C(&ships[v5], 0);
      ships[v5].raceIndex = raceIndex;
      result = &ships[v5];
      ++pGame->shipsNum;
      return result;
    }
    ++v5;
  }
  Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0x873);
  return 0;
}

//----- (00020720) --------------------------------------------------------
void __fastcall Q_Game_RemoveShip_sub_20720(P_Game pGame, P_Ship pShip)
{
  if ( pShip->raceIndex < 0 || pShip->raceIndex >= pGame->racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x87E);
  }
  if ( !pShip->locationType )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x87F);
  }
  pShip->raceIndex = 0xFFFF;
  pShip->locationType = ASCEND_LOCATION_TYPE_VOID;
  pShip->name[0] = '\0';
  if ( --pGame->shipsNum < 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x887);
  }
}

//----- (000207A0) --------------------------------------------------------
void __fastcall sub_207A0(P_Game a1)
{
  T_Race *v2; // ebp
  P_Game v3; // kr00_4
  int v4; // kr30_4
  int v5; // kr34_4
  BYTE v6; // bl
  int v7; // edx
  int v8; // eax
  BYTE atmosphere; // ch
  double v10; // st6
  int i; // eax
  int j; // eax
  int k; // eax
  int m; // eax
  int n; // edx
  int ii; // eax
  int jj; // edx
  int kk; // eax
  int v19; // [esp+8h] [ebp-24h]
  int v20; // [esp+8h] [ebp-24h]
  int v21; // [esp+8h] [ebp-24h]
  unsigned __int8 v22; // [esp+Ch] [ebp-20h]
  BYTE v23; // [esp+10h] [ebp-1Ch]

  v23 = 0;
  v2 = &a1->races[V_PlayerRaceIndex];
  if ( v2->extinct == 0xFFFFFFFF )
  {
    v23 = 1;
  }
  if ( !v23 )
  {
    v3 = a1;
    v23 = 2;
    for ( i = 0; i < a1->racesNum; ++i )
    {
      if ( i != V_PlayerRaceIndex && !v3->races[i].extinct )
      {
        v23 = 0;
        break;
      }
    }
  }
  if ( !v23 )
  {
    v23 = 3;
    for ( j = 0; j < a1->racesNum; ++j )
    {
      if ( (a1->races[j].homeStar->planetsRacesBits & 0x7F) != 1 << V_PlayerRaceIndex )
      {
        v23 = 0;
        break;
      }
    }
  }
  if ( !v23 )
  {
    v22 = 0;
    v23 = 4;
    for ( k = 0; k < a1->racesNum; ++k )
    {
      if ( !a1->races[k].extinct )
      {
        v22 |= 1 << k;
      }
      if ( k != V_PlayerRaceIndex && !a1->races[k].extinct && v2->treaties[k] != 3 )
      {
        v23 = 0;
        break;
      }
    }
    if ( v23 == 4 )
    {
      for ( m = 0; m < a1->starsNum; ++m )
      {
        if ( (v22 & a1->stars[m].exploredBits) == 0 )
        {
          v23 = 0;
          break;
        }
      }
    }
  }
  if ( !v23 && 2 * a1->starsNum / 3 + 1 <= a1->starsControlled )
  {
    v23 = 5;
  }
  if ( v23 )
  {
    v19 = 0;
    for ( n = 0; n < V_Research.num; ++n )
    {
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[n].knownToRace) != 0 )
      {
        ++v19;
      }
    }
    for ( ii = 0; ii < a1->planetsNum; ++ii )
    {
      if ( V_PlayerRaceIndex == a1->planets[ii].raceIndex )
      {
        v19 += 2;
      }
    }
    v4 = Q_Race_GetShips_sub_40224(v2, 0, 0) + v19;
    v5 = 0;
    for ( jj = 0; jj < a1->starsNum; ++jj )
    {
      if ( ((1 << V_PlayerRaceIndex) & a1->stars[jj].exploredBits) != 0 )
      {
        ++v5;
      }
    }
    v20 = v4 + v5;
    for ( kk = 0; kk < a1->racesNum; ++kk )
    {
      if ( kk != V_PlayerRaceIndex && a1->races[kk].extinct != 0xFFFFFFFF )
      {
        v6 = v2->treaties[kk];
        if ( v6 == 3 )
        {
          v20 += 15;
        }
        else if ( v6 == 2 )
        {
          v20 -= 10;
        }
      }
    }
    if ( v23 == 4 )
    {
      v20 += 50;
    }
    v7 = 100 - 75 * a1->day / 4000;
    v8 = v7;
    if ( v7 >= 25 )
    {
      if ( v7 > 100 )
      {
        v8 = 100;
      }
    }
    else
    {
      v8 = 25;
    }
    atmosphere = a1->atmosphere;
    v21 = v8 * v20 / 100;
    if ( atmosphere == 1 )
    {
      v10 = (double)v21 * 1.25;
    }
    else
    {
      if ( atmosphere != 2 )
      {
LABEL_71:
        if ( v21 < 0 )
        {
          v21 = 0;
        }
        a1->endingCondition = v23;
        a1->Unknown_306FC = 100 * v21 / 600;
        WinMgr.gameEventsNum = 0;
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 9, 1);
        return;
      }
      v10 = (double)v21 * 1.5;
    }
    v21 = (int)v10;
    goto LABEL_71;
  }
}

//----- (00020B3C) --------------------------------------------------------
T_Star *__fastcall sub_20B3C(P_Game pGame)
{
  T_Star *stars; // esi
  int i; // eax
  int v4; // kr04_4
  int ShipsAtLocation_sub_1D794; // ecx
  __int16 k; // ax
  int shipRaceIndex; // edx
  WORD j; // di
  P_Ship shipsArray[107]; // [esp+0h] [ebp-1CCh] BYREF
  unsigned __int8 EnemyRacesMask_sub_43374; // [esp+1ACh] [ebp-20h]
  unsigned __int8 v12; // [esp+1B0h] [ebp-1Ch]

  v12 = 1 << V_PlayerRaceIndex;
  stars = pGame->stars;
  EnemyRacesMask_sub_43374 = Q_Race_GetEnemyRacesMask_sub_43374(&V_Game.races[V_PlayerRaceIndex], 0xFFFFFFFF);
  if ( !pGame->Unknown_4 )
  {
    for ( i = 0; (__int16)i < pGame->starsNum; ++i )
    {
      byte_D8460[(__int16)i] &= ~1u;
    }
  }
  v4 = 0;
  for ( j = 0; j < pGame->starsNum; ++v4 )
  {
    if ( (byte_D8460[j] & 1) == 0 )
    {
      byte_D8460[j] |= 1u;
      if ( (v12 & stars[v4].shipsRacesBits) != 0 && (EnemyRacesMask_sub_43374 & stars[v4].shipsRacesBits) != 0 )
      {
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&stars[v4], shipsArray);
        for ( k = 0; k < ShipsAtLocation_sub_1D794; ++k )
        {
          shipRaceIndex = shipsArray[k]->raceIndex;
          if ( (shipRaceIndex == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[shipRaceIndex] == ASCEND_TREATY_WAR)
            && shipsArray[k]->availablePower > 0 )
          {
            ++pGame->Unknown_4;
            return &stars[v4];
          }
        }
      }
    }
    ++j;
  }
  return 0;
}

//----- (00020C94) --------------------------------------------------------
void __fastcall sub_20C94(P_Game pGame, int a2, int a3, int a4)
{
  unsigned __int8 v5; // cl
  int v6; // edx
  int v7; // eax
  int v8; // eax
  T_Wnd03CTW *WndWithState_sub_56E18; // eax
  char *v10; // kr00_4
  int ShipsAtLocation_sub_1D794; // ebx
  WORD v12; // dx
  __int16 k; // cx
  __int16 *v14; // eax
  int v15; // eax
  BYTE endingCondition; // ch
  int i; // edx
  int j; // edx
  __int16 m; // dx
  int n; // eax
  int v21; // [esp-10h] [ebp-1E8h]
  int v22; // [esp-Ch] [ebp-1E4h]
  int shipsRacesBits; // [esp-8h] [ebp-1E0h]
  int v24; // [esp-4h] [ebp-1DCh]
  void *v25[107]; // [esp+0h] [ebp-1D8h] BYREF
  FILE *fp; // [esp+1ACh] [ebp-2Ch]
  char *name; // [esp+1B0h] [ebp-28h]
  char *v28; // [esp+1B4h] [ebp-24h]
  char *v29; // [esp+1B8h] [ebp-20h]
  int v30; // [esp+1BCh] [ebp-1Ch]

  if ( V_SelfPlayMode == 0xFFFFFFFF && pGame->day >= 0x1388 )
  {
    v5 = rand() % 0x15;
    v6 = rand() % 5 + 3;
    v7 = rand();
    sub_1E10C(pGame, v7 % 0x4C + 0x19, v6, v5);
    Q_Game_InitializeStarConnections_sub_1F038(pGame);
    sub_1F404(pGame);
    sub_1EEA4(pGame);
    v8 = rand();
    Q_Game_SetRacesRandomColors_sub_1EE08(pGame, v8 % 6);
    pGame->day = 0;
    WndWithState_sub_56E18 = (T_Wnd03CTW *)Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "RACECONTROLS", 1, 0);
    if ( !WndWithState_sub_56E18 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x9B7);
    }
    WndWithState_sub_56E18->a2.pProcs->proc4_draw(&WndWithState_sub_56E18->a2, 0);
  }
  pGame->Unknown_4 = 0;
  memset(byte_D8460, 0, sizeof(byte_D8460));
  sub_21170(pGame);
  sub_21314(pGame);
  Q_Research_DoProgress_sub_466FC(&V_Research);
  for ( i = 0; i < *(__int16 *)((char *)&pGame->day + (_DWORD)&loc_27281 + 2); ++i )
  {
    sub_352E0(&pGame->planets[i]);
  }
  sub_2106C(pGame);
  for ( j = 0; j < pGame->racesNum; ++j )
  {
    if ( j != V_PlayerRaceIndex )
    {
      sub_3B220(&pGame->races[j]);
    }
  }
  sub_3B220(&V_Game.races[V_PlayerRaceIndex]);
  if ( V_CheatMode == 0xFFFFFFFF )
  {
    fp = fopen("numships.dbg", "at");
    if ( V_Game.starsNum > 0 )
    {
      v30 = 0;
      name = V_Game.stars[0].name;
      v10 = V_Game.stars[0].name;
      do
      {
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[v30], (P_Ship *)v25);
        v12 = 0;
        if ( V_Game.racesNum > 0 )
        {
          v29 = &v10[0x60 * v30];
          do
          {
            if ( ((1 << v12) & V_Game.stars[v30].shipsRacesBits) != 0 )
            {
              for ( k = 0; k < ShipsAtLocation_sub_1D794 && v12 != *((_WORD *)v25[k] + 0x2B); ++k )
              {
                ;
              }
              if ( k >= ShipsAtLocation_sub_1D794 )
              {
                shipsRacesBits = V_Game.stars[v30].shipsRacesBits;
                ++word_D845C;
                fprintf(fp, "T%04d: %s flags (%d) show R%d ship, but none found.\n", pGame->day + 1, v29, shipsRacesBits, v12);
              }
            }
            ++v12;
          }
          while ( v12 < V_Game.racesNum );
        }
        v28 = &v10[0x60 * v30];
        for ( m = 0; m < ShipsAtLocation_sub_1D794; ++m )
        {
          v14 = (__int16 *)v25[m];
          if ( *((_BYTE *)v14 + 0x58) != 1 && ((1 << v14[0x2B]) & V_Game.stars[v30].shipsRacesBits) == 0 )
          {
            v24 = V_Game.stars[v30].shipsRacesBits;
            v22 = v14[0x2B];
            v21 = pGame->day + 1;
            ++word_D845C;
            fprintf(fp, "T%04d: R%d ship exists at %s, flags (%d) indicate otherwise.\n", v21, v22, v28, v24);
          }
        }
        ++v30;
      }
      while ( (__int16)v30 < V_Game.starsNum );
    }
    fclose(fp);
  }
  for ( n = 0; (__int16)n < V_Game.lanesNum; ++n )
  {
    *(_WORD *)pGame->lanes[n].Unknown_21 = 0;
  }
  v15 = V_PlayerRaceIndex;
  if ( ((1 << V_PlayerRaceIndex) & V_Game.races[v15].homeStar->planetsRacesBits) != 0 )
  {
    pGame->starsControlled = 1;
    sub_1FFE0(pGame, (int)V_Game.races[v15].homeStar);
  }
  else
  {
    pGame->starsControlled = 0;
  }
  endingCondition = pGame->endingCondition;
  ++pGame->day;
  if ( !endingCondition && V_SelfPlayMode == FALSE )
  {
    sub_207A0(pGame);
  }
}
// D845C: using guessed type __int16 word_D845C;
// 20C94: using guessed type P_Ship var_1D8[107];

//----- (0002106C) --------------------------------------------------------
void __fastcall sub_2106C(P_Game pGame)
{
  WORD i; // si
  int v3; // edx
  WORD v4; // si
  __int16 v5; // bx
  WORD j; // ax
  int Ships_sub_40224; // [esp+0h] [ebp-20h] BYREF
  __int16 v8; // [esp+4h] [ebp-1Ch]

  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    v3 = i;
    Ships_sub_40224 = Q_Race_GetShips_sub_40224(&V_Game.races[i], 0, &Ships_sub_40224);
    pGame->racePowerStats[v3].shipsNum = Ships_sub_40224;
    pGame->racePowerStats[v3].planetsNum = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[i]);
  }
  if ( V_Game.racesNum > 0 )
  {
    v4 = 0;
    do
    {
      v8 = pGame->racePowerStats[v4].planetsNum + pGame->racePowerStats[v4].shipsNum;
      v5 = 0;
      for ( j = 0; j < V_Game.racesNum; ++j )
      {
        if ( v4 != j && pGame->racePowerStats[j].shipsNum + pGame->racePowerStats[j].planetsNum > v8 )
        {
          ++v5;
        }
      }
      pGame->racePowerStats[v4++].powerGap = v5;
    }
    while ( v4 < V_Game.racesNum );
  }
}

//----- (00021170) --------------------------------------------------------
void __fastcall sub_21170(P_Game a1)
{
  T_Star *stars; // esi
  unsigned __int8 v3; // al
  int v4; // ecx
  unsigned __int8 v5; // [esp+0h] [ebp-18h]

  v5 = 1 << V_PlayerRaceIndex;
  if ( a1->starsNum > 0 )
  {
    stars = a1->stars;
    v4 = 0;
    do
    {
      v3 = stars[v4].planetsRacesBits | stars[v4].shipsRacesBits;
      stars[v4].z2 = 0;
      if ( (v3 & v5) == 0 )
      {
        if ( v3 )
        {
          sub_211EC(a1, &stars[v4], 0);
        }
        stars[v4].z2 = 0xFFFFFFFF;
      }
      ++v4;
    }
    while ( (__int16)v4 < a1->starsNum );
  }
}

//----- (000211EC) --------------------------------------------------------
void __fastcall sub_211EC(P_Game pGame, P_Star pStar, int a3)
{
  WORD racesNum; // cx
  int v7; // ebx
  T_Race *races; // ebp
  int v9; // edi
  __int16 v10; // cx
  WORD v11; // ax
  __int16 v12[8]; // [esp+2h] [ebp-2Ch]
  T_Target v13; // [esp+12h] [ebp-1Ch] BYREF
  int v14; // [esp+1Ah] [ebp-14h]

  if ( V_SelfPlayMode == 0xFFFFFFFF )
  {
    a3 = V_SelfPlayMode;
  }
  racesNum = pGame->racesNum;
  LOWORD(v14) = 0;
  v11 = 0;
  if ( racesNum > 0 )
  {
    do
    {
      if ( a3 || (a3 = 0, v11 != V_PlayerRaceIndex) )
      {
        if ( ((unsigned __int8)(pStar->shipsRacesBits | pStar->planetsRacesBits) & (unsigned __int8)(1 << v11)) != 0 )
        {
          v7 = (__int16)v14;
          LOWORD(v14) = v14 + 1;
          v12[v7] = v11;
        }
      }
      ++v11;
    }
    while ( v11 < pGame->racesNum );
  }
  if ( (_WORD)v14 )
  {
    races = pGame->races;
    while ( 1 )
    {
      v9 = 0;
      v10 = 0;
      if ( (__int16)v14 > 0 )
      {
        break;
      }
LABEL_15:
      if ( !v9 )
      {
        return;
      }
    }
    while ( 1 )
    {
      v13.type = 0;
      v9 |= sub_406C4(&races[v12[v10]], pStar, &v13);
      if ( !v13.type )
      {
        goto LABEL_14;
      }
      if ( v13.type < 2u )
      {
        break;
      }
      if ( v13.type <= 2u )
      {
        sub_3676C(v13.pObject.pPlanet, 1);
      }
      else
      {
        if ( v13.type != 3 )
        {
          break;
        }
        sub_49B3C(v13.pObject.pShip, 1);
      }
LABEL_14:
      if ( ++v10 >= (__int16)v14 )
      {
        goto LABEL_15;
      }
    }
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0xAE2);
    goto LABEL_14;
  }
}
// 211EC: using guessed type __int16 var_2C[8];

//----- (00021314) --------------------------------------------------------
void __fastcall sub_21314(P_Game a1)
{
  P_Star pStar; // ecx
  int v3; // edi

  if ( a1->starsNum > 0 )
  {
    pStar = a1->stars;
    v3 = 0;
    do
    {
      if ( pStar[v3].z2 != 0xFFFFFFFF )
      {
        if ( pStar[v3].planetsRacesBits | pStar[v3].shipsRacesBits )
        {
          sub_211EC(a1, &pStar[v3], 0xFFFFFFFF);
        }
        pStar[v3].z2 = 0xFFFFFFFF;
      }
      ++v3;
    }
    while ( (__int16)v3 < a1->starsNum );
  }
}

//----- (00021374) --------------------------------------------------------
void __fastcall Q_Game_SaveGam_sub_21374(P_Game pGame, P_CFile pfi)
{
  WORD j; // cx
  T_Star *pStar; // esi
  WORD v4; // cx
  T_Planet *planets; // esi
  __int16 kk; // si
  P_Ship vpShips; // edi
  char *v8; // eax
  WORD l; // cx
  T_Race *races; // esi
  WORD m; // cx
  T_Lane *pLanes; // esi
  __int16 i; // ax
  __int16 v14; // di
  __int16 v15; // bx
  T_Sector *sectors; // esi
  __int16 k; // cx
  WORD v18; // cx
  T_Type09 v19; // [esp+0h] [ebp-238h] BYREF
  T_Lane lane; // [esp+1A0h] [ebp-98h] BYREF
  T_SavBlock1Sizes v21; // [esp+1C8h] [ebp-70h] BYREF
  P_Game vpGame; // [esp+1E8h] [ebp-50h]
  int day; // [esp+1ECh] [ebp-4Ch] BYREF
  int index; // [esp+1F0h] [ebp-48h] BYREF
  int v25; // [esp+1F4h] [ebp-44h] BYREF
  int endingCondition; // [esp+1F8h] [ebp-40h] BYREF
  int Unknown_306FC; // [esp+1FCh] [ebp-3Ch] BYREF
  int v28; // [esp+200h] [ebp-38h] BYREF
  int v29; // [esp+204h] [ebp-34h] BYREF
  int v30; // [esp+208h] [ebp-30h] BYREF
  int starsNum; // [esp+20Ch] [ebp-2Ch] BYREF
  int squaresNum; // [esp+210h] [ebp-28h] BYREF
  int planetsNum; // [esp+214h] [ebp-24h] BYREF
  int shipsNum; // [esp+218h] [ebp-20h] BYREF
  int v35; // [esp+21Ch] [ebp-1Ch] BYREF
  int racesNum; // [esp+220h] [ebp-18h] BYREF
  int lanesNum; // [esp+224h] [ebp-14h] BYREF
  int connectionGroupsNum; // [esp+228h] [ebp-10h] BYREF
  int sectorsNum; // [esp+22Ch] [ebp-Ch] BYREF
  T_Type09 *connectionGroups; // [esp+230h] [ebp-8h]
  __int16 v41; // [esp+234h] [ebp-4h]

  vpGame = pGame;
  // Block 1 - Sizes
  v21.sizeResTree = 0x1D72;
  v21.sizeStar = 0x60;
  v21.sizePlanet = 0x7B;
  v21.sizeRace = 0x1EE;
  v21.magic5 = 0x19E;
  v21._sizeSector = 0xD;
  v21.sizeGame = 0x354EF;
  v21.magic4 = 0x27;
  // Block 2
  Q_CFile_Write_sub_1C098(pfi, &v21, 0x20u);
  day = vpGame->day;
  Q_CFile_Write_sub_1C098(pfi, &day, 4u);
  index = vpGame->pCurStar->index;
  Q_CFile_Write_sub_1C098(pfi, &index, 4u);
  v25 = vpGame->pCurPlanet - vpGame->planets;
  Q_CFile_Write_sub_1C098(pfi, &v25, 4u);
  endingCondition = vpGame->endingCondition;
  Q_CFile_Write_sub_1C098(pfi, &endingCondition, 4u);
  Unknown_306FC = vpGame->Unknown_306FC;
  Q_CFile_Write_sub_1C098(pfi, &Unknown_306FC, 4u);
  v28 = V_Day1;
  Q_CFile_Write_sub_1C098(pfi, &v28, 4u);
  v29 = V_Day2;
  Q_CFile_Write_sub_1C098(pfi, &v29, 4u);
  v30 = V_Day3;
  Q_CFile_Write_sub_1C098(pfi, &v30, 4u);
  // Block 3 - ResTree
  Q_ReadWriteResTree_sub_46BB0(&V_Research, pfi, FALSE);
  // Block 4 - Stars
  starsNum = vpGame->starsNum;
  Q_CFile_Write_sub_1C098(pfi, &starsNum, 4u);
  j = 0;
  if ( vpGame->starsNum > 0 )
  {
    pStar = vpGame->stars;
    do
    {
      Q_ReadWriteStar_sub_1D920(&pStar[j++], pfi, FALSE);
    }
    while ( j < vpGame->starsNum );
  }
  // Block 5 - Planet squares
  squaresNum = vpGame->squaresNum;
  Q_CFile_Write_sub_1C098(pfi, &squaresNum, 4u);
  Q_CFile_Write_sub_1C098(pfi, vpGame->squares, 4 * vpGame->squaresNum);
  // Block 6 - Planets
  planetsNum = vpGame->planetsNum;
  Q_CFile_Write_sub_1C098(pfi, &planetsNum, 4u);
  v4 = 0;
  if ( vpGame->planetsNum > 0 )
  {
    planets = vpGame->planets;
    do
    {
      Q_Planet_ReadWrite_sub_370B8(&planets[v4++], pfi, FALSE);
    }
    while ( v4 < vpGame->planetsNum );
  }
  // Block 7 - Ships
  kk = 0;
  shipsNum = vpGame->shipsNum;
  vpShips = vpGame->ships;
  Q_CFile_Write_sub_1C098(pfi, &shipsNum, 4u);
  for ( k = 0; k < 0x6B; ++k )
  {
    v8 = (char *)vpGame + 0x162 * k;
    if ( *(__int16 *)(v8 + 0x272DB) != 0xFFFFFFFF )
    {
      if ( !v8[0x272DD] )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB57);
      }
      v35 = k;
      Q_CFile_Write_sub_1C098(pfi, &v35, 4u);
      ++kk;
      Q_Ship_ReadWrite_sub_4AE8C(&vpShips[k], pfi, FALSE);
    }
  }
  if ( kk != vpGame->shipsNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB65);
  }
  // Block 8 - Races
  racesNum = vpGame->racesNum;
  Q_CFile_Write_sub_1C098(pfi, &racesNum, 4u);
  l = 0;
  if ( vpGame->racesNum > 0 )
  {
    races = vpGame->races;
    do
    {
      Q_Race_ReadWriteFile_sub_43BDC(&races[l++], pfi, FALSE);
    }
    while ( l < vpGame->racesNum );
  }
  // Block 9 - Lanes
  lanesNum = vpGame->lanesNum;
  Q_CFile_Write_sub_1C098(pfi, &lanesNum, 4u);
  memset(&lane.vector1, 0, 0x18);
  m = 0;
  if ( vpGame->lanesNum > 0 )
  {
    pLanes = vpGame->lanes;
    do
    {
      lane = pLanes[m];
      lane.pStar1 = (P_Star)lane.pStar1->index;
      lane.pStar2 = (P_Star)lane.pStar2->index;
      Q_CFile_Write_sub_1C098(pfi, &lane, 0x27u);
      ++m;
    }
    while ( m < vpGame->lanesNum );
  }
  // Block 10
  Q_CFile_Write_sub_1C098(pfi, vpGame->starDistanceMatrix, 10000u);
  // Block 11
  connectionGroupsNum = vpGame->connectionGroupsNum;
  Q_CFile_Write_sub_1C098(pfi, &connectionGroupsNum, 4u);
  memset(&v19.centroidPosition, 0, sizeof(v19.centroidPosition));
  if ( vpGame->connectionGroupsNum > 0 )
  {
    v41 = 0;
    connectionGroups = vpGame->connectionGroups;
    do
    {
      qmemcpy(&v19, &connectionGroups[v41], sizeof(v19));
      *(_DWORD *)&i = 0;
      if ( v19.starsNum > 0 )
      {
        do
        {
          v19.stars[i] = (P_Star)v19.stars[i]->index;
          ++*(_DWORD *)&i;
        }
        while ( i < v19.starsNum );
      }
      v14 = v41;
      Q_CFile_Write_sub_1C098(pfi, &v19, 0x19Eu);
      v15 = vpGame->connectionGroupsNum;
      v41 = v14 + 1;
    }
    while ( (__int16)(v14 + 1) < v15 );
  }
  // Block 12 - Sectors
  sectorsNum = vpGame->sectorsNum;
  Q_CFile_Write_sub_1C098(pfi, &sectorsNum, 4u);
  if ( vpGame->sectorsNum > 0 )
  {
    sectors = vpGame->sectors;
    v18 = 0;
    do
    {
      Q_CFile_Write_sub_1C098(pfi, &sectors[v18++], 0xDu);
    }
    while ( v18 < vpGame->sectorsNum );
  }
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00021AA0) --------------------------------------------------------
void __fastcall Q_Game_LoadGam_sub_21AA0(P_Game pGame, P_CFile pfi)
{
  __int16 v4; // ax
  T_Star *v5; // eax
  T_Square *squares; // ebp
  __int16 v7; // ax
  WORD v8; // cx
  unsigned int v9; // eax
  __int16 i; // ax
  int v11; // edx
  __int16 v12; // ax
  T_Race *v13; // eax
  __int16 v14; // ax
  int laneIndex; // ebp
  T_Lane *v16; // ecx
  T_Star *v17; // ebx
  int pStar2; // eax
  T_Star *v19; // edx
  T_Star *v20; // eax
  int v21; // ebp
  WORD connectionGroupsNum; // cx
  int k; // eax
  WORD v24; // dx
  __int16 v25; // ax
  T_Sector *v26; // edx
  WORD v27; // cx
  WORD j; // cx
  WORD v29; // cx
  WORD v30; // cx
  _DWORD v31[95]; // [esp+0h] [ebp-1E0h] BYREF
  _WORD v32[5]; // [esp+190h] [ebp-50h]
  int v33; // [esp+19Ah] [ebp-46h]
  T_SavBlock1Sizes v34; // [esp+1A0h] [ebp-40h] BYREF
  int buf; // [esp+1C0h] [ebp-20h] BYREF
  unsigned int v36; // [esp+1C4h] [ebp-1Ch]
  T_Star *stars; // [esp+1C8h] [ebp-18h]
  T_Planet *planets; // [esp+1CCh] [ebp-14h]
  T_Lane *lanes; // [esp+1D0h] [ebp-10h]
  WORD lanesNum; // [esp+1D4h] [ebp-Ch]
  __int16 v41; // [esp+1D8h] [ebp-8h]
  int v42; // [esp+1DCh] [ebp-4h]

  Q_CFile_Read_sub_1BF94(pfi, &v34, 0x20u);
  if ( v34.sizeResTree != 0x1D72 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAA);
  }
  if ( v34.sizeStar != 0x60 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAB);
  }
  if ( v34.sizePlanet != 0x7B )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAC);
  }
  if ( v34.sizeRace != 0x1EE )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAD);
  }
  if ( v34.magic4 != 0x27 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAE);
  }
  if ( v34.magic5 != 0x19E )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAF);
  }
  if ( v34._sizeSector != 0xD )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBB0);
  }
  if ( v34.sizeGame != 0x354EF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBB1);
  }
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->day = buf;
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->pCurStar = &pGame->stars[buf];
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->pCurPlanet = &pGame->planets[buf];
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->endingCondition = buf;
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->Unknown_306FC = buf;
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  V_Day1 = buf;
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  V_Day2 = buf;
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  V_Day3 = buf;
  Q_ReadWriteResTree_sub_46BB0(&V_Research, pfi, TRUE);
  // Block 4 - Stars
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  v4 = buf;
  pGame->starsNum = buf;
  v27 = 0;
  if ( v4 > 0 )
  {
    do
    {
      v5 = &pGame->stars[v27++];
      Q_ReadWriteStar_sub_1D920(v5, pfi, TRUE);
    }
    while ( v27 < pGame->starsNum );
  }
  // Block 5 - Planet squares
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->squaresNum = buf;
  squares = pGame->squares;
  Q_CFile_Read_sub_1BF94(pfi, pGame->squares, 4 * pGame->squaresNum);
  // Block 6 - Planets
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  v7 = buf;
  v8 = 0;
  pGame->planetsNum = buf;
  if ( v7 > 0 )
  {
    planets = pGame->planets;
    do
    {
      v36 = 0x7B * v8;
      Q_Planet_ReadWrite_sub_370B8(&planets[v36 / 0x7B], pfi, TRUE);
      v9 = v36;
      pGame->planets[v36 / 0x7B].pSquares = squares;
      ++v8;
      squares += *(unsigned __int16 *)((char *)&pGame->planets[0].totalSquaresNum + v9);
    }
    while ( v8 < pGame->planetsNum );
  }
  // Block 7 - Ships
  for ( i = 0; i < 107; ++i )
  {
    v11 = i;
    pGame->ships[v11].raceIndex = 0xFFFF;
    pGame->ships[v11].locationType = 0;
  }
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->shipsNum = buf;
  for ( j = 0; j < 107; ++j )
  {
    if ( j < pGame->shipsNum )
    {
      Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
      Q_Ship_ReadWrite_sub_4AE8C(&pGame->ships[buf], pfi, TRUE);
    }
  }
  // Block 8 - Races
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  v12 = buf;
  pGame->racesNum = buf;
  v29 = 0;
  if ( v12 > 0 )
  {
    do
    {
      v13 = &pGame->races[v29++];
      Q_Race_ReadWriteFile_sub_43BDC(v13, pfi, TRUE);
    }
    while ( v29 < pGame->racesNum );
  }
  // Block 9 - Lanes
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  v14 = buf;
  pGame->lanesNum = buf;
  if ( v14 > 0 )
  {
    lanes = pGame->lanes;
    stars = pGame->stars;
    v41 = 0;
    do
    {
      laneIndex = v41;
      v16 = &lanes[laneIndex];
      Q_CFile_Read_sub_1BF94(pfi, &lanes[laneIndex], 0x27u);
      v17 = &stars[(int)pGame->lanes[laneIndex].pStar1];
      pStar2 = (int)pGame->lanes[laneIndex].pStar2;
      v19 = stars;
      pGame->lanes[laneIndex].pStar1 = v17;
      v20 = &v19[pStar2];
      pGame->lanes[laneIndex].pStar2 = v20;
      lanesNum = v17->lanesNum;
      v21 = lanesNum;
      v17->lanesNum = lanesNum + 1;
      v17->lanes[v21] = v16;
      LOWORD(v19) = v20->lanesNum;
      v20->lanesNum = (_WORD)v19 + 1;
      v20->lanes[(__int16)v19] = v16;
      LOWORD(v19) = pGame->lanesNum;
      ++v41;
    }
    while ( v41 < (__int16)v19 );
  }
  // Block 10
  Q_CFile_Read_sub_1BF94(pfi, pGame->starDistanceMatrix, 10000u);
  // Block 11
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  pGame->connectionGroupsNum = buf;
  *(_DWORD *)&v32[3] = 0;
  v33 = 0;
  *(_DWORD *)&v32[1] = 0;
  connectionGroupsNum = pGame->connectionGroupsNum;
  v42 = 0;
  if ( connectionGroupsNum > 0 )
  {
    do
    {
      Q_CFile_Read_sub_1BF94(pfi, v31, 0x19Eu);
      for ( k = 0; (__int16)k < v32[0]; ++k )
      {
        v31[(__int16)k] = &pGame->stars[v31[(__int16)k]];
      }
      v24 = pGame->connectionGroupsNum;
      ++v42;
    }
    while ( (__int16)v42 < v24 );
  }
  // Block 12
  Q_CFile_Read_sub_1BF94(pfi, &buf, 4u);
  v25 = buf;
  pGame->sectorsNum = buf;
  v30 = 0;
  if ( v25 > 0 )
  {
    do
    {
      v26 = &pGame->sectors[v30++];
      Q_CFile_Read_sub_1BF94(pfi, v26, 0xDu);
    }
    while ( v30 < pGame->sectorsNum );
  }
  sub_1EEA4(pGame);
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (000220CC) --------------------------------------------------------
// Calculates average distances between each race's home star and all other races' home stars
void __fastcall Q_Game_CalculateAverageHomeStarDistances_sub_220CC(P_Game pGame)
{
  __int16 i2; // di
  WORD racesNum; // dx
  double distanceSum; // st6
  WORD raceCheckLimit; // bx
  WORD i1; // dx
  P_Star pHomeStar1; // ebx
  P_Star pHomeStar2; // eax
  WORD homeStarDistance; // tt
  double raceDistances[7]; // [esp+8h] [ebp-84h] BYREF
  T_Vector3D distanceVector; // [esp+40h] [ebp-4Ch] BYREF
  T_Vector3D v12; // [esp+4Ch] [ebp-40h] BYREF
  T_Vector3D v13; // [esp+58h] [ebp-34h] BYREF
  T_Vector3D *v14; // [esp+6Ch] [ebp-20h]
  int racesNumMinusOne; // [esp+70h] [ebp-1Ch]

  memset(&v12, 0, sizeof(v12));
  memset(raceDistances, 0, sizeof(raceDistances));
  racesNum = pGame->racesNum;
  pGame->_averageHomeStarDistance = 0;
  if ( racesNum > 0 )
  {
    i2 = 0;
    do
    {
      // For each race, calculate distance to all other races' home stars
      for ( i1 = 0; i1 < pGame->racesNum; ++i1 )
      {
        // Skip self-comparison
        if ( i2 != i1 )
        {
          pHomeStar1 = pGame->races[i1].homeStar;
          pHomeStar2 = pGame->races[i2].homeStar;
          // Calculate vector between these two home stars
          v14 = &v13;
          memset(&distanceVector, 0, sizeof(distanceVector));
          distanceVector.x = pHomeStar2->position.x - pHomeStar1->position.x;
          distanceVector.y = pHomeStar2->position.y - pHomeStar1->position.y;
          distanceVector.z = pHomeStar2->position.z - pHomeStar1->position.z;
          v13 = distanceVector;
          v12 = distanceVector;
          // Calculate Euclidean distance and add to this race's total
          raceDistances[i2] = sqrt(
                                distanceVector.y * distanceVector.y
                              + distanceVector.x * distanceVector.x
                              + distanceVector.z * distanceVector.z)
                            + raceDistances[i2];
        }
      }
      // Calculate average distance for this race to all others
      racesNumMinusOne = pGame->racesNum - 1;
      raceDistances[i2] = raceDistances[i2] / (double)racesNumMinusOne;
      distanceSum = (double)pGame->_averageHomeStarDistance + raceDistances[i2++];
      racesNumMinusOne = (int)distanceSum;
      raceCheckLimit = pGame->racesNum;
      pGame->_averageHomeStarDistance = (int)distanceSum;
    }
    while ( i2 < raceCheckLimit );
  }
  // Calculate final average of all race averages
  homeStarDistance = pGame->_averageHomeStarDistance;
  pGame->_averageHomeStarDistance = homeStarDistance / pGame->racesNum;
}
// 220CC: using guessed type double raceDistances[7];

//----- (00022260) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22260(void *result)
{
  _wcpp_2_dtor_array_(result, 7, &C_Race);
}

//----- (00022280) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22280(void *a1)
{
  _wcpp_2_dtor_array_(a1, 0x64, &C_Star);
}

//----- (000222A0) --------------------------------------------------------
void __fastcall __spoils<edx> sub_222A0(void *result)
{
  _wcpp_2_dtor_array_(result, 0x6B, &C_Ship);
}

//----- (000222C0) --------------------------------------------------------
void __fastcall __spoils<edx> sub_222C0(void *a1)
{
  _wcpp_2_dtor_array_(a1, 24, &C_Type09);
}

//----- (000222E0) --------------------------------------------------------
void __fastcall __spoils<edx> sub_222E0(void *a1)
{
  _wcpp_2_dtor_array_(a1, 9, &C_Sector);
}

//----- (00022300) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22300(void *result)
{
  _wcpp_2_dtor_array_(result, 0x1F4, &C_Planet);
}

//----- (00022320) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22320(void *result)
{
  _wcpp_2_dtor_array_(result, 148, &C_Lane);
}

//----- (00022360) --------------------------------------------------------
P_Lane __fastcall sub_22360(P_Lane result)
{
  result->vector1.x = 0.0;
  result->vector1.y = 0.0;
  result->vector1.z = 0.0;
  result->vector2.y = 0.0;
  result->vector2.z = 0.0;
  result->vector2.x = 0.0;
  return result;
}

//----- (000223B0) --------------------------------------------------------
void __fastcall __spoils<> Q_SectorCtor_sub_223B0(P_Sector pSector)
{
  pSector->v.y = 0.0;
  pSector->v.z = 0.0;
  pSector->v.x = 0.0;
}

//----- (000223E0) --------------------------------------------------------
void __fastcall __spoils<> Q_Type09_Ctor_sub_223E0(P_Type09 self)
{
  self->centroidPosition.y = 0.0;
  self->centroidPosition.z = 0.0;
  self->centroidPosition.x = 0.0;
}

//----- (00022400) --------------------------------------------------------
void __fastcall __spoils<> Q_PlanetCtor_sub_22400(P_Planet pPlanet)
{
  pPlanet->position.x = 0.0;
  pPlanet->position.y = 0.0;
  pPlanet->position.z = 0.0;
  pPlanet->totalSquaresNum = 0;
  pPlanet->pSquares = 0;
  pPlanet->Unknown_5A = 0;
}

//----- (00022430) --------------------------------------------------------
int __fastcall Q_Compare_sub_22430(const void *a1, const void *a2)
{
  int v2; // edx
  float v4; // [esp+0h] [ebp-8h]
  float v5; // [esp+4h] [ebp-4h]

  v5 = *(float *)(*(_DWORD *)a1 + 0xD);
  v4 = *(float *)(*(_DWORD *)a2 + 0xD);
  v2 = 0;
  if ( v5 > (double)v4 )
  {
    return 0xFFFFFFFF;
  }
  if ( v5 < (double)v4 )
  {
    return 1;
  }
  return v2;
}

//----- (00022468) --------------------------------------------------------
void __fastcall Q_Proc_sub_22468()
{
  T_Wnd25TW *WndWithState_sub_56E18; // eax

  WndWithState_sub_56E18 = (T_Wnd25TW *)Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "NEXTTURNCONT", 1, 0);
  if ( !WndWithState_sub_56E18 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x69);
  }
  WndWithState_sub_56E18->buttonState = 0;
}

//----- (000224A4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd02COSW_Ctor_sub_224A4(P_Wnd02COSW pWnd)
{
  UBYTE v1; // cl

  Q_WndA2_Ctor_sub_2C830(&pWnd->a);
  Q_Camera_ResetToIdentity_sub_1B4F0(&pWnd->camera);
  sub_254A4(&pWnd->Unknown_172);
  pWnd->a.pProcs = &Wnd02COSW_Procs;
  pWnd->Unknown_AB = 0;
  pWnd->Unknown_AF = 0;
  pWnd->pDisplayItems = 0;
  pWnd->displayItemsCount = 0;
  pWnd->Unknown_BB = 0;
  pWnd->Unknown_C0 = 0;
  pWnd->Unknown_C4 = 0xFFFFFFFF;
  pWnd->Unknown_C8 = 0xFFFFFFFF;
  pWnd->Unknown_CC = 0xFFFFFFFF;
  pWnd->Unknown_D0 = 0xFFFFFFFF;
  pWnd->Unknown_D4 = 0;
  pWnd->Unknown_592 = 0;
  pWnd->Unknown_D8 = 0xFF;
  pWnd->cursorShape = 2;
  pWnd->Unknown_58E = 0;
  pWnd->Unknown_58A = 0;
  v1 = V_PlayerRaceIndex;
  pWnd->Unknown_582 = 0;
  pWnd->Unknown_D9 = 1 << v1;
}

//----- (00022588) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd02COSW_Dtor_sub_22588(P_Wnd02COSW self, unsigned int a2)
{
  char v3; // cl
  char *v4; // eax
  void *Unknown_AB; // edx

  v3 = a2;
  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(self, &C_Wnd02COSW);
    operator delete[](v4);
  }
  else
  {
    Unknown_AB = self->Unknown_AB;
    self->a.pProcs = &Wnd02COSW_Procs;
    if ( Unknown_AB )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(Unknown_AB);
    }
    operator delete[](self->Unknown_AB);
    if ( self->Unknown_AF )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(self->Unknown_AF);
    }
    operator delete[](self->Unknown_AF);
    if ( self->pDisplayItems )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(self->pDisplayItems);
    }
    operator delete[](self->pDisplayItems);
    sub_254B0(&self->Unknown_172);
    Q_Ret_sub_1B66C();
    Q_WndA2_Dtor_sub_2C848(&self->a, 1);
    if ( (v3 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00022644) --------------------------------------------------------
unsigned int __fastcall Q_Wnd02COSW_sub_22644(P_Wnd02COSW pWnd, const char *starShapes, const char *shipShapes)
{
  void *v4; // eax
  void *v5; // eax
  UWORD v6; // ax
  __int16 y0; // cx
  __int16 v8; // bx
  __int16 y1; // ax
  P_CWDisplayItem v10; // eax
  T_CFile fi; // [esp+0h] [ebp-128h] BYREF

  if ( !starShapes )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x9E);
  }
  if ( !shipShapes )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x9F);
  }
  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( pWnd->Unknown_AB )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(pWnd->Unknown_AB);
  }
  operator delete[](pWnd->Unknown_AB);
  if ( Q_CFile_Open_sub_1BBFC(&fi, starShapes, O_BINARY, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0xAA);
  }
  v4 = Q_CFile_Load_sub_1BF1C(&fi, 0);
  pWnd->Unknown_AB = v4;
  if ( !v4 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0xAC);
  }
  if ( pWnd->Unknown_AF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(pWnd->Unknown_AF);
  }
  operator delete[](pWnd->Unknown_AF);
  if ( Q_CFile_Open_sub_1BBFC(&fi, shipShapes, O_BINARY, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0xB5);
  }
  v5 = Q_CFile_Load_sub_1BF1C(&fi, 0);
  pWnd->Unknown_AF = v5;
  if ( !v5 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0xB7);
  }
  v6 = LOWORD(pWnd->a.pane.x1) - LOWORD(pWnd->a.pane.x0);
  y0 = pWnd->a.pane.y0;
  pWnd->_viewportWidth = v6;
  v8 = v6;
  y1 = pWnd->a.pane.y1;
  pWnd->_viewportWidth = v8 >> 1;
  pWnd->_viewportHeight = (__int16)(y1 - y0) >> 1;
  Q_Wnd02COSW_InitializeCameraDefaults_sub_2280C(pWnd);
  if ( pWnd->pDisplayItems )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(pWnd->pDisplayItems);
  }
  operator delete[](pWnd->pDisplayItems);
  v10 = (P_CWDisplayItem)operator new[](0x1D1Fu);
  Q_RegisterDataInWinMgr_sub_2625C(v10, 1, "CW DISPLAYITEMS");
  pWnd->pDisplayItems = v10;
  if ( !v10 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0xCC);
  }
  pWnd->displayItemsCount = 0;
  pWnd->displayItemsCapacity = 0x163;
  Q_CFile_Dtor_sub_1BBC8(&fi);
  return 0xFFFFFFFF;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0002280C) --------------------------------------------------------
void __fastcall Q_Wnd02COSW_InitializeCameraDefaults_sub_2280C(P_Wnd02COSW pWnd)
{
  pWnd->_fov = 35.0;
  Q_Camera_InitializeProjection_sub_1B808(&pWnd->camera, pWnd->_fov, 1.0, 100000.0, (__int16)pWnd->_viewportWidth);
  pWnd->camera.position.x = 0.0;
  pWnd->camera.position.y = 0.0;
  pWnd->camera.position.z = -1500.0;
  pWnd->camera._viewMatrix._[0][0] = 1.0;
  pWnd->camera._viewMatrix._[0][1] = 0.0;
  pWnd->camera._viewMatrix._[0][2] = 0.0;
  pWnd->camera._viewMatrix._[1][0] = 0.0;
  pWnd->camera._viewMatrix._[1][1] = 1.0;
  pWnd->camera._viewMatrix._[1][2] = 0.0;
  pWnd->camera._viewMatrix._[2][0] = 0.0;
  pWnd->camera._viewMatrix._[2][1] = 0.0;
  pWnd->camera._viewMatrix._[2][2] = 1.0;
}

//----- (000228A4) --------------------------------------------------------
#error "228A4: function frame is wrong (funcsize=0)"

//----- (00023BF0) --------------------------------------------------------
void __fastcall Q_Wnd02COSW_Proc4_sub_23BF0(P_Wnd02COSW pWnd, int a2)
{
  T_Wnd18NG *WndWithState_sub_56E18; // eax
  int v4; // eax
  __int16 i; // si
  char v6; // dl
  int v7; // ebx
  int v8; // edx
  int v9; // ebx
  int v10; // edx
  const char *v11; // ecx
  int Unknown_BB; // eax
  int v13; // ebx
  int v14; // edx
  int v15; // ebx
  int v16; // edx
  char s[128]; // [esp+0h] [ebp-F8h] BYREF
  T_Name10 v18[4]; // [esp+80h] [ebp-78h] BYREF
  T_Name12 v19[3]; // [esp+A8h] [ebp-50h] BYREF
  char v20[20]; // [esp+CCh] [ebp-2Ch] BYREF
  int v21; // [esp+E0h] [ebp-18h]

  v21 = a2;
  sub_254F8(pWnd->Unknown_172.Unknown_0, (int)pWnd);
  if ( WinMgr.state == 3 )
  {
    WndWithState_sub_56E18 = (T_Wnd18NG *)Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "NEWGAMEWND", 3, 0);
    if ( !WndWithState_sub_56E18 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x414);
    }
    WndWithState_sub_56E18->a.pProcs->proc4_draw(&WndWithState_sub_56E18->a, 1);
  }
  if ( pWnd->Unknown_D4 == 0xFFFFFFFF )
  {
    sub_23FD4((int)pWnd);
  }
  if ( WinMgr.state != 3 )
  {
    Q_DrawRaceFlagTinted_sub_53E38(&pWnd->a.pane, 3, 3, V_PlayerRaceIndex);
  }
  if ( pWnd->Unknown_BB )
  {
    s[0] = 0;
    Unknown_BB = pWnd->Unknown_BB;
    v6 = 1;
    if ( !*(_BYTE *)(Unknown_BB + 4) )
    {
      v4 = *(_DWORD *)Unknown_BB;
      if ( ((unsigned __int8)V_PlayerRaceMask & *(_BYTE *)(v4 + 0x17)) != 0 )
      {
        strcpy(s, (const char *)(v4 + 0x1C));
        for ( i = 0; i < 7 && (*(_BYTE *)(*(_DWORD *)pWnd->Unknown_BB + 0x14) & (unsigned __int8)(pWnd->Unknown_D9 & v6)) == 0; ++i )
        {
          v6 *= 2;
        }
      }
      v7 = pWnd->a.pane.y1 - 0x1B;
      v8 = pWnd->a.pane.x1 - 0x82;
      WinMgr.LargeFont.pane = V_GSystem.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v8, v7, s, 0, 0xFFFF, 0xFFFF, 0);
      v9 = pWnd->a.pane.y1 - 0xC;
      v10 = pWnd->a.pane.x1 - 0x82;
      v11 = V_StarTypeTexts_D84C4[**(_DWORD **)pWnd->Unknown_BB];
      WinMgr.SmallFont.pane = V_GSystem.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, v10, v9, v11, 0, 0xFFFF, 0xFFFF, 0);
    }
  }
  if ( v21 != 0xA )
  {
    stru_D85E4 = pWnd->a.pane;
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &stru_D85E4);
  if ( V_CheatMode == 0xFFFFFFFF && V_CheatMode == pWnd->Unknown_58E )
  {
    sprintf(s, "STARS CONTROLLED %d", V_Game.starsControlled);
    WinMgr.SmallFont.pane = V_GSystem.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xA, 0x18C, s, 0, 0xFFFF, 0xFF, 0);
    sprintf(s, "PERCENT CONTROLLED %d", 0x64 * V_Game.starsControlled / V_Game.starsNum);
    qmemcpy(v19, V_Atmospheres, sizeof(v19));
    sprintf(s, "%d Biorythym (%s)\n", word_104BE8, v19[V_Game.atmosphere]);
    v13 = pWnd->a.pane.y0 + 0x1E;
    v14 = pWnd->a.pane.x0 + 5;
    WinMgr.LargeFont.pane = V_GSystem.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v14, v13, s, 0, 0xFFFF, 0xFF, 0);
    LOWORD(v14) = 0;
    s[0] = 0;
    qmemcpy(v18, V_Treaties, sizeof(v18));
    if ( V_Game.racesNum > 0 )
    {
      do
      {
        sprintf(
          v20,
          "R%d %10s %d\n",
          (__int16)v14,
          v18[V_Game.races[V_PlayerRaceIndex].treaties[(__int16)v14]],
          V_Game.races[V_PlayerRaceIndex].attitudes[(__int16)v14]);
        ++v14;
        strcat(s, v20);
      }
      while ( (__int16)v14 < V_Game.racesNum );
    }
    v15 = pWnd->a.pane.y0 + 0x37;
    v16 = pWnd->a.pane.x0 + 5;
    WinMgr.LargeFont.pane = V_GSystem.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v16, v15, s, 0, 0xFFFF, 0xFF, 0);
  }
}
// 968DC: using guessed type char V_PlayerRaceMask;
// 104BE8: using guessed type __int16 word_104BE8;
// 23BF0: using guessed type char s[128];
// 23BF0: using guessed type char var_2C[20];

//----- (00023FD4) --------------------------------------------------------
int __fastcall sub_23FD4(int a1)
{
  int result; // eax
  void *ShapeTable_sub_1B084; // eax
  void *v3; // eax
  int i; // esi
  LONG colorSet; // [esp-Ch] [ebp-44h]
  PANE *pane; // [esp+8h] [ebp-30h]
  LONG hotY; // [esp+Ch] [ebp-2Ch]
  LONG hotX; // [esp+10h] [ebp-28h]
  LONG flags; // [esp+14h] [ebp-24h]
  UWORD v11; // [esp+18h] [ebp-20h]
  char v12; // [esp+1Ch] [ebp-1Ch]

  v12 = 1;
  pane = (PANE *)(a1 + 4);
  for ( i = 0; ; ++i )
  {
    result = V_Game.racesNum;
    if ( i >= V_Game.racesNum )
    {
      break;
    }
    hotX = *((__int16 *)&unk_D85C8 + 2 * i);
    hotY = word_D85CA[2 * i];
    if ( (*(unsigned __int8 *)(a1 + 0xD8) & v12) != 0 && (V_Game.races[V_PlayerRaceIndex].treaties[i] || i == V_PlayerRaceIndex) )
    {
      flags = 0;
      v11 = GwshareShpCacheIndexes[i];
      if ( V_Game.races[i].extinct == 0xFFFFFFFF )
      {
        flags = 1;
        VFX_shape_lookaside((*V_GSystem.hazeTables)[0x16]);
      }
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v11);
      VFX_shape_transform(pane, ShapeTable_sub_1B084, 0, hotX, hotY, V_BigBuffer, 0, 0x10000, 0x10000, flags);
    }
    if ( (*(unsigned __int8 *)(a1 + 0xD8) & v12) != 0 )
    {
      colorSet = V_Game.races[i].colorSet;
      v3 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x21]);
      VFX_shape_draw(pane, v3, colorSet, hotX, hotY);
    }
    v12 *= 2;
  }
  return result;
}
// D85CA: using guessed type __int16 word_D85CA[13];
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00024154) --------------------------------------------------------
void __fastcall sub_24154(P_Wnd02COSW a1, int a2, float a3)
{
  float degrees; // [esp+0h] [ebp-8h]

  sub_254B0(&a1->Unknown_172);
  degrees = a3 * WinMgr.j;
  if ( a2 == TRUE )
  {
    Q_Matrix_RotateYY_sub_535E4((P_Matrix3x3D)&a1->camera._viewMatrix, degrees);
  }
  else
  {
    Q_Matrix_RotateXX_sub_535B4((P_Matrix3x3D)&a1->camera._viewMatrix, degrees);
  }
}

//----- (00024198) --------------------------------------------------------
// fovDelta = 1 or -1
void __fastcall sub_24198(P_Wnd02COSW a1, int fovDelta)
{
  int viewportWidth; // [esp-4h] [ebp-10h]

  if ( (a1->_fov >= 20.0 || fovDelta >= 0) && (a1->_fov <= 60.0 || fovDelta <= 0) )
  {
    viewportWidth = (__int16)a1->_viewportWidth;
    // WinMgr.j ~ sensitivity
    a1->_fov = (double)fovDelta * WinMgr.j + a1->_fov;
    Q_Camera_InitializeProjection_sub_1B808(&a1->camera, a1->_fov, 1.0, 100000.0, viewportWidth);
    sub_254B0(&a1->Unknown_172);
  }
  else
  {
    LOBYTE(a1->Unknown_C0) &= ~0x10u;
  }
}

//----- (0002422C) --------------------------------------------------------
void __fastcall sub_2422C(P_Wnd02COSW pWnd)
{
  P_CWDisplayItem pDisplayItems; // kr00_4
  int v3; // eax
  T_Wnd02COSWt1 *v4; // eax
  _DWORD *p_x; // ebp
  double v6; // st7
  T_Wnd02COSWt1 *v7; // eax
  P_TargetObject v8; // edx
  int **v9; // ebx
  int *v10; // ebp
  int *v11; // ebx
  int *v12; // ebp
  double v13; // st7
  double v14; // st7
  float z; // eax
  int v16; // ebp
  __int16 v17; // dx
  int size_low; // ebp
  int Unknown_D8; // ebx
  int v20; // kr0C_4
  double v21; // st7
  UBYTE targetType; // al
  int j; // eax
  int v24[3]; // [esp+8h] [ebp-114h] BYREF
  T_Vector3D v25; // [esp+14h] [ebp-108h] BYREF
  int v26[3]; // [esp+20h] [ebp-FCh] BYREF
  float v27; // [esp+2Ch] [ebp-F0h]
  int v28; // [esp+30h] [ebp-ECh]
  int v29; // [esp+34h] [ebp-E8h]
  T_Vector3D v; // [esp+38h] [ebp-E4h] BYREF
  int v31[3]; // [esp+44h] [ebp-D8h] BYREF
  float v32; // [esp+50h] [ebp-CCh]
  float v33; // [esp+54h] [ebp-C8h]
  float v34; // [esp+58h] [ebp-C4h]
  T_Vector3D v35; // [esp+5Ch] [ebp-C0h]
  int v36[3]; // [esp+68h] [ebp-B4h] BYREF
  float v37; // [esp+74h] [ebp-A8h]
  int v38; // [esp+78h] [ebp-A4h]
  int v39; // [esp+7Ch] [ebp-A0h]
  float v40; // [esp+80h] [ebp-9Ch]
  int v41; // [esp+84h] [ebp-98h]
  int v42; // [esp+88h] [ebp-94h]
  float v43; // [esp+8Ch] [ebp-90h]
  float v44; // [esp+90h] [ebp-8Ch]
  float v45; // [esp+94h] [ebp-88h]
  float v46; // [esp+98h] [ebp-84h]
  int v47; // [esp+9Ch] [ebp-80h]
  int v48; // [esp+A0h] [ebp-7Ch]
  T_Vector3D result; // [esp+A4h] [ebp-78h] BYREF
  int *v50; // [esp+B0h] [ebp-6Ch]
  int *v51; // [esp+B8h] [ebp-64h]
  int *v52; // [esp+BCh] [ebp-60h]
  float v53; // [esp+C0h] [ebp-5Ch]
  int *v54; // [esp+C4h] [ebp-58h]
  T_Vector3D *v55; // [esp+C8h] [ebp-54h]
  int i; // [esp+D0h] [ebp-4Ch]
  T_Wnd02COSWt1 *p_Unknown_172; // [esp+D4h] [ebp-48h]
  T_Star *v58; // [esp+D8h] [ebp-44h]
  T_Wnd02COSWt1 *a1; // [esp+DCh] [ebp-40h]
  P_TargetObject v60; // [esp+E0h] [ebp-3Ch]
  T_Matrix3x4 *trs; // [esp+E4h] [ebp-38h]
  int v62; // [esp+E8h] [ebp-34h]
  int v63; // [esp+ECh] [ebp-30h]
  int v64; // [esp+F0h] [ebp-2Ch]
  WORD v65[2]; // [esp+F4h] [ebp-28h] BYREF
  WORD v66[2]; // [esp+F8h] [ebp-24h] BYREF
  WORD outY[2]; // [esp+FCh] [ebp-20h] BYREF
  WORD outX[2]; // [esp+100h] [ebp-1Ch] BYREF

  memset(&result, 0, sizeof(result));
  memset(&v, 0, sizeof(v));
  pDisplayItems = pWnd->pDisplayItems;
  sub_254B0(&pWnd->Unknown_172);
  Q_Camera_BuildTransform_sub_1B864(&pWnd->camera);
  p_Unknown_172 = &pWnd->Unknown_172;
  trs = &pWnd->camera.trs;
  v3 = (int)&pDisplayItems[0xFFFFFFFF];
  a1 = p_Unknown_172;
  for ( i = 0; ; ++i )
  {
    v63 = v3;
    if ( (__int16)pWnd->displayItemsCount <= i )
    {
      break;
    }
    targetType = pDisplayItems[i].targetType;
    if ( targetType )
    {
      if ( targetType <= 1u )
      {
        p_x = (_DWORD *)&pDisplayItems[i].pObject.pPlanet->position.x;
        Q_M34xV_sub_53384((P_Vector3D)(*p_x + 8), trs, &result);
        Q_M34xV_sub_53384((P_Vector3D)(p_x[1] + 8), trs, &v);
        *(_DWORD *)&pDisplayItems[i].Unknown_05[0xC] = 0xFFFFFFFF;
        if ( result.z > (double)pWnd->camera.nearClip
          && result.z < (double)pWnd->camera.farClip
          && v.z > (double)pWnd->camera.nearClip
          && v.z < (double)pWnd->camera.farClip )
        {
          Q_Project3DTo2D_sub_533D4(
            &result,
            pWnd->camera._scaleFactor,
            (__int16)pWnd->_viewportWidth,
            (__int16)pWnd->_viewportHeight,
            outX,
            outY);
          Q_Project3DTo2D_sub_533D4(&v, pWnd->camera._scaleFactor, (__int16)pWnd->_viewportWidth, (__int16)pWnd->_viewportHeight, v66, v65);
          *(_WORD *)pDisplayItems[i].Unknown_05 = outX[0];
          *(_WORD *)&pDisplayItems[i].Unknown_05[2] = outY[0];
          *(_WORD *)&pDisplayItems[i].Unknown_05[4] = v66[0];
          *(_WORD *)&pDisplayItems[i].Unknown_05[6] = v65[0];
          v6 = (result.z + v.z) * 0.5;
          *(_DWORD *)&pDisplayItems[i].Unknown_05[0xC] = 0;
          v7 = a1;
          *(float *)&pDisplayItems[i].Unknown_05[8] = v6;
          sub_254BC(v7, (int)&pDisplayItems[i]);
        }
      }
      else if ( targetType == 2 )
      {
        v8.pPlanet = (P_Planet)pDisplayItems[i].pObject;
        if ( v8.pPlanet->byte58 == 5 )
        {
          v9 = *(int ***)&v8.pPlanet->byte59;
          v43 = 0.0;
          v44 = 0.0;
          v45 = 0.0;
          v32 = 0.0;
          v33 = 0.0;
          v34 = 0.0;
          if ( *(float *)&v8.pPlanet[1].name[3] )
          {
            v12 = *v9;
            v43 = *((float *)*v9 + 2);
            v44 = *((float *)v12 + 3);
            v45 = *((float *)v12 + 4);
            v11 = v9[1];
          }
          else
          {
            v10 = v9[1];
            v43 = *((float *)v10 + 2);
            v44 = *((float *)v10 + 3);
            v45 = *((float *)v10 + 4);
            v11 = *v9;
          }
          v32 = *((float *)v11 + 2);
          v33 = *((float *)v11 + 3);
          v34 = *((float *)v11 + 4);
          v46 = v32 - v43;
          v50 = v24;
          *(float *)&v47 = v33 - v44;
          *(float *)&v48 = v34 - v45;
          *(float *)v24 = v46;
          v24[1] = v47;
          v24[2] = v48;
          v13 = sqrt(*(float *)&v47 * *(float *)&v47 + v46 * v46 + *(float *)&v48 * *(float *)&v48);
          v51 = v31;
          v37 = v32 - v43;
          *(float *)v31 = v37;
          *(float *)&v38 = v33 - v44;
          v31[1] = v38;
          *(float *)&v39 = v34 - v45;
          v31[2] = v39;
          v52 = v36;
          v53 = *(float *)((char *)&v8.pPlanet[1].Unknown_22 + 1);
          v40 = v37 * v53;
          *(float *)&v41 = *(float *)&v38 * v53;
          *(float *)&v42 = *(float *)&v39 * v53;
          v14 = 1.0 / v13;
          *(float *)v36 = v40;
          v36[1] = v41;
          v36[2] = v42;
          v27 = v40 * v14;
          v54 = v26;
          *(float *)&v28 = *(float *)&v41 * v14;
          *(float *)v26 = v27;
          v26[1] = v28;
          *(float *)&v29 = v14 * *(float *)&v42;
          v26[2] = v29;
          v35.x = v43 + v27;
          v55 = &v25;
          v35.y = v44 + *(float *)&v28;
          v25 = v35;
          v35.z = v45 + *(float *)&v29;
          Q_M34xV_sub_53384(&v25, trs, &result);
          *(_DWORD *)&pDisplayItems[i].Unknown_05[0xC] = 0xFFFFFFFF;
          if ( result.z > (double)pWnd->camera.nearClip && result.z < (double)pWnd->camera.farClip )
          {
            Q_Project3DTo2D_sub_533D4(
              &result,
              pWnd->camera._scaleFactor,
              (__int16)pWnd->_viewportWidth,
              (__int16)pWnd->_viewportHeight,
              outX,
              outY);
            *(_WORD *)pDisplayItems[i].Unknown_05 = outX[0] + 3;
            *(_WORD *)&pDisplayItems[i].Unknown_05[2] = outY[0];
            z = result.z;
            *(_DWORD *)&pDisplayItems[i].Unknown_05[0xC] = 0;
            *(float *)&pDisplayItems[i].Unknown_05[8] = z;
            sub_254BC(p_Unknown_172, (int)&pDisplayItems[i]);
            goto LABEL_29;
          }
        }
        else
        {
          v16 = *(_DWORD *)(v63 + 0x11);
          v62 = v63;
          if ( !v16 )
          {
            if ( *(_BYTE *)(v63 + 4) )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x56E);
            }
            v17 = 4;
            size_low = LOBYTE(v60.pPlanet->size);
            Unknown_D8 = (unsigned __int8)pWnd->Unknown_D8;
            v58 = *(T_Star **)v62;
            v64 = Unknown_D8;
            v20 = 0;
            for ( j = 0; j < 7; ++j )
            {
              if ( (v64 & size_low & (1 << j)) != 0 )
              {
                ++v20;
              }
            }
            if ( v58 == V_Game.pCurStar )
            {
              v17 = 6;
            }
            *(_WORD *)pDisplayItems[i].Unknown_05 = v17 + *(_WORD *)(v62 + 5);
            *(_WORD *)&pDisplayItems[i].Unknown_05[2] = *(_WORD *)(v62 + 7);
            v21 = *(float *)(v62 + 0xD) + 1.0;
            *(_DWORD *)&pDisplayItems[i].Unknown_05[0xC] = 0;
            *(float *)&pDisplayItems[i].Unknown_05[8] = v21;
          }
        }
        sub_254BC(p_Unknown_172, (int)&pDisplayItems[i]);
      }
      else
      {
        Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0x588);
      }
    }
    else
    {
      v60.pPlanet = (P_Planet)pDisplayItems[i].pObject;
      Q_M34xV_sub_53384((P_Vector3D)&v60.pPlanet->position.z, trs, &result);
      *(_DWORD *)&pDisplayItems[i].Unknown_05[0xC] = 0xFFFFFFFF;
      if ( result.z > (double)pWnd->camera.nearClip && result.z < (double)pWnd->camera.farClip )
      {
        Q_Project3DTo2D_sub_533D4(
          &result,
          pWnd->camera._scaleFactor,
          (__int16)pWnd->_viewportWidth,
          (__int16)pWnd->_viewportHeight,
          outX,
          outY);
        *(_WORD *)pDisplayItems[i].Unknown_05 = outX[0];
        *(_WORD *)&pDisplayItems[i].Unknown_05[2] = outY[0];
        *(float *)&pDisplayItems[i].Unknown_05[8] = result.z;
        v4 = a1;
        *(_DWORD *)&pDisplayItems[i].Unknown_05[0xC] = 0;
        sub_254BC(v4, (int)&pDisplayItems[i]);
      }
    }
LABEL_29:
    v3 = v63 + 0x15;
  }
  sub_254DC(a1);
}

//----- (00024948) --------------------------------------------------------
int __fastcall sub_24948(int result, int a2, int a3)
{
  int v3; // ebp
  int v4; // ebx
  int v5; // edi
  int v6; // edx
  int v7; // eax
  int v8; // edx
  int v9; // ebx
  __int16 v10; // si
  int i; // ebx
  int v12; // eax
  int v13; // edx
  int v14; // edi
  char v15; // dl
  int v16; // eax
  __int16 j; // si
  int v18; // ebx
  int v19; // edx
  int v20; // ebx
  int v21; // edx
  const char *v22; // ecx
  _DWORD v23[5]; // [esp+0h] [ebp-2Ch] BYREF
  int v24; // [esp+14h] [ebp-18h]
  int v25; // [esp+18h] [ebp-14h]

  v3 = result;
  v24 = a2;
  v25 = a3;
  if ( *(_DWORD *)(result + 0xD4) == 0xFFFFFFFF )
  {
    return result;
  }
  v4 = *(_DWORD *)(result + 0xBB);
  if ( v4 )
  {
    v5 = 0x28;
    v6 = *(__int16 *)(v4 + 5) - v24;
    v7 = *(__int16 *)(v4 + 7) - v25;
    if ( *(_BYTE *)(v4 + 4) == 2 )
    {
      v6 += byte_965F8[0];
      v5 = 0x14;
      v7 += SHIBYTE(dword_965FD);
    }
    result = v6 * v6 + v7 * v7;
    if ( result <= v5 )
    {
      return result;
    }
    v8 = *(_DWORD *)(v3 + 0x57E);
    *(_DWORD *)(v3 + 0xBB) = 0;
    Q_WinMgr_SetMousePointerShape_sub_5A270(&WinMgr, v8, 0, 0);
    stru_D85E4.x0 = *(_DWORD *)(v3 + 0x10) - 0x82;
    v9 = *(_DWORD *)(v3 + 0xA7);
    stru_D85E4.y0 = *(_DWORD *)(v3 + 0x14) - 0x1B;
    (*(void (__fastcall **)(int, int))(v9 + 0xC))(v3, 0xA);
  }
  v10 = *(_WORD *)(v3 + 0xB7) - 1;
  for ( i = 0x15 * (*(__int16 *)(v3 + 0xB7) - 1) + *(_DWORD *)(v3 + 0xB3); ; i -= 0x15 )
  {
    result = v10;
    if ( v10 < 0 )
    {
      break;
    }
    if ( *(_BYTE *)(i + 4) != 1 )
    {
      v12 = *(__int16 *)(i + 5) - v24;
      v13 = *(__int16 *)(i + 7) - v25;
      v14 = 0x28;
      if ( *(_BYTE *)(i + 4) == 2 )
      {
        v12 += byte_965F8[0];
        v13 += SHIBYTE(dword_965FD);
        v14 = 0x14;
      }
      result = v13 * v13 + v12 * v12;
      if ( result < v14 )
      {
        *(_DWORD *)(v3 + 0xBB) = i;
        break;
      }
    }
    --v10;
  }
  if ( *(_DWORD *)(v3 + 0xBB) )
  {
    Q_WinMgr_SetMousePointerShape_sub_5A270(&WinMgr, *(_DWORD *)(v3 + 0x57E) + 1, 0, 0);
    result = *(_DWORD *)(v3 + 0xBB);
    if ( !*(_BYTE *)(result + 4) )
    {
      v23[0] = dword_96654[0];
      v23[1] = dword_96654[1];
      v23[2] = dword_96654[2];
      v23[3] = dword_96654[3];
      v23[4] = dword_96654[4];
      v15 = 1;
      v16 = **(_DWORD **)(v3 + 0xBB);
      if ( ((unsigned __int8)V_PlayerRaceMask & *(_BYTE *)(v16 + 0x17)) != 0 )
      {
        strcpy((char *)v23, (const char *)(v16 + 0x1C));
        for ( j = 0; j < 7 && (*(_BYTE *)(**(_DWORD **)(v3 + 0xBB) + 0x14) & (unsigned __int8)(*(_BYTE *)(v3 + 0xD9) & v15)) == 0; ++j )
        {
          v15 *= 2;
        }
      }
      if ( LOBYTE(v23[0]) )
      {
        v18 = *(_DWORD *)(v3 + 0x14) - 0x1B;
        v19 = *(_DWORD *)(v3 + 0x10) - 0x82;
        WinMgr.LargeFont.pane = V_GSystem.pane;
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v19, v18, (const char *)v23, 0, 0xFFFF, 0xFF, 0);
      }
      v20 = *(_DWORD *)(v3 + 0x14) - 0xC;
      v21 = *(_DWORD *)(v3 + 0x10) - 0x82;
      v22 = V_StarTypeTexts_D84C4[***(_DWORD ***)(v3 + 0xBB)];
      WinMgr.SmallFont.pane = V_GSystem.pane;
      return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, v21, v20, v22, 0, 0xFFFF, 0xFF, 0);
    }
  }
  return result;
}
// 965FD: using guessed type int dword_965FD;
// 96654: using guessed type _DWORD dword_96654[5];
// 968DC: using guessed type char V_PlayerRaceMask;

//----- (00024BE0) --------------------------------------------------------
void __fastcall sub_24BE0(P_Wnd02COSW pWnd)
{
  int Unknown_BB; // eax
  T_Star *v3; // eax
  T_WndA2 *WndWithState_sub_56E18; // eax
  P_Star v5; // eax
  T_Lane *v6; // ebx
  int i; // ecx

  Unknown_BB = pWnd->Unknown_BB;
  if ( !*(_BYTE *)(Unknown_BB + 4) )
  {
    if ( pWnd->Unknown_582 )
    {
      v5 = *(P_Star *)Unknown_BB;
      if ( ((unsigned __int8)V_PlayerRaceMask & v5->exploredPathToBits) != 0 )
      {
        for ( i = 0; i < v5->lanesNum; ++i )
        {
          v6 = v5->lanes[i];
          if ( v5 == v6->pStar1 && v6->pStar2 == *(P_Star *)pWnd->Unknown_586
            || v6->pStar1 == *(P_Star *)pWnd->Unknown_586 && v5 == v6->pStar2 )
          {
            sub_1D654(*(P_Location *)pWnd->Unknown_586, v5, v6);
            pWnd->Unknown_582 = 0;
            sub_24D30(pWnd);
            sub_2422C(pWnd);
            pWnd->a.pProcs->proc4_draw((P_WndA2)pWnd, 0);
            return;
          }
        }
      }
    }
    else if ( WinMgr.state == 1 )
    {
      v3 = *(T_Star **)Unknown_BB;
      if ( ((unsigned __int8)V_PlayerRaceMask & v3->exploredBits) != 0 )
      {
        V_Game.pCurStar = v3;
        pWnd->Unknown_BB = 0;
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 1);
      }
    }
    else if ( WinMgr.state == 0xD )
    {
      V_Game.pCurStar = *(P_Star *)Unknown_BB;
      WndWithState_sub_56E18 = Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "NEGSCREEN", 0xD, 0);
      if ( !WndWithState_sub_56E18 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x612);
      }
      sub_32A1C((int)WndWithState_sub_56E18);
      pWnd->a.pProcs->proc4_draw((P_WndA2)pWnd, 0);
    }
  }
}
// 968DC: using guessed type char V_PlayerRaceMask;

//----- (00024D30) --------------------------------------------------------
int __fastcall sub_24D30(P_Wnd02COSW pWnd)
{
  WORD i; // di
  T_Star *pStar; // esi
  signed __int16 v4; // bx
  int ShipsAtLocation_sub_1D794; // esi
  WORD j; // si
  T_Lane *v7; // edi
  WORD v8; // di
  __int16 k; // si
  int result; // eax
  T_Ship *pShip; // eax
  P_Ship ships; // [esp+0h] [ebp-1D4h] BYREF
  char s[32]; // [esp+1ACh] [ebp-28h] BYREF

  pWnd->displayItemsCount = 0;
  for ( i = 0; i < V_Game.starsNum; ++i )
  {
    if ( pWnd->displayItemsCount >= (int)pWnd->displayItemsCapacity )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x659);
    }
    pStar = &V_Game.stars[i];
    pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount].pObject.pStar = pStar;
    pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount].targetType = ASCEND_TARGET_TYPE_0_STAR;
    v4 = pWnd->displayItemsCount + 1;
    pWnd->displayItemsCount = v4;
    if ( pStar->shipsRacesBits )
    {
      if ( v4 >= (__int16)pWnd->displayItemsCapacity )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x66B);
      }
      ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[i], &ships);
      if ( !ShipsAtLocation_sub_1D794 && V_CheatMode == TRUE )
      {
        sprintf(s, "cos%05d.bug", V_Game.day);
        Q_SaveGam_sub_54048(s);
        Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0x676);
      }
      if ( ShipsAtLocation_sub_1D794 > 0 )
      {
        pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount].pObject.pShip = ships;
        pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount++].targetType = ASCEND_TARGET_TYPE_2_SHIP;
      }
    }
  }
  for ( j = 0; j < V_Game.lanesNum; ++j )
  {
    v7 = &V_Game.lanes[j];
    if ( ((unsigned __int8)V_PlayerRaceMask & v7->exploredBits) != 0 )
    {
      if ( pWnd->displayItemsCount >= (int)pWnd->displayItemsCapacity )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x68B);
      }
      pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount].pObject.pLane = v7;
      pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount++].targetType = 1;
    }
  }
  v8 = 0;
  for ( k = 0; ; ++k )
  {
    result = k;
    if ( k >= 107 || v8 >= V_Game.shipsNum )
    {
      break;
    }
    if ( pWnd->displayItemsCount >= (int)pWnd->displayItemsCapacity )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x698);
    }
    pShip = &V_Game.ships[k];
    if ( pShip->raceIndex != 0xFFFFFFFF )
    {
      ++v8;
      if ( pShip->locationType == ASCEND_LOCATION_TYPE_STARLANE )
      {
        pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount].pObject.pShip = pShip;
        pWnd->pDisplayItems[(__int16)pWnd->displayItemsCount++].targetType = ASCEND_TARGET_TYPE_2_SHIP;
      }
    }
  }
  return result;
}
// 968DC: using guessed type char V_PlayerRaceMask;

//----- (00024FCC) --------------------------------------------------------
void __fastcall Q_Wnd02COSW_Proc6_sub_24FCC(P_Wnd02COSW a1, P_CFile pfi, int read)
{
  T_Camera *p_camera; // ecx
  T_Vector3D *p_vector3; // edi
  float *v6; // ebp
  T_Matrix3x3 *v7; // edx
  float *v8; // edx
  int v9[7]; // [esp+0h] [ebp-1A4h] BYREF
  char Unknown_D8; // [esp+1Ch] [ebp-188h]
  char Unknown_D9; // [esp+1Dh] [ebp-187h]
  T_Camera v12; // [esp+1Eh] [ebp-186h] BYREF
  int fov; // [esp+B6h] [ebp-EEh]
  int v14[7]; // [esp+C0h] [ebp-E4h] BYREF
  char v15; // [esp+DCh] [ebp-C8h]
  char v16; // [esp+DDh] [ebp-C7h]
  T_Camera v17; // [esp+DEh] [ebp-C6h] BYREF
  int v18; // [esp+176h] [ebp-2Eh]
  P_CFile pfi_; // [esp+180h] [ebp-24h]
  T_Matrix3x3 *p_viewMatrix; // [esp+184h] [ebp-20h]
  float *v21; // [esp+188h] [ebp-1Ch]
  T_Vector3D *p_vector2; // [esp+18Ch] [ebp-18h]
  T_Vector3D *p_position; // [esp+190h] [ebp-14h]

  pfi_ = pfi;
  p_camera = &a1->camera;
  p_viewMatrix = &a1->camera._viewMatrix;
  p_vector3 = &a1->camera.matrix_00.vector3;
  p_position = &a1->camera.position;
  v6 = a1->camera._viewMatrix._[2];
  p_vector2 = &a1->camera.matrix_00.vector2;
  v21 = a1->camera._viewMatrix._[1];
  if ( read == TRUE )
  {
    Q_Camera_ResetToIdentity_sub_1B4F0(&v17);
    Q_CFile_Read_sub_1BF94(pfi_, v14, 0xBEu);
    a1->Unknown_C0 = v14[0];
    a1->Unknown_C4 = v14[1];
    a1->Unknown_58A = v14[2];
    a1->Unknown_C8 = v14[3];
    a1->Unknown_CC = v14[4];
    a1->Unknown_D0 = v14[5];
    a1->Unknown_D4 = v14[6];
    a1->Unknown_D8 = v15;
    a1->Unknown_D9 = v16;
    p_camera->matrix_00.vector1.x = v17.matrix_00.vector1.x;
    p_camera->matrix_00.vector1.y = v17.matrix_00.vector1.y;
    p_camera->matrix_00.vector1.z = v17.matrix_00.vector1.z;
    *p_vector2 = v17.matrix_00.vector2;
    *p_vector3 = v17.matrix_00.vector3;
    p_camera->FOV = v17.FOV;
    p_camera->_scaleFactor = v17._scaleFactor;
    p_camera->nearClip = v17.nearClip;
    p_camera->farClip = v17.farClip;
    *p_position = v17.position;
    p_camera->trs = v17.trs;
    p_camera->_projectionScale = v17._projectionScale;
    v7 = p_viewMatrix;
    p_viewMatrix->_[0][0] = v17._viewMatrix._[0][0];
    v7->_[0][1] = v17._viewMatrix._[0][1];
    v7->_[0][2] = v17._viewMatrix._[0][2];
    v8 = v21;
    *v21 = v17._viewMatrix._[1][0];
    v8[1] = v17._viewMatrix._[1][1];
    v8[2] = v17._viewMatrix._[1][2];
    *v6 = v17._viewMatrix._[2][0];
    v6[1] = v17._viewMatrix._[2][1];
    v6[2] = v17._viewMatrix._[2][2];
    a1->_fov = (float)v18;
    Q_Ret_sub_1B66C();
  }
  else
  {
    Q_Camera_ResetToIdentity_sub_1B4F0(&v12);
    v9[0] = a1->Unknown_C0;
    v9[1] = a1->Unknown_C4;
    v9[2] = a1->Unknown_58A;
    v9[3] = a1->Unknown_C8;
    v9[4] = a1->Unknown_CC;
    v9[5] = a1->Unknown_D0;
    v9[6] = a1->Unknown_D4;
    Unknown_D8 = a1->Unknown_D8;
    Unknown_D9 = a1->Unknown_D9;
    v12.matrix_00.vector1.x = p_camera->matrix_00.vector1.x;
    v12.matrix_00.vector1.y = a1->camera.matrix_00.vector1.y;
    v12.matrix_00.vector1.z = a1->camera.matrix_00.vector1.z;
    v12.matrix_00.vector2 = *p_vector2;
    v12.matrix_00.vector3.x = p_vector3->x;
    v12.matrix_00.vector3.y = a1->camera.matrix_00.vector3.y;
    v12.matrix_00.vector3.z = a1->camera.matrix_00.vector3.z;
    v12.FOV = a1->camera.FOV;
    v12._scaleFactor = a1->camera._scaleFactor;
    v12.nearClip = a1->camera.nearClip;
    v12.farClip = a1->camera.farClip;
    v12.position = *p_position;
    v12.trs = a1->camera.trs;
    v12._projectionScale = a1->camera._projectionScale;
    v12._viewMatrix._[0][0] = p_viewMatrix->_[0][0];
    v12._viewMatrix._[0][1] = p_viewMatrix->_[0][1];
    v12._viewMatrix._[0][2] = p_viewMatrix->_[0][2];
    v12._viewMatrix._[1][0] = *v21;
    v12._viewMatrix._[1][1] = v21[1];
    v12._viewMatrix._[1][2] = v21[2];
    v12._viewMatrix._[2][0] = *v6;
    v12._viewMatrix._[2][1] = a1->camera._viewMatrix._[2][1];
    v12._viewMatrix._[2][2] = a1->camera._viewMatrix._[2][2];
    fov = (int)a1->_fov;
    Q_CFile_Write_sub_1C098(pfi_, v9, 0xBEu);
    Q_Ret_sub_1B66C();
  }
}

//----- (000254A4) --------------------------------------------------------
void __fastcall __spoils<> sub_254A4(T_Wnd02COSWt1 *a1)
{
  sub_254B0(a1);
}

//----- (000254B0) --------------------------------------------------------
void __fastcall __spoils<> sub_254B0(T_Wnd02COSWt1 *a1)
{
  a1->num = 0;
}

//----- (000254BC) --------------------------------------------------------
void __fastcall sub_254BC(T_Wnd02COSWt1 *a1, int a2)
{
  int num; // ebx

  num = a1->num;
  if ( num < 256 )
  {
    if ( a2 )
    {
      a1->Unknown_0[num] = a2;
      ++a1->num;
    }
  }
}

//----- (000254DC) --------------------------------------------------------
void __fastcall sub_254DC(T_Wnd02COSWt1 *a1)
{
  qsort(a1, a1->num, 4u, Q_Compare_sub_22430);
}

//----- (000254F8) --------------------------------------------------------
void __fastcall sub_254F8(int *a1, int a2)
{
  int v2; // esi
  unsigned __int8 v3; // al
  int v4; // kr14_4
  int v5; // ecx
  T_Star *v6; // ebx
  LONG v7; // eax
  LONG v8; // ebp
  T_Star *v9; // eax
  char v10; // dl
  int v11; // edi
  LONG v12; // ecx
  int j; // kr0C_4
  LONG v14; // [esp-8h] [ebp-74h]
  PANE *v15; // [esp+0h] [ebp-6Ch]
  int v17; // [esp+Ch] [ebp-60h]
  PANE *v18; // [esp+10h] [ebp-5Ch]
  T_Star *v19; // [esp+14h] [ebp-58h]
  PANE *v20; // [esp+18h] [ebp-54h]
  PANE *v21; // [esp+1Ch] [ebp-50h]
  PANE *v22; // [esp+20h] [ebp-4Ch]
  PANE *v23; // [esp+24h] [ebp-48h]
  int v24; // [esp+28h] [ebp-44h]
  PANE *v25; // [esp+2Ch] [ebp-40h]
  PANE *pane; // [esp+30h] [ebp-3Ch]
  T_Star *v27; // [esp+34h] [ebp-38h]
  int v28; // [esp+38h] [ebp-34h]
  int i; // [esp+40h] [ebp-2Ch]
  __int16 state; // [esp+44h] [ebp-28h]
  WORD k; // [esp+48h] [ebp-24h]
  unsigned __int8 v33; // [esp+4Ch] [ebp-20h]
  char v34; // [esp+50h] [ebp-1Ch]
  char v35; // [esp+54h] [ebp-18h]

  VFX_pane_wipe((PANE *)(a2 + 4), *(unsigned __int8 *)(a2 + 0xBF));
  v33 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  if ( a1[0x100] > 0 )
  {
    v24 = 0;
    v25 = (PANE *)(a2 + 4);
    v23 = (PANE *)(a2 + 4);
    v22 = (PANE *)(a2 + 4);
    v18 = (PANE *)(a2 + 4);
    pane = (PANE *)(a2 + 4);
    v15 = (PANE *)(a2 + 4);
    v20 = (PANE *)(a2 + 4);
    v21 = (PANE *)(a2 + 4);
    do
    {
      v2 = a1[v24];
      v3 = *(_BYTE *)(v2 + 4);
      v17 = (int)(*(float *)(v2 + 0xD) + -1500.0);
      if ( v3 )
      {
        if ( v3 <= 1u )
        {
          if ( *(_DWORD *)(a2 + 0xC4) || *(_DWORD *)(a2 + 0x58A) )
          {
            v5 = 7;
            v6 = *(T_Star **)v2;
            if ( v17 <= 0xDC )
            {
              if ( v17 <= 0x93 )
              {
                if ( v17 <= 0x49 )
                {
                  if ( v17 <= 0 )
                  {
                    if ( v17 <= (int)0xFFFFFFB7 )
                    {
                      if ( v17 <= (int)0xFFFFFF6D )
                      {
                        if ( v17 > (int)0xFFFFFF24 )
                        {
                          v5 = 6;
                        }
                      }
                      else
                      {
                        v5 = 5;
                      }
                    }
                    else
                    {
                      v5 = 4;
                    }
                  }
                  else
                  {
                    v5 = 3;
                  }
                }
                else
                {
                  v5 = 2;
                }
              }
              else
              {
                v5 = 1;
              }
            }
            else
            {
              v5 = 0;
            }
            if ( *(_DWORD *)(a2 + 0x58A) == 0xFFFFFFFF )
            {
              if ( *(_WORD *)&v6->name[5] )
              {
                v7 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x10 + v5 / 2;
              }
              else
              {
                v7 = v5 + 0x30;
              }
            }
            else
            {
              v7 = v5 + 0x68;
            }
            if ( !*(_DWORD *)(a2 + 0x58A) && (v6->name[7] & 1) != 0 )
            {
              v7 = v5 / 2 + 0x70;
            }
            VFX_line_draw(v20, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7), *(__int16 *)(v2 + 9), *(__int16 *)(v2 + 0xB), 0, v7);
          }
        }
        else if ( v3 == 2 && *(_DWORD *)(a2 + 0xC8) )
        {
          v8 = 3;
          v9 = *(T_Star **)v2;
          if ( v17 <= 0xDC )
          {
            if ( v17 <= 0 )
            {
              if ( v17 > (int)0xFFFFFF24 )
              {
                v8 = 2;
              }
            }
            else
            {
              v8 = 1;
            }
          }
          else
          {
            v8 = 0;
          }
          v10 = BYTE2(v9->planets[4]);
          if ( v10 == 5 )
          {
            if ( ((1 << V_PlayerRaceIndex) & LOBYTE((*(P_Planet *)((char *)&v9->planets[4] + 3))->blackSquaresNum)) != 0
              && ((1 << LOWORD(v9->planets[4])) & *(unsigned __int8 *)(a2 + 0xD8)) != 0 )
            {
              Q_DrawRaceTintedShape_sub_53EB8(
                v21,
                *(void **)(a2 + 0xAF),
                v8,
                *(__int16 *)(v2 + 5),
                *(__int16 *)(v2 + 7),
                (WORD)v9->planets[4]);
            }
          }
          else
          {
            v34 = 1;
            if ( v10 == 4 )
            {
              v27 = *(T_Star **)((char *)&v9->planets[4] + 3);
            }
            else
            {
              v27 = &V_Game.stars[(*(P_Planet *)((char *)&v9->planets[4] + 3))->starIndex];
            }
            if ( !v27 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x822);
            }
            if ( ((1 << V_PlayerRaceIndex) & v27->exploredBits) != 0 )
            {
              v11 = 0;
              for ( i = 0; V_Game.racesNum > i; ++i )
              {
                if ( (*(_BYTE *)(a2 + 0xD8) & (unsigned __int8)(v34 & v27->shipsRacesBits)) != 0 )
                {
                  v14 = *(__int16 *)(v2 + 7) + *((char *)&dword_965FD + v11 + 3);
                  v12 = *(__int16 *)(v2 + 5) + byte_965F8[v11++];
                  Q_DrawRaceTintedShape_sub_53EB8(v18, *(void **)(a2 + 0xAF), v8, v12, v14, i);
                }
                v34 *= 2;
              }
            }
          }
        }
      }
      else
      {
        v19 = *(T_Star **)v2;
        v28 = 3;
        if ( v17 <= 0xDC )
        {
          if ( v17 <= 0 )
          {
            if ( v17 > (int)0xFFFFFF24 )
            {
              v28 = 2;
            }
          }
          else
          {
            v28 = 1;
          }
        }
        else
        {
          v28 = 0;
        }
        VFX_shape_draw(v15, *(void **)(a2 + 0xAB), v28 + 4 * v19->type, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7));
        state = WinMgr.state;
        if ( (((1 << V_PlayerRaceIndex) & v19->exploredBits) != 0 || WinMgr.state == 3) && *(_DWORD *)(a2 + 0xCC) && v19->planetsRacesBits )
        {
          v35 = 1;
          v4 = 0;
          for ( j = 0; j != 7; ++j )
          {
            if ( (*(_BYTE *)(a2 + 0xD8) & (unsigned __int8)(v19->planetsRacesBits & v35)) != 0 )
            {
              VFX_ellipse_draw(
                pane,
                *(__int16 *)(v2 + 5),
                *(__int16 *)(v2 + 7),
                2 * v4 + 4,
                2 * v4 + 4,
                v28 + (unsigned __int8)(4 * V_Game.races[j].colorSet + 0x13) - 3);
              ++v4;
            }
            v35 *= 2;
          }
        }
        if ( v19 == V_Game.pCurStar && WinMgr.state != 3 )
        {
          VFX_ellipse_draw(v22, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7), 4, 4, 0xF3);
        }
        if ( (((1 << V_PlayerRaceIndex) & v19->exploredBits) != 0 || state == 3)
          && (v19->planetsRacesBits & 0x80) != 0
          && *(_DWORD *)(a2 + 0xD0) == 0xFFFFFFFF )
        {
          for ( k = 0; k < V_Game.racesNum; ++k )
          {
            if ( v19 == V_Game.races[k].homeStar )
            {
              break;
            }
          }
          if ( k >= V_Game.racesNum )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x786);
          }
          if ( (*(_BYTE *)(a2 + 0xD8) & (unsigned __int8)(1 << k)) != 0 || WinMgr.state == 3 )
          {
            Q_DrawRaceFlagTinted_sub_53E38(v23, *(__int16 *)(v2 + 5) - 7, *(__int16 *)(v2 + 7) + 3, k);
          }
        }
        if ( ((1 << V_PlayerRaceIndex) & v19->exploredBits) != 0
          && *(_DWORD *)(a2 + 0xCC)
          && ((1 << V_PlayerRaceIndex) & v19->planetsRacesBits) == 0 )
        {
          VFX_pixel_write(v25, *(__int16 *)(v2 + 5) - 4, *(__int16 *)(v2 + 7), v33);
          VFX_pixel_write(v25, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7) - 4, v33);
          VFX_pixel_write(v25, *(__int16 *)(v2 + 5) + 4, *(__int16 *)(v2 + 7), v33);
          VFX_pixel_write(v25, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7) + 4, v33);
        }
      }
      ++v24;
    }
    while ( v24 < a1[0x100] );
  }
}
// 965FD: using guessed type int dword_965FD;

//----- (00025BF8) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd05RW_Ctor_sub_25BF8(P_WndA2 a1)
{
  Q_WndA2_Ctor_sub_2C830(a1);
  a1->pProcs = &Wnd05RW_Procs;
}

//----- (00025C08) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd05RW_Dtor_sub_25C08(P_WndA2 pWnd, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd, &C_Wnd05RW);
    operator delete[](v3);
  }
  else
  {
    pWnd->pProcs = &Wnd05RW_Procs;
    Q_WndA2_Dtor_sub_2C848(pWnd, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(pWnd);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00025C4C) --------------------------------------------------------
void __fastcall Q_Wnd05RW_Proc4_sub_25C4C(P_Wnd pWnd, int a2)
{
  PANE *p_pane; // ebp
  int v4; // kr04_4
  WORD v5; // si

  sub_2CD24((unsigned int)pWnd, a2);
  if ( V_Game.racesNum > 0 )
  {
    p_pane = &pWnd->pane;
    v4 = 0;
    v5 = 0;
    do
    {
      if ( v5 == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[v5] )
      {
        Q_DrawRaceFlagTinted_sub_53E38(p_pane, 0x2F, 3, v5);
        ++v4;
      }
      ++v5;
    }
    while ( v5 < V_Game.racesNum );
  }
}

//----- (00025CB8) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd06RSW_Ctor_sub_25CB8(P_Wnd06RSW result)
{
  Q_WndA2_Ctor_sub_2C830(&result->a);
  result->a.pProcs = &Wnd06RSW_Procs;
  result->Unknown_AB = 0;
}

//----- (00025CD4) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd06RSW_Dtor_sub_25CD4(P_WndA2 pWnd, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd, &C_Wnd06RSW);
    operator delete[](v3);
  }
  else
  {
    pWnd->pProcs = &Wnd06RSW_Procs;
    Q_WndA2_Dtor_sub_2C848(pWnd, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(pWnd);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00025D18) --------------------------------------------------------
void __fastcall Q_Wnd06RSW_Proc4_sub_25D18(P_Wnd06RSW pWnd, int a2)
{
  unsigned int v3; // esi
  int Unknown_AB; // ecx
  UBYTE species; // al
  __int16 v6; // cx
  WORD i; // ax
  char *sub_1CEA8; // eax
  char *v9; // eax
  WORD v10; // ax
  PANE *p_pane; // esi
  int v12; // ecx
  LONG v13; // ebx
  void *ShapeTable_sub_1B084; // eax
  WORD v15; // [esp-8h] [ebp-68h]
  int v16; // [esp-4h] [ebp-64h]
  char s[52]; // [esp+0h] [ebp-60h] BYREF
  int extinct; // [esp+34h] [ebp-2Ch]
  int v19; // [esp+38h] [ebp-28h]
  char *v20; // [esp+3Ch] [ebp-24h]
  LONG color; // [esp+40h] [ebp-20h]
  int v22; // [esp+44h] [ebp-1Ch]
  BYTE v23; // [esp+48h] [ebp-18h]

  if ( pWnd->a.Unknown_39 )
  {
    v3 = 0xFFFFFFFF;
    v22 = 0;
    color = 0xF2;
    if ( a2 )
    {
      color = a2;
    }
    Unknown_AB = pWnd->Unknown_AB;
    extinct = V_Game.races[Unknown_AB].extinct;
    v23 = V_Game.races[V_PlayerRaceIndex].treaties[Unknown_AB];
    if ( !v23 || extinct )
    {
      v22 = 0xFFFFFFFF;
    }
    else
    {
      species = V_Game.races[Unknown_AB].species;
      v19 = 4 * V_Game.races[Unknown_AB].colorSet + 0x13;
      v20 = V_SpecNames[species];
    }
    if ( pWnd->Unknown_AB == V_PlayerRaceIndex )
    {
      v6 = 0;
      for ( i = 0; i < V_Game.racesNum; ++i )
      {
        if ( i != V_PlayerRaceIndex && V_Game.races[V_PlayerRaceIndex].treaties[i] )
        {
          ++v6;
        }
      }
      v16 = V_Game.racesNum - 1;
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xB);// 11: "%d of %d Species Known"
      sprintf(s, sub_1CEA8, v6, v16);
      v20 = s;
      v22 = 0;
      v19 = 0xF3;
      color = 0xF2;
      v3 = 0;
    }
    if ( extinct == 0xFFFFFFFF )
    {
      v9 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xC);    // 12: "Extinct"
      sprintf(s, v9);
      v20 = s;
      v19 = 0xF3;
      v22 = 0;
    }
    if ( !v22 )
    {
      if ( v3 == 0xFFFFFFFF )
      {
        VFX_pane_wipe(&pWnd->a.pane, color);
        v15 = color;
        v10 = v19;
        p_pane = &pWnd->a.pane;
      }
      else
      {
        v10 = v19;
        p_pane = &pWnd->a.pane;
        v15 = 0xFF;
      }
      WinMgr.LargeFont.pane = *p_pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, v20, 0x43u, v10, v15, 0);
    }
    if ( v23 )
    {
      v12 = pWnd->Unknown_AB;
      if ( v12 != V_PlayerRaceIndex && v22 != 0xFFFFFFFF )
      {
        Q_DrawRaceFlagTinted_sub_53E38(&pWnd->a.pane, 0xE, 3, v12);
        v13 = 0xFFFFFFFF;
        if ( !extinct )
        {
          if ( v23 == 3 )
          {
            v13 = 9;
          }
          else if ( v23 == 2 )
          {
            v13 = 8;
          }
        }
        if ( v13 != 0xFFFFFFFF )
        {
          ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
          VFX_shape_draw(&pWnd->a.pane, ShapeTable_sub_1B084, v13, 0xE, 3);
        }
      }
    }
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pWnd->a.pane);
  }
}

//----- (00025FB4) --------------------------------------------------------
void __fastcall Q_Wnd06RSW_Proc5_sub_25FB4(P_Wnd06RSW pWnd, int a2)
{
  if ( pWnd->a.Unknown_39 )
  {
    ((void (*)(void))pWnd->a.pProcs->proc4_draw)();
  }
}

//----- (00026000) --------------------------------------------------------
int __fastcall Q_Wnd06RSW_Proc3_sub_26000(P_Wnd06RSW pWnd, UWORD message, int param1, int param2)
{
  WORD v5; // ax
  int result; // eax
  LONG x1; // ecx
  LONG x0; // edx
  LONG y0; // ebx
  int Unknown_AB; // eax
  int y1; // [esp-4h] [ebp-14h]

  switch ( message )
  {
    case 1u:
      v5 = pWnd->a.name[5] - 0x31;
      pWnd->Unknown_AB = v5;
      if ( v5 < V_Game.racesNum )
      {
        goto LABEL_10;
      }
      result = 0;
      break;
    case 2u:
      pWnd->a.Unknown_39 = 0;
      x1 = pWnd->a.pane.x1;
      x0 = pWnd->a.pane.x0;
      y1 = pWnd->a.pane.y1;
      y0 = pWnd->a.pane.y0;
      pWnd->a.Unknown_35 = 0;
      Q_WinMgr_WipeAndAddDirtyArea_sub_55214(&WinMgr, x0, y0, x1, y1);
      result = 0;
      break;
    case 4u:
    case 5u:
      Unknown_AB = pWnd->Unknown_AB;
      if ( V_Game.races[V_PlayerRaceIndex].treaties[Unknown_AB]
        && Unknown_AB != V_PlayerRaceIndex
        && V_Game.races[Unknown_AB].extinct != 0xFFFFFFFF )
      {
        byte_968DD = pWnd->Unknown_AB;
        goto LABEL_10;
      }
      result = 0;
      break;
    case 6u:
      goto LABEL_13;
    case 7u:
      ((void (*)(void))pWnd->a.pProcs->proc5)();
      result = 0xFFFFFFFF;
      break;
    case 0xBu:
      pWnd->Unknown_AB = param1;
LABEL_13:
      ((void (*)(void))pWnd->a.pProcs->proc4_draw)();
      result = 0xFFFFFFFF;
      break;
    case 0xDu:
      ((void (__fastcall *)(P_Wnd06RSW, _DWORD, _WORD, int))pWnd->a.pProcs->proc4_draw)(pWnd, 0, param1, param2);
      result = Q_WndA2_Proc3_sub_2F424(&pWnd->a, message, (unsigned __int16)param1, param2);
      break;
    default:
LABEL_10:
      result = Q_WndA2_Proc3_sub_2F424(&pWnd->a, message, (unsigned __int16)param1, param2);
      break;
  }
  return result;
}
// 968DD: using guessed type char byte_968DD;

//----- (00026140) --------------------------------------------------------
void sub_26140()
{
  Q_Ret_sub_1B66C();
}

//----- (00026150) --------------------------------------------------------
char *__fastcall sub_26150(char *result)
{
  Q_Camera_ResetToIdentity_sub_1B4F0((P_Camera)(result + 0x1E));
  return result;
}

//----- (00026160) --------------------------------------------------------
int Q_StopSystems_sub_26160()
{
  Q_StopMouse_sub_2632C(&V_InputSystem);
  Q_GSystem_Stop_sub_2C6CC(&V_GSystem);
  Q_SSystem_Stop_sub_4FE8C(&V_SSystem);
  return printf("\n%s\n\n", "Thank you for playing Ascendancy.");
}

//----- (00026194) --------------------------------------------------------
void Q_debugbreak_sub_26194()
{
  __debugbreak();
}

//----- (00026198) --------------------------------------------------------
void __fastcall __noreturn Q_AssertLogBreakExit_sub_26198(int ignore, const char *sourcefile, int line)
{
  if ( !ignore )
  {
    sprintf("Thank you for playing Ascendancy.", "Assert Failed: <%s> Line %d\n\n", sourcefile, line);
    Q_debugbreak_exit_sub_2624C();
  }
  JUMPOUT(0x26195);
}
// 2619A: control flows out of bounds to 26195

//----- (000261A8) --------------------------------------------------------
void __fastcall Q_AssertLogBreakExit_sub_261A8(int ignore, const char *sourcefile, int line)
{
  if ( !ignore )
  {
    sprintf("Thank you for playing Ascendancy.", "Assert Failed: <%s> Line %d\n\n", sourcefile, line);
    Q_debugbreak_exit_sub_2624C();
  }
  JUMPOUT(0x26195);
}
// 261AA: control flows out of bounds to 26195

//----- (000261B8) --------------------------------------------------------
void __fastcall Q_PrintFailAndExit_sub_261B8(int ignore, const char *sourceFile, int line)
{
  char v3[256]; // [esp+0h] [ebp-100h] BYREF

  if ( !ignore )
  {
    strcpy(v3, "Thank you for playing Ascendancy.");
    sprintf("Thank you for playing Ascendancy.", "Assert Failed: <%s> Line %d\n\n%s\n", sourceFile, line, v3);
    Q_debugbreak_exit_sub_2624C();
  }
}

//----- (0002620C) --------------------------------------------------------
int sub_2620C(char *format, ...)
{
  char *v2; // [esp+0h] [ebp-4h] BYREF
  va_list a2; // [esp+14h] [ebp+10h] BYREF

  va_start(a2, format);
  va_copy((va_list)v2, a2);
  return vsprintf("Thank you for playing Ascendancy.", format, &v2);
}

//----- (0002624C) --------------------------------------------------------
void __noreturn Q_debugbreak_exit_sub_2624C()
{
  Q_debugbreak_sub_26194();
  exit(1);
}

//----- (0002625C) --------------------------------------------------------
void __fastcall __spoils<edx,ebx> Q_RegisterDataInWinMgr_sub_2625C(void *aData, int category, char *name)
{
  if ( aData )
  {
    Q_WinMgr_AddWinData_sub_5A094(&WinMgr, aData, category, name);
  }
}

//----- (0002627C) --------------------------------------------------------
void __fastcall Q_RemoveWinDataFromWinMgr_sub_2627C(void *pdata)
{
  Q_WinMgr_RemoveWinData_sub_5A144(&WinMgr, pdata);
}

//----- (0002628C) --------------------------------------------------------
void *__fastcall Q_Allocate_sub_2628C(size_t a1, int a2, char *a3)
{
  void *result; // eax
  void *v4; // esi

  result = malloc(a1);
  v4 = result;
  if ( result )
  {
    Q_WinMgr_AddWinData_sub_5A094(&WinMgr, result, a2, a3);
    return v4;
  }
  return result;
}

//----- (000262B0) --------------------------------------------------------
void *__fastcall Q_AllocAndAddToWinMgr_sub_262B0(size_t num, size_t size, int category, char *name)
{
  void *result; // eax
  void *v5; // esi

  result = calloc(num, size);
  v5 = result;
  if ( result )
  {
    Q_WinMgr_AddWinData_sub_5A094(&WinMgr, result, category, name);
    return v5;
  }
  return result;
}

//----- (000262CC) --------------------------------------------------------
void __fastcall Q_RemoveWinDataFromWinMgr_sub_262CC(void *ptr)
{
  Q_WinMgr_RemoveWinData_sub_5A144(&WinMgr, ptr);
  free(ptr);
}

//----- (000262F0) --------------------------------------------------------
void Q_InputSystem_StaticCtor_sub_262F0()
{
  _wcpp_2_mod_register_((RW_DTREG *)&stru_96768);
  Q_InputSystem_Ctor_sub_26314(&V_InputSystem);
  stru_96768.state_var = 1;
}

//----- (00026314) --------------------------------------------------------
void __fastcall __spoils<> Q_InputSystem_Ctor_sub_26314(P_InputSystem self)
{
  ;
}

//----- (0002631C) --------------------------------------------------------
void __fastcall Q_InputSystem_Dtor_sub_2631C(T_InputSystem *a1)
{
  Q_StopMouse_sub_2632C(a1);
}

//----- (0002632C) --------------------------------------------------------
void __fastcall Q_StopMouse_sub_2632C(P_InputSystem a1)
{
  if ( V_Mouse.initialized )
  {
    MOUSE_shutdown();
  }
  else
  {
    Q_Null_sub_26328();
  }
}

//----- (0002633C) --------------------------------------------------------
int __fastcall Q_StartMouse_sub_2633C(P_InputSystem a1)
{
  V_Mouse.initialized = MOUSE_init(640, 480);
  return (V_Mouse.initialized == 0) - 1;
}

//----- (00026360) --------------------------------------------------------
void __fastcall Q_ProcessKeyboard_sub_26360()
{
  WORD v0; // ax
  bool v1; // zf
  int v2; // eax

  HIBYTE(v0) = 2;
  __asm { int     16h; KEYBOARD - GET SHIFT STATUS }
  V_Keyboard.Flags = v0;
  if ( (v0 & 1) != 0 || (v0 & 2) != 0 )
  {
    V_Keyboard.Shift = 0xFFFFFFFF;
  }
  else
  {
    V_Keyboard.Shift = 0;
  }
  V_Keyboard.Ctrl = ((v0 & 4) == 0) - 1;
  V_Keyboard.Alt = ((v0 & 8) == 0) - 1;
  V_Keyboard.ScrollLock = ((v0 & 0x10) == 0) - 1;
  V_Keyboard.NumLock = ((v0 & 0x20) == 0) - 1;
  V_Keyboard.CapsLock = ((v0 & 0x40) == 0) - 1;
  v2 = ((v0 & 0x80) == 0) - 1;
  v1 = v2 == 0;
  V_Keyboard.Insert = v2;
  BYTE1(v2) = 1;
  __asm { int     16h; KEYBOARD - CHECK BUFFER, DO NOT CLEAR }
  if ( v1 )
  {
    LOWORD(v2) = 0;
  }
  if ( (_WORD)v2 )
  {
    __asm { int     16h; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY }
    V_Keyboard.ASCIIChar = (unsigned __int8)v2;
    V_Keyboard.Pressed = TRUE;
    V_Keyboard.ScanCode = 0;
  }
  else
  {
    V_Keyboard.Pressed = 0;
  }
}
// 2637B: variable 'v0' is possibly undefined

//----- (000264B4) --------------------------------------------------------
void __fastcall Q_ProcessMouse_sub_264B4()
{
  LONG mx; // [esp+0h] [ebp-2Ch] BYREF
  LONG my; // [esp+4h] [ebp-28h] BYREF
  LONG ml; // [esp+8h] [ebp-24h] BYREF
  LONG mr; // [esp+Ch] [ebp-20h] BYREF
  LONG mc; // [esp+10h] [ebp-1Ch] BYREF

  MOUSE_status(&mx, &my, &ml, &mr, &mc);
  if ( mx == V_Mouse.x && my == V_Mouse.y )
  {
    V_Mouse.moved = 0;
  }
  else
  {
    V_Mouse.x = mx;
    V_Mouse.moved = TRUE;
    V_Mouse.y = my;
  }
  if ( ml == V_Mouse.left )
  {
    V_Mouse.leftClicked = 0;
  }
  else
  {
    V_Mouse.left = ml;
    V_Mouse.leftClicked = TRUE;
  }
  if ( mr == V_Mouse.right )
  {
    V_Mouse.rightClicked = 0;
  }
  else
  {
    V_Mouse.right = mr;
    V_Mouse.rightClicked = TRUE;
  }
}

//----- (0002656C) --------------------------------------------------------
int __fastcall Q_ProcessInput_sub_2656C(P_InputSystem a1)
{
  V_Mouse.leftClicked = 0;
  V_Mouse.rightClicked = 0;
  V_Mouse.moved = 0;
  V_Keyboard.Pressed = 0;
  Q_ProcessKeyboard_sub_26360();
  if ( V_Mouse.initialized )
  {
    Q_ProcessMouse_sub_264B4();
  }
  return Q_GameLoop_dword_96774;
}
// 96774: using guessed type int Q_GameLoop_dword_96774;

//----- (000265A8) --------------------------------------------------------
void __fastcall Q_WinEvent_ProcessInput_sub_265A8(P_WinEvent pWinEvent)
{
  WORD eventType; // dx
  int p1; // edx
  int p2; // eax
  WORD msg; // dx
  UWORD v5; // dx

  V_Mouse.moved = FALSE;
  V_Mouse.leftClicked = FALSE;
  V_Mouse.rightClicked = FALSE;
  V_Keyboard.Pressed = FALSE;
  eventType = pWinEvent->eventType;
  if ( (unsigned __int16)eventType < 2u )
  {
    if ( eventType == 1 )
    {
      p1 = pWinEvent->p1;
      p2 = pWinEvent->p2;
      V_Mouse.x = p1;
      V_Mouse.y = p2;
      MOUSE_force_move(p1, p2);
      V_Mouse.moved = TRUE;
    }
  }
  else if ( (unsigned __int16)eventType <= 2u )
  {
    if ( pWinEvent->p1 )
    {
      V_Mouse.right = pWinEvent->p2;
      V_Mouse.rightClicked = TRUE;
    }
    else
    {
      V_Mouse.left = pWinEvent->p2;
      msg = pWinEvent->msg;
      V_Mouse.leftClicked = TRUE;
      if ( msg && V_Mouse.left )
      {
        V_Keyboard.Shift = TRUE;
      }
      else
      {
        V_Keyboard.Shift = FALSE;
      }
    }
  }
  else if ( eventType == 3 )
  {
    V_Keyboard.Flags = pWinEvent->msg;
    v5 = pWinEvent->p1;
    V_Keyboard.ASCIIChar = pWinEvent->p2;
    V_Keyboard.ScanCode = v5;
    V_Keyboard.Pressed = TRUE;
    if ( (V_Keyboard.Flags & 1) == 0 && (V_Keyboard.Flags & 2) == FALSE )
    {
      V_Keyboard.Shift = FALSE;
    }
    else
    {
      V_Keyboard.Shift = TRUE;
    }
    V_Keyboard.Ctrl = ((V_Keyboard.Flags & 4) == 0) - 1;
    V_Keyboard.Alt = ((V_Keyboard.Flags & 8) == 0) - 1;
    V_Keyboard.ScrollLock = ((V_Keyboard.Flags & 0x10) == 0) - 1;
    V_Keyboard.NumLock = ((V_Keyboard.Flags & 0x20) == 0) - 1;
    V_Keyboard.CapsLock = ((V_Keyboard.Flags & 0x40) == 0) - 1;
    if ( (V_Keyboard.Flags & 0x80) == FALSE )
    {
      V_Keyboard.Insert = FALSE;
    }
    else
    {
      V_Keyboard.Insert = TRUE;
    }
  }
}

//----- (000267A0) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd23EW_Ctor_sub_267A0(P_Wnd23EW a1)
{
  Q_Wnd20HW_Ctor_sub_2FC50((P_Wnd20HW)a1);
  a1->a2.pProcs = &Wnd23EW_Procs;
  Q_WndEW_sub_26800(a1);
}

//----- (000267BC) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd23EW_Dtor_sub_267BC(P_Wnd23EW a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd23EW);
    operator delete[](v3);
  }
  else
  {
    a1->a2.pProcs = &Wnd23EW_Procs;
    Q_Wnd20HW_Dtor_sub_2FC68((P_Wnd20HW)a1, 1u);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00026800) --------------------------------------------------------
void __fastcall __spoils<> Q_WndEW_sub_26800(P_Wnd23EW result)
{
  result->pGameEvent = 0;
}

//----- (00026874) --------------------------------------------------------
void __fastcall sub_26874(P_Wnd23EW a1, P_GameEvent pGameEvent)
{
  P_GameEvent pGameEvent_; // ebx
  int p1; // edx
  int p2; // esi
  WORD eventId; // kr00_2
  char *v7; // eax
  char *v8; // eax
  unsigned __int8 v9; // bl
  P_GameEvent v10; // ebx
  _WORD *v11; // edx
  int v12; // ebx
  char *v13; // esi
  char *v14; // ebx
  P_GameEvent v15; // eax
  int v16; // esi
  int v17; // edx
  int v18; // eax
  int v19; // eax
  char *v20; // eax
  char *v21; // edx
  P_GameEvent v22; // edi
  int v23; // esi
  int v24; // edi
  int v25; // esi
  _DWORD *v26; // edi
  int v27; // eax
  char *v28; // edx
  __int16 v29; // bx
  char *v30; // eax
  char *v31; // edx
  __int16 v32; // ax
  P_GameEvent v33; // eax
  int v34; // edx
  int v35; // eax
  char *v36; // ebx
  UBYTE v37; // al
  int v38; // ecx
  __int16 ItemIndex_sub_1B270; // ax
  char *v40; // edx
  char *v41; // edx
  char *v42; // edx
  UBYTE v43; // al
  int v44; // [esp-8h] [ebp-298h]
  char *sub_1CEA8; // [esp-4h] [ebp-294h]
  char format[600]; // [esp+0h] [ebp-290h] BYREF
  char s[32]; // [esp+258h] [ebp-38h] BYREF
  int v48; // [esp+27Ch] [ebp-14h]
  char *Unknown_C95; // [esp+280h] [ebp-10h]
  int v50; // [esp+284h] [ebp-Ch]
  int v51; // [esp+288h] [ebp-8h]
  char *Unknown_CB0; // [esp+28Ch] [ebp-4h]

  if ( !pGameEvent )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x48);
  }
  a1->pGameEvent = pGameEvent;
  sprintf(s, "event%02d", pGameEvent->eventId);
  Q_Wnd20HW_ShowHelpTopic_sub_2FCB0((P_Wnd20HW)a1, "help.txt", s);
  Unknown_C95 = a1->Unknown_C95;
  Unknown_CB0 = a1->Unknown_CB0;
  if ( a1->Unknown_C95[0] != 1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x55);
  }
  if ( *(int *)a1->Unknown_DA3 > 1 && *Unknown_CB0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x57);
  }
  strcpy(format, *(const char **)(Unknown_C95 + 5));
  pGameEvent_ = a1->pGameEvent;
  p1 = pGameEvent_->p1;
  p2 = pGameEvent_->p2;
  eventId = pGameEvent_->eventId;
  v51 = p1 + 0x24;
  v50 = p2 + 0x24;
  v48 = 5 * p1;
  switch ( eventId )
  {
    case ASCEND_EP_00_NEW_DISCOVERY:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex].species], &V_Research.techs[p1]);
      v7 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = 0x1F;
      *(_WORD *)(v7 + 3) = p1;
      break;
    case ASCEND_EP_01_CONSTRUCTION_COMPLETE:
      v9 = pGameEvent_->p2;
      sprintf(
        *(char **)(Unknown_C95 + 5),
        format,
        V_PlanetItems.item[v9].name,
        v51,
        v51,
        *(unsigned __int16 *)(p1 + 0x42) - *(unsigned __int16 *)(p1 + 0x4C));
      *(_WORD *)(Unknown_CB0 + 1) = 0x1E;
      *(_WORD *)(Unknown_CB0 + 3) = v9;
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = *(_WORD *)(p1 + 0x14) + 5 * *(_WORD *)(p1 + 0x16);
      break;
    case ASCEND_EP_02_WOULD_LIKE_TO_SPEAK:
      v29 = pGameEvent_->p1;
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[v29].species]);
      v30 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 3) = 0;
      *(_WORD *)(v30 + 1) = v29;
      break;
    case ASCEND_EP_SHIPARRIVE:
    case ASCEND_EP_FINDRACE:
    case ASCEND_EP_HOSTILESHIP:
    case ASCEND_EP_HOSTILEPLAN:
    case ASCEND_EP_OTHERWAR:
    case ASCEND_EP_20_DISCOVERED_SYSTEM:
      v15 = a1->pGameEvent;
      v16 = v15->p1;
      if ( *(_BYTE *)(v16 + 0x58) != 4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xB3);
      }
      v17 = *(_DWORD *)(v16 + 0x59);
      if ( a1->pGameEvent->eventId == 0x14 )
      {
        if ( *(_WORD *)(v17 + 0x44) == 1 )
        {
          v18 = 0xD;                                   // 13: ""
        }
        else
        {
          v18 = 0xE;                                   // 14: "s"
        }
        sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v18);
        v44 = *(__int16 *)(v17 + 0x44);
        if ( *(_WORD *)(v17 + 0x5A) == 1 )
        {
          v19 = 0xD;                                   // 13: ""
        }
        else
        {
          v19 = 0xE;                                   // 14: "s"
        }
        v20 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v19);
        sprintf(*(char **)(Unknown_C95 + 5), format, v16 + 0x34, v17 + 0x1C, *(__int16 *)(v17 + 0x5A), v20, v44, sub_1CEA8);
      }
      else
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, v16 + 0x34, v17 + 0x1C, V_SpecNames[V_Game.races[v15->p2].species]);
      }
      v21 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v21 + 3) = *(char *)(v16 + 0xAA);
      break;
    case ASCEND_EP_RACEFINDUS:
    case ASCEND_EP_BADSHIPENTERS:
      v22 = a1->pGameEvent;
      v23 = v22->p1;
      v24 = v22->p2;
      if ( *(_BYTE *)(v23 + 0x58) != 4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xCD);
      }
      if ( a1->pGameEvent->eventId == 9 )
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[v24].species], *(_DWORD *)(v23 + 0x59) + 0x1C);
      }
      else
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, *(_DWORD *)(v23 + 0x59) + 0x1C);
      }
      *(_WORD *)(Unknown_CB0 + 1) = v24 + 0xE;
      *(_WORD *)(Unknown_CB0 + 3) = *(char *)(v23 + 0xAA);
      break;
    case ASCEND_EP_SPECIESEXTINCT:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[p1].species]);
      v31 = Unknown_CB0;
      v32 = a1->pGameEvent->p1;
      *(_WORD *)(Unknown_CB0 + 3) = 0;
      *(_WORD *)(v31 + 1) = v32;
      break;
    case ASCEND_EP_SCRAPNEWESTSHIP:
    case ASCEND_EP_SHIPDESTROYED:
      v33 = a1->pGameEvent;
      v34 = v33->p1;
      v35 = v33->p2;
      if ( v35 )
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, v35 + 0x1C);
      }
      v36 = Unknown_CB0;
      v37 = V_PlayerRaceIndex;
      *(_WORD *)(Unknown_CB0 + 3) = v34;
      *(_WORD *)(v36 + 1) = v37 + 0xE;
      break;
    case ASCEND_EP_COLONYINVADED:
      v38 = p1;
      if ( !p1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x114);
      }
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x24, V_SpecNames[V_Game.races[*(unsigned __int8 *)(p1 + 0x57)].species]);
      ItemIndex_sub_1B270 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "data\\planets.shp", 0);
      v40 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = ItemIndex_sub_1B270;
      if ( *(unsigned __int16 *)(v40 + 1) == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x118);
      }
      *(_WORD *)(Unknown_CB0 + 3) = 5 * *(_WORD *)(v38 + 0x16) + *(_WORD *)(v38 + 0x14);
      break;
    case ASCEND_EP_15_HAS_FREE_POPULATION:
      sprintf(*(char **)(Unknown_C95 + 5), format, v51);
      *(_WORD *)(Unknown_CB0 + 1) = 0x1D;
      *(_WORD *)(Unknown_CB0 + 3) = 5 * *(_WORD *)(p1 + 0x16) + *(_WORD *)(p1 + 0x14);
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x2C;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = 2;
      break;
    case ASCEND_EP_16_ENTERED_ORBIT:
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x34, v50);
      v14 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v14 + 3) = *(char *)(p1 + 0xAA);
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = *(_WORD *)(p2 + 0x14) + 5 * *(_WORD *)(p2 + 0x16);
      break;
    case ASCEND_EP_17_SHIP_COMPLETE:
    case ASCEND_EP_18_REFIT_COMPLETE:
      v10 = a1->pGameEvent;
      v11 = (_WORD *)v10->p2;
      v12 = v10->p1;
      sprintf(
        *(char **)(Unknown_C95 + 5),
        format,
        v12 + 0x34,
        v11 + 0x12,
        v11 + 0x12,
        (unsigned __int16)v11[0x21] - (unsigned __int16)v11[0x26]);
      v13 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v13 + 3) = *(char *)(v12 + 0xAA);
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = v11[0xA] + 5 * v11[0xB];
      break;
    case ASCEND_EP_19_REMAINING_MOVES:
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x1C);
      break;
    case ASCEND_EP_21_ALL_TECH_FOR_SHIP:
      v41 = Unknown_CB0;
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex].species]);
      *(_WORD *)(v41 + 3) = 0;
      *(_WORD *)(v41 + 1) = V_PlayerRaceIndex;
      break;
    case ASCEND_EP_22_XENO_COMPLETE:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex].species], v50, &V_Research.techs[p1]);
      v8 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = 0x1F;
      *(_WORD *)(v8 + 3) = p1;
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = *(_WORD *)(p2 + 0x14) + 5 * *(_WORD *)(p2 + 0x16);
      break;
    case ASCEND_EP_23_LANE_TRANSMISION:
      v25 = p1;
      if ( *(_BYTE *)(p1 + 0x58) != 5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xE0);
      }
      v26 = *(_DWORD **)(p1 + 0x59);
      if ( !v26 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xE3);
      }
      v27 = *v26;
      if ( ((1 << V_PlayerRaceIndex) & *(unsigned __int8 *)(*v26 + 0x17)) == 0 )
      {
        v27 = v26[1];
      }
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x34, v27 + 0x1C);
      v28 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v28 + 3) = *(char *)(v25 + 0xAA);
      break;
    case ASCEND_EP_25_FIRST_LAB:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex].species]);
      v42 = Unknown_CB0;
      v43 = V_PlayerRaceIndex;
      *(_WORD *)(Unknown_CB0 + 3) = 0;
      *(_WORD *)(v42 + 1) = v43;
      break;
    default:
      return;
  }
}
// 26D02: conditional instruction was optimized away because bh.1!=4
// 26874: using guessed type char format[600];

//----- (000270F4) --------------------------------------------------------
int __fastcall sub_270F4(T_Wnd20HW *a1, __int16 a2, LONG a3, LONG a4)
{
  P_Procs pProcs; // ebx

  if ( !a2 || (unsigned __int16)a2 > 1u )
  {
    return Q_Wnd20HW_Proc3_sub_2FD68(a1, a2, a3, a4);
  }
  a1->super.Unknown_35 = 0xFFFFFFFF;
  pProcs = a1->super.pProcs;
  a1->super.Unknown_39 = 0xFFFFFFFF;
  ((void (*)(void))pProcs->proc4_draw)();
  return 0;
}

//----- (0002712C) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd30EW_Ctor_sub_2712C(T_WndA2 *a1)
{
  Q_WndA2_Ctor_sub_2C830(a1);
  a1->pProcs = &Wnd30EW_Procs;
}

//----- (0002713C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd30EW_Dtor_sub_2713C(P_Wnd30EW self, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(self, &C_Wnd30EW);
    operator delete[](v3);
  }
  else
  {
    self->a2.pProcs = &Wnd30EW_Procs;
    Q_WndA2_Dtor_sub_2C848(&self->a2, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00027184) --------------------------------------------------------
int __fastcall Q_Wnd30EW_Proc3_sub_27184(P_Wnd30EW pWnd, UWORD message, int param1, int param2)
{
  if ( !message )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
  }
  if ( message <= 1u )
  {
    sub_4F8CC(&V_SSystem, V_Game.races[V_PlayerRaceIndex].species + 8, 0);
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
  }
  if ( message != 2 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
  }
  Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 1, 1);
  return 0xFFFFFFFF;
}

//----- (000271FC) --------------------------------------------------------
void __fastcall Q_Wnd30EW_Proc4_sub_271FC(P_Wnd30EW pWnd, int a2)
{
  int species; // ecx
  FILE *v3; // ebp
  char v4; // ah
  char *v6; // kr0C_4
  char v7; // al
  void *ShapeTable_sub_1B084; // eax
  UBYTE colorSet; // al
  const char *v11; // ecx
  P_Wnd30EW v12; // esi
  int v13; // esi
  int v14; // esi
  WORD v15; // [esp-Ch] [ebp-630h]
  char v16[1004]; // [esp+0h] [ebp-624h] BYREF
  char s[204]; // [esp+3ECh] [ebp-238h] BYREF
  char v18[204]; // [esp+4B8h] [ebp-16Ch] BYREF
  char s1[60]; // [esp+584h] [ebp-A0h] BYREF
  PANE v20; // [esp+5C0h] [ebp-64h] BYREF
  P_Wnd30EW v21; // [esp+5D4h] [ebp-50h]
  char *v22; // [esp+5D8h] [ebp-4Ch]
  int v23; // [esp+5DCh] [ebp-48h]
  int v24; // [esp+5E0h] [ebp-44h] BYREF
  int v25; // [esp+5E4h] [ebp-40h]
  int v26; // [esp+5E8h] [ebp-3Ch]
  int v27; // [esp+5ECh] [ebp-38h]
  int v28; // [esp+5F0h] [ebp-34h]
  int v29; // [esp+5F4h] [ebp-30h]
  int v30; // [esp+5F8h] [ebp-2Ch]
  int v31; // [esp+5FCh] [ebp-28h]
  int v32; // [esp+600h] [ebp-24h]
  char *v33; // [esp+604h] [ebp-20h]
  int v34; // [esp+608h] [ebp-1Ch]
  int v35; // [esp+60Ch] [ebp-18h]

  v21 = pWnd;
  species = V_Game.races[V_PlayerRaceIndex].species;
  v33 = (char *)V_BigBuffer;
  V_BigBuffer[0] = 0;
  v16[0] = 0;
  v3 = Q_OpenTextFile_sub_1BB10("history.txt", 0);
  if ( !v3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x1C1);
  }
  v26 = 0;
  do
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
    sscanf(s, "%s", s1);
    if ( !stricmp(s1, "SPECNUM") )
    {
      sscanf(s, "%s %d", s1, &v24);
      if ( species == v24 )
      {
        v26 = 1;
      }
    }
    else if ( !stricmp(s1, "END") )
    {
      sub_2620C("Species %d not found in history file.\n", species);
      Q_PrintFailAndExit_sub_261B8(0, "..\\eventwnd.cpp", 0x1E8);
    }
  }
  while ( !v26 );
  if ( v26 != 2 )
  {
    v23 = 0;
    v22 = V_SpecNames[species];
    do
    {
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
      sscanf(s, "%s", s1);
      if ( !stricmp(s1, "SPECNUM") || !stricmp(s1, "END") )
      {
        v26 = 2;
      }
      else if ( !stricmp(s1, "POWER") )
      {
        v28 = 0;
        v31 = 0;
        sprintf(v18, "%s: ", v22);
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
          if ( !strnicmp(s, "ENDPOWER", 8u) )
          {
            v28 = 0xFFFFFFFF;
          }
          else
          {
            v31 += strlen(s);
            if ( v31 >= 0xC4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x238);
            }
            strcat(v18, s);
          }
        }
        while ( !v28 );
      }
      else if ( !stricmp(s1, "INTRO") )
      {
        v34 = 0;
        v30 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
          if ( !strnicmp(s, "ENDINTRO", 8u) )
          {
            v34 = 0xFFFFFFFF;
            v23 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x24D);
            }
            strcat(v16, s);
          }
        }
        while ( !v34 );
      }
      else if ( !stricmp(s1, "PEACE") && v23 == 0xFFFFFFFF && !V_Game.atmosphere )
      {
        v25 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
          if ( !strnicmp(s, "ENDPEACE", 8u) )
          {
            v25 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x25F);
            }
            strcat(v16, s);
          }
        }
        while ( !v25 );
      }
      else if ( !stricmp(s1, "NEUTRAL") && v23 == 0xFFFFFFFF && V_Game.atmosphere == 1 )
      {
        v32 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
          if ( !strnicmp(s, "ENDNEUTRAL", 0xAu) )
          {
            v32 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x271);
            }
            strcat(v16, s);
          }
        }
        while ( !v32 );
      }
      else if ( !stricmp(s1, "HOSTILE") && v23 == 0xFFFFFFFF && V_Game.atmosphere == 2 )
      {
        v27 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
          if ( !strnicmp(s, "ENDHOSTILE", 0xAu) )
          {
            v27 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x283);
            }
            strcat(v16, s);
          }
        }
        while ( !v27 );
      }
      else if ( !stricmp(s1, "TEXT") )
      {
        v35 = 0;
        v29 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, s);
          if ( !strnicmp(s, "ENDTEXT", 7u) )
          {
            v35 = 0xFFFFFFFF;
          }
          else
          {
            v29 += strlen(s);
            if ( v29 >= 0xBB4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x295);
            }
            strcat(v33, s);
          }
        }
        while ( !v35 );
      }
    }
    while ( v26 != 2 );
  }
  fclose(v3);
  v13 = 0;
  if ( v16[0] )
  {
    while ( 1 )
    {
      if ( v13 >= 0x3E5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x2AB);
      }
      v4 = v16[v13];
      if ( v4 == 0xA )
      {
        break;
      }
      if ( v4 == 0x40 )
      {
        v16[v13] = 0xA;
      }
      else if ( v4 == 0x5F )
      {
        break;
      }
LABEL_83:
      if ( !v16[++v13] )
      {
        goto LABEL_84;
      }
    }
    v16[v13] = 0x20;
    goto LABEL_83;
  }
LABEL_84:
  if ( !v33 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x2B7);
  }
  v6 = v33;
  v14 = 0;
  if ( *v33 )
  {
    while ( 1 )
    {
      if ( v14 >= 0xBB5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x2BD);
      }
      v7 = v6[v14];
      if ( v7 == 0xA )
      {
        break;
      }
      if ( v7 == 0x40 )
      {
        v6[v14] = 0xA;
      }
      else if ( v7 == 0x5F )
      {
        break;
      }
LABEL_94:
      if ( !v6[++v14] )
      {
        goto LABEL_95;
      }
    }
    v6[v14] = 0x20;
    goto LABEL_94;
  }
LABEL_95:
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 7]);
  VFX_shape_draw(&V_GSystem.pane, ShapeTable_sub_1B084, 0, 7, 0x2E);
  v20.window = v21->a2.pane.window;
  v20.x1 = 0x278;
  v20.x0 = 7;
  v20.y0 = 0x105;
  v20.y1 = 0x1D1;
  colorSet = V_Game.races[V_PlayerRaceIndex].colorSet;
  v11 = v33;
  WinMgr.LargeFont.pane.window = v20.window;
  WinMgr.LargeFont.pane.x0 = 7;
  WinMgr.LargeFont.pane.y0 = v20.y0;
  WinMgr.LargeFont.pane.x1 = v20.x1;
  WinMgr.LargeFont.pane.y1 = v20.y1;
  v12 = v21;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0xA, v11, 0, 4 * colorSet + 0x13, 0xFF, 0x257);
  v20.window = v12->a2.pane.window;
  v20.x1 = 0x278;
  v20.y1 = 0xF5;
  v20.x0 = 0x138;
  v20.y0 = 0x2E;
  WinMgr.LargeFont.pane.window = v20.window;
  WinMgr.LargeFont.pane.x0 = 0x138;
  WinMgr.LargeFont.pane.y0 = v20.y0;
  WinMgr.LargeFont.pane.x1 = v20.x1;
  WinMgr.LargeFont.pane.y1 = v20.y1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0xA, v16, 0, 0xF3, 0xFF, 0x126);
  v20.window = v21->a2.pane.window;
  v20.x0 = 7;
  v20.y0 = 7;
  v20.x1 = 0x278;
  v20.y1 = 0x25;
  Q_DrawRaceFlagTinted_sub_53E38(&v20, 3, 3, V_PlayerRaceIndex);
  v15 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  WinMgr.LargeFont.pane = v20;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xA, v18, 2u, v15, 0xFF, 0x25A);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 271FC: using guessed type char var_624[1004];

//----- (00027BF8) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd24EW_Ctor_sub_27BF8(P_WndA2 a1)
{
  Q_WndA2_Ctor_sub_2C830(a1);
  a1->pProcs = &Wnd24EW_Procs;
}

//----- (00027C08) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd24EW_Dtor_sub_27C08(P_Wnd24EW self, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(self, &C_Wnd24EW);
    operator delete[](v3);
  }
  else
  {
    self->a2.pProcs = &Wnd24EW_Procs;
    Q_WndA2_Dtor_sub_2C848(&self->a2, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00027C50) --------------------------------------------------------
int __fastcall Q_Wnd24EW_Proc3_sub_27C50(P_Wnd24EW pWnd, UWORD message, int param1, int param2)
{
  __int16 v5; // ax
  char v7[2]; // [esp+0h] [ebp-10h] BYREF
  UWORD v8[7]; // [esp+2h] [ebp-Eh]

  v8[1] = message;
  if ( message != 1 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, v8[1], param1, param2);
  }
  LOBYTE(v8[0]) = 0;
  v7[1] = 0;
  v7[0] = 0;
  sub_2C2F8(&V_GSystem, v7);
  v5 = 5;
  V_FadeIndex = 0;
  V_FadeEffect = 0xFFFFFFFF;
  if ( V_Game.endingCondition == 1 )
  {
    v5 = V_Game.races[V_PlayerRaceIndex].species + 8;
  }
  sub_4F8CC(&V_SSystem, v5, 0);
  return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, v8[1], param1, param2);
}
// 132B60: using guessed type int V_FadeEffect;
// 132B64: using guessed type int V_FadeIndex;

//----- (00027D18) --------------------------------------------------------
void __fastcall Q_Wnd24EW_Proc4_sub_27D18(P_Wnd24EW pWnd, int a2)
{
  LONG v2; // eax
  FILE *v3; // ebp
  LONG v4; // ebx
  LONG v5; // ecx
  char v6; // bh
  char v8; // bl
  char *v10; // kr18_4
  char v11; // dh
  void *ShapeTable_sub_1B084; // eax
  UBYTE colorSet; // al
  int v15; // ebp
  char *sub_1CEA8; // eax
  char *v17; // ecx
  void *v18; // eax
  LONG v19; // edi
  LONG v20; // esi
  LONG v21; // ebx
  void *v22; // eax
  int racesNum; // eax
  void *v24; // eax
  WORD v25; // bp
  void *v26; // eax
  BYTE v27; // dl
  int v28; // esi
  int Ships_sub_40224; // eax
  unsigned int v30; // kr28_4
  int v31; // kr2C_4
  int shipsNum; // eax
  int raceIndex; // eax
  LONG v34; // ebx
  int v35; // ecx
  LONG v36; // ecx
  void *v37; // eax
  int v38; // esi
  int PlanetsNum_sub_402E0; // eax
  unsigned int v40; // kr50_4
  int v41; // kr54_4
  UBYTE v42; // al
  LONG v43; // ebx
  int v44; // ecx
  int v45; // eax
  LONG y0; // edx
  int v47; // ecx
  void *v48; // eax
  LONG v49; // esi
  int v50; // kr5C_4
  void *v51; // eax
  int i; // kr24_4
  LONG hullSize; // [esp-20h] [ebp-378h]
  LONG v54; // [esp-20h] [ebp-378h]
  LONG v55; // [esp-20h] [ebp-378h]
  LONG v56; // [esp-1Ch] [ebp-374h]
  LONG v57; // [esp-18h] [ebp-370h]
  LONG v58; // [esp-18h] [ebp-370h]
  LONG v59; // [esp-Ch] [ebp-364h]
  WORD v60; // [esp-Ch] [ebp-364h]
  WORD v61; // [esp-Ch] [ebp-364h]
  WORD v62; // [esp-4h] [ebp-35Ch]
  char v63[204]; // [esp+0h] [ebp-358h] BYREF
  char v64[204]; // [esp+CCh] [ebp-28Ch] BYREF
  char v65[204]; // [esp+198h] [ebp-1C0h] BYREF
  char s1[60]; // [esp+264h] [ebp-F4h] BYREF
  PANE pane; // [esp+2A0h] [ebp-B8h] BYREF
  char s[16]; // [esp+2B4h] [ebp-A4h] BYREF
  T_Ship *v69; // [esp+2C4h] [ebp-94h]
  P_Wnd24EW v70; // [esp+2C8h] [ebp-90h]
  int Unknown_306FC; // [esp+2CCh] [ebp-8Ch]
  LONG shape_number; // [esp+2D0h] [ebp-88h]
  char *ignore; // [esp+2D4h] [ebp-84h]
  int v74; // [esp+2D8h] [ebp-80h]
  int v75; // [esp+2DCh] [ebp-7Ch]
  LONG j; // [esp+2E0h] [ebp-78h]
  int v77; // [esp+2E4h] [ebp-74h]
  int v78; // [esp+2E8h] [ebp-70h]
  int v79; // [esp+2ECh] [ebp-6Ch]
  int v80; // [esp+2F0h] [ebp-68h]
  int v81; // [esp+2F4h] [ebp-64h]
  int v82; // [esp+2F8h] [ebp-60h]
  int v83; // [esp+2FCh] [ebp-5Ch]
  int v84; // [esp+300h] [ebp-58h]
  int v85; // [esp+304h] [ebp-54h]
  int v86; // [esp+308h] [ebp-50h]
  int v87; // [esp+30Ch] [ebp-4Ch]
  int v88; // [esp+310h] [ebp-48h]
  T_Planet *v89; // [esp+314h] [ebp-44h]
  int v90; // [esp+318h] [ebp-40h]
  int v91; // [esp+31Ch] [ebp-3Ch]
  PANE *p_pane; // [esp+320h] [ebp-38h]
  int v93; // [esp+324h] [ebp-34h]
  int v94; // [esp+328h] [ebp-30h]
  LONG hotX; // [esp+32Ch] [ebp-2Ch]
  int v96; // [esp+330h] [ebp-28h]
  int v97; // [esp+334h] [ebp-24h]
  int v98; // [esp+338h] [ebp-20h]
  UWORD index[2]; // [esp+33Ch] [ebp-1Ch]
  UWORD v100[2]; // [esp+340h] [ebp-18h]

  v70 = pWnd;
  Unknown_306FC = V_Game.Unknown_306FC;
  v2 = V_Game.Unknown_306FC / 10 - 1;
  shape_number = v2;
  if ( v2 >= 0 )
  {
    if ( v2 > 9 )
    {
      shape_number = 9;
    }
  }
  else
  {
    shape_number = 0;
  }
  V_BigBuffer[0] = 0;
  ignore = (char *)V_BigBuffer;
  switch ( V_Game.endingCondition )
  {
    case 1:
      sprintf(s, "end-xtnc.txt");
      break;
    case 2:
      sprintf(s, "end-dest.txt");
      break;
    case 3:
      sprintf(s, "end-capt.txt");
      break;
    case 4:
      sprintf(s, "end-unit.txt");
      break;
    case 5:
      sprintf(s, "end-ctrl.txt");
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\eventwnd.cpp", 0x34E);
      break;
  }
  v3 = Q_OpenTextFile_sub_1BB10(s, 0);
  if ( !v3 )
  {
    sub_2620C("Couldn't open %s", s);
    Q_PrintFailAndExit_sub_261B8(0, "..\\eventwnd.cpp", 0x370);
  }
  v63[0] = 0;
  v75 = 0;
  do
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, v65);
    sscanf(v65, "%s", s1);
    if ( !stricmp(s1, "END") )
    {
      v75 = 0xFFFFFFFF;
    }
    else if ( !stricmp(s1, "ENDDESC") )
    {
      v83 = 0;
      v84 = 0;
      do
      {
        Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, v65);
        if ( !strnicmp(v65, "ENDTEXT", 7u) )
        {
          v83 = 0xFFFFFFFF;
        }
        else
        {
          v84 += strlen(v65);
          if ( v84 >= 0xC4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3A1);
          }
          strcat(v63, v65);
        }
      }
      while ( !v83 );
    }
    else if ( !stricmp(s1, "CONGRAT") )
    {
      v85 = 0;
      v86 = 0;
      do
      {
        Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, v65);
        if ( !strnicmp(v65, "ENDTEXT", 7u) )
        {
          v85 = 0xFFFFFFFF;
        }
        else
        {
          v86 += strlen(v65);
          if ( v86 >= 0x3E4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3B3);
          }
          strcat(ignore, v65);
        }
      }
      while ( !v85 );
    }
    else if ( !stricmp(s1, "RANKS") )
    {
      v4 = 0;
      if ( shape_number > 0 )
      {
        v5 = shape_number;
        do
        {
          ++v4;
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, v65);
        }
        while ( v4 < v5 );
      }
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v3, v65);
      v64[0] = 0;
      strcat(v64, v65);
    }
  }
  while ( v75 != 0xFFFFFFFF );
  fclose(v3);
  j = 0;
  if ( v63[0] )
  {
    while ( 1 )
    {
      if ( j >= 0xC5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3D7);
      }
      v6 = v63[j];
      if ( v6 == 0xA )
      {
        break;
      }
      if ( v6 == 0x40 )
      {
        v63[j] = 0xA;
      }
      else if ( v6 == 0x5F )
      {
        break;
      }
LABEL_49:
      if ( !v63[++j] )
      {
        goto LABEL_50;
      }
    }
    v63[j] = 0x20;
    goto LABEL_49;
  }
LABEL_50:
  j = 0;
  if ( v64[0] )
  {
    while ( 1 )
    {
      if ( j >= 0xC5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3E9);
      }
      v8 = v64[j];
      if ( v8 == 0xA )
      {
        break;
      }
      if ( v8 == 0x40 )
      {
        v64[j] = 0xA;
      }
      else if ( v8 == 0x5F )
      {
        break;
      }
LABEL_58:
      if ( !v64[++j] )
      {
        goto LABEL_59;
      }
    }
    v64[j] = 0x20;
    goto LABEL_58;
  }
LABEL_59:
  if ( !ignore )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3F5);
  }
  v10 = ignore;
  j = 0;
  if ( *ignore )
  {
    while ( 1 )
    {
      if ( j >= 0x3E5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3FB);
      }
      v11 = v10[j];
      if ( v11 == 0xA )
      {
        break;
      }
      if ( v11 == 0x40 )
      {
        v10[j] = 0xA;
      }
      else if ( v11 == 0x5F )
      {
        break;
      }
LABEL_69:
      if ( !v10[++j] )
      {
        goto LABEL_70;
      }
    }
    v10[j] = 0x20;
    goto LABEL_69;
  }
LABEL_70:
  pane.window = v70->a2.pane.window;
  pane.x0 = 7;
  pane.y0 = 0xD7;
  pane.x1 = 0x12F;
  pane.y1 = 0x17D;
  if ( V_Game.endingCondition != 1 )
  {
    v59 = shape_number;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2B]);// 43: data\9endgame.shp
    VFX_shape_draw(&pane, ShapeTable_sub_1B084, v59, 0x94, 0x53);
  }
  pane.x1 = 0x12F;
  pane.x0 = 7;
  pane.y0 = 0xD7;
  pane.y1 = 0x107;
  sprintf(v65, "%s", v63);
  colorSet = V_Game.races[V_PlayerRaceIndex].colorSet;
  v15 = Unknown_306FC;
  WinMgr.LargeFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xE, 0, v65, 1u, 4 * colorSet + 0x13, 0xFF, 0x118);
  pane.x1 = 0x12F;
  pane.y1 = 0x17D;
  pane.x0 = 7;
  pane.y0 = 0x14D;
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xF); // 15: "Your score is %d%%.\nThis gives you the title of %s"
  sprintf(v65, sub_1CEA8, v15, v64);
  v60 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  WinMgr.LargeFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, v65, 3u, v60, 0xFF, 0x118);
  pane.x1 = 0x278;
  pane.x0 = 7;
  pane.y0 = 0x18D;
  pane.y1 = 0x1D1;
  v17 = ignore;
  v61 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  WinMgr.LargeFont.pane.window = pane.window;
  WinMgr.LargeFont.pane.x0 = 7;
  WinMgr.LargeFont.pane.y0 = pane.y0;
  WinMgr.LargeFont.pane.x1 = pane.x1;
  WinMgr.LargeFont.pane.y1 = pane.y1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 7, 0, v17, 1u, v61, 0xFF, 0x25A);
  v18 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 7]);
  v19 = 0x2A;
  VFX_shape_draw(&V_GSystem.pane, v18, 0, 7, 7);
  j = 1;
  v93 = 2;
  v20 = 0x15B;
  Q_DrawRaceFlagTinted_sub_53E38(&v70->a2.pane, 0xA, 0xA, V_PlayerRaceIndex);
  for ( i = 0; ; ++i )
  {
    racesNum = V_Game.racesNum;
    if ( V_Game.racesNum <= i + 1 )
    {
      break;
    }
    if ( i == 3 )
    {
      v20 = 0x15B;
      v19 = 0x85;
    }
    v24 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[i + 1]);
    VFX_shape_transform(&V_GSystem.pane, v24, 0, v20, v19, V_BigBuffer, 0, 0x8000, 0x8000, 0);
    v25 = j;
    v62 = j;
    v26 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
    Q_DrawRaceTintedShape_sub_53EB8(&V_GSystem.pane, v26, 3, v20, v19, v62);
    Q_DrawRaceFlagTinted_sub_53E38(&V_GSystem.pane, v20 - 7, v19 + 0x21, v25);
    v27 = V_Game.races[V_PlayerRaceIndex].treaties[i + 1];
    v21 = 0xFFFFFFFF;
    if ( v27 == 3 )
    {
      v21 = 9;
    }
    else if ( v27 == 2 )
    {
      v21 = 8;
    }
    if ( v21 != 0xFFFFFFFF )
    {
      v22 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
      VFX_shape_draw(&V_GSystem.pane, v22, v21, v20 - 7, v19 + 0x21);
    }
    v20 += 0x3E;
  }
  j = i + 1;
  v77 = 0x278;
  LOWORD(racesNum) = GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE];
  pane.x0 = 0x138;
  *(_DWORD *)index = racesNum;
  pane.y0 = 7;
  pane.x1 = 0x278;
  pane.y1 = 0x17D;
  v28 = 7;
  Ships_sub_40224 = Q_Race_GetShips_sub_40224(&V_Game.races[V_PlayerRaceIndex], 0, 0);
  v78 = Ships_sub_40224;
  if ( Ships_sub_40224 < 0x14 )
  {
    v28 = 7 - 7 * (0x14 - Ships_sub_40224) / 0x11;
  }
  if ( v28 >= 0 )
  {
    if ( v28 > 6 )
    {
      v28 = 6;
    }
  }
  else
  {
    v28 = 0;
  }
  v79 = v78 / (v28 + 1);
  v80 = 0;
  v82 = 0x9F;
  v81 = v77 - 0x212;
  if ( v77 - 0x212 < 2 )
  {
    v81 = 2;
  }
  v74 = 0x208;
  v87 = 0x11;
  v30 = 0xFFFFFF00 * v28 + 0x700;
  v31 = 0;
  j = 0;
  while ( 1 )
  {
    shipsNum = V_Game.shipsNum;
    if ( V_Game.shipsNum <= j )
    {
      break;
    }
    raceIndex = V_Game.ships[j].raceIndex;
    v69 = &V_Game.ships[j];
    if ( raceIndex == V_PlayerRaceIndex )
    {
      v34 = 0;
      if ( v80 > v79 && v28 > 0 )
      {
        --v28;
        ++v31;
      }
      if ( v28 > 0 )
      {
        VFX_shape_lookaside(&(*V_GSystem.hazeTables)[v31][v30]);
        v34 = 1;
      }
      v35 = v74 - pane.x0;
      v36 = rand() % v81 + v35;
      hotX = v87 - pane.y0;
      v57 = hotX + rand() % v82;
      hullSize = v69->hullSize;
      v37 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index[0]);
      VFX_shape_transform(&pane, v37, hullSize, v36, v57, V_BigBuffer, 0, 0x5555, 0x5555, v34);
    }
    ++j;
    ++v80;
  }
  LOWORD(shipsNum) = GwshareShpCacheIndexes[0x1D];     // 29: data\planets.shp
  *(_DWORD *)v100 = shipsNum;
  v96 = 0x1FF;
  v38 = 7;
  PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[V_PlayerRaceIndex]);
  if ( PlanetsNum_sub_402E0 < 0x14 )
  {
    v38 = 7 - 7 * (0x14 - PlanetsNum_sub_402E0) / 0x11;
  }
  if ( v38 >= 0 )
  {
    if ( v38 > 6 )
    {
      v38 = 6;
    }
  }
  else
  {
    v38 = 0;
  }
  v97 = v78 / (v38 + 1);
  v94 = v96 - 0x14C;
  v98 = 0;
  v88 = 0x97;
  if ( v96 - 0x14C < 2 )
  {
    v94 = 2;
  }
  v90 = 0x142;
  v91 = 0xDC;
  v40 = 0xFFFFFF00 * v38 + 0x700;
  v41 = 0;
  j = 0;
  while ( V_Game.planetsNum > j )
  {
    v42 = V_Game.planets[j].raceIndex;
    v89 = &V_Game.planets[j];
    if ( v42 == V_PlayerRaceIndex )
    {
      v43 = 0;
      if ( v98 > v97 && v38 > 0 )
      {
        --v38;
        ++v41;
      }
      if ( v38 > 0 )
      {
        VFX_shape_lookaside(&(*V_GSystem.hazeTables)[v41][v40]);
        v43 = 1;
      }
      v44 = v90 - pane.x0;
      v45 = rand();
      y0 = pane.y0;
      hotX = v45 % v94 + v44;
      v47 = v91;
      v58 = v47 - y0 + rand() % v88;
      v56 = hotX;
      v54 = 5 * v89->type + v89->size;
      v48 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v100[0]);
      VFX_shape_transform(&pane, v48, v54, v56, v58, V_BigBuffer, 0, 0x5555, 0x5555, v43);
    }
    ++j;
    ++v98;
  }
  v49 = 0x213;
  p_pane = &v70->a2.pane;
  v50 = 0;
  for ( j = 0; V_Research.num > j; ++j )
  {
    if ( j && !(j % 6) )
    {
      v49 = 0x213;
      ++v50;
    }
    if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[j].knownToRace) != 0 )
    {
      v55 = j;
      v51 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);// 31: data\restree.shp
      VFX_shape_transform(p_pane, v51, v55, v49, 0x11 * v50 + 0xCB, V_BigBuffer, 0, 0x5555, 0x5555, 0);
    }
    v49 += 0x11;
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &V_GSystem.pane);
}
// 28784: conditional instruction was optimized away because %var_60.4==9F
// 289D7: conditional instruction was optimized away because %var_48.4==97
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 27D18: using guessed type char var_358[204];
// 27D18: using guessed type char var_28C[204];

//----- (00028C40) --------------------------------------------------------
void __cdecl Q_TimerCallback_sub_28C40(ULONG user)
{
  dword_D8650 = 0xFFFFFFFF;
}
// D8650: using guessed type int dword_D8650;

//----- (00028C4C) --------------------------------------------------------
int __fastcall Q_CompareSubtitleInstructions_sub_28C4C(P_SubtitleInstruction a1, P_SubtitleInstruction a2)
{
  return a1->frameNumber - a2->frameNumber;
}

//----- (00028C58) --------------------------------------------------------
int __fastcall Q_NC_sub_28C58(int result, __int16 a2)
{
  __int16 v2; // cx

  v2 = *(_WORD *)(result + 6);
  *(_WORD *)(result + 2) += a2;
  *(_WORD *)(result + 6) = a2 + v2;
  return result;
}

//----- (00028C74) --------------------------------------------------------
void __fastcall __spoils<> Q_Type2_Init_sub_28C74(P_Type2 a1)
{
  Q_CFile_Ctor_sub_1BB78(&a1->cfile);
  Q_Font_Init_sub_2B2C0(&a1->font);
  a1->pBuf_198 = 0;
  a1->pBuf_1A8 = 0;
  a1->pBuf_1AC = 0;
  a1->dword1B0 = 0;
  a1->dword1B4 = 0;
  a1->dword19C = 0xFFFFFFFF;
  memset(&a1->flicHeader, 0, sizeof(a1->flicHeader));
  a1->pBuf2 = 0;
  a1->pFlicBuffer = 0;
  a1->dword1EC = 0;
  a1->pBuf3 = 0;
  a1->showInfo = 0;
  memset(a1->subtInsts, 0, sizeof(a1->subtInsts));
  memset(a1->subtitleTexts, 0, sizeof(a1->subtitleTexts));
  a1->Unknown_804 = 0;
  a1->subtInstNum = 0;
  a1->Unknown_908 = 0;
  a1->pFontPalData = 0;
  a1->fontPalStart = 0;
  a1->fontPalCount = 0;
  a1->timerHandle = 0xFFFFFFFF;
  a1->timerFrequency = 0x12;
  a1->Unknown_93A = 0;
  a1->skipFrame = 0xFFFFFFFF;
  a1->Unknown_942 = 0;
}

//----- (00028DA4) --------------------------------------------------------
void __fastcall __spoils<> Q_Type2_Finalize_sub_28DA4(P_Type2 a1)
{
  int i; // ebx
  int j; // ebx

  if ( a1->dword1B0 == 0xFFFFFFFF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pBuf_1AC);
  }
  operator delete(a1->pBuf_1AC);
  if ( a1->dword1B4 == 0xFFFFFFFF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pBuf_198);
    operator delete(a1->pBuf_198);
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pBuf_1A8);
    operator delete(a1->pBuf_1A8);
  }
  for ( i = 0; i < (__int16)a1->Unknown_908; ++i )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->subtitleTexts[i].pText);
  }
  operator delete(a1->subtitleTexts[i].pText);
  for ( j = 0; j < a1->subtInstNum; ++j )
  {
    if ( a1->subtInsts[j].code == 0xA )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C((void *)a1->subtInsts[j].param2);
      operator delete((void *)a1->subtInsts[j].param2);
      a1->subtInsts[j].param2 = 0;
    }
  }
  if ( a1->pFontPalData )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pFontPalData);
  }
  operator delete(a1->pFontPalData);
  sub_2AD08(a1);
  sub_2B2E0(&a1->font);
  Q_CFile_Dtor_sub_1BBC8(&a1->cfile);
}
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00028EB4) --------------------------------------------------------
int __fastcall Q_Type2_sub_28EB4(P_Type2 a1, const char *flicName, void *pBuf, int a4, int a5)
{
  int result; // eax
  __int64 v7; // rax
  int v8; // eax
  __int64 v9; // rax
  int v10; // eax
  UBYTE *pBuf_1AC; // eax

  if ( !flicName )
  {
    return 0;
  }
  Q_Type2_LoadSubtitleTxt_sub_2A1DC(a1, "SUBTITLE.TXT");
  if ( Q_CFile_Open_sub_1BBFC(&a1->cfile, flicName, O_BINARY, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0xE9);
    return 0;
  }
  if ( Q_CFile_Read_sub_1BF94(&a1->cfile, &a1->flicHeader, 0x80u) == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0xE3);
    return 0;
  }
  if ( a1->flicHeader.type != 0xAF12 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0xEF);
    return 0;
  }
  if ( a4 == 0xFFFFFFFF )
  {
    v7 = 640 - a1->flicHeader.width;
    v8 = ((int)v7 - HIDWORD(v7)) >> 1;
  }
  else
  {
    v8 = a4;
  }
  a1->Unknown_1A0 = v8;
  if ( a5 == 0xFFFFFFFF )
  {
    v9 = 480 - a1->flicHeader.height;
    v10 = ((int)v9 - HIDWORD(v9)) >> 1;
  }
  else
  {
    v10 = a5;
  }
  a1->window.x_max = 639;
  a1->window.y_max = 479;
  a1->Unknown_1A4 = v10;
  a1->pane.window = &a1->window;
  if ( pBuf )
  {
    a1->dword1B0 = 0;
    a1->pBuf_1AC = pBuf;
  }
  else
  {
    result = (int)V_GSystem.window.buffer;
    a1->pBuf_1AC = V_GSystem.window.buffer;
    if ( !result )
    {
      return result;
    }
    a1->dword1B0 = 0;
  }
  a1->window.stencil = 0;
  pBuf_1AC = (UBYTE *)a1->pBuf_1AC;
  a1->window.shadow = 0;
  a1->window.buffer = pBuf_1AC;
  return 0xFFFFFFFF;
}

//----- (00029038) --------------------------------------------------------
unsigned int __fastcall Q_Type2_sub_29038(P_Type2 a1, size_t a2, unsigned int a3, int a4, int a5, void *pBuf)
{
  int v8; // edi
  int dword1B4; // edx
  void *v10; // eax
  void *pFlicBuffer; // eax
  size_t v13; // eax
  int oframe1; // edx
  char *v15; // ebp
  char *pBuf2; // eax

  v8 = a3;
  a1->Unknown_804 = 0;
  a1->Unknown_92A = 0;
  a1->Unknown_942 = 0;
  a1->Unknown_92C = 0;
  if ( a2 < a3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x15E);
  }
  if ( a2 - a4 < a3 )
  {
    v8 = a2 - a4;
  }
  dword1B4 = a1->dword1B4;
  a1->dword19C = 0xFFFFFFFF;
  if ( dword1B4 == 0xFFFFFFFF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pBuf_198);
    operator delete[](a1->pBuf_198);
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pBuf_1A8);
    operator delete[](a1->pBuf_1A8);
    a1->pBuf_198 = 0;
    a1->pBuf_1A8 = 0;
    a1->dword1B4 = 0;
  }
  if ( pBuf )
  {
    a1->pFlicBuffer = pBuf;
  }
  if ( a1->pFlicBuffer || (v10 = operator new[](a2), Q_RegisterDataInWinMgr_sub_2625C(v10, 1, "FLIC BUFFER"), (a1->pFlicBuffer = v10) != 0) )
  {
    pFlicBuffer = a1->pFlicBuffer;
    a1->gap1F4 = a2;
    v13 = (size_t)pFlicBuffer + a2;
    oframe1 = a1->flicHeader.oframe1;
    a1->dword1EC = v13;
    a1->pBuf3 = (void *)(v13 - a4);
    v15 = (char *)a1->pBuf3 - v8;
    a1->Unknown_1FC = a5;
    a1->pBuf2 = v15;
    sub_1BECC(&a1->cfile, oframe1, 0);
    a1->Unknown_200 = (sub_1BFD4(&a1->cfile, a1->pBuf2, v8, 0x40u, sub_2BCF4) >= v8) - 1;
    VFX_area_wipe(0, 0, 639, 479, 0);
    pBuf2 = (char *)a1->pBuf2;
    a1->pBuf_198 = pBuf2;
    a1->pBuf_1A8 = pBuf2 + 0x10;
    a1->pBuf2 = a1->pFlicBuffer;
    a1->Unknown_1F8 = a1->pBuf_198 - a1->pBuf2;
    return 0xFFFFFFFF;
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x183);
    return 0;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (000291F8) --------------------------------------------------------
unsigned int __fastcall Q_NC_sub_291F8(int a1)
{
  int v2; // edx
  int v3; // edx
  int v5; // edi
  _DWORD *v6; // edi
  int i; // ebp
  _DWORD *v8; // edx
  unsigned __int16 v9; // ax
  unsigned __int16 *v10; // edx

  v2 = *(_DWORD *)(a1 + 0x19C) + 1;
  *(_DWORD *)(a1 + 0x19C) = v2;
  if ( v2 )
  {
    if ( *(unsigned __int16 *)(a1 + 0x11E) >= *(int *)(a1 + 0x19C) )
    {
      goto LABEL_6;
    }
    v3 = *(_DWORD *)(a1 + 0x16C);
    *(_DWORD *)(a1 + 0x19C) = 1;
  }
  else
  {
    v3 = *(_DWORD *)(a1 + 0x168);
  }
  sub_1BECC((P_CFile)a1, v3, 0);
LABEL_6:
  if ( Q_CFile_Read_sub_1BF94((P_CFile)a1, *(void **)(a1 + 0x198), 0x10u) == 0xFFFFFFFF )
  {
    return 0;
  }
  v5 = **(_DWORD **)(a1 + 0x198) - 0x10;
  if ( v5 < 0 || v5 > 0x4B000 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x1DD);
  }
  Q_CFile_Read_sub_1BF94((P_CFile)a1, *(void **)(a1 + 0x1A8), **(_DWORD **)(a1 + 0x198) - 0x10);
  if ( *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 4) != 0xF1FA )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x1E0);
  }
  v6 = *(_DWORD **)(a1 + 0x1A8);
  for ( i = 0; i < *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 6); ++i )
  {
    v8 = v6;
    v6 = (_DWORD *)((char *)v6 + *v6);
    v9 = *((_WORD *)v8 + 2);
    v10 = (unsigned __int16 *)v8 + 3;
    if ( v9 < 0xFu )
    {
      if ( v9 < 4u )
      {
        goto LABEL_18;
      }
      if ( v9 <= 4u )
      {
        sub_29C6C((P_Type2)a1, v10);
      }
      else
      {
        if ( v9 != 7 )
        {
LABEL_18:
          Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x221);
        }
        sub_2AD40(v10, *(_DWORD *)(a1 + 0x1A0), *(_DWORD *)(a1 + 0x1A4));
      }
    }
    else if ( v9 <= 0xFu )
    {
      sub_29D54((P_Type2)a1, (unsigned __int8 *)v10);
    }
    else if ( v9 <= 0x10u )
    {
      sub_29F58((P_Type2)a1, v10);
    }
    else if ( v9 != 0x12 )
    {
      goto LABEL_18;
    }
  }
  return 0xFFFFFFFF;
}

//----- (0002936C) --------------------------------------------------------
unsigned int __fastcall Q_NC_sub_2936C(T_Type2 *a1)
{
  int v2; // ebx
  char *pBuf_1A8; // esi
  int i; // edi
  unsigned __int16 *v6; // edx
  unsigned __int16 v7; // ax
  __int16 Unknown_92A; // ax
  _DWORD *pBuf_198; // esi
  char *v10; // esi
  char *pBuf3; // edi
  int v12; // edx
  char *v13; // edi
  char *pFlicBuffer; // esi
  signed int v15; // ecx
  int Unknown_200; // ecx
  int Unknown_1F8; // edx
  int v18; // esi
  int v19; // edx
  void *v20; // ebx
  void *pBuf2; // eax

  v2 = ++a1->dword19C;
  if ( a1->flicHeader.frames <= v2 )
  {
    return 0;
  }
  if ( !v2 )
  {
    VFX_area_wipe(0, 0, 0x27F, 0x1DF, a1->font.backColor);
  }
  if ( a1->showInfo == 0xFFFFFFFF )
  {
    Q_Type2_sub_29B24(a1);
  }
  if ( *((unsigned __int16 *)a1->pBuf_198 + 2) != 0xF1FA )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x246);
  }
  pBuf_1A8 = (char *)a1->pBuf_1A8;
  for ( i = 0; i < *((unsigned __int16 *)a1->pBuf_198 + 3); ++i )
  {
    v6 = (unsigned __int16 *)(pBuf_1A8 + 6);
    v7 = *((_WORD *)pBuf_1A8 + 2);
    pBuf_1A8 += *(_DWORD *)pBuf_1A8;
    if ( v7 < 0xFu )
    {
      if ( v7 < 4u )
      {
        goto LABEL_14;
      }
      if ( v7 <= 4u )
      {
        sub_29C6C(a1, v6);
      }
      else
      {
        if ( v7 != 7 )
        {
LABEL_14:
          Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x26C);
        }
        sub_2AD40(v6, a1->Unknown_1A0, a1->Unknown_1A4);
      }
    }
    else if ( v7 <= 0xFu )
    {
      sub_29D54(a1, (unsigned __int8 *)v6);
    }
    else if ( v7 <= 0x10u )
    {
      sub_29F58(a1, v6);
    }
    else if ( v7 != 0x12 )
    {
      goto LABEL_14;
    }
  }
  Unknown_92A = a1->Unknown_92A;
  if ( Unknown_92A )
  {
    if ( (unsigned __int16)Unknown_92A <= 1u )
    {
      sub_2C4C0(&V_GSystem, a1->fontPalStart, a1->fontPalCount);
    }
    else if ( Unknown_92A == 2 )
    {
      sub_2C418(&V_GSystem, a1->fontPalStart, a1->fontPalCount);
    }
  }
  if ( a1->subtInsts[(__int16)a1->Unknown_804].frameNumber == a1->dword19C )
  {
    sub_2AA88(a1);
  }
  pBuf_198 = a1->pBuf_198;
  a1->Unknown_1F8 += *pBuf_198;
  v10 = (char *)pBuf_198 + *pBuf_198;
  pBuf3 = (char *)a1->pBuf3;
  a1->pBuf_198 = v10;
  if ( v10 < pBuf3 )
  {
    v12 = v10 + 0x10 - pBuf3;
    if ( v12 <= 0 )
    {
      v15 = &v10[*(_DWORD *)v10] - pBuf3;
      if ( v15 <= 0 )
      {
        goto LABEL_42;
      }
      if ( v15 >= a1->dword1EC - (int)pBuf3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x2D2);
      }
      pFlicBuffer = (char *)a1->pFlicBuffer;
      v13 = (char *)a1->pBuf3;
    }
    else
    {
      qmemcpy(pBuf3, a1->pFlicBuffer, v10 + 0x10 - pBuf3);
      v13 = v10 + 0x10;
      pFlicBuffer = (char *)a1->pFlicBuffer + v12;
      v15 = *(_DWORD *)a1->pBuf_198 - 0x10;
    }
    qmemcpy(v13, pFlicBuffer, v15);
    goto LABEL_42;
  }
  a1->pBuf_198 = (void *)((char *)a1->pFlicBuffer + (unsigned int)v10 - pBuf3);
LABEL_42:
  Unknown_200 = a1->Unknown_200;
  a1->pBuf_1A8 = (char *)a1->pBuf_198 + 0x10;
  if ( !Unknown_200 )
  {
    if ( a1->Unknown_1F8 < (unsigned int)a1->Unknown_1FC )
    {
      Unknown_1F8 = a1->Unknown_1F8;
    }
    else
    {
      Unknown_1F8 = a1->Unknown_1FC;
    }
    v18 = Unknown_1F8;
    if ( (char *)a1->pBuf2 + Unknown_1F8 - (char *)a1->pBuf3 > 0 )
    {
      v18 = a1->pBuf3 - a1->pBuf2;
    }
    if ( Q_CFile_Read_sub_1BF94(&a1->cfile, a1->pBuf2, v18) < v18 )
    {
      a1->Unknown_200 = 0xFFFFFFFF;
    }
    v19 = a1->Unknown_1F8;
    v20 = a1->pBuf3;
    a1->pBuf2 = (char *)a1->pBuf2 + v18;
    pBuf2 = a1->pBuf2;
    a1->Unknown_1F8 = v19 - v18;
    if ( pBuf2 >= v20 )
    {
      a1->pBuf2 = a1->pFlicBuffer;
    }
  }
  if ( a1->dword1EC + *(_DWORD *)a1->pBuf_198 + a1->Unknown_1F8 - (unsigned int)a1->pBuf3 >= a1->gap1F4 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x305);
  }
  return 0xFFFFFFFF;
}

//----- (000296B4) --------------------------------------------------------
unsigned int __fastcall Q_Type2_sub_296B4(P_Type2 a1)
{
  int v2; // edx
  int v4; // eax
  UBYTE *pBuf_1A8; // esi
  int i; // edi
  UBYTE *v7; // edx
  unsigned __int16 v8; // ax
  UBYTE *v9; // edx
  __int16 Unknown_92A; // ax
  char *v11; // esi
  char *pBuf3; // edx
  signed int v13; // edx
  char *v14; // edi
  char *pFlicBuffer; // esi
  signed int v16; // ecx
  char *v17; // ecx
  _BYTE *v18; // esi
  int Unknown_1F8; // edx
  int v20; // esi
  int v21; // edi
  void *v22; // edx
  void *pBuf2; // eax
  signed int v24; // esi
  _BYTE *v25; // edx
  int v26; // ecx
  int v27; // ecx
  void *v28; // esi
  void *v29; // eax

  if ( dword_D8650 )
  {
    if ( a1->showInfo == 0xFFFFFFFF )
    {
      Q_Type2_sub_29B24(a1);
    }
    if ( dword_D8650 != 0xFFFFFFFF && a1->Unknown_93A != 0xFFFFFFFF )
    {
      goto LABEL_54;
    }
    if ( !a1->Unknown_93A )
    {
      _disable();
      dword_D8650 = 0;
      _enable();
    }
    v2 = a1->dword19C + 1;
    a1->dword19C = v2;
    if ( !v2 )
    {
      VFX_area_wipe(0, 0, 639, 479, a1->font.backColor);
    }
    if ( a1->flicHeader.frames <= a1->dword19C )
    {
      return 0;
    }
    v4 = *((unsigned __int16 *)a1->pBuf_198 + 2);
    ++dword_A0CF8;
    if ( v4 != 0xF1FA )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x32E);
    }
    pBuf_1A8 = (UBYTE *)a1->pBuf_1A8;
    for ( i = 0; i < *((unsigned __int16 *)a1->pBuf_198 + 3); ++i )
    {
      v7 = pBuf_1A8;
      pBuf_1A8 += *(_DWORD *)pBuf_1A8;
      v8 = *((_WORD *)v7 + 2);
      v9 = v7 + 6;
      if ( v8 < 0xFu )
      {
        if ( v8 < 4u )
        {
          goto LABEL_19;
        }
        if ( v8 <= 4u )
        {
          a1->Unknown_92C = 0;
          sub_29C6C(a1, v9);
        }
        else
        {
          if ( v8 != 7 )
          {
LABEL_19:
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x355);
          }
          sub_2AD40((unsigned __int16 *)v9, a1->Unknown_1A0, a1->Unknown_1A4);
        }
      }
      else if ( v8 <= 0xFu )
      {
        sub_29D54(a1, v9);
      }
      else if ( v8 <= 0x10u )
      {
        sub_29F58(a1, v9);
      }
      else if ( v8 != 0x12 )
      {
        goto LABEL_19;
      }
    }
    Unknown_92A = a1->Unknown_92A;
    if ( Unknown_92A )
    {
      if ( (unsigned __int16)Unknown_92A <= 1u )
      {
        sub_2C4C0(&V_GSystem, a1->fontPalStart, a1->fontPalCount);
      }
      else if ( Unknown_92A == 2 )
      {
        sub_2C418(&V_GSystem, a1->fontPalStart, a1->fontPalCount);
      }
    }
    if ( a1->subtInsts[(__int16)a1->Unknown_804].frameNumber == a1->dword19C )
    {
      sub_2AA88(a1);
    }
    if ( a1->Unknown_92C )
    {
      Q_GSystem_FadePalette_sub_2C5E4(&V_GSystem, LOBYTE(a1->Unknown_92C) - 1);
      if ( ++a1->Unknown_92C > 0x40 )
      {
        a1->Unknown_92C = 0;
      }
    }
    if ( a1->Unknown_93A == 0xFFFFFFFF && a1->skipFrame == a1->dword19C )
    {
      getch();
      a1->Unknown_93A = 0;
      a1->skipFrame = 0xFFFFFFFF;
    }
    a1->Unknown_1F8 += *(_DWORD *)a1->pBuf_198;
    v11 = (char *)a1->pBuf_198 + *(_DWORD *)a1->pBuf_198;
    pBuf3 = (char *)a1->pBuf3;
    a1->pBuf_198 = v11;
    if ( v11 >= pBuf3 )
    {
      a1->pBuf_198 = (void *)((char *)a1->pFlicBuffer + (unsigned int)v11 - pBuf3);
LABEL_53:
      a1->pBuf_1A8 = (char *)a1->pBuf_198 + 0x10;
LABEL_54:
      if ( !a1->Unknown_200 )
      {
        if ( a1->Unknown_1F8 < (unsigned int)a1->Unknown_1FC )
        {
          Unknown_1F8 = a1->Unknown_1F8;
        }
        else
        {
          Unknown_1F8 = a1->Unknown_1FC;
        }
        v20 = Unknown_1F8;
        if ( (char *)a1->pBuf2 + Unknown_1F8 - (char *)a1->pBuf3 > 0 )
        {
          v20 = a1->pBuf3 - a1->pBuf2;
        }
        if ( Q_CFile_Read_sub_1BF94(&a1->cfile, a1->pBuf2, v20) < v20 )
        {
          a1->Unknown_200 = 0xFFFFFFFF;
        }
        v21 = a1->Unknown_1F8;
        v22 = a1->pBuf3;
        a1->pBuf2 = (char *)a1->pBuf2 + v20;
        pBuf2 = a1->pBuf2;
        a1->Unknown_1F8 = v21 - v20;
        if ( pBuf2 >= v22 )
        {
          a1->pBuf2 = a1->pFlicBuffer;
        }
      }
      if ( a1->dword1EC + *(_DWORD *)a1->pBuf_198 + a1->Unknown_1F8 - (unsigned int)a1->pBuf3 >= a1->gap1F4 )
      {
        v24 = a1->Unknown_1F8;
        v25 = a1->pBuf3;
        if ( (char *)a1->pBuf2 + v24 - v25 > 0 )
        {
          v24 = v25 - (_BYTE *)a1->pBuf2;
        }
        if ( Q_CFile_Read_sub_1BF94(&a1->cfile, a1->pBuf2, v24) < v24 )
        {
          a1->Unknown_200 = 0xFFFFFFFF;
        }
        v26 = a1->Unknown_1F8;
        a1->pBuf2 = (char *)a1->pBuf2 + v24;
        v27 = v26 - v24;
        v28 = a1->pBuf3;
        v29 = a1->pBuf2;
        a1->Unknown_1F8 = v27;
        if ( v29 >= v28 )
        {
          a1->pBuf2 = a1->pFlicBuffer;
        }
      }
      return 0xFFFFFFFF;
    }
    v13 = v11 + 0x10 - (char *)a1->pBuf3;
    if ( v13 <= 0 )
    {
      v17 = &v11[*(_DWORD *)v11];
      v18 = a1->pBuf3;
      v16 = v17 - v18;
      if ( v16 <= 0 )
      {
        goto LABEL_53;
      }
      if ( v16 >= a1->dword1EC - (int)v18 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x3D0);
      }
      pFlicBuffer = (char *)a1->pFlicBuffer;
      v14 = (char *)a1->pBuf3;
    }
    else
    {
      qmemcpy(a1->pBuf3, a1->pFlicBuffer, v11 + 0x10 - (char *)a1->pBuf3);
      v14 = v11 + 0x10;
      pFlicBuffer = (char *)a1->pFlicBuffer + v13;
      v16 = *(_DWORD *)a1->pBuf_198 - 0x10;
    }
    qmemcpy(v14, pFlicBuffer, v16);
    goto LABEL_53;
  }
  return 0xFFFFFFFF;
}
// A0CF8: using guessed type int dword_A0CF8;
// D8650: using guessed type int dword_D8650;

//----- (00029B24) --------------------------------------------------------
void __fastcall Q_Type2_sub_29B24(P_Type2 a1)
{
  void *pFlicBuffer; // ecx
  signed int v2; // ebx
  int v3; // edi
  int v4; // eax
  LONG v5; // esi
  RGB v6[4]; // [esp+0h] [ebp-18h] BYREF

  pFlicBuffer = a1->pFlicBuffer;
  v2 = a1->gap1F4 / 639u;
  v3 = (a1->pBuf2 - pFlicBuffer) / v2;
  v4 = (a1->pBuf_198 - pFlicBuffer) / v2;
  v6[0].g = 0;
  v6[0].b = 0;
  v5 = v4;
  v6[0].r = 0xFF;
  VFX_DAC_write(0xFE, v6);
  v6[0].r = 0;
  v6[0].g = 0xFF;
  VFX_DAC_write(0xFF, v6);
  if ( v5 < v3 )
  {
    VFX_area_wipe(0, 450, v5, 479, 254);
    VFX_area_wipe(v5, 450, v3, 479, 255);
    VFX_area_wipe(v3, 450, 639, 479, 254);
  }
  else
  {
    VFX_area_wipe(0, 450, v3, 479, 255);
    VFX_area_wipe(v3, 450, v5, 479, 254);
    VFX_area_wipe(v5, 450, 639, 479, 255);
  }
  VFX_area_wipe(v5, 450, v5, 479, 254);
}

//----- (00029C6C) --------------------------------------------------------
void __fastcall sub_29C6C(P_Type2 a1, _WORD *a2)
{
  RGB *v3; // esi
  unsigned __int16 v4; // ax
  UBYTE *p_g; // esi
  unsigned __int8 v6; // dl
  unsigned __int16 i; // di
  int fontPalStart; // edx
  UBYTE r; // dh
  UBYTE b; // bh
  unsigned __int16 v11; // [esp+0h] [ebp-24h]
  unsigned __int16 v12; // [esp+4h] [ebp-20h]
  int v13; // [esp+8h] [ebp-1Ch]
  unsigned __int8 v14; // [esp+Ch] [ebp-18h]

  v3 = (RGB *)(a2 + 1);
  v11 = *a2;
  if ( *a2 )
  {
    v14 = 0;
    v13 = 0;
    do
    {
      LOBYTE(v4) = v3->r;
      p_g = &v3->g;
      v6 = v4 + v14;
      v4 = (unsigned __int8)v4;
      LOBYTE(v4) = *p_g;
      v3 = (RGB *)(p_g + 1);
      v12 = v4;
      v14 = v6;
      if ( !v3[0xFFFFFFFF].b )
      {
        v12 = 0x100;
      }
      for ( i = 0; i < v12; ++i )
      {
        fontPalStart = a1->fontPalStart;
        if ( i < fontPalStart || i >= a1->fontPalCount + fontPalStart )
        {
          r = v3->r;
          v3->g >>= 2;
          b = v3->b;
          v3->r = r >> 2;
          v3->b = b >> 2;
          VFX_DAC_write(v14++, v3++);
        }
      }
      ++v13;
    }
    while ( (unsigned __int16)v13 < v11 );
  }
}

//----- (00029D54) --------------------------------------------------------
int __fastcall sub_29D54(P_Type2 a1, unsigned __int8 *a2)
{
  int v3; // edx
  int v4; // edx
  UWORD width; // ax
  unsigned __int8 *v6; // ebp
  int result; // eax
  int i; // [esp+0h] [ebp-2Ch]
  char *s; // [esp+8h] [ebp-24h]
  RGB v11; // [esp+Ch] [ebp-20h] BYREF
  int v12; // [esp+10h] [ebp-1Ch]
  signed __int8 v13; // [esp+14h] [ebp-18h]

  s = (char *)a1->pBuf_1AC;
  for ( i = 0; a1->flicHeader.height > i; ++i )
  {
    v12 = 0;
    ++a2;
    if ( a1->flicHeader.width )
    {
      do
      {
        v13 = *a2;
        v6 = a2 + 1;
        if ( v13 >= 0 )
        {
          v3 = *v6;
          a2 = v6 + 1;
          memset(s, v3, v13);
        }
        else
        {
          v13 = -v13;
          v4 = v13;
          qmemcpy(s, v6, v13);
          a2 = &v6[v13];
        }
        LOWORD(v4) = v13;
        s += v13;
        width = a1->flicHeader.width;
        v12 += v4;
      }
      while ( (unsigned __int16)v12 < width );
    }
    s += 640 - a1->flicHeader.width;
  }
  v11.r = 0;
  v11.g = 0;
  v11.b = 0;
  Q_GSystem_PaletteGet_sub_2C2B0(&V_GSystem, 0, 0x100, 0);
  sub_2C670(&V_GSystem, 0, 0x100, &v11);
  a1->pane.x0 = 0;
  a1->pane.y0 = 0;
  a1->pane.x1 = a1->flicHeader.width - 1;
  a1->pane.y1 = a1->flicHeader.height - 1;
  VFX_pane_refresh(&a1->pane, a1->Unknown_1A0, a1->Unknown_1A4, a1->pane.x1 + a1->Unknown_1A0, a1->pane.y1 + a1->Unknown_1A4);
  for ( a1->Unknown_92C = 0; a1->Unknown_92C < 0x20; ++a1->Unknown_92C )
  {
    Q_GSystem_FadePalette_sub_2C5E4(&V_GSystem, a1->Unknown_92C);
  }
  ++a1->Unknown_92C;
  return result;
}
// 29DB1: variable 'v4' is possibly undefined

//----- (00029F58) --------------------------------------------------------
void __fastcall sub_29F58(P_Type2 a1, const void *pBuf)
{
  int Unknown_1A0; // edi
  int Unknown_1A4; // [esp-Ch] [ebp-1Ch]
  LONG v5; // [esp-8h] [ebp-18h]
  LONG v6; // [esp-4h] [ebp-14h]

  qmemcpy(a1->pBuf_1AC, pBuf, a1->flicHeader.height * a1->flicHeader.width);
  a1->pane.x1 = a1->flicHeader.width - 1;
  a1->pane.y1 = a1->flicHeader.height - 1;
  v6 = a1->pane.y1 + a1->Unknown_1A4;
  v5 = a1->pane.x1 + a1->Unknown_1A0;
  Unknown_1A4 = a1->Unknown_1A4;
  Unknown_1A0 = a1->Unknown_1A0;
  a1->pane.x0 = 0;
  a1->pane.y0 = 0;
  VFX_pane_refresh(&a1->pane, Unknown_1A0, Unknown_1A4, v5, v6);
}

//----- (00029FF8) --------------------------------------------------------
void __fastcall Q_NC_sub_29FF8(int a1, _WORD *a2)
{
  int v3; // esi
  unsigned __int8 *v4; // edi
  int v6; // eax
  unsigned __int8 v7; // ah
  signed __int8 v8; // al
  int v9; // eax
  int k; // kr04_4
  int v11; // edx
  char v12; // dl
  __int16 v13; // bx
  int v14; // edx
  int v15; // eax
  int v16; // ebx
  int j; // kr0C_4
  PANE *target; // [esp+0h] [ebp-18h]
  __int16 i; // [esp+4h] [ebp-14h]
  __int16 v20; // [esp+4h] [ebp-14h]
  int v21; // [esp+8h] [ebp-10h]
  __int16 v22; // [esp+Ch] [ebp-Ch]
  __int16 v23; // [esp+10h] [ebp-8h]
  __int16 v24; // [esp+14h] [ebp-4h]

  v3 = *(_DWORD *)(a1 + 0x1AC);
  v4 = (unsigned __int8 *)(a2 + 1);
  v22 = *a2;
  v23 = 0;
  target = (PANE *)(a1 + 0x1CC);
  while ( v22-- )
  {
    while ( 1 )
    {
      v24 = *(_WORD *)v4;
      v4 += 2;
      if ( v24 > 0 )
      {
        break;
      }
      if ( (v24 & 0x4000) == 0 )
      {
        printf("Bombing on Frame #%d.\n", *(_DWORD *)(a1 + 0x19C));
        Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x569);
      }
      v23 -= v24;
      v3 = *(unsigned __int16 *)(a1 + 0x120) * v23 + *(_DWORD *)(a1 + 0x1AC);
    }
    for ( i = 0; ; i = v21 + v20 )
    {
      v6 = v24--;
      if ( v6 <= 0 )
      {
        break;
      }
      v7 = *v4;
      v8 = v4[1];
      LOWORD(v21) = 2 * v8;
      v3 += *v4;
      v4 += 2;
      v20 = v7 + i;
      if ( (__int16)v21 <= 0 )
      {
        v13 = *(_WORD *)v4;
        v4 += 2;
        for ( j = 0; ; ++j )
        {
          v14 = v8++;
          if ( v14 >= 0 )
          {
            break;
          }
          *(_WORD *)(v3 + 2 * j) = v13;
        }
        LOWORD(v21) = -(__int16)v21;
      }
      else
      {
        v9 = v21;
        for ( k = 0; ; ++k )
        {
          v11 = (__int16)v9--;
          if ( v11 <= 0 )
          {
            break;
          }
          v12 = *v4++;
          *(_BYTE *)(v3 + k) = v12;
        }
      }
      *(_DWORD *)(a1 + 0x1D0) = v20;
      *(_DWORD *)(a1 + 0x1DC) = v23;
      *(_DWORD *)(a1 + 0x1D4) = v23;
      v15 = *(_DWORD *)(a1 + 0x1A4);
      v16 = *(_DWORD *)(a1 + 0x1DC);
      *(_DWORD *)(a1 + 0x1D8) = (__int16)v21 + v20;
      VFX_pane_refresh(
        target,
        *(_DWORD *)(a1 + 0x1D0) + *(_DWORD *)(a1 + 0x1A0),
        *(_DWORD *)(a1 + 0x1D4) + *(_DWORD *)(a1 + 0x1A4),
        *(_DWORD *)(a1 + 0x1D8) + *(_DWORD *)(a1 + 0x1A0),
        v16 + v15);
    }
    v3 = ++v23 * *(unsigned __int16 *)(a1 + 0x120) + *(_DWORD *)(a1 + 0x1AC);
  }
}
// 2A0FB: variable 'v21' is possibly undefined

//----- (0002A1DC) --------------------------------------------------------
void __fastcall Q_Type2_LoadSubtitleTxt_sub_2A1DC(P_Type2 a1, const char *fileName)
{
  FILE *fp_; // ebx
  int line_; // esi
  unsigned int textLength; // kr04_4
  char *pSubtitleText; // eax
  int v8; // esi
  int v9; // ecx
  void *v10; // eax
  int subtInstNum; // eax
  WORD subtitlesNum_; // dx
  FILE *fp____; // ecx
  WORD v14; // si
  FILE *fp_____; // esi
  WORD v16; // bx
  FILE *v17; // esi
  WORD v18; // cx
  void *v19; // eax
  FILE *fp__; // edi
  int v21; // ebx
  FILE *fp___; // [esp-10h] [ebp-304h]
  T_CFile cfilePal; // [esp+0h] [ebp-2F4h] BYREF
  char subtitleText[256]; // [esp+118h] [ebp-1DCh] BYREF
  char fontFileName[128]; // [esp+218h] [ebp-DCh] BYREF
  char bufc[52]; // [esp+298h] [ebp-5Ch] BYREF
  unsigned int bufi; // [esp+2CCh] [ebp-28h] BYREF
  FILE *fp; // [esp+2D0h] [ebp-24h]
  int line; // [esp+2D4h] [ebp-20h]
  P_Font pFont; // [esp+2D8h] [ebp-1Ch]
  __int16 textIndex; // [esp+2DCh] [ebp-18h]

  if ( fileName )
  {
    fp = Q_OpenTextFile_sub_1BB10(fileName, 0);
    if ( fp )
    {
      textIndex = 0;
      line = 0;
      pFont = &a1->font;
      while ( 1 )
      {
        fp_ = fp;
        fscanf(fp, "%s %d", bufc, &bufi);
        if ( bufi == -1u )
        {
          break;
        }
        line_ = ++line;
        if ( bufi < 2 )
        {
          if ( bufi )
          {
            // SUBFONT       1
            // FONTFILE      DATA\INTRO.FNT
            fscanf(fp_, "%s %s", bufc, fontFileName);
            if ( sub_2B360(pFont, fontFileName) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x5E3);
            }
            // FONTPALETTE   DATA\SUBFONT.PAL
            fscanf(fp, "%s %s", bufc, fontFileName);
            Q_CFile_Ctor_sub_1BB78(&cfilePal);
            if ( Q_CFile_Open_sub_1BBFC(&cfilePal, fontFileName, O_BINARY, 0) )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x5EB);
            }
            v19 = Q_CFile_Load_sub_1BF1C(&cfilePal, 0);
            a1->pFontPalData = v19;
            if ( !v19 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x5EE);
            }
            fp__ = fp;
            // FONTPALSTART  240
            fscanf(fp, "%s %d", bufc, &bufi);
            a1->fontPalStart = bufi;
            // FONTPALCOUNT  16
            fscanf(fp__, "%s %d", bufc, &bufi);
            a1->fontPalCount = bufi;
            // FONTBACKCOLOR 0
            fscanf(fp__, "%s %d", bufc, &bufi);
            v21 = line + 6;
            a1->font.backColor = bufi;
            line = v21;
            Q_CFile_Dtor_sub_1BBC8(&cfilePal);
          }
          else
          {
            // TITLEBOX      0
            // TITLERECT_X0  0
            fscanf(fp_, "%s %d", bufc, &bufi);
            a1->font.pane.x0 = bufi;
            // TITLERECT_Y0  379
            fscanf(fp_, "%s %d", bufc, &bufi);
            a1->font.pane.y0 = bufi;
            // TITLERECT_X1  639
            fscanf(fp_, "%s %d", bufc, &bufi);
            a1->font.pane.x1 = bufi;
            // TITLERECT_Y1  419
            fscanf(fp_, "%s %d", bufc, &bufi);
            line = line_ + 5;
            a1->font.pane.y1 = bufi;
          }
        }
        else if ( bufi <= 2 )
        {
          // SUBTITLE      2
          if ( a1->subtInstNum >= 128 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x5FF);
          }
          a1->subtInsts[a1->subtInstNum].code = 1;
          a1->subtInsts[a1->subtInstNum].param1 = textIndex;
          // TEXT          THIS_GALAXY_CONSISTS
          fscanf(fp, "%s %s", bufc, subtitleText);
          textLength = strlen(subtitleText) + 1;
          pSubtitleText = subtitleText;
          if ( subtitleText[0] )
          {
            do
            {
              if ( *pSubtitleText == '_' )
              {
                *pSubtitleText = ' ';
              }
            }
            while ( *++pSubtitleText );
          }
          v8 = sub_2B5BC(pFont, subtitleText);
          if ( v8 == 0xFFFFFFFF )
          {
            Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x613);
          }
          v9 = textIndex;
          a1->subtitleTexts[textIndex]._margins = v8;
          v10 = operator new[]((__int16)(textLength - 1) + 1);
          Q_RegisterDataInWinMgr_sub_2625C(v10, 1, "SUBTITLE");
          a1->subtitleTexts[v9].pText = (char *)v10;
          if ( !v10 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x61B);
          }
          strcpy(a1->subtitleTexts[textIndex].pText, subtitleText);
          // FRAME_START   55
          fscanf(fp, "%s %d", bufc, &bufi);
          bufi -= 32;
          if ( (int)bufi <= 0 )
          {
            Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x622);
          }
          a1->subtInsts[a1->subtInstNum].frameNumber = bufi;
          fp___ = fp;
          ++a1->subtInstNum;
          // FRAME_END     60
          fscanf(fp___, "%s %d", bufc, &bufi);
          subtInstNum = a1->subtInstNum;
          ++textIndex;
          a1->subtInsts[subtInstNum].frameNumber = bufi;
          a1->subtInsts[a1->subtInstNum].code = 2;
          subtitlesNum_ = a1->subtInstNum;
          line += 4;
          a1->subtInstNum = subtitlesNum_ + 1;
        }
        else if ( bufi < 11 )
        {
          if ( bufi != 3 )
          {
LABEL_10:
            sprintf("Thank you for playing Ascendancy.", "\n  ** Bad Subtitle Data: %s, %d (line %d)\n\n", bufc, bufi, line);
            Q_debugbreak_exit_sub_2624C();
          }
          // DELAY         3
          if ( a1->subtInstNum >= 128 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x635);
          }
          fp____ = fp;
          // FRAMENUMBER   474
          fscanf(fp, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].frameNumber = bufi;
          a1->subtInsts[a1->subtInstNum].code = 3;
          // FRAME_RATE    10
          fscanf(fp____, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].param1 = bufi;
          v14 = a1->subtInstNum;
          line += 3;
          a1->subtInstNum = v14 + 1;
        }
        else if ( bufi <= 11 )
        {
          // FADEMUSIC     11
          if ( a1->subtInstNum >= 0x80 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x703);
          }
          a1->subtInsts[a1->subtInstNum].code = 11;
          v17 = fp;
          // CHANNEL       0
          fscanf(fp, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].param1 = bufi;
          // VOLUME        80
          fscanf(v17, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].param2 = bufi;
          // FRAMENUMBER   971 
          fscanf(v17, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].frameNumber = bufi;
          v18 = a1->subtInstNum;
          line += 4;
          a1->subtInstNum = v18 + 1;
        }
        else
        {
          if ( bufi != 16 )
          {
            goto LABEL_10;
          }
          // DIGITALMUSIC  16
          if ( a1->subtInstNum >= 128 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x68A);
          }
          fp_____ = fp;
          // TUNEID        6
          fscanf(fp, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].param1 = bufi;
          // COMMAND       1
          fscanf(fp_____, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].code = (bufi != 1) + 30;
          // FRAMENUMBER   20
          fscanf(fp_____, "%s %d", bufc, &bufi);
          a1->subtInsts[a1->subtInstNum].frameNumber = bufi;
          v16 = a1->subtInstNum + 1;
          line += 4;
          a1->subtInstNum = v16;
        }
      }
      fclose(fp_);
      qsort(a1->subtInsts, a1->subtInstNum, 0xCu, (int (__fastcall *)(const void *, const void *))Q_CompareSubtitleInstructions_sub_28C4C);
    }
  }
}
// 2A1DC: using guessed type char bufc[52];

//----- (0002AA88) --------------------------------------------------------
void __fastcall sub_2AA88(P_Type2 a1)
{
  int frameNumber; // ebx
  int dword19C; // ecx
  T_SubtitleText *v4; // edi
  int param1; // edx
  HTIMER timerHandle; // eax
  WORD code; // ax
  T_SubtitleText *subtitleTexts; // [esp+0h] [ebp-8h]
  T_Font *p_font; // [esp+4h] [ebp-4h]

  subtitleTexts = a1->subtitleTexts;
  p_font = &a1->font;
  while ( 1 )
  {
    frameNumber = a1->subtInsts[(__int16)a1->Unknown_804].frameNumber;
    dword19C = a1->dword19C;
    if ( frameNumber != dword19C )
    {
      break;
    }
    code = a1->subtInsts[(__int16)a1->Unknown_804].code;
    if ( (unsigned __int16)code < 3u )
    {
      if ( !code )
      {
        goto LABEL_23;
      }
      if ( (unsigned __int16)code <= 1u )
      {
        if ( !a1->Unknown_942 )
        {
          v4 = &subtitleTexts[a1->subtInsts[(__int16)a1->Unknown_804].param1];
          sub_2C1E0(&V_GSystem, a1->fontPalStart, a1->fontPalCount, (unsigned int)a1->pFontPalData);
          sub_2C670(&V_GSystem, a1->fontPalStart, a1->fontPalCount, 0);
          Q_Font_DrawFormattedText_sub_2B8A8(p_font, SLOWORD(v4->_margins), SHIWORD(v4->_margins), v4->pText, 0x80u, 0xFFFF, 0xFFFF, 0);
          a1->Unknown_92A = 1;
        }
        goto LABEL_6;
      }
      if ( a1->Unknown_942 )
      {
        goto LABEL_6;
      }
      a1->Unknown_92A = 2;
      ++a1->Unknown_804;
    }
    else if ( (unsigned __int16)code <= 3u )
    {
      param1 = a1->subtInsts[(__int16)a1->Unknown_804].param1;
      timerHandle = a1->timerHandle;
      a1->timerFrequency = param1;
      if ( timerHandle == 0xFFFFFFFF )
      {
        goto LABEL_6;
      }
      if ( param1 )
      {
        AIL_set_timer_frequency(timerHandle, param1);
      }
      else
      {
        AIL_stop_timer(timerHandle);
      }
      ++a1->Unknown_804;
    }
    else if ( (unsigned __int16)code < 0x1Eu )
    {
      if ( code != 0xB )
      {
        goto LABEL_23;
      }
      if ( V_SSystem.DIG_installed == 0xFFFFFFFF )
      {
        Q_SSystem_SetVolume_sub_4FF4C(&V_SSystem, a1->subtInsts[(__int16)a1->Unknown_804].param2);
        ++a1->Unknown_804;
      }
      else
      {
LABEL_6:
        ++a1->Unknown_804;
      }
    }
    else if ( (unsigned __int16)code <= 0x1Eu )
    {
      sub_4F8CC(&V_SSystem, a1->subtInsts[(__int16)a1->Unknown_804].param1, dword19C ^ frameNumber);
      ++a1->Unknown_804;
    }
    else if ( code == 0x1F )
    {
      Q_SSystem_StopSample_sub_4FA1C(&V_SSystem);
      ++a1->Unknown_804;
    }
    else
    {
LABEL_23:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x80F);
      ++a1->Unknown_804;
    }
  }
}

//----- (0002AC84) --------------------------------------------------------
int __fastcall Q_Type2_SetTimer_sub_2AC84(P_Type2 a1, ULONG hertz)
{
  HTIMER timerHandle; // edx
  HTIMER newTimer; // eax

  a1->timerFrequency = hertz;
  timerHandle = a1->timerHandle;
  if ( timerHandle == 0xFFFFFFFF )
  {
    newTimer = AIL_register_timer(Q_TimerCallback_sub_28C40);
    a1->timerHandle = newTimer;
    if ( newTimer == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x823);
    }
    AIL_set_timer_frequency(a1->timerHandle, hertz);
    AIL_start_timer(a1->timerHandle);
  }
  else
  {
    AIL_set_timer_frequency(timerHandle, hertz);
  }
  return (a1->timerHandle == 0xFFFFFFFF) - 1;
}

//----- (0002AD08) --------------------------------------------------------
void __fastcall __spoils<> sub_2AD08(P_Type2 a1)
{
  if ( a1->timerHandle != 0xFFFFFFFF )
  {
    AIL_stop_timer(a1->timerHandle);
    AIL_release_timer_handle(a1->timerHandle);
    a1->timerHandle = 0xFFFFFFFF;
  }
}

//----- (0002AD40) --------------------------------------------------------
__int16 __cdecl sub_2AD40(unsigned __int16 *a1, int a2, LONG y)
{
  int v4; // ecx
  __int16 *v5; // esi
  __int16 result; // ax
  int v7; // edx
  int v8; // eax
  _BYTE *v9; // esi
  LONG v10; // edx
  char v11; // al
  __int16 *v12; // esi
  int v13; // ecx
  __int16 v14; // ax
  int v15; // edx
  unsigned int v16; // ecx
  __int16 v17; // ax
  UBYTE *v18; // edi
  LONG v19; // edx
  ULONG i; // ecx
  unsigned int j; // ecx
  int v22; // edx
  unsigned int v23; // ecx
  UBYTE *v24; // edi
  ULONG v25; // ecx
  LONG v26; // edx
  int v27; // [esp-2Eh] [ebp-42h]
  int v28; // [esp-2Eh] [ebp-42h]
  LONG v29; // [esp-2Ah] [ebp-3Eh]
  int v30; // [esp-26h] [ebp-3Ah]
  int v31; // [esp-26h] [ebp-3Ah]
  LONG v32; // [esp-22h] [ebp-36h]
  LONG v33; // [esp-22h] [ebp-36h]
  int v34; // [esp-1Eh] [ebp-32h]
  __int16 v35; // [esp-1Eh] [ebp-32h]
  __int16 v36; // [esp-1Ah] [ebp-2Eh]
  ULONG v37; // [esp-1Ah] [ebp-2Eh]
  int v38; // [esp-16h] [ebp-2Ah]
  unsigned int v39; // [esp-16h] [ebp-2Ah]
  __int16 v40; // [esp-12h] [ebp-26h]
  int v41; // [esp-10h] [ebp-24h]
  ULONG v42; // [esp+4h] [ebp-10h] BYREF
  UBYTE *v43; // [esp+8h] [ebp-Ch] BYREF
  ULONG nbytes; // [esp+Ch] [ebp-8h] BYREF
  UBYTE *addr; // [esp+10h] [ebp-4h] BYREF

  v4 = *a1;
  v5 = (__int16 *)(a1 + 1);
  do
  {
    while ( 1 )
    {
      result = *v5++;
      if ( result > 0 )
      {
        break;
      }
      if ( (result & 0x4000) != 0 )
      {
        LOWORD(y) = y - result;
      }
    }
    v7 = a2;
    v41 = v4;
    do
    {
      v40 = result;
      v8 = *(unsigned __int8 *)v5;
      v9 = (char *)v5 + 1;
      v10 = v8 + v7;
      v11 = *v9;
      v12 = (__int16 *)(v9 + 1);
      if ( (v11 & 0x80) != 0 )
      {
        v13 = -v11;
        v14 = *v12;
        v5 = v12 + 1;
        v36 = v14;
        v34 = 2 * v13;
        // Calculates the address of the point (x,y) on the physical
        // display screen, and stores this address to the pointer
        // variable *addr.  In addition, the number of bytes
        // until the end of the screen line (or the end of the EVGA
        // bank, whichever comes first) is written to *nbytes.  For
        // EVGA drivers, including VESA, this function performs a
        // bank-set call to prepare for direct pixel-write access to
        // the specified line.  Either the addr or nbytes parameter
        // may be NULL, to suppress storage of their respective
        // values.
        VFX_line_address(v10, y, &addr, &nbytes);
        v15 = v27;
        v16 = v34;
        v17 = v36;
        v18 = addr;
        if ( v34 > (int)nbytes )
        {
          v37 = v34 - nbytes;
          v19 = nbytes + v27;
          for ( i = nbytes >> 1; i; --i )
          {
            *(_WORD *)v18 = v17;
            v18 += 2;
          }
          v35 = v17;
          VFX_line_address(v19, v29, &addr, &nbytes);
          v15 = v28;
          v17 = v35;
          v16 = v37;
          v18 = addr;
        }
        v7 = v16 + v15;
        for ( j = v16 >> 1; j; --j )
        {
          *(_WORD *)v18 = v17;
          v18 += 2;
        }
      }
      else
      {
        v38 = 2 * v11;
        VFX_line_address(v10, y, &v43, &v42);
        v22 = v30;
        y = v32;
        v23 = v38;
        v24 = v43;
        if ( v38 > (int)v42 )
        {
          v39 = v38 - v42;
          v25 = v42;
          v26 = v42 + v30;
          qmemcpy(v43, v12, v42);
          v12 = (__int16 *)((char *)v12 + v25);
          VFX_line_address(v26, v32, &v43, &v42);
          v22 = v31;
          y = v33;
          v23 = v39;
          v24 = v43;
        }
        v7 = v23 + v22;
        qmemcpy(v24, v12, v23);
        v5 = (__int16 *)((char *)v12 + v23);
      }
      result = v40 - 1;
    }
    while ( v40 != 1 );
    LOWORD(y) = y + 1;
    v4 = v41 - 1;
  }
  while ( v41 != 1 );
  return result;
}
// 2ADAB: variable 'v27' is possibly undefined
// 2ADD3: variable 'v29' is possibly undefined
// 2ADD9: variable 'v28' is possibly undefined
// 2AE00: variable 'v30' is possibly undefined
// 2AE01: variable 'v32' is possibly undefined
// 2AE29: variable 'v31' is possibly undefined
// 2AE2A: variable 'v33' is possibly undefined

//----- (0002AE48) --------------------------------------------------------
int __cdecl Q_NC_sub_2AE48(unsigned __int16 a1)
{
  while ( MEMORY[0x46C] <= a1 )
  {
    ;
  }
  return MEMORY[0x46C];
}
// 2AE48: could not find valid save-restore pair for edi

//----- (0002AE69) --------------------------------------------------------
__int16 Q_NC_sub_2AE69()
{
  __int16 result; // ax

  result = 0x1510;
  __asm { int     23h; DOS - CONTROL "C" EXIT ADDRESS }
  return result;
}

//----- (0002AE80) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd01FLIC_Ctor_sub_2AE80(P_Wnd01FLIC self)
{
  Q_WndA2_Ctor_sub_2C830(&self->a2);
  Q_Type2_Init_sub_28C74(&self->t2);
  self->a2.pProcs = &Wnd01FLIC_Procs;
  self->t2.loopCount = 1;
  self->t2.Unknown_94C = 0;
}

//----- (0002AEB0) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd01FLIC_Dtor_sub_2AEB0(P_Wnd01FLIC self, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(self, &C_Wnd01FLIC);
    operator delete[](v3);
  }
  else
  {
    self->a2.pProcs = &Wnd01FLIC_Procs;
    Q_Type2_Finalize_sub_28DA4(&self->t2);
    Q_WndA2_Dtor_sub_2C848(&self->a2, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002AF04) --------------------------------------------------------
UBYTE *__fastcall Q_Wnd01FLIC_LoadFlicHeader_sub_2AF04(P_Wnd01FLIC a1, const char *flicName)
{
  int v2; // ecx

  v2 = Q_Type2_sub_28EB4(&a1->t2, flicName, WinMgr.window->buffer, 0xFFFFFFFF, 0xFFFFFFFF);
  if ( !v2 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flicwin.cpp", 0x4E);
  }
  return (UBYTE *)v2;
}

//----- (0002AF3C) --------------------------------------------------------
unsigned int __fastcall Q_Wnd01FLIC_sub_2AF3C(P_Wnd01FLIC pWnd)
{
  signed int size; // esi
  int preloadMegs; // ebx
  unsigned int v5; // ebx

  size = pWnd->t2.bufferMegs << 0x14;
  if ( size <= WinMgr.cache.size )
  {
    preloadMegs = pWnd->t2.preloadMegs;
    if ( preloadMegs == 0xFFFFFFFF )
    {
      size = WinMgr.cache.size;
      v5 = WinMgr.cache.size;
    }
    else
    {
      v5 = preloadMegs << 0x14;
    }
    Q_Cache_Free_sub_1B4D0(&WinMgr.cache);
    return Q_Type2_sub_29038(&pWnd->t2, size, v5, pWnd->t2.maxFrame << 0xA, pWnd->t2.readSizeKB << 0xA, WinMgr.cache.pShapeCache);
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flicwin.cpp", 0x67);
    return 0;
  }
}

//----- (0002AFF0) --------------------------------------------------------
int __fastcall Q_Wnd01FLIC_Proc3_sub_2AFF0(P_Wnd01FLIC pWnd, UWORD message, int param1, int param2)
{
  WORD v6; // dx
  WORD loopCount; // bx
  int result; // eax
  __int16 i; // cx
  RGB v10[256]; // [esp+0h] [ebp-31Ch] BYREF
  P_Type2 pt2; // [esp+300h] [ebp-1Ch]
  int v12; // [esp+304h] [ebp-18h]
  int v13; // [esp+308h] [ebp-14h]
  char newVolume; // [esp+30Ch] [ebp-10h]

  LOWORD(v13) = message;
  pt2 = &pWnd->t2;
  switch ( message )
  {
    case 1u:
      v12 = 0;
      pWnd->t2.dword19C = 0xFFFFFFFF;
      pWnd->t2.Unknown_94C = 0;
      pWnd->t2.Unknown_94E = 0;
      pWnd->t2.Unknown_952 = 0;
      MOUSE_hide();
      V_FadeEffect = 0;
      if ( Q_Wnd01FLIC_sub_2AF3C(pWnd) )
      {
        Q_SSystem_StopSample_sub_4FA1C(&V_SSystem);
        Q_WndA2_Proc3_sub_2F424(&pWnd->a2, v13, param1, param2);
        Q_WinMgr_sub_56400(&WinMgr, pWnd->a2.index, 0xA, 0, 0, 0);
        Q_Type2_SetTimer_sub_2AC84(pt2, 18u);
      }
      else
      {
        Q_Cache_Lock_sub_1ACE8(&WinMgr.cache);
        MOUSE_show();
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, pWnd->a2.sendMessage, pWnd->a2.sendParam1, pWnd->a2.sendParam2);
      }
      result = v12;
      break;
    case 2u:
      sub_2AD08(&pWnd->t2);
      newVolume = 129;
      for ( i = 0; i < 64; ++i )
      {
        Q_GSystem_AdjustPalette_sub_2BD04(&V_GSystem, i, 0);
        Q_SSystem_SetVolume_sub_4FF4C(&V_SSystem, newVolume);
        newVolume -= 2;
      }
      Q_SSystem_StopSample_sub_4FA1C(&V_SSystem);
      Q_Cache_Lock_sub_1ACE8(&WinMgr.cache);
      memset(v10, 0, sizeof(v10));
      Q_GSystem_PaletteSet_sub_2C224(&V_GSystem, 0, 0x100, v10);
      VFX_area_wipe(0, 0, 639, 479, 0);
      Q_LoadPal_sub_2C158(&V_GSystem, "DATA\\game.pal", 0, 0x100u);
      Q_GSystem_PaletteSet_sub_2C224(&V_GSystem, 0, 0x100, v10);
      V_FadeEffect = 0xFFFFFFFF;
      V_FadeIndex = 0;
      MOUSE_show();
      Q_WndA2_Proc3_sub_2F424(&pWnd->a2, v13, param1, param2);
      result = v12;
      break;
    case 3u:
    case 4u:
    case 5u:
      goto LABEL_14;
    case 0xAu:
      if ( !Q_Type2_sub_296B4(&pWnd->t2) )
      {
        v6 = pWnd->t2.Unknown_94C + 1;
        loopCount = pWnd->t2.loopCount;
        pWnd->t2.Unknown_94C = v6;
        if ( v6 < loopCount )
        {
          Q_Wnd01FLIC_sub_2AF3C(pWnd);
        }
      }
      if ( pWnd->t2.Unknown_94C >= pWnd->t2.loopCount )
      {
LABEL_14:
        Q_WinMgr_sub_564C0(&WinMgr, pWnd->a2.index, 0xA);
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, pWnd->a2.sendMessage, pWnd->a2.sendParam1, pWnd->a2.sendParam2);
      }
      v12 = 0xFFFFFFFF;
      result = 0xFFFFFFFF;
      break;
    default:
      result = Q_WndA2_Proc3_sub_2F424(&pWnd->a2, v13, param1, param2);
      break;
  }
  return result;
}
// 132B60: using guessed type int V_FadeEffect;
// 132B64: using guessed type int V_FadeIndex;

//----- (0002B2C0) --------------------------------------------------------
void __fastcall __spoils<> Q_Font_Init_sub_2B2C0(P_Font a1)
{
  a1->pVfxFont = 0;
  a1->pane.window = 0;
  sub_2B2FC(a1, 0);
}

//----- (0002B2E0) --------------------------------------------------------
void __fastcall __spoils<> sub_2B2E0(P_Font a1)
{
  if ( a1->pVfxFont )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pVfxFont);
  }
  operator delete(a1->pVfxFont);
}
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002B2FC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_2B2FC(P_Font pFont, const char *aFName)
{
  void *v4; // eax
  int i; // eax

  pFont->pane.window = (WINDOW *)&V_GSystem;
  if ( aFName )
  {
    return sub_2B360(pFont, aFName);
  }
  v4 = operator new[](0x100u);
  Q_RegisterDataInWinMgr_sub_2625C(v4, 1, "FONT TRANSLATE");
  pFont->pFontTranslate = (BYTE *)v4;
  if ( !v4 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x5D);
  }
  for ( i = 0; i < 256; ++i )
  {
    pFont->pFontTranslate[i] = i;
  }
  return TRUE;
}

//----- (0002B360) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_2B360(P_Font pFont, const char *aFName)
{
  VFX_FONT *v4; // eax
  T_CFile v6; // [esp+0h] [ebp-124h] BYREF

  if ( !aFName )
  {
    return TRUE;
  }
  Q_CFile_Ctor_sub_1BB78(&v6);
  if ( !Q_CFile_Open_sub_1BBFC(&v6, aFName, O_BINARY, 0) )
  {
    if ( pFont->pVfxFont )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(pFont->pVfxFont);
    }
    operator delete(pFont->pVfxFont);
    v4 = (VFX_FONT *)Q_CFile_Load_sub_1BF1C(&v6, 0);
    pFont->pVfxFont = v4;
    if ( v4 )
    {
      Q_CFile_Dtor_sub_1BBC8(&v6);
      return TRUE;
    }
  }
  Q_CFile_Dtor_sub_1BBC8(&v6);
  return FALSE;
}
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002B3E0) --------------------------------------------------------
void __fastcall Q_Font_SetPaneRect_sub_2B3E0(P_Font pFont, int x1, int y1, int x2, int y2)
{
  pFont->pane.x0 = x1;
  pFont->pane.y0 = y1;
  pFont->pane.x1 = x2;
  pFont->pane.y1 = y2;
}

//----- (0002B3F4) --------------------------------------------------------
// Example:
// "Owned by |%d|%s"
// |XXX| -> color fo %s
int __fastcall Q_Font_ParseTextColor_sub_2B3F4(P_Font pFont, char *input, char *output, int update)
{
  char *pcurr; // esi
  char nextchar; // al
  int processedLength; // ecx
  const char *start; // ebp
  _BYTE *v10; // esi
  char v11; // al
  BYTE v13; // bl
  char v14[4]; // [esp+0h] [ebp-14h] BYREF
  P_Font pFont_; // [esp+4h] [ebp-10h]

  pFont_ = pFont;
  pcurr = input;
  // Find the first '|'
  while ( *pcurr != '|' )
  {
    if ( *pcurr )
    {
      nextchar = *++pcurr;
      if ( *pcurr == '|' )
      {
        break;
      }
      ++pcurr;
      if ( nextchar )
      {
        continue;
      }
    }
    pcurr = 0;
    break;
  }
  processedLength = 0;
  if ( pcurr )
  {
    if ( pcurr != input )
    {
      strncpy(output, input, pcurr - input);
      output[pcurr - input] = 0;
      return pcurr - input;
    }
    start = pcurr + 1;
    v10 = pcurr + 1;
    *output = 0;
    // Find the next '|'
    while ( *v10 != '|' )
    {
      if ( *v10 )
      {
        v11 = *++v10;
        if ( *v10 == '|' )
        {
          break;
        }
        ++v10;
        if ( v11 )
        {
          continue;
        }
      }
      v10 = 0;
      break;
    }
    if ( v10 )
    {
      processedLength = v10 - start + 2;
      if ( v10 == start )
      {
        strcpy(output, "|");
        return v10 - start + 2;
      }
      if ( update == TRUE )
      {
        strncpy(v14, start, 3u);
        v14[3] = 0;
        v13 = atoi(v14);
        pFont_->pFontTranslate[0xF3] = v13;
        return v10 - start + 2;
      }
    }
    else
    {
      return 1;
    }
  }
  else
  {
    strcpy(output, input);
  }
  return processedLength;
}

//----- (0002B4F4) --------------------------------------------------------
int __fastcall Q_Font_GetTextWidth_sub_2B4F4(P_Font pFont, char *text)
{
  int v3; // edi
  int v4; // kr04_4
  int v6; // [esp+0h] [ebp-20h]
  char *parsedText; // [esp+4h] [ebp-1Ch]
  char *text_; // [esp+8h] [ebp-18h]

  if ( !text )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0xD7);
  }
  if ( !pFont->pVfxFont )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0xD8);
  }
  text_ = text;
  v3 = 0;
  parsedText = strdup(text);
  do
  {
    v6 = Q_Font_ParseTextColor_sub_2B3F4(pFont, text_, parsedText, 0);
    v4 = 0;
    if ( *parsedText )
    {
      do
      {
        v3 += VFX_character_width(pFont->pVfxFont, (unsigned __int8)parsedText[v4++]);
      }
      while ( parsedText[v4] );
    }
    text_ += v6;
  }
  while ( v6 > 0 );
  free(parsedText);
  return v3;
}

//----- (0002B594) --------------------------------------------------------
LONG __fastcall Q_Font_GetHeight_sub_2B594(P_Font pFont)
{
  if ( !pFont->pVfxFont )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x104);
  }
  return VFX_font_height(pFont->pVfxFont);
}

//----- (0002B5BC) --------------------------------------------------------
int __fastcall sub_2B5BC(P_Font pFont, char *text)
{
  LONG fontHeight; // esi
  int textWidth; // edx
  int v5; // ecx
  int v6; // ebx

  fontHeight = Q_Font_GetHeight_sub_2B594(pFont);
  textWidth = Q_Font_GetTextWidth_sub_2B4F4(pFont, text);
  v5 = pFont->pane.y1 - pFont->pane.y0 - fontHeight;
  v6 = pFont->pane.x1 - pFont->pane.x0 - textWidth;
  if ( v5 >= 0 && v6 >= 0 )
  {
    return (v6 >> 1) + (v5 >> 1 << 0x10);
  }
  else
  {
    return 0xFFFFFFFF;
  }
}

//----- (0002B610) --------------------------------------------------------
void __fastcall Q_Font_RenderText_sub_2B610(P_Font pFont, LONG xOffset, LONG yOffset, char *text, char flags, __int16 a6, __int16 a7)
{
  __int16 v8; // cx
  LONG fontHeight; // ebx
  LONG textWidth; // edx
  LONG x1; // edi
  LONG v12; // eax
  LONG x0; // edx
  char *parsedText; // esi
  char *text__; // edi
  int TextWidth_sub_2B4F4; // eax
  PANE pane; // [esp+0h] [ebp-38h] BYREF
  int parsedLen; // [esp+14h] [ebp-24h]
  LONG v19; // [esp+18h] [ebp-20h]
  char *text_; // [esp+1Ch] [ebp-1Ch]
  PANE *p_pane; // [esp+20h] [ebp-18h]
  LONG y; // [esp+24h] [ebp-14h]
  LONG x; // [esp+28h] [ebp-10h]

  v19 = xOffset;
  y = yOffset;
  text_ = text;
  v8 = a6;
  if ( !text_ )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x13B);
  }
  if ( !pFont->pVfxFont )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x13C);
  }
  if ( a7 == 0xFFFFFFFF )
  {
    a7 = pFont->backColor;
  }
  if ( a6 == 0xFFFFFFFF )
  {
    v8 = 0xF3;
  }
  if ( v8 != 0xFFFFFFFE )
  {
    pFont->pFontTranslate[0xF3] = v8;
  }
  fontHeight = Q_Font_GetHeight_sub_2B594(pFont);
  pane.window = pFont->pane.window;
  pane.x0 = pFont->pane.x0;
  pane.y0 = pFont->pane.y0;
  pane.x0 += v19;
  pane.y0 += y;
  textWidth = Q_Font_GetTextWidth_sub_2B4F4(pFont, text_) + pane.x0;
  pane.x1 = textWidth;
  pane.y1 = fontHeight + pane.y0;
  x1 = pFont->pane.x1;
  if ( pane.x0 <= x1 )
  {
    v12 = textWidth;
    x0 = pFont->pane.x0;
    if ( v12 >= x0 && pane.y0 <= pFont->pane.y1 && pane.y1 >= pFont->pane.y0 )
    {
      if ( x0 <= pane.x0 )
      {
        if ( x1 < pane.x1 )
        {
          pane.x1 = pFont->pane.x1;
        }
      }
      else
      {
        pane.x0 = pFont->pane.x0;
      }
      if ( pane.y0 >= pFont->pane.y0 )
      {
        if ( pane.y1 > pFont->pane.y1 )
        {
          pane.y1 = pFont->pane.y1;
        }
      }
      else
      {
        pane.y0 = pFont->pane.y0;
      }
      if ( a7 != 0xFF )
      {
        VFX_pane_wipe(&pane, a7);
      }
      parsedText = strdup(text_);
      x = v19;
      text__ = text_;
      p_pane = &pFont->pane;
      do
      {
        parsedLen = Q_Font_ParseTextColor_sub_2B3F4(pFont, text__, parsedText, TRUE);
        if ( *parsedText )
        {
          VFX_string_draw(p_pane, x, y, pFont->pVfxFont, parsedText, (UBYTE *)pFont->pFontTranslate);
        }
        TextWidth_sub_2B4F4 = Q_Font_GetTextWidth_sub_2B4F4(pFont, parsedText);
        text__ += parsedLen;
        x += TextWidth_sub_2B4F4;
      }
      while ( parsedLen > 0 );
      free(parsedText);
      if ( (flags & 0xC0) == 0 )
      {
        Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
      }
    }
  }
}

//----- (0002B804) --------------------------------------------------------
void __fastcall Q_NC_sub_2B804(LONG *a1, int a2)
{
  LONG v3; // ecx

  Q_WinMgr_WipeAndAddDirtyArea_sub_55214(&WinMgr, a1[3], a1[4], a1[5], a1[6]);
  v3 = a1[6] - a2;
  a1[4] -= a2;
  a1[6] = v3;
}

//----- (0002B838) --------------------------------------------------------
LONG __fastcall Q_NC_sub_2B838(int a1, __int16 a2, __int16 a3)
{
  PANE *v4; // ebp
  int i; // kr04_4
  LONG result; // eax

  v4 = (PANE *)(a1 + 8);
  for ( i = 0; ; ++i )
  {
    result = a3 + a2;
    if ( a2 + i >= result )
    {
      break;
    }
    VFX_character_draw(v4, 1, 1, *(void **)a1, a2 + i, 0);
    VFX_pane_refresh(v4, *(_DWORD *)(a1 + 0xC), *(_DWORD *)(a1 + 0x10), *(_DWORD *)(a1 + 0x14), *(_DWORD *)(a1 + 0x18));
    getch();
  }
  return result;
}

//----- (0002B8A8) --------------------------------------------------------
// Renders formatted text within a specified area, with word wrapping and alignment options
// Returns total height of the rendered text in pixels
int __fastcall Q_Font_DrawFormattedText_sub_2B8A8(
        P_Font pFont,
        int xOffset,
        int yOffset,
        const char *text,
        UWORD flags,
        WORD bgColor,
        WORD wipeColor,
        int maxWidth)
{
  WORD actualWipeColor; // ax
  char *currentLineStart; // ebp
  char *currentPos; // ebx
  char *lastSpacePos; // ecx
  unsigned int endOfText; // edi
  int lineWidth; // eax
  int verticalPos; // eax
  int heightAdjust; // edx
  __int64 v17; // rax
  char *lineText; // ebp
  int lineWidth_; // edx
  int horizontalPos; // edx
  int totalHeight; // [esp+0h] [ebp-40h]
  int currentY; // [esp+4h] [ebp-3Ch]
  char *textCopy; // [esp+Ch] [ebp-34h]
  int lineNum; // [esp+14h] [ebp-2Ch]
  int lineHeight; // [esp+18h] [ebp-28h]
  int lineCount; // [esp+20h] [ebp-20h]
  char tempChar; // [esp+30h] [ebp-10h]

  // Handle pane wiping (background clearing) if specified in flags
  if ( (flags & 0x80) != 0 && wipeColor != 0xFF )
  {
    actualWipeColor = wipeColor;
    if ( wipeColor == -1u )
    {
      actualWipeColor = pFont->backColor;
    }
    VFX_pane_wipe(&pFont->pane, actualWipeColor);
  }
  // Set default background color if none specified
  if ( bgColor == 0xFFFFFFFF )
  {
    LOBYTE(bgColor) = 0xF3;
  }
  pFont->pFontTranslate[0xF3] = bgColor;
  // Calculate maximum width if not specified
  if ( maxWidth < 1 )
  {
    maxWidth = pFont->pane.x1 - pFont->pane.x0;        // Use pane width
  }
  // Create working copy of the text
  textCopy = strdup(text);
  currentLineStart = textCopy;
  currentPos = textCopy;
  lastSpacePos = textCopy;                             // Track last space for word wrapping
  lineCount = 1;                                       // Start with at least one line
  // Word wrapping processing loop
  endOfText = 0;
  do
  {
    if ( !*currentPos )                                // Check for end of string
    {
      endOfText = 0xFFFFFFFF;
    }
    // Temporarily null-terminate to measure line width
    tempChar = *currentPos;
    *currentPos = 0;
    lineWidth = Q_Font_GetTextWidth_sub_2B4F4(pFont, currentLineStart);
    *currentPos = tempChar;
    if ( tempChar == '\n' )                            // Handle explicit newline
    {
      *currentPos = 0;                                 // Terminate current line
      currentLineStart = ++currentPos;                 // Start new line
      ++lineCount;
    }
    else if ( lineWidth <= maxWidth || lastSpacePos <= currentLineStart )
    {
      // Handle word wrapping
      if ( *currentPos == ' ' )
      {
        lastSpacePos = currentPos;                     // Remember last space position
      }
      ++currentPos;
    }
    else
    {
      // Wrap at last space position
      currentLineStart = lastSpacePos + 1;
      *lastSpacePos = 0;                               // Terminate line at space
      currentPos = lastSpacePos + 1;
      ++lineCount;
    }
  }
  while ( !endOfText );
  // Calculate line height and total text height
  lineHeight = Q_Font_GetHeight_sub_2B594(pFont) + 2;  // Font height + padding
  totalHeight = lineCount * lineHeight;
  // Calculate vertical position based on flags
  if ( (flags & 0x10) != 0 )                           // Top alignment
  {
    verticalPos = yOffset - totalHeight;
  }
  else
  {
    heightAdjust = totalHeight + 1;
    if ( (flags & 1) != 0 )                            // Middle vertical alignment
    {
      v17 = pFont->pane.y1 - pFont->pane.y0 - heightAdjust;
      verticalPos = ((int)v17 - HIDWORD(v17)) >> 1;
    }
    else
    {
      if ( (flags & 4) != 0 )
      {
        currentY = yOffset - heightAdjust / 2;         // Center relative to yOffset
        goto RENDER_LINES;
      }
      verticalPos = yOffset;                           // Default to top at yOffset
    }
  }
  currentY = verticalPos;
RENDER_LINES:
  // Render each line of text
  lineText = textCopy;
  for ( lineNum = 0; lineNum < lineCount; ++lineNum )
  {
    lineWidth_ = Q_Font_GetTextWidth_sub_2B4F4(pFont, lineText);
    // Calculate horizontal position based on flags
    if ( (flags & 0x20) != 0 )                         // Right alignment
    {
      horizontalPos = xOffset - lineWidth_;
    }
    else if ( (flags & 2) != 0 )                       // Center alignment
    {
      horizontalPos = (pFont->pane.x1 - pFont->pane.x0 - lineWidth_) / 2;
    }
    else if ( (flags & 8) != 0 )                       // Center relative to xOffset
    {
      horizontalPos = xOffset - lineWidth_ / 2;
    }
    else
    {
      horizontalPos = xOffset;                         // Default left alignment
    }
    // Render the current line
    Q_Font_RenderText_sub_2B610(pFont, horizontalPos, currentY, lineText, flags, 0xFFFFFFFE, wipeColor);
    // Move to next line
    lineText += strlen(lineText) + 1;
    currentY += lineHeight;
  }
  // Update pane if wipe was performed
  if ( (flags & 0x80) != 0 )
  {
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pFont->pane);
  }
  // Clean up and return total height
  free(textCopy);
  return lineCount * lineHeight;
}
// 2B8A8: could not find valid save-restore pair for ebx

//----- (0002BB50) --------------------------------------------------------
void Q_GSystem_StaticCtor_sub_2BB50()
{
  _wcpp_2_mod_register_((RW_DTREG *)&stru_96780);
  Q_GSystem_Ctor_sub_2BD4C(&V_GSystem);
  stru_96780.state_var = 1;
}

//----- (0002BB74) --------------------------------------------------------
void __fastcall Q_Pane_CopyOrDrawRectangle_sub_2BB74(PANE *pPane, LONG x0, LONG yTop, LONG x1, LONG yBottom, UBYTE color, int copy)
{
  PANE source; // [esp+0h] [ebp-20h] BYREF
  LONG x1_; // [esp+14h] [ebp-Ch]
  LONG yTop_; // [esp+18h] [ebp-8h]
  LONG x0_; // [esp+1Ch] [ebp-4h]

  x0_ = x0;
  yTop_ = yTop;
  x1_ = x1;
  if ( copy == TRUE )
  {
    source.window = pPane->window;
    source.x0 = x0_;
    source.y1 = yBottom;
    source.x1 = x1;
    source.y0 = yTop;
    VFX_pane_copy(&source, 0, 0, pPane, x0_, yTop, color);
  }
  else
  {
    VFX_line_draw(pPane, x0_, yTop, x1, yTop, LD_DRAW, color);// Top
    VFX_line_draw(pPane, x0_, yBottom, x1_, yBottom, LD_DRAW, color);// Bottom
    VFX_line_draw(pPane, x0_, yTop_, x0_, yBottom, LD_DRAW, color);// Left
    VFX_line_draw(pPane, x1_, yTop_, x1_, yBottom, LD_DRAW, color);// Right
  }
}
// 2BB74: could not find valid save-restore pair for ebx

//----- (0002BC40) --------------------------------------------------------
void __fastcall Q_Pane_CenterShape_sub_2BC40(PANE *pPane, void *shape_table, LONG shape_number, int *outHotX, int *outHotY)
{
  int shapeHeight; // ebx
  int v7; // eax
  int v8; // eax
  RECT shapeBounds; // [esp+0h] [ebp-18h] BYREF
  LONG shapeNumber; // [esp+10h] [ebp-8h]
  void *shapeTable; // [esp+14h] [ebp-4h]

  shapeTable = shape_table;
  shapeNumber = shape_number;
  if ( !pPane )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x40);
  }
  if ( !shapeTable )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x41);
  }
  VFX_shape_visible_rectangle(shapeTable, shapeNumber, 0, 0, 0, &shapeBounds);
  shapeHeight = shapeBounds.y1 - shapeBounds.y0;
  v7 = pPane->x1 - pPane->x0 - (shapeBounds.x1 - shapeBounds.x0);
  *outHotX = v7;
  if ( v7 )
  {
    *outHotX = v7 / 2;
  }
  v8 = pPane->y1 - pPane->y0 - shapeHeight;
  *outHotY = v8;
  if ( v8 )
  {
    *outHotY = v8 / 2;
  }
  *outHotX -= shapeBounds.x0;
  *outHotY -= shapeBounds.y0;
}

//----- (0002BCF4) --------------------------------------------------------
void __fastcall sub_2BCF4(int a1, unsigned __int8 a2)
{
  Q_GSystem_AdjustPalette_sub_2BD04(&V_GSystem, a2, 0);
}

//----- (0002BD04) --------------------------------------------------------
// Adjusts the palette colors towards a target color with a specific intensity
void __fastcall Q_GSystem_AdjustPalette_sub_2BD04(P_GSystem pGSystem, char fadeIntensity, RGB *pTargetColor)
{
  char v4; // dh
  int i; // kr04_4
  char v6; // dl
  char v7; // dl
  char v8; // dl
  RGB targetColor; // [esp+0h] [ebp-14h]

  if ( !fadeIntensity )
  {
    Q_GSystem_PaletteGet_sub_2C2B0(pGSystem, 0, 0x100, pGSystem->palette1);
  }
  if ( pTargetColor )
  {
    targetColor = *pTargetColor;
  }
  else
  {
    targetColor.r = 0;
    targetColor.g = 0;
    targetColor.b = 0;
  }
  v4 = 0x40 - fadeIntensity;
  if ( (char)(0x40 - fadeIntensity) < 0 )
  {
    v4 = 0;
  }
  for ( i = 0; i != 0x100; ++i )
  {
    v8 = pGSystem->palette1[i].r - targetColor.r;
    if ( v8 >= 0 )
    {
      if ( (char)(v8 - v4) > 0 )
      {
        --pGSystem->palette1[i].r;
      }
    }
    else if ( (char)(v4 + v8) < 0 )
    {
      ++pGSystem->palette1[i].r;
    }
    v6 = pGSystem->palette1[i].g - targetColor.g;
    if ( v6 >= 0 )
    {
      if ( (char)(v6 - v4) > 0 )
      {
        --pGSystem->palette1[i].g;
      }
    }
    else if ( (char)(v4 + v6) < 0 )
    {
      ++pGSystem->palette1[i].g;
    }
    v7 = pGSystem->palette1[i].b - targetColor.b;
    if ( v7 >= 0 )
    {
      if ( (char)(v7 - v4) > 0 )
      {
        --pGSystem->palette1[i].b;
      }
    }
    else if ( (char)(v4 + v7) < 0 )
    {
      ++pGSystem->palette1[i].b;
    }
  }
  Q_GSystem_PaletteSet_sub_2C224(pGSystem, 0, 0x100, pGSystem->palette1);
}

//----- (0002BD4C) --------------------------------------------------------
void __fastcall __spoils<> Q_GSystem_Ctor_sub_2BD4C(P_GSystem self)
{
  self->window.buffer = 0;
  self->pane.window = 0;
  self->Unknown_12F = 0;
  self->fname[0] = 0;
  self->hazeTables = 0;
  self->numTables = 0;
}

//----- (0002BD7C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_GSystem_Dtor_sub_2BD7C(P_GSystem self, unsigned int a2)
{
  Q_GSystem_Stop_sub_2C6CC(self);
}

//----- (0002BD88) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_GSystem_Start_sub_2BD88(P_GSystem a1, const char *dirName, const char *driverName)
{
  void *v4; // esi
  void *v5; // edx
  MACRO_VFX_BOOL result; // eax
  UBYTE *buffer; // ecx
  UBYTE *v8; // eax
  int a; // eax
  int b; // eax
  int v11; // eax
  int v12; // eax
  UBYTE *v13; // edi
  char *fname; // [esp-4h] [ebp-234h]
  T_CFile v15; // [esp+0h] [ebp-230h] BYREF
  char v16[256]; // [esp+118h] [ebp-118h] BYREF
  const char *v17; // [esp+218h] [ebp-18h]
  void *ptr; // [esp+21Ch] [ebp-14h]

  v17 = dirName;
  fname = a1->fname;
  strcpy(a1->fname, dirName);
  strcat(fname, "\\");
  if ( driverName )
  {
    strcat(fname, driverName);
  }
  else
  {
    strcpy(v16, v17);
    strcat(v16, "\\VFXSCAN.DLL");
    Q_CFile_Ctor_sub_1BB78(&v15);
    Q_CFile_Open_sub_1BBFC(&v15, v16, 0x200, 0);
    v4 = Q_CFile_Load_sub_1BF1C(&v15, 0);
    if ( !v4 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x9F);
    }
    Q_CFile_Dtor_sub_1BBC8(&v15);
    ptr = DLL_load(v4, 5u, 0);
    Q_RemoveWinDataFromWinMgr_sub_2627C(v4);
    v5 = ptr;
    operator delete(v4);
    if ( !v5 )
    {
      return FALSE;
    }
    strcat(a1->fname, VFX_driver_name(v5));
    free(ptr);
  }
  result = Q_GSYSTEM_CPP_sub_2BFDC(a1);
  if ( result )
  {
    VFX_init_driver();
    buffer = a1->window.buffer;
    a1->Unknown_12F = 0xFFFFFFFF;
    if ( buffer )
    {
      Q_RemoveWinDataFromWinMgr_sub_262CC(buffer);
    }
    v8 = (UBYTE *)Q_AllocAndAddToWinMgr_sub_262B0(a1->b * a1->a, 1u, 1, "OFFSCREEN BUFFER");
    a1->window.stencil = 0;
    a1->window.buffer = v8;
    a = a1->a;
    a1->window.shadow = 0;
    a1->window.x_max = a - 1;
    b = a1->b;
    a1->pane.x0 = 0;
    a1->window.y_max = b - 1;
    v11 = a1->a;
    a1->pane.y0 = 0;
    a1->pane.x1 = v11 - 1;
    v12 = a1->b;
    a1->pane.window = &a1->window;
    v13 = a1->window.buffer;
    a1->pane.y1 = v12 - 1;
    if ( !v13 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0xD9);
    }
    return TRUE;
  }
  return result;
}
// 2BE8B: conditional instruction was optimized away because esi.4!=0
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002BFDC) --------------------------------------------------------
unsigned int __fastcall Q_GSYSTEM_CPP_sub_2BFDC(P_GSystem a1)
{
  void *v2; // esi
  void *v3; // edx
  VFX_DESC *v5; // eax
  T_CFile v6; // [esp-128h] [ebp-12Ch] BYREF

  Q_CFile_Ctor_sub_1BB78(&v6);
  Q_CFile_Open_sub_1BBFC(&v6, a1->fname, O_BINARY, FALSE);
  v2 = Q_CFile_Load_sub_1BF1C(&v6, 0);
  if ( !v2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0xEB);
  }
  Q_CFile_Dtor_sub_1BBC8(&v6);
  v3 = DLL_load(v2, 5u, 0);
  Q_RemoveWinDataFromWinMgr_sub_2627C(v2);
  operator delete(v2);
  if ( !v3 )
  {
    return 0;
  }
  VFX_register_driver(v3);
  v5 = VFX_describe_driver();
  a1->a = v5->scrn_width;
  a1->b = v5->scrn_height;
  return 0xFFFFFFFF;
}
// 2C02A: conditional instruction was optimized away because esi.4!=0
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002C08C) --------------------------------------------------------
void __fastcall Q_AllocateHazeTables_sub_2C08C(P_GSystem a1, unsigned __int16 numTables)
{
  void *v4; // eax

  v4 = operator new[](numTables << 8);
  Q_RegisterDataInWinMgr_sub_2625C(v4, 1, "GSYSTEM HAZE TABLES");
  a1->hazeTables = (T_HazeTables *)v4;
  a1->numTables = numTables;
}

//----- (0002C0C0) --------------------------------------------------------
int __fastcall Q_LoadHazeTables_sub_2C0C0(P_GSystem a1, const char *a2, unsigned __int16 num)
{
  void *v4; // edi
  T_CFile v6; // [esp+0h] [ebp-118h] BYREF

  if ( num >= a1->numTables )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x11F);
  }
  Q_CFile_Ctor_sub_1BB78(&v6);
  Q_CFile_Open_sub_1BBFC(&v6, a2, 0x200, 0);
  v4 = Q_CFile_Load_sub_1BF1C(&v6, (*a1->hazeTables)[num]);
  if ( !v4 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\gsystem.cpp", 0x127);
  }
  Q_CFile_Dtor_sub_1BBC8(&v6);
  return (v4 == 0) - 1;
}

//----- (0002C158) --------------------------------------------------------
unsigned int __fastcall Q_LoadPal_sub_2C158(P_GSystem a1, const char *aFName, int a3, unsigned __int16 a4)
{
  T_CFile v8; // [esp+0h] [ebp-124h] BYREF
  unsigned __int16 from[2]; // [esp+118h] [ebp-Ch]

  *(_DWORD *)from = a3;
  Q_CFile_Ctor_sub_1BB78(&v8);
  Q_CFile_Open_sub_1BBFC(&v8, aFName, O_BINARY, 0);
  if ( !Q_CFile_Load_sub_1BF1C(&v8, a1->palette2) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x13C);
  }
  Q_CFile_Dtor_sub_1BBC8(&v8);
  Q_GSystem_PaletteSet_sub_2C224(a1, from[0], a4, a1->palette2);
  return 0xFFFFFFFF;
}
// 2C1AD: conditional instruction was optimized away because ecx.4!=0

//----- (0002C1E0) --------------------------------------------------------
void __fastcall sub_2C1E0(P_GSystem a1, unsigned __int16 a2, unsigned __int16 a3, unsigned int a4)
{
  int v4; // ebx
  unsigned int v5; // esi
  int i; // edx

  for ( i = 0; i < a3; ++i )
  {
    v4 = i + a2;
    v5 = a4 + 3 * i;
    *(_WORD *)&a1->palette2[v4].r = *(_WORD *)v5;
    a1->palette2[v4].b = *(_BYTE *)(v5 + 2);
  }
}

//----- (0002C224) --------------------------------------------------------
void __fastcall Q_GSystem_PaletteSet_sub_2C224(P_GSystem a1, unsigned __int16 from, __int16 count, RGB *palette)
{
  int i; // kr04_4

  VFX_wait_vblank_leading();
  for ( i = 0; from + i < (__int16)(from + count); ++i )
  {
    VFX_DAC_write(from + i, &palette[i]);
  }
}

//----- (0002C264) --------------------------------------------------------
void __fastcall Q_NC_sub_2C264(T_GSystem *a1)
{
  Q_GSystem_PaletteSet_sub_2C224(a1, 0, 256, a1->palette2);
}

//----- (0002C280) --------------------------------------------------------
void __fastcall Q_NC_sub_2C280(P_GSystem a1, signed __int16 a2, __int16 a3)
{
  Q_GSystem_PaletteSet_sub_2C224(a1, a2, a3, &a1->palette2[a2]);
}

//----- (0002C2B0) --------------------------------------------------------
void __fastcall Q_GSystem_PaletteGet_sub_2C2B0(P_GSystem a1, unsigned __int16 from, __int16 count, RGB *palette)
{
  RGB *nextrgb; // edi
  int i; // kr04_4

  nextrgb = palette;
  if ( !palette )
  {
    nextrgb = a1->palette2;
  }
  VFX_wait_vblank_leading();
  for ( i = 0; from + i < (__int16)(from + count); ++i )
  {
    VFX_DAC_read(from + i, &nextrgb[i]);
  }
}

//----- (0002C2F8) --------------------------------------------------------
void __fastcall sub_2C2F8(T_GSystem *a1, char *a2)
{
  int i; // ecx
  unsigned int v4; // eax

  for ( i = 0; i < 0x40; ++i )
  {
    Q_GSystem_AdjustPalette_sub_2BD04(a1, i, (RGB *)a2);
    v4 = i;
    delay(v4);
  }
}

//----- (0002C418) --------------------------------------------------------
void __fastcall sub_2C418(P_GSystem a1, int a2, __int16 a3)
{
  __int16 v3; // si
  LONG v4; // [esp-8h] [ebp-10h]
  RGB v5; // [esp+0h] [ebp-8h] BYREF
  int v6; // [esp+4h] [ebp-4h]

  v6 = a2;
  v3 = a2;
  VFX_wait_vblank_leading();
  if ( (__int16)(a3 + a2) > (__int16)a2 )
  {
    do
    {
      VFX_DAC_read(v3, &v5);
      if ( v5.r )
      {
        --v5.r;
      }
      if ( v5.r )
      {
        --v5.r;
      }
      if ( v5.g )
      {
        --v5.g;
      }
      if ( v5.g )
      {
        --v5.g;
      }
      if ( v5.b )
      {
        --v5.b;
      }
      if ( v5.b )
      {
        --v5.b;
      }
      v4 = v3++;
      VFX_DAC_write(v4, &v5);
    }
    while ( v3 < (__int16)(a3 + a2) );
  }
}
// 2C418: using guessed type RGB anonymous_0;

//----- (0002C4C0) --------------------------------------------------------
void __fastcall sub_2C4C0(P_GSystem a1, int a2, int a3)
{
  __int16 i; // si
  RGB v5; // [esp+0h] [ebp-1Ch] BYREF
  int v6; // [esp+4h] [ebp-18h]
  int v7; // [esp+8h] [ebp-14h]

  v6 = a2;
  VFX_wait_vblank_leading();
  v7 = a3 + a2;
  for ( i = a2; i < (__int16)v7; ++i )
  {
    VFX_DAC_read(i, &v5);
    if ( v5.r < a1->palette2[i].r )
    {
      ++v5.r;
    }
    if ( v5.r < a1->palette2[i].r )
    {
      ++v5.r;
    }
    if ( v5.g < a1->palette2[i].g )
    {
      ++v5.g;
    }
    if ( v5.g < a1->palette2[i].g )
    {
      ++v5.g;
    }
    if ( v5.b < a1->palette2[i].b )
    {
      ++v5.b;
    }
    if ( v5.b < a1->palette2[i].b )
    {
      ++v5.b;
    }
    VFX_DAC_write(i, &v5);
  }
}

//----- (0002C5C0) --------------------------------------------------------
void __fastcall Q_NC_sub_2C5C0(T_GSystem *a1)
{
  int i; // ebx
  unsigned int v3; // eax

  for ( i = 0; i < 64; ++i )
  {
    Q_GSystem_FadePalette_sub_2C5E4(a1, i);
    v3 = i;
    delay(v3);
  }
}

//----- (0002C5E4) --------------------------------------------------------
void __fastcall Q_GSystem_FadePalette_sub_2C5E4(P_GSystem a1, char a2)
{
  char v3; // dh
  RGB *palette1; // kr00_4
  char v5; // dl
  int v6; // kr04_4

  if ( !a2 )
  {
    Q_GSystem_PaletteGet_sub_2C2B0(a1, 0, 256, a1->palette1);
  }
  v3 = 64 - a2;
  palette1 = a1->palette1;
  v6 = 0;
  do
  {
    v5 = *(&palette1->r + v6) - *(&a1->palette2[0].r + v6);
    if ( v5 >= 0 )
    {
      if ( (char)(v5 - v3) > 0 )
      {
        --*(&palette1->r + v6);
      }
    }
    else if ( (char)(v3 + v5) < 0 )
    {
      ++*(&palette1->r + v6);
    }
    ++v6;
  }
  while ( (RGB *)((char *)palette1 + v6) != a1->palette2 );
  Q_GSystem_PaletteSet_sub_2C224(a1, 0, 256, a1->palette1);
}

//----- (0002C670) --------------------------------------------------------
void __fastcall sub_2C670(P_GSystem a1, int a2, int a3, RGB *triplet)
{
  RGB *v4; // edi
  __int16 v5; // si
  char v6[4]; // [esp+0h] [ebp-14h] BYREF
  int v7; // [esp+4h] [ebp-10h]
  int v8; // [esp+8h] [ebp-Ch]

  v8 = a2;
  v4 = triplet;
  if ( !triplet )
  {
    v4 = (RGB *)v6;
    v6[1] = 0;
    v6[2] = 0;
    v6[0] = 0;
  }
  v5 = v8;
  v7 = a3 + v8;
  VFX_wait_vblank_leading();
  for ( ; v5 < (__int16)v7; ++v5 )
  {
    VFX_DAC_write(v5, v4);
  }
}

//----- (0002C6CC) --------------------------------------------------------
void __fastcall Q_GSystem_Stop_sub_2C6CC(P_GSystem a1)
{
  UBYTE *buffer; // ebx

  if ( a1->Unknown_12F == 0xFFFFFFFF )
  {
    VFX_shutdown_driver();
  }
  buffer = a1->window.buffer;
  a1->Unknown_12F = 0;
  if ( buffer )
  {
    Q_RemoveWinDataFromWinMgr_sub_262CC(buffer);
    a1->window.buffer = 0;
  }
  if ( a1->window.shadow )
  {
    Q_RemoveWinDataFromWinMgr_sub_262CC(a1->window.shadow);
    a1->window.shadow = 0;
  }
  Q_RemoveWinDataFromWinMgr_sub_2627C(a1->hazeTables);
  operator delete[](a1->hazeTables);
  a1->hazeTables = 0;
  a1->numTables = 0;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0002C744) --------------------------------------------------------
void __fastcall Q_GSystem_PreloadMouseShp_sub_2C744(P_GSystem a1)
{
  void *v2; // eax
  T_CFile CFile; // [esp-124h] [ebp-128h] BYREF

  if ( V_Mouse.initialized )
  {
    if ( !a1->mouseShapeTable )
    {
      Q_CFile_Ctor_sub_1BB78(&CFile);
      Q_CFile_Open_sub_1BBFC(&CFile, "DATA\\MOUSE.SHP", O_BINARY, FALSE);
      v2 = Q_CFile_Load_sub_1BF1C(&CFile, 0);
      a1->mouseShapeTable = v2;
      if ( !v2 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x2B3);
      }
      a1->mouseShapeNum = 0;
      Q_CFile_Dtor_sub_1BBC8(&CFile);
    }
    MOUSE_set_pointer(a1->mouseShapeTable, a1->mouseShapeNum);
  }
}

//----- (0002C7D0) --------------------------------------------------------
void __fastcall Q_GSystem_SetMousePointerShape_sub_2C7D0(P_GSystem pGSysytem, LONG mouseShapeNumber, void *table)
{
  void *mouseShapeTable; // ecx

  mouseShapeTable = table;
  if ( !table )
  {
    mouseShapeTable = pGSysytem->mouseShapeTable;
  }
  if ( !mouseShapeTable )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x2C7);
  }
  if ( mouseShapeNumber < 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x2C8);
  }
  MOUSE_set_pointer(mouseShapeTable, mouseShapeNumber);
}
// 2C80C: conditional instruction was optimized away because ecx.4!=0

//----- (0002C830) --------------------------------------------------------
void __fastcall __spoils<> Q_WndA2_Ctor_sub_2C830(P_WndA2 a1)
{
  a1->pProcs = &WndA2_Procs;
  Q_Wnd_Init_sub_2C8E4((P_Wnd)a1);
}

//----- (0002C848) --------------------------------------------------------
void __fastcall __spoils<edx> Q_WndA2_Dtor_sub_2C848(P_WndA2 a1, char a2)
{
  char *v3; // eax
  T_ChildWindows *children; // edx
  __int16 i; // ax
  P_WndA2 v6; // edx
  int parentIndex; // ebx

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_WndA2);
    operator delete[](v3);
  }
  else
  {
    children = a1->children;
    a1->pProcs = &WndA2_Procs;
    if ( children )
    {
      for ( i = 0; i < 20; ++i )
      {
        v6 = (*a1->children)[i];
        if ( v6 )
        {
          v6->parentIndex = 0;
        }
      }
      Q_RemoveWinDataFromWinMgr_sub_262CC(a1->children);
    }
    parentIndex = a1->parentIndex;
    if ( parentIndex )
    {
      sub_2CA0C((P_Wnd)WinMgr.wnds[parentIndex].pWndA2, (P_Wnd)a1, parentIndex);
    }
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002C8E4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd_Init_sub_2C8E4(P_Wnd a1)
{
  a1->index = 0;
  a1->pane.window = 0;
  a1->shapeCacheIndex = 0xFFFF;
  a1->Unknown_1A = 0;
  a1->shapeNumber = 0xFFFF;
  a1->name[0] = 0;
  a1->Unknown_35 = 0;
  a1->Unknown_39 = 0;
  a1->_mouseFocus = 0;
  a1->Unknown_59 = 0xFFFF;
  a1->_x = 0xFFFF;
  a1->_y = 0xFFFF;
  a1->framed = 0;
  a1->sendMessage = 0;
  a1->sendParam1 = 0;
  a1->sendParam2 = 0;
  a1->helpIndex[0] = 0;
  a1->parentIndex = 0;
  a1->children = 0;
  a1->childrenNum = 0;
  a1->_t19Num = 0;
  a1->Unknown_A3 = 0xFFFFFFFF;
}

//----- (0002C978) --------------------------------------------------------
void __fastcall Q_RegisterWindowInWinMgr_sub_2C978(P_WndA2 a1)
{
  a1->index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, a1);
}

//----- (0002C990) --------------------------------------------------------
unsigned int __fastcall Q_GWINDOW_CPP_LinkChild_sub_2C990(P_WndA2 a1, P_WndA2 a2)
{
  T_ChildWindows *children; // eax
  WORD childrenNum; // ax

  if ( !a1->childrenNum )
  {
    if ( a1->children )
    {
      Q_RemoveWinDataFromWinMgr_sub_262CC(a1->children);
    }
    children = (T_ChildWindows *)Q_Allocate_sub_2628C(0x50u, 1, "CHILD WINDOWS");
    a1->children = children;
    memset(children, 0, sizeof(T_ChildWindows));
  }
  if ( a1->childrenNum >= 20 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x94);
  }
  childrenNum = a1->childrenNum;
  a1->childrenNum = childrenNum + 1;
  (*a1->children)[childrenNum] = a2;
  return 0xFFFFFFFF;
}

//----- (0002CA0C) --------------------------------------------------------
unsigned int __fastcall sub_2CA0C(P_Wnd a1, P_Wnd a2, int a3)
{
  unsigned int v4; // esi
  __int16 i; // dx
  P_WndA2 *v6; // ebx

  v4 = 0;
  if ( a1->children )
  {
    for ( i = 0; i < 20; ++i )
    {
      v6 = &(*a1->children)[i];
      if ( a2 == (P_Wnd)*v6 )
      {
        *v6 = 0;
        v4 = 0xFFFFFFFF;
        --a1->childrenNum;
      }
    }
  }
  return v4;
}

//----- (0002CA58) --------------------------------------------------------
int __fastcall Q_NC_sub_2CA58(int a1)
{
  return (*(int (**)(void))(*(_DWORD *)(a1 + 0xA7) + 4))();
}

//----- (0002CA78) --------------------------------------------------------
P_Wnd __fastcall Q_Wnd_Proc2TranslatePane_sub_2CA78(P_Wnd result, WORD xOffset, WORD yOffset)
{
  LONG y0; // edi
  LONG y1; // ebp
  LONG v5; // esi

  y0 = result->pane.y0;
  y1 = result->pane.y1;
  v5 = xOffset + result->pane.x1;
  result->pane.x0 += xOffset;
  result->pane.x1 = v5;
  result->pane.y0 = yOffset + y0;
  result->pane.y1 = yOffset + y1;
  return result;
}

//----- (0002CD24) --------------------------------------------------------
void __fastcall sub_2CD24(unsigned int a1, int a2)
{
  void *ShapeTable_sub_1B084; // eax
  UWORD v3; // ax
  LONG v4; // [esp-18h] [ebp-1Ch]
  LONG v5; // [esp-14h] [ebp-18h]
  LONG v6; // [esp-Ch] [ebp-10h]

  if ( *(_DWORD *)(a1 + 0x39) )
  {
    if ( (WinMgr._wndIndex == *(_DWORD *)(a1 + 0x41) || a2 == 3) && *(_DWORD *)(a1 + 0x3D) && a2 != 2 )
    {
      (*(void (__fastcall **)(unsigned int, int))(*(_DWORD *)(a1 + 0xA7) + 0x10))(a1, a2);
    }
    else
    {
      if ( *(__int16 *)(a1 + 0x1E) == 0xFFFFFFFF )
      {
        if ( *(_WORD *)(a1 + 0xA1) )
        {
          sub_2D0F4((P_Wnd)a1, 0);
        }
        else
        {
          VFX_pane_wipe((PANE *)(a1 + 4), 0xF2);
          WinMgr.LargeFont.pane = *(PANE *)(a1 + 4);
          v3 = 0;
          if ( *(__int16 *)(a1 + 0x5B) == 0xFFFFFFFF )
          {
            v3 = 2;
          }
          if ( *(__int16 *)(a1 + 0x5D) == 0xFFFFFFFF )
          {
            LOBYTE(v3) = v3 | 1;
          }
          Q_Font_DrawFormattedText_sub_2B8A8(
            &WinMgr.LargeFont,
            *(__int16 *)(a1 + 0x5B),
            *(__int16 *)(a1 + 0x5D),
            (const char *)(a1 + 0x20),
            v3,
            0xFFFF,
            0xFF,
            0);
          if ( *(_DWORD *)(a1 + 0x5F) == 0xFFFFFFFF )
          {
            VFX_line_draw((PANE *)(a1 + 4), 0, 0, *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), 0, 0, 0xF3);
            VFX_line_draw((PANE *)(a1 + 4), 0, 0, 0, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), 0, 0xF3);
            v5 = *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC);
            VFX_line_draw((PANE *)(a1 + 4), *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), v5, 0, v5, 0, 0xF3);
            v4 = *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8);
            VFX_line_draw((PANE *)(a1 + 4), v4, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), v4, 0, 0, 0xF3);
          }
        }
      }
      else
      {
        v6 = *(__int16 *)(a1 + 0x1E);
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
        VFX_shape_draw((PANE *)(a1 + 4), ShapeTable_sub_1B084, v6, 0, 0);
      }
      Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, *(_DWORD *)(a1 + 8), *(_DWORD *)(a1 + 0xC), *(_DWORD *)(a1 + 0x10), *(_DWORD *)(a1 + 0x14));
    }
    if ( *(_WORD *)(a1 + 0x6B) )
    {
      sub_2D218((P_WndA2)a1);
    }
  }
}

//----- (0002CF28) --------------------------------------------------------
void __fastcall Q_Wnd_Proc5_sub_2CF28(P_Wnd pWnd, int a2)
{
  PANE *p_pane; // esi
  void *ShapeTable_sub_1B084; // eax
  UWORD v4; // ax
  LONG v5; // [esp-18h] [ebp-1Ch]
  LONG v6; // [esp-14h] [ebp-18h]
  LONG shapeNumber; // [esp-Ch] [ebp-10h]

  p_pane = &pWnd->pane;
  if ( pWnd->shapeNumber == 0xFFFFFFFF )
  {
    if ( pWnd->_t19Num )
    {
      sub_2D0F4(pWnd, 1);
    }
    else
    {
      VFX_pane_wipe(&pWnd->pane, 0x96);
      WinMgr.LargeFont.pane = pWnd->pane;
      v4 = 0;
      if ( pWnd->_x == 0xFFFFFFFF )
      {
        v4 = 2;
      }
      if ( pWnd->_y == 0xFFFFFFFF )
      {
        LOBYTE(v4) = v4 | 1;
      }
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, pWnd->_x, pWnd->_y, pWnd->name, v4, 0xFFFF, 0xFF, 0);
      if ( pWnd->framed == TRUE )
      {
        VFX_line_draw(&pWnd->pane, 0, 0, pWnd->pane.x1 - pWnd->pane.x0, 0, 0, 0xF3);
        VFX_line_draw(&pWnd->pane, 0, 0, 0, pWnd->pane.y1 - pWnd->pane.y0, 0, 0xF3);
        v6 = pWnd->pane.y1 - pWnd->pane.y0;
        VFX_line_draw(&pWnd->pane, pWnd->pane.x1 - pWnd->pane.x0, v6, 0, v6, 0, 0xF3);
        v5 = pWnd->pane.x1 - pWnd->pane.x0;
        VFX_line_draw(&pWnd->pane, v5, pWnd->pane.y1 - pWnd->pane.y0, v5, 0, 0, 0xF3);
      }
    }
  }
  else
  {
    VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapFocus);
    shapeNumber = pWnd->shapeNumber;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->shapeCacheIndex);
    VFX_shape_translate_draw(p_pane, ShapeTable_sub_1B084, shapeNumber, 0, 0);
  }
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, pWnd->pane.x0, pWnd->pane.y0, pWnd->pane.x1, pWnd->pane.y1);
}

//----- (0002D0F4) --------------------------------------------------------
P_Wnd __fastcall sub_2D0F4(P_Wnd pWnd, int a2)
{
  LONG v2; // eax
  PANE *pPane; // esi
  P_Wnd result; // eax
  T_Type19 *t19; // kr00_4
  char *v6; // eax
  int v7; // ebx
  int v8; // edx
  void *ShapeTable_sub_1B084; // eax
  UWORD v10; // [esp-10h] [ebp-30h]
  LONG shapeNumber; // [esp-Ch] [ebp-2Ch]
  LONG hotX; // [esp-8h] [ebp-28h]
  LONG hotY; // [esp-4h] [ebp-24h]
  int i; // [esp+8h] [ebp-18h]

  v2 = 0xF2;
  if ( a2 )
  {
    v2 = 0x96;
  }
  pPane = &pWnd->pane;
  VFX_pane_wipe(&pWnd->pane, v2);
  result = pWnd;
  t19 = pWnd->_t19;
  for ( i = 0; (__int16)i < pWnd->_t19Num; ++i )
  {
    if ( !&t19[i] )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x1CE);
    }
    if ( t19[i].Unknown_0 )
    {
      if ( t19[i].Unknown_0 == 1 )
      {
        hotY = t19[i].hotY;
        hotX = t19[i].hotX;
        shapeNumber = t19[i]._shapeNumber;
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, t19[i].cacheIndex);
        VFX_shape_draw(pPane, ShapeTable_sub_1B084, shapeNumber, hotX, hotY);
      }
      else
      {
        Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x1DF);
      }
    }
    else
    {
      v6 = sub_2D3D0((char *)t19[i].cacheIndex);
      v7 = t19[i].hotY;
      v8 = t19[i].hotX;
      v10 = t19[i]._shapeNumber;
      WinMgr.LargeFont.pane.window = pPane->window;
      WinMgr.LargeFont.pane.x0 = pWnd->pane.x0;
      WinMgr.LargeFont.pane.y0 = pWnd->pane.y0;
      WinMgr.LargeFont.pane.x1 = pWnd->pane.x1;
      WinMgr.LargeFont.pane.y1 = pWnd->pane.y1;
      result = (P_Wnd)Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v8, v7, v6, v10, 0xF3, 0xFF, 0);
    }
  }
  return result;
}

//----- (0002D218) --------------------------------------------------------
void __fastcall sub_2D218(P_WndA2 pWnd)
{
  __int16 i; // bx
  P_WndA2 *v3; // eax
  P_WndA2 v4; // ecx
  P_WndA2 v5; // eax

  if ( pWnd->children )
  {
    for ( i = 0; i < 20; ++i )
    {
      v3 = &(*pWnd->children)[i];
      v4 = *v3;
      if ( *v3 )
      {
        v5 = *v3;
        if ( v4->Unknown_39 == 0xFFFFFFFF )
        {
          v4->pProcs->proc4_draw(v5, 0);
        }
      }
    }
  }
}

//----- (0002D258) --------------------------------------------------------
void __fastcall Q_WndA2_CallChildrenProc3_sub_2D258(P_WndA2 pWnd, UWORD message, int param1, int param2)
{
  __int16 i; // si
  P_WndA2 pChildWnd; // ebx
  P_WndA2 pChildWnd_; // eax

  if ( pWnd->children )
  {
    for ( i = 0; i < 20; ++i )
    {
      pChildWnd = (*pWnd->children)[i];
      if ( pChildWnd && (pChildWnd->Unknown_35 || message == 1) )
      {
        pChildWnd_ = (*pWnd->children)[i];
        pChildWnd_->pProcs->proc3_msg(pChildWnd_, message, param1, param2);
      }
    }
  }
}

//----- (0002D2CC) --------------------------------------------------------
int Q_LoadGwshareTxt_sub_2D2CC()
{
  FILE *v0; // ecx
  int i; // kr04_4
  char filename[52]; // [esp+0h] [ebp-34h] BYREF

  v0 = Q_OpenTextFile_sub_1BB10("gwshare.txt", 0);
  if ( !v0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x214);
  }
  for ( i = 0; i != 0x2D; ++i )
  {
    fscanf(v0, "%s", filename);
    GwshareShpCacheIndexes[i] = Q_Cache_AddFile_sub_1ADAC(&WinMgr.cache, filename);
  }
  return fclose(v0);
}
// 2D2CC: using guessed type char filename[52];

//----- (0002D334) --------------------------------------------------------
int __fastcall sub_2D334(const char *a1)
{
  unsigned int v1; // kr04_4
  int result; // eax

  if ( !a1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x226);
  }
  v1 = strlen(a1) + 1;
  if ( (int)(v1 - 1 + SHIWORD(dword_100302)) >= 0x400 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x229);
  }
  strcpy(&byte_FFF04[SHIWORD(dword_100302)], a1);
  result = SHIWORD(dword_100302);
  HIWORD(dword_100302) += v1;
  return result;
}
// 2D334: could not find valid save-restore pair for edi
// 100302: using guessed type int dword_100302;

//----- (0002D3D0) --------------------------------------------------------
char *__fastcall sub_2D3D0(char *result)
{
  if ( (int)result >= SHIWORD(dword_100302) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x237);
  }
  return result;
}
// 100302: using guessed type int dword_100302;

//----- (0002D400) --------------------------------------------------------
unsigned int __fastcall sub_2D400(int a1, int a2)
{
  unsigned int result; // eax
  __int16 v4; // cx

  if ( *(__int16 *)(a1 + 0xA1) < 4 )
  {
    v4 = *(_WORD *)(a1 + 0xA1);
    *(_WORD *)(a1 + 0xA1) = v4 + 1;
    result = 0xFFFFFFFF;
    *(_DWORD *)(a1 + 0xD * v4 + 0x6D) = *(_DWORD *)a2;
    *(_DWORD *)(a1 + 0xD * v4 + 0x71) = *(_DWORD *)(a2 + 4);
    *(_DWORD *)(a1 + 0xD * v4 + 0x75) = *(_DWORD *)(a2 + 8);
    *(_BYTE *)(a1 + 0xD * v4 + 0x79) = *(_BYTE *)(a2 + 0xC);
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x241);
    return 0;
  }
  return result;
}

//----- (0002D464) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd25TW_Ctor_sub_2D464(P_Wnd25TW a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = &Wnd25TW_Procs;
  Q_Wnd25TW_Init_sub_2D4C4(a1);
}

//----- (0002D480) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd25TW_Dtor_sub_2D480(P_Wnd25TW a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd25TW);
    operator delete[](v3);
  }
  else
  {
    a1->a2.pProcs = &Wnd25TW_Procs;
    Q_WndA2_Dtor_sub_2C848(&a1->a2, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002D4C4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd25TW_Init_sub_2D4C4(P_Wnd25TW result)
{
  result->buttonState = 0;
}

//----- (0002D4D0) --------------------------------------------------------
int __fastcall Q_Wnd25TW_Proc3_sub_2D4D0(P_Wnd25TW pWnd25TW, UWORD message, int param1, int param2)
{
  if ( message < 4u
    || message > 5u
    || param1 < pWnd25TW->a2.pane.x0
    || param1 > pWnd25TW->a2.pane.x1
    || param2 < pWnd25TW->a2.pane.y0
    || param2 > pWnd25TW->a2.pane.y1 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd25TW->a2, message, param1, param2);
  }
  pWnd25TW->buttonState = ~pWnd25TW->buttonState;
  pWnd25TW->a2.pProcs->proc5((P_WndA2)pWnd25TW, 0);
  return Q_WndA2_Proc3_sub_2F424(&pWnd25TW->a2, message, param1, param2);
}

//----- (0002D528) --------------------------------------------------------
void __fastcall Q_Wnd25TW_Proc4_sub_2D528(P_Wnd25TW pWnd, int a2)
{
  PANE *p_pane; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v4; // eax
  LONG v5; // eax
  LONG v6; // [esp-18h] [ebp-1Ch]
  LONG v7; // [esp-14h] [ebp-18h]
  LONG shapeNumber; // [esp-Ch] [ebp-10h]
  LONG v9; // [esp-Ch] [ebp-10h]
  T_HazeTable *hazeTableMapFocus; // [esp-4h] [ebp-8h]

  if ( pWnd->a2.Unknown_39 )
  {
    if ( (WinMgr._wndIndex == pWnd->a2.index || a2 == 3) && pWnd->a2._mouseFocus && a2 != 2 )
    {
      pWnd->a2.pProcs->proc5((P_WndA2)pWnd, a2);
    }
    else
    {
      if ( pWnd->a2.shapeNumber == 0xFFFFFFFF )
      {
        v5 = 0xF2;
        if ( pWnd->buttonState == 0xFFFFFFFF )
        {
          v5 = 0x50;
        }
        VFX_pane_wipe(&pWnd->a2.pane, v5);
        WinMgr.LargeFont.pane = pWnd->a2.pane;
        if ( pWnd->a2._x == 0xFFFFFFFF && pWnd->a2._y == 0xFFFFFFFF )
        {
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, pWnd->a2.name, 3u, 0xFFFF, 0xFF, 0);
        }
        else
        {
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, pWnd->a2._x, pWnd->a2._y, pWnd->a2.name, 0, 0xFFFF, 0xFF, 0);
        }
        if ( pWnd->a2.framed == 0xFFFFFFFF )
        {
          VFX_line_draw(&pWnd->a2.pane, 0, 0, pWnd->a2.pane.x1 - pWnd->a2.pane.x0, 0, 0, 0xF3);
          VFX_line_draw(&pWnd->a2.pane, 0, 0, 0, pWnd->a2.pane.y1 - pWnd->a2.pane.y0, 0, 0xF3);
          v7 = pWnd->a2.pane.y1 - pWnd->a2.pane.y0;
          VFX_line_draw(&pWnd->a2.pane, pWnd->a2.pane.x1 - pWnd->a2.pane.x0, v7, 0, v7, 0, 0xF3);
          v6 = pWnd->a2.pane.x1 - pWnd->a2.pane.x0;
          VFX_line_draw(&pWnd->a2.pane, v6, pWnd->a2.pane.y1 - pWnd->a2.pane.y0, v6, 0, 0, 0xF3);
        }
      }
      else
      {
        p_pane = &pWnd->a2.pane;
        if ( pWnd->buttonState == 0xFFFFFFFF )
        {
          hazeTableMapFocus = WinMgr.hazeTableMapFocus;
          (*WinMgr.hazeTableMapFocus)[0xF2] = 0x50;
          VFX_shape_lookaside((UBYTE *)hazeTableMapFocus);
          shapeNumber = pWnd->a2.shapeNumber;
          ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.shapeCacheIndex);
          VFX_shape_translate_draw(p_pane, ShapeTable_sub_1B084, shapeNumber, 0, 0);
          (*WinMgr.hazeTableMapFocus)[0xF2] = 0x96;
        }
        else
        {
          v9 = pWnd->a2.shapeNumber;
          v4 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.shapeCacheIndex);
          VFX_shape_draw(p_pane, v4, v9, 0, 0);
        }
      }
      Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, pWnd->a2.pane.x0, pWnd->a2.pane.y0, pWnd->a2.pane.x1, pWnd->a2.pane.y1);
    }
    if ( pWnd->a2.childrenNum )
    {
      sub_2D218(&pWnd->a2);
    }
  }
}

//----- (0002D79C) --------------------------------------------------------
void __fastcall Q_Wnd25TW_Proc5_sub_2D79C(P_Wnd25TW pWnd, int a2)
{
  PANE *p_pane; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v4; // eax
  LONG v5; // eax
  LONG v6; // [esp-18h] [ebp-20h]
  LONG v7; // [esp-14h] [ebp-1Ch]
  LONG shapeNumber; // [esp-Ch] [ebp-14h]
  LONG v9; // [esp-Ch] [ebp-14h]
  T_HazeTable *hazeTableMapFocus; // [esp-4h] [ebp-Ch]
  PANE *pane; // [esp+0h] [ebp-8h]

  if ( pWnd->a2.shapeNumber == 0xFFFFFFFF )
  {
    v5 = 0x96;
    if ( pWnd->buttonState == 0xFFFFFFFF )
    {
      v5 = 0xCA;
    }
    pane = &pWnd->a2.pane;
    VFX_pane_wipe(&pWnd->a2.pane, v5);
    WinMgr.LargeFont.pane = pWnd->a2.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, pWnd->a2.name, 3u, 0xFFFF, 0xFF, 0);
    if ( pWnd->a2.framed == 0xFFFFFFFF )
    {
      VFX_line_draw(pane, 0, 0, pWnd->a2.pane.x1 - pWnd->a2.pane.x0, 0, 0, 0xF3);
      VFX_line_draw(pane, 0, 0, 0, pWnd->a2.pane.y1 - pWnd->a2.pane.y0, 0, 0xF3);
      v7 = pWnd->a2.pane.y1 - pWnd->a2.pane.y0;
      VFX_line_draw(pane, pWnd->a2.pane.x1 - pWnd->a2.pane.x0, v7, 0, v7, 0, 0xF3);
      v6 = pWnd->a2.pane.x1 - pWnd->a2.pane.x0;
      VFX_line_draw(pane, v6, pWnd->a2.pane.y1 - pWnd->a2.pane.y0, v6, 0, 0, 0xF3);
    }
  }
  else
  {
    p_pane = &pWnd->a2.pane;
    if ( pWnd->buttonState == 0xFFFFFFFF )
    {
      hazeTableMapFocus = WinMgr.hazeTableMapFocus;
      (*WinMgr.hazeTableMapFocus)[0xF2] = 0xCA;
      VFX_shape_lookaside((UBYTE *)hazeTableMapFocus);
      shapeNumber = pWnd->a2.shapeNumber;
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.shapeCacheIndex);
      VFX_shape_translate_draw(p_pane, ShapeTable_sub_1B084, shapeNumber, 0, 0);
      (*WinMgr.hazeTableMapFocus)[0xF2] = 0x96;
    }
    else
    {
      VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapFocus);
      v9 = pWnd->a2.shapeNumber;
      v4 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.shapeCacheIndex);
      VFX_shape_translate_draw(p_pane, v4, v9, 0, 0);
    }
  }
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, pWnd->a2.pane.x0, pWnd->a2.pane.y0, pWnd->a2.pane.x1, pWnd->a2.pane.y1);
}

//----- (0002D99C) --------------------------------------------------------
void __fastcall Q_Wnd25TW_Proc6_sub_2D99C(P_Wnd25TW pWnd, P_CFile pfi, BOOL read)
{
  int *p_buttonState; // edx

  p_buttonState = &pWnd->buttonState;
  if ( read == 0xFFFFFFFF )
  {
    Q_CFile_Read_sub_1BF94(pfi, p_buttonState, 4u);
  }
  else
  {
    Q_CFile_Write_sub_1C098(pfi, p_buttonState, 4u);
  }
}

//----- (0002D9C4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd03CTW_Ctor_sub_2D9C4(P_Wnd03CTW pWnd)
{
  Q_WndA2_Ctor_sub_2C830(&pWnd->a2);
  pWnd->a2.pProcs = &Wnd03CTW_Procs;
  pWnd->pControls = 0;
  pWnd->numControls = 0;
  pWnd->e = 0xFFFF;
  Q_Wnd03CTW_Init_sub_2DA60((P_Wnd)pWnd);
}

//----- (0002D9FC) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd03CTW_Dtor_sub_2D9FC(P_Wnd03CTW pWnd, char a2)
{
  char *v4; // eax
  P_Control pControls; // edx

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(pWnd, &C_Wnd03CTW);
    operator delete[](v4);
  }
  else
  {
    pControls = pWnd->pControls;
    pWnd->a2.pProcs = &Wnd03CTW_Procs;
    if ( pControls )
    {
      Q_RemoveWinDataFromWinMgr_sub_262CC(pControls);
      pWnd->pControls = 0;
    }
    Q_WndA2_Dtor_sub_2C848(&pWnd->a2, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(pWnd);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002DA60) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd03CTW_Init_sub_2DA60(P_Wnd pWnd)
{
  pWnd->Unknown_59 = 7;
}

//----- (0002DA68) --------------------------------------------------------
void __fastcall Q_Wnd03CTW_Register_sub_2DA68(P_Wnd03CTW a1)
{
  a1->a2.index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, &a1->a2);
}

//----- (0002DA80) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Wnd03CTW_AllocateControls_sub_2DA80(P_Wnd03CTW a1, __int16 numControls)
{
  MACRO_VFX_BOOL result; // eax

  if ( numControls <= 0 )
  {
    return FALSE;
  }
  result = (MACRO_VFX_BOOL)Q_AllocAndAddToWinMgr_sub_262B0(numControls, 0xEu, 1, "CONTROLS");
  a1->pControls = (P_Control)result;
  if ( result )
  {
    result = TRUE;
    a1->numControls = numControls;
  }
  return result;
}

//----- (0002DAC8) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Wnd03CTW_SetControl_sub_2DAC8(P_Wnd03CTW pWnd, __int16 mask, __int16 a3, P_Control pControl)
{
  int v5; // eax
  T_Control *v6; // edi
  int i; // eax

  for ( i = 0; i < pWnd->numControls && mask != pWnd->pControls[i].mask; ++i )
  {
    ;
  }
  if ( i >= pWnd->numControls )
  {
    return FALSE;
  }
  v5 = i;
  if ( pControl )
  {
    v6 = &pWnd->pControls[v5];
    qmemcpy(v6, pControl, 0xCu);
    qmemcpy(&v6->Unknown_C, &pControl->Unknown_C, sizeof(v6->Unknown_C));
  }
  else
  {
    pWnd->pControls[v5].Unknown_A = a3;
  }
  return TRUE;
}

//----- (0002DB54) --------------------------------------------------------
void __fastcall Q_Wnd03CTW_Proc2_sub_2DB54(P_Wnd03CTW pWnd, WORD xOffset, WORD yOffset)
{
  LONG y0; // edi
  LONG y1; // ebp
  LONG v6; // ecx
  __int16 numControls; // dx
  int v8; // edx
  int v9; // ebx

  y0 = pWnd->a2.pane.y0;
  y1 = pWnd->a2.pane.y1;
  v6 = xOffset + pWnd->a2.pane.x1;
  pWnd->a2.pane.x0 += xOffset;
  pWnd->a2.pane.x1 = v6;
  pWnd->a2.pane.y0 = yOffset + y0;
  numControls = pWnd->numControls;
  pWnd->a2.pane.y1 = yOffset + y1;
  v9 = 0;
  if ( numControls > 0 )
  {
    do
    {
      v8 = (__int16)v9;
      pWnd->pControls[v8].x0 += xOffset;
      pWnd->pControls[v8].x1 += xOffset;
      pWnd->pControls[v8].y0 += yOffset;
      pWnd->pControls[v8].y1 += yOffset;
      ++v9;
    }
    while ( (__int16)v9 < pWnd->numControls );
  }
}

//----- (0002DBE4) --------------------------------------------------------
int __fastcall Q_Wnd03CTW_sub_2DBE4(P_Wnd03CTW pWnd, int a2, int a3)
{
  int v4; // ecx
  int e; // eax
  T_Control *v6; // eax
  int v7; // edx
  T_Control *v8; // eax

  v4 = a2;
  e = pWnd->e;
  if ( e != 0xFFFFFFFF )
  {
    v6 = &pWnd->pControls[e];
    if ( a2 <= v6->x1 && a2 >= v6->x0 && a3 <= v6->y1 && a3 >= v6->y0 )
    {
      LOWORD(a2) = pWnd->e;
      return a2;
    }
  }
  v7 = 0;
  if ( pWnd->numControls <= 0 )
  {
    return 0xFFFFFFFF;
  }
  while ( 1 )
  {
    v8 = &pWnd->pControls[(__int16)v7];
    if ( v4 <= v8->x1 && v4 >= v8->x0 && a3 <= v8->y1 && a3 >= v8->y0 )
    {
      break;
    }
    if ( (__int16)++v7 >= pWnd->numControls )
    {
      return 0xFFFFFFFF;
    }
  }
  return v7;
}

//----- (0002DCA0) --------------------------------------------------------
void __fastcall Q_Wnd03CTW_sub_2DCA0(P_Wnd03CTW pWnd, __int16 a2)
{
  int e; // edx
  T_Control *v5; // eax

  if ( a2 != pWnd->e )
  {
    if ( a2 >= pWnd->numControls )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x396);
    }
    e = pWnd->e;
    if ( e != 0xFFFFFFFF )
    {
      LOBYTE(pWnd->pControls[e].Unknown_A) &= ~2;
    }
    if ( a2 != 0xFFFFFFFF )
    {
      v5 = &pWnd->pControls[a2];
      if ( (v5->Unknown_A & 1) != 0 )
      {
        LOBYTE(v5->Unknown_A) |= 2u;
      }
    }
    pWnd->e = a2;
  }
}

//----- (0002DD2C) --------------------------------------------------------
void __fastcall Q_Wnd03CTW_NC_sub_2DD2C(P_Wnd03CTW pWnd, __int16 a2, __int16 a3)
{
  P_Control pControls; // esi
  WORD Unknown_C; // di

  pControls = pWnd->pControls;
  Unknown_C = pControls[a2].Unknown_C;
  pControls[a2].Unknown_C = pControls[a3].Unknown_C;
  pWnd->pControls[a3].Unknown_C = Unknown_C;
}

//----- (0002DD70) --------------------------------------------------------
void __fastcall Q_Wnd03CTW_sub_2DD70(P_Wnd03CTW pWnd03CTW)
{
  int i; // eax

  for ( i = 0; (__int16)i < V_Game.racesNum; ++i )
  {
    pWnd03CTW->pControls[(__int16)i].Unknown_C = 5 * V_Game.races[(__int16)i].colorSet + 20;
  }
}

//----- (0002DDB8) --------------------------------------------------------
unsigned int __fastcall Q_Wnd03CTW_sub_2DDB8(P_Wnd03CTW pWnd, __int16 a2)
{
  T_Control *v2; // eax

  if ( a2 >= pWnd->numControls )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x3CD);
  }
  if ( a2 == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x3CE);
  }
  v2 = &pWnd->pControls[a2];
  if ( (v2->Unknown_A & 1) == 0 )
  {
    return 0;
  }
  if ( (v2->Unknown_A & 4) != 0 )
  {
    LOBYTE(v2->Unknown_A) &= ~4u;
  }
  else
  {
    LOBYTE(v2->Unknown_A) |= 4u;
  }
  return 0xFFFFFFFF;
}

//----- (0002DE68) --------------------------------------------------------
int __fastcall Q_Wnd03CTW_Proc3_sub_2DE68(P_Wnd03CTW pWnd, UWORD message, int param1, int param2)
{
  int result; // eax
  __int16 v6; // ax
  __int16 v7; // bx
  int soundNumber; // edx
  int v9; // edi
  unsigned int v10; // ebx
  __int16 i; // [esp+6h] [ebp-Ch]

  switch ( message )
  {
    case 1u:
      Q_Wnd03CTW_sub_2DD70(pWnd);
      Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
      goto LABEL_3;
    case 4u:
    case 5u:
      if ( param1 < pWnd->a2.pane.x0 || param1 > pWnd->a2.pane.x1 || param2 < pWnd->a2.pane.y0 || param2 > pWnd->a2.pane.y1 )
      {
LABEL_3:
        result = 0;
      }
      else
      {
        v7 = Q_Wnd03CTW_sub_2DBE4(pWnd, param1, param2);
        if ( v7 != 0xFFFFFFFF )
        {
          soundNumber = pWnd->a2.soundNumber;
          if ( soundNumber != 0xFFFFFFFF )
          {
            Q_SSystem_StartSample_sub_4FB90(&V_SSystem, soundNumber);
          }
          v9 = v7;
          Q_Wnd03CTW_sub_2DCA0(pWnd, v7);
          v10 = Q_Wnd03CTW_sub_2DDB8(pWnd, v7);
          pWnd->a2.pProcs->proc4_draw(&pWnd->a2, 0);
          if ( v10 == 0xFFFFFFFF )
          {
            if ( pWnd->a2.parentIndex )
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd->a2.parentIndex, pWnd->a2.sendMessage, pWnd->pControls[v9].mask, 0);
            }
          }
        }
        result = 0xFFFFFFFF;
      }
      break;
    case 6u:
      Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWnd->a2.index, 0xFFFF);
      result = 0xFFFFFFFF;
      break;
    case 7u:
      Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, pWnd->a2.index, 4, 8, 0, 0);
      result = 0xFFFFFFFF;
      break;
    case 8u:
      v6 = Q_Wnd03CTW_sub_2DBE4(pWnd, param1, param2);
      if ( v6 != pWnd->e )
      {
        Q_Wnd03CTW_sub_2DCA0(pWnd, v6);
        pWnd->a2.pProcs->proc4_draw(&pWnd->a2, 0);
      }
      result = 0xFFFFFFFF;
      break;
    case 9u:
      if ( param1 == 0xFFFFFFFF )
      {
        for ( i = 0; i < pWnd->numControls; ++i )
        {
          Q_Wnd03CTW_SetControl_sub_2DAC8(pWnd, 1 << i, param2, 0);
        }
      }
      else
      {
        Q_Wnd03CTW_SetControl_sub_2DAC8(pWnd, param1, param2, 0);
      }
      result = 0xFFFFFFFF;
      break;
    default:
      result = Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
      break;
  }
  return result;
}

//----- (0002E084) --------------------------------------------------------
void __fastcall Q_Wnd03CTW_Proc4_sub_2E084(P_Wnd03CTW pWnd, int a2)
{
  __int16 v2; // si
  void *pShapeTable; // eax MAPDST
  T_Control *v5; // ecx
  LONG shapeNumber; // [esp-Ch] [ebp-18h]
  LONG v8; // [esp-Ch] [ebp-18h]
  LONG v9; // [esp-8h] [ebp-14h]
  LONG v10; // [esp-4h] [ebp-10h]
  __int16 i; // [esp+8h] [ebp-4h]

  shapeNumber = pWnd->a2.shapeNumber;
  pShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.shapeCacheIndex);
  VFX_shape_draw(&pWnd->a2.pane, pShapeTable, shapeNumber, 0, 0);
  for ( i = 0; i < pWnd->numControls; ++i )
  {
    v5 = &pWnd->pControls[i];
    switch ( v5->Unknown_A )
    {
      case 0:
        v2 = 4;
        break;
      case 1:
        v2 = 0;
        break;
      case 3:
        v2 = 1;
        break;
      case 5:
        v2 = 2;
        break;
      case 7:
        v2 = 3;
        break;
      default:
        Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x48A);
        break;
    }
    v10 = v5->y0 - pWnd->a2.pane.y0;
    v9 = v5->x0 - pWnd->a2.pane.x0;
    v8 = v5->Unknown_C + v2;
    pShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.shapeCacheIndex);
    VFX_shape_draw(&pWnd->a2.pane, pShapeTable, v8, v9, v10);
  }
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, pWnd->a2.pane.x0, pWnd->a2.pane.y0, pWnd->a2.pane.x1, pWnd->a2.pane.y1);
}
// 2E156: variable 'v2' is possibly undefined

//----- (0002E1B4) --------------------------------------------------------
void __fastcall Q_Wnd03CTW_Proc6_sub_2E1B4(P_Wnd03CTW pWnd, P_CFile pfi, BOOL read)
{
  if ( read == TRUE )
  {
    Q_CFile_Read_sub_1BF94(pfi, pWnd->pControls, 0xE * pWnd->numControls);
  }
  else
  {
    Q_CFile_Write_sub_1C098(pfi, pWnd->pControls, 0xE * pWnd->numControls);
  }
}

//----- (0002E208) --------------------------------------------------------
void __fastcall Q_DefaultDrawItemFunc_sub_2E208(PANE *pPane, void *pData, int param1, BOOL hovered)
{
  WORD wipeColor; // bx

  wipeColor = 0xF2;
  if ( hovered == 0xFFFFFFFF )
  {
    wipeColor = 0x96;
  }
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, (const char *)pData, 0, 0xFFFF, wipeColor, 0);
}

//----- (0002E248) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd10LB_Ctor_sub_2E248(P_Wnd10LB pListBox)
{
  Q_WndA2_Ctor_sub_2C830(&pListBox->a2);
  pListBox->a2.pProcs = &Wnd10LB_Procs;
  Q_Wnd10LB_Init_sub_2E2B8(pListBox);
}

//----- (0002E264) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd10LB_Dtor_sub_2E264(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd10LB);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = &Wnd10LB_Procs;
    Q_Wnd10LB_Clear_sub_2ED4C((P_Wnd10LB)a1);
    Q_Wnd10LB_FinalizeMemPool_sub_2F2B4((P_Wnd10LB)a1);
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002E2B8) --------------------------------------------------------
void __fastcall Q_Wnd10LB_Init_sub_2E2B8(P_Wnd10LB pListBox)
{
  __int16 Height_sub_2B594; // ax

  Q_Wnd_Init_sub_2C8E4((P_Wnd)pListBox);
  pListBox->Unknown_AB = 0;
  pListBox->Unknown_AF = 0;
  pListBox->hasScrollBar = 0;
  pListBox->Unknown_B7 = 0;
  pListBox->Unknown_BB = 0;
  pListBox->_borderColor = 0x31;
  pListBox->Unknown_C5 = 0xF2;
  pListBox->wipeColor = 0;
  memset(pListBox->items, 0, sizeof(pListBox->items));
  pListBox->itemCount = 0;
  Height_sub_2B594 = Q_Font_GetHeight_sub_2B594(&WinMgr.LargeFont);
  pListBox->_scrollOffset = 0;
  pListBox->_selectedIndex = 0;
  pListBox->hoveredItemIndex = 0xFFFF;
  pListBox->scrollThumbState = 0;
  pListBox->memPoolAllocated = 0;
  pListBox->pMemPool = 0;
  pListBox->Unknown_8EE = 0;
  pListBox->memPoolSize = 0;
  pListBox->_defaultItemHeight = Height_sub_2B594 + 3;
  pListBox->getItemHeightFunc = 0;
  Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pListBox, Q_DefaultDrawItemFunc_sub_2E208);
  pListBox->a2.shapeCacheIndex = GwshareShpCacheIndexes[0x24];// 36: data\listbox.shp
  Q_Wnd10LB_InitScrollBar_sub_2E9CC(pListBox, 1);
}

//----- (0002E3BC) --------------------------------------------------------
void __fastcall Q_Wnd10LB_Register_sub_2E3BC(P_Wnd10LB a1)
{
  a1->a2.index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, &a1->a2);
}

//----- (0002E3D4) --------------------------------------------------------
int __fastcall Q_Wnd10LB_Proc3_sub_2E3D4(P_Wnd10LB pWnd, UWORD message, int param1, int param2)
{
  P_Procs pProcs; // ebx
  int v8; // eax
  int v9; // edx
  UWORD selectedIndex; // ax
  int v11; // eax
  int v12; // edx
  UWORD v13; // dx
  P_Procs v14; // ebx

  if ( message < 8u )
  {
    if ( message < 4u )
    {
      if ( message == 1 )
      {
        Q_Wnd10LB_InitScrollBar_sub_2E9CC(pWnd, pWnd->largeScrollBar);
        return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, 1u, param1, param2);
      }
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
    }
    if ( message > 5u )
    {
      if ( message <= 6u )
      {
        Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWnd->a2.index, 0xFFFF);
        Q_WinMgr_sub_564C0(&WinMgr, pWnd->a2.index, 0xFFFFFFFF);
        pWnd->hoveredItemIndex = 0xFFFF;
        pProcs = pWnd->a2.pProcs;
        pWnd->scrollThumbState = 0;
        pProcs->proc4_draw(&pWnd->a2, 0);
      }
      else
      {
        Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, pWnd->a2.index, 4, 8, 0, 0);
        Q_Wnd10LB_MouseMessage_sub_2EDC8(pWnd, V_Mouse.x, V_Mouse.y);
      }
      return 0xFFFFFFFF;
    }
LABEL_11:
    if ( param1 < pWnd->a2.pane.x0 || param1 > pWnd->a2.pane.x1 || param2 < pWnd->a2.pane.y0 || param2 > pWnd->a2.pane.y1 )
    {
      return 0;
    }
    if ( message != 0xC || pWnd->a2.helpIndex[0] == 0x30 )
    {
      sub_2F090(pWnd, param1, param2, message);
      return 0xFFFFFFFF;
    }
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
  }
  if ( message <= 8u )
  {
    Q_Wnd10LB_MouseMessage_sub_2EDC8(pWnd, param1, param2);
    return 0xFFFFFFFF;
  }
  if ( message < 0x191u )
  {
    if ( message != 0xC )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
    }
    goto LABEL_11;
  }
  if ( message <= 0x191u )
  {
    v8 = sub_56528(&WinMgr, pWnd->a2.index, message);
    if ( v8 != 0xFFFF )
    {
      v9 = 2 * v8 / 3 - 1;
      if ( v9 < 0 )
      {
        v9 = 0;
      }
      sub_56564(&WinMgr, pWnd->a2.index, message, v9);
    }
    selectedIndex = pWnd->_selectedIndex;
    if ( selectedIndex )
    {
      pWnd->_selectedIndex = selectedIndex - 1;
      pWnd->a2.pProcs->proc4_draw((P_WndA2)pWnd, 0);
    }
    return 0xFFFFFFFF;
  }
  else
  {
    if ( message > 0x192u )
    {
      if ( message == 0x193 )
      {
        Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWnd->a2.index, 0x193);
        Q_WinMgr_sub_564C0(&WinMgr, pWnd->a2.index, 0xFFFFFFFF);
        return 0xFFFFFFFF;
      }
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1, param2);
    }
    v11 = sub_56528(&WinMgr, pWnd->a2.index, message);
    if ( v11 != 0xFFFF )
    {
      v12 = 2 * v11 / 3 - 1;
      if ( v12 < 0 )
      {
        v12 = 0;
      }
      sub_56564(&WinMgr, pWnd->a2.index, message, v12);
    }
    v13 = pWnd->_selectedIndex;
    if ( v13 < pWnd->itemCount - (pWnd->a2.pane.y1 - pWnd->a2.pane.y0) / pWnd->_defaultItemHeight )
    {
      v14 = pWnd->a2.pProcs;
      pWnd->_selectedIndex = v13 + 1;
      v14->proc4_draw(&pWnd->a2, 0);
    }
    return 0xFFFFFFFF;
  }
}

//----- (0002E6C0) --------------------------------------------------------
void __fastcall Q_Wnd10LB_Proc4_sub_2E6C0(P_Wnd10LB pWnd, int a2)
{
  LONG v3; // edi
  signed __int16 selectedIndex; // di
  unsigned int v5; // ebp
  UWORD defaultItemHeight; // ax
  LONG y1; // ecx
  T_ListBoxItem *v8; // ebx
  int v9[2]; // [esp+0h] [ebp-30h] BYREF
  int v10; // [esp+8h] [ebp-28h]
  int v11; // [esp+Ch] [ebp-24h]
  LONG v12; // [esp+10h] [ebp-20h]
  LONG x1; // [esp+14h] [ebp-1Ch]
  T_ListBoxItem *items; // [esp+18h] [ebp-18h]

  VFX_pane_wipe(&pWnd->a2.pane, pWnd->Unknown_C5);
  x1 = pWnd->a2.pane.x1 - pWnd->a2.pane.x0;
  v3 = pWnd->a2.pane.y1 - pWnd->a2.pane.y0;
  VFX_line_draw(&pWnd->a2.pane, 0, 0, x1, 0, 0, pWnd->_borderColor);
  VFX_line_draw(&pWnd->a2.pane, 0, 0, 0, v3, 0, pWnd->_borderColor);
  VFX_line_draw(&pWnd->a2.pane, x1, v3, x1, 0, 0, pWnd->_borderColor);
  VFX_line_draw(&pWnd->a2.pane, x1, v3, 0, v3, 0, pWnd->_borderColor);
  if ( pWnd->hasScrollBar == 0xFFFFFFFF )
  {
    Q_Wnd10LB_DrawScrollBar_sub_2E868(pWnd, 0);
  }
  v9[1] = pWnd->a2.pane.x0 + 1;
  v10 = pWnd->a2.pane.y0 + 1;
  v9[0] = (int)pWnd->a2.pane.window;
  v11 = pWnd->a2.pane.x1 - 1;
  if ( pWnd->hasScrollBar == 0xFFFFFFFF )
  {
    v11 -= pWnd->scrollBarWidth;
  }
  selectedIndex = pWnd->_selectedIndex;
  v5 = 0;
  items = pWnd->items;
  while ( selectedIndex < (int)pWnd->itemCount && !v5 )
  {
    v8 = &items[selectedIndex];
    if ( pWnd->getItemHeightFunc )
    {
      defaultItemHeight = ((int (__fastcall *)(void *, int))pWnd->getItemHeightFunc)(v8->pData, v8->value);
    }
    else
    {
      defaultItemHeight = pWnd->_defaultItemHeight;
    }
    v12 = v10 + defaultItemHeight - 1;
    y1 = pWnd->a2.pane.y1;
    if ( v12 >= y1 )
    {
      v5 = 0xFFFFFFFF;
      v12 = y1 - 1;
    }
    pWnd->drawItemFunc((PANE *)v9, v8->pData, v8->value, (selectedIndex++ != pWnd->hoveredItemIndex) - 1);
    v10 = v12 + 1;
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pWnd->a2.pane);
}

//----- (0002E868) --------------------------------------------------------
void __fastcall Q_Wnd10LB_DrawScrollBar_sub_2E868(P_Wnd10LB pListBox, int refresh)
{
  LONG x1; // edi
  LONG x0; // edx
  int scrollBarWidth; // ebx
  LONG v6; // edi
  int centerLineY; // edx
  void *shapeTable; // eax MAPDST
  LONG shapeNumberArrowUp; // [esp-Ch] [ebp-34h]
  LONG shapeNumberArrowDown; // [esp-Ch] [ebp-34h]
  LONG hotX_; // [esp-8h] [ebp-30h]
  LONG wipeColor; // [esp-4h] [ebp-2Ch]
  LONG hotY_; // [esp-4h] [ebp-2Ch]
  PANE pane; // [esp+0h] [ebp-28h] BYREF
  LONG hotX; // [esp+14h] [ebp-14h]
  PANE *pPane; // [esp+18h] [ebp-10h]
  int refresh_; // [esp+1Ch] [ebp-Ch]
  LONG centerLineY_; // [esp+20h] [ebp-8h]
  LONG y1; // [esp+24h] [ebp-4h]

  refresh_ = refresh;
  x1 = pListBox->a2.pane.x1;
  x0 = pListBox->a2.pane.x0;
  scrollBarWidth = pListBox->scrollBarWidth;
  y1 = pListBox->a2.pane.y1 - pListBox->a2.pane.y0;
  v6 = x1 - x0 - scrollBarWidth;
  VFX_line_draw(&pListBox->a2.pane, v6, 0, v6, y1, LD_DRAW, pListBox->_borderColor);
  centerLineY = pListBox->a2.pane.y0 + (pListBox->a2.pane.y1 - pListBox->a2.pane.y0) / 2;
  pane.window = pListBox->a2.pane.window;
  pane.x0 = pListBox->a2.pane.x1 - pListBox->scrollBarWidth + 1;
  pane.x1 = pListBox->a2.pane.x1 - 1;
  pane.y0 = pListBox->a2.pane.y0 + 1;
  pane.y1 = pListBox->a2.pane.y1 - 1;
  wipeColor = pListBox->wipeColor;
  centerLineY_ = centerLineY;
  VFX_pane_wipe(&pane, wipeColor);
  if ( pListBox->scrollThumbState > 1u )
  {
    if ( pListBox->scrollThumbState == 2 )
    {
      pane.y1 = centerLineY_;
    }
    else
    {
      pane.y0 = centerLineY_;
    }
    VFX_pane_wipe(&pane, 0x96);
  }
  hotX = v6 + 2;
  shapeNumberArrowUp = pListBox->a2.shapeNumber;
  shapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pListBox->a2.shapeCacheIndex);
  pPane = &pListBox->a2.pane;
  VFX_shape_draw(&pListBox->a2.pane, shapeTable, shapeNumberArrowUp, v6 + 2, 2);
  hotY_ = y1 - pListBox->scrollBarWidth + 2;
  hotX_ = hotX;
  shapeNumberArrowDown = pListBox->a2.shapeNumber + 1;
  shapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pListBox->a2.shapeCacheIndex);
  VFX_shape_draw(pPane, shapeTable, shapeNumberArrowDown, hotX_, hotY_);
  if ( refresh_ == TRUE )
  {
    Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, v6 + pListBox->a2.pane.x0, pListBox->a2.pane.y0, pListBox->a2.pane.x1, pListBox->a2.pane.y1);
  }
}

//----- (0002E9CC) --------------------------------------------------------
void __fastcall Q_Wnd10LB_InitScrollBar_sub_2E9CC(P_Wnd10LB pListBox, char large)
{
  LONG shapeNumber; // eax
  void *ShapeTable_sub_1B084; // eax
  unsigned int resolution; // eax
  int xResolution; // edx
  LONG x0; // eax
  LONG x1; // eax
  int hasScrollBar; // ecx
  LONG v10; // [esp-4h] [ebp-10h]

  if ( large == 1 )
  {
    pListBox->a2.shapeNumber = 0;
  }
  else
  {
    pListBox->a2.shapeNumber = 2;
  }
  shapeNumber = pListBox->a2.shapeNumber;
  pListBox->largeScrollBar = large;
  v10 = shapeNumber;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pListBox->a2.shapeCacheIndex);
  resolution = VFX_shape_resolution(ShapeTable_sub_1B084, v10);
  pListBox->scrollBarWidth = resolution;
  pListBox->pane.window = pListBox->a2.pane.window;
  xResolution = HIWORD(resolution);
  x0 = pListBox->a2.pane.x0;
  pListBox->scrollBarWidth = xResolution;
  pListBox->pane.x0 = x0 + 1;
  x1 = pListBox->a2.pane.x1;
  pListBox->scrollBarWidth = xResolution + 3;
  hasScrollBar = pListBox->hasScrollBar;
  pListBox->pane.x1 = x1 - 1;
  if ( hasScrollBar == TRUE )
  {
    pListBox->pane.x1 -= pListBox->scrollBarWidth;
  }
}

//----- (0002EA8C) --------------------------------------------------------
int __fastcall Q_Wnd10LB_AddItem_sub_2EA8C(P_Wnd10LB pListBox, BYTE *pData, WORD a3, BOOL bRedraw)
{
  __int16 defaultItemHeight; // di
  int scrollOffset; // edx
  int scrollBarWidth; // eax
  LONG x1; // edi
  size_t v10; // kr04_4
  void *v11; // eax
  int Unknown_8EE; // ecx
  int result; // eax
  char *v15; // [esp+4h] [ebp-10h]

  defaultItemHeight = a3;
  if ( pListBox->itemCount >= 256u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x62A);
  }
  if ( a3 == 0xFFFFFFFF )
  {
    defaultItemHeight = pListBox->_defaultItemHeight;
  }
  pListBox->_scrollOffset += defaultItemHeight;
  scrollOffset = pListBox->_scrollOffset;
  if ( (unsigned __int16)scrollOffset > pListBox->a2.pane.y1 - pListBox->a2.pane.y0 - 1 )
  {
    if ( pListBox->Unknown_B7 == 0xFFFFFFFF )
    {
      pListBox->a2.pane.y1 = pListBox->a2.pane.y0 + scrollOffset + 2;
    }
    else if ( !pListBox->hasScrollBar )
    {
      scrollBarWidth = pListBox->scrollBarWidth;
      x1 = pListBox->pane.x1;
      pListBox->hasScrollBar = TRUE;
      pListBox->pane.x1 = x1 - scrollBarWidth;
    }
  }
  if ( pListBox->Unknown_AB == 0xFFFFFFFF )
  {
    v10 = strlen(pData) + 1;
    if ( pListBox->memPoolAllocated )
    {
      Unknown_8EE = pListBox->Unknown_8EE;
      if ( pListBox->memPoolSize - Unknown_8EE < v10 )
      {
        Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x653);
        return 0xFFFFFFFF;
      }
      v15 = (char *)pListBox->pMemPool + Unknown_8EE;
      pListBox->Unknown_8EE += v10;
    }
    else
    {
      v11 = operator new[](v10);
      Q_RegisterDataInWinMgr_sub_2625C(v11, 1, "LISTBOX STRING");
      v15 = (char *)v11;
      if ( !v11 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x648);
      }
    }
    strcpy(v15, pData);
    pData = v15;
  }
  pListBox->items[pListBox->itemCount].pData = pData;
  pListBox->items[pListBox->itemCount].value = 0;
  HIWORD(result) = HIWORD(bRedraw);
  ++pListBox->itemCount;
  if ( bRedraw == TRUE )
  {
    pListBox->a2.pProcs->proc4_draw(&pListBox->a2, 0);
  }
  LOWORD(result) = pListBox->itemCount;
  // Return index of new item
  return result;
}

//----- (0002EC50) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Wnd10LB_SetItemValue_sub_2EC50(P_Wnd10LB pListBox, unsigned __int16 itemIndex, int value)
{
  MACRO_VFX_BOOL true; // eax

  if ( itemIndex >= 256u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x66B);
  }
  if ( !pListBox->items[itemIndex].pData )
  {
    return FALSE;
  }
  true = TRUE;
  pListBox->items[itemIndex].value = value;
  return true;
}

//----- (0002ECA4) --------------------------------------------------------
int __fastcall Q_Wnd10LB_GetItemValue_sub_2ECA4(P_Wnd10LB pListBox, unsigned __int16 itemIndex)
{
  if ( itemIndex >= 256u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x679);
  }
  return pListBox->items[itemIndex].value;
}

//----- (0002ECDC) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd10LB_SetSelectedIndex_sub_2ECDC(P_Wnd10LB pListBox, UWORD index)
{
  if ( pListBox->_scrollOffset > pListBox->a2.pane.y1 - pListBox->a2.pane.y0 - 1 && index < pListBox->itemCount )
  {
    pListBox->hoveredItemIndex = 0xFFFF;
    pListBox->_selectedIndex = index;
  }
}

//----- (0002ED14) --------------------------------------------------------
void *__fastcall Q_Wnd10LB_GetItemData_sub_2ED14(P_Wnd10LB pListBox, unsigned __int16 itemIndex)
{
  if ( itemIndex >= 256u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x68D);
  }
  return pListBox->items[itemIndex].pData;
}

//----- (0002ED4C) --------------------------------------------------------
void __fastcall Q_Wnd10LB_Clear_sub_2ED4C(P_Wnd10LB pListBox)
{
  LONG x1; // eax
  int Unknown_AF; // edx
  int i; // edx

  pListBox->Unknown_8EE = 0;
  for ( i = 0; i < pListBox->itemCount; ++i )
  {
    if ( pListBox->items[i].pData )
    {
      pListBox->items[i].pData = 0;
    }
  }
  pListBox->itemCount = 0;
  pListBox->_scrollOffset = 0;
  pListBox->hoveredItemIndex = 0xFFFF;
  x1 = pListBox->a2.pane.x1;
  pListBox->_selectedIndex = 0;
  Unknown_AF = pListBox->Unknown_AF;
  pListBox->pane.x1 = x1 - 1;
  if ( !Unknown_AF )
  {
    pListBox->hasScrollBar = 0;
  }
}

//----- (0002EDC8) --------------------------------------------------------
void __fastcall Q_Wnd10LB_MouseMessage_sub_2EDC8(P_Wnd10LB pScrollBar, unsigned int mouseX, unsigned int mouseY)
{
  unsigned int x1; // eax
  UWORD selectedIndex; // di
  UWORD itemCount; // dx
  unsigned int v8; // ebx
  UWORD v9; // cx
  int itemHeight; // eax
  LONG y1; // edx
  unsigned int v12; // edx
  unsigned int scrollThumbState; // eax
  UBYTE v14; // al
  int hasScrollBar; // edx
  T_Wnd10LB *v16; // eax
  LONG Unknown_C5; // [esp-4h] [ebp-18h]

  // Handle existing hover state
  if ( pScrollBar->hoveredItemIndex != 0xFFFFFFFF )
  {
    // Check if mouse is still over the same item
    if ( mouseY >= pScrollBar->pane.y0 && mouseY <= pScrollBar->pane.y1 && mouseX <= pScrollBar->pane.x1 )
    {
      if ( pScrollBar->Unknown_BB == 0xFFFFFFFF )
      {
        // Keep item highlighted (mouse still over it)
        VFX_pane_wipe(&pScrollBar->pane, pScrollBar->Unknown_C5);
        pScrollBar->drawItemFunc(
          &pScrollBar->pane,
          pScrollBar->items[pScrollBar->hoveredItemIndex].pData,
          pScrollBar->items[pScrollBar->hoveredItemIndex].value,
          TRUE);
        Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pScrollBar->pane);
      }
      return;
    }
    // Remove highlight from previously hovered item
    VFX_pane_wipe(&pScrollBar->pane, pScrollBar->Unknown_C5);
    pScrollBar->drawItemFunc(
      &pScrollBar->pane,
      pScrollBar->items[pScrollBar->hoveredItemIndex].pData,
      pScrollBar->items[pScrollBar->hoveredItemIndex].value,
      FALSE);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pScrollBar->pane);
    pScrollBar->hoveredItemIndex = 0xFFFF;
  }
  x1 = pScrollBar->a2.pane.x1;
  if ( pScrollBar->hasScrollBar == 0xFFFFFFFF )
  {
    x1 -= pScrollBar->scrollBarWidth;
  }
  if ( x1 <= mouseX )
  {
    if ( pScrollBar->hasScrollBar != TRUE )
    {
      return;
    }
    v12 = pScrollBar->a2.pane.y0 + (pScrollBar->a2.pane.y1 - pScrollBar->a2.pane.y0) / 2;
    scrollThumbState = pScrollBar->scrollThumbState;
    if ( scrollThumbState > 1 )
    {
      if ( mouseY <= v12 )
      {
        if ( scrollThumbState == 2 )
        {
          return;
        }
        hasScrollBar = pScrollBar->hasScrollBar;
        v16 = pScrollBar;
        pScrollBar->scrollThumbState = 2;
      }
      else
      {
        if ( scrollThumbState == 3 )
        {
          return;
        }
        hasScrollBar = pScrollBar->hasScrollBar;
        v16 = pScrollBar;
        pScrollBar->scrollThumbState = 3;
      }
    }
    else
    {
      v14 = (mouseY > v12) + 2;
      hasScrollBar = pScrollBar->hasScrollBar;
      pScrollBar->scrollThumbState = v14;
      v16 = pScrollBar;
    }
    Q_Wnd10LB_DrawScrollBar_sub_2E868(v16, hasScrollBar);
  }
  else
  {
    if ( pScrollBar->scrollThumbState > 1u )
    {
      pScrollBar->scrollThumbState = 1;
      Q_Wnd10LB_DrawScrollBar_sub_2E868(pScrollBar, 0xFFFFFFFF);
      Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pScrollBar->a2.index, 0x193);
      Q_WinMgr_sub_564C0(&WinMgr, pScrollBar->a2.index, 0xFFFFFFFF);
    }
    selectedIndex = pScrollBar->_selectedIndex;
    itemCount = pScrollBar->itemCount;
    v8 = 0;
    pScrollBar->pane.y0 = pScrollBar->a2.pane.y0 + 1;
    if ( selectedIndex < itemCount )
    {
      while ( !v8 )
      {
        v8 = 0;
        itemHeight = (int)pScrollBar->getItemHeightFunc;
        if ( itemHeight )
        {
          itemHeight = pScrollBar->getItemHeightFunc(pScrollBar->items[selectedIndex].pData, pScrollBar->items[selectedIndex].value, 0);
        }
        else
        {
          LOWORD(itemHeight) = pScrollBar->_defaultItemHeight;
        }
        pScrollBar->pane.y1 = pScrollBar->pane.y0 + itemHeight - 1;
        y1 = pScrollBar->a2.pane.y1;
        if ( pScrollBar->pane.y1 >= y1 )
        {
          v8 = 0xFFFFFFFF;
          pScrollBar->pane.y1 = y1 - 1;
        }
        if ( mouseY >= pScrollBar->pane.y0 && mouseY <= pScrollBar->pane.y1 )
        {
          Unknown_C5 = pScrollBar->Unknown_C5;
          pScrollBar->hoveredItemIndex = selectedIndex;
          VFX_pane_wipe(&pScrollBar->pane, Unknown_C5);
          pScrollBar->drawItemFunc(
            &pScrollBar->pane,
            pScrollBar->items[selectedIndex].pData,
            pScrollBar->items[selectedIndex].value,
            0xFFFFFFFF);
          Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pScrollBar->pane);
          return;
        }
        ++selectedIndex;
        v9 = pScrollBar->itemCount;
        pScrollBar->pane.y0 = pScrollBar->pane.y1 + 1;
        if ( selectedIndex >= v9 )
        {
          return;
        }
      }
    }
  }
}

//----- (0002F090) --------------------------------------------------------
void __fastcall sub_2F090(T_Wnd10LB *a1, unsigned int a2, unsigned int a3, __int16 a4)
{
  LONG hoveredItemIndex; // ecx
  int soundNumber; // edx
  int v8; // ebx

  if ( a1->a2.pane.x1 - a1->scrollBarWidth <= a2 )
  {
    if ( a1->hasScrollBar == 0xFFFFFFFF )
    {
      if ( a1->a2.pane.y0 + (a1->a2.pane.y1 - a1->a2.pane.y0) / 2 <= a3 )
      {
        a1->a2.pProcs->proc3_msg((P_WndA2)a1, 0x192, 0, 0);
        Q_WinMgr_sub_56400(&WinMgr, a1->a2.index, 0x192, 0, 0, 0x1E);
      }
      else
      {
        a1->a2.pProcs->proc3_msg((P_WndA2)a1, 0x191, 0, 0);
        Q_WinMgr_sub_56400(&WinMgr, a1->a2.index, 0x191, 0, 0, 0x1E);
      }
      v8 = 1;
      if ( a4 == 5 )
      {
        v8 = 2;
      }
      Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, a1->a2.index, v8, 0x193, 0, 0);
    }
  }
  else
  {
    hoveredItemIndex = a1->hoveredItemIndex;
    if ( hoveredItemIndex != 0xFFFFFFFF )
    {
      if ( WinMgr.Unknown_24DA4 )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a2.parentIndex, 0x1C02, hoveredItemIndex, a4);
      }
      else
      {
        soundNumber = a1->a2.soundNumber;
        if ( soundNumber != 0xFFFFFFFF )
        {
          Q_SSystem_StartSample_sub_4FB90(&V_SSystem, soundNumber);
        }
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a2.parentIndex, 0x1C01, a1->hoveredItemIndex, a4);
      }
      Q_Wnd10LB_MouseMessage_sub_2EDC8(a1, a2, a3);
    }
  }
}

//----- (0002F1C8) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(P_Wnd10LB listBox, P_DrawItemFunc func)
{
  listBox->drawItemFunc = func;
}

//----- (0002F1D8) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd10LB_SetCompareProc_sub_2F1D8(P_Wnd10LB result, void *proc)
{
  result->pfnCompareProc = proc;
}

//----- (0002F1E0) --------------------------------------------------------
void __fastcall Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(P_Wnd10LB pListBox)
{
  if ( !pListBox->pfnCompareProc )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x7AB);
  }
  qsort(pListBox->items, pListBox->itemCount, 8u, (int (__fastcall *)(const void *, const void *))pListBox->pfnCompareProc);
}

//----- (0002F228) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Wnd10LB_InitMemPool_sub_2F228(P_Wnd10LB pListBox, int size, void *pMemPool)
{
  MACRO_VFX_BOOL result; // eax

  Q_Wnd10LB_Clear_sub_2ED4C(pListBox);
  if ( pListBox->pMemPool )
  {
    Q_RemoveWinDataFromWinMgr_sub_262CC(pListBox->pMemPool);
    pListBox->pMemPool = 0;
  }
  if ( pMemPool )
  {
    pListBox->pMemPool = pMemPool;
  }
  else
  {
    pListBox->pMemPool = Q_Allocate_sub_2628C(size, 1, "LISTBOX MEMPOOL");
  }
  if ( pListBox->pMemPool )
  {
    pListBox->memPoolAllocated = TRUE;
    pListBox->Unknown_8EE = 0;
    result = TRUE;
    pListBox->memPoolSize = size;
  }
  else
  {
    pListBox->memPoolAllocated = 0;
    pListBox->memPoolSize = 0;
    result = FALSE;
    pListBox->Unknown_8EE = 0;
  }
  return result;
}

//----- (0002F2B4) --------------------------------------------------------
void __fastcall Q_Wnd10LB_FinalizeMemPool_sub_2F2B4(P_Wnd10LB pListBox)
{
  if ( pListBox->pMemPool )
  {
    Q_RemoveWinDataFromWinMgr_sub_262CC(pListBox->pMemPool);
    pListBox->pMemPool = 0;
  }
  pListBox->memPoolSize = 0;
  pListBox->Unknown_8EE = 0;
  pListBox->memPoolAllocated = 0;
}

//----- (0002F2F4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd15NT_Ctor_sub_2F2F4(P_Wnd15NT result)
{
  Q_WndA2_Ctor_sub_2C830(&result->a);
  result->a.pProcs = &Wnd15NT_Procs;
}

//----- (0002F30C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd15NT_Dtor_sub_2F30C(P_WndA2 pWnd, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd, &C_Wnd15NT);
    operator delete[](v3);
  }
  else
  {
    pWnd->pProcs = &Wnd15NT_Procs;
    Q_WndA2_Dtor_sub_2C848(pWnd, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(pWnd);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002F354) --------------------------------------------------------
void __fastcall Q_Wnd15NT_Proc4_sub_2F354(P_Wnd pWnd, int a2)
{
  void *ShapeTable_sub_1B084; // eax
  LONG v4; // ecx
  char *v5; // ebx
  void *v6; // eax
  __int16 i; // si
  STENCIL **p_stencil; // [esp-Ch] [ebp-20h]
  WORD v9; // [esp-4h] [ebp-18h]
  char s[12]; // [esp+0h] [ebp-14h] BYREF
  PANE *p_pane; // [esp+Ch] [ebp-8h]
  int a2a; // [esp+10h] [ebp-4h]

  p_stencil = &pWnd[1].pane.window->stencil;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->shapeCacheIndex);
  p_pane = &pWnd->pane;
  VFX_shape_draw(&pWnd->pane, ShapeTable_sub_1B084, (LONG)p_stencil, 0, 0);
  sprintf(s, "%05d", V_Game.day);
  a2a = (int)p_pane;
  for ( i = 0; i < 5; ++i )
  {
    v4 = 0x1F * i + 2;
    v9 = V_PlayerRaceIndex;
    v5 = (char *)&pWnd[1].pane.window[0xFFFFFFFE] + s[i] - 8;
    v6 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->shapeCacheIndex);
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a2a, v6, (LONG)v5, v4, 0, v9);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)a2a);
}
// 2F354: using guessed type char s[12];

//----- (0002F414) --------------------------------------------------------
void __fastcall Q_Wnd15NT_Proc5_sub_2F414(P_Wnd pWnd, int a2)
{
  (*(void (**)(void))(pWnd[1].magic12345678 + 0xC))();
}

//----- (0002F420) --------------------------------------------------------
int __fastcall Q_Wnd26MW_Proc3_sub_2F420(P_WndA2 pWnd, UWORD message, int param1, int param2)
{
  return Q_WndA2_Proc3_sub_2F424(pWnd, message, param1, param2);
}

//----- (0002F424) --------------------------------------------------------
int __fastcall Q_WndA2_Proc3_sub_2F424(P_WndA2 pWndA2, UWORD message, int param1, int param2)
{
  P_Procs pProcs; // ebp
  WORD sendMessage; // cx
  LONG sendParam2; // ebx
  int soundNumber; // edx
  int param1a; // [esp+2h] [ebp-10h]

  if ( message < 7u )
  {
    if ( message < 2u )
    {
      if ( message == 1 )
      {
        pWndA2->Unknown_39 = 0xFFFFFFFF;
        pProcs = pWndA2->pProcs;
        pWndA2->Unknown_35 = 0xFFFFFFFF;
        pProcs->proc4_draw(pWndA2, 0);
        Q_WndA2_CallChildrenProc3_sub_2D258(pWndA2, 1u, param1, param2);
        return 0;
      }
      return 0;
    }
    if ( message <= 2u )
    {
      Q_WndA2_CallChildrenProc3_sub_2D258(pWndA2, message, param1, param2);
      pWndA2->Unknown_39 = 0;
      pWndA2->Unknown_35 = 0;
      if ( pWndA2->index == WinMgr._wndIndex )
      {
        WinMgr._wndIndex = 0xFFFFFFFF;
      }
      Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWndA2->index, 0xFFFF);
      Q_WinMgr_sub_564C0(&WinMgr, pWndA2->index, 0xFFFFFFFF);
      return 0;
    }
    else
    {
      if ( message < 4u )
      {
        return 0;
      }
      if ( message <= 5u )
      {
        if ( param1 < pWndA2->pane.x0 || param1 > pWndA2->pane.x1 || param2 < pWndA2->pane.y0 || param2 > pWndA2->pane.y1 )
        {
          return 0;
        }
        sendMessage = pWndA2->sendMessage;
        param1a = pWndA2->sendParam1;
        sendParam2 = pWndA2->sendParam2;
        if ( sendMessage == 0x3E7 )
        {
          sendMessage = message;
        }
        if ( param1a == 0x3E7 )
        {
          param1a = (__int16)message;
        }
        if ( sendParam2 == 0x3E7 )
        {
          sendParam2 = (__int16)message;
        }
        soundNumber = pWndA2->soundNumber;
        if ( soundNumber != 0xFFFFFFFF )
        {
          Q_SSystem_StartSample_sub_4FB90(&V_SSystem, soundNumber);
        }
        if ( pWndA2->parentIndex )
        {
          if ( sendMessage == 0x3E6 )
          {
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, param1a, sendParam2, 0);
            return 0xFFFFFFFF;
          }
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWndA2->parentIndex, sendMessage, param1a, sendParam2);
        }
        else
        {
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, sendMessage, param1a, sendParam2);
        }
        return 0xFFFFFFFF;
      }
      else
      {
        if ( pWndA2->Unknown_39 && pWndA2->Unknown_35 && pWndA2->_mouseFocus )
        {
          pWndA2->pProcs->proc4_draw(pWndA2, 2);
        }
        return 0xFFFFFFFF;
      }
    }
  }
  else if ( message <= 7u )
  {
    if ( pWndA2->Unknown_39 && pWndA2->Unknown_35 && pWndA2->_mouseFocus )
    {
      pWndA2->pProcs->proc4_draw(pWndA2, 3);
    }
    return 0xFFFFFFFF;
  }
  else
  {
    if ( message >= 0xEu )
    {
      if ( message <= 0xEu )
      {
        pWndA2->Unknown_35 = 0xFFFFFFFF;
        pWndA2->Unknown_39 = 0xFFFFFFFF;
        return 0;
      }
      if ( message <= 0xFu )
      {
        pWndA2->Unknown_35 = 0;
        return 0;
      }
      if ( message >= 0xC9u )
      {
        if ( message > 0xCAu )
        {
          return 0;
        }
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, (__int16)message, 0);
        return 0xFFFFFFFF;
      }
      return 0;
    }
    if ( message != 0xC )
    {
      return 0;
    }
    if ( param1 < pWndA2->pane.x0 || param1 > pWndA2->pane.x1 || param2 < pWndA2->pane.y0 || param2 > pWndA2->pane.y1 )
    {
      return 0;
    }
    if ( pWndA2->helpIndex[0] != 0x30 )
    {
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)pWndA2->helpIndex, 0);
    }
    return 0xFFFFFFFF;
  }
}

//----- (0002F478) --------------------------------------------------------
int __fastcall Q_Wnd15NT_Proc3_sub_2F478(P_WndA2 pWnd, UWORD message, int param1, int param2)
{
  if ( message != 0xD )
  {
    return Q_Wnd26MW_Proc3_sub_2F420(pWnd, message, param1, param2);
  }
  pWnd->pProcs->proc4_draw(pWnd, 0);
  return 0;
}

//----- (0002F48C) --------------------------------------------------------
void __fastcall __spoils<> Q_WndEDITWND_Ctor_sub_2F48C(P_WndEDITWND pWnd)
{
  Q_WndA2_Ctor_sub_2C830(&pWnd->a2);
  pWnd->a2.pProcs = &WndEDITWND_Procs;
  Q_WndEDITWND_Init_sub_2F4EC(pWnd);
}

//----- (0002F4A8) --------------------------------------------------------
void __fastcall __spoils<edx> Q_WndEDITWND_Dtor_sub_2F4A8(P_WndA2 pWnd, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd, &C_WndEDITWND);
    operator delete[](v3);
  }
  else
  {
    pWnd->pProcs = &WndEDITWND_Procs;
    Q_WndA2_Dtor_sub_2C848(pWnd, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(pWnd);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002F4EC) --------------------------------------------------------
void __fastcall __spoils<> Q_WndEDITWND_Init_sub_2F4EC(P_WndEDITWND pWnd)
{
  pWnd->pText = 0;
  pWnd->textLength = 0;
  pWnd->maxTextLength = 0;
  pWnd->cursorPos = 0;
  pWnd->wipeColor = 0xF2;
  pWnd->pFont = &WinMgr.LargeFont;
  pWnd->Unknown_BD = 0xFFFFFFFF;
  pWnd->bgColor = (unsigned __int8)byte_96778;
}
// 96778: using guessed type char byte_96778;

//----- (0002F540) --------------------------------------------------------
void __fastcall Q_WndEDITWND_Proc4_sub_2F540(P_WndEDITWND pWnd, int a2)
{
  P_Font pFont; // eax
  char *pText; // ecx
  int cursorPos; // edx
  char *v6; // eax
  int TextWidth_sub_2B4F4; // eax
  LONG v8; // [esp-18h] [ebp-30h]
  LONG v9; // [esp-14h] [ebp-2Ch]
  WORD bgColor; // [esp-Ch] [ebp-24h]
  PANE *a2a; // [esp+0h] [ebp-18h]

  a2a = &pWnd->a2.pane;
  VFX_pane_wipe(&pWnd->a2.pane, pWnd->wipeColor);
  VFX_line_draw(a2a, 0, 0, pWnd->a2.pane.x1 - pWnd->a2.pane.x0, 0, 0, 0xF3);
  VFX_line_draw(a2a, 0, 0, 0, pWnd->a2.pane.y1 - pWnd->a2.pane.y0, 0, 0xF3);
  v9 = pWnd->a2.pane.y1 - pWnd->a2.pane.y0;
  VFX_line_draw(a2a, pWnd->a2.pane.x1 - pWnd->a2.pane.x0, v9, 0, v9, 0, 0xF3);
  v8 = pWnd->a2.pane.x1 - pWnd->a2.pane.x0;
  VFX_line_draw(a2a, v8, pWnd->a2.pane.y1 - pWnd->a2.pane.y0, v8, 0, 0, 0xF3);
  pFont = pWnd->pFont;
  bgColor = pWnd->bgColor;
  pText = pWnd->pText;
  pFont->pane = *a2a;
  Q_Font_DrawFormattedText_sub_2B8A8(pFont, 2, 4, pText, 0, bgColor, 0xFF, 0);
  cursorPos = pWnd->cursorPos;
  v6 = pWnd->pText;
  LOBYTE(pText) = v6[cursorPos];
  v6[cursorPos] = 0;
  TextWidth_sub_2B4F4 = Q_Font_GetTextWidth_sub_2B4F4(pWnd->pFont, pWnd->pText);
  pWnd->pText[pWnd->cursorPos] = (char)pText;
  VFX_line_draw(a2a, TextWidth_sub_2B4F4 + 2, 3, TextWidth_sub_2B4F4 + 2, pWnd->a2.pane.y1 - pWnd->a2.pane.y0 - 3, LD_DRAW, 0x98);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, a2a);
}

//----- (0002F6B0) --------------------------------------------------------
int __fastcall Q_WndEDITWND_Proc3_sub_2F6B0(P_WndEDITWND pWnd, UWORD message, int param1, int param2)
{
  int Unknown_BD; // ecx
  P_Procs pProcs; // ebx
  WORD cursorPos; // ax
  P_Procs v10; // ebx

  if ( message != 3 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, (unsigned __int8)param1, param2);
  }
  Unknown_BD = pWnd->Unknown_BD;
  pWnd->Unknown_BD = 0;
  if ( (char)param1 >= 0x30 && (char)param1 <= 0x39
    || (char)param1 >= 0x41 && (char)param1 <= 0x5A
    || (char)param1 >= 0x61 && (char)param1 <= 0x7A
    || (_BYTE)param1 == 0x20
    || (_BYTE)param1 == 0x2D )
  {
    if ( Unknown_BD )
    {
      pWnd->cursorPos = 0;
      pWnd->textLength = pWnd->cursorPos;
      *pWnd->pText = 0;
    }
    if ( pWnd->textLength < pWnd->maxTextLength && Q_Font_GetTextWidth_sub_2B4F4(&WinMgr.LargeFont, pWnd->pText) < 0x5F )
    {
      Q_WndEDITWND_InsertChar_sub_2F8F8(pWnd, pWnd->cursorPos, param1);
      ++pWnd->cursorPos;
      pWnd->a2.pProcs->proc4_draw((P_WndA2)pWnd, 0);
    }
    return 0xFFFFFFFF;
  }
  if ( (unsigned int)param2 < 0x4B )
  {
    if ( (unsigned int)param2 >= 0xE )
    {
      if ( (unsigned int)param2 > 0xE )
      {
        if ( param2 == 0x1C )
        {
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, 3, 0);
          return 0xFFFFFFFF;
        }
        return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, (unsigned __int8)param1, param2);
      }
      if ( pWnd->cursorPos > 0 )
      {
        Q_WndEDITWND_DeleteChar_sub_2F8A4(pWnd, --pWnd->cursorPos);
        pWnd->a2.pProcs->proc4_draw((P_WndA2)pWnd, 0);
      }
      return 0xFFFFFFFF;
    }
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, (unsigned __int8)param1, param2);
  }
  if ( (unsigned int)param2 <= 0x4B )
  {
    if ( pWnd->cursorPos > 0 )
    {
      pProcs = pWnd->a2.pProcs;
      --pWnd->cursorPos;
      pProcs->proc4_draw(&pWnd->a2, 0);
    }
    return 0xFFFFFFFF;
  }
  if ( (unsigned int)param2 < 0x4D )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, (unsigned __int8)param1, param2);
  }
  if ( (unsigned int)param2 <= 0x4D )
  {
    cursorPos = pWnd->cursorPos;
    if ( cursorPos < pWnd->textLength )
    {
      v10 = pWnd->a2.pProcs;
      pWnd->cursorPos = cursorPos + 1;
      v10->proc4_draw(&pWnd->a2, 0);
    }
    return 0xFFFFFFFF;
  }
  else
  {
    if ( param2 != 0x53 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, (unsigned __int8)param1, param2);
    }
    if ( pWnd->cursorPos < pWnd->textLength )
    {
      Q_WndEDITWND_DeleteChar_sub_2F8A4(pWnd, pWnd->cursorPos);
      pWnd->a2.pProcs->proc4_draw((P_WndA2)pWnd, 0);
    }
    return 0xFFFFFFFF;
  }
}

//----- (0002F8A4) --------------------------------------------------------
void __fastcall Q_WndEDITWND_DeleteChar_sub_2F8A4(P_WndEDITWND pWnd, int pos)
{
  int i; // kr04_4

  if ( (__int16)pos >= pWnd->maxTextLength )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x8F2);
  }
  for ( i = 0; (__int16)pos < pWnd->textLength; ++i )
  {
    pWnd->pText[(__int16)pos] = pWnd->pText[(__int16)pos + 1];
  }
  --pWnd->textLength;
}

//----- (0002F8F8) --------------------------------------------------------
void __fastcall Q_WndEDITWND_InsertChar_sub_2F8F8(P_WndEDITWND pWnd, WORD pos, char character)
{
  int v3; // edi
  int i; // eax
  char *v7; // edx

  if ( pos > pWnd->textLength )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x903);
  }
  if ( pWnd->textLength >= pWnd->maxTextLength )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x904);
  }
  LOWORD(v3) = pWnd->textLength;
  if ( pos == (_WORD)v3 )
  {
    pWnd->pText[(__int16)v3] = character;
    pWnd->pText[(__int16)v3 + 1] = 0;
  }
  else
  {
    for ( i = v3; (__int16)i >= pos; v7[1] = *v7 )
    {
      v7 = &pWnd->pText[(__int16)i--];
    }
  }
  pWnd->pText[pos] = character;
  ++pWnd->textLength;
}
// 2F968: variable 'v3' is possibly undefined

//----- (0002F9A4) --------------------------------------------------------
void __fastcall Q_WndEDITWND_SetNewText_sub_2F9A4(P_WndEDITWND pWnd, const char *newText, WORD maxTextLength)
{
  unsigned int v3; // kr04_4

  if ( !newText )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x91B);
  }
  pWnd->pText = (char *)newText;
  pWnd->maxTextLength = maxTextLength;
  v3 = strlen(newText) + 1;
  pWnd->textLength = v3 - 1;
  if ( (__int16)(v3 - 1) > maxTextLength )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x921);
  }
  pWnd->cursorPos = pWnd->textLength;
}

//----- (0002FA18) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd26MW_Ctor_sub_2FA18(P_Wnd26MW a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = &Wnd26MW_Procs;
  Q_Wnd26MW_Init_sub_2FA78(a1);
}

//----- (0002FA34) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd26MW_Dtor_sub_2FA34(P_WndA2 pWnd, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd, &C_Wnd26MW);
    operator delete[](v3);
  }
  else
  {
    pWnd->pProcs = &Wnd26MW_Procs;
    Q_WndA2_Dtor_sub_2C848(pWnd, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(pWnd);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002FA78) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd26MW_Init_sub_2FA78(P_Wnd26MW result)
{
  result->Unknown_AB = 0;
  result->Unknown_AF = 3;
  result->Unknown_B1 = 0xF3;
}

//----- (0002FA98) --------------------------------------------------------
void __fastcall Q_Wnd26MW_Proc4_sub_2FA98(P_Wnd pWnd, int a2)
{
  PANE *p_pane; // esi
  WINDOW *window; // ecx
  LONG v5; // [esp-18h] [ebp-2Ch]
  LONG v6; // [esp-14h] [ebp-28h]
  UWORD x0; // [esp-10h] [ebp-24h]
  WORD x0_high; // [esp-Ch] [ebp-20h]
  int v9; // [esp-4h] [ebp-18h]

  p_pane = &pWnd->pane;
  VFX_pane_wipe(&pWnd->pane, 0xF2);
  if ( pWnd->framed == 0xFFFFFFFF )
  {
    VFX_line_draw(p_pane, 0, 0, pWnd->pane.x1 - pWnd->pane.x0, 0, 0, 0xF3);
    VFX_line_draw(p_pane, 0, 0, 0, pWnd->pane.y1 - pWnd->pane.y0, 0, 0xF3);
    v6 = pWnd->pane.y1 - pWnd->pane.y0;
    VFX_line_draw(p_pane, pWnd->pane.x1 - pWnd->pane.x0, v6, 0, v6, 0, 0xF3);
    v5 = pWnd->pane.x1 - pWnd->pane.x0;
    VFX_line_draw(p_pane, v5, pWnd->pane.y1 - pWnd->pane.y0, v5, 0, 0, 0xF3);
  }
  if ( pWnd[1].pane.window )
  {
    window = pWnd[1].pane.window;
    v9 = pWnd->pane.x1 - pWnd->pane.x0 - 5;
    x0_high = HIWORD(pWnd[1].pane.x0);
    x0 = pWnd[1].pane.x0;
    WinMgr.LargeFont.pane = pWnd->pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, (const char *)window, x0, x0_high, 0xFF, v9);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pWnd->pane);
}

//----- (0002FBA4) --------------------------------------------------------
void __fastcall sub_2FBA4(int a1, int a2)
{
  int v3; // ecx
  LONG v4; // eax
  LONG v5; // ebx
  void *ShapeTable_sub_1B084; // eax
  WORD v7; // [esp-4h] [ebp-14h]

  v3 = *(_DWORD *)(a1 + 0x41);
  v4 = 0xF2;
  if ( WinMgr._wndIndex == v3 && a2 != 2 || a2 == 3 )
  {
    v4 = 0x96;
  }
  VFX_pane_wipe((PANE *)(a1 + 4), v4);
  if ( *(__int16 *)(a1 + 0x1E) == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x9A0);
  }
  v5 = *(__int16 *)(a1 + 0x1E);
  if ( v5 != 0xFFFFFFFF )
  {
    v7 = V_PlayerRaceIndex;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)(a1 + 4), ShapeTable_sub_1B084, v5, 0, 0, v7);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 4));
}

//----- (0002FC3C) --------------------------------------------------------
int __fastcall sub_2FC3C(int a1)
{
  return (*(int (**)(void))(*(_DWORD *)(a1 + 0xA7) + 0xC))();
}

//----- (0002FC50) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd20HW_Ctor_sub_2FC50(P_Wnd20HW self)
{
  Q_WndA2_Ctor_sub_2C830(&self->super);
  self->super.pProcs = &Wnd20HW_Procs;
}

//----- (0002FC68) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd20HW_Dtor_sub_2FC68(P_Wnd20HW self, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(self, &C_Wnd20HW);
    operator delete[](v3);
  }
  else
  {
    self->super.pProcs = &Wnd20HW_Procs;
    Q_WndA2_Dtor_sub_2C848(&self->super, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002FCB0) --------------------------------------------------------
void __fastcall Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(P_Wnd20HW pHelpWnd, char *helpfile, char *helptopic)
{
  LONG x0; // ebx

  pHelpWnd->pagesNum = 0;
  pHelpWnd->Unknown_DA7 = pHelpWnd->pagesNum;
  strcpy(pHelpWnd->fileName, helpfile);
  strcpy(pHelpWnd->helpTopic, helptopic);
  sub_2FEB8(pHelpWnd);
  x0 = 152;
  if ( !WinMgr.state || WinMgr.state == 1 || WinMgr.state == 7 || WinMgr.state == 8 || WinMgr.state == 0x10 || WinMgr.state == 0x14 )
  {
    x0 = 80;
  }
  pHelpWnd->super.pane.x0 = x0;
  pHelpWnd->super.pane.y0 = 120;
  pHelpWnd->super.pane.x1 = x0 + 335;
  pHelpWnd->super.pane.y1 = 375;
}

//----- (0002FD68) --------------------------------------------------------
int __fastcall Q_Wnd20HW_Proc3_sub_2FD68(P_Wnd20HW pWnd, UWORD message, int param1, int param2)
{
  P_Procs pProcs; // ebx
  int Unknown_DA7; // edx
  P_Procs v7; // ebx

  if ( message < 6u )
  {
    if ( message < 2u )
    {
      if ( message == 1 )
      {
        pWnd->super.Unknown_35 = 0xFFFFFFFF;
        pProcs = pWnd->super.pProcs;
        pWnd->super.Unknown_39 = 0xFFFFFFFF;
        pProcs->proc4_draw(&pWnd->super, 0);
        return 0;
      }
      return Q_WndA2_Proc3_sub_2F424(&pWnd->super, message, param1, param2);
    }
    if ( message > 2u && message == 5 )
    {
      goto LABEL_9;
    }
    return Q_WndA2_Proc3_sub_2F424(&pWnd->super, message, param1, param2);
  }
  if ( message <= 7u )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->super, message, param1, param2);
  }
  if ( message < 0xDu )
  {
    if ( message != 0xC )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->super, message, param1, param2);
    }
LABEL_9:
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, 0xCA, 0);
    return 0xFFFFFFFF;
  }
  if ( message <= 0xDu || message < 0x32u || message > 0x32u )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->super, message, param1, param2);
  }
  Unknown_DA7 = pWnd->Unknown_DA7;
  if ( Unknown_DA7 >= pWnd->pagesNum )
  {
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, param1, param2);
  }
  else
  {
    v7 = pWnd->super.pProcs;
    pWnd->Unknown_DA7 = Unknown_DA7 + 1;
    v7->proc4_draw(&pWnd->super, 0);
  }
  return 0;
}

//----- (0002FE58) --------------------------------------------------------
void __fastcall Q_HELPWIN_CPP_FgetsLine_sub_2FE58(FILE *fp, char *line)
{
  unsigned int found; // edi
  char first; // ah

  found = 0;
  do
  {
    if ( !fgets(line, 200, fp) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\helpwin.cpp", 0x9E);
    }
    first = *line;
    if ( *line != ' ' && first != '\t' && first != '\n' && first != '\r' && first != '/' && first != '#' )
    {
      found = 0xFFFFFFFF;
    }
  }
  while ( !found );
}

//----- (0002FEB8) --------------------------------------------------------
int __fastcall sub_2FEB8(P_Wnd20HW pHelpWnd)
{
  P_Wnd20HW v1; // kr04_4
  int i; // kr08_4
  char *buffer; // eax
  P_Wnd20HW pHelpWnd___; // edx
  P_Wnd20HW pHelpWnd__; // ecx
  int v6; // kr0C_4
  int v7; // kr10_4
  int v8; // kr24_4
  int v9; // kr28_4
  P_HelpItem v10; // edx
  int v11; // edx
  P_HelpItem v12; // eax
  P_HelpItem v13; // edx
  P_WndA2 v14; // edx
  PANE *p_pane; // ebx
  int v16; // edi
  P_HelpItem v17; // eax
  char *v18; // edx
  P_HelpItem v19; // eax
  P_HelpItem v20; // edx
  char *pText; // kr14_4
  int flagsNum; // esi
  int v25; // esi
  int j; // ecx
  char line[204]; // [esp+0h] [ebp-13Ah] BYREF
  char s2[60]; // [esp+CCh] [ebp-6Eh] BYREF
  char s1[60]; // [esp+108h] [ebp-32h] BYREF
  char s3[5][10]; // [esp+144h] [ebp+Ah] BYREF
  FILE *fp; // [esp+178h] [ebp+3Eh]
  T_HelpItem *helpItems; // [esp+17Ch] [ebp+42h]
  LONG bufi1; // [esp+180h] [ebp+46h] BYREF
  LONG bufi2; // [esp+184h] [ebp+4Ah] BYREF
  LONG bufi3; // [esp+188h] [ebp+4Eh] BYREF
  LONG bufi4; // [esp+18Ch] [ebp+52h] BYREF
  char *pBuffer; // [esp+190h] [ebp+56h]
  MACRO_VFX_BOOL withoutButton; // [esp+194h] [ebp+5Ah]
  int v39; // [esp+198h] [ebp+5Eh]
  int v40; // [esp+19Ch] [ebp+62h]
  int v41; // [esp+1A0h] [ebp+66h]
  MACRO_VFX_BOOL v42; // [esp+1A4h] [ebp+6Ah]
  int searchState; // [esp+1A8h] [ebp+6Eh]
  int v44; // [esp+1ACh] [ebp+72h]
  P_Wnd20HW pHelpWnd_; // [esp+1B0h] [ebp+76h]
  MACRO_VFX_BOOL bEndText; // [esp+1B4h] [ebp+7Ah]
  int textLength; // [esp+1B8h] [ebp+7Eh]

  pHelpWnd_ = pHelpWnd;
  Q_WndA2_CallChildrenProc3_sub_2D258(&pHelpWnd->super, 2u, 0, 0);
  v1 = pHelpWnd_;
  for ( i = 0; i != 0xA; ++i )
  {
    v1->helpItems[i]._hasNextPage = FALSE;
  }
  buffer = pHelpWnd_->buffer;
  pHelpWnd_->helpItemsNum = 0;
  memset(buffer, 0, 3000u);
  searchState = 0;
  v41 = 0;
  v40 = 0;
  pHelpWnd___ = pHelpWnd_;
  pHelpWnd__ = pHelpWnd_;
  pHelpWnd_->super.shapeCacheIndex = GwshareShpCacheIndexes[0x25];// 37: data\help.shp
  pHelpWnd___->super.shapeNumber = 0;
  fp = Q_OpenTextFile_sub_1BB10(pHelpWnd___->fileName, 0);
  do
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, line);
    sscanf(line, "%s", s1);
    if ( !stricmp(s1, "HELP") )
    {
      sscanf(line, "%s %s", s1, s2);
      if ( !stricmp(pHelpWnd__->helpTopic, s2) )
      {
        // Found topic
        searchState = 1;
      }
      else if ( !stricmp("END", s2) )
      {
        sub_2620C("Topic '%s' not found in help file.\n", pHelpWnd__->helpTopic);
        Q_PrintFailAndExit_sub_261B8(0, "..\\helpwin.cpp", 0xE8);
      }
    }
  }
  while ( !searchState );
  v42 = TRUE;
  withoutButton = TRUE;
  helpItems = pHelpWnd_->helpItems;
  if ( searchState != 2 )
  {
    pBuffer = pHelpWnd_->buffer;
    v44 = 4 * v41;
    v6 = 4 * v41;
    v39 = 600 * v40;
    v8 = 600 * v40;
    v7 = 0;
    v9 = 0;
    do
    {
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, line);
      sscanf(line, "%s", s1);
      if ( !stricmp(s1, "HELP") )
      {
        searchState = 2;
      }
      else if ( !stricmp(s1, "POS") )
      {
        v10 = helpItems;
        sscanf(line, "%s %d %d", s1, &bufi1, &bufi2);
        v10->posX = bufi1;
        v10->posY = bufi2;
      }
      else if ( !stricmp(s1, "SHAPE") )
      {
        v11 = pHelpWnd_->helpItemsNum + 1;
        pHelpWnd_->helpItemsNum = v11;
        if ( v11 >= 10 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x124);
        }
        if ( v42 == 0xFFFFFFFF )
        {
          v42 = FALSE;
        }
        else
        {
          ++helpItems;
        }
        v12 = helpItems;
        helpItems->Unknown_04 = 0;
        v12->x0 = 0;
        v12->y0 = 0;
        v12->posX = 0;
        v12->posY = 0;
        if ( sscanf(line, "%s %d %d %d %d", s1, &bufi1, &bufi2, &bufi3, &bufi4) == 5 )
        {
          v13 = helpItems;
          helpItems->x0 = bufi1;
          v13->y0 = bufi2;
          v13->posX = bufi3;
          v13->posY = bufi4;
        }
      }
      else if ( !stricmp(s1, "BUTTON") )
      {
        if ( withoutButton == TRUE )
        {
          withoutButton = FALSE;
        }
        else
        {
          ++v41;
          ++v7;
        }
        if ( pHelpWnd_->super.childrenNum <= v41 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x145);
        }
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, (*(P_WndA2 *)((char *)&(*pHelpWnd_->super.children)[v7] + v6))->index, 0xE, 0, 0);
      }
      else if ( !stricmp(s1, "TITLE") )
      {
        sscanf(line, "%s %s", s1, (*(P_WndA2 *)((char *)&(*pHelpWnd_->super.children)[v7] + v6))->name);
      }
      else if ( !stricmp(s1, "MSG") )
      {
        sscanf(line, "%s %d", s1, &bufi1);
        (*(P_WndA2 *)((char *)&(*pHelpWnd_->super.children)[v7] + v6))->sendParam1 = bufi1;
      }
      else if ( !stricmp(s1, "PANE") )
      {
        sscanf(line, "%s %d %d %d %d", s1, &bufi1, &bufi2, &bufi3, &bufi4);
        v14 = *(P_WndA2 *)((char *)&(*pHelpWnd_->super.children)[v7] + v6);
        v14->pane.x0 = bufi1;
        v14->pane.y0 = bufi2;
        v14->pane.x1 = bufi3;
        v14->pane.y1 = bufi4;
      }
      else if ( !stricmp(s1, "BPOS") )
      {
        sscanf(line, "%s %s", s1, s3);
        p_pane = &(*(P_WndA2 *)((char *)&(*pHelpWnd_->super.children)[v7] + v6))->pane;
        if ( !stricmp(s3[0], "BL") )
        {
          p_pane->x0 = pHelpWnd_->super.pane.x0 + 15;
          p_pane->y0 = pHelpWnd_->super.pane.y1 - 50;
          p_pane->x1 = pHelpWnd_->super.pane.x0 + 90;
          p_pane->y1 = pHelpWnd_->super.pane.y1 - 15;
        }
        else if ( !stricmp(s3[0], "BR") )
        {
          p_pane->x0 = pHelpWnd_->super.pane.x1 - 90;
          p_pane->y0 = pHelpWnd_->super.pane.y1 - 50;
          p_pane->x1 = pHelpWnd_->super.pane.x1 - 15;
          p_pane->y1 = pHelpWnd_->super.pane.y1 - 15;
        }
      }
      else if ( !stricmp(s1, "TEXT") )
      {
        v16 = pHelpWnd_->helpItemsNum + 1;
        pHelpWnd_->helpItemsNum = v16;
        if ( v16 >= 10 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x177);
        }
        if ( v40 >= 5 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x178);
        }
        if ( v42 == 0xFFFFFFFF )
        {
          v42 = FALSE;
        }
        else
        {
          ++helpItems;
        }
        v17 = helpItems;
        helpItems->Unknown_04 = 1;
        v17->flags = 0;
        v18 = &pBuffer[0x258 * v9 + v8];
        v19 = helpItems;
        helpItems->pText = v18;
        *v18 = 0;
        v19->pFont = &WinMgr.LargeFont;
        v19->posX = 0;
        v19->posY = 0;
        v19->Unknown_9 = 0xFFFF;
        ++v40;
        ++v9;
        if ( sscanf(line, "%s %d %d %d", s1, &bufi1, &bufi2, &bufi3) == 4 )
        {
          v20 = helpItems;
          helpItems->posX = bufi1;
          v20->posY = bufi2;
          v20->Unknown_9 = bufi3;
        }
        bEndText = FALSE;
        textLength = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, line);
          if ( !strnicmp(line, "ENDTEXT", 7u) )
          {
            bEndText = TRUE;
          }
          else
          {
            textLength += strlen(line);
            if ( textLength >= 596 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x19E);
            }
            strcat(helpItems->pText, line);
          }
        }
        while ( bEndText == FALSE );
        if ( !helpItems->pText )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x1A6);
        }
        pText = helpItems->pText;
        v25 = 0;
        if ( *pText )
        {
          do
          {
            if ( v25 >= 597 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x1AC);
            }
            if ( pText[v25] == '\n' )
            {
              pText[v25] = ' ';
            }
            else if ( pText[v25] == '@' )
            {
              pText[v25] = '\n';
            }
          }
          while ( pText[++v25] );
        }
      }
      else if ( !stricmp(s1, "CENTERPOS") )
      {
        helpItems->posX = (pHelpWnd_->super.pane.x1 - pHelpWnd_->super.pane.x0) / 2;
        helpItems->posY = (pHelpWnd_->super.pane.y1 - 0x32 - pHelpWnd_->super.pane.y0) / 2;
      }
      else if ( !stricmp(s1, "FONT") )
      {
        sscanf(line, "%s %s", s1, s3);
        if ( !stricmp(s3[0], "LARGE") )
        {
          helpItems->pFont = &WinMgr.LargeFont;
        }
        else if ( !stricmp(s3[0], "SMALL") )
        {
          helpItems->pFont = &WinMgr.SmallFont;
        }
      }
      else if ( !stricmp(s1, "FLAGS") )
      {
        flagsNum = sscanf(line, "%s %s %s %s %s %s", s1, s3, s3[1], s3[2], s3[3], s3[4]) - 1;
        for ( j = 0; j < flagsNum; ++j )
        {
          if ( !stricmp(s3[j], "TJ_HC") )
          {
            LOBYTE(helpItems->flags) |= 2u;
          }
          else if ( !stricmp(s3[j], "TJ_VC") )
          {
            LOBYTE(helpItems->flags) |= 1u;
          }
          else if ( !stricmp(s3[j], "TJ_R") )
          {
            LOBYTE(helpItems->flags) |= 0x20u;
          }
          else if ( !stricmp(s3[j], "TJ_B") )
          {
            LOBYTE(helpItems->flags) |= 0x10u;
          }
        }
      }
      else if ( !stricmp(s1, "NEWPAGE") )
      {
        helpItems->_hasNextPage = TRUE;
        ++pHelpWnd_->pagesNum;
      }
    }
    while ( searchState != 2 );
  }
  return fclose(fp);
}
// 2FEB8: using guessed type char line[204];

//----- (00030774) --------------------------------------------------------
void __fastcall Q_Wnd20HW_Proc4_sub_30774(P_Wnd20HW pWnd, int a2)
{
  PANE *p_pane; // esi
  int shapeCacheIndex; // eax
  void *ShapeTable_sub_1B084; // eax
  int v5; // edi
  LONG v6; // esi
  int v7; // ebx
  int v8; // ecx
  int j; // kr0C_4
  int v10; // kr10_4
  P_Wnd v11; // edi
  P_Wnd v12; // eax
  int v13; // esi
  PANE *v14; // edi
  int v15; // edx
  int Unknown_DA7; // ebx
  int v17; // esi
  T_HelpItem *v18; // kr1C_4
  int v19; // kr20_4
  char Unknown_04; // ah
  void *v21; // eax
  int v22; // edx
  int posY; // ebx
  int posX; // eax
  const char *pText; // ecx
  T_Font *pFont; // eax
  int v27; // edx
  int helpItemsNum; // edi
  int i; // eax
  UWORD v30; // [esp-Ch] [ebp-A4h]
  LONG shapeNumber; // [esp-8h] [ebp-A0h]
  LONG y0; // [esp-8h] [ebp-A0h]
  WORD v33; // [esp-8h] [ebp-A0h]
  LONG v34; // [esp-4h] [ebp-9Ch]
  int v35; // [esp+0h] [ebp-98h]
  int v36[20]; // [esp+4h] [ebp-94h]
  PANE pane; // [esp+54h] [ebp-44h] BYREF
  int v38; // [esp+68h] [ebp-30h]
  int v39; // [esp+6Ch] [ebp-2Ch]
  int hasNextPage; // [esp+70h] [ebp-28h]
  int v41; // [esp+74h] [ebp-24h]
  P_Wnd20HW pHelpWnd; // [esp+78h] [ebp-20h]
  UWORD flags; // [esp+7Ch] [ebp-1Ch]
  __int16 Unknown_9; // [esp+80h] [ebp-18h]

  pHelpWnd = pWnd;
  p_pane = &pWnd->super.pane;
  VFX_pane_wipe(&pWnd->super.pane, 0xF2);
  shapeCacheIndex = (unsigned __int16)pHelpWnd->super.shapeCacheIndex;
  if ( (unsigned __int16)shapeCacheIndex != 0xFFFF )
  {
    shapeNumber = pHelpWnd->super.shapeNumber;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[shapeCacheIndex]);
    VFX_shape_draw(p_pane, ShapeTable_sub_1B084, shapeNumber, 0, 0);
  }
  v5 = 0;
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pHelpWnd->super.pane);
  for ( i = 0; i < pHelpWnd->super.childrenNum; ++i )
  {
    if ( (*pHelpWnd->super.children)[i]->Unknown_35 == 0xFFFFFFFF )
    {
      v36[v5++] = i;
    }
  }
  v6 = pHelpWnd->super.pane.x0 + 8;
  v7 = pHelpWnd->super.pane.x0 + 0x147;
  if ( v5 > 0 )
  {
    v8 = v5;
    v10 = v5;
    v39 = 4 * v5;
    for ( j = 0; j < v10; ++j )
    {
      v11 = (P_Wnd)(*pHelpWnd->super.children)[v36[j]];
      v12 = (P_Wnd)pHelpWnd;
      v11->pane.x0 = v6;
      v11->pane.y0 = v12->pane.y0 + 0xD9;
      v11->pane.y1 = pHelpWnd->super.pane.y0 + 0xF7;
      v13 = (v7 - v6) / v8 + v6;
      v14 = &v11->pane;
      if ( v13 > v7 )
      {
        v13 = v7;
      }
      --v8;
      v14->x1 = v13;
      v6 = v13 + 1;
    }
  }
  pane = pHelpWnd->super.pane;
  pane.x0 = pHelpWnd->super.pane.x0 + 0xA;
  pane.y0 = pHelpWnd->super.pane.y0 + 0xA;
  pane.x1 = pHelpWnd->super.pane.x0 + 0x145;
  pane.y1 = pHelpWnd->super.pane.y0 + 0xCF;
  v15 = 0;
  Unknown_DA7 = pHelpWnd->Unknown_DA7;
  v41 = 0;
  if ( Unknown_DA7 > 0 )
  {
    do
    {
      if ( v41 >= pHelpWnd->helpItemsNum )
      {
        break;
      }
      if ( pHelpWnd->helpItems[v41]._hasNextPage == 0xFFFFFFFF )
      {
        ++v15;
      }
      v17 = pHelpWnd->Unknown_DA7;
      ++v41;
    }
    while ( v15 < v17 );
  }
  hasNextPage = 0;
  v18 = &pHelpWnd->helpItems[v41];
  v19 = 0;
  if ( v41 < pHelpWnd->helpItemsNum )
  {
    do
    {
      if ( hasNextPage == 0xFFFFFFFF )
      {
        break;
      }
      hasNextPage = v18[v19]._hasNextPage;
      Unknown_04 = v18[v19].Unknown_04;
      if ( Unknown_04 )
      {
        if ( Unknown_04 == 1 )
        {
          v22 = 0;
          if ( (v18[v19].flags & 2) == 0 )
          {
            v22 = pane.x1 - pane.x0 - v18[v19].posX;
          }
          v35 = v22;
          posY = v18[v19].posY;
          posX = v18[v19].posX;
          pText = v18[v19].pText;
          flags = v18[v19].flags;
          Unknown_9 = v18[v19].Unknown_9;
          v38 = posX;
          pFont = v18[v19].pFont;
          v33 = Unknown_9;
          v30 = flags;
          v27 = v38;
          pFont->pane = pane;
          Q_Font_DrawFormattedText_sub_2B8A8(pFont, v27, posY, pText, v30, v33, 0xFF, v35);
        }
        else if ( Unknown_04 != 2 )
        {
          Q_AssertLogBreakExit_sub_261A8(0, "..\\helpwin.cpp", 0x245);
        }
      }
      else
      {
        v35 = v18[v19].posY;
        v34 = v18[v19].posX;
        y0 = (unsigned __int16)v18[v19].y0;
        v21 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[(unsigned __int16)v18[v19].x0]);
        VFX_shape_draw(&pane, v21, y0, v34, v35);
      }
      helpItemsNum = pHelpWnd->helpItemsNum;
      ++v41;
      ++v19;
    }
    while ( v41 < helpItemsNum );
  }
  sub_2D218(&pHelpWnd->super);
}
// 30774: using guessed type int var_94[20];

//----- (00030A90) --------------------------------------------------------
void __fastcall sub_30A90(PANE *pPane, void *pData, int param1, int param2)
{
  int v5; // edx
  int v6; // eax
  char *sub_1CEA8; // eax
  char *v8; // eax
  LONG v9; // edx
  void *ShapeTable_sub_1B084; // eax
  char *v11; // eax
  int v12; // edx
  int v13; // ebx
  int v14; // ecx
  int v15; // esi
  char *v16; // eax
  void *v17; // eax
  void *v18; // eax
  int v19; // eax
  char *v20; // eax
  int v21; // kr04_4
  LONG v22; // ecx
  void *v23; // eax
  WORD v24; // dx
  char *v25; // eax
  int v26; // kr0C_4
  LONG v27; // ecx
  void *v28; // eax
  WORD v29; // dx
  int v30; // eax
  char *v31; // eax
  int v32; // kr14_4
  LONG v33; // ecx
  void *v34; // eax
  LONG v35; // ebx
  void *v36; // eax
  char *v37; // edi
  LONG v38; // ebx
  void *v39; // eax
  int v40; // ecx
  __int16 i; // di
  __int16 j; // di
  __int16 k; // di
  LONG v44; // [esp-20h] [ebp-B0h]
  char v45; // [esp-4h] [ebp-94h]
  int v46; // [esp-4h] [ebp-94h]
  char v47; // [esp-4h] [ebp-94h]
  char v48; // [esp-4h] [ebp-94h]
  char v49; // [esp-4h] [ebp-94h]
  char v50; // [esp-4h] [ebp-94h]
  __int16 v51; // [esp-4h] [ebp-94h]
  char s[52]; // [esp+0h] [ebp-90h] BYREF
  int v53; // [esp+34h] [ebp-5Ch]
  int v54; // [esp+38h] [ebp-58h]
  LONG shape_number; // [esp+3Ch] [ebp-54h]
  char *v56; // [esp+40h] [ebp-50h]
  int v57; // [esp+44h] [ebp-4Ch]
  int v58; // [esp+48h] [ebp-48h]
  LONG v59; // [esp+4Ch] [ebp-44h]
  int v60; // [esp+50h] [ebp-40h]
  int v61; // [esp+54h] [ebp-3Ch]
  int v62; // [esp+58h] [ebp-38h]
  int v63; // [esp+5Ch] [ebp-34h]
  int v64; // [esp+60h] [ebp-30h]
  LONG v65; // [esp+64h] [ebp-2Ch]
  LONG v66; // [esp+68h] [ebp-28h]
  LONG hotY; // [esp+6Ch] [ebp-24h]
  int *v68; // [esp+70h] [ebp-20h]
  int v69; // [esp+74h] [ebp-1Ch]
  UWORD v70[2]; // [esp+78h] [ebp-18h]
  __int16 m; // [esp+7Ch] [ebp-14h]
  UWORD index[2]; // [esp+80h] [ebp-10h]

  v68 = (int *)pData;
  v58 = 9;
  if ( param2 && (param1 == 1 || *((_DWORD *)pData + 2) != 0xFFFFFFFF) )
  {
    v58 = 0xF3;
  }
  else
  {
    v5 = v68[2];
    if ( v5 != 0xFFFFFFFF )
    {
      v58 = 4 * v68[v5 + 0xA] + 0x13;
    }
  }
  sprintf(s, "%d.", v68[0x1B]);
  v57 = (__int16)v58;
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 5, 5, s, 0, v58, 0xFF, 0);
  HIWORD(v6) = HIWORD(v68);
  if ( v68[2] == 0xFFFFFFFF )
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x10);// 16: "<EMPTY>"
    WinMgr.LargeFont.pane = *pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x1E, 5, sub_1CEA8, 0, v57, 0xFF, 0);
    return;
  }
  LOWORD(v6) = GwshareShpCacheIndexes[0x20];           // 32: data\raceflag.shp
  *(_DWORD *)index = v6;
  v8 = (char *)&v68[v68[2]];
  v9 = *((_DWORD *)v8 + 3);
  v69 = *((_DWORD *)v8 + 0xA);
  shape_number = v9;
  v45 = v69;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index[0]);
  Q_DrawTintedShape_sub_53F40(pPane, ShapeTable_sub_1B084, v9, 0x19, 5, v45);
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 5, V_SpecNames[shape_number], 0, v57, 0xFF, 0);
  v46 = *v68;
  v11 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x11);      // 17: "Day %d"
  sprintf(s, v11, v46);
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 0x14, s, 0, v57, 0xFF, 0);
  v12 = ((v68[0x1C] & 0xFE00) >> 9) + 0x50;
  v13 = v68[0x1C] & 0x1F;
  v14 = (v68[0x1C] & 0x1E0) >> 5;
  v60 = (*((_WORD *)v68 + 0x39) & 0xF800) >> 0xB;
  v15 = v60;
  v56 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x12);      // 18: "am"
  if ( v15 )
  {
    if ( v15 == 0xC )
    {
      v16 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x13);  // 19: "pm"
    }
    else
    {
      if ( v15 <= 0xC )
      {
        goto LABEL_16;
      }
      v16 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x13);  // 19: "pm"
      v60 = v15 - 0xC;
    }
    v56 = v16;
    goto LABEL_16;
  }
  v60 = 0xC;
LABEL_16:
  v53 = (*((_WORD *)v68 + 0x39) & 0x7E0) >> 5;
  sprintf(s, "%d/%d/%d", v14, v13, v12);
  v54 = (__int16)v58;
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 0x32, s, 0, v58, 0xFF, 0);
  sprintf(s, "%d : %.2d %s", v60, v53, v56);
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 0x41, s, 0, v54, 0xFF, 0);
  v44 = shape_number;
  v17 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);// 42: data\smraces.shp
  VFX_shape_transform(pPane, v17, v44, 0x96, 0x1E, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  v47 = v69;
  v18 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
  Q_DrawTintedShape_sub_53F40(pPane, v18, 3, 0x96, 0x1E, v47);
  LOWORD(v19) = GwshareShpCacheIndexes[0x29];          // 41: data\14intel.shp
  *(_DWORD *)v70 = v19;
  v59 = 0xC8;
  v20 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x14);      // 20: "Fleet"
  v64 = 0x14;
  WinMgr.SmallFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xC8, 5, v20, 0, v54, 0xFF, 0);
  v21 = 0;
  for ( i = 0; i < v68[0x18]; ++i )
  {
    v22 = v59;
    v48 = v69;
    v23 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v70[0]);
    Q_DrawTintedShape_sub_53F40(pPane, v23, 5, v22, 8 * v21 + 0x14, v48);
    v59 += 8;
    if ( i % 9 == 8 )
    {
      v59 = 0xC8;
      ++v21;
    }
  }
  v24 = v58;
  v25 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x15);      // 21: "Colonies"
  v65 = 0x118;
  v63 = 0x14;
  WinMgr.SmallFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x118, 5, v25, 0, v24, 0xFF, 0);
  v26 = 0;
  for ( j = 0; j < v68[0x19]; ++j )
  {
    v27 = v65;
    v49 = v69;
    v28 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v70[0]);
    Q_DrawTintedShape_sub_53F40(pPane, v28, 6, v27, 8 * v26 + 0x14, v49);
    v65 += 8;
    if ( j % 9 == 8 )
    {
      v65 = 0x118;
      ++v26;
    }
  }
  v29 = v58;
  v30 = v68[0x1A] >> 2;
  v66 = 0x168;
  v61 = v30;
  v62 = 0x14;
  v31 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x16);      // 22: "Discoveries"
  WinMgr.SmallFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x168, 5, v31, 0, v29, 0xFF, 0);
  v32 = 0;
  for ( k = 0; k < v61; ++k )
  {
    v50 = v69;
    v33 = v66;
    v34 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v70[0]);
    Q_DrawTintedShape_sub_53F40(pPane, v34, 7, v33, 8 * v32 + 0x14, v50);
    v66 += 8;
    if ( k % 9 == 8 )
    {
      v66 = 0x168;
      ++v32;
    }
  }
  hotY = 5;
  for ( m = 0; m < v68[1]; ++m )
  {
    if ( m != v68[2] )
    {
      v37 = (char *)&v68[m];
      if ( *((_DWORD *)v37 + 0x11) )
      {
        v51 = *((_WORD *)v37 + 0x14);
        v38 = *((_DWORD *)v37 + 3);
        v39 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index[0]);
        Q_DrawTintedShape_sub_53F40(pPane, v39, v38, 0x1CC, 5, v51);
        v40 = *((_DWORD *)v37 + 0x11);
        v35 = 0xFFFFFFFF;
        if ( v40 == 3 )
        {
          v35 = 9;
        }
        else if ( v40 == 2 )
        {
          v35 = 8;
        }
        if ( v35 != 0xFFFFFFFF )
        {
          v36 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
          VFX_shape_draw(pPane, v36, v35, 0x1CC, 5);
        }
      }
    }
  }
}
// 30E3F: variable 'v19' is possibly undefined
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00031158) --------------------------------------------------------
void __fastcall sub_31158(PANE *pPane, void *pData, int param1, int param2)
{
  WORD v5; // dx
  char s[12]; // [esp+0h] [ebp-20h] BYREF
  int v7; // [esp+Ch] [ebp-14h]
  void *v8; // [esp+10h] [ebp-10h]

  v8 = pData;
  v5 = 9;
  if ( param2 )
  {
    v5 = 0xF3;
  }
  sprintf(s, "%d.", *((_DWORD *)v8 + 0x37));
  WinMgr.LargeFont.pane = *pPane;
  v7 = v5;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 5, 5, s, 0, v5, 0xFF, 0);
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x1E, 5, (const char *)v8 + 0x14, 0, v7, 0xFF, 0x226);
}

//----- (00031200) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd11LW_Ctor_sub_31200(P_Wnd11LW result)
{
  Q_WndA2_Ctor_sub_2C830(&result->a);
  result->a.pProcs = &Wnd11LW_Procs;
  Q_Wnd_Init_sub_2C8E4((P_Wnd)result);
}

//----- (0003121C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd11LW_Dtor_sub_3121C(P_Wnd11LW pWnd, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd, &C_Wnd11LW);
    operator delete[](v3);
  }
  else
  {
    pWnd->a.pProcs = &Wnd11LW_Procs;
    Q_WndA2_Dtor_sub_2C848(&pWnd->a, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(pWnd);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00031268) --------------------------------------------------------
int __fastcall Q_Wnd11LW_Proc3_sub_31268(P_Wnd11LW pWnd, UWORD message, int param1, int param2)
{
  const char *v6; // ecx
  T_Wnd10LB *Wnd_sub_56DA8; // eax
  char v8; // bl
  int v9; // eax
  int v10; // ebx
  _DWORD *ItemData_sub_2ED14; // esi
  char v12; // ah
  const char *v13; // ebp
  T_CFile v14; // [esp+0h] [ebp-144h] BYREF
  char fname[20]; // [esp+118h] [ebp-2Ch] BYREF
  int param2a; // [esp+138h] [ebp-Ch]
  int v17[2]; // [esp+13Ch] [ebp-8h]

  LOWORD(v17[1]) = message;
  v17[0] = param1;
  param2a = param2;
  if ( message < 3u )
  {
    if ( message != 1 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a, v17[1], v17[0], param2a);
    }
    v6 = "savescr";
    if ( WinMgr.state == 2 )
    {
      pWnd->Unknown[4] = 1;
    }
    else if ( WinMgr.state == 4 )
    {
      v6 = "loadscr";
      pWnd->Unknown[4] = 0;
    }
    else
    {
      v6 = "tutscr";
      pWnd->Unknown[4] = 2;
    }
    Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "LOADLIST", 0);
    v8 = pWnd->Unknown[4];
    *(_DWORD *)pWnd->Unknown = Wnd_sub_56DA8;
    if ( v8 == 2 )
    {
      Wnd_sub_56DA8->_defaultItemHeight = 0x3C;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(*(P_Wnd10LB *)pWnd->Unknown, sub_31158);
      sub_317D0((int)pWnd);
    }
    else
    {
      Wnd_sub_56DA8->_defaultItemHeight = 0x55;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(*(P_Wnd10LB *)pWnd->Unknown, sub_30A90);
      sub_316A8((int)pWnd);
    }
    strcpy(pWnd->a.helpIndex, v6);
    strcpy((char *)(*(_DWORD *)pWnd->Unknown + 0x4F), v6);
    Q_WndA2_Proc3_sub_2F424(&pWnd->a, v17[1], v17[0], param2a);
    return 0;
  }
  if ( message <= 3u )
  {
    if ( param1 >= 0x31 && param1 <= 0x39 )
    {
      v9 = 9;
      v10 = param1 - 0x30;
      if ( pWnd->Unknown[4] == 1 )
      {
        v9 = 0xA;
      }
      if ( v10 < v9 )
      {
        ((void (*)(void))pWnd->a.pProcs->proc3_msg)();
        return 0xFFFFFFFF;
      }
    }
    return 0;
  }
  if ( message != 0x1C01 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a, v17[1], v17[0], param2a);
  }
  ItemData_sub_2ED14 = Q_Wnd10LB_GetItemData_sub_2ED14(*(P_Wnd10LB *)pWnd->Unknown, v17[0]);
  sprintf(fname, "%02d.sav", ItemData_sub_2ED14[0x1B]);
  Q_CFile_Ctor_sub_1BB78(&v14);
  v12 = pWnd->Unknown[4];
  if ( v12 == 1 )
  {
    Q_SaveGam_sub_54048(fname);
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
  }
  else if ( v12 )
  {
    v13 = &pWnd->Unknown[0xE0 * param1 + 0x915];
    strcpy(fname, v13);
    strcat(fname, ".tsv");
    Q_LoadGam_sub_53FB0(fname);
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
    srand(0);
    dword_96BBC = LODWORD(WinMgr.j);
    WinMgr.j = 1.0;
    strcpy(fname, v13);
    strcat(fname, ".bin");
    Q_WinMgr_PlayWinEvents_sub_59988(&WinMgr, fname, 0);
  }
  else if ( ItemData_sub_2ED14[2] != 0xFFFFFFFF )
  {
    Q_LoadGam_sub_53FB0(fname);
    WinMgr.Unknown_4758 = 1;
    WinMgr.Unknown_4736[0] = 0;
    WinMgr.Unknown_4756 = 1;
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 1, 0);
  }
  Q_CFile_Dtor_sub_1BBC8(&v14);
  return 0xFFFFFFFF;
}
// 96BBC: using guessed type int dword_96BBC;
// 31268: using guessed type char fname[20];

//----- (0003160C) --------------------------------------------------------
void __fastcall Q_Wnd11LW_Proc4_sub_3160C(P_Wnd pWnd, int a2)
{
  char x0; // ah
  LONG v4; // edx
  char *v5; // eax
  char *sub_1CEA8; // [esp+0h] [ebp-18h]

  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x17);// 23: "Load Game"
  x0 = pWnd[1].pane.x0;
  v4 = 0x10;
  if ( x0 == 1 )
  {
    v4 = 0x73;
    v5 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x18);     // 24: "Save Game"
  }
  else
  {
    if ( x0 != 2 )
    {
      goto LABEL_6;
    }
    v5 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x19);     // 25: "Play Tutorial"
    v4 = 0;
  }
  sub_1CEA8 = v5;
LABEL_6:
  if ( v4 )
  {
    VFX_pane_wipe(&pWnd->pane, v4);
  }
  WinMgr.LargeFont.pane = pWnd->pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 4, sub_1CEA8, 3u, 0xFFFF, 0xFF, 0);
  sub_2D218((P_WndA2)pWnd);
}

//----- (000316A8) --------------------------------------------------------
T_CFile *__fastcall sub_316A8(int a1)
{
  unsigned __int16 v2; // dx
  T_CFile *result; // eax
  int i; // edi
  T_CFile handle; // [esp+0h] [ebp-158h] BYREF
  char s[32]; // [esp+118h] [ebp-40h] BYREF
  int v7; // [esp+138h] [ebp-20h]
  int v8; // [esp+13Ch] [ebp-1Ch]

  v8 = a1;
  Q_Wnd10LB_Clear_sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xAB));
  Q_CFile_Ctor_sub_1BB78(&handle);
  for ( i = 0; i < 0x14; ++i )
  {
    v7 = i + 1;
    sprintf(s, "%02d.sav", i + 1);
    if ( access(s, 0) )
    {
      *(_DWORD *)(a1 + 0x74 * i + 0xB8) = 0xFFFFFFFF;
    }
    else
    {
      Q_CFile_Open_sub_1BBFC(&handle, s, 0x200, 0);
      Q_CFile_Read_sub_1BF94(&handle, (void *)(a1 + 0x74 * i + 0xB0), 0x74u);
      dos_getftime(handle.fh, (unsigned __int16 *)(a1 + 0x74 * i + 0x120), (unsigned __int16 *)(a1 + 0x74 * i + 0x122));
    }
    *(_DWORD *)(a1 + 0x74 * i + 0x11C) = v7;
    Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(v8 + 0xAB), (BYTE *)(a1 + 0x74 * i + 0xB0), 0xFFFF, 0);
    v2 = i;
    Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(v8 + 0xAB), v2, *(_BYTE *)(v8 + 0xAF) == 1);
  }
  result = &handle;
  Q_CFile_Dtor_sub_1BBC8(&handle);
  return result;
}
// 317B7: returning address of temporary local variable '%handle'

//----- (000317D0) --------------------------------------------------------
int __fastcall sub_317D0(int a1)
{
  FILE *v1; // ebp
  int v2; // esi
  int v3; // kr00_4
  int v4; // eax
  int v6; // kr04_4
  int v7; // [esp+0h] [ebp-24h] BYREF
  int v8; // [esp+4h] [ebp-20h]
  int v9; // [esp+8h] [ebp-1Ch]

  v8 = a1;
  Q_Wnd10LB_Clear_sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xAB));
  v1 = Q_OpenTextFile_sub_1BB10("tutindex.txt", 0);
  fscanf(v1, "%d", &v7);
  if ( v7 > 7 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\loadwin.cpp", 0x1EA);
  }
  v9 = 0;
  if ( v7 > 0 )
  {
    v2 = v8 + 0x9C0;
    v3 = v8 + 0x9D4;
    v6 = 0;
    do
    {
      fscanf(v1, "%s", v2 + 0xE0 * v6);
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v1, (char *)(v3 + 0xE0 * v6));
      Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(v8 + 0xAB), (BYTE *)(v2 + 0xE0 * v6), 0xFFFF, 0);
      v4 = v9 + 1;
      *(_DWORD *)(v2 + 0xE0 * v6 + 0xDC) = v9 + 1;
      v9 = v4;
      ++v6;
    }
    while ( v4 < v7 );
  }
  return fclose(v1);
}

//----- (000318A0) --------------------------------------------------------
int __fastcall sub_318A0(unsigned __int16 a1, unsigned __int8 a2)
{
  int v3; // esi
  unsigned int v4; // edx
  unsigned int v5; // kr00_4
  int v6; // ebx
  int v7; // kr04_4

  LOWORD(v3) = *((_WORD *)dword_10032C + a1);
  if ( (unsigned __int16)v3 == 0xFFFF )
  {
    return 0;
  }
  HIWORD(v3) = 0;
  v4 = dword_100328 + 4 * (unsigned __int16)word_100330;
  v5 = dword_100328 + 4 * v3;
  v6 = (a2 << 0x10) + a1;
  v7 = 0;
  if ( v5 >= v4 )
  {
    return 0;
  }
  while ( v6 != *(_DWORD *)(v5 + 4 * v7) )
  {
    ++v7;
    if ( v5 + 4 * v7 >= v4 )
    {
      return 0;
    }
  }
  return (unsigned __int16)((int)(v5 + 4 * v7 - dword_100328) / 4) + 0x102;
}
// 100328: using guessed type int dword_100328;
// 100330: using guessed type __int16 word_100330;

//----- (00031934) --------------------------------------------------------
char __fastcall sub_31934(int a1)
{
  char v1; // ch
  unsigned __int16 v2; // si
  char v3; // dh
  char v4; // al
  int v5; // edx
  char result; // al
  char v7; // ch
  int v8; // ebx

  v1 = byte_100335;
  v2 = a1;
  v3 = (a1 << byte_100335) | *(_BYTE *)dword_100324++;
  *(_BYTE *)(dword_100324 - 1) = v3;
  v4 = byte_100334;
  if ( (unsigned __int16)(dword_100324 - dword_100338) == 0x100 )
  {
    *(_BYTE *)dword_100338 = 0xFF;
    dword_100338 = dword_100324++;
  }
  v5 = (int)v2 >> (8 - v1);
  result = v4 - (8 - v1);
  v7 = 0;
  v8 = dword_100324;
  *(_BYTE *)dword_100324 = v5;
  if ( (unsigned __int8)result >= 8u )
  {
    dword_100324 = v8 + 1;
    if ( (unsigned __int16)(v8 + 1 - dword_100338) == 0x100 )
    {
      *(_BYTE *)dword_100338 = 0xFF;
      dword_100338 = dword_100324++;
    }
    if ( (unsigned __int8)result > 8u )
    {
      v7 = result - 8;
      *(_BYTE *)dword_100324 = BYTE1(v5);
    }
  }
  else
  {
    v7 = result;
  }
  byte_100335 = v7;
  return result;
}
// 100324: using guessed type int dword_100324;
// 100334: using guessed type char byte_100334;
// 100335: using guessed type char byte_100335;
// 100338: using guessed type int dword_100338;

//----- (00031A34) --------------------------------------------------------
int __fastcall sub_31A34(unsigned __int16 a1, char a2)
{
  int v2; // ecx
  unsigned __int16 v3; // bx
  _WORD *v4; // edx
  int result; // eax

  v2 = dword_100328;
  v3 = word_100330;
  *(_BYTE *)(dword_100328 + 4 * (unsigned __int16)word_100330 + 2) = a2;
  *(_WORD *)(v2 + 4 * v3) = a1;
  v4 = (char *)dword_10032C + 2 * a1;
  if ( (unsigned __int16)*v4 == 0xFFFF )
  {
    *v4 = word_100330;
  }
  sub_31934(a1);
  result = (unsigned __int16)++word_100330 + 0x102;
  if ( result > (unsigned __int16)word_100332 )
  {
    if ( result <= 0x1000 )
    {
      BYTE1(result) = byte_100334 + 1;
      word_100332 *= 2;
      ++byte_100334;
    }
    else
    {
      sub_31934(0x100);
      result = (int)dword_10032C;
      byte_100334 = 9;
      word_100332 = 0x200;
      word_100330 = 0;
      memset(dword_10032C, 0xFF, 0x2008u);
    }
  }
  return result;
}
// 100328: using guessed type int dword_100328;
// 100330: using guessed type __int16 word_100330;
// 100332: using guessed type __int16 word_100332;
// 100334: using guessed type char byte_100334;

//----- (00031B08) --------------------------------------------------------
int sub_31B08()
{
  int v0; // ebx
  unsigned __int16 v1; // ax
  int v2; // kr04_4
  UBYTE v3; // cl
  int v4; // ebx
  int v5; // eax
  char v6; // dh
  int result; // eax
  _BYTE *v8; // ebx
  int v9; // ebx
  char v10; // bl

  v0 = dword_100324;
  byte_100334 = 9;
  word_100332 = 0x200;
  *(_BYTE *)dword_100324 = 8;
  byte_100335 = 0;
  dword_100338 = v0 + 1;
  dword_100324 = v0 + 2;
  sub_31934(0x100);
  v1 = *V_Window1.buffer;
  v2 = 0;
  do
  {
    v3 = V_Window1.buffer[v2 + 1];
    v4 = v1;
    v1 = sub_318A0(v1, v3);
    if ( !v1 )
    {
      sub_31A34(v4, v3);
      v1 = v3;
    }
    ++v2;
  }
  while ( v2 + 1 < 0x4B000 );
  sub_31934(v1);
  sub_31934(0x101);
  LOWORD(v5) = dword_100324;
  LOWORD(v4) = dword_100338;
  v6 = byte_100335;
  result = v5 - v4;
  if ( byte_100335 )
  {
    *(_BYTE *)dword_100338 = result;
    v8 = (_BYTE *)(dword_100324 + 1);
    dword_100324 = (int)v8;
    *v8 = 0;
    v9 = (int)(v8 + 1);
  }
  else
  {
    v10 = result;
    if ( (unsigned __int16)result == 1 )
    {
      result = dword_100338;
      *(_BYTE *)dword_100338 = byte_100335;
      return result;
    }
    result = dword_100338;
    *(_BYTE *)dword_100338 = v10 - 1;
    v9 = dword_100324 + 1;
    *(_BYTE *)dword_100324 = v6;
  }
  dword_100324 = v9;
  return result;
}
// 31BC0: variable 'v5' is possibly undefined
// 100324: using guessed type int dword_100324;
// 100332: using guessed type __int16 word_100332;
// 100334: using guessed type char byte_100334;
// 100335: using guessed type char byte_100335;
// 100338: using guessed type int dword_100338;

//----- (00031C18) --------------------------------------------------------
void __fastcall Q_SaveScreenshot_sub_31C18(UBYTE *shadowBuffer, int size)
{
  RGB *v2; // kr00_4
  int v3; // edi
  _BYTE *v4; // ebp
  _BYTE *v5; // ebp
  int v6; // ebx
  _WORD *v7; // ebp
  int v8; // ebp
  void *v9; // ecx
  int handle; // esi
  LONG i; // esi
  int j; // esi
  int v13; // [esp-4h] [ebp-30h]
  char s[20]; // [esp+0h] [ebp-2Ch] BYREF
  RGB *triplet; // [esp+14h] [ebp-18h]

  if ( size >= 632552 )
  {
    V_Window1.buffer = shadowBuffer;
    V_Window1.x_max = 639;
    V_Window1.y_max = 479;
    V_Window1.shadow = 0;
    V_Window1.stencil = 0;
    triplet = (RGB *)(shadowBuffer + 0x4B000);
    VFX_window_read(&V_Window1, 0, 0, 639, 479);
    dword_100308 = (int)triplet;
    v2 = triplet;
    triplet += 0x100;
    for ( i = 0; i < 0x100; ++i )
    {
      VFX_DAC_read(i, &v2[i]);
    }
    buf = triplet;
    memset(triplet, 0, 0x493E0u);
    dword_100328 = (int)&triplet[0x186A0];
    word_100330 = 0;
    dword_10032C = &triplet[0x19BF5].g;
    dword_100324 = (int)buf;
    memset(&triplet[0x19BF5].g, 0xFF, 0x2008u);
    triplet = (RGB *)((char *)triplet + 0x4D3E0);
    v3 = dword_100324;
    qmemcpy((void *)dword_100324, "GIF87a", 4u);
    qmemcpy((void *)(v3 + 4), "7a", 2u);
    v4 = (_BYTE *)(dword_100324 + 6);
    *(_WORD *)(dword_100324 + 6) = 0x280;
    v4 += 2;
    *(_WORD *)v4 = 0x1E0;
    v4 += 2;
    *v4++ = 0x87;
    *v4++ = 0xFF;
    *v4 = 0;
    v5 = v4 + 1;
    for ( j = 0; j < 0x300; ++j )
    {
      v6 = 0xFF * *(unsigned __int8 *)(j + dword_100308) / 0x3F;
      *v5++ = v6;
    }
    *v5 = 0x2C;
    v7 = v5 + 1;
    *v7++ = 0;
    *v7++ = 0;
    *v7++ = 0x280;
    *v7++ = 0x1E0;
    *(_BYTE *)v7 = 7;
    dword_100324 = (int)v7 + 1;
    sub_31B08();
    v13 = V_ScreenshotCounter;
    v8 = dword_100324;
    *(_BYTE *)dword_100324 = 0x3B;
    ++v8;
    v9 = buf;
    dword_100324 = v8;
    sprintf(s, "scr%03d.gif", v13);
    handle = open(s, O_BINARY|O_TRUNC|O_CREAT|O_RDWR, S_IRWXU);
    write(handle, buf, v8 - (_DWORD)v9);
    close(handle);
    dword_100324 = 0;
    dword_10032C = 0;
    dword_100328 = 0;
    buf = 0;
    V_Window1.buffer = 0;
    dword_100308 = 0;
    ++V_ScreenshotCounter;
  }
}
// 100308: using guessed type int dword_100308;
// 100324: using guessed type int dword_100324;
// 100328: using guessed type int dword_100328;
// 100330: using guessed type __int16 word_100330;
// 10033C: using guessed type int V_ScreenshotCounter;

//----- (00031E60) --------------------------------------------------------
void __fastcall Q_AppendRomanNum_sub_31E60(char *a1, int number)
{
  int v3; // kr04_4
  char *v4; // edi

  if ( number < 0 || !a1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\name.cpp", 0x29);
  }
  if ( number > 1000 )
  {
    v4 = a1;
    v3 = 0;
    do
    {
      if ( 0x3E8 * v3 + 1000 >= 4000 )
      {
        break;
      }
      strcat(v4, "M");
      ++v3;
    }
    while ( 0x3E8 * v3 + 1000 < number );
  }
  strcat(a1, V_Romans100[number / 100 % 10]);
  strcat(a1, V_Romans10[number / 10 % 10]);
  strcat(a1, V_Romans1[number % 10]);
}

//----- (00031FB0) --------------------------------------------------------
int __fastcall sub_31FB0(_DWORD *a1, const char *a2, int a3, int a4)
{
  unsigned __int8 v5; // dl
  int v7; // [esp-4h] [ebp-10h]

  v5 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  if ( a4 == 0xFFFFFFFF )
  {
    v5 = 0xF3;
  }
  v7 = a1[3] - a1[1] - 0x10;
  WinMgr.LargeFont.pane = *(PANE *)a1;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 8, 3, a2, 0, v5, 0xFF, v7);
}

//----- (0003201C) --------------------------------------------------------
void __fastcall __spoils<> Q_WndNW_sub_3201C(P_WndNW a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = (P_Procs)&off_95F1C;
  Q_WndNW_sub_3207C(a1);
}
// 95F1C: using guessed type int (__fastcall *off_95F1C)(P_WndA2 a1);

//----- (00032038) --------------------------------------------------------
T_WndA2 *__fastcall sub_32038(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95ED8);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95F1C;
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95F1C: using guessed type int (__fastcall *off_95F1C)(P_WndA2 a1);

//----- (0003207C) --------------------------------------------------------
void __fastcall __spoils<> Q_WndNW_sub_3207C(P_WndNW result)
{
  result->b = 0;
  result->c = 0;
  result->d = 0;
  result->f = 0xFFFF;
  result->g = 0xFFFF;
  result->h = 0xFFFF;
}

//----- (000320B8) --------------------------------------------------------
unsigned int __fastcall sub_320B8(int a1, __int16 a2, LONG a3, LONG a4)
{
  int v5; // edi
  T_Wnd10LB *WndWithState_sub_56E18; // eax
  T_Wnd26MW *v7; // eax
  T_Wnd02COSW *v8; // eax
  char Unknown_1E9; // bl
  int v10; // eax
  T_Race *v11; // eax
  int v12; // edx
  __int16 v13; // ax
  __int16 v14; // ax
  int ItemValue_sub_2ECA4; // edx
  char v17[32]; // [esp+0h] [ebp-44h] BYREF
  char v18[16]; // [esp+20h] [ebp-24h] BYREF
  int v19; // [esp+30h] [ebp-14h]
  int v20; // [esp+34h] [ebp-10h]
  int v21; // [esp+38h] [ebp-Ch]
  int param2; // [esp+3Ch] [ebp-8h]
  __int16 v23; // [esp+40h] [ebp-4h]

  v23 = a2;
  v5 = a3;
  param2 = a4;
  v19 = V_PlayerRaceIndex;
  v21 = (unsigned __int8)byte_968DD;
  if ( (unsigned __int16)a2 < 4u )
  {
    if ( !a2 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    if ( (unsigned __int16)a2 <= 1u )
    {
      if ( !*(_DWORD *)(a1 + 0xAB) )
      {
        a3 = 0xD;
        a4 = 0;
        WndWithState_sub_56E18 = (T_Wnd10LB *)Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "PLAYERDIP", 0xD, 0);
        *(_DWORD *)(a1 + 0xAB) = WndWithState_sub_56E18;
        if ( !WndWithState_sub_56E18 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x7B);
        }
      }
      *(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xAB) = 0;
      *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8C9) = 0x1D;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), (P_DrawItemFunc)sub_31FB0);
      Q_Wnd10LB_InitScrollBar_sub_2E9CC(*(P_Wnd10LB *)(a1 + 0xAB), 0);
      *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + 0xC6) = 0xF2;
      if ( !*(_DWORD *)(a1 + 0xAF) )
      {
        a3 = 0xD;
        a4 = 0;
        v7 = (T_Wnd26MW *)Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "ALIENDIP", 0xD, 0);
        *(_DWORD *)(a1 + 0xAF) = v7;
        if ( !v7 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x88);
        }
      }
      if ( !*(_DWORD *)(a1 + 0xB3) )
      {
        a3 = 0xD;
        a4 = 0;
        v8 = (T_Wnd02COSW *)Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "COSMOSWnd", 0xD, 0);
        *(_DWORD *)(a1 + 0xB3) = v8;
        if ( !v8 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x8F);
        }
      }
      sub_32658(a1);
      sub_32E84(a1, 0, a3, a4);
      *(_WORD *)(*(_DWORD *)(a1 + 0xAF) + 0xB1) = 4 * V_Game.races[(unsigned __int8)byte_968DD].colorSet + 0x13;
      memset(byte_101DC4, 0, 0xFu);
      Unknown_1E9 = V_Game.races[v21].Unknown_1E9;
      v10 = v19;
      *(_DWORD *)(a1 + 0xB7) = 0;
      v11 = &V_Game.races[v10];
      if ( Unknown_1E9 == 0xE )
      {
        v14 = sub_44238((int)v11, (unsigned __int8)byte_968DD, v18, *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
        sub_32A48(a1, (int)v18, v14, 0xFFFFFFFF, 0xFFFFFFFF);
        sub_32C14(a1, 0x1D);
      }
      else
      {
        v20 = Unknown_1E9;
        v12 = (__int16)v21;
        *(_DWORD *)(a1 + 0xB7) = 0xFFFFFFFF;
        v13 = sub_44A2C(v11, v12, Unknown_1E9, v17);
        sub_32B44(a1, (int)v17, v13);
        sub_32BDC(a1, v20);
      }
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    if ( a2 != 2 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    Q_WndA2_CallChildrenProc3_sub_2D258((P_WndA2)a1, v23, a3, a4);
    return 0;
  }
  if ( (unsigned __int16)a2 <= 5u )
  {
    if ( a3 >= 0xAE && a3 <= 0x147 && a4 >= 0x145 && a4 <= 0x1D8 )
    {
      Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 0);
      sub_32714(a1, a3, a4);
      return 0xFFFFFFFF;
    }
    return 0;
  }
  if ( (unsigned __int16)a2 < 0xCu )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
  }
  if ( (unsigned __int16)a2 <= 0xCu )
  {
    if ( a3 < 0xAE || a3 > 0x147 || a4 < 0x145 || a4 > 0x1D8 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)"tinyrace", 0);
    return 0xFFFFFFFF;
  }
  else
  {
    if ( a2 != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    ItemValue_sub_2ECA4 = Q_Wnd10LB_GetItemValue_sub_2ECA4(*(P_Wnd10LB *)(a1 + 0xAB), a3);
    sub_32800(a1, ItemValue_sub_2ECA4);
    if ( *(_DWORD *)(a1 + 0xB7) == 0xFFFFFFFF )
    {
      *(_DWORD *)(a1 + 0xB7) = 0;
    }
    return 0xFFFFFFFF;
  }
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032414) --------------------------------------------------------
void __fastcall sub_32414(int a1)
{
  T_WndA2 *Wnd_sub_56DA8; // eax
  __int16 v2; // di
  void *v3; // eax
  WORD v4; // bx
  __int16 v5; // ax
  __int16 v6; // dx
  LONG v7; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v9; // eax
  char *sub_1CEA8; // eax
  LONG v11; // [esp-1Ch] [ebp-50h]
  LONG v12; // [esp-8h] [ebp-3Ch]
  PANE pane; // [esp+0h] [ebp-34h] BYREF
  P_WndA2 result; // [esp+14h] [ebp-20h]
  LONG v15; // [esp+18h] [ebp-1Ch]
  int v16; // [esp+1Ch] [ebp-18h]

  result = (P_WndA2)a1;
  pane = V_GSystem.pane;
  if ( *(_WORD *)(a1 + 0xC1) )
  {
    pane.x0 = 0xAE;
    pane.y0 = 0x145;
    pane.x1 = 0x147;
    pane.y1 = 0x1D8;
    VFX_pane_wipe(&pane, 0xF2);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
    Wnd_sub_56DA8 = Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "INTELSCREEN", 0);
    LOWORD(Wnd_sub_56DA8) = GwshareShpCacheIndexes[0x29];
    v16 = (int)Wnd_sub_56DA8;
    if ( SHIWORD(result[1].pane.y1) > 0 )
    {
      v2 = 0;
      do
      {
        v4 = *((_WORD *)&dword_96840 + v2 + 1);
        v5 = word_9682E[v2];
        v6 = word_96838[v2];
        v7 = v5;
        v11 = v5;
        v15 = v6;
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[v4]);
        VFX_shape_transform(&V_GSystem.pane, ShapeTable_sub_1B084, 0, v11, v6, V_BigBuffer, 0, 0x8000, 0x8000, 0);
        v12 = v15;
        if ( v2 == LOWORD(result[1].pane.y1) )
        {
          v9 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v16);
          Q_DrawRaceTintedShape_sub_53EB8(&V_GSystem.pane, v9, 4, v7, v12, v4);
        }
        else
        {
          v3 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v16);
          Q_DrawRaceTintedShape_sub_53EB8(&V_GSystem.pane, v3, 3, v7, v12, v4);
        }
        ++v2;
      }
      while ( v2 < SHIWORD(result[1].pane.y1) );
    }
  }
  pane.x0 = 7;
  pane.y0 = 0x145;
  pane.x1 = 0xA5;
  pane.y1 = 0x163;
  VFX_pane_wipe(&pane, 0xF2);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1A);// 26: "Selected System"
  WinMgr.SmallFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 2, 2, sub_1CEA8, 0, 0xFFFF, 0xFF, 0);
  WinMgr.LargeFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0xD, V_Game.pCurStar->name, 0, 0xFFFF, 0xFF, 0);
  if ( result->childrenNum )
  {
    sub_2D218(result);
  }
}
// 9682E: using guessed type __int16 word_9682E[5];
// 96838: using guessed type __int16 word_96838[4];
// 96840: using guessed type int dword_96840;
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00032658) --------------------------------------------------------
void *__fastcall sub_32658(int a1)
{
  void *result; // eax
  WORD v3; // dx
  int v4; // ebx

  *(_WORD *)(a1 + 0xC1) = 0;
  *(_WORD *)(a1 + 0xBF) = 0;
  result = (char *)&dword_96840 + 2;
  memset((char *)&dword_96840 + 2, 0xFFFFFFFF, 0xAu);
  if ( V_Game.racesNum > 0 )
  {
    v3 = 0;
    do
    {
      result = (void *)v3;
      if ( v3 != V_PlayerRaceIndex
        && v3 != (unsigned __int8)byte_968DD
        && V_Game.races[v3].extinct != 0xFFFFFFFF
        && V_Game.races[V_PlayerRaceIndex].treaties[v3] )
      {
        if ( V_Game.races[(unsigned __int8)byte_968DD].treaties[v3] )
        {
          LOWORD(result) = *(_WORD *)(a1 + 0xC1);
          v4 = (__int16)result;
          result = (char *)result + 1;
          *(_WORD *)(a1 + 0xC1) = (_WORD)result;
          *((_WORD *)&dword_96840 + v4 + 1) = v3;
        }
      }
      ++v3;
    }
    while ( v3 < V_Game.racesNum );
  }
  return result;
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032714) --------------------------------------------------------
int __fastcall sub_32714(int a1, int a2, __int16 a3)
{
  __int16 v5; // dx
  int result; // eax
  __int16 v7; // cx
  __int16 v8; // bx
  int v9; // edx
  __int16 v10; // ax
  char v11[16]; // [esp+0h] [ebp-20h] BYREF
  int v12; // [esp+10h] [ebp-10h]

  v12 = a2;
  v5 = *(_WORD *)(a1 + 0xC1);
  result = 0;
  if ( v5 > 0 )
  {
    do
    {
      v7 = v12 - word_9682E[(__int16)result];
      v8 = a3 - word_96838[(__int16)result];
      if ( v7 < 0x16 && v7 > (int)0xFFFFFFEA && v8 < 0x16 && v8 > (int)0xFFFFFFEA )
      {
        break;
      }
      ++result;
    }
    while ( (__int16)result < *(__int16 *)(a1 + 0xC1) );
  }
  if ( (__int16)result < *(__int16 *)(a1 + 0xC1) && (_WORD)result != *(_WORD *)(a1 + 0xBF) )
  {
    v9 = *(_DWORD *)(a1 + 0xB7);
    *(_WORD *)(a1 + 0xBF) = result;
    if ( !v9 )
    {
      v10 = sub_44238(
              (int)&V_Game.races[V_PlayerRaceIndex],
              (unsigned __int8)byte_968DD,
              v11,
              *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
      sub_32A48(a1, (int)v11, v10, 0, 0xFFFFFFFF);
    }
    return (*(int (**)(void))(*(_DWORD *)(a1 + 0xA7) + 0xC))();
  }
  return result;
}
// 9682E: using guessed type __int16 word_9682E[5];
// 96838: using guessed type __int16 word_96838[4];
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032800) --------------------------------------------------------
void __fastcall sub_32800(int a1, int a2)
{
  int v3; // ebx
  T_Race *v4; // edi
  __int16 v5; // ax
  char v6; // bl
  char v7; // cl
  __int16 v8; // ax
  char v9[16]; // [esp+0h] [ebp-30h] BYREF
  char v10[16]; // [esp+10h] [ebp-20h] BYREF
  int pCurStar; // [esp+20h] [ebp-10h]
  int v12; // [esp+24h] [ebp-Ch]
  int v13; // [esp+28h] [ebp-8h]
  P_Race v14; // [esp+2Ch] [ebp-4h]

  v13 = V_PlayerRaceIndex;
  v3 = (unsigned __int8)byte_968DD;
  v14 = &V_Game.races[V_PlayerRaceIndex];
  v4 = &V_Game.races[v3];
  if ( *(_DWORD *)(a1 + 0xB7) != 0xFFFFFFFF )
  {
    v6 = a2;
    if ( (_BYTE)a2 == 0xE )
    {
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
      return;
    }
    pCurStar = 0;
    byte_101DC4[a2] = 1;
    if ( (unsigned __int8)a2 < 9u )
    {
      if ( (_BYTE)a2 != 7 )
      {
        goto LABEL_14;
      }
    }
    else if ( (unsigned __int8)a2 > 0xBu )
    {
      if ( (_BYTE)a2 == 0xC )
      {
        pCurStar = (int)V_Game.pCurStar;
      }
      goto LABEL_14;
    }
    pCurStar = *((__int16 *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1);
LABEL_14:
    v12 = (char)a2;
    v7 = sub_44BCC(v4, (__int16 *)V_PlayerRaceIndex, a2, pCurStar, 0);
    sub_32C14(a1, v7);
    sub_450B0(v14, (unsigned __int8)byte_968DD, v6, v7, pCurStar, 0);
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, *(_DWORD *)(*(_DWORD *)(a1 + 0xB3) + 0x41), 0xD, 0, 0);
    v8 = sub_44238((int)v14, (unsigned __int8)byte_968DD, v10, *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
    sub_32A48(a1, (int)v10, v8, 0xFFFFFFFF, 0xFFFFFFFF);
    return;
  }
  if ( (_BYTE)a2 == 1 )
  {
    V_Game.pCurStar = (P_Star)V_Game.races[(unsigned __int8)byte_968DD].Unknown_1EA;
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 0);
  }
  else
  {
    sub_450B0(&V_Game.races[v3], v13, v4->Unknown_1E9, a2, v4->Unknown_1EA, 0);
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, *(_DWORD *)(*(_DWORD *)(a1 + 0xB3) + 0x41), 0xD, 0, 0);
    v4->Unknown_1E9 = 0xE;
    v5 = sub_44238((int)v14, (unsigned __int8)byte_968DD, v9, *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
    sub_32A48(a1, (int)v9, v5, 0xFFFFFFFF, 0xFFFFFFFF);
    sub_32BDC(a1, 0xE);
  }
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032A1C) --------------------------------------------------------
__int64 __fastcall sub_32A1C(int a1)
{
  if ( !*(_DWORD *)(a1 + 0xB7) )
  {
    sub_32A48(a1, 0, 0, 0, 0);
  }
  return (unsigned int)(*(int (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
}

//----- (00032A48) --------------------------------------------------------
__int64 __fastcall sub_32A48(int a1, int a2, __int16 a3, int a4, int a5)
{
  T_Wnd10LB *v6; // eax
  __int16 v7; // si
  UWORD selectedIndex; // dx
  int v9; // edx
  char *v10; // eax
  unsigned __int16 v11; // ax
  T_Wnd10LB *v13; // [esp+0h] [ebp-18h]
  UWORD v14; // [esp+8h] [ebp-10h]

  word_103F94 = 0;
  if ( a5 )
  {
    qmemcpy(byte_100340, (const void *)a2, 0xCu);
    qmemcpy(&byte_100340[0xC], (const void *)(a2 + 0xC), 3u);
    word_100350 = a3;
  }
  v6 = *(T_Wnd10LB **)(a1 + 0xAB);
  selectedIndex = v6->_selectedIndex;
  Q_Wnd10LB_Clear_sub_2ED4C(v6);
  v14 = selectedIndex;
  if ( word_100350 > 0 )
  {
    v7 = 0;
    do
    {
      v9 = byte_100340[v7];
      if ( !byte_101DC4[v9] )
      {
        v10 = sub_32C48(a1, v9, 0xFFFFFFFF, 0xFFFFFFFF);
        v13 = *(T_Wnd10LB **)(a1 + 0xAB);
        v11 = Q_Wnd10LB_AddItem_sub_2EA8C(v13, v10, 0xFFFF, 0);
        Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xAB), v11, byte_100340[v7]);
      }
      ++v7;
    }
    while ( v7 < word_100350 );
  }
  if ( !a4 )
  {
    Q_Wnd10LB_SetSelectedIndex_sub_2ECDC(*(P_Wnd10LB *)(a1 + 0xAB), v14);
  }
  return (unsigned int)(*(int (__cdecl **)(T_Wnd10LB *))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xA7) + 0xC))(v13);
}
// 32B38: variable 'v13' is possibly undefined
// 100350: using guessed type __int16 word_100350;
// 103F94: using guessed type __int16 word_103F94;

//----- (00032B44) --------------------------------------------------------
__int64 __fastcall sub_32B44(int a1, int a2, __int16 a3)
{
  T_Wnd10LB *v4; // eax
  char *v5; // eax
  unsigned __int16 v6; // ax
  int i; // edi
  char *v9; // [esp+0h] [ebp-1Ch]

  v4 = *(T_Wnd10LB **)(a1 + 0xAB);
  word_103F94 = 0;
  Q_Wnd10LB_Clear_sub_2ED4C(v4);
  for ( i = 0; (__int16)i < a3; ++i )
  {
    v9 = (char *)((__int16)i + a2);
    v5 = sub_32C48(a1, *v9, 0xFFFFFFFF, 0);
    v6 = Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(a1 + 0xAB), v5, 0xFFFF, 0);
    Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xAB), v6, *v9);
  }
  return (unsigned int)(*(int (**)(void))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xA7) + 0xC))();
}
// 103F94: using guessed type __int16 word_103F94;

//----- (00032BDC) --------------------------------------------------------
__int64 __fastcall sub_32BDC(int a1, char a2)
{
  *(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xAB) = sub_32C48(a1, a2, 0, 0xFFFFFFFF);
  return (unsigned int)(*(int (**)(void))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xA7) + 0xC))();
}

//----- (00032C14) --------------------------------------------------------
__int64 __fastcall sub_32C14(int a1, char a2)
{
  *(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xAB) = sub_32C48(a1, a2, 0, 0);
  return (unsigned int)(*(int (**)(void))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xA7) + 0xC))();
}

//----- (00032C48) --------------------------------------------------------
char *__fastcall sub_32C48(int a1, char a2, int a3, int a4)
{
  char *v5; // ebx
  char *v6; // ebx
  char *v7; // edx
  char *name; // esi
  char v9; // al
  char *v12; // [esp+4h] [ebp-18h]

  if ( word_103F94 >= 0xF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x27B);
  }
  if ( a3 )
  {
    v12 = (char *)&unk_103454 + 0xB4 * word_103F94 + 0xB4;
  }
  else
  {
    v12 = (char *)&unk_103454;
  }
  if ( a4 )
  {
    if ( a3 )
    {
      v5 = (char *)&unk_100744 + 0x80 * a2;
    }
    else
    {
      v5 = (char *)&unk_101DD4 + 0x80 * a2;
    }
  }
  else
  {
    if ( a3 )
    {
      v6 = (char *)&unk_100EC4;
    }
    else
    {
      v6 = (char *)&unk_102554;
    }
    v5 = &v6[0x80 * a2];
  }
  v7 = v12;
  while ( *v5 )
  {
    name = 0;
    if ( *v5 == 0x25 )
    {
      v9 = v5[1];
      if ( (unsigned __int8)v9 < 0x73u )
      {
        if ( v9 == 0x6D )
        {
          if ( a3 )
          {
            goto LABEL_16;
          }
LABEL_18:
          name = V_SpecNames[V_Game.races[(unsigned __int8)byte_968DD].species];
        }
      }
      else
      {
        if ( (unsigned __int8)v9 <= 0x73u )
        {
          if ( a3 )
          {
            name = V_Game.pCurStar->name;
          }
          else
          {
            name = (char *)(V_Game.races[(unsigned __int8)byte_968DD].Unknown_1EA + 0x1C);
          }
          goto LABEL_32;
        }
        if ( (unsigned __int8)v9 <= 0x74u )
        {
          if ( a3 == 0xFFFFFFFF && a4 == 0xFFFFFFFF )
          {
            name = V_SpecNames[V_Game.races[*((__int16 *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1)].species];
          }
          else
          {
            name = V_SpecNames[V_Game.races[V_Game.races[(unsigned __int8)byte_968DD].Unknown_1EA].species];
          }
        }
        else if ( v9 == 0x79 )
        {
          if ( !a3 )
          {
LABEL_16:
            name = V_SpecNames[V_Game.races[V_PlayerRaceIndex].species];
            goto LABEL_32;
          }
          goto LABEL_18;
        }
      }
    }
LABEL_32:
    if ( name )
    {
      strcpy(v7, name);
      ++v5;
      v7 += strlen(v7);
    }
    else
    {
      *v7++ = *v5;
    }
    ++v5;
  }
  *v7 = 0;
  if ( a3 )
  {
    ++word_103F94;
  }
  return v12;
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;
// 103F94: using guessed type __int16 word_103F94;

//----- (00032E84) --------------------------------------------------------
int __fastcall sub_32E84(int a1, int a2, int a3, int a4)
{
  FILE *v5; // eax
  FILE *v6; // esi
  int result; // eax
  FILE *v8; // eax
  FILE *v9; // esi
  char s[16]; // [esp+0h] [ebp-34h] BYREF
  char v11[36]; // [esp+10h] [ebp-24h] BYREF

  if ( (unsigned __int8)byte_968DD >= 0x15u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2D6);
  }
  if ( V_PlayerRaceIndex >= 0x15u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2D7);
  }
  sprintf(s, "RACE%02d.DIP", V_Game.races[(unsigned __int8)byte_968DD].species);
  strcpy(v11, "PLAYER.DIP");
  if ( *(_WORD *)(a1 + 0xBB) != (unsigned __int8)byte_968DD )
  {
    v5 = Q_OpenTextFile_sub_1BB10(s, 0);
    v6 = v5;
    if ( !v5 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2E4);
    }
    sub_32FD8(a1, v5, 0);
    fclose(v6);
    *(_WORD *)(a1 + 0xBB) = (unsigned __int8)byte_968DD;
  }
  result = *(__int16 *)(a1 + 0xBD);
  if ( result != V_PlayerRaceIndex )
  {
    v8 = Q_OpenTextFile_sub_1BB10(v11, 0);
    v9 = v8;
    if ( !v8 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2EF);
    }
    sub_32FD8(a1, v8, 0xFFFFFFFF);
    fclose(v9);
    result = V_PlayerRaceIndex;
    *(_WORD *)(a1 + 0xBD) = V_PlayerRaceIndex;
  }
  return result;
}
// 32E84: could not find valid save-restore pair for edi
// 968DD: using guessed type char byte_968DD;
// 32E84: using guessed type char var_24[36];

//----- (00032FD8) --------------------------------------------------------
int __fastcall sub_32FD8(int a1, FILE *a2, int a3)
{
  __int16 v3; // si
  char *v4; // eax
  __int16 i; // si
  int result; // eax
  char *v7; // eax
  char v8[220]; // [esp+0h] [ebp-DCh] BYREF

  while ( strncmp(v8, "ACTIONS", 7u) )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  }
  Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  v3 = 0;
  while ( strncmp(v8, "RESPONSES", 9u) )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
    if ( a3 )
    {
      v4 = (char *)&unk_100744 + 0x80 * v3;
    }
    else
    {
      v4 = (char *)&unk_101DD4 + 0x80 * v3;
    }
    ++v3;
    strncpy(v4, v8, 0x7Fu);
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  }
  Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  for ( i = 0; ; ++i )
  {
    result = strncmp(v8, "END DIPLO", 9u);
    if ( !result )
    {
      break;
    }
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
    if ( a3 )
    {
      v7 = (char *)&unk_100EC4 + 0x80 * i;
    }
    else
    {
      v7 = (char *)&unk_102554 + 0x80 * i;
    }
    strncpy(v7, v8, 0x7Fu);
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  }
  return result;
}

//----- (000330DC) --------------------------------------------------------
void __fastcall sub_330DC(T_Type5 *a1, unsigned __int8 *a2)
{
  T_WndA2 *Wnd_sub_56DA8; // eax
  int v4; // esi
  const char *v5; // ecx
  void *ShapeTable_sub_1B084; // eax
  void *v7; // eax
  char *sub_1CEA8; // eax
  int v9; // kr04_4
  LONG v10; // ecx
  void *v11; // eax
  WORD v12; // dx
  char *v13; // eax
  int v14; // kr0C_4
  void *v15; // eax
  int TechsNum_sub_40664; // eax
  char *v17; // eax
  int v18; // kr14_4
  LONG v19; // ecx
  void *v20; // eax
  WORD v21; // di
  LONG v22; // kr18_4
  LONG v23; // ebx
  void *v24; // eax
  BYTE v25; // cl
  __int16 i; // di
  __int16 j; // di
  __int16 k; // di
  WORD v29; // [esp-4h] [ebp-5Ch]
  WORD v30; // [esp-4h] [ebp-5Ch]
  WORD v31; // [esp-4h] [ebp-5Ch]
  int v32[2]; // [esp+0h] [ebp-58h] BYREF
  int v33; // [esp+8h] [ebp-50h]
  int v34; // [esp+Ch] [ebp-4Ch]
  int v35; // [esp+10h] [ebp-48h]
  unsigned __int8 *v36; // [esp+14h] [ebp-44h]
  int PlanetsNum_sub_402E0; // [esp+18h] [ebp-40h]
  T_Race *v38; // [esp+1Ch] [ebp-3Ch]
  int v39; // [esp+20h] [ebp-38h]
  P_Race v40; // [esp+24h] [ebp-34h]
  int v41; // [esp+28h] [ebp-30h]
  int v42; // [esp+2Ch] [ebp-2Ch]
  int v43; // [esp+30h] [ebp-28h]
  int v44; // [esp+34h] [ebp-24h]
  LONG v45; // [esp+38h] [ebp-20h]
  LONG hotY; // [esp+3Ch] [ebp-1Ch]
  LONG v47; // [esp+40h] [ebp-18h]
  LONG v48; // [esp+44h] [ebp-14h]
  int v49; // [esp+48h] [ebp-10h]

  v36 = a2;
  Wnd_sub_56DA8 = Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "INTELSCREEN", 0);
  LOWORD(Wnd_sub_56DA8) = GwshareShpCacheIndexes[0x29];// 41: data\14intel.shp
  v49 = (int)Wnd_sub_56DA8;
  v40 = (P_Race)a2;
  v4 = *a2;
  v42 = *a2;
  v35 = 4 * V_Game.races[v4].colorSet + 0x13;
  v32[1] = (__int16)v42;
  Q_DrawRaceFlagTinted_sub_53E38((PANE *)a1, 3, 3, v42);
  v5 = V_SpecNames[V_Game.races[v4].species];
  v34 = (__int16)v35;
  WinMgr.LargeFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x14, 5, v5, 0, v35, 0xFF, 0);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[v42]);
  VFX_shape_transform((PANE *)a1, ShapeTable_sub_1B084, 0, 0x96, 0x1E, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  v7 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v49);
  v45 = 0xC8;
  Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v7, 3, 0x96, 0x1E, v42);
  v32[0] = 0;
  Q_Race_GetShips_sub_40224((P_Race)a2, 0, v32);
  v43 = 0x14;
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x14);// 20: "Fleet"
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xC8, 5, sub_1CEA8, 0, v34, 0xFF, 0);
  v9 = 0;
  for ( i = 0; i < v32[0]; ++i )
  {
    v10 = v45;
    v29 = v42;
    v11 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v11, 5, v10, 8 * v9 + 0x14, v29);
    v45 += 8;
    if ( i % 9 == 8 )
    {
      v45 = 0xC8;
      ++v9;
    }
  }
  v12 = v35;
  PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(v40);
  v48 = 0x118;
  v41 = 0x14;
  v13 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x15);      // 21: "Colonies"
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x118, 5, v13, 0, v12, 0xFF, 0);
  v14 = 0;
  for ( j = 0; j < PlanetsNum_sub_402E0; ++j )
  {
    v30 = v42;
    v15 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v15, 6, v48, 8 * v14 + 0x14, v30);
    v48 += 8;
    if ( j % 9 == 8 )
    {
      v48 = 0x118;
      ++v14;
    }
  }
  TechsNum_sub_40664 = Q_Race_GetTechsNum_sub_40664(v40);
  v47 = 0x168;
  v39 = TechsNum_sub_40664 >> 2;
  v44 = 0x14;
  v17 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x16);      // 22: "Discoveries"
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x168, 5, v17, 0, v35, 0xFF, 0);
  v18 = 0;
  for ( k = 0; k < v39; ++k )
  {
    v19 = v47;
    v31 = v42;
    v20 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v20, 7, v19, 8 * v18 + 0x14, v31);
    v47 += 8;
    if ( k % 9 == 8 )
    {
      v47 = 0x168;
      ++v18;
    }
  }
  v38 = &V_Game.races[V_PlayerRaceIndex];
  hotY = 5;
  if ( V_Game.racesNum > 0 )
  {
    v22 = hotY;
    v21 = 0;
    do
    {
      if ( v21 != v42 && v40->treaties[v21] && !V_Game.races[v21].extinct && (v38->treaties[v21] || v21 == V_PlayerRaceIndex) )
      {
        v33 = v21;
        Q_DrawRaceFlagTinted_sub_53E38((PANE *)a1, 0x1CC, v22, v21);
        v25 = v40->treaties[v33];
        v23 = 0xFFFFFFFF;
        if ( v25 == 3 )
        {
          v23 = 9;
        }
        else if ( v25 == 2 )
        {
          v23 = 8;
        }
        if ( v23 != 0xFFFFFFFF )
        {
          v24 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);// 41: data\14intel.shp
          VFX_shape_draw((PANE *)a1, v24, v23, 0x1CC, v22);
        }
      }
      ++v21;
    }
    while ( v21 < V_Game.racesNum );
  }
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00033598) --------------------------------------------------------
void __fastcall __spoils<> Q_WndIW_sub_33598(P_WndIW a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a);
  a1->a.pProcs = (P_Procs)&off_95F04;
  Q_WndIW_sub_335F8(a1);
}
// 95F04: using guessed type int (__fastcall *off_95F04)(P_WndA2 a1);

//----- (000335B4) --------------------------------------------------------
T_WndA2 *__fastcall sub_335B4(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95EC4);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95F04;
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95F04: using guessed type int (__fastcall *off_95F04)(P_WndA2 a1);

//----- (000335F8) --------------------------------------------------------
void __fastcall __spoils<> Q_WndIW_sub_335F8(P_WndIW result)
{
  result->Unknown = 0;
}

//----- (00033604) --------------------------------------------------------
int __fastcall sub_33604(int a1, __int16 a2, LONG a3, LONG a4)
{
  T_Wnd10LB *Wnd_sub_56DA8; // eax

  if ( a2 != 1 )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  if ( !*(_DWORD *)(a1 + 0xAB) )
  {
    Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "INTELLIST", 0);
    *(_DWORD *)(a1 + 0xAB) = Wnd_sub_56DA8;
    Wnd_sub_56DA8->_defaultItemHeight = 0x3C;
    Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), (P_DrawItemFunc)sub_330DC);
  }
  return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, 1u, a3, a4);
}

//----- (00033674) --------------------------------------------------------
void __fastcall sub_33674(T_Wnd08SW *a1)
{
  PANE *p_pane; // esi
  char *sub_1CEA8; // eax
  unsigned __int16 v3; // ax
  int i; // esi
  WORD v5; // [esp-Ch] [ebp-60h]
  char *v6; // [esp-4h] [ebp-58h]
  char s[52]; // [esp+0h] [ebp-54h] BYREF
  P_WndA2 result; // [esp+34h] [ebp-20h]
  int v9; // [esp+38h] [ebp-1Ch] BYREF
  int PlanetsNum_sub_402E0; // [esp+3Ch] [ebp-18h]

  result = &a1->a;
  p_pane = &a1->a.pane;
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &a1->a.pane);
  Q_DrawRaceFlagTinted_sub_53E38(p_pane, 3, 3, V_PlayerRaceIndex);
  v6 = V_SpecNames[V_Game.races[V_PlayerRaceIndex].species];
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1B);// 27: "%s Intelligence"
  sprintf(s, sub_1CEA8, v6);
  v5 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  WinMgr.LargeFont.pane = *p_pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 9, s, 2u, v5, 0xFF, 0);
  Q_Wnd10LB_Clear_sub_2ED4C((P_Wnd10LB)result[1].magic12345678);
  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    if ( i == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[i] && !V_Game.races[i].extinct )
    {
      v9 = 0;
      Q_Race_GetShips_sub_40224(&V_Game.races[i], 0, &v9);
      PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[i]);
      v3 = Q_Wnd10LB_AddItem_sub_2EA8C((P_Wnd10LB)result[1].magic12345678, (BYTE *)&V_Game.races[i], 0xFFFF, 0);
      Q_Wnd10LB_SetItemValue_sub_2EC50((P_Wnd10LB)result[1].magic12345678, v3, -(PlanetsNum_sub_402E0 + v9));
    }
  }
  Q_Wnd10LB_SetCompareProc_sub_2F1D8((P_Wnd10LB)result[1].magic12345678, Q_CompareListBoxItems_sub_10A14);
  Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0((P_Wnd10LB)result[1].magic12345678);
  sub_2D218(result);
}

//----- (00033830) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd22AW_Ctor_sub_33830(P_Wnd22AW self)
{
  Q_Wnd20HW_Ctor_sub_2FC50(&self->super);
  self->super.super.pProcs = &Wnd22AW_Procs;
}

//----- (00033840) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd22AW_Dtor_sub_33840(P_Wnd22AW self, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(self, &C_Wnd22AW);
    operator delete[](v3);
  }
  else
  {
    self->super.super.pProcs = &Wnd22AW_Procs;
    Q_Wnd20HW_Dtor_sub_2FC68(&self->super, 1u);
    if ( (v2 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00033884) --------------------------------------------------------
void __fastcall Q_Wnd22AW_ShowHelpTopicAbil_sub_33884(P_Wnd22AW pAbilWnd)
{
  char helptopic[32]; // [esp+0h] [ebp-20h] BYREF

  sprintf(helptopic, "abil%02d", V_Game.races[V_PlayerRaceIndex].ability);
  Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(&pAbilWnd->super, "help.txt", helptopic);
}

//----- (000338DC) --------------------------------------------------------
int __fastcall Q_Wnd22AW_Proc3_sub_338DC(P_Wnd22AW pAbilWnd, UWORD message, int param1, int param2)
{
  int raceIndex; // eax
  T_Race *pRace; // esi
  int willTakeDays; // edx
  int v8; // eax
  char *text_s; // eax
  char *textOK; // esi
  P_Procs pProcs; // ebx
  char s[100]; // [esp+0h] [ebp-84h] BYREF
  char helptopic[32]; // [esp+64h] [ebp-20h] BYREF

  raceIndex = V_PlayerRaceIndex;
  pRace = &V_Game.races[raceIndex];
  if ( !message )
  {
    return Q_Wnd20HW_Proc3_sub_2FD68(&pAbilWnd->super, message, param1, param2);
  }
  if ( message <= 1u )
  {
    if ( Q_Race_UseAbility_sub_434E4(&V_Game.races[raceIndex], 0) == TRUE )
    {
      pAbilWnd->super.helpItems[2].Unknown_04 = 2;
    }
    else
    {
      Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, (*pAbilWnd->super.super.children)[0]->index, 2, 0, 0);
      willTakeDays = V_AbilityDays[pRace->ability] - pRace->daysAfterAbilityUse;
      if ( willTakeDays == 1 )
      {
        v8 = 0x1C;                                     // 28: ""
      }
      else
      {
        v8 = 0x1D;                                     // 29: "s"
      }
      text_s = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v8);
      sprintf(s, pAbilWnd->super.helpItems[2].pText, willTakeDays, text_s);
      strcpy(pAbilWnd->super.helpItems[2].pText, s);
      textOK = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);// 30: "OK"
      strcpy((*pAbilWnd->super.super.children)[1]->name, textOK);
    }
    pAbilWnd->super.super.Unknown_35 = 0xFFFFFFFF;
    pProcs = pAbilWnd->super.super.pProcs;
    pAbilWnd->super.super.Unknown_39 = 0xFFFFFFFF;
    pProcs->proc4_draw(&pAbilWnd->super.super, 0);
    return 0;
  }
  else
  {
    if ( message != 0x32 || param1 != 1 )
    {
      return Q_Wnd20HW_Proc3_sub_2FD68(&pAbilWnd->super, message, param1, param2);
    }
    Q_Race_UseAbility_sub_434E4(&V_Game.races[raceIndex], 1);
    sprintf(helptopic, "abres%02d", pRace->ability);
    Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(&pAbilWnd->super, "help.txt", helptopic);
    pAbilWnd->super.super.pProcs->proc4_draw((P_WndA2)pAbilWnd, 0);
    return 0;
  }
}
// 338DC: using guessed type char s[100];

//----- (00033A68) --------------------------------------------------------
void __fastcall Q_Wnd22AW_Proc4_sub_33A68(P_WndA2 pWnd, int a2)
{
  void *ShapeTable_sub_1B084; // eax
  void *v4; // eax
  LONG colorSet; // [esp-Ch] [ebp-18h]

  Q_Wnd20HW_Proc4_sub_30774((P_Wnd20HW)pWnd, 0);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, V_PlayerRaceIndex);
  VFX_shape_draw(&pWnd->pane, ShapeTable_sub_1B084, 0, 0xFA, 0x41);
  colorSet = V_Game.races[V_PlayerRaceIndex].colorSet;
  v4 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, 0x21u);
  VFX_shape_draw(&pWnd->pane, v4, colorSet, 0xFA, 0x41);
}

//----- (00033AF0) --------------------------------------------------------
// Initializes a planet's surface and orbital configuration
// 
// @param pPlanet Pointer to planet object to initialize
// @param planetSize Requested planet size (0-4, clamped to 4)
// @param planetType Requested planet type (0-10, clamped to 10)
// @param pSquaresArray Pre-allocated array for planet squares
// @return Total number of squares allocated for the planet
UWORD __fastcall Q_Planet_Initialize_sub_33AF0(P_Planet pPlanet, UWORD planetSize, UWORD planetType, P_Square pSquaresArray)
{
  int txtLoaded; // ebx
  int i; // eax
  UWORD v7; // bx
  T_PlanetSurface *surface; // ebx
  signed int blackThreshold; // ebp
  int habitableSquares; // ecx
  UBYTE squareColor; // al
  int randVal; // eax
  unsigned __int8 flags; // al
  UWORD surfaceSquaresNum; // bx
  int v15; // eax
  UWORD maximumPopulation; // ax
  int j; // ebx
  int greenThreshold; // [esp+0h] [ebp-10h]
  int blueThreshold; // [esp+4h] [ebp-Ch]
  int redThreshold; // [esp+8h] [ebp-8h]

  if ( pPlanet->pSquares && planetSize != pPlanet->size )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x41);
  }
  txtLoaded = V_PlanetCfg.txtLoaded;
  pPlanet->pSquares = pSquaresArray;
  if ( !txtLoaded )
  {
    Q_PLANET_CPP_LoadPlanItemTxt_sub_33D30();
  }
  if ( planetSize >= 5u )
  {
    pPlanet->size = ASCEND_PLANET_SIZE_ENORMOUS;
  }
  else
  {
    pPlanet->size = planetSize;
  }
  pPlanet->surfaceSquaresNum = 0;
  // Calculate surface squares from configuration
  for ( i = 0; i < 15; ++i )
  {
    v7 = V_PlanetCfg.squares.sizes[pPlanet->size].column[i] + pPlanet->surfaceSquaresNum;
    pPlanet->surfaceSquaresNum = v7;
  }
  if ( v7 > 100u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x52);
  }
  // Set total squares (surface + 10 orbital slots)
  pPlanet->totalSquaresNum = pPlanet->surfaceSquaresNum + 10;
  if ( planetType >= 11u )
  {
    pPlanet->type = ASCEND_PLANET_TYPE_CONGENIAL;
  }
  else
  {
    pPlanet->type = planetType;
  }
  // Initialize square colors based on planet type distribution
  surface = &V_PlanetCfg.surfaces[pPlanet->type];
  blackThreshold = 0x7FFF * (unsigned int)surface->black / 100;
  redThreshold = 0x7FFF * (unsigned int)surface->red / 100 + blackThreshold;
  greenThreshold = 0x7FFF * (unsigned int)surface->green / 100 + redThreshold;
  habitableSquares = 0;
  blueThreshold = 0x7FFF * (unsigned int)surface->blue / 100 + greenThreshold;
  for ( j = 0; j < pPlanet->totalSquaresNum; ++j )
  {
    pPlanet->pSquares[j].planetItemIndex = 0xFF;
    pPlanet->pSquares[j].flags = 0;
    squareColor = ASCEND_SQUARE_COLOR_WHITE;
    if ( j < pPlanet->surfaceSquaresNum )
    {
      randVal = rand();
      if ( randVal >= blackThreshold )
      {
        ++habitableSquares;
        if ( randVal >= redThreshold )
        {
          if ( randVal >= greenThreshold )
          {
            if ( randVal >= blueThreshold )
            {
              squareColor = ASCEND_SQUARE_COLOR_WHITE;
            }
            else
            {
              squareColor = ASCEND_SQUARE_COLOR_BLUE;
            }
          }
          else
          {
            squareColor = ASCEND_SQUARE_COLOR_GREEN;
          }
        }
        else
        {
          squareColor = ASCEND_SQUARE_COLOR_RED;
        }
      }
      else
      {
        squareColor = ASCEND_SQUARE_COLOR_BLACK;
      }
    }
    pPlanet->pSquares[j].color = squareColor;
  }
  pPlanet->flags = 0;
  flags = pPlanet->flags;
  pPlanet->buildingProgress = flags;
  pPlanet->Unknown_4E = flags;
  pPlanet->usedPopulation = flags;
  pPlanet->prosperity = flags;
  pPlanet->research = flags;
  pPlanet->industry = flags;
  pPlanet->population = flags;
  // Randomly add xeno ruins (1 in 7 chance)
  if ( !(rand() % 7) )
  {
    surfaceSquaresNum = pPlanet->surfaceSquaresNum;
    v15 = rand();
    pPlanet->pSquares[v15 % surfaceSquaresNum].color |= ASCEND_SQUARE_XENO_RUINS;
    pPlanet->flags |= 2u;
  }
  pPlanet->_squareIndex = 0xFFFF;
  pPlanet->buildingPlanetItemIndex = 0xFF;
  // Set population capacity based on habitable squares
  maximumPopulation = habitableSquares / 3 + 5;
  pPlanet->maximumPopulation2 = maximumPopulation;
  pPlanet->maximumPopulation = maximumPopulation;
  pPlanet->raceIndex = 0xFF;
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
  pPlanet->Unknown_5E = 0;
  return pPlanet->totalSquaresNum;
}

//----- (00033D30) --------------------------------------------------------
void __fastcall Q_PLANET_CPP_LoadPlanItemTxt_sub_33D30()
{
  FILE *fp; // esi
  MACRO_VFX_BOOL found; // edi
  int v2; // kr0C_4
  int v3; // kr10_4
  int v4; // kr1C_4
  int v5; // kr20_4
  int v6; // kr2C_4
  int v7; // kr30_4
  char *v8; // kr44_4
  int l; // edx
  int v10; // ecx
  int n; // edx
  int len; // kr04_4
  int v13; // kr3C_4
  int i; // edi
  int j; // edi
  int k; // edi
  int m; // kr38_4
  char bufc[196]; // [esp+0h] [ebp-ECh] BYREF
  int bufi; // [esp+C8h] [ebp-24h] BYREF
  unsigned __int16 val2; // [esp+CCh] [ebp-20h] BYREF
  UWORD val3; // [esp+D0h] [ebp-1Ch] BYREF
  BYTE val4; // [esp+D4h] [ebp-18h] BYREF
  BYTE val5; // [esp+D8h] [ebp-14h] BYREF
  UWORD val6; // [esp+DCh] [ebp-10h] BYREF
  UBYTE val7; // [esp+E0h] [ebp-Ch] BYREF
  char *name; // [esp+E8h] [ebp-4h]

  fp = Q_OpenTextFile_sub_1BB10("planitem.txt", 0);
  if ( fp )
  {
    found = FALSE;
    do
    {
      fgets(bufc, 195, fp);
      if ( bufc[0] == '#' )
      {
        found = TRUE;
      }
    }
    while ( found == FALSE );
    fscanf(fp, "%d", &bufi);
    V_PopGrowthAmount50 = bufi;
    for ( i = 0; i < 11; ++i )
    {
      v2 = i;
      v3 = 0;
      do
      {
        fscanf(fp, "%d", &bufi);
        *(&V_PlanetCfg.surfaces[v2].black + v3++) = bufi;// Actually V_PlanetCfg->surfaces
      }
      while ( v2 * 4 + v3 != 4 * i + 4 );
    }
    for ( j = 0; j < 5; ++j )
    {
      v4 = j;
      v5 = 0;
      do
      {
        fscanf(fp, "%d", &bufi);
        V_PlanetCfg.offsets.sizes[v4].column[v5++] = bufi;
      }
      while ( v4 * 0xF + v5 != 0xF * j + 0xF );
    }
    for ( k = 0; k < 5; ++k )
    {
      v6 = k;
      v7 = 0;
      do
      {
        fscanf(fp, "%d", &bufi);
        V_PlanetCfg.squares.sizes[v6].column[v7++] = bufi;
      }
      while ( v6 * 0xF + v7 != 0xF * k + 0xF );
    }
    fscanf(fp, "%d %d %d", &bufi, &val2, &val3);
    if ( bufi != 39 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0xE1);
    }
    V_PlanetItems.surfaceItemsNum = val2;
    V_PlanetItems.orbitalItemsNum = val3;
    if ( val2 + val3 > 39 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0xE6);
    }
    name = V_PlanetItems.item[0].name;
    v8 = V_PlanetItems.item[0].name;
    for ( m = 0; m != 0x27; ++m )
    {
      fscanf(fp, "%s %d %d %d %d %d %d %d", &v8[0x28 * m], &bufi, &val2, &val3, &val4, &val5, &val6, &val7);
      l = 0;
      len = strlen(&v8[0x28 * m]) + 1;
      v10 = len - 1;
      v13 = m;
      if ( len - 1 > 0 )
      {
        do
        {
          if ( V_PlanetItems.item[v13].name[l] == '^' )
          {
            V_PlanetItems.item[v13].name[l] = ' ';
          }
          ++l;
        }
        while ( l < len - 1 );
      }
      V_PlanetItems.item[m].ind = bufi;
      V_PlanetItems.item[m].flags = 0;
      V_PlanetItems.item[m].res = val2;
      V_PlanetItems.item[m].pros = val3;
      V_PlanetItems.item[m].mpop = val4;
      V_PlanetItems.item[m].upop = val5;
      V_PlanetItems.item[m].cost = val6;
      V_PlanetItems.item[m].resReq = val7;
      for ( n = 0; n < 8; ++n )
      {
        fscanf(fp, "%d", &bufi);
        if ( bufi == 0xFF )
        {
          break;
        }
        LOWORD(v10) = V_PlanetItems.item[m].flags;
        v10 |= 1 << bufi;
        V_PlanetItems.item[m].flags = v10;
      }
    }
    fclose(fp);
  }
  V_PlanetCfg.txtLoaded = TRUE;
}
/* Orphan comments:
 0  0  0  0  4  4  5  0  0  0  0  0  0  0  0 
 0  0  0  4  3  4  5  6  0  0  0  0  0  0  0 
 0  0  3  2  3  3  4  5  7  0  0  0  0  0  0 
 0  2  1  1  2  2  3  4  5  7  0  0  0  0  0 
 1  0  0  0  1  1  2  3  4  5  7  0  0  0  0 
 0  0  0  0  2  3  2  0  0  0  0  0  0  0  0 
 0  0  0  1  3  3  3  1  0  0  0  0  0  0  0 
 0  0  1  4  4  5  4  4  1  0  0  0  0  0  0 
 0  2  5  6  6  7  6  6  5  2  0  0  0  0  0 
 3  6  7  8  8  9  8  8  7  6  3  0  0  0  0 
100  0  0  0
 50  2  2  2
 20  3  5  3
  0  3 20  3
 40 10  2  2
 20 20  2  2
 40  2  2 10
 20  3  3 20
 40 10 10 10
 20 15 15 15
  0 33 34 33
*/
// 9684C: using guessed type int V_PopGrowthAmount50;

//----- (0003407C) --------------------------------------------------------
// Counts available build locations on a planet's surface
// Return Number of valid construction squares (max 100)
int __fastcall Q_Planet_CountAvailableBuildSquares_sub_3407C(P_Planet pPlanet)
{
  int availableSquares; // ebp
  T_Square *pPlanetSquare; // eax
  T_SquareGridCoord SquareGridCoords; // eax
  UWORD row; // si
  UWORD column; // di
  unsigned __int16 bottom; // bx
  int i; // [esp+4h] [ebp-10h]
  unsigned __int16 right; // [esp+8h] [ebp-Ch]
  unsigned __int16 top; // [esp+Ch] [ebp-8h]
  unsigned __int16 left; // [esp+10h] [ebp-4h]

  availableSquares = 0;
  for ( i = 0; pPlanet->totalSquaresNum > i && availableSquares < 100; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i];
    if ( (pPlanetSquare->color & ASCEND_SQUARE_XENO_RUINS) == 0
      && (pPlanetSquare->color || V_Game.races[pPlanet->raceIndex].ability == ASCEND_SA_BUILD_ON_BLACK)
      && pPlanet->pSquares[i].planetItemIndex == 0xFF )
    {
      SquareGridCoords = Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(pPlanet, i);
      row = SquareGridCoords.row;
      column = SquareGridCoords.column;
      left = Q_Planet_GetSquareIndex_sub_35968(pPlanet, SquareGridCoords.column - 1, SquareGridCoords.row);
      right = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column + 1, row);
      top = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row - 1);
      bottom = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row + 1);
      ++availableSquares;
      // Don't count if there is no adjacent buildings
      if ( (left == 0xFFFF || (pPlanet->pSquares[left].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (right == 0xFFFF || (pPlanet->pSquares[right].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (top == 0xFFFF || (pPlanet->pSquares[top].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (bottom == 0xFFFF || (pPlanet->pSquares[bottom].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0) )
      {
        --availableSquares;
      }
    }
  }
  return availableSquares;
}

//----- (0003420C) --------------------------------------------------------
// Counts available black (unusable) surface squares that could be terraformed
// Return Number of terraformable black squares (max 100)
int __fastcall Q_Planet_CountTerraformableSquares_sub_3420C(P_Planet pPlanet)
{
  int v2; // ebp
  int result; // eax
  T_Square *pPlanetSquare; // esi
  __int32 v5; // eax
  T_SquareGridCoord gridCoords; // eax
  UWORD row; // si
  UWORD column; // di
  unsigned __int16 bottom; // bx
  int i; // [esp+0h] [ebp-14h]
  unsigned __int16 top; // [esp+8h] [ebp-Ch]
  unsigned __int16 left; // [esp+Ch] [ebp-8h]
  unsigned __int16 right; // [esp+10h] [ebp-4h]

  v2 = 0;
  for ( i = 0; ; ++i )
  {
    result = pPlanet->totalSquaresNum;
    if ( (unsigned __int16)result <= i || v2 >= 100 )
    {
      break;
    }
    pPlanetSquare = &pPlanet->pSquares[i];
    v5 = pPlanetSquare->color & ASCEND_SQUARE_XENO_RUINS;
    if ( (pPlanetSquare->color & ASCEND_SQUARE_XENO_RUINS) == 0 )
    {
      LOBYTE(v5) = pPlanetSquare->color;
      if ( !v5 && pPlanetSquare->planetItemIndex == 0xFF )
      {
        gridCoords = Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(pPlanet, i);
        row = gridCoords.row;
        column = gridCoords.column;
        left = Q_Planet_GetSquareIndex_sub_35968(pPlanet, gridCoords.column - 1, gridCoords.row);
        right = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column + 1, row);
        top = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row - 1);
        bottom = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row + 1);
        ++v2;
        if ( (left == 0xFFFF || (pPlanet->pSquares[left].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
          && (right == 0xFFFF || (pPlanet->pSquares[right].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
          && (top == 0xFFFF || (pPlanet->pSquares[top].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
          && (bottom == 0xFFFF || (pPlanet->pSquares[bottom].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0) )
        {
          --v2;
        }
      }
    }
  }
  return result;
}

//----- (00034368) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Planet_CanPlaceItem_sub_34368(P_Planet pPlanet, UBYTE planetItemIndex, unsigned __int16 squareIndex)
{
  MACRO_VFX_BOOL canPlaceByItem; // ebp
  MACRO_VFX_BOOL canPlaceBySquare; // edi
  int resReq; // eax
  int color; // eax
  T_Square *v8; // eax
  T_Square *pPlanetSquare; // eax
  T_SquareGridCoord coords; // eax
  UWORD row; // cx
  unsigned __int16 bottom; // bx
  int v14; // [esp+0h] [ebp-20h]
  int column; // [esp+8h] [ebp-18h]
  unsigned __int16 left; // [esp+Ch] [ebp-14h]
  unsigned __int16 top; // [esp+14h] [ebp-Ch]
  unsigned __int16 right; // [esp+18h] [ebp-8h]
  unsigned __int16 v19; // [esp+1Ch] [ebp-4h]

  canPlaceByItem = TRUE;
  canPlaceBySquare = TRUE;
  // Reject if planet is uncolonized and item isn't a colony base
  if ( pPlanet->raceIndex == 0xFF && planetItemIndex != ASCEND_PI_05_COLONY_BASE )
  {
    return FALSE;
  }
  if ( planetItemIndex < (unsigned int)ASCEND_PI_39_END )
  {
    canPlaceByItem = FALSE;
    // Check research requirements
    resReq = V_PlanetItems.item[planetItemIndex].resReq;
    if ( resReq == 0xFF || V_Research.num > resReq && ((1 << pPlanet->raceIndex) & V_Research.techs[resReq].knownToRace) != 0 )
    {
      // Check population requirements
      v19 = pPlanet->population - pPlanet->usedPopulation;
      if ( pPlanet->buildingPlanetItemIndex != 0xFF )
      {
        v19 += V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].upop;
      }
      if ( v19 >= V_PlanetItems.item[planetItemIndex].upop )
      {
        canPlaceByItem = TRUE;
      }
      // Special case for ship construction
      if ( canPlaceByItem == TRUE && planetItemIndex == ASCEND_PI_23_SHIP )
      {
        canPlaceByItem = Q_Planet_CanBuildShip_sub_362E0(pPlanet);
      }
    }
    // Colony base exception
    if ( planetItemIndex == ASCEND_PI_05_COLONY_BASE )
    {
      canPlaceByItem = TRUE;
    }
  }
  if ( squareIndex < pPlanet->totalSquaresNum )
  {
    canPlaceBySquare = FALSE;
    // Check if building on black squares is allowed
    if ( planetItemIndex < (unsigned int)ASCEND_PI_39_END
      && ((V_PlanetItems.item[planetItemIndex].flags & ASCEND_PI_FLAG_BUILD_ON_BLACK) != 0
       || V_Game.races[pPlanet->raceIndex].ability == ASCEND_SA_BUILD_ON_BLACK) )
    {
      canPlaceBySquare = TRUE;
    }
    v14 = squareIndex;
    color = pPlanet->pSquares[v14].color;
    if ( pPlanet->pSquares[v14].color
      || planetItemIndex == 0xFF
      || (LOBYTE(color) = planetItemIndex, (V_PlanetItems.item[color].flags & 2) != 0) )
    {
      canPlaceBySquare = TRUE;
    }
    // Verify surface/orbital placement rules
    if ( planetItemIndex != 0xFF
      && planetItemIndex <= (unsigned int)ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER
      && squareIndex < pPlanet->surfaceSquaresNum != planetItemIndex < (int)V_PlanetItems.surfaceItemsNum )
    {
      canPlaceBySquare = FALSE;
    }
    // Check xeno ruins compatibility
    if ( planetItemIndex != 0xFF
      && ((pPlanet->pSquares[squareIndex].color & ASCEND_SQUARE_XENO_RUINS) != 0) != (planetItemIndex == ASCEND_PI_38_XENO_ARCHEOLOGICAL_DIG) )
    {
      canPlaceBySquare = FALSE;
    }
    // Terraforming only on black squares
    if ( planetItemIndex == ASCEND_PI_36_TERRAFORMING )
    {
      v8 = &pPlanet->pSquares[squareIndex];
      if ( v8->color || v8->planetItemIndex != 0xFF )
      {
        canPlaceBySquare = FALSE;
      }
    }
    // Automation special rules
    if ( planetItemIndex == ASCEND_PI_35_AUTOMATION )
    {
      pPlanetSquare = &pPlanet->pSquares[squareIndex];
      if ( (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0
        || pPlanetSquare->planetItemIndex == ASCEND_PI_23_SHIP
        || (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_AUTOMATED) != 0 )
      {
        canPlaceBySquare = FALSE;
      }
    }
    // Check adjacent squares for incomplete construction
    if ( squareIndex < pPlanet->surfaceSquaresNum
      && (pPlanet->pSquares[squareIndex].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0
      && planetItemIndex != ASCEND_PI_05_COLONY_BASE
      && planetItemIndex != ASCEND_PI_35_AUTOMATION )
    {
      coords = Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(pPlanet, squareIndex);
      row = coords.row;
      column = coords.column;
      left = Q_Planet_GetSquareIndex_sub_35968(pPlanet, coords.column - 1, coords.row);
      right = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column + 1, row);
      top = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row - 1);
      bottom = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row + 1);
      if ( (left == 0xFFFF || (pPlanet->pSquares[left].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (right == 0xFFFF || (pPlanet->pSquares[right].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (top == 0xFFFF || (pPlanet->pSquares[top].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (bottom == 0xFFFF || (pPlanet->pSquares[bottom].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0) )
      {
        canPlaceBySquare = FALSE;
      }
    }
  }
  if ( canPlaceByItem && canPlaceBySquare )
  {
    return TRUE;
  }
  else
  {
    return FALSE;
  }
}

//----- (00034774) --------------------------------------------------------
void __fastcall Q_Planet_StartConstruction_sub_34774(P_Planet pPlanet, UBYTE planetItemIndex, int squareIndex, BOOL _immediate)
{
  unsigned __int8 actionType; // cl
  UWORD squareIndex_; // dx
  unsigned __int8 planetItemIndex_; // bl
  UWORD v8; // si

  if ( squareIndex != 0xFFFF && pPlanet->pSquares[squareIndex].planetItemIndex == 0xFF )
  {
    if ( _immediate == TRUE )
    {
      // ?ACTION_BUILD_NOW Immediate placement
      actionType = 0;
      squareIndex_ = squareIndex;
      planetItemIndex_ = planetItemIndex;
    }
    else
    {
      // ?ACTION_START_CONSTRUCTION Queued construction
      actionType = 2;
      v8 = squareIndex;
      planetItemIndex_ = planetItemIndex;
      squareIndex_ = v8;
    }
    Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, squareIndex_, planetItemIndex_, actionType);
  }
}

//----- (000347CC) --------------------------------------------------------
// Finds the optimal location to build a specific planet item
// Return Index of best square to build on, or 0xFFFF if none found
int __fastcall Q_Planet_FindOptimalBuildLocation_sub_347CC(P_Planet pPlanet, UBYTE planetItemIndex)
{
  UBYTE raceIndex; // cl
  int candidateCount; // ebp
  int knownToRace; // edx
  int v6; // kr14_4
  signed int bestScore; // edi
  int score; // eax
  signed __int8 ind; // bl
  signed __int8 pros; // bl
  signed __int8 res; // bl
  int i; // ecx
  int j; // ecx
  UWORD candidateSquares[100]; // [esp+0h] [ebp-E0h]
  P_Square pSquares; // [esp+C8h] [ebp-18h]
  int v17; // [esp+CCh] [ebp-14h]
  int NO_LOCATION_FOUND; // [esp+D0h] [ebp-10h]
  int bestIndex; // [esp+D4h] [ebp-Ch]
  int v20; // [esp+D8h] [ebp-8h]
  UBYTE planetItemIndex_; // [esp+DCh] [ebp-4h]

  planetItemIndex_ = planetItemIndex;
  NO_LOCATION_FOUND = 0xFFFF;
  raceIndex = pPlanet->raceIndex;
  candidateCount = 0;
  knownToRace = V_Research.techs[V_Research.num - 1].knownToRace;
  v17 = 0;
  if ( ((1 << raceIndex) & knownToRace) != 0 && Q_Race_GetTechsNum_sub_40664(&V_Game.races[raceIndex]) == V_Research.num )
  {
    v17 = 0xFFFFFFFF;
  }
  v20 = 0;
  v6 = 0;
  for ( i = 0; i < pPlanet->totalSquaresNum && v6 < 0x64; ++i )
  {
    if ( pPlanet->pSquares[i].planetItemIndex == 0xFF )
    {
      if ( Q_Planet_CanPlaceItem_sub_34368(pPlanet, planetItemIndex_, i) )
      {
        ++candidateCount;
        candidateSquares[v6++] = i;
      }
    }
  }
  if ( candidateCount )
  {
    bestScore = -1u;
    bestIndex = -1u;
    if ( candidateCount > 0 )
    {
      pSquares = pPlanet->pSquares;
      for ( j = 0; j < candidateCount; ++j )
      {
        switch ( pSquares[candidateSquares[j]].color )
        {
          case ASCEND_SQUARE_COLOR_RED:
            score = 0;
            if ( V_PlanetItems.item[planetItemIndex_].ind > 0 )
            {
              ind = V_PlanetItems.item[planetItemIndex_].ind;
              score = 3;
              if ( ind < (char)V_PlanetItems.item[planetItemIndex_].res || ind < (char)V_PlanetItems.item[planetItemIndex_].pros )
              {
                score = 2;
              }
            }
            break;
          case ASCEND_SQUARE_COLOR_GREEN:
            score = 0;
            if ( (char)V_PlanetItems.item[planetItemIndex_].pros > 0 )
            {
              pros = V_PlanetItems.item[planetItemIndex_].pros;
              score = 3;
              if ( pros < V_PlanetItems.item[planetItemIndex_].ind || pros < (char)V_PlanetItems.item[planetItemIndex_].res )
              {
                score = 2;
              }
            }
            break;
          case ASCEND_SQUARE_COLOR_BLUE:
            if ( v17 )
            {
              goto LABEL_24;
            }
            score = 0;
            if ( (char)V_PlanetItems.item[planetItemIndex_].res > 0 )
            {
              res = V_PlanetItems.item[planetItemIndex_].res;
              score = 3;
              if ( res < V_PlanetItems.item[planetItemIndex_].ind || res < (char)V_PlanetItems.item[planetItemIndex_].pros )
              {
                score = 2;
              }
            }
            break;
          default:
LABEL_24:
            score = 1;
            break;
        }
        if ( score > bestScore )
        {
          bestIndex = j;
          bestScore = score;
        }
      }
    }
    if ( bestIndex >= 0 )
    {
      return candidateSquares[bestIndex];
    }
  }
  return NO_LOCATION_FOUND;
}
// 347CC: using guessed type UWORD candidateSquares[100];

//----- (00034A44) --------------------------------------------------------
// Counts available build squares by type
// White square count as a tile for each building type
void __fastcall Q_Planet_CountBuildableSquaresByColor_sub_34A44(P_Planet pPlanet, LONG *outResearch, LONG *outIndustry, LONG *outFertility)
{
  int i; // [esp+0h] [ebp-14h]

  *outResearch = 0;
  *outIndustry = 0;
  *outFertility = 0;
  for ( i = 0; pPlanet->totalSquaresNum > i; ++i )
  {
    if ( pPlanet->pSquares[i].planetItemIndex == 0xFF && Q_Planet_CanPlaceItem_sub_34368(pPlanet, ASCEND_PI_00_FACTORY, i) )
    {
      switch ( pPlanet->pSquares[i].color )
      {
        case ASCEND_SQUARE_COLOR_RED:
          ++*outIndustry;
          break;
        case ASCEND_SQUARE_COLOR_GREEN:
          goto LABEL_3;
        case ASCEND_SQUARE_COLOR_BLUE:
          ++*outResearch;
          break;
        default:
          ++*outResearch;
          ++*outIndustry;
LABEL_3:
          ++*outFertility;
          break;
      }
    }
  }
}

//----- (00034AE4) --------------------------------------------------------
// Finds the optimal location and starts construction of a planet item
// Return Index of square where construction started, or 0xFFFF if no valid location found
int __fastcall Q_Planet_BuildAtOptimalLocation_sub_34AE4(P_Planet pPlanet, UBYTE planetItemIndex, BOOL _immediate)
{
  int squareIndex; // ebx

  squareIndex = Q_Planet_FindOptimalBuildLocation_sub_347CC(pPlanet, planetItemIndex);
  Q_Planet_StartConstruction_sub_34774(pPlanet, planetItemIndex, squareIndex, _immediate);
  return squareIndex;
}

//----- (00034B0C) --------------------------------------------------------
// Handles planet item placement/removal and construction
// actionType Construction action type:
//   0 = Immediate placement
//   1 = ?Remove item
//   2 = Begin construction
//   3 = Complete construction
//   4.. = Just Calc and return FALSE
// Return TRUE on success, FALSE on failure
MACRO_VFX_BOOL __fastcall Q_Planet_HandleItemConstruction_sub_34B0C(
        P_Planet pPlanet,
        UWORD squareIndex,
        unsigned __int8 planetItemIndex,
        unsigned __int8 actionType)
{
  MACRO_VFX_BOOL v5; // ebp
  P_Square pSquare; // edi
  UBYTE planetItemIndex___; // dl
  UBYTE planetItemIndex_; // al
  T_UWordPair squareIndex_; // edx
  T_Ship *pShip; // eax
  T_Square *pPlanetSquare; // eax
  UBYTE v13; // dl
  int v14; // eax
  int v15; // edx
  int range; // [esp+0h] [ebp-30h] BYREF
  int damage; // [esp+4h] [ebp-2Ch] BYREF
  int numUses; // [esp+8h] [ebp-28h] BYREF
  LONG outRange; // [esp+Ch] [ebp-24h] BYREF
  LONG outDamage; // [esp+10h] [ebp-20h] BYREF
  int numUses_; // [esp+14h] [ebp-1Ch] BYREF
  MACRO_VFX_BOOL bOrbitalSquare; // [esp+18h] [ebp-18h]
  T_UWordPair squareIndex__; // [esp+1Ch] [ebp-14h]
  UBYTE planetItemIndex__; // [esp+20h] [ebp-10h]

  squareIndex__ = (T_UWordPair)squareIndex;
  planetItemIndex__ = planetItemIndex;
  v5 = FALSE;
  if ( squareIndex == 0xFFFF && ((V_PlanetItems.item[planetItemIndex].flags & 2) == 0 || actionType != 2) )
  {
    goto CALC_AND_EXIT;
  }
  bOrbitalSquare = (squareIndex__.word0 < pPlanet->surfaceSquaresNum) - 1;
  pSquare = pPlanet->pSquares;
  if ( !actionType )
  {
    // 0 = Immediate placement
    if ( pSquare[squareIndex__.word0].planetItemIndex == 0xFF && planetItemIndex__ < (unsigned int)ASCEND_PI_39_END )
    {
      planetItemIndex___ = planetItemIndex__;
      if ( pPlanet->population - pPlanet->usedPopulation >= V_PlanetItems.item[planetItemIndex__].upop
        && planetItemIndex__ >= (int)V_PlanetItems.surfaceItemsNum == bOrbitalSquare )
      {
        pSquare[squareIndex__.word0].planetItemIndex = planetItemIndex__;
        pSquare[squareIndex__.word0].flags = ASCEND_SQUARE_FLAGS_COMPLETE;
        v5 = TRUE;
        if ( (V_PlanetItems.item[planetItemIndex___].flags & ASCEND_PI_FLAG_ATTACK) != 0 )
        {
          Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, planetItemIndex___, &range, &damage, &numUses);
          if ( numUses )
          {
            HIBYTE(pSquare[squareIndex__.word0].flags) = 0;
            pSquare[squareIndex__.word0].flags |= (_WORD)numUses << 8;
            Q_Planet_CalcPoints_sub_34E70(pPlanet);
            return TRUE;
          }
        }
      }
    }
    goto CALC_AND_EXIT;
  }
  if ( actionType > 1u )
  {
    if ( actionType > 3u )
    {
      Q_Planet_CalcPoints_sub_34E70(pPlanet);
      return FALSE;
    }
    // 3 = Complete construction
    if ( actionType == 3
      || (V_PlanetItems.item[planetItemIndex__].flags & 2) != 0
      || Q_Planet_CanPlaceItem_sub_34368(pPlanet, planetItemIndex__, squareIndex__.word0)
      && ((pSquare[squareIndex__.word0].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0
       || planetItemIndex__ == ASCEND_PI_35_AUTOMATION && (pSquare[squareIndex__.word0].flags & ASCEND_SQUARE_FLAGS_AUTOMATED) == 0) )
    {
      squareIndex_.word0 = pPlanet->_squareIndex;
      if ( squareIndex_.word0 != 0xFFFF )
      {
        squareIndex_.word1 = 0;
        if ( pPlanet->pSquares[*(_DWORD *)&squareIndex_].planetItemIndex == ASCEND_PI_23_SHIP )
        {
          pShip = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, squareIndex_.word0);
          Q_Ship_RemoveFromTheGame_sub_49940(pShip);
        }
        pPlanetSquare = &pPlanet->pSquares[pPlanet->_squareIndex];
        if ( (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0 )
        {
          pPlanetSquare->planetItemIndex = 0xFF;
        }
      }
      v13 = planetItemIndex__;
      v14 = planetItemIndex__;
      pPlanet->_squareIndex = 0xFFFF;
      if ( (V_PlanetItems.item[v14].flags & 2) == 0 )
      {
        pPlanet->_squareIndex = squareIndex__.word0;
        if ( v13 != ASCEND_PI_35_AUTOMATION )
        {
          pSquare[squareIndex__.word0].planetItemIndex = v13;
        }
      }
      v15 = planetItemIndex__;
      pPlanet->buildingPlanetItemIndex = planetItemIndex__;
      if ( (V_PlanetItems.item[v15].flags & ASCEND_PI_FLAG_ATTACK) != 0 )
      {
        Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, v15, &outRange, &outDamage, &numUses_);
        if ( numUses_ )
        {
          HIBYTE(pSquare[squareIndex__.word0].flags) = 0;
          pSquare[squareIndex__.word0].flags |= (_WORD)numUses_ << 8;
        }
      }
      Q_Planet_CalcPoints_sub_34E70(pPlanet);
      return TRUE;
    }
CALC_AND_EXIT:
    Q_Planet_CalcPoints_sub_34E70(pPlanet);
    return v5;
  }
  // 1 = 
  planetItemIndex_ = pSquare[squareIndex__.word0].planetItemIndex;
  if ( planetItemIndex_ == 0xFF
    || V_PlanetItems.item[planetItemIndex_].mpop > pPlanet->maximumPopulation - pPlanet->population
    && (pSquare[squareIndex__.word0].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    goto CALC_AND_EXIT;
  }
  pSquare[squareIndex__.word0].planetItemIndex = 0xFF;
  pSquare[squareIndex__.word0].flags = 0;
  if ( squareIndex__.word0 == pPlanet->_squareIndex )
  {
    pPlanet->_squareIndex = 0xFFFF;
    pPlanet->buildingPlanetItemIndex = 0xFF;
  }
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
  return TRUE;
}

//----- (00034E70) --------------------------------------------------------
void __fastcall Q_Planet_CalcPoints_sub_34E70(P_Planet pPlanet)
{
  T_Square *pSquare; // esi
  UBYTE planetItemIndex; // dl
  T_PlanetItem *pPlanetItem; // eax
  signed __int8 pros; // dh
  int v6; // edi
  signed __int8 res; // dh
  int v8; // edi
  int SquareWithItem_sub_35930; // eax
  int v10; // eax
  int v11; // eax
  UBYTE buildingPlanetItemIndex; // dl
  int halfIndustry; // eax
  UWORD maximumPopulation; // dx
  UWORD population; // cx
  int i; // ebp
  BYTE v17; // [esp+0h] [ebp-30h]
  UWORD v18; // [esp+4h] [ebp-2Ch]
  BYTE v19; // [esp+8h] [ebp-28h]
  UWORD blackSquaresNum; // [esp+Ch] [ebp-24h]
  WORD orbitalSquaresNum; // [esp+10h] [ebp-20h]
  UWORD freeSurfaceSquaresNum; // [esp+14h] [ebp-1Ch]
  int research; // [esp+18h] [ebp-18h]
  int industry; // [esp+1Ch] [ebp-14h]
  int prosperity; // [esp+20h] [ebp-10h]
  int v26; // [esp+20h] [ebp-10h]
  UWORD maximumPopulation2; // [esp+24h] [ebp-Ch]

  industry = 0;
  research = 0;
  prosperity = 0;
  v18 = 0;
  freeSurfaceSquaresNum = 0;
  blackSquaresNum = 0;
  orbitalSquaresNum = 0;
  v17 = 0;
  v19 = 0;
  maximumPopulation2 = pPlanet->maximumPopulation2;
  for ( i = 0; i < pPlanet->totalSquaresNum; ++i )
  {
    pSquare = &pPlanet->pSquares[i];
    planetItemIndex = pSquare->planetItemIndex;
    pPlanetItem = &V_PlanetItems.item[planetItemIndex];
    if ( planetItemIndex == 0xFF )
    {
      if ( i < pPlanet->surfaceSquaresNum )
      {
        if ( (pSquare->color & ASCEND_SQUARE_XENO_RUINS) == 0 )
        {
          ++freeSurfaceSquaresNum;
          if ( !pSquare->color )                       // Black
          {
            ++blackSquaresNum;
          }
        }
      }
      else
      {
        ++orbitalSquaresNum;
      }
    }
    else
    {
      if ( (pSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )// Complete
      {
        if ( pPlanetItem->ind )
        {
          industry += pPlanetItem->ind;
          if ( pSquare->color == ASCEND_SQUARE_COLOR_RED )// Red
          {
            ++industry;
          }
        }
        pros = pPlanetItem->pros;
        if ( pros )
        {
          v6 = pros + prosperity;
          prosperity = v6;
          if ( pPlanet->pSquares[i].color == ASCEND_SQUARE_COLOR_GREEN )
          {
            prosperity = v6 + 1;
          }
        }
        res = pPlanetItem->res;
        if ( res )
        {
          v8 = res + research;
          research = v8;
          if ( pPlanet->pSquares[i].color == ASCEND_SQUARE_COLOR_BLUE )
          {
            research = v8 + 1;
          }
        }
        if ( (pPlanetItem->flags & ASCEND_PI_FLAG_ATTACK) == 0 || planetItemIndex == ASCEND_PI_17_TRACTOR_BEAM )
        {
          if ( (pPlanetItem->flags & ASCEND_PI_FLAG_DEFENSE) != 0 || planetItemIndex == ASCEND_PI_17_TRACTOR_BEAM )
          {
            ++v19;
          }
        }
        else
        {
          ++v17;
        }
        maximumPopulation2 += pPlanetItem->mpop;
      }
      if ( planetItemIndex != ASCEND_PI_23_SHIP
        && (pPlanet->pSquares[i].flags & 2) == 0
        && (V_PlanetItems.item[planetItemIndex].flags & ASCEND_PI_FLAG_MASK6) == 0 )
      {
        v18 += pPlanetItem->upop;
      }
    }
  }
  SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_12_HYPERPOWER_PLANT);
  if ( SquareWithItem_sub_35930 != 0xFFFF && (pPlanet->pSquares[SquareWithItem_sub_35930].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    industry += industry >> 1;
  }
  v10 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_13_FERTILIZATION_PLANT);
  if ( v10 != 0xFFFF && (pPlanet->pSquares[v10].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    prosperity += prosperity >> 1;
  }
  v11 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_14_INTERNET);
  if ( v11 != 0xFFFF && (pPlanet->pSquares[v11].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    research += research >> 1;
  }
  if ( pPlanet->buildingPlanetItemIndex != 0xFF )
  {
    buildingPlanetItemIndex = pPlanet->buildingPlanetItemIndex;
    halfIndustry = industry >> 2;
    switch ( buildingPlanetItemIndex )
    {
      case ASCEND_PI_33_ENDLESS_PARTY:
        prosperity += halfIndustry;
        break;
      case ASCEND_PI_34_SCIENTIST_TAKEOVER:
        LOWORD(research) = halfIndustry + research;
        break;
      case ASCEND_PI_35_AUTOMATION:
        v18 += V_PlanetItems.item[ASCEND_PI_35_AUTOMATION].upop;
        break;
    }
  }
  if ( industry )
  {
    industry = (int)pow((double)(industry + 1), 0.85);
  }
  if ( prosperity )
  {
    prosperity = (int)pow((double)(prosperity + 1), 0.85);
  }
  v26 = prosperity - pPlanet->population / 4;
  if ( v26 < 0 )
  {
    LOWORD(v26) = 0;
  }
  pPlanet->freeSurfaceSquaresNum = freeSurfaceSquaresNum;
  pPlanet->blackSquaresNum = blackSquaresNum;
  pPlanet->freeOrbitalSquaresNum = orbitalSquaresNum;
  pPlanet->industry = industry;
  pPlanet->research = research;
  if ( V_PlayerRaceIndex != pPlanet->raceIndex && V_SelfPlayMode == FALSE && V_Game.atmosphere )
  {
    if ( V_Game.atmosphere <= (unsigned int)ASCEND_ATMOSPHERE_NEUTRAL )
    {
      pPlanet->industry = (int)((double)pPlanet->industry * 1.3);
    }
    else if ( V_Game.atmosphere == ASCEND_ATMOSPHERE_HOSTILE )
    {
      pPlanet->industry = (int)((double)pPlanet->industry * 1.3);
      pPlanet->research = (int)(1.3 * (double)pPlanet->research);
    }
  }
  pPlanet->prosperity = v26;
  pPlanet->maximumPopulation = maximumPopulation2;
  pPlanet->usedPopulation = v18;
  pPlanet->byte58 = v17;
  pPlanet->byte59 = v19;
  if ( pPlanet->maximumPopulation > 100u )
  {
    pPlanet->maximumPopulation = 100;
  }
  maximumPopulation = pPlanet->maximumPopulation;
  if ( pPlanet->population > maximumPopulation )
  {
    pPlanet->population = maximumPopulation;
  }
  population = pPlanet->population;
  if ( pPlanet->usedPopulation > population )
  {
    pPlanet->usedPopulation = population;
  }
}

//----- (000352E0) --------------------------------------------------------
void __fastcall sub_352E0(P_Planet pPlanet)
{
  P_Square pSquares; // kr00_4
  int v3; // kr04_4
  int planetItemIndex; // edx
  UBYTE buildingPlanetItemIndex; // ah
  unsigned int v6; // ebp
  int v7; // eax
  unsigned __int16 squareIndex; // dx
  UBYTE raceIndex; // al
  T_Square *v10; // eax
  P_Ship ShipAtSquare_sub_35A70; // eax
  __int16 v12; // ax
  int v13; // edi
  int v14; // ecx
  UBYTE v15; // bl
  __int16 v16; // di
  UBYTE v17; // al
  int SquareWithItem_sub_35930; // eax
  UWORD maximumPopulation; // di
  int i; // eax
  float x_4; // [esp+4h] [ebp-58h]
  T_Vector3D v1; // [esp+8h] [ebp-54h] BYREF
  T_Vector3D v2; // [esp+14h] [ebp-48h]
  int a3; // [esp+2Ch] [ebp-30h] BYREF
  int a4; // [esp+30h] [ebp-2Ch] BYREF
  LONG length; // [esp+38h] [ebp-24h] BYREF
  float v27; // [esp+3Ch] [ebp-20h]
  int v28; // [esp+40h] [ebp-1Ch]

  pPlanet->invincible = 0;
  if ( pPlanet->raceIndex != 0xFF )
  {
    pSquares = pPlanet->pSquares;
    v3 = 0;
    LOWORD(v28) = 0;
    while ( (__int16)v28 < (int)pPlanet->totalSquaresNum )
    {
      if ( pSquares[v3].planetItemIndex != 0xFF )
      {
        planetItemIndex = pSquares[v3].planetItemIndex;
        if ( (V_PlanetItems.item[planetItemIndex].flags & 4) != 0 )
        {
          Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, planetItemIndex, &a3, &a4, &length);
          if ( length )
          {
            HIBYTE(pSquares[v3].flags) = 0;
            pSquares[v3].flags |= (_WORD)length << 8;
          }
        }
      }
      LOWORD(v28) = v28 + 1;
      ++v3;
    }
    buildingPlanetItemIndex = pPlanet->buildingPlanetItemIndex;
    v6 = 0;
    if ( buildingPlanetItemIndex != 0xFF )
    {
      v7 = buildingPlanetItemIndex;
      if ( (V_PlanetItems.item[v7].flags & 0x20) == 0 )
      {
        if ( pPlanet->_squareIndex == 0xFFFF && (V_PlanetItems.item[v7].flags & 2) == 0 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x3E9);
        }
        squareIndex = pPlanet->_squareIndex;
        pPlanet->buildingProgress += pPlanet->industry;
        if ( Q_Planet_GetItemCost_sub_3583C(pPlanet, squareIndex, pPlanet->buildingPlanetItemIndex) > pPlanet->buildingProgress )
        {
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_31_ALIEN_HOSPITALITY && !(V_Game.day % 10) )
          {
            v13 = V_PlayerRaceIndex;
            v14 = pPlanet->industry / 10 + 1;
            for ( i = 0; i < V_Game.racesNum; ++i )
            {
              *((_WORD *)&V_StaticStrings_dword_A0D04 + 0xF7 * i + v13 + 0x1210) = v14 + V_Game.races[i].attitudes[v13];
            }
          }
        }
        else
        {
          raceIndex = pPlanet->raceIndex;
          if ( raceIndex == V_PlayerRaceIndex
            && pPlanet->buildingPlanetItemIndex == ASCEND_PI_02_LABORATORY
            && V_Research.current.project[raceIndex] == 0xFFFF
            && !sub_469F0(&V_Research, raceIndex) )
          {
            Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_25_FIRST_LAB, 0, 0);
          }
          if ( V_PlayerRaceIndex == pPlanet->raceIndex
            && WinMgr.state != 0x11
            && pPlanet->buildingPlanetItemIndex != ASCEND_PI_23_SHIP
            && !pPlanet->Unknown_5A )
          {
            v6 = 0xFFFFFFFF;
            Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_01_CONSTRUCTION_COMPLETE, (int)pPlanet, pPlanet->buildingPlanetItemIndex);
          }
          v10 = &pPlanet->pSquares[pPlanet->_squareIndex];
          if ( (v10->color & 8) != 0 )
          {
            v10->color &= ~8u;
            pPlanet->pSquares[pPlanet->_squareIndex].planetItemIndex = 0xFF;
            sub_46A94(&V_Research, pPlanet->raceIndex, (int)pPlanet);
          }
          else
          {
            LOBYTE(v10->flags) |= 1u;
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_23_SHIP )
          {
            ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, pPlanet->_squareIndex);
            if ( !ShipAtSquare_sub_35A70 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x415);
            }
            if ( ShipAtSquare_sub_35A70->locationType == ASCEND_LOCATION_TYPE_SHIPYARD )
            {
              pPlanet->population -= V_PlanetItems.item[0x17].upop;
            }
            sub_49828(ShipAtSquare_sub_35A70);
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_36_TERRAFORMING )
          {
            pPlanet->pSquares[pPlanet->_squareIndex].flags = 0;
            pPlanet->pSquares[pPlanet->_squareIndex].planetItemIndex = 0xFF;
            pPlanet->pSquares[pPlanet->_squareIndex].color = 1;
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_35_AUTOMATION )
          {
            LOBYTE(pPlanet->pSquares[pPlanet->_squareIndex].flags) |= 2u;
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_37_LUSH_GROWTH_BOMB && (pPlanet->flags & 1) == 0 )
          {
            pPlanet->maximumPopulation2 += 10;
            pPlanet->flags |= 1u;
          }
          if ( (V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].flags & 8) != 0 && pPlanet->_squareIndex >= pPlanet->surfaceSquaresNum )
          {
            v12 = 15;
            if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_27_ORBITAL_MEGA_SHIELD )
            {
              v12 = 35;
            }
            HIBYTE(pPlanet->pSquares[pPlanet->_squareIndex].flags) = 0;
            pPlanet->pSquares[pPlanet->_squareIndex].flags |= v12 << 8;
          }
          pPlanet->_squareIndex = 0xFFFF;
          pPlanet->buildingPlanetItemIndex = 0xFF;
          pPlanet->buildingProgress = 0;
        }
      }
    }
    if ( pPlanet->population < pPlanet->maximumPopulation )
    {
      v15 = V_PlayerRaceIndex;
      v16 = pPlanet->prosperity + pPlanet->Unknown_4E;
      v17 = pPlanet->raceIndex;
      pPlanet->Unknown_4E = v16;
      if ( v17 != v15 && pPlanet->prosperity < 4u )
      {
        pPlanet->Unknown_4E = v16 + 1;
      }
      if ( (unsigned __int16)pPlanet->Unknown_4E < V_PopGrowthAmount50 )
      {
        goto LABEL_71;
      }
      if ( V_PlayerRaceIndex == pPlanet->raceIndex
        && WinMgr.state != ASCEND_WINMGR_STATE_PLANET_ALLOC
        && pPlanet->population == pPlanet->usedPopulation
        && !v6
        && !pPlanet->Unknown_5A
        && (pPlanet->buildingPlanetItemIndex == 0xFF || (V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].flags & 0x20) != 0) )
      {
        Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_15_HAS_FREE_POPULATION, (int)pPlanet, 0);
      }
      ++pPlanet->population;
      SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xFu);
      if ( SquareWithItem_sub_35930 != 0xFFFF && (pPlanet->pSquares[SquareWithItem_sub_35930].flags & 1) != 0 )
      {
        ++pPlanet->population;
      }
      maximumPopulation = pPlanet->maximumPopulation;
      if ( pPlanet->population > maximumPopulation )
      {
        pPlanet->population = maximumPopulation;
      }
    }
    pPlanet->Unknown_4E = 0;
LABEL_71:
    Q_Planet_CalcPoints_sub_34E70(pPlanet);
  }
  v1 = pPlanet->position;
  v27 = sqrt(v1.y * v1.y + v1.x * v1.x + v1.z * v1.z);
  Q_Vector3D_Normalize_sub_53000(&v1);
  x_4 = dbl_91DD9 / (v27 * v27);
  Q_Vector3D_RotateY_sub_532AC(&v1, x_4);
  v2.x = v1.x * v27;
  v2.y = v1.y * v27;
  v2.z = v1.z * v27;
  v1.y = v2.y;
  v1.z = v2.z;
  pPlanet->position.x = v2.x;
  pPlanet->position.y = v1.y;
  pPlanet->position.z = v1.z;
}
// 91DD9: using guessed type double dbl_91DD9;
// 9684C: using guessed type int V_PopGrowthAmount50;

//----- (0003583C) --------------------------------------------------------
UWORD __fastcall Q_Planet_GetItemCost_sub_3583C(P_Planet pPlanet, unsigned __int16 a2, unsigned __int8 planetItemIndex)
{
  UWORD result; // ax
  T_Ship *ShipAtSquare_sub_35A70; // eax

  result = 0xFFFF;
  if ( a2 != 0xFFFF )
  {
    planetItemIndex = pPlanet->pSquares[a2].planetItemIndex;
  }
  if ( planetItemIndex != 0xFF )
  {
    if ( planetItemIndex == 0x17 )                     // Ship
    {
      if ( Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, a2)->locationType == 2 )
      {
        result = pPlanet->Unknown_77;
      }
      else
      {
        ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, a2);
        result = Q_Ship_GetCost_sub_4A18C(ShipAtSquare_sub_35A70);
      }
    }
    else
    {
      result = V_PlanetItems.item[planetItemIndex].cost;
    }
    if ( planetItemIndex == 0x23 && a2 == pPlanet->_squareIndex )// Automation
    {
      result *= 3;
    }
  }
  return result;
}
// 35893: conditional instruction was optimized away because bl.1 is in (<17u|18..FE)

//----- (000358BC) --------------------------------------------------------
int __fastcall Q_Planet_GetDaysToCompleteItem_sub_358BC(P_Planet pPlanet)
{
  UWORD industry; // si
  UWORD buildingProgress; // cx
  UWORD cost; // ax

  industry = pPlanet->industry;
  buildingProgress = pPlanet->buildingProgress;
  cost = Q_Planet_GetItemCost_sub_3583C(pPlanet, pPlanet->_squareIndex, pPlanet->buildingPlanetItemIndex);
  return Q_GetTurnsToComplete_sub_46C20(cost, buildingProgress, industry);
}

//----- (000358F0) --------------------------------------------------------
// Counts the number of non-ColonyBase buildings on a planet's surface
int __fastcall Q_Planet_CountSurfaceBuildings_sub_358F0(P_Planet pPlanet)
{
  UWORD surfaceSquaresNum; // dx
  int count; // ebx
  UWORD i; // ax
  UBYTE planetItemIndex; // cl

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  count = 0;
  i = 0;
  if ( surfaceSquaresNum )
  {
    do
    {
      planetItemIndex = pPlanet->pSquares[i].planetItemIndex;
      if ( planetItemIndex != 0xFF && planetItemIndex != ASCEND_PI_05_COLONY_BASE )
      {
        ++count;
      }
      ++i;
    }
    while ( i < pPlanet->surfaceSquaresNum );
  }
  return count;
}

//----- (00035930) --------------------------------------------------------
UWORD __fastcall Q_Planet_GetSquareWithItem_sub_35930(P_Planet pPlanet, UBYTE planetItemIndex)
{
  UWORD totalSquaresNum; // dx
  UWORD i; // ax

  totalSquaresNum = pPlanet->totalSquaresNum;
  i = 0;
  if ( !totalSquaresNum )
  {
    return 0xFFFF;
  }
  while ( planetItemIndex != pPlanet->pSquares[i].planetItemIndex )
  {
    if ( ++i >= pPlanet->totalSquaresNum )
    {
      return 0xFFFF;
    }
  }
  return i;
}

//----- (00035968) --------------------------------------------------------
// Converts grid (column,row) coordinates back to a linear square index
int __fastcall Q_Planet_GetSquareIndex_sub_35968(P_Planet pPlanet, int column, int row)
{
  int v5; // ebx
  int size; // ecx
  int size_; // kr00_4
  int v8; // esi
  int v9; // eax
  int v10; // eax
  int v12; // edx
  int v13; // [esp+4h] [ebp-4h]

  v5 = 0;
  v13 = 0xFFFF;
  if ( column >= 0 && column < 15 && row >= 0 )
  {
    if ( column > 0 )
    {
      size = pPlanet->size;
      size_ = size;
      v12 = 0;
      do
      {
        LOWORD(size) = V_PlanetCfg.squares.sizes[size_].column[v12++];
        v5 += size;
      }
      while ( v12 < column );
    }
    v8 = 0xF * pPlanet->size + column;
    v9 = V_PlanetCfg.offsets.sizes[0].column[v8];
    if ( row >= v9 )
    {
      v10 = V_PlanetCfg.squares.sizes[0].column[v8] + v9;
      if ( row < v10 )
      {
        LOWORD(v10) = V_PlanetCfg.offsets.sizes[0].column[v8];
        return row + v5 - v10;
      }
    }
  }
  return v13;
}

//----- (00035A00) --------------------------------------------------------
// Converts a linear surface square index to (row, column) coordinates in planet's grid system
T_SquareGridCoord __fastcall Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(P_Planet pPlanet, unsigned __int16 squareIndex)
{
  T_SquareGridCoord v3; // edi
  int row; // edi
  int column; // ecx
  UWORD surfaceSquaresNum; // si
  unsigned __int16 index; // ax
  int size; // kr00_4
  int i; // kr04_4

  v3 = (T_SquareGridCoord)0xFFFFFFFF;
  if ( squareIndex < pPlanet->surfaceSquaresNum )
  {
    row = 0;
    column = 0;
    surfaceSquaresNum = pPlanet->surfaceSquaresNum;
    index = 0;
    if ( surfaceSquaresNum )
    {
      size = pPlanet->size;
      i = 0;
      do
      {
        row = V_PlanetCfg.offsets.sizes[size].column[i] + squareIndex - index;
        index += V_PlanetCfg.squares.sizes[size].column[i];
        if ( index > squareIndex )
        {
          break;
        }
        ++column;
        ++i;
      }
      while ( index < pPlanet->surfaceSquaresNum );
    }
    return (T_SquareGridCoord)((column << 0x10) + row);
  }
  return v3;
}

//----- (00035A70) --------------------------------------------------------
P_Ship __fastcall Q_Planet_GetShipAtSquare_sub_35A70(P_Planet pPlanet, UWORD squareIndex)
{
  unsigned int shipIndex; // ecx

  if ( squareIndex >= pPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x50B);
  }
  shipIndex = ((int)pPlanet->pSquares[squareIndex].flags >> 8) & 0x7F;
  if ( shipIndex >= 107 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x50F);
  }
  if ( V_Game.ships[(unsigned __int16)shipIndex].raceIndex == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x510);
  }
  return &V_Game.ships[(unsigned __int16)shipIndex];
}

//----- (00035B04) --------------------------------------------------------
// Assigns a ship to an orbital square on a planet
void __fastcall Q_Planet_AssignShipToOrbitalSquare_sub_35B04(P_Planet pPlanet, unsigned __int16 squareIndex, P_Ship pShip)
{
  int shipIndex; // edi

  if ( squareIndex >= pPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x519);
  }
  if ( squareIndex < pPlanet->surfaceSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x51A);
  }
  shipIndex = pShip - V_Game.ships;
  if ( (unsigned __int16)shipIndex >= 107u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x51E);
  }
  if ( V_Game.ships[(unsigned __int16)shipIndex].raceIndex == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x51F);
  }
  // Store ship index in square flags (upper byte) while preserving existing flags (lower byte)
  pPlanet->pSquares[squareIndex].flags = ((_WORD)shipIndex << 8) | (unsigned __int8)pPlanet->pSquares[squareIndex].flags;
}

//----- (00035BB4) --------------------------------------------------------
// Attempts to place a ship in orbit around a planet
// Return TRUE if successfully placed in orbit, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Planet_TryPlaceShipInOrbit_sub_35BB4(P_Planet pPlanet, P_Ship pShip)
{
  int firstOrbitalIndex_; // kr08_4
  int firstOrbitalIndex; // kr00_4
  int i; // kr04_4

  if ( pPlanet->raceIndex == pShip->raceIndex || !Q_Planet_HasOrbitalDefense_sub_361B8(pPlanet) )
  {
    firstOrbitalIndex_ = pPlanet->surfaceSquaresNum;
    firstOrbitalIndex = (unsigned __int16)firstOrbitalIndex_;
    for ( i = 0; firstOrbitalIndex_ + i < pPlanet->totalSquaresNum; ++i )
    {
      if ( pPlanet->pSquares[i + firstOrbitalIndex].planetItemIndex == 0xFF )
      {
        pShip->locationType = ASCEND_LOCATION_TYPE_ORBIT;
        pShip->pLocation.pPlanet = pPlanet;
        pPlanet->pSquares[i + firstOrbitalIndex].planetItemIndex = ASCEND_PI_23_SHIP;
        pPlanet->pSquares[i + firstOrbitalIndex].flags = ASCEND_SQUARE_FLAGS_COMPLETE;
        Q_Planet_AssignShipToOrbitalSquare_sub_35B04(pPlanet, firstOrbitalIndex_ + i, pShip);
        return TRUE;
      }
    }
  }
  return FALSE;
}

//----- (00035C38) --------------------------------------------------------
// Moves a ship from orbit into star system
// Returns TRUE if successful, FALSE if ship wasn't found on the planet
MACRO_VFX_BOOL __fastcall Q_Planet_LaunchShip_sub_35C38(P_Planet pPlanet, P_Ship pShip)
{
  int surfaceSquaresNum; // ecx
  int v4; // kr00_4
  T_Square *pSquare; // eax
  double z; // st7
  int i; // kr04_4
  T_Vector3D randomOffset; // [esp+0h] [ebp-40h] BYREF
  T_Vector3D shipPosition; // [esp+Ch] [ebp-34h] BYREF
  T_Vector3D shipPosition_; // [esp+18h] [ebp-28h] BYREF
  int v12; // [esp+24h] [ebp-1Ch]
  T_Vector3D *p_shipPosition; // [esp+28h] [ebp-18h]

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  v4 = surfaceSquaresNum;
  for ( i = 0; surfaceSquaresNum + i < pPlanet->totalSquaresNum; ++i )
  {
    pSquare = &pPlanet->pSquares[i + v4];
    if ( pSquare->flags
      && pSquare->planetItemIndex == ASCEND_PI_23_SHIP
      && Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, surfaceSquaresNum) == pShip )
    {
      pPlanet->pSquares[i + v4].planetItemIndex = 0xFF;
      pPlanet->pSquares[i + v4].flags = 0;
      pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
      pShip->pLocation.pStar = &V_Game.stars[pPlanet->starIndex];
      randomOffset.x = (float)(rand() % 1000 - 500);
      randomOffset.y = (float)(rand() % 1000 - 500);
      v12 = rand() % 1000 - 500;
      randomOffset.z = (float)v12;
      Q_Vector3D_SetLength_sub_53054(&randomOffset, 250.0);
      memset(&shipPosition_, 0, sizeof(shipPosition_));
      p_shipPosition = &shipPosition;
      shipPosition_.x = pPlanet->position.x + randomOffset.x;
      shipPosition_.y = pPlanet->position.y + randomOffset.y;
      z = pPlanet->position.z;
      shipPosition = shipPosition_;
      shipPosition_.z = z + randomOffset.z;
      Q_Ship_SetPositionAndSnapToGrid_sub_496BC(pShip, &shipPosition);
      return TRUE;
    }
  }
  return FALSE;
}

//----- (00035DA4) --------------------------------------------------------
// Determines the best available orbital shield type for a planet
// Return Item index of best available shield (MEGA_SHIELD, SHIELD, or 0xFF if none available)
char __fastcall Q_Planet_GetBestAvailableOrbitalShield_sub_35DA4(P_Planet pPlanet)
{
  char NO_SHIELD_AVAILABLE; // bl
  int v2; // ecx

  NO_SHIELD_AVAILABLE = 0xFF;
  if ( V_PlanetItems.item[ASCEND_PI_27_ORBITAL_MEGA_SHIELD].resReq == 0xFF )
  {
    return ASCEND_PI_27_ORBITAL_MEGA_SHIELD;
  }
  v2 = 1 << pPlanet->raceIndex;
  if ( (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_27_ORBITAL_MEGA_SHIELD].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_27_ORBITAL_MEGA_SHIELD;
  }
  if ( V_PlanetItems.item[ASCEND_PI_26_ORBITAL_SHIELD].resReq == 0xFF
    || (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_26_ORBITAL_SHIELD].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_26_ORBITAL_SHIELD;
  }
  return NO_SHIELD_AVAILABLE;
}

//----- (00035E24) --------------------------------------------------------
// Determines the best available orbital defense weapon for a planet based on researched technologies
// Return Item index of best available orbital weapon (LONG_RANGE_WHOPPER, SHORT_RANGE_WHOPPER, MISSILE_BASE, or 0xFF if none available)
char __fastcall Q_Planet_GetBestAvailableOrbitalWeapon_sub_35E24(P_Planet pPlanet)
{
  char NO_WEAPON_AVAILABLE; // dl
  int v2; // ecx

  NO_WEAPON_AVAILABLE = 0xFF;
  if ( V_PlanetItems.item[ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER].resReq == 0xFF )
  {
    return ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER;
  }
  v2 = 1 << pPlanet->raceIndex;
  if ( (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER;
  }
  if ( V_PlanetItems.item[ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER].resReq == 0xFF
    || (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER;
  }
  if ( V_PlanetItems.item[ASCEND_PI_28_ORBITAL_MISSILE_BASE].resReq == 0xFF
    || (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_28_ORBITAL_MISSILE_BASE].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_28_ORBITAL_MISSILE_BASE;
  }
  return NO_WEAPON_AVAILABLE;
}

//----- (00035ED8) --------------------------------------------------------
// Calculates the maximum orbital defense coverage range for a planet
// Return Maximum defense range in game units, or -1 if no defenses
int __fastcall Q_Planet_GetMaxOrbitalDefenseRange_sub_35ED8(P_Planet pPlanet)
{
  int surfaceSquaresNum; // kr08_4
  int firstOrbitalIndex; // kr00_4
  UBYTE planetItemIndex_; // al
  T_Square *pPlanetSquare; // eax
  UBYTE planetItemIndex; // dl
  int i; // kr04_4
  int range; // [esp+Ch] [ebp-34h] BYREF
  int damage; // [esp+10h] [ebp-30h] BYREF
  LONG numUses; // [esp+14h] [ebp-2Ch] BYREF
  float currentRange; // [esp+18h] [ebp-28h]
  int baseRange; // [esp+1Ch] [ebp-24h]
  int remainingUses; // [esp+20h] [ebp-20h]
  float maxRange; // [esp+24h] [ebp-1Ch]

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  maxRange = -1.0;
  firstOrbitalIndex = surfaceSquaresNum;
  for ( i = 0; surfaceSquaresNum + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i + firstOrbitalIndex];
    planetItemIndex = pPlanetSquare->planetItemIndex;
    currentRange = -1.0;
    if ( planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex_ = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex_ >= (unsigned int)ASCEND_PI_28_ORBITAL_MISSILE_BASE
        && planetItemIndex_ <= (unsigned int)ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER )
      {
        range = 0;
        damage = 0;
        numUses = 1;
        Q_Planet_GetOrbitalWeaponStats_sub_366C8(
          pPlanet,
          pPlanet->pSquares[i + firstOrbitalIndex].planetItemIndex,
          &range,
          &damage,
          &numUses);
        if ( numUses )
        {
          remainingUses = (int)pPlanet->pSquares[i + firstOrbitalIndex].flags >> 8;
        }
        // Calculate effective range if weapon has remaining uses
        if ( remainingUses > 0 )
        {
          baseRange = 32 * range;
          currentRange = (double)(32 * range) * 0.95;
        }
      }
    }
    if ( currentRange > (double)maxRange )
    {
      maxRange = currentRange;
    }
  }
  return (int)maxRange;
}

//----- (00035FE0) --------------------------------------------------------
// Calculates the total shield strength of a planet's orbital defenses
// Return Total shield strength (3 per regular shield, 6 per mega shield)
int __fastcall Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(P_Planet pPlanet)
{
  int firstOrbitalIndex; // kr08_4
  int totalShieldStrength; // eax
  UBYTE planetItemIndex; // dl
  T_Square *pPlanetSquare; // edx
  int i; // kr04_4

  firstOrbitalIndex = pPlanet->surfaceSquaresNum;
  totalShieldStrength = 0;
  for ( i = 0; firstOrbitalIndex + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[(unsigned __int16)firstOrbitalIndex + i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex >= (unsigned int)ASCEND_PI_26_ORBITAL_SHIELD )
      {
        if ( planetItemIndex <= (unsigned int)ASCEND_PI_26_ORBITAL_SHIELD )
        {
          totalShieldStrength += 3;
        }
        else if ( planetItemIndex == ASCEND_PI_27_ORBITAL_MEGA_SHIELD )
        {
          totalShieldStrength += 6;
        }
      }
    }
  }
  return totalShieldStrength;
}

//----- (00036050) --------------------------------------------------------
// Calculates the total weapon strength of a planet's orbital defenses
// Return Total weapon strength (2 per missile base, 4 per short-range whopper, 6 per long-range whopper)
int __fastcall Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(P_Planet pPlanet)
{
  int firstOrbitalIndex; // kr08_4
  int totalWeaponStrength; // eax
  UBYTE planetItemIndex; // dl
  T_Square *pPlanetSquare; // edx
  int i; // kr04_4

  firstOrbitalIndex = pPlanet->surfaceSquaresNum;
  totalWeaponStrength = 0;
  for ( i = 0; firstOrbitalIndex + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[(unsigned __int16)firstOrbitalIndex + i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex < (unsigned int)ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER )
      {
        if ( planetItemIndex == ASCEND_PI_28_ORBITAL_MISSILE_BASE )
        {
          totalWeaponStrength += 2;
        }
      }
      else if ( planetItemIndex <= (unsigned int)ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER )
      {
        totalWeaponStrength += 4;
      }
      else if ( planetItemIndex == ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER )
      {
        totalWeaponStrength += 6;
      }
    }
  }
  return totalWeaponStrength;
}

//----- (000360D8) --------------------------------------------------------
// Calculates the total defensive strength of a planet's orbital installations
// @return Combined defensive score of all orbital installations
int __fastcall Q_Planet_CalculateOrbitalDefenseStrength_sub_360D8(P_Planet pPlanet)
{
  int firstOrbitalIndex; // kr08_4
  int defenseScore; // eax
  T_Square *pPlanetSquare; // edx
  int i; // kr04_4

  firstOrbitalIndex = pPlanet->surfaceSquaresNum;
  defenseScore = 0;
  for ( i = 0; firstOrbitalIndex + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[(unsigned __int16)firstOrbitalIndex + i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      switch ( pPlanetSquare->planetItemIndex )
      {
        case ASCEND_PI_26_ORBITAL_SHIELD:
          ++defenseScore;
          break;
        case ASCEND_PI_27_ORBITAL_MEGA_SHIELD:
        case ASCEND_PI_28_ORBITAL_MISSILE_BASE:
          defenseScore += 2;
          break;
        case ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER:
          defenseScore += 4;
          break;
        case ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER:
          defenseScore += 6;
          break;
        default:
          continue;
      }
    }
  }
  return defenseScore;
}

//----- (00036158) --------------------------------------------------------
// // Calculates the total shield strength of a planet's surface defenses
// // @return Total shield strength (2 per regular shield, 4 per mega shield)
int __fastcall Q_Planet_CalculateSurfaceShieldStrength_sub_36158(P_Planet pPlanet)
{
  int score; // eax
  UBYTE planetItemIndex; // dl
  T_Square *pPlanetSquare; // edx
  int i; // ebx

  score = 0;
  for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex >= (unsigned int)ASCEND_PI_18_SURFACE_SHIELD )
      {
        if ( planetItemIndex <= (unsigned int)ASCEND_PI_18_SURFACE_SHIELD )
        {
          score += 2;
        }
        else if ( planetItemIndex == ASCEND_PI_19_SURFACE_MEGA_SHIELD )
        {
          score += 4;
        }
      }
    }
  }
  return score;
}

//----- (000361B8) --------------------------------------------------------
// Checks if a planet has orbital defenses that prevent enemy ships from orbiting
// Return TRUE if planet has active orbital defenses, FALSE otherwise
int __fastcall Q_Planet_HasOrbitalDefense_sub_361B8(P_Planet pPlanet)
{
  int surfaceSquaresNum; // ecx
  int false; // edi
  int v4; // kr00_4
  T_Square *pPlanetSquare; // eax
  UBYTE planetItemIndex; // dl
  int i; // kr04_4

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  false = FALSE;
  v4 = (unsigned __int16)surfaceSquaresNum;
  for ( i = 0; surfaceSquaresNum + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i + v4];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      if ( pPlanetSquare->planetItemIndex == ASCEND_PI_23_SHIP
        && Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, surfaceSquaresNum)->raceIndex == pPlanet->raceIndex )
      {
        return TRUE;
      }
      planetItemIndex = pPlanet->pSquares[i + v4].planetItemIndex;
      if ( planetItemIndex == ASCEND_PI_26_ORBITAL_SHIELD || planetItemIndex == ASCEND_PI_27_ORBITAL_MEGA_SHIELD )
      {
        return TRUE;
      }
    }
  }
  return false;
}

//----- (0003623C) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_3623C(P_Planet pPlanet)
{
  MACRO_VFX_BOOL v2; // ebp
  T_Square *pPlanetSquare; // eax
  UBYTE planetItemIndex; // dh
  int i; // [esp+0h] [ebp-1Ch]

  v2 = 0;
  for ( i = 0; pPlanet->surfaceSquaresNum > i; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex == ASCEND_PI_02_LABORATORY || planetItemIndex == ASCEND_PI_08_RESEARCH_CAMPUS )
      {
        if ( Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, i, pPlanet->pSquares[i].planetItemIndex, 1u) )
        {
          v2 = TRUE;
        }
      }
    }
  }
  return v2;
}

//----- (000362C8) --------------------------------------------------------
void __fastcall Q_Planet_SetPosition_sub_362C8(P_Planet pPlanet, P_Vector3D newPosition)
{
  pPlanet->position = *newPosition;
  Q_Vector3D_SnapToGrid_sub_53440(&pPlanet->position);
}

//----- (000362E0) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Planet_CanBuildShip_sub_362E0(P_Planet pPlanet)
{
  int false; // ebx
  int shipyardSquareIndex; // eax

  if ( pPlanet->raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x688);
  }
  false = FALSE;
  shipyardSquareIndex = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD);
  if ( shipyardSquareIndex != 0xFFFF
    && (pPlanet->pSquares[shipyardSquareIndex].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0
    && Q_Race_GetMoreAllowedShips_sub_3EFE0(&V_Game.races[pPlanet->raceIndex]) > 0 )
  {
    return TRUE;
  }
  return false;
}

//----- (0003636C) --------------------------------------------------------
int __fastcall Q_Planet_GetSquaresValue_sub_3636C(P_Planet pPlanet, BOOL withBlack)
{
  P_Square pSquares; // kr00_4
  int result; // eax
  int ii; // kr04_4
  __int16 i; // bx

  pSquares = pPlanet->pSquares;
  result = 0;
  ii = 0;
  for ( i = 0; i < (int)pPlanet->surfaceSquaresNum; ++i )
  {
    if ( pSquares[ii].color < (unsigned int)ASCEND_SQUARE_COLOR_RED )
    {
      if ( pSquares[ii].color )                        // White square
      {
        ++result;
      }
      else if ( withBlack )
      {
        ++result;
      }
    }
    else
    {
      result += 2;
    }
    ++ii;
  }
  return result;
}

//----- (000363B0) --------------------------------------------------------
int __fastcall Q_Planet_GetTotalValue_sub_363B0(P_Planet pPlanet)
{
  int squaresValue; // edi
  int itemsValue; // ebx
  int totalValue; // edi
  int i; // eax

  if ( pPlanet->raceIndex > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x6CD);
  }
  squaresValue = (pPlanet->maximumPopulation - pPlanet->population) / 2
               + pPlanet->population
               + pPlanet->research
               + pPlanet->prosperity
               + pPlanet->industry
               + (unsigned __int16)Q_Planet_GetSquaresValue_sub_3636C(
                                     pPlanet,
                                     (V_Game.races[pPlanet->raceIndex].ability != ASCEND_SA_BUILD_ON_BLACK) - 1);
  if ( (pPlanet->flags & 2) != 0 )
  {
    squaresValue += 100;
  }
  itemsValue = 0;
  for ( i = 0; i < pPlanet->totalSquaresNum; ++i )
  {
    itemsValue += V_PlanetItems.item[pPlanet->pSquares[i].planetItemIndex].cost;
  }
  totalValue = itemsValue + squaresValue;
  if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD) )
  {
    totalValue += 50;
  }
  if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_24_ORBITAL_DOCKS) )
  {
    totalValue += 50;
  }
  if ( totalValue < 0 )
  {
    return 0;
  }
  return totalValue;
}

//----- (000364B4) --------------------------------------------------------
// Calculates the visible value of a planet from a specific race's perspective
int __fastcall Q_Planet_GetVisibleValueForRace_sub_364B4(P_Planet pPlanet, WORD raceIndex)
{
  T_Race *pRace; // ebx
  int planetRaceIndex; // eax
  int baseSquaresValue; // esi
  MACRO_VFX_BOOL hasSurfaceCloaker; // esi
  int economicValue; // edi
  int itemsValue; // eax
  int totalValue_; // edi
  int finalScore; // eax
  int i; // edx
  int j; // kr0C_4
  int visibleValue; // [esp+0h] [ebp-1Ch]
  MACRO_VFX_BOOL hasOrbitalCloaker; // [esp+4h] [ebp-18h]

  if ( raceIndex > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x71A);
  }
  pRace = &V_Game.races[raceIndex];
  planetRaceIndex = pPlanet->raceIndex;
  visibleValue = 0;
  // Only calculate if planet is uncolonized or at war with this race
  if ( planetRaceIndex == 0xFF || raceIndex != planetRaceIndex && pRace->treaties[planetRaceIndex] == ASCEND_TREATY_WAR )
  {
    baseSquaresValue = (unsigned __int16)Q_Planet_GetSquaresValue_sub_3636C(
                                           pPlanet,
                                           (V_Game.races[raceIndex].ability != ASCEND_SA_BUILD_ON_BLACK) - 1);
    visibleValue = baseSquaresValue;
    if ( (pPlanet->flags & 2) != 0 )
    {
      visibleValue = baseSquaresValue + 40;
    }
    // Only calculate full value if planet is valuable enough or at war
    if ( visibleValue > 70 || pRace->treaties[pPlanet->raceIndex] == ASCEND_TREATY_WAR )
    {
      if ( pRace->treaties[pPlanet->raceIndex] != ASCEND_TREATY_WAR )
      {
        goto RETURN_SCORE;
      }
      // If case of war, calculate additional aspects
      hasSurfaceCloaker = FALSE;
      economicValue = (pPlanet->maximumPopulation - pPlanet->population) / 2
                    + pPlanet->population
                    + pPlanet->research
                    + pPlanet->prosperity
                    + pPlanet->industry;
      hasOrbitalCloaker = FALSE;
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_11_SURFACE_CLOAKER) != 0xFFFF )
      {
        hasSurfaceCloaker = TRUE;
      }
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_25_ORBITAL_CLOAKER) != 0xFFFF )
      {
        hasOrbitalCloaker = TRUE;
      }
      itemsValue = 0;
      if ( hasSurfaceCloaker == FALSE )
      {
        // If surface is visible
        for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
        {
          itemsValue += V_PlanetItems.item[pPlanet->pSquares[i].planetItemIndex].cost;
        }
      }
      if ( hasOrbitalCloaker == FALSE )
      {
        // If orbit is visible
        for ( j = 0; pPlanet->surfaceSquaresNum + j < pPlanet->totalSquaresNum; ++j )
        {
          itemsValue += V_PlanetItems.item[pPlanet->pSquares[j].planetItemIndex].cost;
        }
      }
      totalValue_ = itemsValue + economicValue;
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD) )
      {
        totalValue_ += 50;
      }
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_24_ORBITAL_DOCKS) )
      {
        totalValue_ += 50;
      }
      finalScore = 2 * (totalValue_ / 10 + visibleValue);
    }
    else
    {
      finalScore = 0;
    }
    visibleValue = finalScore;
  }
RETURN_SCORE:
  if ( visibleValue < 0 )
  {
    return 0;
  }
  return visibleValue;
}

//----- (000366C8) --------------------------------------------------------
void __fastcall Q_Planet_GetOrbitalWeaponStats_sub_366C8(
        P_Planet pPlanet,
        UBYTE planetItemIndex,
        LONG *outRange,
        LONG *outDamage,
        LONG *outNumUses)
{
  if ( !outRange || !outDamage || !outNumUses )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x785);
  }
  switch ( planetItemIndex )
  {
    case ASCEND_PI_28_ORBITAL_MISSILE_BASE:
      *outRange = 45;
      *outDamage = 7;
      *outNumUses = 1;
      break;
    case ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER:
      *outRange = 45;
      *outDamage = 7;
      *outNumUses = 3;
      break;
    case ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER:
      *outRange = 90;
      *outDamage = 8;
      *outNumUses = 3;
      break;
    case ASCEND_PI_17_TRACTOR_BEAM:
      *outRange = 200;
      *outDamage = 0;
      *outNumUses = 2;
      break;
  }
}

//----- (0003676C) --------------------------------------------------------
int __fastcall sub_3676C(P_Planet pPlanet, int a2)
{
  UBYTE planetItemIndex; // al
  P_Ship pShip; // edi
  BOOL v5; // eax
  int v6; // eax
  double v7; // st7
  double z; // st7
  T_Type23 *pt23; // eax
  int result; // eax
  T_Vector3D v11; // [esp+8h] [ebp-8Ch]
  T_Vector3D v12; // [esp+14h] [ebp-80h] BYREF
  T_Vector3D v13; // [esp+20h] [ebp-74h] BYREF
  T_Vector3D v14; // [esp+38h] [ebp-5Ch] BYREF
  int numUses; // [esp+58h] [ebp-3Ch] BYREF
  T_Vector3D *v16; // [esp+60h] [ebp-34h]
  LONG range; // [esp+64h] [ebp-30h] BYREF
  int damage; // [esp+68h] [ebp-2Ch] BYREF
  T_Vector3D *v19; // [esp+6Ch] [ebp-28h]
  int v20; // [esp+70h] [ebp-24h]
  float v21; // [esp+74h] [ebp-20h]
  int v22; // [esp+78h] [ebp-1Ch]
  int v23; // [esp+7Ch] [ebp-18h]

  planetItemIndex = pPlanet->t22.pt23->planetItemIndex;
  v20 = 0xFFFFFFFF;
  if ( planetItemIndex == 0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x7AB);
  }
  v23 = 0;
  pShip = pPlanet->t22.pShip;
  damage = 0;
  numUses = 1;
  Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, pPlanet->t22.pt23->planetItemIndex, &range, &damage, &numUses);
  if ( pShip )
  {
    range = 0;
    if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM || &V_Game.stars[pPlanet->starIndex] != pShip->pLocation.pStar )
    {
      v20 = 0;
    }
  }
  v22 = 1;
  if ( numUses )
  {
    v22 = (int)pPlanet->t22.pt23->Unknown_2 >> 8;
  }
  v5 = v20 && v22;
  v23 |= v5;
  if ( (v23 & 1) != 0 )
  {
    if ( damage )
    {
      v6 = Q_Ship_ApplyDamage_sub_4B7A0(pShip, a2, damage, pPlanet->raceIndex);
      v23 |= v6;
    }
    if ( a2 == 1 )
    {
      if ( pPlanet->t22.pt23->planetItemIndex == ASCEND_PI_17_TRACTOR_BEAM )
      {
        v16 = &v13;
        v11.x = pShip->position.x - pPlanet->position.x;
        v11.y = pShip->position.y - pPlanet->position.y;
        v11.z = pShip->position.z - pPlanet->position.z;
        v13 = v11;
        v7 = sqrt(v11.y * v11.y + v11.x * v11.x + v11.z * v11.z) + -3200.0;
        v21 = v7;
        if ( v7 < 1280.0 )
        {
          v21 = 1280.0;
        }
        Q_Vector3D_SetLength_sub_53054(&v13, v21);
        memset(&v14, 0, sizeof(v14));
        v19 = &v12;
        v14.x = pPlanet->position.x + v13.x;
        v14.y = pPlanet->position.y + v13.y;
        z = pPlanet->position.z;
        v12 = v14;
        v14.z = z + v13.z;
        pShip->position.x = v14.x;
        pShip->position.y = v12.y;
        pShip->position.z = v12.z;
      }
      if ( numUses && v22 > 0 )
      {
        pt23 = pPlanet->t22.pt23;
        --v22;
        HIBYTE(pt23->Unknown_2) = 0;
        pPlanet->t22.pt23->Unknown_2 |= (_WORD)v22 << 8;
      }
    }
  }
  result = v23;
  pPlanet->t22.Unknown_8 = v23;
  return result;
}
// 3680F: conditional instruction was optimized away because %range.4==0

//----- (00036A5C) --------------------------------------------------------
void __fastcall sub_36A5C(P_Planet pPlanet, int a2, WORD raceIndex)
{
  int raceIndex__; // edx
  int v5; // eax
  UWORD totalSquaresNum; // cx
  int v7; // edi
  int v8; // kr04_4
  int v9; // kr0C_4
  int v10; // ebx
  int v11; // ecx
  UWORD v12; // di
  int v13; // ebp
  int v14; // eax
  WORD v15; // cx
  int v16; // ebx
  T_Ship *ShipAtSquare_sub_35A70; // eax
  __int16 v18[10]; // [esp+0h] [ebp-30h]
  int v19; // [esp+14h] [ebp-1Ch]
  int squareIndex; // [esp+18h] [ebp-18h]
  WORD raceIndex_; // [esp+1Ch] [ebp-14h]

  v19 = a2;
  raceIndex_ = raceIndex;
  if ( pPlanet->invincible != 0xFFFFFFFF )
  {
    if ( pPlanet->raceIndex >= V_Game.racesNum && pPlanet->raceIndex != 0xFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x7FE);
    }
    if ( raceIndex_ < 0 || raceIndex_ >= V_Game.racesNum )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x7FF);
    }
    raceIndex__ = pPlanet->raceIndex;
    if ( raceIndex__ != 0xFF )
    {
      v5 = raceIndex__;
      raceIndex__ = raceIndex_;
      Q_Race_DecayRelations_sub_433E0(&V_Game.races[v5], raceIndex_, &V_Game.stars[pPlanet->starIndex]);
    }
    LOWORD(raceIndex__) = pPlanet->surfaceSquaresNum;
    totalSquaresNum = pPlanet->totalSquaresNum;
    v7 = 0;
    squareIndex = 0xFFFF;
    if ( (unsigned __int16)raceIndex__ < totalSquaresNum )
    {
      v8 = 0;
      v9 = 0;
      do
      {
        v10 = (unsigned __int16)raceIndex__;
        if ( pPlanet->pSquares[v10].planetItemIndex != 0xFF )
        {
          v18[v8] = raceIndex__;
          if ( (V_PlanetItems.item[pPlanet->pSquares[v10].planetItemIndex].flags & ASCEND_PI_FLAG_DEFENSE) != 0
            && (_WORD)raceIndex__ != pPlanet->_squareIndex )
          {
            squareIndex = raceIndex__ + v9;
          }
          ++v7;
          ++v8;
        }
        ++v9;
      }
      while ( (unsigned __int16)raceIndex__ < pPlanet->totalSquaresNum );
    }
    if ( v7 )
    {
      v11 = 0xFFFFFFFF;
      if ( (unsigned __int16)squareIndex == 0xFFFF )
      {
        v12 = v18[rand() % v7];
      }
      else
      {
        v12 = squareIndex;
        v13 = (unsigned __int16)squareIndex;
        v14 = ((int)pPlanet->pSquares[v13].flags >> 8) - v19;
        if ( v14 > 0 && (_WORD)squareIndex != pPlanet->_squareIndex )
        {
          HIBYTE(pPlanet->pSquares[v13].flags) = 0;
          pPlanet->pSquares[v13].flags |= (_WORD)v14 << 8;
          v11 = 0;
        }
      }
      if ( pPlanet->pSquares[v12].planetItemIndex == 0x17 )
      {
        v15 = raceIndex_;
        v16 = v19;
        ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, v12);
        v11 = ((Q_Ship_ApplyDamage_sub_4B7A0(ShipAtSquare_sub_35A70, 1, 2 * v16, v15) & 4) == 0) - 1;
      }
      if ( pPlanet->maximumPopulation < pPlanet->population )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x837);
      }
      if ( V_PlanetItems.item[pPlanet->pSquares[v12].planetItemIndex].mpop )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x838);
      }
      if ( v11 == 0xFFFFFFFF )
      {
        Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, v12, 0xFFu, 1u);
        if ( pPlanet->pSquares[v12].planetItemIndex != 0xFF )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x83D);
        }
        if ( v12 == pPlanet->_squareIndex )
        {
          pPlanet->_squareIndex = 0xFFFF;
          pPlanet->buildingPlanetItemIndex = 0xFF;
          pPlanet->buildingProgress = 0;
        }
      }
      Q_Planet_CalcPoints_sub_34E70(pPlanet);
    }
  }
}
// 36A5C: using guessed type __int16 var_30[10];

//----- (00036CD4) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Planet_TryInvade_sub_36CD4(P_Planet pPlanet, unsigned __int16 squareIndex_1, int *outModulesUse)
{
  P_Ship vpShip; // eax
  int raceIndex; // edx
  T_Ship *vpShip_; // ebp
  unsigned int v7; // eax
  WORD declareWar; // di
  __int16 i; // ax
  __int16 j; // ax
  T_Square *v11; // edx
  T_Square *v12; // edx
  int ii; // edi
  int v14; // edi
  T_Square *pPlanetSquare; // eax
  T_Square *pPlanetSquare_; // eax
  __int16 k; // bx
  MACRO_VFX_BOOL mastersOfInvasion; // [esp+0h] [ebp-30h]
  int surfaceShields; // [esp+4h] [ebp-2Ch]
  int modulesToUse; // [esp+8h] [ebp-28h]
  MACRO_VFX_BOOL invaded; // [esp+Ch] [ebp-24h]
  int invasionModules; // [esp+10h] [ebp-20h]
  int v24; // [esp+14h] [ebp-1Ch]
  signed __int16 squareIndex; // [esp+18h] [ebp-18h]
  signed __int16 a2; // [esp+1Ch] [ebp-14h]

  if ( squareIndex_1 >= pPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x851);
  }
  if ( pPlanet->pSquares[squareIndex_1].planetItemIndex != 0x17 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x852);
  }
  vpShip = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, squareIndex_1);
  raceIndex = pPlanet->raceIndex;
  vpShip_ = vpShip;
  if ( raceIndex == 0xFF || raceIndex == vpShip->raceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x856);
  }
  invaded = FALSE;
  mastersOfInvasion = FALSE;
  if ( !V_Game.races[vpShip->raceIndex].ability )
  {
    mastersOfInvasion = TRUE;
  }
  if ( Q_Race_DecayRelations_sub_433E0(&V_Game.races[pPlanet->raceIndex], vpShip->raceIndex, &V_Game.stars[pPlanet->starIndex]) == 0xFFFFFFFF )
  {
    v7 = 0xF7 * pPlanet->raceIndex;
    declareWar = V_Game.races[v7 / 0xF7].declareWar;
    if ( declareWar < V_Game.races[0].attitudes[vpShip_->raceIndex + v7] )
    {
      V_Game.races[0].attitudes[vpShip_->raceIndex + v7] = declareWar - 0xA;
    }
  }
  invasionModules = 0;
  surfaceShields = 0;
  for ( i = 0; i < vpShip_->hullCellsNum; ++i )
  {
    if ( vpShip_->hullCells[i].gizmoIndex == ASCEND_GIZMO_73_INVASION_MODULE )
    {
      ++invasionModules;
    }
  }
  for ( j = 0; j < (int)pPlanet->surfaceSquaresNum; ++j )
  {
    v12 = &pPlanet->pSquares[j];
    if ( v12->planetItemIndex == ASCEND_PI_18_SURFACE_SHIELD && (v12->flags & 1) != 0 )
    {
      ++surfaceShields;
    }
    else
    {
      v11 = &pPlanet->pSquares[j];
      if ( v11->planetItemIndex == ASCEND_PI_19_SURFACE_MEGA_SHIELD && (v11->flags & 1) != 0 )
      {
        surfaceShields += 2;
      }
    }
  }
  v24 = invasionModules;
  if ( invasionModules > surfaceShields )
  {
    v24 = surfaceShields + 1;
  }
  modulesToUse = v24;
  if ( mastersOfInvasion == TRUE )
  {
    modulesToUse = 1;
  }
  ii = 0;
  *outModulesUse = modulesToUse;
  for ( k = 0; k < vpShip_->hullCellsNum && ii < modulesToUse; ++k )
  {
    if ( vpShip_->hullCells[k].gizmoIndex == ASCEND_GIZMO_73_INVASION_MODULE )
    {
      ++ii;
      Q_Ship_RemoveGizmoFromCell_sub_492F8(vpShip_, k);
    }
  }
  Q_Ship_RecalcStats_sub_496E0(vpShip_);
  v14 = 0;
  for ( a2 = 0; a2 < (int)pPlanet->surfaceSquaresNum && v14 < v24; ++a2 )
  {
    pPlanetSquare = &pPlanet->pSquares[a2];
    if ( pPlanetSquare->planetItemIndex == ASCEND_PI_18_SURFACE_SHIELD && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      ++v14;
      Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, a2, 0xFFu, 1u);
    }
  }
  for ( squareIndex = 0; squareIndex < (int)pPlanet->surfaceSquaresNum && v14 < v24; ++squareIndex )
  {
    pPlanetSquare_ = &pPlanet->pSquares[squareIndex];
    if ( pPlanetSquare_->planetItemIndex == ASCEND_PI_19_SURFACE_MEGA_SHIELD && (pPlanetSquare_->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      v14 += 2;
      if ( v14 <= v24 )
      {
        Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, squareIndex, 0xFFu, 1u);
      }
    }
  }
  if ( invasionModules > surfaceShields || mastersOfInvasion == TRUE )
  {
    if ( pPlanet->raceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_BATTLE )
    {
      Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_COLONYINVADED, (int)pPlanet, 0);
    }
    Q_Star_ChangePlanetOwnership_sub_1D234(&V_Game.stars[pPlanet->starIndex], pPlanet, vpShip_->raceIndex);
    invaded = TRUE;
    pPlanet->dayColonized = V_Game.day;
  }
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
  return invaded;
}

//----- (00037040) --------------------------------------------------------
void __fastcall Q_Planet_Abandon_sub_37040(P_Planet pPlanet)
{
  T_Square *v2; // esi
  int i; // edx

  Q_Star_ChangePlanetOwnership_sub_1D234(&V_Game.stars[pPlanet->starIndex], pPlanet, 0xFFFF);
  for ( i = 0; i < pPlanet->totalSquaresNum; ++i )
  {
    v2 = &pPlanet->pSquares[i];
    if ( v2->planetItemIndex != ASCEND_PI_23_SHIP )
    {
      v2->planetItemIndex = 0xFF;
      pPlanet->pSquares[i].flags = 0;
    }
  }
  pPlanet->usedPopulation = 0;
  pPlanet->population = pPlanet->usedPopulation;
  pPlanet->raceIndex = 0xFF;
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
}

//----- (000370B8) --------------------------------------------------------
void __fastcall Q_Planet_ReadWrite_sub_370B8(P_Planet pPlanet, P_CFile pfi, int read)
{
  T_Planet vPlanet; // [esp+0h] [ebp-8Ch] BYREF

  if ( read == TRUE )
  {
    memset(&vPlanet, 0, 0xC);
    vPlanet.pSquares = 0;
    vPlanet.Unknown_5A = 0;
    vPlanet.totalSquaresNum = 0;
    Q_CFile_Read_sub_1BF94(pfi, &vPlanet, 0x7Bu);
    pPlanet->position.x = vPlanet.position.x;
    pPlanet->position.y = vPlanet.position.y;
    pPlanet->position.z = vPlanet.position.z;
    pPlanet->starIndex = vPlanet.starIndex;
    pPlanet->Unknown_E = vPlanet.Unknown_E;
    pPlanet->pSquares = vPlanet.pSquares;
    pPlanet->size = vPlanet.size;
    pPlanet->type = vPlanet.type;
    pPlanet->surfaceSquaresNum = vPlanet.surfaceSquaresNum;
    pPlanet->totalSquaresNum = vPlanet.totalSquaresNum;
    pPlanet->freeSurfaceSquaresNum = vPlanet.freeSurfaceSquaresNum;
    pPlanet->freeOrbitalSquaresNum = vPlanet.freeOrbitalSquaresNum;
    pPlanet->blackSquaresNum = vPlanet.blackSquaresNum;
    pPlanet->Unknown_22 = vPlanet.Unknown_22;
    qmemcpy(pPlanet->name, vPlanet.name, 0x1Cu);
    *(_WORD *)&pPlanet->name[0x1C] = *(_WORD *)&vPlanet.name[0x1C];
    pPlanet->population = vPlanet.population;
    pPlanet->industry = vPlanet.industry;
    pPlanet->research = vPlanet.research;
    pPlanet->prosperity = vPlanet.prosperity;
    pPlanet->maximumPopulation = vPlanet.maximumPopulation;
    pPlanet->usedPopulation = vPlanet.usedPopulation;
    pPlanet->Unknown_4E = vPlanet.Unknown_4E;
    pPlanet->buildingProgress = vPlanet.buildingProgress;
    pPlanet->_squareIndex = vPlanet._squareIndex;
    pPlanet->buildingPlanetItemIndex = vPlanet.buildingPlanetItemIndex;
    pPlanet->maximumPopulation2 = vPlanet.maximumPopulation2;
    pPlanet->raceIndex = vPlanet.raceIndex;
    pPlanet->byte58 = vPlanet.byte58;
    pPlanet->byte59 = vPlanet.byte59;
    pPlanet->Unknown_5A = vPlanet.Unknown_5A;
    pPlanet->Unknown_5E = vPlanet.Unknown_5E;
    pPlanet->invincible = vPlanet.invincible;
    pPlanet->flags = vPlanet.flags;
    pPlanet->dayColonized = vPlanet.dayColonized;
    pPlanet->t22 = vPlanet.t22;
    pPlanet->Unknown_77 = vPlanet.Unknown_77;
    if ( V_Game.starsNum <= pPlanet->starIndex )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x8E4);
    }
    if ( pPlanet->Unknown_E >= 5 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x8E5);
    }
    V_Game.stars[pPlanet->starIndex].planets[pPlanet->Unknown_E] = pPlanet;
    ++V_Game.stars[pPlanet->starIndex].planetsNum;
  }
  else
  {
    Q_CFile_Write_sub_1C098(pfi, pPlanet, 0x7Bu);
  }
}

//----- (000372B0) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd7PW_Ctor_sub_372B0(P_Wnd07PW pWnd7PW)
{
  Q_WndA2_Ctor_sub_2C830(&pWnd7PW->super);
  pWnd7PW->super.pProcs = &Wnd7PW_Procs;
  Q_Wnd7PW_Init_sub_37310(pWnd7PW);
}

//----- (000372CC) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd7PW_Dtor_sub_372CC(P_Wnd07PW a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd7PW);
    operator delete[](v3);
  }
  else
  {
    a1->super.pProcs = &Wnd7PW_Procs;
    Q_WndA2_Dtor_sub_2C848(&a1->super, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00037310) --------------------------------------------------------
void __fastcall Q_Wnd7PW_Init_sub_37310(P_Wnd07PW pWnd7PW)
{
  P_Wnd07PW v1; // kr00_4
  UWORD squareIndex2; // ax
  int i; // ebx
  char filename[64]; // [esp+0h] [ebp-40h] BYREF

  v1 = pWnd7PW;
  pWnd7PW->planetItemIndex = -1;
  pWnd7PW->squareIndex2 = -1;
  squareIndex2 = pWnd7PW->squareIndex2;
  v1->Unknown_18B = 5;
  v1->squareIndex3 = squareIndex2;
  v1->squareIndex1 = squareIndex2;
  for ( i = 0; i < 11; ++i )
  {
    sprintf(filename, "data\\planal%02d.shp", i);
    v1->planalShpCacheIndex[i] = Q_Cache_AddFile_sub_1ADAC(&WinMgr.cache, filename);
  }
}

//----- (00037380) --------------------------------------------------------
// Transform screen coordinates to column and row coordinates of planet surface square
T_SquareGridCoord __fastcall Q_ScreenToSurfaceSquareGridCoord_sub_37380(int screenX, int screenY)
{
  return (T_SquareGridCoord)((__int16)((0x11 * screenX + 0x22 * screenY - 0x29D6) / 0x484) | (((0x11 * screenX - 0x22 * screenY - 0xC9E)
                                                                                             / (int)0xFFFFFB7C) << 0x10));
}

//----- (000373E0) --------------------------------------------------------
int __fastcall Q_GetSquareIndexAtScreen_sub_373E0(int screenX, int screenY)
{
  T_SquareGridCoord gridCoord; // eax

  if ( screenX > 13 && screenX < 153 && screenY > 119 && screenY < 469 )
  {
    // Orbital
    return (screenY - 119) / 70 + V_Game.pCurPlanet->surfaceSquaresNum + 5 * ((screenX - 13) / 70);
  }
  // Surface
  gridCoord = Q_ScreenToSurfaceSquareGridCoord_sub_37380(screenX, screenY);
  return (unsigned __int16)Q_Planet_GetSquareIndex_sub_35968(V_Game.pCurPlanet, *(int *)&gridCoord >> 0x10, (__int16)gridCoord.row);
}

//----- (0003745C) --------------------------------------------------------
void __fastcall Q_DrawItemFunc_sub_3745C(PANE *pPane, void *pData, int param1, BOOL hovered)
{
  LONG wipeColor; // eax
  T_Wnd07PW *Wnd_sub_56DA8; // eax
  LONG scale; // ebp
  unsigned __int16 v8; // bx
  void *ShapeTable_sub_1B084; // eax
  void *v10; // eax
  char *name; // ecx
  LONG v12; // [esp-20h] [ebp-40h]
  int v13; // [esp-18h] [ebp-38h]
  int v14; // [esp+0h] [ebp-20h] BYREF
  int hotY; // [esp+4h] [ebp-1Ch] BYREF
  LONG shape_number; // [esp+8h] [ebp-18h] BYREF
  UWORD pCacheIndex; // [esp+Ch] [ebp-14h] BYREF
  UBYTE a2; // [esp+10h] [ebp-10h]

  wipeColor = 0xF2;
  if ( hovered )
  {
    wipeColor = 0x96;
  }
  VFX_pane_wipe(pPane, wipeColor);
  a2 = *(_BYTE *)pData;
  if ( a2 != 0xFF )
  {
    Wnd_sub_56DA8 = (T_Wnd07PW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLANETALLOC", 0);
    sub_39390(Wnd_sub_56DA8, a2, &pCacheIndex, (UWORD *)&shape_number);
    scale = 0x10000;
    if ( a2 == 0x17 )
    {
      scale = 0x8000;
    }
    v8 = shape_number;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex);
    Q_Pane_CenterShape_sub_2BC40(pPane, ShapeTable_sub_1B084, v8, &v14, &hotY);
    v13 = hotY;
    v12 = (unsigned __int16)shape_number;
    v10 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex);
    VFX_shape_transform(pPane, v10, v12, 40, v13, V_BigBuffer, 0, scale, scale, 0);
  }
  name = V_PlanetItems.item[*(unsigned __int8 *)pData].name;
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x50, 0, name, 1u, 0xFFFF, 0xFF, 0);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00037568) --------------------------------------------------------
int __fastcall Q_Wnd07PW_Proc3_sub_37568(P_Wnd07PW pWnd7PW, UWORD message, int param1, int param2)
{
  T_Wnd10LB *pWnd10LB; // ecx
  P_Wnd14PSW pWnd14PSW; // eax
  P_Wnd14PSW v6; // edi
  char *v7; // ebx
  P_Wnd07PW v9; // eax
  P_Procs v10; // ebx
  int j; // kr04_4
  P_Wnd07PW v12; // eax
  P_Wnd07PW v13; // edx
  int Unknown_35; // edx
  P_Wnd07PW v15; // edx
  int squareIndex1; // edx
  T_Planet *v17; // eax
  T_Planet *v18; // eax
  T_Planet *pCurPlanet; // eax
  P_Wnd07PW v20; // edx
  UBYTE planetItemIndex; // ch
  unsigned __int8 v22; // dh
  P_Ship v23; // esi
  int GizmoHullCellIndex_sub_4937C; // eax
  T_Star *v25; // edi
  P_Planet v26; // ebx
  char *sub_1CEA8; // eax
  P_Planet v28; // edx
  UBYTE raceIndex; // cl
  int v30; // edi
  int v31; // ecx
  WORD v32; // dx
  int v33; // esi
  int PlanetsNum_sub_402E0; // eax
  char *v35; // ebx
  int v36; // eax
  char *v37; // eax
  P_Wnd20HW v38; // edi
  P_Wnd20HW v39; // edi
  MACRO_VFX_BOOL v40; // eax
  unsigned __int8 v41; // al
  unsigned __int16 squareIndex2; // bx
  P_Wnd07PW v43; // eax
  int squareIndex3; // eax
  LONG v45; // ebx
  P_Procs pProcs; // esi
  P_Wnd10LB v47; // eax
  P_Wnd07PW v48; // edi
  P_Wnd07PW v49; // kr08_4
  BYTE *p_type; // edi
  T_Wnd10LB *pListBox; // eax
  int v52; // esi
  T_Ship *v53; // ecx
  P_Wnd08SW pWnd8SW; // edi
  T_Ship *ShipAtSquare_sub_35A70; // eax
  char *v56; // [esp-8h] [ebp-120h]
  int v57; // [esp-4h] [ebp-11Ch]
  char v58[200]; // [esp+0h] [ebp-118h] BYREF
  int s[7]; // [esp+C8h] [ebp-50h] BYREF
  _DWORD v60[5]; // [esp+E4h] [ebp-34h]
  int v61; // [esp+F8h] [ebp-20h]
  P_Wnd20HW a1; // [esp+FCh] [ebp-1Ch]
  int param2a; // [esp+100h] [ebp-18h]
  P_Wnd10LB pWnd10LB_; // [esp+104h] [ebp-14h]
  int param1a; // [esp+108h] [ebp-10h]
  int i; // [esp+10Ch] [ebp-Ch]
  P_Wnd07PW pWnd7PW_; // [esp+110h] [ebp-8h]
  UWORD message_; // [esp+114h] [ebp-4h]

  pWnd7PW_ = pWnd7PW;
  message_ = message;
  param1a = param1;
  param2a = param2;
  pWnd10LB = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0);
  pWnd10LB_ = pWnd10LB;
  pWnd14PSW = (T_Wnd14PSW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLSQUARE", 0);
  v6 = pWnd14PSW;
  if ( message >= 7u )
  {
    if ( message_ <= 7u )
    {
      Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, pWnd7PW_->super.index, 4, 8, 0, 0);
      if ( (pWnd7PW_->super._mouseFocus & pWnd7PW_->super.Unknown_35 & pWnd7PW_->super.Unknown_39) == 0xFFFFFFFF )
      {
        pWnd7PW_->super.pProcs->proc5((P_WndA2)pWnd7PW_, 0);
      }
      return 0xFFFFFFFF;
    }
    if ( message_ >= 0x33u )
    {
      if ( message > 0x33u )
      {
        if ( message_ < 0x1C01u )
        {
          if ( message_ != 0x34 )
          {
            return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->super, message_, param1a, param2a);
          }
          v52 = 0xFFFFFFFF;
          if ( param2a )
          {
            pWnd7PW_->squareIndex3 = pWnd14PSW->squareIndex;
          }
          else
          {
            v53 = sub_40144(&V_Game.races[V_Game.pCurPlanet->raceIndex], V_Game.pCurPlanet);
            if ( !v53 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x2AD);
            }
            v52 = 0;
            Q_Planet_AssignShipToOrbitalSquare_sub_35B04(V_Game.pCurPlanet, param1a, v53);
          }
          pWnd8SW = (T_Wnd08SW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "SHIPDESSCREEN", 0);
          ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, param1a);
          sub_4DA7C(pWnd8SW, ShipAtSquare_sub_35A70, v52, 0);
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 8, 1);
          return 0;
        }
        else
        {
          v7 = (char *)pWnd7PW_ + 5 * param1a;
          if ( message_ <= 0x1C01u )
          {
            v41 = v7[0xB2];
            squareIndex2 = pWnd7PW_->squareIndex2;
            pWnd7PW_->planetItemIndex = v41;
            if ( squareIndex2 == 0xFFFF )
            {
              if ( v41 != 0xFF && (V_PlanetItems.item[v41].flags & 2) != 0 )
              {
                Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, 0xFFFFu, v41, 2u);
                pWnd7PW_->planetItemIndex = 0xFF;
              }
            }
            else if ( v41 != 0xFF )
            {
              if ( Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, pWnd7PW_->planetItemIndex, squareIndex2) == 0xFFFFFFFF )
              {
                if ( pWnd7PW_->planetItemIndex == ASCEND_PI_23_SHIP )
                {
                  pWnd7PW_->squareIndex3 = pWnd7PW_->squareIndex2;
                }
                Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd7PW_->squareIndex2, pWnd7PW_->planetItemIndex, 2u);
              }
              v43 = pWnd7PW_;
              pWnd7PW_->planetItemIndex = 0xFF;
              v43->squareIndex1 = 0xFFFF;
              pWnd7PW_->squareIndex2 = v43->squareIndex1;
            }
            Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB_->a2.index, 2, 0, 0);
            squareIndex3 = pWnd7PW_->squareIndex3;
            if ( (unsigned __int16)squareIndex3 == 0xFFFF )
            {
              pWnd7PW_->super.pProcs->proc4_draw((P_WndA2)pWnd7PW_, 0);
            }
            else
            {
              pWnd7PW_->super.pProcs->proc3_msg((P_WndA2)pWnd7PW_, 0x34, squareIndex3, 0);
            }
            return 0;
          }
          else
          {
            if ( message_ != 0x1C02 )
            {
              return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->super, message_, param1a, param2a);
            }
            v45 = (unsigned __int8)v7[0xB2];
            if ( v45 != 0xFF )
            {
              Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, v45, 5);
            }
            return 0xFFFFFFFF;
          }
        }
      }
      if ( V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
      {
        if ( param1a == 1 )
        {
          pWnd7PW_->squareIndex2 = 0xFFFF;
        }
        v47 = pWnd10LB_;
        v48 = pWnd7PW_;
        pWnd10LB_->Unknown_AB = 0;
        v49 = pWnd7PW_;
        v47->_defaultItemHeight = 75;
        v47->wipeColor = 0xF2;
        Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(v47, Q_DrawItemFunc_sub_3745C);
        v61 = 0;
        p_type = &v48->Unknown_B2[0].type;
        Q_Wnd10LB_Clear_sub_2ED4C(pWnd10LB_);
        for ( i = 0; i < 39; ++i )
        {
          if ( (_BYTE)i != ASCEND_PI_05_COLONY_BASE && Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, i, pWnd7PW_->squareIndex2) )
          {
            pListBox = pWnd10LB_;
            v49->Unknown_B2[v61].type = i;
            v49->Unknown_B2[v61].pObject.pPlanet = 0;
            Q_Wnd10LB_AddItem_sub_2EA8C(pListBox, p_type, 0xFFFF, 0);
            p_type += 5;
            ++v61;
          }
        }
        if ( v61 )
        {
          Q_WndA2_CallChildrenProc3_sub_2D258(&pWnd7PW_->super, 6u, 0, 0);
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB_->a2.index, 1, 0, 0);
        }
      }
LABEL_147:
      pWnd7PW_->super.pProcs->proc4_draw((P_WndA2)pWnd7PW_, 0);
      return 0;
    }
    if ( message_ <= 8u )
    {
      if ( !pWnd10LB->a2.Unknown_35 && !pWnd14PSW->a.Unknown_35 )
      {
        v15 = pWnd7PW_;
        pWnd7PW_->squareIndex1 = Q_GetSquareIndexAtScreen_sub_373E0(param1a, param2a);
        if ( V_Game.pCurPlanet->raceIndex != V_PlayerRaceIndex
          && v15->planetItemIndex != 5
          && pWnd7PW_->squareIndex1 != 0xFFFF
          && (V_Game.pCurPlanet->pSquares[pWnd7PW_->squareIndex1].planetItemIndex != ASCEND_PI_23_SHIP
           || Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, pWnd7PW_->squareIndex1)->raceIndex != V_PlayerRaceIndex) )
        {
          pWnd7PW_->squareIndex1 = 0xFFFF;
        }
        squareIndex1 = pWnd7PW_->squareIndex1;
        if ( (unsigned __int16)squareIndex1 != 0xFFFF
          && V_Game.pCurPlanet->pSquares[squareIndex1].planetItemIndex == ASCEND_PI_23_SHIP
          && Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, squareIndex1)->raceIndex != V_PlayerRaceIndex )
        {
          pWnd7PW_->squareIndex1 = 0xFFFF;
        }
        goto LABEL_147;
      }
    }
    else
    {
      if ( message_ != 0x32 )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->super, message_, param1a, param2a);
      }
      pWnd7PW_->squareIndex1 = 0xFFFF;
      if ( param1a == 0xA || param1a == 0xB )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.index, 2, 0, 0);
        ((void (*)(void))pWnd7PW_->super.pProcs->proc3_msg)();
        return 0;
      }
      if ( param1a == 0xC )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.index, 2, 0, 0);
        pProcs = pWnd7PW_->super.pProcs;
        pWnd7PW_->planetItemIndex = 5;
        ((void (*)(void))pProcs->proc3_msg)();
        return 0;
      }
      if ( param1a == 4
        || V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex
        || pWnd7PW_->squareIndex2 != 0xFFFF
        && V_Game.pCurPlanet->pSquares[pWnd7PW_->squareIndex2].planetItemIndex == 0x17
        && Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, pWnd7PW_->squareIndex2)->raceIndex == V_PlayerRaceIndex )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v6->a.index, 0x32, param1a, pWnd7PW_->squareIndex2);
        Q_WndA2_CallChildrenProc3_sub_2D258(&pWnd7PW_->super, 6u, 0, 0);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v6->a.index, 1, 0, 0);
        pWnd7PW_->super.pProcs->proc4_draw((P_WndA2)pWnd7PW_, 0);
        return 0;
      }
    }
    return 0;
  }
  if ( message_ < 4u )
  {
    if ( !message_ )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->super, message_, param1a, param2a);
    }
    if ( message > 1u )
    {
      if ( message_ != 3 )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->super, message_, param1a, param2a);
      }
      if ( (unsigned int)param2a < 0x17 )
      {
        if ( (unsigned int)param2a < 0x13 )
        {
          if ( param2a == 1 )
          {
            if ( pWnd10LB->a2.Unknown_35 )
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB->a2.index, 2, 0, 0);
            }
            else if ( pWnd14PSW->a.Unknown_35 )
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.index, 2, 0, pWnd10LB->a2.Unknown_35);
            }
            else
            {
              Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
            }
          }
        }
        else if ( (unsigned int)param2a <= 0x13 )
        {
          if ( V_CheatMode )
          {
            if ( V_Game.pCurPlanet->raceIndex == 0xFF )
            {
              V_Game.pCurPlanet->raceIndex = V_PlayerRaceIndex;
            }
            else
            {
              Q_Star_ChangePlanetOwnership_sub_1D234(&V_Game.stars[V_Game.pCurPlanet->starIndex], V_Game.pCurPlanet, V_PlayerRaceIndex);
            }
          }
        }
        else if ( param2a == 0x14 && V_CheatMode )
        {
          pCurPlanet = V_Game.pCurPlanet;
          V_Game.pCurPlanet->population += 2;
          Q_Planet_BuildAtOptimalLocation_sub_34AE4(pCurPlanet, 5u, 0xFFFFFFFF);
        }
      }
      else if ( (unsigned int)param2a <= 0x17 )
      {
        if ( V_CheatMode )
        {
          v17 = V_Game.pCurPlanet;
          V_Game.pCurPlanet->buildingProgress += 200;
          sub_352E0(v17);
        }
      }
      else if ( (unsigned int)param2a < 0x1F )
      {
        if ( param2a == 0x18 && V_CheatMode )
        {
          V_Game.pCurPlanet->population = V_Game.pCurPlanet->maximumPopulation;
        }
      }
      else if ( (unsigned int)param2a <= 0x1F )
      {
        pWnd7PW_->Unknown_18B ^= 1u;
      }
      else if ( (unsigned int)param2a >= 0x31 )
      {
        if ( (unsigned int)param2a <= 0x31 )
        {
          if ( V_CheatMode )
          {
            sub_352E0(V_Game.pCurPlanet);
          }
        }
        else if ( param2a == 0x32 )
        {
          if ( V_Keyboard.Shift )
          {
            if ( V_CheatMode )
            {
              v18 = V_Game.pCurPlanet;
              ++V_Game.pCurPlanet->maximumPopulation2;
              Q_Planet_CalcPoints_sub_34E70(v18);
            }
          }
          else
          {
            V_Game.pCurPlanet->Unknown_5A = ~V_Game.pCurPlanet->Unknown_5A;
          }
        }
      }
      goto LABEL_147;
    }
    v60[0] = off_96850[0];
    v60[1] = off_96850[1];
    v60[2] = off_96850[2];
    v60[3] = off_96850[3];
    v60[4] = off_96850[4];
    for ( j = 0; j != 5; ++j )
    {
      Q_WinMgr_DispatchMessageProc3_sub_56D70(&WinMgr, (char *)v60[j], message_, param1a, param2a);
    }
    v12 = pWnd7PW_;
    pWnd7PW_->super.Unknown_35 = 0xFFFFFFFF;
    v12->super.Unknown_39 = 0xFFFFFFFF;
    v12->planetItemIndex = 0xFF;
    v12->squareIndex1 = 0xFFFF;
    v13 = pWnd7PW_;
    pWnd7PW_->squareIndex2 = v12->squareIndex1;
    if ( v13->squareIndex3 != 0xFFFF )
    {
      sub_394BC(v13);
    }
    pWnd7PW_->super.pProcs->proc4_draw((P_WndA2)pWnd7PW_, 0);
    if ( V_ShipNameText )
    {
      sub_557D4(&WinMgr, dword_104680, V_ShipNameText, 20);
      V_ShipNameText = 0;
    }
    return 0;
  }
  if ( message > 4u )
  {
    if ( message_ <= 5u )
    {
      v9 = pWnd7PW_;
      pWnd7PW_->planetItemIndex = 0xFF;
      v10 = v9->super.pProcs;
      v9->squareIndex2 = 0xFFFF;
      ((void (*)(void))v10->proc4_draw)();
      return 0xFFFFFFFF;
    }
    else
    {
      Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWnd7PW_->super.index, 8);
      if ( (pWnd7PW_->super._mouseFocus & pWnd7PW_->super.Unknown_35 & pWnd7PW_->super.Unknown_39) == 0xFFFFFFFF )
      {
        pWnd7PW_->super.pProcs->proc4_draw((P_WndA2)pWnd7PW_, 0);
      }
      return 0xFFFFFFFF;
    }
  }
  Unknown_35 = pWnd7PW_->super.Unknown_35;
  if ( !Unknown_35 )
  {
    return Unknown_35;
  }
  if ( pWnd10LB->a2.Unknown_35 )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB->a2.index, 2, 0, 0);
  }
  else if ( pWnd14PSW->a.Unknown_35 )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.index, 2, 0, pWnd10LB->a2.Unknown_35);
  }
  else
  {
    v20 = pWnd7PW_;
    pWnd7PW_->squareIndex2 = pWnd7PW_->squareIndex1;
    if ( v20->squareIndex2 == 0xFFFF )
    {
      if ( v20->planetItemIndex != (BYTE)0xFF )
      {
        v20->planetItemIndex = 0xFF;
      }
    }
    else
    {
      if ( v20->super.soundNumber != 0xFFFFFFFF )
      {
        Q_SSystem_StartSample_sub_4FB90(&V_SSystem, v20->super.soundNumber);
      }
      planetItemIndex = pWnd7PW_->planetItemIndex;
      if ( planetItemIndex == 0xFF )
      {
        pWnd7PW_->super.pProcs->proc3_msg(&pWnd7PW_->super, 0x32u, 3, 0);
        return 0;
      }
      if ( Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, planetItemIndex, pWnd7PW_->squareIndex2) )
      {
        v22 = pWnd7PW_->planetItemIndex;
        if ( v22 == 5 )
        {
          v23 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, v6->squareIndex);
          GizmoHullCellIndex_sub_4937C = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v23, ASCEND_GIZMO_71_COLONIZER);
          Q_Ship_RemoveGizmoFromCell_sub_492F8(v23, GizmoHullCellIndex_sub_4937C);
          v25 = &V_Game.stars[V_Game.pCurPlanet->starIndex];
          if ( V_Game.pCurPlanet->raceIndex != 0xFF )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x1C6);
          }
          v26 = V_Game.pCurPlanet;
          sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1F);// 31: "Name Your Colony"
          sub_557D4(&WinMgr, sub_1CEA8, v26->name, 0x14);
          v28 = V_Game.pCurPlanet;
          raceIndex = v23->raceIndex;
          V_Game.pCurPlanet->raceIndex = raceIndex;
          v25->planetsRacesBits |= 1 << raceIndex;
          v28->population = 2;
          v28->dayColonized = V_Game.day;
          v30 = 0;
          Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd7PW_->squareIndex2, pWnd7PW_->planetItemIndex, 0);
          v31 = 0xFFFFFFFF;
          memset(s, 0, sizeof(s));
          if ( V_Game.racesNum > 0 )
          {
            v32 = 0;
            do
            {
              v33 = v32;
              if ( !V_Game.races[v33].extinct )
              {
                PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[v33]);
                s[v32] = PlanetsNum_sub_402E0;
                if ( v30 < PlanetsNum_sub_402E0 && (v32 == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[v32]) )
                {
                  v31 = v32;
                  v30 = s[v32];
                }
              }
              ++v32;
            }
            while ( v32 < V_Game.racesNum );
          }
          if ( v31 < 0 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x1E9);
          }
          a1 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "HELPWINDOW", 0);
          v35 = "colonize";
          if ( v31 == V_PlayerRaceIndex )
          {
            v35 = "maxcolonize";
          }
          Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(a1, "help.txt", v35);
          v57 = s[v31];
          v56 = V_SpecNames[V_Game.races[v31].species];
          if ( s[V_PlayerRaceIndex] == 1 )
          {
            v36 = 0x20;                                // 32: "y"
          }
          else
          {
            v36 = 0x21;                                // 33: "ies"
          }
          v37 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v36);
          v38 = a1;
          sprintf(v58, a1->helpItems[0].pText, V_SpecNames[V_Game.races[V_PlayerRaceIndex].species], s[V_PlayerRaceIndex], v37, v56, v57);
          strcpy(v38->helpItems[0].pText, v58);
          a1->helpItems[1].x0 = 0x1D;
          a1->helpItems[1].y0 = V_Game.pCurPlanet->size + 5 * V_Game.pCurPlanet->type;
          v39 = a1;
          sprintf(v58, a1->helpItems[2].pText, V_Game.pCurPlanet->name);
          strcpy(v39->helpItems[2].pText, v58);
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, 0, 0);
          pWnd7PW_->planetItemIndex = 0xFF;
        }
        else
        {
          v40 = Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd7PW_->squareIndex2, v22, 2u);
          if ( pWnd7PW_->planetItemIndex == 0x17 && v40 == 0xFFFFFFFF )
          {
            pWnd7PW_->squareIndex3 = pWnd7PW_->squareIndex2;
          }
          pWnd7PW_->planetItemIndex = 0xFF;
        }
      }
    }
  }
  ((void (*)(void))pWnd7PW_->super.pProcs->proc3_msg)();
  return 0;
}
// 37B38: conditional instruction was optimized away because ch.1!=FF
// 96850: using guessed type char *off_96850[5];
// 37568: using guessed type int s[7];
// 37568: using guessed type char var_118[200];

//----- (000384B0) --------------------------------------------------------
void __fastcall Q_Wnd07PW_Proc4_sub_384B0(P_Wnd07PW pPlanetWnd, int a2)
{
  T_UWordPair planetType; // eax
  void *pShapeTable; // eax MAPDST
  BYTE planetItemIndex; // ah
  int squareIndex1; // ebx
  MACRO_VFX_BOOL v9; // eax
  int pSquares; // edx
  LONG v11; // kr18_4
  int v12; // kr08_4
  int j; // kr0C_4
  unsigned __int16 v14; // di
  int v15; // eax
  LONG v16; // ebx
  LONG v17; // ecx
  int v18; // eax
  T_HazeTables *hazeTables; // edx
  T_HazeTables *v20; // eax
  int v21; // eax
  LONG v22; // edx
  LONG v23; // ebx
  int v24; // eax
  int n; // esi
  int v26; // eax
  LONG v27; // edi
  LONG v28; // edx
  int v29; // eax
  unsigned __int16 word0; // di
  void *v31; // esi
  int v32; // esi
  unsigned __int8 v33; // al
  void *ShapeTable_sub_1B084; // eax
  int v35; // eax
  MACRO_VFX_BOOL v36; // eax
  UBYTE raceIndex; // dl
  int v38; // kr20_4
  T_UWordPair v39; // kr30_4
  int v40; // kr28_4
  int v41; // kr10_4
  int v42; // kr14_4
  LONG v43; // esi
  int v44; // edx
  T_Square *v45; // edx
  unsigned __int16 v46; // si
  int v47; // eax
  LONG v48; // esi
  int v49; // ecx
  int v50; // edi
  unsigned __int8 v51; // al
  void *v52; // eax
  BOOL v53; // edi
  void *v54; // eax
  int i; // kr04_4
  int k; // esi
  int m; // esi
  int ii; // kr2C_4
  void *v59; // [esp-24h] [ebp-3B8h]
  void *v60; // [esp-24h] [ebp-3B8h]
  LONG v61; // [esp-20h] [ebp-3B4h]
  LONG v62; // [esp-20h] [ebp-3B4h]
  LONG v63; // [esp-20h] [ebp-3B4h]
  LONG v64; // [esp-18h] [ebp-3ACh]
  LONG v65; // [esp-18h] [ebp-3ACh]
  LONG v66; // [esp-18h] [ebp-3ACh]
  LONG shapeNumber; // [esp-Ch] [ebp-3A0h]
  LONG v68; // [esp-Ch] [ebp-3A0h]
  LONG v69; // [esp-8h] [ebp-39Ch]
  LONG y; // [esp-4h] [ebp-398h]
  UBYTE v71[256]; // [esp+0h] [ebp-394h] BYREF
  UBYTE s[256]; // [esp+100h] [ebp-294h] BYREF
  SCRNVERTEX x0; // [esp+200h] [ebp-194h] BYREF
  int v74; // [esp+218h] [ebp-17Ch]
  int v75; // [esp+21Ch] [ebp-178h]
  LONG v76; // [esp+230h] [ebp-164h]
  int v77; // [esp+234h] [ebp-160h]
  int v78; // [esp+248h] [ebp-14Ch]
  int v79; // [esp+24Ch] [ebp-148h]
  SCRNVERTEX x1; // [esp+260h] [ebp-134h] BYREF
  int v81; // [esp+278h] [ebp-11Ch]
  int v82; // [esp+27Ch] [ebp-118h]
  int v83; // [esp+280h] [ebp-114h]
  LONG x; // [esp+290h] [ebp-104h]
  int v85; // [esp+294h] [ebp-100h]
  int v86; // [esp+298h] [ebp-FCh]
  int v87; // [esp+2A8h] [ebp-ECh]
  int v88; // [esp+2ACh] [ebp-E8h]
  int v89; // [esp+2B0h] [ebp-E4h]
  PANE v90; // [esp+2C0h] [ebp-D4h] BYREF
  PANE pane; // [esp+2D4h] [ebp-C0h] BYREF
  PANE v92; // [esp+2E8h] [ebp-ACh] BYREF
  PANE pPane; // [esp+2FCh] [ebp-98h] BYREF
  int v94; // [esp+310h] [ebp-84h]
  int v95; // [esp+314h] [ebp-80h]
  int v96; // [esp+318h] [ebp-7Ch]
  int v97; // [esp+31Ch] [ebp-78h]
  int v98; // [esp+320h] [ebp-74h]
  int v99; // [esp+324h] [ebp-70h]
  int v100; // [esp+328h] [ebp-6Ch]
  void *shape_table; // [esp+32Ch] [ebp-68h]
  T_UWordPair a2a; // [esp+330h] [ebp-64h]
  int v103; // [esp+334h] [ebp-60h]
  int v104; // [esp+338h] [ebp-5Ch]
  int v105; // [esp+33Ch] [ebp-58h]
  LONG shape_number; // [esp+340h] [ebp-54h]
  int v107; // [esp+344h] [ebp-50h]
  LONG v108; // [esp+348h] [ebp-4Ch]
  unsigned __int8 *v109; // [esp+34Ch] [ebp-48h]
  int v110; // [esp+350h] [ebp-44h]
  int v111; // [esp+354h] [ebp-40h]
  int v112; // [esp+358h] [ebp-3Ch]
  LONG hotX; // [esp+35Ch] [ebp-38h]
  int v114; // [esp+360h] [ebp-34h]
  int v115; // [esp+364h] [ebp-30h]
  T_UWordPair planalCacheIndex; // [esp+368h] [ebp-2Ch] BYREF
  MACRO_VFX_BOOL v117; // [esp+36Ch] [ebp-28h]
  T_UWordPair data17npShapeIndex; // [esp+370h] [ebp-24h]
  int v119; // [esp+374h] [ebp-20h]
  LONG v120; // [esp+378h] [ebp-1Ch] BYREF
  unsigned __int8 v121; // [esp+37Ch] [ebp-18h]

  shape_number = V_Game.pCurPlanet->size;
  planetType.word0 = V_Game.pCurPlanet->type;
  data17npShapeIndex = (T_UWordPair)GwshareShpCacheIndexes[0x2C];// 44: data\17np.shp
  planetType = (T_UWordPair)planetType.word0;
  planetType.word0 = pPlanetWnd->planalShpCacheIndex[planetType.word0];
  planalCacheIndex = planetType;
  if ( pPlanetWnd->super.shapeNumber != 0xFFFFFFFF )
  {
    pShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, data17npShapeIndex.word0);
    VFX_shape_draw(&pPlanetWnd->super.pane, pShapeTable, 4, 7, 115);
    if ( (pPlanetWnd->Unknown_18B & 4) != 0 )
    {
      pShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planalCacheIndex.word0);
      VFX_shape_draw(&pPlanetWnd->super.pane, pShapeTable, shape_number, 408, 296);
    }
    shapeNumber = pPlanetWnd->super.shapeNumber;
    pShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, data17npShapeIndex.word0);
    VFX_shape_draw(&pPlanetWnd->super.pane, pShapeTable, shapeNumber, 0, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPlanetWnd->super.pane);
  }
  pPane = pPlanetWnd->super.pane;
  planetItemIndex = pPlanetWnd->planetItemIndex;
  v117 = 0xFFFF;
  if ( planetItemIndex != (BYTE)0xFF )
  {
    v117 = 0xFFFE;
    squareIndex1 = pPlanetWnd->squareIndex1;
    if ( (unsigned __int16)squareIndex1 != 0xFFFF && V_Game.pCurPlanet->pSquares[squareIndex1].planetItemIndex == 0xFF )
    {
      v9 = Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, pPlanetWnd->planetItemIndex, squareIndex1);
      if ( v9 )
      {
        LOWORD(v9) = pPlanetWnd->squareIndex1;
        v117 = v9;
      }
    }
  }
  pSquares = (int)V_Game.pCurPlanet->pSquares;
  v120 = 0xFFFF;
  v109 = (unsigned __int8 *)pSquares;
  LOBYTE(pSquares) = V_Game.pCurPlanet->raceIndex;
  a2a = 0;
  if ( (_BYTE)pSquares == V_PlayerRaceIndex
    || Q_Planet_GetSquareWithItem_sub_35930(V_Game.pCurPlanet, ASCEND_PI_11_SURFACE_CLOAKER) == 0xFFFF )
  {
    v111 = 110;
    v98 = 410;
    v112 = 0xF * shape_number;
    v11 = shape_number;
    for ( i = 0; i != 0xF; ++i )
    {
      v96 = V_PlanetCfg.offsets.sizes[v11].column[i];
      v12 = v96;
      v105 = v98;
      v100 = v11 * 0xF + i;
      v110 = 0x11 * i + 110;
      for ( j = 0; V_PlanetCfg.offsets.sizes[0].column[v100] + V_PlanetCfg.squares.sizes[0].column[v100] > v12 + j; ++j )
      {
        x1.x = 0x22 * (v12 + j) + v105;
        v81 = x1.x + 0x22;
        x = x1.x;
        v87 = x1.x - 0x22;
        x1.y = 0x11 * (v12 + j) + v110;
        v82 = x1.y + 0x11;
        v85 = x1.y + 0x22;
        v88 = x1.y + 0x11;
        v89 = 0x960000;
        v86 = 0x960000;
        v83 = 0x960000;
        x1.c = 0x960000;
        HIWORD(v35) = HIWORD(v109);
        v121 = v109[1];
        LOWORD(v35) = *v109;
        v119 = v35;
        v94 = dword_96864[0];
        v95 = dword_96864[1];
        v36 = Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, 0xFFu, a2a.word0);
        if ( pPlanetWnd->squareIndex1 == a2a && pPlanetWnd->planetItemIndex == (BYTE)0xFF && v121 == 0xFF && v36 == 0xFFFFFFFF )
        {
          VFX_flat_polygon(&V_GSystem.pane, 4, &x1);
          goto LABEL_34;
        }
        if ( (pPlanetWnd->Unknown_18B & 1) != 0 )
        {
          v14 = 0xC;
          v115 = 0xD;
          if ( !(_WORD)v119 )
          {
            v115 = 7;
            v14 = 0;
          }
          switch ( (unsigned __int16)v119 )
          {
            case 2u:
              v14 = 0x75;
              v115 = 8;
              break;
            case 3u:
              v14 = 0x92;
              v115 = 9;
              break;
            case 4u:
              v14 = 0xFF;
              v115 = 0xA;
              break;
          }
          if ( v36 == 0xFFFFFFFF )
          {
            x0.x = x1.x;
            x0.y = x1.y + 1;
            v74 = v81 - 2;
            v75 = v82;
            v76 = x;
            v77 = v85 - 1;
            v78 = v87 + 2;
            v79 = v88;
            for ( k = 0; k < 4; ++k )
            {
              v15 = 0x18 * *((char *)&v95 + k);
              v16 = *(LONG *)((char *)&x0.y + v15);
              v17 = *(LONG *)((char *)&x0.x + v15);
              v18 = 0x18 * *((char *)&v94 + k);
              VFX_line_draw(&V_GSystem.pane, *(LONG *)((char *)&x0.x + v18), *(LONG *)((char *)&x0.y + v18), v17, v16, 0, v14);
            }
            if ( (_WORD)v115 )
            {
              hazeTables = V_GSystem.hazeTables;
              v20 = (T_HazeTables *)((unsigned __int16)v115 << 8);
LABEL_33:
              VFX_translate_polygon(&V_GSystem.pane, 4, &x0, (char *)v20 + (_DWORD)hazeTables);
            }
          }
          else
          {
            x0.x = x1.x;
            x0.y = x1.y + 0xE;
            v74 = v81 - 0x1C;
            v75 = v82;
            v76 = x;
            v77 = v85 - 0xE;
            v78 = v87 + 0x1C;
            v79 = v88;
            for ( m = 0; m < 4; ++m )
            {
              v21 = 0x18 * *((char *)&v95 + m);
              v22 = *(LONG *)((char *)&x0.y + v21);
              v23 = *(LONG *)((char *)&x0.x + v21);
              v24 = 0x18 * *((char *)&v94 + m);
              VFX_line_draw(&V_GSystem.pane, *(LONG *)((char *)&x0.x + v24), *(LONG *)((char *)&x0.y + v24), v23, v22, 0, v14);
            }
            if ( (_WORD)v115 )
            {
              v20 = V_GSystem.hazeTables;
              hazeTables = (T_HazeTables *)((unsigned __int16)v115 << 8);
              goto LABEL_33;
            }
          }
        }
LABEL_34:
        if ( pPlanetWnd->squareIndex1 == a2a && pPlanetWnd->planetItemIndex == (BYTE)0xFF && v121 == 0xFF )
        {
          for ( n = 0; n < 4; ++n )
          {
            v26 = 0x18 * *((char *)&v95 + n);
            v27 = *(LONG *)((char *)&x1.y + v26);
            v28 = *(LONG *)((char *)&x1.x + v26);
            v29 = 0x18 * *((char *)&v94 + n);
            VFX_line_draw(&V_GSystem.pane, *(LONG *)((char *)&x1.x + v29), *(LONG *)((char *)&x1.y + v29), v28, v27, 0, 0x96);
          }
        }
        if ( v121 == 0xFF && (v119 & 8) == 0 )
        {
          if ( (unsigned __int16)v117 == a2a )
          {
            sub_39390(pPlanetWnd, pPlanetWnd->planetItemIndex, (UWORD *)&planalCacheIndex, (UWORD *)&v120);
            y = x1.y;
            v69 = x1.x;
            v68 = (unsigned __int16)v120;
            ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planalCacheIndex.word0);
            VFX_shape_draw(&V_GSystem.pane, ShapeTable_sub_1B084, v68, v69, y);
          }
        }
        else
        {
          word0 = a2a.word0;
          sub_393F4(pPlanetWnd, a2a.word0, (UWORD *)&planalCacheIndex, &v120);
          v31 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planalCacheIndex.word0);
          shape_table = v31;
          if ( V_Game.pCurPlanet->_squareIndex == a2a )
          {
            VFX_flat_polygon(&V_GSystem.pane, 4, &x1);
            v32 = 0x22 * V_Game.pCurPlanet->buildingProgress;
            v114 = v32 / Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, word0, 0xFFu);
            v33 = 0xF2;
            if ( pPlanetWnd->squareIndex1 == a2a )
            {
              v33 = 0x96;
            }
            memset(s, v33, sizeof(s));
            VFX_shape_lookaside(s);
            VFX_shape_translate_draw(&V_GSystem.pane, shape_table, (unsigned __int16)v120, x1.x, x1.y);
            pane = V_GSystem.pane;
            pane.y0 = x1.y + 0x22 - v114;
            if ( pPlanetWnd->squareIndex1 == a2a )
            {
              VFX_shape_lookaside((*V_GSystem.hazeTables)[0x15]);
              VFX_shape_translate_draw(&pane, shape_table, (unsigned __int16)v120, x1.x, x1.y - pane.y0);
            }
            else
            {
              VFX_shape_draw(&pane, shape_table, (unsigned __int16)v120, x1.x, x1.y - pane.y0);
            }
          }
          else if ( pPlanetWnd->squareIndex1 == a2a )
          {
            VFX_shape_lookaside((*V_GSystem.hazeTables)[0x15]);
            VFX_shape_translate_draw(&V_GSystem.pane, v31, (unsigned __int16)v120, x1.x, x1.y);
          }
          else
          {
            VFX_shape_draw(&V_GSystem.pane, v31, (unsigned __int16)v120, x1.x, x1.y);
          }
        }
        ++*(_DWORD *)&a2a;
        v109 += 4;
      }
      v98 -= 0x22;
    }
  }
  v99 = 0xD;
  raceIndex = V_Game.pCurPlanet->raceIndex;
  v108 = 0x77;
  v103 = 0;
  if ( raceIndex != V_PlayerRaceIndex && Q_Planet_GetSquareWithItem_sub_35930(V_Game.pCurPlanet, 0x19u) != 0xFFFF )
  {
    v103 = 0xFFFFFFFF;
  }
  v38 = v99;
  a2a = (T_UWordPair)V_Game.pCurPlanet->surfaceSquaresNum;
  v39 = a2a;
  v97 = 4 * *(_DWORD *)&a2a;
  v40 = *(_DWORD *)&a2a;
  hotX = v99 + 0x23;
  v41 = v99 + 0x23;
  v42 = 0;
  for ( ii = 0; V_Game.pCurPlanet->totalSquaresNum > *(_DWORD *)&v39 + ii; ++ii )
  {
    v45 = &V_Game.pCurPlanet->pSquares[ii + v40];
    v104 = 0;
    v46 = v45->planetItemIndex;
    if ( v45->planetItemIndex == 0x17 && Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a2a.word0)->raceIndex == V_PlayerRaceIndex )
    {
      v104 = 0xFFFFFFFF;
    }
    if ( pPlanetWnd->squareIndex1 == *(_DWORD *)&v39 + ii )
    {
      HIWORD(v47) = a2a.word1;
      LOWORD(v47) = v46;
      if ( v47 == 0xFF && !v103 && pPlanetWnd->planetItemIndex == (BYTE)0xFF )
      {
        pPane.x0 = v38 + 0x46 * v42;
        pPane.y0 = v108;
        pPane.x1 = pPane.x0 + 0x46;
        pPane.y1 = v108 + 0x46;
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(&pPane, 1, 1, 0x45, 0x45, 0x96u, 0);
      }
    }
    v107 = v46;
    if ( v46 == 0xFF )
    {
      if ( (unsigned __int16)v117 == *(_DWORD *)&v39 + ii )
      {
        v43 = (LONG)sub_10000;
        if ( pPlanetWnd->planetItemIndex == 0x17 )
        {
          v43 = 0x8000;
        }
        sub_39390(pPlanetWnd, pPlanetWnd->planetItemIndex, (UWORD *)&planalCacheIndex, (UWORD *)&v120);
        v64 = v108 + 0x23;
        v61 = (unsigned __int16)v120;
        v59 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planalCacheIndex.word0);
        VFX_shape_transform(&V_GSystem.pane, v59, v61, v41 + 0x46 * v42, v64, V_BigBuffer, 0, v43, v43, 0);
      }
    }
    else
    {
      sub_393F4(pPlanetWnd, a2a.word0, (UWORD *)&planalCacheIndex, &v120);
      v90 = pPlanetWnd->super.pane;
      v48 = (LONG)sub_10000;
      if ( v107 == 0x17 )
      {
        v48 = 0x8000;
      }
      if ( V_Game.pCurPlanet->_squareIndex == *(_DWORD *)&v39 + ii )
      {
        v49 = 0x46 * V_Game.pCurPlanet->buildingProgress;
        v50 = v49 / Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, a2a.word0, 0xFFu);
        v51 = 0xF2;
        if ( pPlanetWnd->squareIndex1 == *(_DWORD *)&v39 + ii )
        {
          v51 = 0x96;
        }
        memset(v71, v51, sizeof(v71));
        if ( !v103 || v104 == 0xFFFFFFFF )
        {
          VFX_shape_lookaside(v71);
          v65 = v108 + 0x23;
          v62 = (unsigned __int16)v120;
          v52 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planalCacheIndex.word0);
          VFX_shape_transform(&V_GSystem.pane, v52, v62, v41 + 0x46 * v42, v65, V_BigBuffer, 0, v48, v48, 1);
        }
        v90.y0 = v108 + 0x46 - v50;
      }
      if ( !v103 || v104 == 0xFFFFFFFF )
      {
        v53 = pPlanetWnd->squareIndex1 == *(_DWORD *)&v39 + ii;
        VFX_shape_lookaside((*V_GSystem.hazeTables)[0x15]);
        v66 = v108 + 0x23 - v90.y0;
        v63 = (unsigned __int16)v120;
        v60 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planalCacheIndex.word0);
        VFX_shape_transform(&v90, v60, v63, v41 + 0x46 * v42, v66, V_BigBuffer, 0, v48, v48, v53);
      }
    }
    v44 = (*(_DWORD *)&v39 + ii - V_Game.pCurPlanet->surfaceSquaresNum) % 5;
    v108 += 0x46;
    if ( v44 == 4 )
    {
      v108 = 0x77;
      ++v42;
    }
  }
  if ( ((T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0))->a2.Unknown_35 == 0xFFFFFFFF )
  {
    v92.window = (WINDOW *)&V_GSystem;
    v92.x0 = 0x70;
    v92.y0 = 0x70;
    v92.y1 = 0x1AC;
    v92.x1 = 0x210;
    v54 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, data17npShapeIndex.word0);
    VFX_shape_draw(&v92, v54, 5, 0, 0);
  }
  sub_2D218(&pPlanetWnd->super);
}
// 10000: using guessed type void __noreturn sub_10000();
// 96864: using guessed type _DWORD dword_96864[2];
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00039390) --------------------------------------------------------
void __fastcall sub_39390(P_Wnd07PW pWnd7PW, UBYTE a2, UWORD *pCacheIndex, UWORD *a4)
{
  if ( a2 >= 39u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x461);
  }
  *pCacheIndex = GwshareShpCacheIndexes[30];           // 30: data\planitem.shp
  *a4 = 0;
  *a4 = a2;
  if ( a2 == 23 )
  {
    *pCacheIndex = GwshareShpCacheIndexes[V_Game.pCurPlanet->raceIndex + 14];
    *a4 = 0;
  }
}
// 393C3: conditional instruction was optimized away because dl.1<27u

//----- (000393F4) --------------------------------------------------------
__int16 __fastcall sub_393F4(P_Wnd07PW pWnd, UWORD squareIndex, UWORD *a3, _WORD *a4)
{
  P_Planet pCurPlanet; // eax
  T_Square *v6; // eax
  __int16 planetItemIndex; // dx
  __int16 result; // ax
  P_Ship ShipAtSquare_sub_35A70; // esi

  if ( squareIndex >= V_Game.pCurPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x476);
  }
  *a3 = GwshareShpCacheIndexes[0x1E];                  // 30: data\planitem.shp
  pCurPlanet = V_Game.pCurPlanet;
  *a4 = 0;
  v6 = &pCurPlanet->pSquares[squareIndex];
  planetItemIndex = v6->planetItemIndex;
  if ( (unsigned __int8)planetItemIndex == 0xFF )
  {
    if ( (v6->color & 8) != 0 )
    {
      *a4 = 0x27;
    }
  }
  else
  {
    *a4 = planetItemIndex;
  }
  result = planetItemIndex;
  if ( planetItemIndex == ASCEND_PI_23_SHIP )
  {
    ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, squareIndex);
    *a3 = GwshareShpCacheIndexes[ShipAtSquare_sub_35A70->raceIndex + 0xE];
    if ( ShipAtSquare_sub_35A70->hullSize < 0 || ShipAtSquare_sub_35A70->hullSize >= 4 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x48A);
    }
    result = ShipAtSquare_sub_35A70->hullSize;
    *a4 = result;
  }
  return result;
}

//----- (000394BC) --------------------------------------------------------
void __fastcall sub_394BC(P_Wnd07PW pWnd07PW)
{
  P_Wnd08SW pWnd08SW; // esi
  char *label; // eax
  P_Ship pShip; // edx
  int Unknown_C9; // ebp
  T_Ship *ShipAtSquare_sub_35A70; // eax
  T_Planet *pCurPlanet; // eax
  int v8; // edx
  P_Location pLocation; // eax

  pWnd08SW = (T_Wnd08SW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "SHIPDESSCREEN", 0);
  V_ShipNameText = pWnd08SW->pShip->name;
  label = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x22);    // 34: "Name Your Ship"
  pShip = pWnd08SW->pShip;
  dword_104680 = label;
  if ( pShip )
  {
    if ( pWnd08SW->Unknown_C9 == TRUE )
    {
      dword_104680 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x23);// 35: "Rename Your Ship?"
      pCurPlanet = V_Game.pCurPlanet;
      LOBYTE(V_Game.pCurPlanet->pSquares[pWnd07PW->squareIndex3].flags) &= ~1u;
      Q_Planet_HandleItemConstruction_sub_34B0C(pCurPlanet, pWnd07PW->squareIndex3, ASCEND_PI_23_SHIP, 3u);
      v8 = Q_Wnd08SW_CalculateShipRefitCost_sub_4EE00(pWnd08SW);
      pLocation.pPlanet = V_Game.pCurPlanet;
      V_Game.pCurPlanet->Unknown_77 = v8;
      pWnd08SW->pShip->locationType = ASCEND_LOCATION_TYPE_SHIPDOCK;
      pWnd08SW->pShip->pLocation = pLocation;
    }
  }
  else
  {
    Unknown_C9 = pWnd08SW->Unknown_C9;
    V_ShipNameText = 0;
    if ( !Unknown_C9 )
    {
      ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, pWnd07PW->squareIndex3);
      Q_Ship_RemoveFromTheGame_sub_49940(ShipAtSquare_sub_35A70);
      Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd07PW->squareIndex3, 0xFFu, 1u);
    }
  }
  pWnd07PW->squareIndex3 = 0xFFFF;
}

//----- (000395C4) --------------------------------------------------------
void __fastcall Q_Wnd07PW_Proc6_sub_395C4(P_Wnd07PW pWnd7PW, P_CFile pfi, BOOL read)
{
  char *p_Unknown_18B; // edx

  p_Unknown_18B = &pWnd7PW->Unknown_18B;
  if ( read == TRUE )
  {
    Q_CFile_Read_sub_1BF94(pfi, p_Unknown_18B, 1u);
  }
  else
  {
    Q_CFile_Write_sub_1C098(pfi, p_Unknown_18B, 1u);
  }
}

//----- (000395EC) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd29GSW_Ctor_sub_395EC(P_Wnd29GSW result)
{
  Q_WndA2_Ctor_sub_2C830(&result->super);
  result->super.pProcs = &Wnd29GSW_Procs;
}

//----- (000395FC) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd29GSW_Dtor_sub_395FC(P_Wnd29GSW self, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(self, &stru_95F44);
    operator delete[](v3);
  }
  else
  {
    self->super.pProcs = &Wnd29GSW_Procs;
    Q_WndA2_Dtor_sub_2C848(&self->super, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00039644) --------------------------------------------------------
int __fastcall Q_Wnd29GSW_Proc3_sub_39644(P_Wnd29GSW pWnd, UWORD message, int param1, int param2)
{
  T_Wnd14PSW *v5; // eax
  T_Wnd10LB *Wnd_sub_56DA8; // [esp+0h] [ebp-10h]

  Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0);
  v5 = (T_Wnd14PSW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLSQUARE", 0);
  if ( (Wnd_sub_56DA8->a2.Unknown_35 || v5->a.Unknown_35) && message != 0xF && message != 0xE )
  {
    return 0;
  }
  if ( message < 6u )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->super, message, param1, param2);
  }
  if ( message <= 6u )
  {
    pWnd->super.pProcs->proc4_draw((P_WndA2)pWnd, 2);
  }
  else
  {
    if ( message != 7 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->super, message, param1, param2);
    }
    pWnd->super.pProcs->proc4_draw((P_WndA2)pWnd, 1);
  }
  return 0;
}

//----- (000396F0) --------------------------------------------------------
void __fastcall Q_Wnd29GSW_Proc4_sub_396F0(P_Wnd29GSW pWnd, int a2)
{
  T_Wnd10LB *Wnd_sub_56DA8; // esi
  T_Wnd14PSW *v3; // eax
  T_Wnd07PW *v4; // ebp
  T_UWordPair v5; // eax
  LONG v6; // eax
  void *ShapeTable_sub_1B084; // eax
  LONG v8; // eax
  LONG v9; // edi
  int v10; // kr04_4
  void *v11; // eax
  LONG v12; // eax
  char *sub_1CEA8; // eax
  UWORD squareIndex; // bx
  UBYTE planetItemIndex; // cl
  char *v16; // eax
  UBYTE buildingPlanetItemIndex; // ch
  int DaysToCompleteItem_sub_358BC; // esi
  UWORD flags; // ax
  int v20; // eax
  char *v21; // eax
  char *v22; // eax
  LONG v23; // edi
  unsigned __int16 v24; // bx
  PANE *v25; // esi
  void *v26; // eax
  void *v27; // eax
  char *v28; // ecx
  int v29; // ebx
  LONG x1; // edi
  LONG x0; // ecx
  LONG y1; // ebp
  LONG y0; // esi
  LONG v34; // edi
  LONG v35; // ebp
  int j; // esi
  LONG v37; // ecx
  LONG v38; // ebx
  LONG v39; // edx
  int i; // esi
  LONG v41; // [esp-10h] [ebp-A0h]
  LONG v42; // [esp-Ch] [ebp-9Ch]
  int v43; // [esp-8h] [ebp-98h]
  char *v44; // [esp+Ch] [ebp-84h]
  char s[60]; // [esp+10h] [ebp-80h] BYREF
  LONG hotX; // [esp+4Ch] [ebp-44h] BYREF
  int hotY; // [esp+50h] [ebp-40h] BYREF
  char *name; // [esp+54h] [ebp-3Ch]
  int v49; // [esp+58h] [ebp-38h]
  LONG sendParam1; // [esp+5Ch] [ebp-34h]
  P_Wnd29GSW v51; // [esp+60h] [ebp-30h]
  PANE *pane; // [esp+64h] [ebp-2Ch]
  PANE *pPane; // [esp+68h] [ebp-28h]
  LONG p_pane; // [esp+6Ch] [ebp-24h]
  T_UWordPair index; // [esp+70h] [ebp-20h] BYREF
  LONG shape_number; // [esp+74h] [ebp-1Ch] BYREF
  UBYTE a2a; // [esp+78h] [ebp-18h]

  v51 = pWnd;
  v49 = 0;
  if ( a2 != 2 && (WinMgr._wndIndex == pWnd->super.index || a2 == 1) )
  {
    v49 = 0xFFFFFFFF;
  }
  Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0);
  v3 = (T_Wnd14PSW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLSQUARE", 0);
  if ( Wnd_sub_56DA8->a2.Unknown_35 || v3->a.Unknown_35 )
  {
    v49 = 0;
  }
  sendParam1 = v51->super.sendParam1;
  if ( sendParam1 == 4 )
  {
    sendParam1 = 3;
  }
  if ( v51->super.sendMessage == 0x33 )
  {
    sendParam1 = 4;
  }
  v4 = (T_Wnd07PW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "PLANETALLOC", 0);
  index = (T_UWordPair)0xFFFF;
  shape_number = 0xFFFF;
  VFX_shape_lookaside((*V_GSystem.hazeTables)[0x15]);
  if ( sendParam1 <= 2 )
  {
    VFX_pane_wipe(&v51->super.pane, 0);
  }
  v5.word1 = HIWORD(sendParam1);
  switch ( sendParam1 )
  {
    case 0:
      v5.word0 = GwshareShpCacheIndexes[0x26];         // 38: data\planres.shp
      index = v5;
      p_pane = (int)pow((double)V_Game.pCurPlanet->research, 0.75);
      shape_number = p_pane;
      if ( (unsigned __int16)p_pane > 0x14u )
      {
        shape_number = 0x14;
      }
      goto LABEL_23;
    case 1:
      v5.word0 = GwshareShpCacheIndexes[0x27];         // 39: data\planind.shp
      index = v5;
      p_pane = (int)pow((double)V_Game.pCurPlanet->industry, 0.75);
      shape_number = p_pane;
      if ( (unsigned __int16)p_pane > 0x14u )
      {
        shape_number = 0x14;
      }
      goto LABEL_23;
    case 2:
      v5.word0 = GwshareShpCacheIndexes[0x28];         // 40: data\planpro.shp
      index = v5;
      HIWORD(v6) = HIWORD(V_Game.pCurPlanet);
      LOWORD(v6) = V_Game.pCurPlanet->prosperity;
      shape_number = v6;
      if ( (unsigned __int16)v6 > 0x14u )
      {
        shape_number = 0x14;
      }
LABEL_23:
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index.word0);
      VFX_shape_draw(&v51->super.pane, ShapeTable_sub_1B084, (unsigned __int16)shape_number, 0, 0);
      goto LABEL_61;
    case 3:
      v8 = 0xF2;
      if ( v49 )
      {
        v8 = 0x96;
      }
      p_pane = (LONG)&v51->super.pane;
      VFX_pane_wipe(&v51->super.pane, v8);
      v9 = 0;
      shape_number = 1;
      pane = &v51->super.pane;
      v10 = 0;
      for ( i = 0; i < V_Game.pCurPlanet->maximumPopulation; ++i )
      {
        if ( i == V_Game.pCurPlanet->usedPopulation )
        {
          ++shape_number;
        }
        if ( i == V_Game.pCurPlanet->population )
        {
          ++shape_number;
        }
        v11 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2C]);// 44: data\17np.shp
        VFX_shape_draw(pane, v11, (unsigned __int16)shape_number, v9, 0xA * v10);
        v9 += 0xA;
        if ( i % 0xA == 9 )
        {
          v9 = 0;
          ++v10;
        }
      }
      goto LABEL_61;
    case 4:
      v12 = 0xF2;
      if ( v49 && V_Game.pCurPlanet->raceIndex == V_PlayerRaceIndex )
      {
        v12 = 0x96;
      }
      VFX_pane_wipe(&v51->super.pane, v12);
      a2a = 0xFF;
      qmemcpy(s, &unk_9686C, sizeof(s));
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x24);// 36: "No Project"
      squareIndex = 0xFFFF;
      planetItemIndex = v4->planetItemIndex;
      name = sub_1CEA8;
      if ( planetItemIndex == 0xFF )
      {
        buildingPlanetItemIndex = V_Game.pCurPlanet->buildingPlanetItemIndex;
        if ( buildingPlanetItemIndex != 0xFF )
        {
          DaysToCompleteItem_sub_358BC = (unsigned __int16)Q_Planet_GetDaysToCompleteItem_sub_358BC(V_Game.pCurPlanet);
          flags = V_PlanetItems.item[buildingPlanetItemIndex].flags;
          a2a = buildingPlanetItemIndex;
          if ( (flags & 0x20) == 0 )
          {
            if ( DaysToCompleteItem_sub_358BC == 0xFFFF )
            {
              v22 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x27);// 39: "No Progress"
              strcpy(s, v22);
            }
            else
            {
              if ( DaysToCompleteItem_sub_358BC == 1 )
              {
                v20 = 0x1C;                            // 28: ""
              }
              else
              {
                v20 = 0x1D;                            // 29: "s"
              }
              v44 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v20);
              v21 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x26);// 38: "%d day%s until completion"
              sprintf(s, v21, DaysToCompleteItem_sub_358BC, v44);
            }
          }
          if ( V_Game.pCurPlanet->buildingPlanetItemIndex != ASCEND_PI_35_AUTOMATION )
          {
            squareIndex = V_Game.pCurPlanet->_squareIndex;
          }
        }
      }
      else
      {
        v16 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x25);// 37: "Pick a Location"
        a2a = planetItemIndex;
        strcpy(s, v16);
      }
      if ( a2a == 0xFF )
      {
        if ( V_Game.pCurPlanet->population != V_Game.pCurPlanet->usedPopulation )
        {
          goto LABEL_60;
        }
        v29 = 0x19;
        v25 = &v51->super.pane;
        v28 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x28);// 40: "(No Free Population)"
      }
      else
      {
        if ( squareIndex == 0xFFFF )
        {
          sub_39390(v4, a2a, (UWORD *)&index, (UWORD *)&shape_number);
        }
        else
        {
          sub_393F4(v4, squareIndex, (UWORD *)&index, &shape_number);
        }
        v23 = 0x10000;
        if ( a2a == ASCEND_PI_23_SHIP )
        {
          v23 = 0x8000;
        }
        v24 = shape_number;
        name = V_PlanetItems.item[a2a].name;
        v25 = &v51->super.pane;
        v26 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index.word0);
        Q_Pane_CenterShape_sub_2BC40(v25, v26, v24, &hotX, &hotY);
        v43 = hotY;
        v42 = hotX;
        v41 = (unsigned __int16)shape_number;
        v27 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index.word0);
        VFX_shape_transform(v25, v27, v41, v42, v43, V_BigBuffer, 0, v23, v23, 0);
        v28 = s;
        v29 = 0x50;
      }
      WinMgr.LargeFont.pane = *v25;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v29, v28, 2u, 0xFFFF, 0xFF, 0);
LABEL_60:
      WinMgr.LargeFont.pane = v51->super.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xA, name, 2u, 0xFFFF, 0xFF, 0);
LABEL_61:
      if ( sendParam1 <= 2 && v49 && V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
      {
        x1 = v51->super.pane.x1;
        x0 = v51->super.pane.x0;
        y1 = v51->super.pane.y1;
        y0 = v51->super.pane.y0;
        pPane = &v51->super.pane;
        v34 = x1 - x0;
        v35 = y1 - y0;
        for ( j = 0; j < 3; ++j )
        {
          v37 = v34;
          v38 = j;
          v39 = j;
          --v34;
          Q_Pane_CopyOrDrawRectangle_sub_2BB74(pPane, v39, v38, v37, v35--, 0x96u, 0);
        }
      }
      Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &v51->super.pane);
      return;
    default:
      goto LABEL_61;
  }
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00039D80) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd14PSW_Ctor_sub_39D80(P_Wnd14PSW pWnd14PSW)
{
  Q_WndA2_Ctor_sub_2C830(&pWnd14PSW->a);
  pWnd14PSW->a.pProcs = &Wnd14PSW_Procs;
  Q_ReadPlanetTexts_sub_39DE0();
}

//----- (00039D9C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd14PSW_Dtor_sub_39D9C(P_Wnd14PSW pWnd14PSW, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd14PSW, &C_Wnd14PSW);
    operator delete[](v3);
  }
  else
  {
    pWnd14PSW->a.pProcs = &Wnd14PSW_Procs;
    Q_WndA2_Dtor_sub_2C848(&pWnd14PSW->a, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(pWnd14PSW);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00039DE0) --------------------------------------------------------
void __fastcall Q_ReadPlanetTexts_sub_39DE0()
{
  int i; // kr04_4
  int j; // kr0C_4
  int k; // kr14_4

  for ( i = 0; i != 5; ++i )
  {
    PlanetSizeTexts[i] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(i + 41);
  }
  for ( j = 0; j != 0xB; ++j )
  {
    PlanetTypeTexts[j] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(j + 46);
  }
  for ( k = 0; k != 8; ++k )
  {
    PlanetButtonTexts[k] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(k + 57);
  }
}
/* Orphan comments:
41: "Tiny"
46: "Husk"
57: "Cancel"
*/

//----- (00039E3C) --------------------------------------------------------
int __fastcall Q_Wnd14PSW_Proc3_sub_39E3C(P_Wnd14PSW pWnd14PSW, UWORD message, int param1, int param2)
{
  int squareIndex; // eax
  UBYTE planetItemIndex; // cl
  P_WndA2 v7; // eax
  int v8; // esi
  T_Ship *ShipAtSquare_sub_35A70; // eax
  T_Ship *v10; // esi
  int v11; // ebx
  int raceIndex; // edx
  int v13; // edi
  int v14; // ebx
  int SquareWithItem_sub_35930; // edx
  int v16; // edi
  int v17; // ebx
  int v18; // esi
  int v19; // ecx
  int v20; // eax
  int v21; // ecx
  int i; // kr04_4
  int v23; // kr08_4
  P_WndA2 v24; // ecx
  int v25; // edi
  int Unknown_00; // ebx
  int v27; // edx
  int v28; // eax
  WORD v29; // bx
  int index; // edx
  P_WndA2 v31; // edi
  char *sub_1CEA8; // esi
  P_WndA2 v33; // edx
  int v34; // ecx
  WORD v35; // bx
  char *v36; // esi
  int v37; // edi
  P_WndA2 v38; // eax
  T_Ship *v39; // eax
  T_Ship *v40; // eax
  MACRO_VFX_BOOL v41; // esi
  char *v42; // ebx
  T_Wnd20HW *Wnd_sub_56DA8; // ecx
  int PlanetsNum_sub_402E0; // edi
  int v45; // eax
  int v46; // eax
  char *v47; // eax
  int v48; // [esp-4h] [ebp-144h]
  char *v49; // [esp-4h] [ebp-144h]
  char s[280]; // [esp+0h] [ebp-140h] BYREF
  int param1a; // [esp+118h] [ebp-28h]
  int v52[2]; // [esp+11Ch] [ebp-24h] BYREF
  int param2a; // [esp+124h] [ebp-1Ch]
  int v54; // [esp+128h] [ebp-18h]
  int v55; // [esp+12Ch] [ebp-14h]
  P_WndA2 a1; // [esp+130h] [ebp-10h]
  int v57; // [esp+134h] [ebp-Ch]
  T_Type20 v58; // [esp+138h] [ebp-8h]

  a1 = &pWnd14PSW->a;
  v58.message = message;
  param1a = param1;
  param2a = param2;
  squareIndex = pWnd14PSW->squareIndex;
  planetItemIndex = 0xFF;
  if ( (unsigned __int16)squareIndex != 0xFFFF )
  {
    planetItemIndex = V_Game.pCurPlanet->pSquares[squareIndex].planetItemIndex;
  }
  if ( v58.message < 0x33u )
  {
    if ( v58.message >= 4u )
    {
      if ( v58.message > 5u )
      {
        if ( v58.message >= 7u )
        {
          if ( v58.message <= 7u )
          {
            if ( a1->Unknown_39 && a1->Unknown_35 && a1->_mouseFocus )
            {
              a1->pProcs->proc5(a1, 0);
            }
            return 0xFFFFFFFF;
          }
          else
          {
            if ( v58.message != 0x32 )
            {
              return Q_WndA2_Proc3_sub_2F424(a1, v58.message, param1a, param2a);
            }
            dword_104684 = param1a;
            LOWORD(a1[1].magic12345678) = param2a;
            return 0;
          }
        }
        if ( a1->Unknown_39 && a1->Unknown_35 && a1->_mouseFocus )
        {
          a1->pProcs->proc4_draw(a1, 0);
        }
      }
      return 0xFFFFFFFF;
    }
    if ( !v58.message )
    {
      return Q_WndA2_Proc3_sub_2F424(a1, v58.message, param1a, param2a);
    }
    if ( v58.message <= 1u )
    {
      v7 = a1;
      a1->Unknown_39 = 0xFFFFFFFF;
      v8 = dword_104684;
      v7->Unknown_35 = 0xFFFFFFFF;
      if ( v8 == 3 )
      {
        v54 = 0;
        if ( planetItemIndex == 0xFF )
        {
          v19 = 0;
          while ( (_BYTE)v19 == 5 || Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, v19, a1[1].magic12345678) == FALSE )
          {
            if ( ++v19 >= 0x27 )
            {
              goto LABEL_37;
            }
          }
          v20 = v54 + 1;
          *(_DWORD *)&s[4 * v20 + 0xC4] = 0x36;
          v54 = v20;
        }
        else
        {
          if ( planetItemIndex == 0x17 )
          {
            LOWORD(v7) = a1[1].magic12345678;
            if ( (V_Game.pCurPlanet->pSquares[(_DWORD)v7].flags & 1) != 0 )
            {
              ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a1[1].magic12345678);
              v10 = ShipAtSquare_sub_35A70;
              if ( !ShipAtSquare_sub_35A70 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\psqwin.cpp", 0x79);
              }
              if ( Q_Ship_FindGizmoHullCellIndex_sub_4937C(ShipAtSquare_sub_35A70, 0x47u) != 0xFFFFFFFF
                && V_Game.pCurPlanet->raceIndex == 0xFF )
              {
                v11 = v54 + 1;
                *(_DWORD *)&s[4 * v54 + 0xC8] = 0x34;
                v54 = v11;
              }
              if ( Q_Ship_FindGizmoHullCellIndex_sub_4937C(v10, 0x49u) != 0xFFFFFFFF )
              {
                raceIndex = V_Game.pCurPlanet->raceIndex;
                if ( raceIndex != 0xFF && (_BYTE)raceIndex != V_PlayerRaceIndex )
                {
                  v13 = v54 + 1;
                  *(_DWORD *)&s[4 * v54 + 0xC8] = 0x39;
                  v54 = v13;
                }
              }
              *(_DWORD *)&s[4 * v54 + 0xC8] = 0x37;
              v14 = v54;
              SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(V_Game.pCurPlanet, 0x18u);
              v54 = v14 + 1;
              if ( (unsigned __int16)SquareWithItem_sub_35930 != 0xFFFF
                && (V_Game.pCurPlanet->pSquares[SquareWithItem_sub_35930].flags & 1) != 0
                && V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
              {
                v16 = v54 + 1;
                *(_DWORD *)&s[4 * v54 + 0xC8] = 0x38;
                v54 = v16;
              }
            }
          }
          if ( planetItemIndex != 5 )
          {
            v17 = v54 + 1;
            *(_DWORD *)&s[4 * v54 + 0xC8] = 0x35;
            v54 = v17;
          }
          if ( Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, ASCEND_PI_35_AUTOMATION, a1[1].magic12345678) )
          {
            v18 = v54 + 1;
            *(_DWORD *)&s[4 * v54 + 0xC8] = 0x3A;
            v54 = v18;
          }
        }
LABEL_37:
        v58.Unknown_00 = 0xA0;
        v21 = v54 + 1;
        *(_DWORD *)&s[4 * v54 + 0xC8] = 0x33;
        v54 = v21;
        if ( v21 > 0 )
        {
          v55 = v21;
          v57 = 0;
          v23 = v21;
          v52[1] = 4 * v21;
          for ( i = 0; i < v23; ++i )
          {
            v24 = (*a1->children)[i];
            strcpy(v24->name, *(const char **)&V_PlanetCfg.offsets.sizes[4].column[4 * *(_DWORD *)&s[4 * i + 0xC8] + 8]);
            v25 = v55;
            v24->sendMessage = *(_WORD *)&s[4 * i + 0xC8];
            Unknown_00 = v58.Unknown_00;
            v27 = 0x1DF - v58.Unknown_00;
            v24->pane.x0 = v58.Unknown_00;
            v24->pane.y0 = 0x151;
            v24->pane.y1 = 0x16F;
            v58.Unknown_00 = v27 / v25 + Unknown_00;
            if ( v58.Unknown_00 > 0x1DF )
            {
              v58.Unknown_00 = 0x1DF;
            }
            v28 = v58.Unknown_00;
            v29 = v58.message;
            v48 = param2a;
            v24->pane.x1 = v58.Unknown_00;
            index = v24->index;
            v58.Unknown_00 = v28 + 1;
            Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, index, v29, param1a, v48);
            --v55;
          }
        }
        if ( v54 == 1 )
        {
          v31 = a1;
          sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);// 30: "OK"
          strcpy((*v31->children)[0]->name, sub_1CEA8);
        }
      }
      else
      {
        v33 = (*v7->children)[0];
        v33->pane.x0 = 0xA0;
        v33->pane.y0 = 0x151;
        v34 = param1a;
        v33->pane.x1 = 0x1DF;
        v35 = v58.message;
        v33->pane.y1 = 0x16F;
        v36 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);// 30: "OK"
        strcpy(v33->name, v36);
        v37 = param2a;
        v33->sendMessage = 0x33;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v33->index, v35, v34, v37);
      }
      a1->pProcs->proc4_draw(a1, 0);
      return 0;
    }
    else
    {
      if ( v58.message != 2 )
      {
        return Q_WndA2_Proc3_sub_2F424(a1, v58.message, param1a, param2a);
      }
      Q_WndA2_CallChildrenProc3_sub_2D258(a1, 2u, param1a, param2a);
      v38 = a1;
      a1->Unknown_39 = 0;
      v38->Unknown_35 = 0;
      if ( WinMgr._wndIndex == a1->index )
      {
        WinMgr._wndIndex = 0xFFFFFFFF;
      }
      Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, a1->index, 0xFFFF);
      Q_WinMgr_sub_564C0(&WinMgr, a1->index, 0xFFFFFFFF);
      return 0;
    }
  }
  else
  {
    if ( v58.message <= 0x33u )
    {
LABEL_76:
      Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x32, 0xA, 0);
      return 0;
    }
    if ( v58.message < 0x37u )
    {
      if ( v58.message < 0x35u )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x32, 0xC, 0);
        return 0;
      }
      else if ( v58.message <= 0x35u )
      {
        if ( planetItemIndex == 0x17 )
        {
          v39 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a1[1].magic12345678);
          Q_Ship_RemoveFromTheGame_sub_49940(v39);
        }
        Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, a1[1].magic12345678, 0xFFu, 1u);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x32, 0xA, 0);
        return 0;
      }
      else
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x32, 0xB, 0);
        return 0;
      }
    }
    else
    {
      if ( v58.message <= 0x37u )
      {
        v40 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a1[1].magic12345678);
        Q_Planet_LaunchShip_sub_35C38(V_Game.pCurPlanet, v40);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x32, 0xA, 0);
        return 0;
      }
      if ( v58.message < 0x39u )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x32, 0xA, 0);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x34, LOWORD(a1[1].magic12345678), 1);
        return 0;
      }
      if ( v58.message > 0x39u )
      {
        if ( v58.message != 0x3A )
        {
          return Q_WndA2_Proc3_sub_2F424(a1, v58.message, param1a, param2a);
        }
        Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, a1[1].magic12345678, 0x23u, 2u);
        goto LABEL_76;
      }
      v41 = Q_Planet_TryInvade_sub_36CD4(V_Game.pCurPlanet, a1[1].magic12345678, v52);
      v42 = "invadefailure";
      Wnd_sub_56DA8 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "HELPWINDOW", 0);
      if ( v41 == 0xFFFFFFFF )
      {
        v42 = "invadesuccess";
      }
      PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[V_PlayerRaceIndex]);
      Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, "help.txt", v42);
      if ( PlanetsNum_sub_402E0 == 1 )
      {
        v45 = 0x20;                                    // 32: "y"
      }
      else
      {
        v45 = 0x21;                                    // 33: "ies"
      }
      v49 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v45);
      if ( v52[0] == 1 )
      {
        v46 = 0x1C;                                    // 28: ""
      }
      else
      {
        v46 = 0x1D;                                    // 29: "s"
      }
      v47 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v46);
      sprintf(s, Wnd_sub_56DA8->helpItems[0].pText, V_Game.pCurPlanet->name, v52[0], v47, PlanetsNum_sub_402E0, v49);
      strcpy(Wnd_sub_56DA8->helpItems[0].pText, s);
      Wnd_sub_56DA8->helpItems[1].x0 = 0x1C;
      Wnd_sub_56DA8->helpItems[1].y0 = 0x49;
      Wnd_sub_56DA8->helpItems[2].x0 = 0x1D;
      Wnd_sub_56DA8->helpItems[2].y0 = V_Game.pCurPlanet->size + 5 * V_Game.pCurPlanet->type;
      Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->parentIndex, 0x32, 0xA, 0);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, 0, 0);
      return 0;
    }
  }
}
/* Orphan comments:
30: "OK"
*/
// 104684: using guessed type int dword_104684;

//----- (0003A6BC) --------------------------------------------------------
void __fastcall Q_Wnd14PSW_Proc4_sub_3A6BC(P_Wnd14PSW pWnd14PSW)
{
  PANE *p_pane; // esi
  void *helpShapeTable; // eax
  LONG x0; // eax
  char *sub_1CEA8; // eax
  int raceIndex; // esi
  int v6; // edx
  int v7; // ebx
  char *v8; // eax
  int v9; // edx
  UBYTE planetItemIndex; // al
  UWORD industry; // cx
  UWORD buildingProgress; // si
  UWORD ItemCost_sub_3583C; // ax
  int v14; // eax
  UWORD population; // dx
  UWORD maximumPopulation; // bx
  int magic12345678_low; // eax
  unsigned __int16 v18; // bx
  UBYTE color; // al
  P_Ship ShipAtSquare_sub_35A70; // eax
  char *v21; // eax
  const char *v22; // ebx
  char *v23; // eax
  unsigned __int16 magic12345678; // dx
  UWORD v25; // cx
  UWORD v26; // si
  UWORD v27; // ax
  int v28; // eax
  int v29; // edx
  char *v30; // esi
  int v31; // eax
  char *v32; // eax
  char *v33; // esi
  char *v34; // eax
  char *v35; // esi
  char *v36; // esi
  char *v37; // esi
  char *v38; // eax
  char *v39; // eax
  char *v40; // esi
  char *v41; // eax
  char *v42; // eax
  char *v43; // ecx
  char *v44; // eax
  int v45; // eax
  char *v46; // eax
  T_Tech *v47; // [esp-10h] [ebp-1AAh]
  WORD v48; // [esp-Ch] [ebp-1A6h]
  char *v49; // [esp-Ch] [ebp-1A6h]
  char *v50; // [esp-Ch] [ebp-1A6h]
  char *v51; // [esp-8h] [ebp-1A2h]
  char *v52; // [esp-8h] [ebp-1A2h]
  int v53; // [esp-8h] [ebp-1A2h]
  char *v54; // [esp-8h] [ebp-1A2h]
  int v55; // [esp-8h] [ebp-1A2h]
  char *v56; // [esp-4h] [ebp-19Eh]
  char *v57; // [esp-4h] [ebp-19Eh]
  char *v58; // [esp-4h] [ebp-19Eh]
  char *v59; // [esp-4h] [ebp-19Eh]
  char *v60; // [esp-4h] [ebp-19Eh]
  int v61; // [esp-4h] [ebp-19Eh]
  int v62; // [esp-4h] [ebp-19Eh]
  char *v63; // [esp-4h] [ebp-19Eh]
  char v64[152]; // [esp+0h] [ebp-19Ah] BYREF
  char v65[100]; // [esp+98h] [ebp-102h] BYREF
  char v66[100]; // [esp+FCh] [ebp-9Eh] BYREF
  char s[52]; // [esp+160h] [ebp-3Ah] BYREF
  char v68[52]; // [esp+194h] [ebp-6h] BYREF
  PANE pane; // [esp+1C8h] [ebp+2Eh]
  char v70[20]; // [esp+1DCh] [ebp+42h] BYREF
  char *v71; // [esp+1F0h] [ebp+56h]
  T_Tech *name; // [esp+1F4h] [ebp+5Ah]
  T_Square *v73; // [esp+1F8h] [ebp+5Eh]
  char *format; // [esp+1FCh] [ebp+62h]
  char *v75; // [esp+200h] [ebp+66h]
  char *v76; // [esp+204h] [ebp+6Ah]
  int v77; // [esp+208h] [ebp+6Eh]
  char *v78; // [esp+20Ch] [ebp+72h]
  P_WndA2 result; // [esp+210h] [ebp+76h]
  int TurnsToComplete_sub_46C20; // [esp+214h] [ebp+7Ah]
  char *v81; // [esp+218h] [ebp+7Eh]

  result = &pWnd14PSW->a;
  p_pane = &pWnd14PSW->a.pane;
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pWnd14PSW->a.pane);
  VFX_pane_wipe(p_pane, 0xF2);
  helpShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x25]);// 37: data\help.shp
  v77 = 0;
  VFX_shape_draw(p_pane, helpShapeTable, 0, 0, 0);
  pane = result->pane;
  pane.x0 = result->pane.x0 + 0xA;
  pane.y0 = result->pane.y0 + 0xA;
  v78 = 0;
  x0 = result->pane.x0;
  name = 0;
  v76 = 0;
  pane.x1 = x0 + 0x145;
  format = 0;
  TurnsToComplete_sub_46C20 = 0xFFFF;
  pane.y1 = result->pane.y0 + 0xCF;
  WinMgr.LargeFont.pane = pane;
  WinMgr.LargeFont.backColor = 0xFF;
  v81 = 0;
  switch ( dword_104684 )
  {
    case 0:
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x41);// 65: "Research"
      v78 = sub_1CEA8;
      LOWORD(sub_1CEA8) = V_Game.pCurPlanet->research;
      raceIndex = V_Game.pCurPlanet->raceIndex;
      v81 = sub_1CEA8;
      v6 = V_Research.current.project[raceIndex];
      if ( v6 != 0xFFFF )
      {
        v77 = 0xFFFFFFFF;
        name = &V_Research.techs[v6];
        v7 = sub_469F0(&V_Research, raceIndex);
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(
                                      V_Research.techs[v6].cost,
                                      (unsigned __int16)word_106FB4[V_Game.pCurPlanet->raceIndex],
                                      v7);
      }
      v76 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x42);  // 66: "be discovered"
      format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x43);// 67: "No progress is being made on %s."
      break;
    case 1:
      v8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x44);   // 68: "Industry"
      v78 = v8;
      LOWORD(v8) = V_Game.pCurPlanet->industry;
      LOWORD(v9) = V_Game.pCurPlanet->_squareIndex;
      v81 = v8;
      planetItemIndex = 0xFF;
      if ( (unsigned __int16)v9 != 0xFFFF )
      {
        HIWORD(v9) = 0;
        planetItemIndex = V_Game.pCurPlanet->pSquares[v9].planetItemIndex;
      }
      if ( planetItemIndex != 0xFF )
      {
        name = (T_Tech *)V_PlanetItems.item[planetItemIndex].name;
        v77 = 0xFFFFFFFF;
        industry = V_Game.pCurPlanet->industry;
        buildingProgress = V_Game.pCurPlanet->buildingProgress;
        ItemCost_sub_3583C = Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, v9, 0xFFu);
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(ItemCost_sub_3583C, buildingProgress, industry);
      }
      v76 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x45);  // 69: "be completed"
      format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x43);// 67: "No progress is being made on %s."
      break;
    case 2:
      v78 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x46);  // 70: "Prosperity"
      HIWORD(v14) = HIWORD(V_Game.pCurPlanet);
      LOWORD(v14) = V_Game.pCurPlanet->prosperity;
      v81 = (char *)v14;
      name = (T_Tech *)Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x47);// 71: "Population"
      v76 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x48);  // 72: "grow"
      population = V_Game.pCurPlanet->population;
      maximumPopulation = V_Game.pCurPlanet->maximumPopulation;
      v77 = 0xFFFFFFFF;
      if ( population >= maximumPopulation )
      {
        format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4A);// 74: "%s has no more room to grow."
      }
      else
      {
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(
                                      V_PopGrowthAmount50,
                                      (unsigned __int16)V_Game.pCurPlanet->Unknown_4E,
                                      V_Game.pCurPlanet->prosperity);
        if ( (unsigned __int16)TurnsToComplete_sub_46C20 == 0xFFFF )
        {
          format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x49);// 73: "%s is not growing."
        }
      }
      break;
    case 3:
      magic12345678_low = LOWORD(result[1].magic12345678);
      if ( (unsigned __int16)magic12345678_low != 0xFFFF )
      {
        HIBYTE(v18) = 0;
        v73 = &V_Game.pCurPlanet->pSquares[magic12345678_low];
        LOBYTE(v18) = v73->planetItemIndex;
        v75 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4B);// 75: "White"
        color = v73->color;
        v71 = 0;
        switch ( color & 7 )
        {
          case ASCEND_SQUARE_COLOR_BLACK:
            v75 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4C);// 76: "Black"
            break;
          case ASCEND_SQUARE_COLOR_RED:
            v75 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4D);// 77: "Red"
            v71 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4E);// 78: "industry"
            break;
          case ASCEND_SQUARE_COLOR_GREEN:
            v75 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4F);// 79: "Green"
            v71 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x50);// 80: "prosperity"
            break;
          case ASCEND_SQUARE_COLOR_BLUE:
            v75 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x51);// 81: "Blue"
            v71 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x52);// 82: "research"
            break;
          default:
            break;
        }
        if ( LOWORD(result[1].magic12345678) >= V_Game.pCurPlanet->surfaceSquaresNum )
        {
          v75 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x53);// 83: "Orbital"
        }
        if ( v18 == 0xFF )
        {
          if ( (v73->color & ASCEND_SQUARE_XENO_RUINS) != 0 && V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
          {
            v33 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x58);// 88: "Xenoarcheological Ruins"
            strcpy(v66, v33);
          }
          else
          {
            v58 = v75;
            v34 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x59);// 89: "%s Square"
            sprintf(v66, v34, v58);
          }
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x14, v66, 2u, 0xFFFF, 0xFFFF, 0);
          if ( (v73->color & ASCEND_SQUARE_XENO_RUINS) == 0 )
          {
            if ( LOWORD(result[1].magic12345678) < V_Game.pCurPlanet->surfaceSquaresNum )
            {
              if ( (v73->color & 7) == ASCEND_SQUARE_COLOR_WHITE )
              {
                v36 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5B);// 91: "White squares are ordinary habitable surface squares."
                strcpy(v64, v36);
              }
              else if ( (v73->color & 7) != 0 )
              {
                v59 = v71;
                v51 = v75;
                v38 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5D);// 93: "%s squares increase the effectiveness of %s-producing structures."
                sprintf(v64, v38, v51, v59);
              }
              else
              {
                v37 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5C);// 92: "Black squares are uninhabitable.  Most structures cannot be built on them."
                strcpy(v64, v37);
              }
            }
            else
            {
              v35 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5A);// 90: "Orbital squares are used for building orbital structures such as 
                                                       // Shipyards and Ships."
              strcpy(v64, v35);
            }
            Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0x50, v64, 2u, 0xFFFF, 0xFFFF, 0);
          }
        }
        else
        {
          strcpy(s, V_PlanetItems.item[v18].name);
          if ( v18 == 0x17 )
          {
            ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, result[1].magic12345678);
            sprintf(s, "%s \"%s\"", V_PlanetItems.item[0x17].name, ShipAtSquare_sub_35A70->name);
          }
          if ( (v73->flags & 2) != 0 )
          {
            v21 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x54);// 84: "Automated "
          }
          else
          {
            v21 = (char *)&unk_920AA;
          }
          v22 = v21;
          qmemcpy(v68, &unk_968A8, 0x32u);
          if ( LOWORD(result[1].magic12345678) < V_Game.pCurPlanet->surfaceSquaresNum )
          {
            v56 = v75;
            v23 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x55);// 85: " on %s Square"
            sprintf(v68, v23, v56);
          }
          sprintf(v65, "%s%s%s", v22, s, v68);
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xF, v65, 2u, 0xFFFF, 0xFFFF, 0);
          magic12345678 = result[1].magic12345678;
          if ( !V_Game.pCurPlanet->pSquares[magic12345678].flags )
          {
            v25 = V_Game.pCurPlanet->industry;
            v26 = V_Game.pCurPlanet->buildingProgress;
            v27 = Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, magic12345678, 0xFFu);
            v28 = Q_GetTurnsToComplete_sub_46C20(v27, v26, v25);
            v29 = v28;
            if ( v28 == 0xFFFF )
            {
              v30 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x56);// 86: "No progress"
              strcpy(v65, v30);
            }
            else
            {
              if ( v28 == 1 )
              {
                v31 = 0x1C;                            // 28: ""
              }
              else
              {
                v31 = 0x1D;                            // 29: "s"
              }
              v57 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v31);
              v32 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x57);// 87: "%d day%s until completion"
              sprintf(v65, v32, v29, v57);
            }
            Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x32, v65, 2u, 0xFFFF, 0xFFFF, 0);
          }
        }
      }
      break;
    case 4:
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xF, V_Game.pCurPlanet->name, 2u, 0xFFFF, 0xFFFF, 0);
      v60 = PlanetTypeTexts[V_Game.pCurPlanet->type];
      v52 = PlanetSizeTexts[V_Game.pCurPlanet->size];
      v39 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5E);  // 94: "%s %s Planet"
      sprintf(v66, v39, v52, v60);
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x3C, v66, 2u, 0xFFFF, 0xFFFF, 0);
      v40 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5F);  // 95: "No One"
      strcpy(v70, v40);
      if ( V_Game.pCurPlanet->raceIndex != 0xFF )
      {
        strcpy(v70, V_SpecNames[V_Game.races[V_Game.pCurPlanet->raceIndex].species]);
      }
      v53 = 4 * V_Game.races[V_Game.pCurPlanet->raceIndex].colorSet + 0x13;
      v41 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x60);  // 96: "Owned by |%d|%s"
      sprintf(v66, v41, v53, v70);
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x5A, v66, 2u, 0xFFFF, 0xFFFF, 0);
      v61 = V_Game.pCurPlanet->maximumPopulation;
      v42 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x61);  // 97: "Maximum Population  %d"
      sprintf(v66, v42, v61);
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x78, v66, 2u, 0xFFFF, 0xFFFF, 0);
      if ( V_Game.pCurPlanet->raceIndex == V_PlayerRaceIndex && V_Game.pCurPlanet->Unknown_5A == 0xFFFFFFFF )
      {
        v48 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
        v43 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x62);// 98: "Self Managed"
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x96, v43, 2u, v48, 0xFFFF, 0);
      }
      break;
    default:
      break;
  }
  if ( v78 )
  {
    v62 = (unsigned __int16)v81;
    v54 = v78;
    v49 = V_Game.pCurPlanet->name;
    v44 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x63);    // 99: "%s %s: %d per day"
    sprintf(v66, v44, v49, v54, v62);
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xF, v66, 2u, 0xFFFF, 0xFFFF, 0);
    if ( v77 )
    {
      if ( (unsigned __int16)TurnsToComplete_sub_46C20 == 0xFFFF )
      {
        sprintf(v66, format, name);
      }
      else
      {
        if ( (unsigned __int16)TurnsToComplete_sub_46C20 == 1 )
        {
          v45 = 0x1C;                                  // 28: ""
        }
        else
        {
          v45 = 0x1D;                                  // 29: "s"
        }
        v63 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v45);
        v55 = (unsigned __int16)TurnsToComplete_sub_46C20;
        v50 = v76;
        v47 = name;
        v46 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x64);// 100: "%s will %s in %d day%s."
        sprintf(v66, v46, v47, v50, v55, v63);
      }
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x50, v66, 2u, 0xFFFF, 0xFFFF, 0);
    }
  }
  if ( result->childrenNum )
  {
    sub_2D218(result);
  }
}
// 9684C: using guessed type int V_PopGrowthAmount50;
// 104684: using guessed type int dword_104684;
// 106FB4: using guessed type __int16 word_106FB4[7];
// 3A6BC: using guessed type char s[52];
// 3A6BC: using guessed type char var_184[100];
// 3A6BC: using guessed type char var_120[100];
// 3A6BC: using guessed type char var_21C[152];
// 3A6BC: using guessed type _BYTE var_40[20];

//----- (0003B120) --------------------------------------------------------
void __fastcall Q_RaceCtor_sub_3B120(P_Race pRace)
{
  char *sub_1CEA8; // eax
  int i; // kr04_4

  for ( i = 0; i != 0x15; ++i )
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(i + 0x65);
    strcpy(V_SpecNames[i], sub_1CEA8);
  }
  pRace->species = 0xFF;
  pRace->index = 0xFF;
  pRace->homeStar = 0;
  Q_Race_Init_sub_3B188(pRace);
}
/* Orphan comments:
101: "Minions"
*/

//----- (0003B188) --------------------------------------------------------
void __fastcall Q_Race_Init_sub_3B188(P_Race pRace)
{
  int i; // kr04_4

  pRace->Unknown_1AA = 18;
  pRace->Unknown_1AC = 22;
  pRace->Unknown_1AE = 0;
  pRace->Unknown_19B = 0;
  pRace->bioMaxpositve = 0;
  pRace->bioMaxnegative = 0;
  pRace->Unknown_1E9 = 14;
  pRace->Unknown_1EA = 0;
  for ( i = 0; i != 7; ++i )
  {
    pRace->treaties[i] = 0;
    pRace->attitudes[i] = 0;
  }
  pRace->extinct = FALSE;
}

//----- (0003B1FC) --------------------------------------------------------
void __fastcall Q_Race_InitAndSetSpecies_sub_3B1FC(P_Race pRace, UBYTE raceIndex, WORD species)
{
  Q_Race_Init_sub_3B188(pRace);
  pRace->index = raceIndex;
  if ( pRace->species != species )
  {
    // If changing species, the reload DIP values
    pRace->species = species;
    Q_Race_LoadDIPFile_sub_43C80(pRace);
  }
}

//----- (0003B220) --------------------------------------------------------
void __fastcall sub_3B220(P_Race pRace)
{
  P_Ship v2; // esi
  int Ships_sub_40224; // eax
  int v4; // ebx
  int eventId; // edx
  int j; // kr04_4
  UBYTE v7; // dl
  int v8; // ecx
  UBYTE index; // al
  __int16 i; // di
  P_Ship raceShips[107]; // [esp+0h] [ebp-1CCh] BYREF
  int v12; // [esp+1ACh] [ebp-20h]
  int MoreAllowedShips_sub_3EFE0; // [esp+1B0h] [ebp-1Ch]

  if ( pRace->extinct != TRUE )
  {
    MoreAllowedShips_sub_3EFE0 = Q_Race_GetMoreAllowedShips_sub_3EFE0(pRace);
    if ( MoreAllowedShips_sub_3EFE0 < 0 )
    {
      v12 = Q_Race_GetShips_sub_40224(pRace, raceShips, 0) - 1;
      for ( i = 0; i < -MoreAllowedShips_sub_3EFE0; ++i )
      {
        v2 = raceShips[v12 - i];
        if ( pRace->index == V_PlayerRaceIndex )
        {
          Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_SCRAPNEWESTSHIP, v2->hullSize, 0);
        }
        Q_Ship_RemoveFromTheGame_sub_49940(v2);
      }
    }
    Ships_sub_40224 = Q_Race_GetShips_sub_40224(pRace, raceShips, 0);
    sub_3C1C0(pRace, raceShips, Ships_sub_40224);
    v4 = Q_Race_GetShips_sub_40224(pRace, raceShips, 0);
    if ( !v4 && !Q_Race_GetPlanetsNum_sub_402E0(pRace) )
    {
      // No more ships and no more planets
      eventId = ASCEND_EP_SPECIESEXTINCT;
      LOBYTE(v4) = pRace->index;
      pRace->extinct = TRUE;
ADD_GAME_EVENT_AND_EXIT:
      Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, eventId, v4, 0);
      return;
    }
    if ( v4 > 0 )
    {
      for ( j = 0; j < v4; ++j )
      {
        Q_Ship_Turn_sub_4A6AC(raceShips[j]);
      }
    }
    V_AllTechsKnownCache = FALSE;
    sub_3B5B8(pRace);
    sub_405F4(pRace);
    if ( (pRace->homeStar->planetsRacesBits & 0x80) != 0 )
    {
      v7 = V_PlayerRaceIndex;
      v8 = pRace->daysAfterAbilityUse + 1;
      index = pRace->index;
      pRace->daysAfterAbilityUse = v8;
      if ( index == v7 && v8 && V_AbilityDays[pRace->ability] == v8 )
      {
        v4 = FALSE;
        eventId = ASCEND_EP_ABILITYPTS;
        goto ADD_GAME_EVENT_AND_EXIT;
      }
    }
  }
}
// 10509C: using guessed type int V_AllTechsKnownCache;

//----- (0003B38C) --------------------------------------------------------
char __fastcall Q_NC_sub_3B38C(P_Race pRace)
{
  P_Race v1; // esi
  int v2; // ecx
  int v3; // kr04_4
  int v4; // ebp
  __int16 i; // di
  T_Race *v6; // eax
  P_Ship v7; // eax
  P_Ship v8; // eax
  int raceIndex; // ecx
  __int16 k; // di
  int v12[148]; // [esp+0h] [ebp-5E8h] BYREF
  P_Ship v13[221]; // [esp+250h] [ebp-398h] BYREF
  int Ships_sub_40224; // [esp+5C4h] [ebp-24h]
  T_Planet *pPlanet; // [esp+5C8h] [ebp-20h]
  __int16 j; // [esp+5CCh] [ebp-1Ch]

  v1 = pRace;
  LOBYTE(pRace) = pRace->index;
  if ( (_BYTE)pRace == V_PlayerRaceIndex && V_SelfPlayMode != 0xFFFFFFFF )
  {
    v2 = 0;
    LOWORD(pRace) = 0;
    if ( V_Game.racesNum > 0 )
    {
      v3 = 0;
      do
      {
        if ( (__int16)pRace != v1->index && !v1->treaties[(__int16)pRace] )
        {
          ++v2;
          v13[v3++ + 0xD6] = (P_Ship)(__int16)pRace;
        }
        LOWORD(pRace) = (_WORD)pRace + 1;
      }
      while ( (__int16)pRace < V_Game.racesNum );
    }
    if ( v2 )
    {
      memset(v12, 0, sizeof(v12));
      v4 = 0;
      for ( i = 0; i < v2; ++i )
      {
        v6 = &V_Game.races[(_DWORD)v13[i + 0xD6]];
        v4 += Q_Race_GetShips_sub_40224(v6, &v13[v4 + 0x6B], 0);
      }
      Ships_sub_40224 = Q_Race_GetShips_sub_40224(v1, v13, 0);
      for ( j = 0; ; ++j )
      {
        LOBYTE(pRace) = j;
        if ( j >= Ships_sub_40224 )
        {
          break;
        }
        v7 = v13[j];
        if ( v7->locationType == 5 )
        {
          pPlanet = v7->pLocation.pPlanet;
          if ( !v12[((char *)pPlanet - (char *)V_Game.lanes) / 0x27] )
          {
            v12[((char *)pPlanet - (char *)V_Game.lanes) / 0x27] = 0xFFFFFFFF;
            for ( k = 0; k < v4; ++k )
            {
              v8 = v13[k + 0x6B];
              if ( pPlanet == v8->pLocation.pPlanet )
              {
                raceIndex = v8->raceIndex;
                if ( !v1->treaties[raceIndex] )
                {
                  v1->treaties[raceIndex] = 1;
                  v1->attitudes[raceIndex] = v1->startAttitude;
                  V_Game.races[raceIndex].treaties[v1->index] = 1;
                  V_Game.races[raceIndex].attitudes[v1->index] = V_Game.races[raceIndex].startAttitude;
                  Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, 0x17, (int)v13[j], raceIndex);
                }
              }
            }
          }
        }
      }
    }
  }
  return (char)pRace;
}
// 3B38C: using guessed type int var_5E8[148];

//----- (0003B56C) --------------------------------------------------------
int __fastcall sub_3B56C(P_Race pRace, P_Location pLocation)
{
  int ShipsAtLocation_sub_1D794; // edi
  __int16 i; // dx
  int result; // eax
  P_Ship v6; // eax
  P_Ship pShip[107]; // [esp+0h] [ebp-1ACh] BYREF

  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(pLocation, pShip);
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= ShipsAtLocation_sub_1D794 )
    {
      break;
    }
    v6 = pShip[i];
    if ( v6 )
    {
      if ( v6->raceIndex == pRace->index )
      {
        Q_Ship_RecalculateTurnResources_sub_4A5B8(v6);
      }
    }
  }
  return result;
}

//----- (0003B5B8) --------------------------------------------------------
void __fastcall sub_3B5B8(T_Race *a1)
{
  int v1; // ebx
  int v2; // edi
  __int16 i; // bx
  WORD v4; // dx
  int v5; // kr04_4
  int v6; // ecx
  int v7; // eax
  int v8; // ecx
  int v9; // eax
  int v10; // ecx
  int v11; // eax
  int v12; // ebp
  int v13; // ecx
  int v14; // eax
  int v15; // ebx
  int v16; // eax
  double v17; // st7
  double v18; // st7
  double v19; // st7
  __int16 j; // si
  P_Ship v21; // ecx
  __int16 v22; // dx
  int v23; // eax
  int v24; // eax
  __int16 v25; // di
  int v26; // edx
  WORD v27; // si
  int v28; // kr0C_4
  int v29; // kr14_4
  int v30; // eax
  int v31; // eax
  int v32; // eax
  P_Planet v33; // kr18_4
  int v34; // kr1C_4
  int v35; // ebp
  int v36; // ecx
  __int16 v37; // si
  int starIndex; // ecx
  __int16 v39; // si
  signed int v40; // ebp
  T_Planet *v41; // ecx
  int v42; // edi
  int v43; // edx
  WORD v44; // bx
  T_Planet *v45; // edx
  WORD k; // bx
  P_Ship pShips[107]; // [esp+0h] [ebp-214h] BYREF
  int v48; // [esp+1ACh] [ebp-68h]
  int v49; // [esp+1B0h] [ebp-64h]
  float v50; // [esp+1B4h] [ebp-60h]
  int Ships_sub_40224; // [esp+1B8h] [ebp-5Ch]
  int v52; // [esp+1BCh] [ebp-58h]
  int v53; // [esp+1C0h] [ebp-54h]
  int v54; // [esp+1C4h] [ebp-50h]
  P_Race pRace; // [esp+1C8h] [ebp-4Ch]
  float v56; // [esp+1CCh] [ebp-48h]
  int v57; // [esp+1D0h] [ebp-44h]
  int v58; // [esp+1D4h] [ebp-40h]
  P_Planet pPlanet; // [esp+1D8h] [ebp-3Ch]
  int v60; // [esp+1DCh] [ebp-38h]
  float v61; // [esp+1E0h] [ebp-34h]
  float v62; // [esp+1E4h] [ebp-30h]
  float v63; // [esp+1E8h] [ebp-2Ch]
  float v64; // [esp+1ECh] [ebp-28h]
  int v65; // [esp+1F0h] [ebp-24h]
  int v66; // [esp+1F4h] [ebp-20h]
  unsigned __int8 EnemyRacesMask_sub_43374; // [esp+1F8h] [ebp-1Ch]

  pRace = a1;
  Ships_sub_40224 = Q_Race_GetShips_sub_40224(a1, pShips, 0);
  if ( pRace->index != V_PlayerRaceIndex || V_SelfPlayMode == 0xFFFFFFFF )
  {
    sub_3C670(pRace);
    v1 = Ships_sub_40224;
    sub_3C968(pRace);
    sub_44080(pRace);
    sub_3C2E8(pRace, pShips, v1);
  }
  if ( Q_Race_HasDiscoveredAllTechs_sub_40590(pRace) != 0xFFFFFFFF
    && (V_PlayerRaceIndex != pRace->index || V_SelfPlayMode || dword_106FC2 == 0xFFFFFFFF)
    && V_Research.current.project[pRace->index] == 0xFFFF )
  {
    sub_3EA7C(pRace);
  }
  if ( V_PlayerRaceIndex != pRace->index || V_SelfPlayMode == 0xFFFFFFFF )
  {
    Q_Race_UseAbility_sub_434E4(pRace, 1);
  }
  v2 = Ships_sub_40224;
  for ( i = 0; i < v2; ++i )
  {
    if ( V_PlayerRaceIndex != pRace->index || V_SelfPlayMode == 0xFFFFFFFF )
    {
      sub_3EBDC(pRace, pShips[i]);
    }
  }
  if ( V_PlayerRaceIndex != pRace->index || V_SelfPlayMode == 0xFFFFFFFF )
  {
    LOWORD(v66) = Q_Race_GetMoreAllowedShips_sub_3EFE0(pRace);
    if ( (__int16)v66 > 0xA )
    {
      LOWORD(v66) = 0xA;
    }
    if ( (__int16)v66 > 0 )
    {
      v63 = 0.0;
      v61 = 0.0;
      v62 = 0.0;
      EnemyRacesMask_sub_43374 = Q_Race_GetEnemyRacesMask_sub_43374(pRace, 0xFFFFFFFF);
      v4 = 0;
      if ( V_Game.starsNum > 0 )
      {
        v5 = 0;
        do
        {
          if ( (V_Game.stars[v5].planetsRacesBits & EnemyRacesMask_sub_43374) != 0 )
          {
            v10 = *((char *)&dword_104F6D + v4 + 3);
            v11 = dword_104BEC[v4];
            v60 = v11;
            if ( v10 > 1 )
            {
              v60 = v11 >> (v10 - 1);
            }
            v12 = v4;
            v13 = *((char *)&dword_104F09 + v4 + 3);
            v14 = dword_104D7C[v12];
            v15 = dword_104BEC[v12];
            v61 = (double)v60 + v61;
            v16 = v15 + v14;
            v60 = v16;
            if ( v13 > 0 )
            {
              v60 = v16 >> v13;
            }
            v63 = (double)v60 + v63;
          }
          else if ( (V_Game.stars[v5].shipsRacesBits & EnemyRacesMask_sub_43374) != 0 )
          {
            v6 = *((char *)&dword_104F09 + v4 + 3);
            v7 = dword_104D7C[v4];
            v54 = v7;
            if ( v6 > 0 )
            {
              v54 = v7 >> v6;
            }
            v63 = (double)v54 + v63;
          }
          else
          {
            if ( *((char *)&dword_104FD1 + v4 + 3) <= 0 )
            {
              v62 = (double)dword_104BEC[v4] + v62;
            }
            v8 = *((char *)&dword_104F09 + v4 + 3);
            v9 = dword_104D7C[v4];
            v53 = v9;
            if ( v8 > 0 )
            {
              v53 = v9 >> v8;
            }
            v63 = (double)v53 + v63;
          }
          ++v4;
          ++v5;
        }
        while ( v4 < V_Game.starsNum );
      }
      v62 = v62 * 0.050000001;
      v17 = v61 * 0.6666666666666666;
      v61 = v17;
      v50 = v17 + v63 + v62;
      if ( v50 <= 0.0 )
      {
        v49 = (__int16)v66 / 3;
        v62 = (float)v49;
        v63 = v62;
        v61 = (double)(__int16)v66 - v62 - v62;
      }
      else
      {
        v18 = (double)(__int16)v66;
        v61 = v61 * v18;
        v63 = v63 * v18;
        v62 = v18 * v62;
        v19 = 1.0 / v50;
        v61 = v61 * v19;
        v63 = v63 * v19;
        v62 = v19 * v62;
      }
      for ( j = 0; j < Ships_sub_40224; ++j )
      {
        v21 = pShips[j];
        if ( !v21 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x22A);
        }
        if ( v21->locationType == 1 )
        {
          if ( v21->hasColonizer && v62 > 0.0 )
          {
            v62 = v62 - 1.0;
          }
          else if ( Q_Ship_HasGizmo_sub_4A534(pShips[j], 0x49) && v61 > 0.0 )
          {
            v61 = v61 - 1.0;
          }
          else if ( v63 > 0.0 )
          {
            v63 = v63 - 1.0;
          }
        }
      }
      v22 = 0;
      while ( 1 )
      {
        v23 = v22;
        if ( v22 >= 0x64 )
        {
          break;
        }
        ++v22;
        dword_1046E8[v23] = 0;
        dword_104878[v23] = 0;
        dword_104A08[v23] = 0;
      }
      v24 = 0;
      if ( (__int16)v66 > 0 )
      {
        v25 = v66;
        do
        {
          v26 = (__int16)v24++;
          dword_104B98[v26] = 0xFFFFFFFF;
        }
        while ( (__int16)v24 < v25 );
      }
      v27 = 0;
      if ( V_Game.starsNum > 0 )
      {
        v28 = 0;
        do
        {
          if ( ((1 << pRace->index) & V_Game.stars[v28].planetsRacesBits) != 0 )
          {
            v29 = 0;
            for ( k = 0; k < V_Game.starsNum; ++v29 )
            {
              if ( ((1 << pRace->index) & V_Game.stars[v29].exploredPathToBits) != 0 )
              {
                v49 = 1 / (Q_Star_GetDistanceToStar_sub_1DA04(&V_Game.stars[v29], &V_Game.stars[v28]) / 25 + 1);
                v64 = (float)v49;
                v56 = v64;
                if ( (V_Game.stars[v28].planetsRacesBits & EnemyRacesMask_sub_43374) != 0 )
                {
                  v32 = *((char *)&dword_104F6D + k + 3);
                  v52 = (int)((double)dword_104BEC[k] * v64);
                  if ( v32 >= 1 )
                  {
                    if ( v32 < 2 )
                    {
                      dword_104A08[v27] += v52 / 2;
                    }
                  }
                  else
                  {
                    dword_104A08[v27] += v52;
                  }
                  if ( *((char *)&dword_104F09 + k + 3) < 1 )
                  {
                    dword_104878[v27] += v52;
                  }
                }
                else if ( (V_Game.stars[v28].shipsRacesBits & EnemyRacesMask_sub_43374) != 0 )
                {
                  v49 = dword_104BEC[k] + dword_104D7C[k];
                  v30 = *((char *)&dword_104F09 + k + 3);
                  v57 = (int)((double)v49 * v64);
                  if ( v30 < 1 )
                  {
                    dword_104878[v27] += v57;
                  }
                }
                else
                {
                  if ( *((char *)&dword_104FD1 + k + 3) < 1 )
                  {
                    dword_1046E8[v27] = (int)((double)dword_104BEC[k] * v64 * 0.050000001 + (double)dword_1046E8[v27]);
                  }
                  v31 = *((char *)&dword_104F09 + k + 3);
                  v48 = (int)((double)dword_104D7C[k] * v56);
                  if ( v31 < 1 )
                  {
                    dword_104878[v27] += v48;
                  }
                }
              }
              ++k;
            }
          }
          ++v27;
          ++v28;
        }
        while ( v27 < V_Game.starsNum );
      }
      pPlanet = V_Game.planets;
      if ( V_Game.planetsNum > 0 )
      {
        v33 = pPlanet;
        v34 = 0;
        LOWORD(v65) = 0;
        do
        {
          if ( v33[v34].buildingPlanetItemIndex == 0xFF
            && Q_Planet_GetSquareWithItem_sub_35930(&v33[v34], 0x16u) != 0xFFFF
            && v33[v34].raceIndex == pRace->index )
          {
            starIndex = v33[v34].starIndex;
            if ( starIndex >= 0x64 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2A1);
            }
            v58 = (dword_104878[starIndex] + dword_1046E8[starIndex] + dword_104A08[starIndex]) / 0xA;
            v35 = 0;
            v36 = dword_104BC0[0];
            v58 *= v33[v34].industry;
            v37 = 0;
            if ( (__int16)v66 > 0 )
            {
              while ( 1 )
              {
                if ( v37 >= 0xA )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2B1);
                }
                if ( dword_104B98[v37] == 0xFFFFFFFF )
                {
                  break;
                }
                if ( v36 > dword_104BC0[v37] )
                {
                  v35 = v37;
                  v36 = dword_104BC0[v37];
                }
                if ( ++v37 >= (__int16)v66 )
                {
                  goto LABEL_96;
                }
              }
              v35 = v37;
            }
LABEL_96:
            if ( v58 > dword_104BC0[v35] || dword_104B98[v35] == 0xFFFFFFFF )
            {
              dword_104B98[v35] = (__int16)v65;
              dword_104BC0[v35] = v58;
            }
          }
          LOWORD(v65) = v65 + 1;
          ++v34;
        }
        while ( (__int16)v65 < V_Game.planetsNum );
      }
      if ( (__int16)v66 > 0 )
      {
        v39 = 0;
        while ( 1 )
        {
          v40 = dword_104B98[v39];
          if ( v40 <= (int)0xFFFFFFFF || V_Game.planetsNum <= v40 )
          {
            goto LABEL_117;
          }
          v41 = &V_Game.planets[v40];
          if ( !v41 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2D9);
          }
          v42 = v41->starIndex;
          if ( v42 >= 0x64 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2DD);
          }
          if ( v62 > 0.0 )
          {
            v43 = dword_1046E8[v42];
            if ( v43 > dword_104878[v42] && v43 > dword_104A08[v42] )
            {
              break;
            }
          }
          if ( v63 > 0.0 && dword_104878[v42] > dword_104A08[v42] )
          {
LABEL_116:
            sub_3CB60(pRace, &V_Game.planets[v40], 1u);
            v63 = v63 - 1.0;
            goto LABEL_117;
          }
          if ( v61 <= 0.0 )
          {
            if ( v62 > 0.0 )
            {
              break;
            }
            if ( v63 > 0.0 )
            {
              goto LABEL_116;
            }
          }
          else
          {
            sub_3CB60(pRace, &V_Game.planets[v40], 2u);
            v61 = v61 - 1.0;
          }
LABEL_117:
          if ( ++v39 >= (__int16)v66 )
          {
            goto LABEL_128;
          }
        }
        sub_3CB60(pRace, &V_Game.planets[v40], 0);
        v62 = v62 - 1.0;
        goto LABEL_117;
      }
    }
  }
LABEL_128:
  if ( V_Game.planetsNum > 0 )
  {
    v44 = 0;
    do
    {
      v45 = &V_Game.planets[v44];
      if ( v45->raceIndex == pRace->index
        && (pRace->index != V_PlayerRaceIndex || v45->Unknown_5A || V_SelfPlayMode)
        && v45->buildingPlanetItemIndex == 0xFF )
      {
        Q_Race_ManagePlanetDevelopment_sub_3D8F0(pRace, v45);
      }
      ++v44;
    }
    while ( v44 < V_Game.planetsNum );
  }
}
// 1046E8: using guessed type int dword_1046E8[100];
// 104878: using guessed type int dword_104878[100];
// 104A08: using guessed type int dword_104A08[100];
// 104B98: using guessed type int dword_104B98[];
// 104BC0: using guessed type int dword_104BC0[9];
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];
// 104F09: using guessed type int dword_104F09;
// 104F6D: using guessed type int dword_104F6D;
// 104FD1: using guessed type int dword_104FD1;
// 106FC2: using guessed type int dword_106FC2;

//----- (0003C12C) --------------------------------------------------------
// Determines if a ship should be considered for an upgrade
MACRO_VFX_BOOL __fastcall Q_Race_ShouldUpgradeShip_sub_3C12C(P_Race pRace, P_Ship pShip)
{
  int availableCells; // ebp
  int false; // esi
  char bestWeapon; // al
  int bestWeaponDamage; // ebx

  availableCells = pShip->hullCellsNum - pShip->gizmosNum;
  false = FALSE;
  bestWeapon = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_WEAPON, pRace->index);
  if ( bestWeapon <= (char)-1u || bestWeapon >= 0x4C )
  {
    bestWeaponDamage = 0;
  }
  else
  {
    bestWeaponDamage = V_Gizmos[bestWeapon].weaponDamage;
  }
  // 1. If more than 1/3 of hull space is available
  // 2. OR if not a colonizer and doesn't have invasion module AND has potential for better weapons
  // 3. OR if ship is at least rank 1 and has significant upgrade potential (15+)
  if ( 3 * availableCells > pShip->hullCellsNum
    || !pShip->hasColonizer
    && Q_Ship_HasGizmo_sub_4A534(pShip, ASCEND_GIZMO_73_INVASION_MODULE) == FALSE
    && bestWeaponDamage > pShip->totalWeaponDamage
    || Q_Ship_GetRank_sub_4A8CC(pShip) >= 1 && Q_Ship_UpgradePotential_sub_4A1CC(pShip, pRace->index) >= 15 )
  {
    return TRUE;
  }
  return false;
}

//----- (0003C1C0) --------------------------------------------------------
char __fastcall sub_3C1C0(P_Race pRace, P_ShipsList shipsArray, int a3)
{
  int moreAllowedShips; // eax
  int raceBitFlag; // ecx
  __int16 v7; // ax
  P_Ship v8; // ecx
  UBYTE locationType; // dl
  BYTE order; // bl
  int i; // edi

  moreAllowedShips = Q_Race_GetMoreAllowedShips_sub_3EFE0(pRace);
  if ( moreAllowedShips < 2 )
  {
    if ( shipsArray )
    {
      if ( a3 > 0 )
      {
        LOBYTE(moreAllowedShips) = pRace->index;
        if ( pRace->index != V_PlayerRaceIndex || V_SelfPlayMode == TRUE )
        {
          raceBitFlag = 1 << pRace->index;
          v7 = 0;
          if ( (raceBitFlag & V_Research.techs[ASCEND_TECH_01_INTERPLANETARY_EXPLORATION].knownToRace) != 0 )
          {
            v7 = 1;
            if ( (raceBitFlag & V_Research.techs[ASCEND_TECH_19_ADVANCED_EXPLORATION].knownToRace) != 0 )
            {
              v7 = 2;
              if ( (raceBitFlag & V_Research.techs[ASCEND_TECH_31_LARGE_SCALE_CONSTRUCTION].knownToRace) != 0 )
              {
                v7 = 3;
              }
            }
          }
          if ( !v7 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x365);
          }
          for ( i = 0; i < a3; ++i )
          {
            if ( !&shipsArray[i] )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x36B);
            }
            v8 = shipsArray[i];
            if ( !v8 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x36F);
            }
            locationType = v8->locationType;
            if ( locationType != ASCEND_LOCATION_TYPE_SHIPYARD && locationType != ASCEND_LOCATION_TYPE_SHIPDOCK )
            {
              order = v8->order;
              if ( order != 2 && order != 5 && order != 6 && Q_Race_ShouldUpgradeShip_sub_3C12C(pRace, shipsArray[i]) )
              {
                Q_Ship_RemoveFromTheGame_sub_49940(v8);
              }
            }
            LOBYTE(moreAllowedShips) = a3;
          }
        }
      }
    }
  }
  return moreAllowedShips;
}
// 3C265: conditional instruction was optimized away because ebx.4>=1

//----- (0003C2E8) --------------------------------------------------------
int __fastcall sub_3C2E8(T_Race *a1, P_ShipsList a2, int a3)
{
  int v3; // kr04_4
  int v4; // ebx
  WORD starsNum; // si
  int v6; // esi
  int v7; // eax
  __int16 i; // si
  P_Location v9; // edi
  signed int starIndex; // ebx
  int pPlanet; // edi
  int result; // eax
  P_Ship v13; // ecx
  UBYTE locationType; // al
  __int16 v17; // [esp+Ch] [ebp-18h]
  char EnemyRacesMask_sub_43374; // [esp+10h] [ebp-14h]

  EnemyRacesMask_sub_43374 = Q_Race_GetEnemyRacesMask_sub_43374(a1, 0xFFFFFFFF);
  sub_1FD90((int)&V_Game, (int)&dword_105035 + 3, a1->index);
  if ( V_Game.starsNum > 0 )
  {
    v3 = 0;
    v17 = 0;
    do
    {
      v6 = v17;
      dword_104BEC[v6] = Q_Star_CalculateStrategicValueForRace_sub_1DA4C(&V_Game.stars[v3], a1->index, a2, a3);
      dword_104D7C[v6] = sub_1DB70(&V_Game.stars[v3], a1->index, a2, a3);
      v7 = *((char *)&dword_105035 + v17 + 3);
      if ( v7 > 0 && (V_Game.stars[v3].shipsRacesBits & (unsigned __int8)EnemyRacesMask_sub_43374) != 0 )
      {
        dword_104D7C[v17] = 2 * dword_104D7C[v17] + 0x12C + 0x96 * v7;
      }
      v4 = v17;
      starsNum = V_Game.starsNum;
      ++v17;
      *((_BYTE *)&dword_104F09 + v4 + 3) = 0;
      *((_BYTE *)&dword_104F6D + v4 + 3) = 0;
      *((_BYTE *)&dword_104FD1 + v4 + 3) = 0;
      ++v3;
    }
    while ( v17 < starsNum );
  }
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= a3 )
    {
      break;
    }
    v13 = a2[i];
    if ( !v13 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3B3);
    }
    locationType = v13->locationType;
    starIndex = 0xFFFFFFFF;
    if ( locationType == 4 )
    {
      pPlanet = (int)v13->pLocation.pPlanet;
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3BB);
      }
LABEL_16:
      starIndex = *(__int16 *)(pPlanet + 4);
      goto LABEL_17;
    }
    if ( locationType == 3 )
    {
      v9.pPlanet = (P_Planet)v13->pLocation;
      if ( !v9.pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3C3);
      }
      starIndex = v9.pPlanet->starIndex;
    }
    else if ( locationType == 5 && v13->order == 1 )
    {
      pPlanet = (int)v13->_orderTargetObject.pPlanet;
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3CC);
      }
      goto LABEL_16;
    }
LABEL_17:
    if ( starIndex > (int)0xFFFFFFFF && starIndex < V_Game.starsNum )
    {
      if ( v13->hasColonizer )
      {
        ++*((_BYTE *)&dword_104FD1 + starIndex + 3);
      }
      else if ( Q_Ship_HasGizmo_sub_4A534(v13, 0x49) )
      {
        ++*((_BYTE *)&dword_104F6D + starIndex + 3);
      }
      else
      {
        ++*((_BYTE *)&dword_104F09 + starIndex + 3);
      }
    }
  }
  return result;
}
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];
// 104F09: using guessed type int dword_104F09;
// 104F6D: using guessed type int dword_104F6D;
// 104FD1: using guessed type int dword_104FD1;
// 105035: using guessed type int dword_105035;

//----- (0003C4EC) --------------------------------------------------------
void __fastcall Q_NC_sub_3C4EC(P_Race pRace, int a2)
{
  __int16 v3; // ax
  int v4; // ebx
  int v5; // eax
  WORD v6; // cx
  int i; // kr04_4
  int v8; // edx
  WORD v9; // bx
  int v10; // kr0C_4
  int v11; // ebx
  __int16 Unknown_19B; // bx
  int v13; // edx

  if ( a2 )
  {
    pRace->Unknown_19B = 0;
    if ( ((1 << pRace->index) & pRace->homeStar->planetsRacesBits) != 0 )
    {
      v4 = 0;
      v5 = 0;
      v6 = 0;
      for ( i = 0; v6 < V_Game.starsNum; ++i )
      {
        if ( ((1 << pRace->index) & V_Game.stars[i].exploredPathToBits) != 0 )
        {
          v8 = dword_104D7C[v6] + dword_104BEC[v6];
          if ( v6 >= a2 )
          {
            if ( v8 > v5 )
            {
              v4 = v8 + v4 - v5;
              v5 = v4 / a2;
            }
          }
          else
          {
            v4 += v8;
          }
        }
        ++v6;
      }
      v9 = 0;
      if ( V_Game.starsNum > 0 )
      {
        v10 = 0;
        do
        {
          if ( ((1 << pRace->index) & V_Game.stars[v10].exploredPathToBits) != 0 && dword_104D7C[v9] + dword_104BEC[v9] >= v5 )
          {
            *(_DWORD *)&pRace->z1[4 * pRace->Unknown_19B] = &V_Game.stars[v10];
          }
          ++v9;
          ++v10;
        }
        while ( v9 < V_Game.starsNum );
      }
      if ( !pRace->Unknown_19B && V_Game.starsNum > 0 )
      {
        v13 = 0;
        do
        {
          v11 = 1 << pRace->index;
          if ( ((unsigned __int8)v11 & V_Game.stars[v13].planetsRacesBits) != 0
            && ((unsigned __int8)v11 & V_Game.stars[v13].shipsRacesBits) == 0 )
          {
            Unknown_19B = pRace->Unknown_19B;
            pRace->Unknown_19B = Unknown_19B + 1;
            *(_DWORD *)&pRace->z1[4 * Unknown_19B] = &V_Game.stars[v13];
          }
          ++v13;
        }
        while ( (__int16)v13 < V_Game.starsNum );
      }
    }
    else
    {
      v3 = pRace->Unknown_19B;
      pRace->Unknown_19B = v3 + 1;
      *(_DWORD *)&pRace->z1[4 * v3] = pRace->homeStar;
    }
  }
}
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];

//----- (0003C670) --------------------------------------------------------
void __fastcall sub_3C670(P_Race pRace)
{
  __int16 v2; // bx
  T_Race *v3; // ecx
  __int16 v4; // si
  int v5; // ecx
  int powerGap; // eax
  int v7; // edx
  bool v8; // zf
  __int16 v9; // kr02_2
  int v10; // edx
  int index; // ecx
  BYTE v12; // dl
  int i; // edx
  int j; // eax
  int v15; // [esp+0h] [ebp-34h]
  __int16 v16; // [esp+4h] [ebp-30h]
  int v17; // [esp+8h] [ebp-2Ch]
  int v18; // [esp+Ch] [ebp-28h]
  unsigned __int8 EnemyRacesMask_sub_43374; // [esp+10h] [ebp-24h]
  unsigned __int8 v20; // [esp+14h] [ebp-20h]
  unsigned __int8 v21; // [esp+18h] [ebp-1Ch]

  if ( V_Game.racesNum > 0 )
  {
    LOWORD(v18) = 0;
    while ( 1 )
    {
      index = pRace->index;
      if ( (__int16)v18 != index && pRace->treaties[(__int16)v18] && V_Game.races[(__int16)v18].extinct != 0xFFFFFFFF )
      {
        break;
      }
LABEL_54:
      LOWORD(v18) = v18 + 1;
      if ( (__int16)v18 >= V_Game.racesNum )
      {
        return;
      }
    }
    v12 = pRace->treaties[(__int16)v18];
    v2 = 0;
    if ( (unsigned __int8)v12 < 2u )
    {
      v8 = v12 == 1;
    }
    else
    {
      if ( (unsigned __int8)v12 <= 2u )
      {
        v2 = V_Game.racePowerStats[(__int16)v18].powerGap - V_Game.racePowerStats[index].powerGap;
        if ( v2 >= 0 )
        {
          if ( v2 > 3 )
          {
            v2 = 3;
          }
        }
        else
        {
          v2 = 0;
        }
        goto LABEL_34;
      }
      v8 = v12 == 3;
    }
    if ( v8 )
    {
      if ( pRace->treaties[(__int16)v18] == 1 )
      {
        for ( i = 0; i < V_Game.starsNum; ++i )
        {
          if ( ((1 << pRace->index) & V_Game.stars[i].planetsRacesBits) != 0 && ((1 << v18) & V_Game.stars[i].shipsRacesBits) != 0 )
          {
            v15 = unk_96912;
            v16 = *((_WORD *)&unk_96912 + 2);
            v2 += *((_WORD *)&v15 + V_Game.atmosphere);
          }
        }
      }
      v3 = &V_Game.races[(__int16)v18];
      EnemyRacesMask_sub_43374 = Q_Race_GetEnemyRacesMask_sub_43374(v3, 0xFFFFFFFF);
      v20 = EnemyRacesMask_sub_43374;
      v21 = Q_Race_GetEnemyRacesMask_sub_43374(v3, 0xFFFFFFFF);
      if ( v21 != EnemyRacesMask_sub_43374 )
      {
        v4 = 0;
        v17 = 0;
        for ( j = 0; j < V_Game.racesNum; ++j )
        {
          if ( j != (__int16)v18 && j != pRace->index )
          {
            if ( ((1 << j) & v20) != 0 )
            {
              v4 += V_Game.racePowerStats[j].shipsNum;
            }
            v5 = 1 << j;
            if ( (v21 & (1 << j)) != 0 )
            {
              LOWORD(v5) = V_Game.racePowerStats[j].shipsNum;
              v17 += v5;
            }
          }
        }
        if ( v4 <= (__int16)v17 )
        {
          v2 += 3;
        }
        else
        {
          --v2;
        }
        if ( pRace->treaties[(__int16)v18] == 1 )
        {
          powerGap = V_Game.racePowerStats[(__int16)v18].powerGap;
          v7 = V_Game.racePowerStats[pRace->index].powerGap;
          if ( powerGap - v7 <= 1 )
          {
            if ( v7 - powerGap > 1 )
            {
              v2 += 4;
            }
          }
          else
          {
            v2 -= 2;
          }
        }
      }
    }
LABEL_34:
    if ( (__int16)v18 == V_PlayerRaceIndex && V_SelfPlayMode == FALSE )
    {
      if ( v2 < 0 )
      {
        if ( V_Game.atmosphere )
        {
          if ( V_Game.atmosphere <= 1u )
          {
            v2 *= 2;
          }
          else if ( V_Game.atmosphere == 2 )
          {
            v2 *= 3;
          }
        }
      }
      else if ( V_Game.atmosphere )
      {
        if ( V_Game.atmosphere <= 1u )
        {
          v2 /= 2;
        }
        else if ( V_Game.atmosphere == 2 )
        {
          v2 /= 3;
        }
      }
    }
    if ( v2 )
    {
      v9 = v18;
      pRace->attitudes[(__int16)v18] += v2;
      v10 = pRace->attitudes[v9];
      if ( v10 >= 50 )
      {
        if ( v10 > 950 )
        {
          pRace->attitudes[v9] = 950;
        }
      }
      else
      {
        pRace->attitudes[v9] = 50;
      }
    }
    goto LABEL_54;
  }
}

//----- (0003C968) --------------------------------------------------------
void __fastcall sub_3C968(P_Race pRace)
{
  double v2; // st7
  float v3; // edx
  double v4; // st7
  WORD v5; // ax
  double bioSinX; // [esp+8h] [ebp-34h]
  double v7; // [esp+8h] [ebp-34h]
  double bioSinTwiceX; // [esp+8h] [ebp-34h]
  double bioSinHalfX; // [esp+10h] [ebp-2Ch]
  double v10; // [esp+10h] [ebp-2Ch]
  float bioMaxpositve; // [esp+18h] [ebp-24h]
  float bioMaxnegative; // [esp+1Ch] [ebp-20h]
  float v13; // [esp+20h] [ebp-1Ch]
  float v14; // [esp+24h] [ebp-18h]
  float v15; // [esp+24h] [ebp-18h]
  float v16; // [esp+24h] [ebp-18h]

  if ( V_Game.day % 0xA )
  {
    return;
  }
  v13 = (double)(V_Game.day % pRace->bioPeriod) / (double)pRace->bioPeriod * 6.28318530716;
  if ( !v13 )
  {
    v13 = 0.0099999998;
  }
  bioSinX = pRace->bioSinX;
  v7 = sin(v13) * bioSinX;
  bioSinHalfX = pRace->bioSinHalfX;
  v10 = sin(v13 * 0.5) * bioSinHalfX + v7;
  bioSinTwiceX = pRace->bioSinTwiceX;
  v14 = sin(v13 * 2.0) * bioSinTwiceX + v10;
  if ( v14 >= 0.0 )
  {
    v2 = v14 + 0.5;
  }
  else
  {
    v2 = v14 + -0.5;
  }
  v15 = v2;
  bioMaxpositve = (float)pRace->bioMaxpositve;
  if ( v15 > (double)bioMaxpositve )
  {
    v3 = (float)pRace->bioMaxpositve;
LABEL_11:
    v15 = v3;
    goto LABEL_12;
  }
  bioMaxnegative = (float)pRace->bioMaxnegative;
  if ( v15 < (double)bioMaxnegative )
  {
    v3 = (float)pRace->bioMaxnegative;
    goto LABEL_11;
  }
LABEL_12:
  if ( pRace->index == V_PlayerRaceIndex )
  {
    word_104BE8 = (int)v15;
  }
  if ( V_Game.atmosphere == 2 )
  {
    v4 = v15 + -6.0;
  }
  else if ( V_Game.atmosphere )
  {
    v4 = v15 + -2.0;
  }
  else
  {
    v4 = v15 + -4.0;
  }
  if ( V_Game.racesNum > 0 )
  {
    v5 = 0;
    do
    {
      if ( pRace->treaties[v5] )
      {
        if ( !V_Game.races[v5].extinct )
        {
          v16 = v4;
          pRace->attitudes[v5] = (int)((double)pRace->attitudes[v5] + v16);
        }
      }
      ++v5;
    }
    while ( v5 < V_Game.racesNum );
  }
}
// 104BE8: using guessed type __int16 word_104BE8;

//----- (0003CB60) --------------------------------------------------------
int __fastcall sub_3CB60(P_Race pRace, P_Planet pPlanet, unsigned __int8 a3)
{
  T_Ship *v5; // eax
  T_Ship *v6; // ebp
  int squareIndex; // [esp+0h] [ebp-14h]

  if ( pPlanet->industry )
  {
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD) == 0xFFFF )
    {
      if ( (V_Game.day > 170 || V_Game.atmosphere == ASCEND_ATMOSPHERE_HOSTILE)
        && ((1 << pRace->index) & V_Research.techs[V_PlanetItems.item[ASCEND_PI_22_SHIPYARD].resReq].knownToRace) != 0 )
      {
        if ( !Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_22_SHIPYARD, 0) )
        {
          return 2;
        }
        return 1;
      }
    }
    else if ( Q_Planet_CanBuildShip_sub_362E0(pPlanet) && (pPlanet->raceIndex != V_PlayerRaceIndex || V_SelfPlayMode == TRUE) )
    {
      squareIndex = Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_23_SHIP, 0);
      if ( squareIndex != 0xFFFF )
      {
        v5 = sub_40144(pRace, pPlanet);
        v6 = v5;
        if ( !v5 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x537);
        }
        Q_Race_DetermineAndBuildOptimalShip_sub_3F060(pRace, v5, pPlanet, a3);
        Q_Planet_AssignShipToOrbitalSquare_sub_35B04(pPlanet, squareIndex, v6);
        return 1;
      }
    }
  }
  return 0;
}

//----- (0003CC90) --------------------------------------------------------
unsigned int __fastcall Q_NC_sub_3CC90(_BYTE *a1, unsigned __int8 a2)
{
  if ( a2 < 39u && ((1 << *a1) & V_Research.techs[V_PlanetItems.item[a2].resReq].knownToRace) != 0 )
  {
    return 0xFFFFFFFF;
  }
  else
  {
    return 0;
  }
}

//----- (0003CCE4) --------------------------------------------------------
unsigned int __fastcall sub_3CCE4(P_Race pRace, P_Planet pPlanet)
{
  unsigned int v3; // ebp
  int v4; // edi
  int industry; // ebx
  int research; // ebx
  UBYTE v7; // al
  UWORD flags; // ax
  P_Square pSquares; // eax
  T_PlanetItem *v10; // ebx
  T_Square *v11; // edi
  int ind; // eax
  int color; // edi
  signed __int8 pros; // al
  int v15; // edi
  P_Square v16; // eax
  signed __int8 res; // ah
  int v18; // edi
  P_Square v19; // eax
  T_Square *v20; // edi
  int resReq; // ebx
  UBYTE v22; // bl
  unsigned __int8 v23; // bh
  int i; // ecx
  int j; // kr0C_4
  int v27[3]; // [esp+0h] [ebp-10Ch]
  int v28; // [esp+Ch] [ebp-100h]
  int v29; // [esp+10h] [ebp-FCh]
  int v30; // [esp+18h] [ebp-F4h]
  int v31; // [esp+1Ch] [ebp-F0h]
  int v32; // [esp+20h] [ebp-ECh]
  int v33; // [esp+24h] [ebp-E8h]
  int v34; // [esp+28h] [ebp-E4h]
  int v35; // [esp+2Ch] [ebp-E0h]
  int v36; // [esp+30h] [ebp-DCh]
  int v37; // [esp+34h] [ebp-D8h]
  int v38; // [esp+38h] [ebp-D4h]
  int v39; // [esp+3Ch] [ebp-D0h]
  int v40; // [esp+44h] [ebp-C8h]
  int v41; // [esp+48h] [ebp-C4h]
  int v42; // [esp+4Ch] [ebp-C0h]
  int v43; // [esp+50h] [ebp-BCh]
  int v44; // [esp+9Ch] [ebp-70h]
  int v45; // [esp+A0h] [ebp-6Ch]
  int v46; // [esp+A4h] [ebp-68h]
  int v47; // [esp+A8h] [ebp-64h]
  float v48; // [esp+ACh] [ebp-60h]
  float v49; // [esp+B0h] [ebp-5Ch]
  float v50; // [esp+B4h] [ebp-58h]
  float v51; // [esp+B8h] [ebp-54h]
  int v52; // [esp+BCh] [ebp-50h]
  float v53; // [esp+C0h] [ebp-4Ch]
  float v54; // [esp+C4h] [ebp-48h]
  int squareIndex; // [esp+C8h] [ebp-44h]
  int v56; // [esp+CCh] [ebp-40h]
  int v57; // [esp+D0h] [ebp-3Ch]
  int v58; // [esp+D4h] [ebp-38h]
  int v59; // [esp+D8h] [ebp-34h]
  float v60; // [esp+DCh] [ebp-30h]
  int v61; // [esp+E0h] [ebp-2Ch]
  int v62; // [esp+E4h] [ebp-28h]
  int random100; // [esp+E8h] [ebp-24h]
  int v64; // [esp+ECh] [ebp-20h]
  P_Square v65; // [esp+F0h] [ebp-1Ch]
  UBYTE planetItemIndex; // [esp+F4h] [ebp-18h]

  v3 = 0;
  v52 = 0;
  squareIndex = 0xFFFFFFFF;
  v53 = 0.0;
  v51 = 1.0;
  v48 = 1.0;
  v54 = 1.0;
  v50 = 1.0;
  v49 = 1.0;
  v44 = 0;
  v64 = 0;
  v47 = 0;
  v62 = 0;
  v61 = 0;
  v4 = Q_Planet_CalculateSurfaceShieldStrength_sub_36158(pPlanet);
  if ( V_PlanetItems.item[ASCEND_PI_19_SURFACE_MEGA_SHIELD].resReq == 0xFF
    || ((1 << pPlanet->raceIndex) & V_Research.techs[V_PlanetItems.item[ASCEND_PI_19_SURFACE_MEGA_SHIELD].resReq].knownToRace) != 0 )
  {
    v61 = 0xFFFFFFFF;
  }
  if ( V_PlanetItems.item[ASCEND_PI_19_SURFACE_MEGA_SHIELD].resReq == 0xFF
    || ((1 << pPlanet->raceIndex) & V_Research.techs[V_PlanetItems.item[ASCEND_PI_19_SURFACE_MEGA_SHIELD].resReq].knownToRace) != 0 )
  {
    v62 = 0xFFFFFFFF;
  }
  if ( pPlanet->maximumPopulation - pPlanet->population > 0 )
  {
    v44 = 0xFFFFFFFF;
  }
  if ( Q_Race_HasDiscoveredAllTechs_sub_40590(pRace) )
  {
    v52 = 0xFFFFFFFF;
  }
  if ( pPlanet->prosperity < 2u )
  {
    v64 = 0xFFFFFFFF;
    v54 = 2.0;
    v3 = 4;
  }
  if ( pPlanet->freeSurfaceSquaresNum || pPlanet->maximumPopulation - pPlanet->population <= 3 || !v62 )
  {
    if ( pPlanet->freeSurfaceSquaresNum > 1u && pPlanet->maximumPopulation - pPlanet->population < 2 )
    {
      v3 = 8;
      if ( v44 == 0xFFFFFFFF )
      {
        v50 = 0.0;
      }
    }
  }
  else
  {
    v50 = 0.5;
    v47 = 0xFFFFFFFF;
  }
  if ( v4 < 4 )
  {
    v49 = 2.0;
    if ( !v3 )
    {
      v3 = 0x10;
    }
  }
  if ( v52 )
  {
    v48 = 0.0;
  }
  if ( pPlanet->population - pPlanet->usedPopulation <= pPlanet->prosperity || pPlanet->prosperity >= 3u )
  {
    if ( pPlanet->population - pPlanet->usedPopulation < pPlanet->prosperity || pPlanet->prosperity > 5u )
    {
      v54 = 0.5;
    }
  }
  else
  {
    v54 = 2.0;
    if ( !v3 )
    {
      v3 = 4;
    }
  }
  industry = pPlanet->industry;
  if ( (unsigned __int16)industry < 25u )
  {
    if ( pPlanet->industry )
    {
      v45 = 0x19 / industry;
      v51 = (float)(0x19 / industry);
    }
    else
    {
      v51 = 25.0;
    }
    if ( !v3 )
    {
      v3 = 2;
    }
  }
  if ( !v52 )
  {
    research = pPlanet->research;
    if ( (unsigned __int16)research < 0x19u )
    {
      if ( pPlanet->research )
      {
        v45 = 0x19 / research;
        v51 = (float)(0x19 / research);
      }
      else
      {
        v51 = 25.0;
      }
      if ( !v3 )
      {
        v3 = 1;
      }
    }
  }
  if ( 5 * v4 < 2 * pPlanet->surfaceSquaresNum )
  {
    v49 = 1.5;
    if ( !v3 )
    {
      v3 = 0x10;
    }
  }
  for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
  {
    pSquares = pPlanet->pSquares;
    LOBYTE(pSquares) = pSquares[i].planetItemIndex;
    v58 = 0;
    v57 = 0;
    v59 = 0;
    v56 = 0;
    v46 = 0;
    v10 = &V_PlanetItems.item[(unsigned __int8)pSquares];
    if ( (_BYTE)pSquares != 0xFF
      && (_BYTE)pSquares != 4
      && (_BYTE)pSquares != 6
      && (_BYTE)pSquares != 7
      && (_BYTE)pSquares != 8
      && (_BYTE)pSquares != 0x13
      && (_BYTE)pSquares != 5
      && (_BYTE)pSquares != 0xB
      && (_BYTE)pSquares != 0xC
      && (_BYTE)pSquares != 0xD
      && (_BYTE)pSquares != 0xE
      && (_BYTE)pSquares != 0xF
      && (_BYTE)pSquares != 0x11
      && (_BYTE)pSquares != 0x10
      && ((_BYTE)pSquares != 0x12 || v61 && (v3 == 0x10 || !v3))
      && ((_BYTE)pSquares != 3 || v47)
      && ((_BYTE)pSquares != 0x14 || v44)
      && ((_BYTE)pSquares != 9 && (_BYTE)pSquares != 0xA || v52) )
    {
      v11 = &pPlanet->pSquares[i];
      LOWORD(pSquares) = v11->flags & 1;
      v65 = pSquares;
      HIWORD(ind) = 0;
      if ( (_WORD)v65 )
      {
        if ( v10->ind )
        {
          ind = v10->ind;
          color = v11->color;
          v58 += ind;
          if ( color == 2 )
          {
            ++v58;
          }
        }
        pros = v10->pros;
        if ( pros )
        {
          v15 = pros + v59;
          v16 = pPlanet->pSquares;
          v59 = v15;
          ind = v16[i].color;
          if ( ind == 3 )
          {
            ind = v15 + 1;
            v59 = v15 + 1;
          }
        }
        res = v10->res;
        if ( res )
        {
          v18 = res + v57;
          v19 = pPlanet->pSquares;
          v57 = v18;
          ind = v19[i].color;
          if ( ind == 4 )
          {
            v57 = v18 + 1;
          }
        }
        v20 = &pPlanet->pSquares[i];
        if ( v20->planetItemIndex != 0xFF )
        {
          LOWORD(ind) = v20->flags & 1;
          v65 = (P_Square)ind;
          if ( (_BYTE)ind )
          {
            v7 = v20->planetItemIndex;
            if ( v7 >= 0x12u )
            {
              if ( v7 <= 0x12u )
              {
                v46 += 2;
              }
              else if ( v7 == 0x13 )
              {
                v46 += 4;
              }
            }
          }
        }
        v56 += v10->mpop;
      }
      v60 = (double)v58 * v51;
      v60 = (double)v57 * v48 + v60;
      v60 = (double)v59 * v54 + v60;
      flags = pPlanet->pSquares[i].flags;
      v60 = (double)v56 * v50 + v60;
      v60 = (double)v46 * v49 + v60;
      if ( (flags & 2) != 0 )
      {
        v60 = v60 + v54;
      }
      if ( squareIndex == 0xFFFFFFFF || v60 < (double)v53 )
      {
        squareIndex = i;
        v53 = v60;
      }
    }
  }
  if ( squareIndex == 0xFFFFFFFF )
  {
    return 0;
  }
  random100 = rand() % 100;
  for ( j = 0; j != 0x27; ++j )
  {
    resReq = V_PlanetItems.item[j].resReq;
    if ( resReq == 0xFF || ((1 << pPlanet->raceIndex) & V_Research.techs[resReq].knownToRace) != 0 )
    {
      v27[j] = 0xFFFFFFFF;
    }
    else
    {
      v27[j] = 0;
    }
  }
  planetItemIndex = 0xFF;
  v22 = pPlanet->pSquares[squareIndex].planetItemIndex;
  v23 = v22;
  if ( (v22 == 2 || v22 == 9 || v22 == 0xA) && v52 == 0xFFFFFFFF )
  {
    if ( v64 == 0xFFFFFFFF )
    {
      v22 = 1;
    }
    else if ( random100 >= 25 )
    {
      v22 = 0;
    }
    else
    {
      v22 = 0x12;
    }
  }
  if ( v3 < 2 )
  {
    if ( !v3 )
    {
      goto LABEL_222;
    }
    if ( !v52 )
    {
      v22 = 2;
      goto LABEL_222;
    }
LABEL_123:
    v22 = 0;
    goto LABEL_222;
  }
  if ( v3 <= 2 )
  {
    goto LABEL_123;
  }
  if ( v3 < 8 )
  {
    v22 = 1;
  }
  else if ( v3 <= 8 )
  {
    v22 = 0x14;
  }
  else
  {
    v22 = 0x12;
  }
LABEL_222:
  if ( v22 < 2u )
  {
    if ( v22 )
    {
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_13_FERTILIZATION_PLANT) == 0xFFFF && v37 )
      {
        planetItemIndex = ASCEND_PI_13_FERTILIZATION_PLANT;
        goto LABEL_136;
      }
      if ( !v64 && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_15_CLONING_PLANT) == 0xFFFF && v39 )
      {
        planetItemIndex = ASCEND_PI_15_CLONING_PLANT;
        goto LABEL_136;
      }
      if ( !v64 && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_17_TRACTOR_BEAM) == 0xFFFF && v40 )
      {
        planetItemIndex = ASCEND_PI_17_TRACTOR_BEAM;
        goto LABEL_136;
      }
      if ( !v64 && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_11_SURFACE_CLOAKER) == 0xFFFF && v35 )
      {
        planetItemIndex = ASCEND_PI_11_SURFACE_CLOAKER;
        goto LABEL_136;
      }
      if ( v29 && v31 )
      {
        if ( random100 < 0x32 && !v52 )
        {
          planetItemIndex = 4;
          goto LABEL_136;
        }
      }
      else
      {
        if ( v29 && !v52 )
        {
          planetItemIndex = 4;
          goto LABEL_136;
        }
        if ( !v31 )
        {
          if ( !v33 || v52 )
          {
            if ( v23 != v22 && v27[1] )
            {
              planetItemIndex = 1;
            }
          }
          else
          {
            planetItemIndex = 9;
          }
          goto LABEL_136;
        }
      }
      planetItemIndex = 7;
      goto LABEL_136;
    }
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xCu) == 0xFFFF && v36 )
    {
      planetItemIndex = 0xC;
      goto LABEL_136;
    }
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x11u) == 0xFFFF && v40 )
    {
      planetItemIndex = 0x11;
      goto LABEL_136;
    }
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xBu) == 0xFFFF && v35 )
    {
      planetItemIndex = 0xB;
      goto LABEL_136;
    }
    if ( v29 && v30 )
    {
      if ( random100 < 0x32 && !v52 )
      {
        planetItemIndex = 4;
        goto LABEL_136;
      }
    }
    else
    {
      if ( v29 && !v52 )
      {
        planetItemIndex = 4;
        goto LABEL_136;
      }
      if ( !v30 )
      {
        if ( !v34 || v52 )
        {
          if ( v23 && v27[0] )
          {
            planetItemIndex = 0;
          }
        }
        else
        {
          planetItemIndex = 0xA;
        }
        goto LABEL_136;
      }
    }
    planetItemIndex = 6;
    goto LABEL_136;
  }
  if ( v22 <= 2u )
  {
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xEu) == 0xFFFF && v38 )
    {
      planetItemIndex = 0xE;
    }
    else if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x11u) == 0xFFFF && v40 )
    {
      planetItemIndex = 0x11;
    }
    else if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xBu) == 0xFFFF && v35 )
    {
      planetItemIndex = 0xB;
    }
    else if ( v32 )
    {
      planetItemIndex = 8;
    }
    else if ( v29 )
    {
      planetItemIndex = 4;
    }
    else if ( v34 )
    {
      planetItemIndex = 0xA;
    }
    else if ( v33 )
    {
      planetItemIndex = 9;
    }
    else if ( v23 != v22 && v27[2] )
    {
      planetItemIndex = 2;
    }
  }
  else if ( v22 < 0x12u )
  {
    if ( v22 != 3 )
    {
      return 0;
    }
    if ( v29 )
    {
      planetItemIndex = 4;
    }
    else if ( v23 != 3 && v28 )
    {
      planetItemIndex = 3;
    }
  }
  else if ( v22 <= 0x12u )
  {
    if ( v42 )
    {
      planetItemIndex = 0x13;
    }
    else if ( v23 != v22 && v41 )
    {
      planetItemIndex = 0x12;
    }
  }
  else
  {
    if ( v22 != 0x14 )
    {
      return 0;
    }
    if ( v29 )
    {
      planetItemIndex = 4;
    }
    else if ( v28 )
    {
      planetItemIndex = 3;
    }
    else if ( v23 != 0x14 && v43 )
    {
      planetItemIndex = 0x14;
    }
  }
LABEL_136:
  if ( planetItemIndex < (unsigned int)ASCEND_PI_39_END && Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, squareIndex, v23, 1u) )
  {
    Q_Planet_StartConstruction_sub_34774(pPlanet, planetItemIndex, squareIndex, FALSE);
    return 0xFFFFFFFF;
  }
  return 0;
}
// 3D3C4: conditional instruction was optimized away because ebp.4==10
// 3D3FB: conditional instruction was optimized away because ebp.4==4

//----- (0003D8F0) --------------------------------------------------------
void __fastcall Q_Race_ManagePlanetDevelopment_sub_3D8F0(P_Race pRace, P_Planet pPlanet)
{
  T_Square *pFoundSurfaceSquare; // edi
  int surfaceBuildingsNum; // eax
  T_Planet *v5; // eax
  UBYTE v6; // dl
  int population; // eax
  int planetPopulation; // eax
  int xenoSquareIndex; // eax
  int bXenoBuildStarted; // ebp
  UWORD usedPopulation; // ax
  int v12; // ebp
  UBYTE planetItemIndex; // bl
  T_PlanetItem *pPlanetItem_; // ebx
  int upop; // ebx
  int v16; // ebp
  int j; // edi
  int resReq; // eax
  UBYTE raceIndex; // cl
  int ind; // ecx
  P_PlanetItem pPlanetItem; // eax
  int v22; // ecx
  __int16 v23; // ax
  unsigned __int16 v24; // di
  int i; // eax
  T_Type24 v26[39]; // [esp+6h] [ebp-120h]
  int freeInd; // [esp+CAh] [ebp-5Ch] BYREF
  int freeRes; // [esp+CEh] [ebp-58h] BYREF
  int freeFer; // [esp+D2h] [ebp-54h] BYREF
  int maximumPopulation; // [esp+D6h] [ebp-50h]
  MACRO_VFX_BOOL isPlanetStrained; // [esp+DAh] [ebp-4Ch]
  T_Race *pRace_; // [esp+DEh] [ebp-48h]
  int a3; // [esp+E6h] [ebp-40h]
  int v34; // [esp+EAh] [ebp-3Ch]
  unsigned int v35; // [esp+EEh] [ebp-38h]
  int bHasTerraformableSquares; // [esp+F6h] [ebp-30h]
  int bHasAvailableBuildSquares; // [esp+FAh] [ebp-2Ch]
  int v38; // [esp+FEh] [ebp-28h]
  int v39; // [esp+106h] [ebp-20h]
  int v40; // [esp+10Ah] [ebp-1Ch]

  pRace_ = pRace;
  isPlanetStrained = FALSE;
  v38 = 0;
  Q_Planet_CountBuildableSquaresByColor_sub_34A44(pPlanet, &freeRes, &freeInd, &freeFer);
  if ( Q_Race_HasDiscoveredAllTechs_sub_40590(pRace_) == TRUE )
  {
    freeInd += freeRes;
    freeFer += freeRes;
    freeRes = 0;
  }
  surfaceBuildingsNum = Q_Planet_CountSurfaceBuildings_sub_358F0(pPlanet);
  if ( surfaceBuildingsNum < 1 )
  {
    if ( freeInd > 0 )
    {
LABEL_5:
      v5 = pPlanet;
      v6 = 0;
      goto LABEL_20;
    }
    goto LABEL_18;
  }
  if ( surfaceBuildingsNum < 2 )
  {
    if ( freeFer <= 0 || pPlanet->industry <= 1u )
    {
      goto LABEL_5;
    }
LABEL_18:
    v6 = 1;
    goto LABEL_19;
  }
  if ( surfaceBuildingsNum >= 3 )
  {
    goto LABEL_21;
  }
  if ( freeRes <= 0 || pPlanet->prosperity <= 1u || pPlanet->industry <= 1u )
  {
    if ( freeInd > 0 && pPlanet->prosperity > 1u )
    {
      v5 = pPlanet;
      v6 = 0;
      goto LABEL_20;
    }
    goto LABEL_18;
  }
  v6 = 2;
LABEL_19:
  v5 = pPlanet;
LABEL_20:
  if ( Q_Planet_BuildAtOptimalLocation_sub_34AE4(v5, v6, TRUE) != 0xFFFF )
  {
    return;
  }
LABEL_21:
  if ( !pPlanet->industry )
  {
    return;
  }
  if ( pPlanet->prosperity < 2u )
  {
    population = pPlanet->population;
    if ( pPlanet->maximumPopulation - (unsigned __int16)population < 1 && population - pPlanet->usedPopulation < 1 )
    {
      v38 = 0xFFFFFFFF;
    }
  }
  planetPopulation = pPlanet->population;
  if ( pPlanet->maximumPopulation - (unsigned __int16)planetPopulation < 1 && planetPopulation - pPlanet->usedPopulation < 2 )
  {
    isPlanetStrained = TRUE;
  }
  v34 = (__int16)Q_Race_BuildOptimalOrbitalPlanetItem_sub_3E1CC(pRace_, pPlanet);
  if ( v34 == 1 )
  {
    return;
  }
  bHasAvailableBuildSquares = (Q_Planet_CountAvailableBuildSquares_sub_3407C(pPlanet) <= 0) - 1;
  bHasTerraformableSquares = (Q_Planet_CountTerraformableSquares_sub_3420C(pPlanet) <= 0) - 1;
  xenoSquareIndex = Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_38_XENO_ARCHEOLOGICAL_DIG, TRUE);
  bXenoBuildStarted = (xenoSquareIndex == 0xFFFF) - 1;
  Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, xenoSquareIndex, ASCEND_PI_38_XENO_ARCHEOLOGICAL_DIG, 1u);
  if ( !pPlanet->freeSurfaceSquaresNum || !bHasAvailableBuildSquares && !bHasTerraformableSquares && !bXenoBuildStarted )
  {
LABEL_84:
    sub_3CCE4(pRace_, pPlanet);
    return;
  }
  if ( bXenoBuildStarted == 0xFFFFFFFF )
  {
    Q_Race_HandleAdvancedPlanetDevelopment_sub_3E520(pRace_, pPlanet);
    return;
  }
  if ( bHasAvailableBuildSquares != 0xFFFFFFFF )
  {
    if ( ((1 << pPlanet->raceIndex) & V_Research.techs[V_PlanetItems.item[ASCEND_PI_36_TERRAFORMING].resReq].knownToRace) != 0 )
    {
      LOWORD(a3) = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_21_TRANSPORT_TUBES);
      a3 = (unsigned __int16)a3;
      if ( (unsigned __int16)a3 == 0xFFFF )
      {
        if ( Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_36_TERRAFORMING, FALSE) != 0xFFFF )
        {
          return;
        }
      }
      else
      {
        v24 = a3;
        Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, a3, ASCEND_PI_21_TRANSPORT_TUBES, 1u);
        if ( Q_Planet_CanPlaceItem_sub_34368(pPlanet, ASCEND_PI_36_TERRAFORMING, v24) )
        {
          Q_Planet_StartConstruction_sub_34774(pPlanet, ASCEND_PI_36_TERRAFORMING, a3, 0);
          return;
        }
      }
    }
    else if ( pPlanet->freeSurfaceSquaresNum > pPlanet->blackSquaresNum
           && isPlanetStrained != TRUE
           && Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_21_TRANSPORT_TUBES, TRUE) != 0xFFFF )
    {
      return;
    }
    goto LABEL_84;
  }
  a3 = 0xFFFFFFFF;
  usedPopulation = pPlanet->usedPopulation;
  v12 = 0;
  if ( usedPopulation < pPlanet->maximumPopulation )
  {
    if ( usedPopulation >= pPlanet->population || v34 == 2 )
    {
      return;
    }
  }
  else
  {
    for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
    {
      pFoundSurfaceSquare = &pPlanet->pSquares[i];
      planetItemIndex = pFoundSurfaceSquare->planetItemIndex;
      if ( planetItemIndex != 0xFF && planetItemIndex != ASCEND_PI_05_COLONY_BASE )
      {
        pPlanetItem_ = &V_PlanetItems.item[pFoundSurfaceSquare->planetItemIndex];
        if ( !pPlanetItem_->mpop )
        {
          upop = pPlanetItem_->upop;
          if ( upop > v12 )
          {
            v12 = upop;
            a3 = i;
          }
        }
      }
    }
    if ( a3 == 0xFFFFFFFF )
    {
      Q_debugbreak_sub_26194();
      Q_Planet_Abandon_sub_37040(pPlanet);
      return;
    }
    Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, a3, pFoundSurfaceSquare->planetItemIndex, 1u);
    if ( pPlanet->usedPopulation >= pPlanet->population )
    {
      return;
    }
  }
  if ( pPlanet->population - pPlanet->usedPopulation <= 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x85A);
  }
  if ( v38 || Q_Race_HandleAdvancedPlanetDevelopment_sub_3E520(pRace_, pPlanet) != 0xFFFFFFFF )
  {
    v35 = (__int16)sub_3E800(pRace_, (unsigned __int16 *)pPlanet);
    if ( v35 == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x870);
    }
    v16 = 0;
    for ( j = 0; ; ++j )
    {
      while ( 1 )
      {
        if ( V_PlanetItems.surfaceItemsNum )
        {
          resReq = V_PlanetItems.item[j].resReq;
          if ( resReq == 0xFF
            || (raceIndex = pPlanet->raceIndex,
                maximumPopulation = V_Research.techs[resReq].knownToRace,
                ((1 << raceIndex) & maximumPopulation) != 0) )
          {
            maximumPopulation = pPlanet->maximumPopulation;
            if ( V_PlanetItems.item[j].upop <= maximumPopulation - pPlanet->usedPopulation )
            {
              break;
            }
          }
        }
LABEL_63:
        ++j;
      }
      HIWORD(ind) = HIWORD(v35);
      pPlanetItem = &V_PlanetItems.item[j];
      if ( v35 <= 3 )
      {
        switch ( (unsigned int)pPlanetItem )
        {
          case 0u:
            ind = pPlanetItem->ind;
            if ( !pPlanetItem->ind )
            {
              goto LABEL_63;
            }
            v26[v16].Unknown_1 = pPlanetItem->ind;
            break;
          case 1u:
            ind = (char)pPlanetItem->res;
            if ( !pPlanetItem->res )
            {
              goto LABEL_63;
            }
            v26[v16].Unknown_1 = (char)pPlanetItem->res;
            break;
          case 2u:
            ind = (char)pPlanetItem->pros;
            if ( !pPlanetItem->pros )
            {
              goto LABEL_63;
            }
            v26[v16].Unknown_1 = (char)pPlanetItem->pros;
            break;
          case 3u:
            ind = pPlanetItem->mpop;
            if ( !pPlanetItem->mpop )
            {
              goto LABEL_63;
            }
            v26[v16].Unknown_1 = pPlanetItem->mpop;
            break;
        }
      }
      LOWORD(ind) = pPlanetItem->mpop;
      v39 = ind;
      LOWORD(ind) = (char)pPlanetItem->pros;
      v22 = ind + v39;
      v40 = v22;
      LOWORD(v22) = (char)pPlanetItem->res;
      v39 = v22;
      v23 = pPlanetItem->ind;
      LOWORD(v22) = v22 + v40;
      v26[v16].planetItemIndex = 0;
      v26[v16++].Unknown_3 = v22 + v23;
    }
  }
}
// 3DCC8: conditional instruction was optimized away because bl.1==0
// 3DBF4: variable 'pFoundSurfaceSquare' is possibly undefined

//----- (0003E020) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Race_ReplaceOrbitalPlanetItem_sub_3E020(P_Race pRace, P_Planet pPlanet, UBYTE newItemIndex)
{
  MACRO_VFX_BOOL result; // eax
  int currentWeaponStrength; // ebx
  int currentShieldStrength; // eax
  int currentShieldStrength_; // edx
  int firstOrbitalSquare; // kr08_4
  signed int newItemScore; // eax
  UBYTE existingItemIndex; // cl
  int i; // kr04_4
  MACRO_VFX_BOOL wantNewWeapon; // [esp+8h] [ebp-18h]
  int minShieldThreshold; // [esp+Ch] [ebp-14h]
  signed int bestScore; // [esp+10h] [ebp-10h]
  MACRO_VFX_BOOL wantNewShield; // [esp+14h] [ebp-Ch]
  signed int bestSquareIndex; // [esp+18h] [ebp-8h]

  if ( newItemIndex > (unsigned int)ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER
    || newItemIndex < (unsigned int)ASCEND_PI_22_SHIPYARD
    || newItemIndex == ASCEND_PI_23_SHIP )
  {
    // Not orbital item
    return FALSE;
  }
  bestScore = 0;
  bestSquareIndex = -1u;
  // Calculate current planetary defenses
  wantNewWeapon = 0;
  currentWeaponStrength = Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(pPlanet);
  wantNewShield = 0;
  currentShieldStrength = Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(pPlanet);
  currentShieldStrength_ = currentShieldStrength;
  // Determine what type of item we're installing
  if ( newItemIndex == ASCEND_PI_26_ORBITAL_SHIELD || newItemIndex == ASCEND_PI_27_ORBITAL_MEGA_SHIELD )
  {
    wantNewShield = TRUE;
  }
  else if ( newItemIndex == ASCEND_PI_28_ORBITAL_MISSILE_BASE
         || newItemIndex == ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER
         || newItemIndex == ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER )
  {
    wantNewWeapon = TRUE;
  }
  minShieldThreshold = currentShieldStrength - 3;
  firstOrbitalSquare = pPlanet->surfaceSquaresNum;
  for ( i = 0; firstOrbitalSquare + i < pPlanet->totalSquaresNum; ++i )
  {
    existingItemIndex = pPlanet->pSquares[(unsigned __int16)firstOrbitalSquare + i].planetItemIndex;
    newItemScore = -1u;
    if ( existingItemIndex != ASCEND_PI_26_ORBITAL_SHIELD || newItemIndex == ASCEND_PI_26_ORBITAL_SHIELD )
    {
      if ( existingItemIndex != ASCEND_PI_28_ORBITAL_MISSILE_BASE || newItemIndex == ASCEND_PI_28_ORBITAL_MISSILE_BASE )
      {
        if ( existingItemIndex == ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER
          && newItemIndex != ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER
          && (wantNewShield == FALSE || currentShieldStrength_ < currentWeaponStrength - 4) )
        {
          newItemScore = 4;
          if ( currentShieldStrength_ > currentWeaponStrength )
          {
            newItemScore = 8;
          }
        }
      }
      else if ( wantNewShield == FALSE || currentShieldStrength_ < currentWeaponStrength - 2 )
      {
        // Only replace weapon if shields are too weak
        newItemScore = 2;
        if ( currentShieldStrength_ > currentWeaponStrength )
        {
          newItemScore = 4;
        }
      }
    }
    else if ( wantNewWeapon == FALSE || currentWeaponStrength < minShieldThreshold )
    {
      // Only replace shield if weapons are too weak
      newItemScore = 3;
      if ( currentWeaponStrength > currentShieldStrength_ )
      {
        newItemScore = 6;
      }
    }
    if ( newItemScore != -1u && (bestSquareIndex == -1u || newItemScore < bestScore) )
    {
      bestSquareIndex = firstOrbitalSquare + i;
      bestScore = newItemScore;
    }
  }
  if ( bestSquareIndex == -1u )
  {
    // No suitable square was found
    return FALSE;
  }
  result = Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, bestSquareIndex, pPlanet->pSquares[bestSquareIndex].planetItemIndex, 1u);
  if ( result )
  {
    Q_Planet_StartConstruction_sub_34774(pPlanet, newItemIndex, bestSquareIndex, FALSE);
    return TRUE;
  }
  return result;
}

//----- (0003E1CC) --------------------------------------------------------
// Determines and builds the most appropriate orbital installation for a planet
// @return 1 if an installation was built, 0 otherwise
int __fastcall Q_Race_BuildOptimalOrbitalPlanetItem_sub_3E1CC(P_Race pRace, P_Planet pPlanet)
{
  UBYTE newItemIndex; // ch
  int planetResearch; // ebx
  int weaponStrength; // ebp
  int population; // eax
  int planetIndustry; // edx
  int totalDefense; // eax
  int homeSystemBonus; // edx
  int random100; // edx
  MACRO_VFX_BOOL isPlanetStrained; // [esp+0h] [ebp-14h]
  int shiledStrength; // [esp+8h] [ebp-Ch]
  char bestWeapon; // [esp+Ch] [ebp-8h]
  char bestShield; // [esp+10h] [ebp-4h]

  newItemIndex = 0xFF;
  isPlanetStrained = FALSE;
  planetResearch = pPlanet->research;
  if ( Q_Race_HasDiscoveredAllTechs_sub_40590(pRace) )
  {
    planetResearch = 1000;
  }
  // Not enough surface buildings
  if ( Q_Planet_CountSurfaceBuildings_sub_358F0(pPlanet) < 5 )
  {
    return 0;
  }
  shiledStrength = Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(pPlanet);
  weaponStrength = Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(pPlanet);
  bestShield = Q_Planet_GetBestAvailableOrbitalShield_sub_35DA4(pPlanet);
  bestWeapon = Q_Planet_GetBestAvailableOrbitalWeapon_sub_35E24(pPlanet);
  // Check if planet is population/resource strained
  if ( (unsigned __int16)pPlanet->freeOrbitalSquaresNum < 2u
    || (population = pPlanet->population, pPlanet->maximumPopulation - (unsigned __int16)population < 1)
    && population - pPlanet->usedPopulation < 2
    || pPlanet->prosperity < 2u )
  {
    isPlanetStrained = TRUE;
  }
  // Priority 1: Build shields if none exist
  if ( shiledStrength < 1 && bestShield != (char)0xFF )
  {
    newItemIndex = bestShield;
  }
  // Priority 2: Build weapons if none exist
  if ( newItemIndex == 0xFF && weaponStrength < 1 && bestWeapon != (char)0xFF )
  {
    newItemIndex = bestWeapon;
  }
  // Priority 3: Build shipyard if needed
  if ( newItemIndex == 0xFF
    && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD) == 0xFFFF
    && pPlanet->size > 1u
    && (pPlanet->industry >= 4u || pPlanet->freeSurfaceSquaresNum - pPlanet->blackSquaresNum < 5) )
  {
    if ( (V_Research.techs[V_PlanetItems.item[ASCEND_PI_22_SHIPYARD].resReq].knownToRace & (1 << pRace->index)) != 0 )
    {
      newItemIndex = ASCEND_PI_22_SHIPYARD;
    }
  }
  else if ( pPlanet->industry < 4u && Q_Planet_CountAvailableBuildSquares_sub_3407C(pPlanet) > 0 )
  {
    return 0;
  }
  // Check industry/research balance
  if ( (pPlanet->industry < 20u || planetResearch < 20)
    && Q_Planet_CountAvailableBuildSquares_sub_3407C(pPlanet) > 0
    && (shiledStrength > 0 || bestShield == (char)0xFF)
    && (weaponStrength > 0 || bestWeapon == (char)0xFF) )
  {
    planetIndustry = pPlanet->industry;
    totalDefense = weaponStrength + shiledStrength;
    if ( (unsigned __int16)planetIndustry <= planetResearch )
    {
      // Defense too high relative to production
      if ( totalDefense > planetIndustry )
      {
        return 0;
      }
    }
    // Defense too high relative to research
    else if ( totalDefense > planetResearch )
    {
      return 0;
    }
  }
  // Home system gets stronger defenses
  homeSystemBonus = 0;
  if ( &V_Game.stars[pPlanet->starIndex] == pRace->homeStar )
  {
    homeSystemBonus = 6;
  }
  // Balance weapons and shields
  if ( newItemIndex != 0xFF || weaponStrength >= shiledStrength || bestWeapon == (char)0xFF || weaponStrength >= homeSystemBonus + 6 )
  {
    if ( newItemIndex == 0xFF && bestShield != (char)0xFF && homeSystemBonus + 6 > shiledStrength )
    {
      newItemIndex = bestShield;
    }
  }
  else
  {
    newItemIndex = bestWeapon;
  }
  // 20% chance to consider Orbital Cloaker if available
  random100 = rand() % 100;
  if ( newItemIndex == 0xFF
    && random100 < 20
    && Q_Planet_CanPlaceItem_sub_34368(pPlanet, ASCEND_PI_25_ORBITAL_CLOAKER, 0xFFFFu)
    && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_25_ORBITAL_CLOAKER) == 0xFFFF )
  {
    newItemIndex = ASCEND_PI_25_ORBITAL_CLOAKER;
  }
  // Final fallback to shields or weapons
  if ( newItemIndex != 0xFF || weaponStrength >= shiledStrength || bestWeapon == (char)0xFF )
  {
    if ( newItemIndex == 0xFF && bestShield != (char)0xFF )
    {
      newItemIndex = bestShield;
    }
  }
  else
  {
    newItemIndex = bestWeapon;
  }
  // Attempt to build the selected item
  if ( newItemIndex != 0xFF )
  {
    // Try optimal location first if planet isn't strained
    if ( isPlanetStrained == FALSE && Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, newItemIndex, 0) != 0xFFFF )
    {
      return 1;
    }
    // Try replacing existing orbital items if needed
    if ( Q_Race_ReplaceOrbitalPlanetItem_sub_3E020(pRace, pPlanet, newItemIndex) )
    {
      return 1;
    }
    // Fallback replacement options
    if ( newItemIndex != bestShield || bestWeapon == (char)0xFF )
    {
      if ( newItemIndex == bestWeapon && bestShield != (char)0xFF && Q_Race_ReplaceOrbitalPlanetItem_sub_3E020(pRace, pPlanet, bestShield) )
      {
        return 1;
      }
    }
    else if ( Q_Race_ReplaceOrbitalPlanetItem_sub_3E020(pRace, pPlanet, bestWeapon) )
    {
      return 1;
    }
  }
  return 0;
}

//----- (0003E520) --------------------------------------------------------
// Handles advanced planet development and special building construction
// @param pRace The race developing the planet
// @param pPlanet The planet being developed
// @return TRUE if a building was constructed, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Race_HandleAdvancedPlanetDevelopment_sub_3E520(P_Race pRace, P_Planet pPlanet)
{
  MACRO_VFX_BOOL result; // eax
  int minResearchThreshold; // edx
  int planetPopulation; // eax
  int currentSurfaceShiledStrength; // esi
  int surfaceFactor; // edx
  int requiredSurfaceShiledStrength; // eax
  UWORD planetResearch; // di
  int v11; // edx
  __int16 i; // di
  UBYTE specialItemIndex; // si
  char items[5]; // [esp+0h] [ebp-24h]
  UBYTE shieldItemIndex; // [esp+8h] [ebp-1Ch]
  UBYTE candidateItemIndex; // [esp+Ch] [ebp-18h]

  // First priority: Xeno archeological dig if ruins exist
  if ( (pPlanet->flags & ASCEND_PF_02_HAS_XENO_RUINS) != 0
    && Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_38_XENO_ARCHEOLOGICAL_DIG, FALSE) != 0xFFFF )
  {
    result = TRUE;
    pPlanet->flags &= ~2u;
    return result;
  }
  minResearchThreshold = 3;
  // If all techs done, then research value does not matter
  if ( Q_Race_HasDiscoveredAllTechs_sub_40590(pRace) == TRUE )
  {
    minResearchThreshold = 0;
  }
  // Minimum requirements check
  if ( pPlanet->industry < 3u )
  {
    return FALSE;
  }
  if ( pPlanet->research < minResearchThreshold )
  {
    return FALSE;
  }
  if ( pPlanet->prosperity < 2u )
  {
    return FALSE;
  }
  // Population check
  planetPopulation = pPlanet->population;
  if ( pPlanet->maximumPopulation - (unsigned __int16)planetPopulation < 1 && planetPopulation - pPlanet->usedPopulation < 2 )
  {
    return FALSE;
  }
  // Available space check
  if ( pPlanet->freeSurfaceSquaresNum - pPlanet->blackSquaresNum < 3 )
  {
    return FALSE;
  }
  currentSurfaceShiledStrength = Q_Planet_CalculateSurfaceShieldStrength_sub_36158(pPlanet);
  // BUG? requiredSurfaceShiledStrength is greater for non Home Star
  if ( &V_Game.stars[pPlanet->starIndex] == pRace->homeStar )
  {
    surfaceFactor = pPlanet->surfaceSquaresNum;
  }
  else
  {
    surfaceFactor = 2 * pPlanet->surfaceSquaresNum;
  }
  requiredSurfaceShiledStrength = surfaceFactor / 5;
  if ( surfaceFactor / 5 < 4 )
  {
    requiredSurfaceShiledStrength = 4;
  }
  if ( (pPlanet->industry < 20u || pPlanet->research < 20u) && currentSurfaceShiledStrength > 0 )
  {
    planetResearch = pPlanet->research;
    v11 = 3 * currentSurfaceShiledStrength;
    if ( pPlanet->industry <= planetResearch )
    {
      if ( v11 <= 2 * pPlanet->industry )
      {
        goto LABEL_25;
      }
    }
    else if ( v11 <= 2 * planetResearch )
    {
      goto LABEL_25;
    }
    requiredSurfaceShiledStrength = currentSurfaceShiledStrength;
  }
LABEL_25:
  // Build surface shields if needed
  if ( currentSurfaceShiledStrength < requiredSurfaceShiledStrength )
  {
    shieldItemIndex = 0xFF;
    if ( Q_Planet_CanPlaceItem_sub_34368(pPlanet, ASCEND_PI_19_SURFACE_MEGA_SHIELD, 0xFFFFu) )
    {
      shieldItemIndex = ASCEND_PI_19_SURFACE_MEGA_SHIELD;
    }
    else if ( Q_Planet_CanPlaceItem_sub_34368(pPlanet, ASCEND_PI_18_SURFACE_SHIELD, 0xFFFFu) )
    {
      shieldItemIndex = ASCEND_PI_18_SURFACE_SHIELD;
    }
    if ( shieldItemIndex != 0xFF && Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, shieldItemIndex, FALSE) )
    {
      return TRUE;
    }
  }
  // Small chance to build Surface Cloaker (4% chance for ODD-numbered races)
  if ( pPlanet->raceIndex % 2
    && pPlanet->industry > 20u
    && rand() % 100 < 4
    && Q_Planet_CanPlaceItem_sub_34368(pPlanet, ASCEND_PI_11_SURFACE_CLOAKER, 0xFFFFu)
    && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_11_SURFACE_CLOAKER) == 0xFFFF
    && Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_11_SURFACE_CLOAKER, FALSE) )
  {
    return TRUE;
  }
  // Try building special structures:
  // ASCEND_PI_12_HYPERPOWER_PLANT
  // ASCEND_PI_13_FERTILIZATION_PLANT
  // ASCEND_PI_14_INTERNET (if all techs done - BUG?)
  // ASCEND_PI_15_CLONING_PLANT
  // ASCEND_PI_37_LUSH_GROWTH_BOMB (only once)
  *(_DWORD *)items = *(_DWORD *)V_Items;
  items[4] = V_Items[4];
  for ( i = 0; i < 5; ++i )
  {
    candidateItemIndex = items[i];
    if ( (candidateItemIndex != ASCEND_PI_37_LUSH_GROWTH_BOMB || (pPlanet->flags & ASCEND_PF_01_LUSH_GROWTH_BOMBED) == 0)
      && Q_Planet_CanPlaceItem_sub_34368(pPlanet, candidateItemIndex, 0xFFFFu)
      && (Q_Race_HasDiscoveredAllTechs_sub_40590(pRace) == TRUE || candidateItemIndex != ASCEND_PI_14_INTERNET) )
    {
      specialItemIndex = candidateItemIndex;
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, candidateItemIndex) == 0xFFFF )
      {
        if ( Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, specialItemIndex, FALSE) )
        {
          return TRUE;
        }
      }
    }
  }
  return FALSE;
}

//----- (0003E800) --------------------------------------------------------
int __fastcall sub_3E800(_BYTE *a1, unsigned __int16 *edx0)
{
  MACRO_VFX_BOOL v3; // ebx
  int v4; // eax
  int v5; // eax
  int v7; // eax
  int v8; // eax
  int v9; // ebx
  int v10; // ecx
  LONG v11; // [esp+0h] [ebp-1Ch] BYREF
  int a2; // [esp+4h] [ebp-18h] BYREF
  int v13[5]; // [esp+8h] [ebp-14h] BYREF

  Q_Planet_CountBuildableSquaresByColor_sub_34A44((P_Planet)edx0, &a2, &v11, v13);
  v3 = Q_Race_HasDiscoveredAllTechs_sub_40590((P_Race)a1);
  if ( v3 == 0xFFFFFFFF )
  {
    v4 = a2;
    a2 = 0;
    v11 += v4;
    v13[0] += v4;
  }
  v5 = edx0[0x21];
  if ( edx0[0x25] - (unsigned __int16)v5 >= 2 || v5 - edx0[0x26] >= 2 )
  {
    if ( edx0[0x22] < 3u && v11 > 0 )
    {
      return 0;
    }
    if ( edx0[0x23] < 3u && a2 > 0 && v3 == FALSE )
    {
      return 1;
    }
    if ( edx0[0x24] < 2u && v13[0] > 0 )
    {
      return 2;
    }
    if ( edx0[0x22] < 4u && v11 > 0 )
    {
      return 0;
    }
    if ( edx0[0x24] < 3u && v13[0] > 0 )
    {
      return 2;
    }
    if ( edx0[0x23] < 5u && a2 > 0 && v3 == FALSE )
    {
      return 1;
    }
    if ( !edx0[0x24] )
    {
      return 2;
    }
    if ( edx0[0x24] < 2u )
    {
      v7 = edx0[0x21];
      if ( edx0[0x25] - (unsigned __int16)v7 < 1 && v7 - edx0[0x26] < 1 )
      {
        return 2;
      }
    }
    if ( v13[0] > 0 && V_PopGrowthAmount50 / edx0[0x24] > 0xF )
    {
      v8 = edx0[0x21];
      if ( edx0[0x25] - (unsigned __int16)v8 > 3 && v8 - edx0[0x26] != 1 )
      {
        return 2;
      }
    }
    if ( v3 == 0xFFFFFFFF )
    {
      if ( v11 > 0 )
      {
        return 0;
      }
      if ( v13[0] > 0 && edx0[0x24] < 5u )
      {
        return 2;
      }
    }
    else
    {
      HIWORD(v9) = 0;
      LOWORD(v9) = edx0[0x22];
      v10 = edx0[0x23];
      if ( Q_Planet_GetSquareWithItem_sub_35930((P_Planet)edx0, 0xCu) != 0xFFFF )
      {
        v10 += v9 >> 1;
      }
      if ( Q_Planet_GetSquareWithItem_sub_35930((P_Planet)edx0, 0xEu) != 0xFFF )
      {
        v9 += v10 >> 1;
      }
      if ( (v9 > v10 || v11 <= 0) && a2 > 0 )
      {
        return 1;
      }
      if ( v11 > 0 )
      {
        return 0;
      }
      if ( v13[0] > 0 )
      {
        return 2;
      }
    }
  }
  return 3;
}
// 9684C: using guessed type int V_PopGrowthAmount50;
// 3E800: using guessed type int var_14[5];

//----- (0003EA7C) --------------------------------------------------------
__int16 __fastcall sub_3EA7C(P_Race pRace)
{
  int index; // eax
  int word0; // edi
  __int16 j; // si
  __int16 k; // ax
  signed __int16 i; // si
  __int16 v8[32]; // [esp+0h] [ebp-90h]
  __int16 v9[24]; // [esp+40h] [ebp-50h] BYREF
  T_UWordPair v10; // [esp+70h] [ebp-20h]
  T_WordPair v11; // [esp+74h] [ebp-1Ch]

  v10 = 0;
  for ( i = 0; ; ++i )
  {
    LOWORD(index) = V_Research.num;
    if ( i >= (int)V_Research.num )
    {
      break;
    }
    word0 = v10.word0;
    if ( v10.word0 >= 0x20u )
    {
      break;
    }
    if ( ((1 << pRace->index) & V_Research.techs[i].knownToRace) == 0 )
    {
      if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, i, pRace->index) )
      {
        v8[word0] = i;
        v10 = (T_UWordPair)(word0 + 1);
      }
    }
  }
  v11.word0 = 0xFFFF;
  if ( v10.word0 )
  {
    qmemcpy(v9, word_9691E, 0x2Eu);
    if ( ((1 << pRace->index) & V_Research.techs[5].knownToRace) != 0 && rand() % 0x64 < 0x2D )
    {
      v11.word0 = 0xFFFE;
    }
    for ( j = 0; j < (int)v10.word0 && v11.word0 == 0xFFFFFFFF; ++j )
    {
      for ( k = 0; k < 23 && v11.word0 == 0xFFFFFFFF; ++k )
      {
        if ( v9[k] == v8[j] )
        {
          v11.word0 = v8[j];
        }
      }
    }
    if ( v11.word0 < 0 )
    {
      v11.word0 = v8[rand() % v10.word0];
    }
    index = pRace->index;
    V_Research.current.project[index] = v11.word0;
  }
  return index;
}
// 3EA7C: using guessed type __int16 var_90[32];
// 3EA7C: using guessed type __int16 var_50[24];

//----- (0003EBDC) --------------------------------------------------------
void __fastcall sub_3EBDC(P_Race pRace, P_Ship pShip)
{
  UBYTE locationType; // ah
  P_Star pStar; // esi
  int index; // eax
  int v6; // eax
  int v7; // eax
  P_Planet MostInterestingPlanet_sub_403C0; // eax
  int v9; // eax
  int v10; // ecx
  double v11; // st7
  double v12; // st7
  double v13; // st7
  int planetsRacesBits; // eax
  int i; // esi
  P_Star pStar_1; // [esp+4h] [ebp-40h]
  T_Star *v17; // [esp+8h] [ebp-3Ch]
  float v18; // [esp+Ch] [ebp-38h]
  MACRO_VFX_BOOL hasInvasionModule; // [esp+10h] [ebp-34h]
  int shipsRacesBits; // [esp+14h] [ebp-30h]
  float v21; // [esp+20h] [ebp-24h]
  float v22; // [esp+20h] [ebp-24h]
  __int16 v23; // [esp+24h] [ebp-20h]
  __int16 v24; // [esp+28h] [ebp-1Ch]
  unsigned __int8 EnemyRacesMask_sub_43374; // [esp+2Ch] [ebp-18h]

  locationType = pShip->locationType;
  if ( locationType != ASCEND_LOCATION_TYPE_SHIPYARD
    && locationType != ASCEND_LOCATION_TYPE_SHIPDOCK
    && locationType != ASCEND_LOCATION_TYPE_STARLANE )
  {
    if ( pShip->raceIndex == V_PlayerRaceIndex && V_SelfPlayMode == FALSE )
    {
      pShip->order = 0;
      pShip->_orderTargetObject.pPlanet = 0;
      return;
    }
    if ( pShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM && pShip->order == 1 )
    {
      pStar = pShip->pLocation.pStar;
      if ( !pStar )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBBC);
      }
      if ( pShip->hasColonizer )
      {
        index = pStar->index;
        if ( *((char *)&dword_104FD1 + index + 3) > 0 )
        {
          --*((_BYTE *)&dword_104FD1 + index + 3);
        }
      }
      else if ( Q_Ship_HasGizmo_sub_4A534(pShip, ASCEND_GIZMO_73_INVASION_MODULE) )
      {
        v6 = pStar->index;
        if ( *((char *)&dword_104F6D + v6 + 3) > 0 )
        {
          --*((_BYTE *)&dword_104F6D + v6 + 3);
        }
      }
      else
      {
        v7 = pStar->index;
        if ( *((char *)&dword_104F09 + v7 + 3) > 0 )
        {
          --*((_BYTE *)&dword_104F09 + v7 + 3);
        }
      }
      pShip->order = 0;
      pShip->_orderTargetObject.pPlanet = 0;
    }
    if ( !pShip->order )
    {
      if ( pShip->locationType == ASCEND_LOCATION_TYPE_ORBIT && Q_Planet_LaunchShip_sub_35C38(pShip->pLocation.pPlanet, pShip) != 0xFFFFFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBE7);
      }
      if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBEB);
      }
      pStar_1 = pShip->pLocation.pStar;
      if ( !pStar_1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBEF);
      }
      if ( pShip->hasColonizer == 0xFFFFFFFF )
      {
        MostInterestingPlanet_sub_403C0 = Q_Race_GetMostInterestingPlanet_sub_403C0(pRace, pShip->pLocation.pStar);
        if ( MostInterestingPlanet_sub_403C0 )
        {
          pShip->order = 2;
          pShip->_orderTargetObject.pPlanet = MostInterestingPlanet_sub_403C0;
          return;
        }
      }
      if ( pShip->totalStarLaneDrivePotential > 0 || pShip->totalStarLaneHyperdrivePotential > 0 )
      {
        v18 = 0.0;
        v23 = 0;
        v17 = 0;
        hasInvasionModule = Q_Ship_HasGizmo_sub_4A534(pShip, ASCEND_GIZMO_73_INVASION_MODULE);
        EnemyRacesMask_sub_43374 = Q_Race_GetEnemyRacesMask_sub_43374(pRace, 0xFFFFFFFF);
        for ( i = 0; ; ++i )
        {
          if ( i >= V_Game.starsNum )
          {
            if ( v17 && v17 != pStar_1 && Q_Ship_OrderToStar_sub_4AA78(pShip, v17) > 0 && v23 != pStar_1->index )
            {
              if ( pShip->hasColonizer )
              {
                ++*((_BYTE *)&dword_104FD1 + v23 + 3);
              }
              else if ( hasInvasionModule )
              {
                ++*((_BYTE *)&dword_104F6D + v23 + 3);
              }
              else
              {
                ++*((_BYTE *)&dword_104F09 + v23 + 3);
              }
            }
            return;
          }
          if ( dword_104BEC[i] > 0 || dword_104D7C[i] > 0 )
          {
            break;
          }
LABEL_56:
          ;
        }
        v24 = Q_Ship_OrderToStar_sub_4AA78(pShip, &V_Game.stars[i]);
        planetsRacesBits = V_Game.stars[i].planetsRacesBits;
        shipsRacesBits = V_Game.stars[i].shipsRacesBits;
        if ( ((planetsRacesBits | shipsRacesBits) & EnemyRacesMask_sub_43374) != 0 )
        {
          if ( pShip->hasColonizer )
          {
            if ( ((unsigned __int8)planetsRacesBits & EnemyRacesMask_sub_43374) != 0
              && (EnemyRacesMask_sub_43374 & (unsigned __int8)shipsRacesBits) == 0 )
            {
              if ( *((char *)&dword_104FD1 + i + 3) <= 0 )
              {
                v12 = (double)dword_104BEC[i];
                goto LABEL_53;
              }
LABEL_35:
              v21 = 0.0;
              goto LABEL_54;
            }
LABEL_36:
            v21 = 0.0;
            goto LABEL_54;
          }
          if ( hasInvasionModule )
          {
            if ( ((unsigned __int8)planetsRacesBits & EnemyRacesMask_sub_43374) == 0 )
            {
              goto LABEL_35;
            }
            v9 = *((char *)&dword_104F6D + i + 3);
            v21 = (float)dword_104BEC[i];
            if ( v9 <= 1 )
            {
              goto LABEL_54;
            }
            LOBYTE(v10) = v9 - 1;
          }
          else
          {
            if ( ((unsigned __int8)planetsRacesBits & EnemyRacesMask_sub_43374) != 0 )
            {
              v11 = (double)(dword_104D7C[i] + dword_104BEC[i]);
            }
            else
            {
              v11 = (double)dword_104D7C[i];
            }
            v21 = v11;
            if ( *((char *)&dword_104F09 + i + 3) <= 0 )
            {
              goto LABEL_54;
            }
            LOBYTE(v10) = *((_BYTE *)&dword_104F09 + i + 3);
          }
        }
        else
        {
          if ( pShip->hasColonizer )
          {
            if ( *((char *)&dword_104FD1 + i + 3) > 0 )
            {
              goto LABEL_36;
            }
            v12 = (double)dword_104BEC[i];
LABEL_53:
            v21 = v12;
            goto LABEL_54;
          }
          if ( hasInvasionModule )
          {
            v21 = *(float *)&pShip->hasColonizer;
            goto LABEL_54;
          }
          v10 = *((char *)&dword_104F09 + i + 3);
          v21 = (float)dword_104D7C[i];
          if ( v10 <= 0 )
          {
LABEL_54:
            v13 = v21 / (double)(v24 / 25 + 1);
            if ( v13 > v18 )
            {
              v17 = &V_Game.stars[i];
              v23 = i;
              v22 = v13;
              v18 = v22;
            }
            goto LABEL_56;
          }
        }
        v12 = v21 / (double)(1 << v10);
        goto LABEL_53;
      }
    }
  }
}
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];
// 104F09: using guessed type int dword_104F09;
// 104F6D: using guessed type int dword_104F6D;
// 104FD1: using guessed type int dword_104FD1;

//----- (0003EFE0) --------------------------------------------------------
// Calculates the allowed ships for a race based on systems controled.
// The formula is: (1 + exclusively controlled stars + home star bonus) - current ship count
int __fastcall Q_Race_GetMoreAllowedShips_sub_3EFE0(P_Race pRace)
{
  int totalRaceShips; // ebp
  int v3; // kr04_4
  int i; // eax

  totalRaceShips = Q_Race_GetShips_sub_40224(pRace, 0, 0);
  v3 = 0;
  for ( i = 0; (__int16)i < V_Game.starsNum; ++i )
  {
    if ( V_Game.stars[i].planetsRacesBits == 1 << pRace->index )
    {
      // 1 for every exclusively controlled system 
      ++v3;
    }
  }
  return v3 + 1 - totalRaceShips;
}
/* Orphan comments:
Add 1 if have colonies in home system
*/

//----- (0003F060) --------------------------------------------------------
void __fastcall Q_Race_DetermineAndBuildOptimalShip_sub_3F060(P_Race pRace, P_Ship pShip, P_Planet pPlanet, unsigned __int8 a4)
{
  int raceIndexMask; // eax
  __int16 affordableHullSize; // cx
  int cost; // edx
  char gizmoShield; // bl
  char gizmoLane; // bh
  __int16 dayFactor; // [esp+2h] [ebp-24h]
  __int16 wantHullSize; // [esp+6h] [ebp-20h]
  char gizmoGenerator; // [esp+Ah] [ebp-1Ch]
  char gizmoWeapon; // [esp+Eh] [ebp-18h]
  char gizmoDrive; // [esp+12h] [ebp-14h]

  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xCD0);
  }
  wantHullSize = 0;
  raceIndexMask = 1 << pRace->index;
  if ( (raceIndexMask & V_Research.techs[ASCEND_TECH_01_INTERPLANETARY_EXPLORATION].knownToRace) != 0 )
  {
    wantHullSize = 1;
    if ( (raceIndexMask & V_Research.techs[ASCEND_TECH_19_ADVANCED_EXPLORATION].knownToRace) != 0 )
    {
      wantHullSize = 2;
      if ( (raceIndexMask & V_Research.techs[ASCEND_TECH_31_LARGE_SCALE_CONSTRUCTION].knownToRace) != 0 )
      {
        wantHullSize = 3;
      }
    }
  }
  if ( !wantHullSize )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xCE2);
  }
  dayFactor = V_Game.day / 250;
  affordableHullSize = wantHullSize;
  if ( dayFactor >= 1 )
  {
    if ( dayFactor > 8 )
    {
      dayFactor = 8;
    }
  }
  else
  {
    dayFactor = 1;
  }
  while ( affordableHullSize >= 0 )
  {
    Q_Ship_SetSize_sub_49148(pShip, affordableHullSize);
    cost = Q_Ship_GetCost_sub_4A18C(pShip) + pShip->hullCellsNum * dayFactor;
    if ( !pPlanet->industry )
    {
      pPlanet->industry = 1;
    }
    // Races with low patience will settle for smaller ships that build quickly,
    // while races with high patience will wait longer to build larger, more powerful ships.
    if ( cost / pPlanet->industry + 1 < pRace->shipPatience )
    {
      break;
    }
    --affordableHullSize;
  }
  if ( affordableHullSize < 0 )
  {
    affordableHullSize = 0;
  }
  Q_Ship_SetSize_sub_49148(pShip, affordableHullSize);
  gizmoWeapon = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_WEAPON, pRace->index);
  gizmoGenerator = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_GENERATOR, pRace->index);
  gizmoDrive = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_DRIVE, pRace->index);
  gizmoShield = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_SHIELD, pRace->index);
  gizmoLane = ASCEND_GIZMO_43_STAR_LANE_DRIVE;
  if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE) )
  {
    gizmoLane = ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE;
  }
  if ( gizmoGenerator == (char)0xFF )
  {
    gizmoGenerator = ASCEND_GIZMO_27_PROTON_SHAVER;
  }
  if ( gizmoDrive == (char)0xFF )
  {
    gizmoDrive = ASCEND_GIZMO_16_TONKLIN_MOTOR;
  }
  if ( gizmoWeapon == (char)0xFF )
  {
    gizmoWeapon = ASCEND_GIZMO_00_MASS_BARRAGE_GUN;
  }
  if ( gizmoShield == (char)0xFF )
  {
    gizmoShield = ASCEND_GIZMO_10_ION_WRAP;
  }
  switch ( affordableHullSize )
  {
    case 0:
      Q_Race_BuildSmallShip_sub_3F324(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    case 1:
      Q_Race_BuildMediumShip_sub_3F3F8(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    case 2:
      Q_Race_BuildLargeShip_sub_3F784(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    case 3:
      Q_Race_BuildEnormousShip_sub_3FBAC(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    default:
      return;
  }
}
// 3F0F5: conditional instruction was optimized away because %wantHullSize.2 is in (1..3)

//----- (0003F324) --------------------------------------------------------
void __fastcall Q_Race_BuildSmallShip_sub_3F324(
        P_Race pRace,
        char generator,
        char drive,
        char weapon,
        char shield,
        char lane,
        P_Ship pShip,
        unsigned __int8 a8)
{
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, generator, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, drive, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, lane, 2);
  if ( a8 )
  {
    if ( a8 > 1u && a8 == 2 )
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, 3);
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, 4);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, weapon, 3);
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, weapon, 4);
    }
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, 3);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, 4);
  }
}

//----- (0003F3F8) --------------------------------------------------------
void __fastcall Q_Race_BuildMediumShip_sub_3F3F8(
        P_Race pRace,
        char generator,
        char drive,
        char weapon,
        char shield,
        char lane,
        P_Ship pShip,
        unsigned __int8 a8)
{
  int v9; // ecx
  int v10; // edi
  int v11; // ecx
  int v12; // ecx
  int v13; // edx
  char gizmoIndex; // dl
  int v15; // ebx
  int v16; // ebx
  int v17; // ebx
  int v18; // ecx
  int v19; // ecx
  int v20; // ebx
  int v21; // ebx
  int v22; // ecx
  int v23; // edx
  char v24; // dl
  int v25; // ebx
  int v26; // ecx
  int v27; // ebx
  int v28; // ecx
  int v29; // ebx
  int v30; // ecx
  int v31; // edx
  char v32; // dl
  int v33; // ebx

  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, generator, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, generator, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, drive, 2);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, lane, 3);
  v9 = 4;
  if ( pShip->totalGeneratorPower < 8 )
  {
    v9 = 5;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, generator, 4);
  }
  v10 = v9 + 1;
  if ( !a8 )
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, v9);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, v10);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, v9 + 2);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v9 + 3);
    v12 = v9 + 5;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, lane, v10 + 3);
    if ( v10 + 4 >= 10 )
    {
      return;
    }
    while ( 1 )
    {
      v13 = rand() % 100;
      if ( v13 > 75 )
      {
        break;
      }
      if ( v13 > 50 )
      {
        gizmoIndex = shield;
        goto LABEL_17;
      }
      if ( v13 <= 25 )
      {
        gizmoIndex = lane;
        goto LABEL_17;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, v12++);
LABEL_18:
      if ( v12 >= 0xA )
      {
        return;
      }
    }
    gizmoIndex = generator;
LABEL_17:
    v15 = v12++;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, gizmoIndex, v15);
    goto LABEL_18;
  }
  if ( a8 > 1u && a8 == 2 )
  {
    if ( weapon == ASCEND_GIZMO_05_PLASMATRON || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_05_PLASMATRON) )
    {
      v27 = v9;
      v26 = v9 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, weapon, v27);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_05_PLASMATRON, v9);
      v26 = v9 + 1;
    }
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v26);
    v28 = v26 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v28++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v28);
    v29 = v28 + 1;
    v30 = v28 + 2;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, shield, v29);
    if ( v30 >= 0xA )
    {
      return;
    }
    while ( 1 )
    {
      v31 = rand() % 0x64;
      if ( v31 > 0x4B )
      {
        break;
      }
      if ( v31 > 0x32 )
      {
        v32 = shield;
        goto LABEL_48;
      }
      if ( v31 <= 0x19 )
      {
        v32 = lane;
        goto LABEL_48;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v30++);
LABEL_49:
      if ( v30 >= 0xA )
      {
        return;
      }
    }
    v32 = generator;
LABEL_48:
    v33 = v30++;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v32, v33);
    goto LABEL_49;
  }
  if ( weapon == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 5) )
  {
    v16 = v9;
    v11 = v9 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, weapon, v16);
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 5, v9);
    v11 = v9 + 1;
  }
  v17 = v11;
  v18 = v11 + 1;
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, weapon, v17);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, weapon, v18++);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, shield, v18);
  v19 = v18 + 1;
  if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_36_RECALLER) )
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_36_RECALLER, v19++);
  }
  if ( lane == ASCEND_GIZMO_43_STAR_LANE_DRIVE || V_Game.day > 800 || V_Game.racePowerStats[pRace->index].powerGap >= 3 )
  {
    v20 = v19++;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, lane, v20);
  }
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, shield, v19);
  v21 = v19 + 1;
  v22 = v19 + 2;
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v21);
  if ( v22 < 0xA )
  {
    while ( 1 )
    {
      v23 = rand() % 0x64;
      if ( v23 > 0x42 )
      {
        break;
      }
      if ( v23 <= 0x21 )
      {
        v24 = shield;
        goto LABEL_33;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v22++);
LABEL_34:
      if ( v22 >= 0xA )
      {
        return;
      }
    }
    v24 = generator;
LABEL_33:
    v25 = v22++;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v24, v25);
    goto LABEL_34;
  }
}

//----- (0003F784) --------------------------------------------------------
void __fastcall Q_Race_BuildLargeShip_sub_3F784(
        P_Race pRace,
        BYTE a2,
        BYTE a3,
        BYTE a4,
        BYTE a5,
        BYTE a6,
        P_Ship pShip,
        unsigned __int8 a8)
{
  int v8; // esi
  int v9; // ebp
  int v10; // esi
  int v11; // esi
  int v12; // esi
  int v13; // edx
  int v14; // ebx
  int v15; // ebx
  BYTE v16; // dl
  int v17; // ebx
  int v18; // esi
  int v19; // ebx
  int v20; // esi
  int v21; // esi
  int v22; // ecx
  int v23; // esi
  BYTE v24; // dl
  int v25; // esi
  int v26; // ebx
  int v27; // esi
  int v28; // ebx
  int v29; // esi
  int v30; // edx
  int v31; // ebx
  int v32; // ebx
  BYTE v33; // dl

  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 2);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a3, 3);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, 4);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, 5);
  v8 = 6;
  if ( pShip->totalGeneratorPower < 0x10 )
  {
    v8 = 7;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 6);
  }
  v9 = v8 + 1;
  if ( a8 )
  {
    if ( a8 <= 1u || a8 != 2 )
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v8);
      v10 = v8 + 1;
      if ( a4 == 7 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 7) )
      {
        v17 = v10;
        v11 = v10 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v17);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 7, v10);
        v11 = v10 + 1;
      }
      if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 5) )
      {
        v19 = v11;
        v18 = v11 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v19);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 5, v11);
        v18 = v11 + 1;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v18);
      v20 = v18 + 1;
      if ( a6 == ASCEND_GIZMO_43_STAR_LANE_DRIVE )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_43_STAR_LANE_DRIVE, v20++);
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v20);
      v21 = v20 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_57_ACCUTRON) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_57_ACCUTRON, v21++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_36_RECALLER) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_36_RECALLER, v21++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_65_REPLENISHER) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_65_REPLENISHER, v21++);
      }
      v22 = v21 + 2;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_70_PHASE_BOMB, v21);
      v23 = v21 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_35_BRUNSWIK_DISSIPATOR) )
      {
        v24 = 0x23;
      }
      else
      {
        if ( !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_33_MOLECULAR_TIE_DOWN) )
        {
LABEL_40:
          sub_40084(pRace, pShip, v23, a2);
          return;
        }
        v24 = 0x21;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v24, v23);
      v23 = v22;
      goto LABEL_40;
    }
    if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_05_PLASMATRON) )
    {
      v26 = v8;
      v25 = v8 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v26);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 5, v8);
      v25 = v8 + 1;
    }
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v25);
    v27 = v25 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v27++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v27++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v27++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v27);
    v28 = v27 + 1;
    v29 = v27 + 2;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, v28);
    while ( v29 < 0xF )
    {
      v30 = rand() % 0x64;
      if ( v30 <= 0x4B )
      {
        if ( v30 <= 0x32 )
        {
          if ( v30 <= 0x19 )
          {
            v32 = v29;
            v33 = a6;
          }
          else
          {
            v33 = 0x49;
            v32 = v29;
          }
        }
        else
        {
          v32 = v29;
          v33 = a5;
        }
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v33, v32);
        ++v29;
      }
      else
      {
        v31 = v29++;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, v31);
      }
    }
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v8);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v9);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v8 + 2);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v8 + 3);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v8 + 4);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v8 + 5);
    v12 = v8 + 7;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, v9 + 5);
    if ( v9 + 6 < 0xF )
    {
      do
      {
        v13 = rand() % 0x64;
        if ( v13 <= 0x50 )
        {
          if ( v13 <= 0x3C )
          {
            if ( v13 <= 0x28 )
            {
              if ( v13 <= 0x14 )
              {
                v15 = v12;
                v16 = a6;
              }
              else
              {
                v16 = 0x47;
                v15 = v12;
              }
            }
            else
            {
              v16 = 0x49;
              v15 = v12;
            }
          }
          else
          {
            v15 = v12;
            v16 = a5;
          }
          Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v16, v15);
          ++v12;
        }
        else
        {
          v14 = v12++;
          Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, v14);
        }
      }
      while ( v12 < 0xF );
    }
  }
}

//----- (0003FBAC) --------------------------------------------------------
void __fastcall Q_Race_BuildEnormousShip_sub_3FBAC(
        T_Race *eax0,
        char a2,
        char a3,
        char a4,
        char a5,
        char a6,
        _DWORD *pShip,
        unsigned __int8 a8)
{
  int v8; // esi
  int v9; // ebp
  int v10; // ebx
  int v11; // esi
  int v12; // esi
  int v13; // esi
  int v14; // edx
  int v15; // ebx
  int v16; // ebx
  char v17; // dl
  int v18; // ebx
  int v19; // esi
  int v20; // ebx
  int v21; // esi
  int v22; // ebx
  int v23; // esi
  int v24; // esi
  int v25; // ebp
  int v26; // esi
  int v27; // esi
  BYTE v28; // dl
  int v29; // esi
  int v30; // ebx
  int v31; // esi
  int v32; // ebx
  int v33; // esi
  int v34; // edx
  int v35; // ebx
  int v36; // ebx
  char v37; // dl

  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 2);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 3);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a3, 4);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a3, 5);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, 6);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, 7);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a5, 8);
  v8 = 9;
  if ( (int)pShip[6] < 0x18 )
  {
    v8 = 0xA;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 9);
  }
  if ( a6 == 0x2B )
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x2B, v8++);
  }
  v9 = v8 + 1;
  if ( a8 )
  {
    if ( a8 <= 1u || a8 != 2 )
    {
      v10 = v8;
      v11 = v8 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v10);
      if ( a4 == 7 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 7) )
      {
        v18 = v11;
        v12 = v11 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v18);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 7, v11);
        v12 = v11 + 1;
      }
      if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 5) )
      {
        v20 = v12;
        v19 = v12 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v20);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 5, v12);
        v19 = v12 + 1;
      }
      if ( a4 == 8 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 8) )
      {
        v22 = v19;
        v21 = v19 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v22);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 8, v19);
        v21 = v19 + 1;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v21);
      v23 = v21 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v23);
      v24 = v23 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x39) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x39, v24++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x24) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x24, v24++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x41) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x41, v24++);
      }
      v25 = v24 + 4;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x46, v24);
      v26 = v24 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x46, v26++);
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, v26);
      v27 = v26 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x23) )
      {
        v28 = 0x23;
      }
      else
      {
        if ( !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x21) )
        {
LABEL_44:
          sub_40084(eax0, (P_Ship)pShip, v27, a2);
          return;
        }
        v28 = 0x21;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, v28, v27);
      v27 = v25;
      goto LABEL_44;
    }
    if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 5) )
    {
      v30 = v8;
      v29 = v8 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v30);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 5, v8);
      v29 = v8 + 1;
    }
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v29);
    v31 = v29 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a5, v31);
    v32 = v31 + 1;
    v33 = v31 + 2;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, v32);
    while ( v33 < 0x19 )
    {
      v34 = rand() % 0x64;
      if ( v34 <= 0x4B )
      {
        if ( v34 <= 0x32 )
        {
          if ( v34 <= 0x19 )
          {
            v36 = v33;
            v37 = a6;
          }
          else
          {
            v37 = 0x49;
            v36 = v33;
          }
        }
        else
        {
          v36 = v33;
          v37 = a5;
        }
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, v37, v36);
        ++v33;
      }
      else
      {
        v35 = v33++;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, v35);
      }
    }
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v9);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8 + 2);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8 + 3);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8 + 4);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v8 + 5);
    v13 = v8 + 7;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a5, v9 + 5);
    if ( v9 + 6 < 0x19 )
    {
      do
      {
        v14 = rand() % 0x64;
        if ( v14 <= 0x50 )
        {
          if ( v14 <= 0x3C )
          {
            if ( v14 <= 0x28 )
            {
              if ( v14 <= 0x14 )
              {
                v16 = v13;
                v17 = a6;
              }
              else
              {
                v17 = 0x47;
                v16 = v13;
              }
            }
            else
            {
              v17 = 0x49;
              v16 = v13;
            }
          }
          else
          {
            v16 = v13;
            v17 = a5;
          }
          Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, v17, v16);
          ++v13;
        }
        else
        {
          v15 = v13++;
          Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, v15);
        }
      }
      while ( v13 < 0x19 );
    }
  }
}

//----- (00040084) --------------------------------------------------------
void __fastcall sub_40084(P_Race pRace, P_Ship pShip, int startCell, BYTE restGizmoIndex)
{
  __int16 researched; // cx
  __int16 v5; // bx
  int j; // eax
  int v7; // esi
  int v8; // edi
  BYTE v9; // al
  int v10; // ebx
  BYTE rgizmos[28]; // [esp+4h] [ebp-44h]
  BYTE qgizmos[20]; // [esp+20h] [ebp-28h] BYREF
  int k; // [esp+34h] [ebp-14h]
  BYTE restGizmoIndex_; // [esp+38h] [ebp-10h]

  k = startCell;
  restGizmoIndex_ = restGizmoIndex;
  researched = 0;
  v5 = 0;
  qmemcpy(qgizmos, "E?2.-&%\"/74@62&%B=01", sizeof(qgizmos));
  while ( v5 < 20 )
  {
    if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, qgizmos[v5]) )
    {
      j = researched++;
      rgizmos[j] = qgizmos[v5];
    }
    ++v5;
  }
  while ( k < pShip->hullCellsNum && researched )
  {
    v7 = rand() % researched;
    v8 = k + 1;
    --researched;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, rgizmos[v7], k);
    v9 = rgizmos[researched];
    k = v8;
    rgizmos[v7] = v9;
  }
  while ( k < pShip->hullCellsNum )
  {
    v10 = k++;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, restGizmoIndex_, v10);
  }
}

//----- (00040144) --------------------------------------------------------
T_Ship *__fastcall sub_40144(P_Race pRace, P_Planet pPlanet)
{
  T_Ship *vpShip1; // eax
  T_Ship *vpShip2; // ecx
  UWORD industry; // di
  int day; // edx
  unsigned __int16 Cost_sub_4A18C; // [esp+0h] [ebp-14h]

  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF3C);
  }
  if ( Q_Race_GetMoreAllowedShips_sub_3EFE0(pRace) > 0 )
  {
    vpShip1 = sub_20684(&V_Game, pRace->index);
    vpShip2 = vpShip1;
    if ( !vpShip1 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF45);
    }
    Cost_sub_4A18C = Q_Ship_GetCost_sub_4A18C(vpShip1);
    if ( !Cost_sub_4A18C )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF51);
    }
    industry = pPlanet->industry;
    if ( !industry )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF54);
    }
    day = V_Game.day;
    vpShip2->locationType = ASCEND_LOCATION_TYPE_SHIPYARD;
    vpShip2->pLocation.pPlanet = pPlanet;
    vpShip2->_dayBuilt = day + Cost_sub_4A18C / (int)industry + 1;
    return vpShip2;
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\race.cpp", 0xF40);
    return 0;
  }
}
// 401AC: conditional instruction was optimized away because eax.4!=0

//----- (00040218) --------------------------------------------------------
int __fastcall Q_CompareShipsByDayBuilt_sub_40218(P_Ship *ppShip1, P_Ship *ppShip2)
{
  return (*ppShip1)->_dayBuilt - (*ppShip2)->_dayBuilt;
}

//----- (00040224) --------------------------------------------------------
// Builds ships list
// Returns number of ships
int __fastcall Q_Race_GetShips_sub_40224(P_Race pRace, P_ShipsList pShipsList, int *totalSize)
{
  int j; // esi
  int ii; // kr04_4
  int v5; // kr0C_4
  __int16 i; // cx
  int shipsNum; // [esp+8h] [ebp-18h]
  int raceIndex; // [esp+Ch] [ebp-14h]

  j = 0;
  shipsNum = 0;
  if ( totalSize )
  {
    *totalSize = 0;
  }
  ii = 0;
  v5 = 0;
  for ( i = 0; i < 107 && j < V_Game.shipsNum; ++i )
  {
    raceIndex = V_Game.ships[ii].raceIndex;
    if ( raceIndex != 0xFFFFFFFF )
    {
      ++j;
      if ( raceIndex == pRace->index )
      {
        if ( pShipsList )
        {
          pShipsList[v5] = &V_Game.ships[ii];
        }
        ++shipsNum;
        ++v5;
        if ( totalSize )
        {
          *totalSize += V_Game.ships[ii].hullSize + 1;
        }
      }
    }
    ++ii;
  }
  if ( pShipsList )
  {
    qsort(pShipsList, shipsNum, 4u, (int (__fastcall *)(const void *, const void *))Q_CompareShipsByDayBuilt_sub_40218);
  }
  return shipsNum;
}

//----- (000402E0) --------------------------------------------------------
int __fastcall Q_Race_GetPlanetsNum_sub_402E0(P_Race pRace)
{
  int count; // ebx
  int i; // eax

  count = 0;
  for ( i = 0; i < V_Game.planetsNum; ++i )
  {
    if ( V_Game.planets[i].raceIndex == pRace->index )
    {
      ++count;
    }
  }
  return count;
}

//----- (000403C0) --------------------------------------------------------
P_Planet __fastcall Q_Race_GetMostInterestingPlanet_sub_403C0(P_Race pRace, P_Star pStar)
{
  int withBlack; // ebp
  P_Planet pPlanet; // ebx
  unsigned __int16 squaresValue; // ax
  P_Lane pLane; // ecx
  P_Star pStar1; // ebx
  __int16 v8; // ax
  int planetsRacesBits; // ebx
  __int16 v12; // bx
  WORD i; // cx
  P_Planet pPlanet_; // [esp+0h] [ebp-28h]
  unsigned __int16 v15; // [esp+4h] [ebp-24h]
  unsigned __int16 maxValue; // [esp+8h] [ebp-20h]
  __int16 v17; // [esp+Ch] [ebp-1Ch]

  maxValue = 0;
  pPlanet_ = 0;
  v12 = 0;
  if ( V_Game.racesNum > 0 )
  {
    while ( V_Game.races[v12].extinct == 0xFFFFFFFF
         || v12 == pRace->index
         || pRace->treaties[v12] != ASCEND_TREATY_ALLIANCE
         || ((1 << v12) & pStar->planetsRacesBits) == 0 )
    {
      if ( ++v12 >= V_Game.racesNum )
      {
        goto LABEL_9;
      }
    }
    return 0;
  }
LABEL_9:
  withBlack = (pRace->ability != ASCEND_SA_BUILD_ON_BLACK) - 1;
  for ( i = 0; i < pStar->planetsNum; ++i )
  {
    pPlanet = pStar->planets[i];
    if ( pPlanet->raceIndex == 0xFF )
    {
      squaresValue = Q_Planet_GetSquaresValue_sub_3636C(pStar->planets[i], withBlack);
      if ( (pPlanet->flags & 2) != 0 )
      {
        squaresValue += 40;
      }
      if ( squaresValue > maxValue )
      {
        maxValue = squaresValue;
        pPlanet_ = pPlanet;
      }
    }
  }
  v15 = 70;
  if ( pStar->planetsRacesBits )
  {
    v8 = 0;
    if ( V_Game.racesNum > 0 )
    {
      while ( 1 )
      {
        if ( pRace->treaties[v8] == ASCEND_TREATY_WAR )
        {
          planetsRacesBits = pStar->planetsRacesBits;
          if ( ((1 << v8) & planetsRacesBits) != 0 && ((1 << pRace->index) & planetsRacesBits) == 0 )
          {
            break;
          }
        }
        if ( ++v8 >= V_Game.racesNum )
        {
          goto LABEL_34;
        }
      }
      v15 = 0;
    }
  }
  else
  {
    v15 = 35;
    v17 = 0;
    if ( pStar->lanesNum > 0 )
    {
      while ( 1 )
      {
        pLane = pStar->lanes[v17];
        if ( !pLane )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x100E);
        }
        pStar1 = pLane->pStar1;
        if ( pStar == pLane->pStar1 )
        {
          pStar1 = pLane->pStar2;
        }
        if ( ((1 << pRace->index) & pStar1->planetsRacesBits) != 0 )
        {
          break;
        }
        if ( ++v17 >= pStar->lanesNum )
        {
          goto LABEL_34;
        }
      }
      v15 = 17;
    }
  }
LABEL_34:
  if ( maxValue <= v15 )
  {
    return 0;
  }
  return pPlanet_;
}

//----- (00040590) --------------------------------------------------------
// Checks if a race has discovered all available technologies
// @return TRUE if all techs are known, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Race_HasDiscoveredAllTechs_sub_40590(P_Race pRace)
{
  int i; // edx

  if ( !V_AllTechsKnownCache )
  {
    V_AllTechsKnownResult = TRUE;
    // Check each technology in the game
    for ( i = 0; i < V_Research.num; ++i )
    {
      if ( ((1 << pRace->index) & V_Research.techs[i].knownToRace) == 0 )
      {
        // Found unknown tech
        V_AllTechsKnownResult = FALSE;
        break;
      }
    }
    V_AllTechsKnownCache = TRUE;
  }
  return V_AllTechsKnownResult;
}
// 10509C: using guessed type int V_AllTechsKnownCache;

//----- (000405F4) --------------------------------------------------------
unsigned int __fastcall sub_405F4(P_Race pRace)
{
  unsigned int v2; // esi
  WORD v3; // dx
  T_Planet *pPlanet; // eax
  UBYTE raceIndex; // cl

  v2 = 0;
  if ( Q_Race_HasDiscoveredAllTechs_sub_40590(pRace) && V_Game.planetsNum > 0 )
  {
    v3 = 0;
    do
    {
      pPlanet = &V_Game.planets[v3];
      raceIndex = pPlanet->raceIndex;
      if ( raceIndex == pRace->index && (raceIndex != V_PlayerRaceIndex || pPlanet->Unknown_5A || V_SelfPlayMode) )
      {
        if ( sub_3623C(pPlanet) )
        {
          v2 = 0xFFFFFFFF;
        }
      }
      ++v3;
    }
    while ( v3 < V_Game.planetsNum );
  }
  return v2;
}

//----- (00040664) --------------------------------------------------------
int __fastcall Q_Race_GetTechsNum_sub_40664(P_Race ppRace)
{
  int v1; // ebx
  int i; // edx

  v1 = 0;
  for ( i = 0; i < V_Research.num; ++i )
  {
    if ( ((1 << ppRace->index) & V_Research.techs[i].knownToRace) != 0 )
    {
      ++v1;
    }
  }
  return v1;
}

//----- (000406C4) --------------------------------------------------------
int __fastcall sub_406C4(P_Race pRace, P_Star pStar, P_Target pTarget)
{
  UBYTE raceIndex; // cl
  int ShipsAtLocation_sub_1D794; // ebp
  P_Ship v6; // esi
  __int16 v7; // bx
  BYTE order; // dh
  __int16 v9; // ax
  P_Location v10; // ecx
  int v11; // edx
  int v12; // ebx
  char EnemyRacesMask_sub_43374; // cl
  P_Star homeStar; // eax
  unsigned int v15; // ebx
  UBYTE planetsRacesBits; // ch
  __int16 v17; // si
  P_Ship pShip; // ebx
  int GizmoHullCellIndex_sub_4937C; // eax
  int result; // eax
  unsigned __int8 v21; // al
  MACRO_VFX_BOOL v22; // ebp
  int v23; // ebx
  P_Location v24; // esi
  __int16 k; // ax
  int v26; // ebx
  P_Ship vpShip; // esi
  __int16 availablePower; // cx
  __int16 m; // bx
  P_Ship v30; // edx
  P_TargetObject v31; // eax
  int v32; // eax
  int v33; // edx
  P_TargetObject v34; // ebx
  UBYTE v35; // al
  signed __int16 industry; // di
  int y_low; // ecx
  int v38; // eax
  P_Target v39; // eax
  int v40; // eax
  P_Target v41; // eax
  UBYTE v42; // dl
  int state; // eax
  P_Target v44; // eax
  P_Target v45; // eax
  T_Planet *vpPlanet; // ecx
  UBYTE locationType; // bl
  T_Planet *pPlanet; // eax
  int v49; // eax
  UBYTE index; // al
  __int16 v51; // cx
  P_Target v52; // eax
  __int16 v53; // bx
  __int16 v54; // ax
  __int16 i; // cx
  __int16 j; // dx
  __int16 v57; // dx
  P_Ship ships[107]; // [esp+0h] [ebp-3CCh] BYREF
  P_Ship ships2[107]; // [esp+1ACh] [ebp-220h] BYREF
  int v60[5]; // [esp+358h] [ebp-74h] BYREF
  __int16 v61[8]; // [esp+36Ch] [ebp-60h] BYREF
  MACRO_VFX_BOOL v62; // [esp+37Ch] [ebp-50h]
  int v63; // [esp+380h] [ebp-4Ch]
  P_Target v64; // [esp+384h] [ebp-48h]
  int v65; // [esp+388h] [ebp-44h]
  int v66; // [esp+38Ch] [ebp-40h]
  int v67; // [esp+390h] [ebp-3Ch]
  P_Location vpLocation; // [esp+394h] [ebp-38h]
  int v69; // [esp+398h] [ebp-34h]
  int v70; // [esp+39Ch] [ebp-30h]
  __int16 v71; // [esp+3A0h] [ebp-2Ch]
  __int16 v72; // [esp+3A4h] [ebp-28h]
  int v73; // [esp+3A8h] [ebp-24h]
  int v74; // [esp+3ACh] [ebp-20h]
  int v75; // [esp+3B0h] [ebp-1Ch]
  int v76; // [esp+3B4h] [ebp-18h]
  unsigned __int8 v77; // [esp+3B8h] [ebp-14h]

  vpLocation.pStar = pStar;
  v64 = pTarget;
  if ( !pTarget )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1081);
  }
  raceIndex = pRace->index;
  v77 = vpLocation.pStar->planetsRacesBits | vpLocation.pStar->shipsRacesBits;
  if ( ((1 << raceIndex) & v77) == 0 )
  {
    return FALSE;
  }
  sub_3B56C(pRace, vpLocation);
  LOWORD(v76) = 0;
  LOWORD(v73) = 0;
  LOWORD(v74) = 0;
  LOWORD(v70) = 0;
  v65 = 0;
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(vpLocation, ships);
  for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
  {
    v6 = ships[i];
    if ( !v6 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x10AC);
    }
    if ( v6->raceIndex == pRace->index && v6->availablePower > 0 && v6->locationType != ASCEND_LOCATION_TYPE_SHIPYARD )
    {
      v7 = LOWORD(v6->availableMoves) + v70;
      LOWORD(v74) = LOWORD(v6->availablePower) + v74;
      ships2[(__int16)v76] = v6;
      LOWORD(v70) = v7;
      order = v6->order;
      LOWORD(v76) = v76 + 1;
      if ( order )
      {
        v65 = 0xFFFFFFFF;
      }
    }
  }
  v9 = 0;
  if ( SLOWORD(vpLocation.pPlanet->Unknown_5A) > 0 )
  {
    v10.pPlanet = vpLocation.pPlanet;
    do
    {
      v11 = *((_DWORD *)&v10.pPlanet->research + v9);
      if ( *(_BYTE *)(v11 + 0x57) == pRace->index )
      {
        v12 = (__int16)v73;
        LOWORD(v73) = v73 + 1;
        v60[v12] = v11;
      }
      ++v9;
    }
    while ( v9 < SLOWORD(vpLocation.pPlanet->Unknown_5A) );
  }
  if ( !(_WORD)v76 && !(_WORD)v73 )
  {
    return FALSE;
  }
  if ( vpLocation.pPlanet == (P_Planet)pRace->homeStar
    || !(_WORD)v76
    || V_PlayerRaceIndex == pRace->index
    || ((1 << pRace->index) & V_Research.techs[V_Gizmos[0x24].resReq].knownToRace) == 0 )
  {
    goto LABEL_39;
  }
  EnemyRacesMask_sub_43374 = Q_Race_GetEnemyRacesMask_sub_43374(pRace, 0xFFFFFFFF);
  homeStar = pRace->homeStar;
  v15 = 0;
  planetsRacesBits = homeStar->planetsRacesBits;
  if ( (planetsRacesBits & 0x7F) == 0 )
  {
    v15 = 0xFFFFFFFF;
  }
  if ( !v15 )
  {
    v15 = 0;
    if ( ((unsigned __int8)EnemyRacesMask_sub_43374 & (unsigned __int8)(planetsRacesBits | homeStar->shipsRacesBits)) != 0 )
    {
      v15 = 0xFFFFFFFF;
    }
  }
  if ( v15 && (v17 = 0, (__int16)v76 > 0) )
  {
    while ( 1 )
    {
      pShip = ships2[v17];
      if ( pShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
      {
        if ( pShip->availablePower )
        {
          GizmoHullCellIndex_sub_4937C = Q_Ship_FindGizmoHullCellIndex_sub_4937C(ships2[v17], 0x24u);// Recaller
          if ( GizmoHullCellIndex_sub_4937C != 0xFFFFFFFF )
          {
            pShip->Unknown_62 = 1;
            pShip->pCurHullCell = &pShip->hullCells[GizmoHullCellIndex_sub_4937C];
            pShip->_target.type = 5;
            if ( (sub_49B3C(pShip, 0) & 1) != 0 )
            {
              break;
            }
          }
        }
      }
      if ( ++v17 >= (__int16)v76 )
      {
        goto LABEL_39;
      }
    }
    v64->type = 3;
    v64->pObject.pPlanet = (P_Planet)ships2[v17];
    return TRUE;
  }
  else
  {
LABEL_39:
    v21 = 1;
    v22 = FALSE;
    LOWORD(v75) = 0;
    v62 = FALSE;
    for ( j = 0; j < 7; ++j )
    {
      v66 = v21;
      if ( (v21 & v77) != 0 )
      {
        v23 = (__int16)v75;
        v24.pPlanet = vpLocation.pPlanet;
        v61[v23] = j;
        if ( ((unsigned __int8)v66 & HIBYTE(v24.pPlanet->size)) != 0 )
        {
          LOBYTE(v61[v23]) |= 8u;
        }
        if ( (v21 & vpLocation.pPlanet->size) != 0 )
        {
          LOBYTE(v61[(__int16)v75]) |= 0x10u;
        }
        if ( pRace->treaties[j] == 2 )
        {
          if ( V_PlayerRaceIndex != pRace->index || V_SelfPlayMode == TRUE || (HIBYTE(vpLocation.pPlanet->size) & v21) != 0 )
          {
            v22 = TRUE;
            LOBYTE(v61[(__int16)v75]) |= 0x20u;
          }
        }
        else if ( pRace->index != V_PlayerRaceIndex
               && j == V_PlayerRaceIndex
               && ((1 << pRace->index) & (unsigned __int8)byte_D8460[SLOWORD(vpLocation.pPlanet->position.y)]) != 0 )
        {
          v22 = TRUE;
          LOBYTE(v61[(__int16)v75]) |= 0x20u;
        }
        LOWORD(v75) = v75 + 1;
      }
      v21 *= 2;
    }
    if ( (__int16)v75 <= 0 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1133);
    }
    if ( (__int16)v75 == 1 )
    {
      v62 = TRUE;
    }
    if ( v62 == FALSE && v22 == FALSE && (pRace->index != V_PlayerRaceIndex || V_SelfPlayMode == TRUE) )
    {
      LOWORD(v69) = 0;
      do
      {
        v71 = v61[(__int16)v69] & 7;
        if ( pRace->treaties[(unsigned __int8)v71] == ASCEND_TREATY_ALLIANCE )
        {
          for ( k = 0; k < (__int16)v75; ++k )
          {
            v26 = v61[k] & 7;
            if ( V_Game.races[v71].treaties[(unsigned __int8)v26] == ASCEND_TREATY_WAR && pRace->treaties[v26] != ASCEND_TREATY_ALLIANCE )
            {
              v22 = TRUE;
              LOBYTE(v61[k]) |= 0x20u;
            }
          }
        }
        LOWORD(v69) = v69 + 1;
      }
      while ( (__int16)v69 < (__int16)v75 );
    }
    if ( v22 != TRUE
      || V_PlayerRaceIndex == pRace->index && V_SelfPlayMode != TRUE && WinMgr.state != 0x10
      || (result = sub_41268(
                     pRace,
                     v75,
                     (__int16)v76,
                     (int)v61,
                     (P_TargetObject)vpLocation.pPlanet,
                     (int)ships2,
                     v73,
                     (int)v60,
                     (__int16)v74,
                     (__int16)v70,
                     vpLocation.pStar,
                     (int)v64),
          result != TRUE) )
    {
      if ( V_PlayerRaceIndex == pRace->index && !v65 && V_SelfPlayMode == FALSE )
      {
        return FALSE;
      }
      vpShip = 0;
      availablePower = 0;
      for ( m = 0; m < (__int16)v76; ++m )
      {
        if ( !ships2[m]->order && (pRace->index != V_PlayerRaceIndex || V_SelfPlayMode == 0xFFFFFFFF) )
        {
          sub_3EBDC(pRace, ships2[m]);
        }
        v30 = ships2[m];
        if ( availablePower < v30->availablePower && v30->order )
        {
          vpShip = ships2[m];
          availablePower = v30->availablePower;
        }
      }
      if ( !vpShip )
      {
        return FALSE;
      }
      switch ( vpShip->order )
      {
        case ASCEND_SO_1_GOSTAR:
          if ( vpShip->locationType == ASCEND_LOCATION_TYPE_ORBIT )
          {
            Q_Planet_LaunchShip_sub_35C38(vpShip->pLocation.pPlanet, vpShip);
          }
          if ( vpShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1188);
          }
          if ( pRace->index != V_PlayerRaceIndex
            && Q_Star_ShipsAreTravelingTowards_sub_1D834(vpLocation.pStar, pRace->index) == TRUE
            && vpShip->hasColonizer != TRUE
            && Q_Ship_HasGizmo_sub_4A534(vpShip, ASCEND_GIZMO_73_INVASION_MODULE) == TRUE )
          {
            return FALSE;
          }
          v31.pPlanet = (P_Planet)vpShip->_orderTargetObject;
          if ( v31.pPlanet != vpLocation.pPlanet )
          {
            v34.pPlanet = (P_Planet)vpShip->_orderTargetObject;
            v35 = V_Game.starDistanceMatrix[SLOWORD(vpLocation.pPlanet->position.y)][SLOWORD(v31.pPlanet->position.y)];
            v63 = 0;
            industry = vpLocation.pPlanet->industry;
            v72 = v35;
            v57 = 0;
            if ( industry > 0 )
            {
              while ( 1 )
              {
                v67 = *(_DWORD *)&vpLocation.pPlanet->name[4 * v57 + 8];
                if ( vpLocation.pPlanet == *(P_Planet *)v67 )
                {
                  v38 = 0x64 * *(__int16 *)(*(_DWORD *)(v67 + 4) + 4);
                  y_low = SLOWORD(v34.pPlanet->position.y);
                }
                else
                {
                  y_low = 0x64 * *(__int16 *)(*(_DWORD *)v67 + 4);
                  v38 = SLOWORD(v34.pPlanet->position.y);
                }
                if ( V_Game.starDistanceMatrix[0][y_low + v38] == v72 - 1 )
                {
                  break;
                }
                if ( ++v57 >= (__int16)vpLocation.pPlanet->industry )
                {
                  goto LABEL_115;
                }
              }
              v63 = 0xFFFFFFFF;
            }
LABEL_115:
            if ( v63 != 0xFFFFFFFF )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x11CC);
            }
            if ( (*(_BYTE *)(v67 + 0x23) & 2) != 0 && sub_4A480(vpShip, 0, (P_TargetObject)v67) )
            {
              v39 = v64;
              v64->type = 3;
              v39->pObject.pPlanet = (P_Planet)vpShip;
            }
            else
            {
              vpShip->Unknown_62 = 0;
              v40 = v67;
              vpShip->pCurHullCell = 0;
              vpShip->_target.pObject.pPlanet = (P_Planet)v40;
              v41 = v64;
              vpShip->_target.type = 2;
              v41->type = 3;
              v41->pObject.pPlanet = (P_Planet)vpShip;
            }
            goto LABEL_121;
          }
          v32 = (int)vpLocation.pPlanet ^ (int)v31.pPlanet;
          v33 = vpShip->raceIndex;
          LOBYTE(v32) = V_PlayerRaceIndex;
          vpShip->order = 0;
          if ( v33 != v32 || V_SelfPlayMode == TRUE )
          {
            sub_3EBDC(pRace, vpShip);
          }
          result = TRUE;
          break;
        case ASCEND_SO_2_COLONIZE:
          vpPlanet = vpShip->_orderTargetObject.pPlanet;
          if ( !vpShip->hasColonizer )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x123F);
          }
          if ( vpPlanet->raceIndex == 0xFF )
          {
            locationType = vpShip->locationType;
            if ( locationType == 3 )
            {
              pPlanet = vpShip->pLocation.pPlanet;
              if ( vpPlanet == pPlanet )
              {
                v49 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(vpShip, 0x47u);// Colonizer
                if ( v49 == 0xFFFFFFFF )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x125A);
                }
                Q_Ship_RemoveGizmoFromCell_sub_492F8(vpShip, v49);
                index = pRace->index;
                vpPlanet->population = 2;
                vpPlanet->raceIndex = index;
                vpPlanet->dayColonized = V_Game.day;
                Q_Planet_BuildAtOptimalLocation_sub_34AE4(vpPlanet, 5u, 0xFFFFFFFF);// Colony Base
                --vpShip->availablePower;
                LOBYTE(vpLocation.pPlanet->size) |= 1 << pRace->index;
                v51 = v74 - 1;
                vpShip->order = 0;
                LOWORD(v74) = v51;
              }
              else
              {
                Q_Planet_LaunchShip_sub_35C38(pPlanet, vpShip);
                if ( vpShip->locationType != 4 )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1252);
                }
              }
            }
            else
            {
              if ( locationType != 4 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x126C);
              }
              vpShip->Unknown_62 = 0;
              vpShip->pCurHullCell = 0;
              vpShip->_target.type = 1;
              v52 = v64;
              vpShip->_target.pObject.pPlanet = vpPlanet;
              v52->type = 3;
              v52->pObject.pPlanet = (P_Planet)vpShip;
            }
          }
          else
          {
            vpShip->order = 0;
          }
          goto LABEL_121;
        case ASCEND_SO_3_ORBITPLANET:
          if ( vpShip->raceIndex != V_PlayerRaceIndex )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x11F3);
          }
          v42 = vpShip->locationType;
          if ( v42 == 3 )
          {
            if ( vpShip->pLocation.pPlanet != vpShip->_orderTargetObject.pPlanet )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x11F7);
            }
            state = WinMgr.state;
            vpShip->order = 0;
            if ( state != 0x10 )
            {
              Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_16_ENTERED_ORBIT, (int)vpShip, (int)vpShip->_orderTargetObject.pPlanet);
            }
          }
          else if ( v42 == 4 )
          {
            vpShip->Unknown_62 = 0;
            vpShip->pCurHullCell = 0;
            vpShip->_target.pObject.pPlanet = vpShip->_orderTargetObject.pPlanet;
            v44 = v64;
            vpShip->_target.type = 1;
            v44->type = 3;
            v44->pObject.pPlanet = (P_Planet)vpShip;
          }
          else
          {
            vpShip->order = 0;
          }
          goto LABEL_121;
        case ASCEND_SO_7_GOSPACE:
          if ( vpShip->raceIndex != V_PlayerRaceIndex )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x121D);
          }
          if ( vpShip->locationType != 4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x121E);
          }
          if ( (vpShip->Unknown_84 & 8) != 0 )
          {
            vpShip->order = 0;
          }
          else if ( vpShip->Unknown_62 )
          {
            vpShip->order = 0;
          }
          else
          {
            v45 = v64;
            vpShip->_target.type = 3;
            v45->type = 3;
            v45->pObject.pPlanet = (P_Planet)vpShip;
          }
          goto LABEL_121;
        default:
          v53 = v74;
          v54 = vpShip->availablePower;
          vpShip->availableMoves = 0;
          vpShip->availablePower = 0;
          LOWORD(v74) = v53 - v54;
LABEL_121:
          if ( (__int16)v74 <= 0 )
          {
            return FALSE;
          }
          return TRUE;
      }
    }
  }
  return result;
}
// 40BBE: conditional instruction was optimized away because %var_1C.2>=1
// 406C4: using guessed type int var_74[5];

//----- (00041268) --------------------------------------------------------
int __userpurge sub_41268@<eax>(
        T_Race *a1@<eax>,
        __int16 a2@<dx>,
        int ecx0@<ecx>,
        int a4@<ebx>,
        P_TargetObject a5@<ebp>,
        int a6,
        __int16 a7,
        int a8,
        int a9,
        int a10,
        T_Star *a11,
        int a12)
{
  _BYTE *v13; // edx
  int ShipsAtLocation_sub_1D794; // edi
  __int16 j; // ax
  P_Ship v16; // edx
  T_Ship *v17; // esi
  char v18; // cl
  P_Ship v19; // edx
  T_Ship *v20; // eax
  int hasColonizer; // edx
  P_Ship v22; // ebx
  P_Ship v23; // edx
  P_Ship v25; // ecx
  int GizmoHullCellIndex_sub_4937C; // eax
  int v27; // eax
  P_Ship v28; // edx
  P_Ship v29; // edx
  int v30; // esi
  __int16 n; // cx
  int v32; // ebx
  int v33; // esi
  int v34; // eax
  char v35; // bh
  P_Ship v36; // edx
  T_Ship *v37; // ebp
  float *v38; // ebx
  __int16 ii; // si
  P_Ship v40; // edx
  UBYTE locationType; // cl
  T_Ship *v42; // ecx
  double v43; // st7
  double v44; // st7
  int v45; // edx
  WORD planetsNum; // bx
  WORD v47; // cx
  P_Planet v48; // eax
  int raceIndex; // edx
  P_Planet v50; // edi
  P_Race v51; // ebp
  signed __int16 mm; // cx
  P_Ship ShipAtSquare_sub_35A70; // esi
  int v54; // eax
  T_Ship *v55; // ecx
  __int16 nn; // ax
  __int16 v57; // bx
  P_Ship *v58; // eax
  T_Ship *v59; // ecx
  unsigned int v60; // eax
  unsigned int v61; // eax
  T_Ship *v62; // ebp
  T_Ship *v63; // ecx
  double v64; // st7
  char v65; // cl
  P_Ship v66; // ebp
  P_Ship v67; // edx
  int v68; // ebx
  T_Ship *v69; // ebp
  P_Ship v70; // ebx
  P_Ship v71; // edi
  int v72; // eax
  int v73; // eax
  P_Ship v74; // edx
  P_Ship v75; // edx
  P_Lane v76; // eax
  T_Star *pStar2; // eax
  T_Star *v78; // ecx
  __int16 v79; // ax
  UBYTE v80; // dl
  int v81; // esi
  int v82; // eax
  __int16 i4; // bx
  P_Ship v84; // edx
  UBYTE v85; // cl
  int v86; // eax
  __int16 i; // ax
  __int16 kk; // bx
  T_ShipsList ships; // [esp+8h] [ebp-40Ch] BYREF
  char v90; // [esp+1B4h] [ebp-260h]
  T_HullCell *v91; // [esp+1B5h] [ebp-25Fh]
  BYTE type; // [esp+1B9h] [ebp-25Bh]
  P_TargetObject v93; // [esp+1BAh] [ebp-25Ah]
  float x; // [esp+1BEh] [ebp-256h]
  float y; // [esp+1C2h] [ebp-252h]
  float z; // [esp+1C6h] [ebp-24Eh]
  float v97; // [esp+1CAh] [ebp-24Ah]
  float v98; // [esp+1CEh] [ebp-246h]
  float v99; // [esp+1D2h] [ebp-242h]
  int v100; // [esp+1D6h] [ebp-23Eh]
  char Unknown_62; // [esp+1DCh] [ebp-238h]
  T_HullCell *pCurHullCell; // [esp+1DDh] [ebp-237h]
  T_Target target; // [esp+1E1h] [ebp-233h]
  T_Vector3D v104[2]; // [esp+1E6h] [ebp-22Eh] BYREF
  int Unknown_84; // [esp+1FEh] [ebp-216h]
  int v106[3]; // [esp+204h] [ebp-210h] BYREF
  T_Vector3D v107; // [esp+210h] [ebp-204h] BYREF
  T_Vector3D v108; // [esp+21Ch] [ebp-1F8h]
  T_Vector3D v109; // [esp+228h] [ebp-1ECh]
  T_Vector3D v110; // [esp+234h] [ebp-1E0h] BYREF
  float v111; // [esp+240h] [ebp-1D4h]
  float v112; // [esp+244h] [ebp-1D0h]
  float v113; // [esp+248h] [ebp-1CCh]
  T_Vector3D v114; // [esp+24Ch] [ebp-1C8h] BYREF
  int v115[6]; // [esp+258h] [ebp-1BCh] BYREF
  float v116; // [esp+270h] [ebp-1A4h]
  float v117; // [esp+274h] [ebp-1A0h]
  float v118; // [esp+278h] [ebp-19Ch]
  T_Vector3D v119; // [esp+27Ch] [ebp-198h] BYREF
  T_Vector3D v120[2]; // [esp+288h] [ebp-18Ch] BYREF
  float v121; // [esp+2A0h] [ebp-174h]
  float v122; // [esp+2A4h] [ebp-170h]
  float v123; // [esp+2A8h] [ebp-16Ch]
  T_Vector3D v124; // [esp+2ACh] [ebp-168h] BYREF
  T_Vector3D v125; // [esp+2B8h] [ebp-15Ch] BYREF
  float v126; // [esp+2C4h] [ebp-150h]
  float v127; // [esp+2C8h] [ebp-14Ch]
  float v128; // [esp+2CCh] [ebp-148h]
  T_Vector3D v129; // [esp+2D0h] [ebp-144h] BYREF
  T_Vector3D v130[2]; // [esp+2DCh] [ebp-138h] BYREF
  float v131; // [esp+2F4h] [ebp-120h]
  float v132; // [esp+2F8h] [ebp-11Ch]
  float v133; // [esp+2FCh] [ebp-118h]
  float v134; // [esp+300h] [ebp-114h]
  float v135; // [esp+304h] [ebp-110h]
  float v136; // [esp+308h] [ebp-10Ch]
  T_Vector3D v137; // [esp+30Ch] [ebp-108h] BYREF
  P_Ship v138; // [esp+320h] [ebp-F4h]
  P_TargetObject v139; // [esp+324h] [ebp-F0h]
  P_Race v140; // [esp+328h] [ebp-ECh]
  float v141; // [esp+32Ch] [ebp-E8h]
  LONG v142; // [esp+330h] [ebp-E4h] BYREF
  int v143; // [esp+334h] [ebp-E0h]
  P_Ship v144; // [esp+338h] [ebp-DCh]
  P_Ship v145; // [esp+33Ch] [ebp-D8h]
  T_Planet *pPlanet; // [esp+340h] [ebp-D4h]
  int *v147; // [esp+344h] [ebp-D0h]
  float v148; // [esp+348h] [ebp-CCh]
  unsigned int v149; // [esp+34Ch] [ebp-C8h]
  P_Ship pShip; // [esp+350h] [ebp-C4h]
  float v151; // [esp+354h] [ebp-C0h]
  float v152; // [esp+358h] [ebp-BCh]
  int *v153; // [esp+35Ch] [ebp-B8h]
  P_Ship v154; // [esp+360h] [ebp-B4h]
  float v155; // [esp+364h] [ebp-B0h]
  T_Vector3D *v156; // [esp+368h] [ebp-ACh]
  float v157; // [esp+36Ch] [ebp-A8h]
  T_Vector3D *v158; // [esp+370h] [ebp-A4h]
  T_Vector3D *v159; // [esp+374h] [ebp-A0h]
  T_Vector3D *v160; // [esp+378h] [ebp-9Ch]
  MACRO_VFX_BOOL v161; // [esp+37Ch] [ebp-98h] BYREF
  MACRO_VFX_BOOL v162; // [esp+380h] [ebp-94h]
  float v163; // [esp+384h] [ebp-90h]
  P_TargetObject a3; // [esp+388h] [ebp-8Ch]
  float v165; // [esp+38Ch] [ebp-88h]
  T_Vector3D *v166; // [esp+390h] [ebp-84h]
  T_Vector3D *v167; // [esp+394h] [ebp-80h]
  float v168; // [esp+398h] [ebp-7Ch]
  int MaxOrbitalDefenseRange_sub_35ED8; // [esp+39Ch] [ebp-78h]
  T_Vector3D *v170; // [esp+3A0h] [ebp-74h]
  P_Ship v171; // [esp+3A4h] [ebp-70h]
  unsigned int v172; // [esp+3A8h] [ebp-6Ch]
  float v173; // [esp+3ACh] [ebp-68h]
  float v174; // [esp+3B0h] [ebp-64h]
  T_Planet *v175; // [esp+3B4h] [ebp-60h]
  P_Ship v176; // [esp+3B8h] [ebp-5Ch]
  LONG v177; // [esp+3BCh] [ebp-58h] BYREF
  int v178; // [esp+3C0h] [ebp-54h]
  __int16 i2; // [esp+3C4h] [ebp-50h]
  int v180; // [esp+3C8h] [ebp-4Ch]
  __int16 i1; // [esp+3CCh] [ebp-48h]
  int v182; // [esp+3D0h] [ebp-44h]
  int v183; // [esp+3D4h] [ebp-40h]
  int v184; // [esp+3D8h] [ebp-3Ch]
  int v185; // [esp+3DCh] [ebp-38h]
  __int16 m; // [esp+3E0h] [ebp-34h]
  int v187; // [esp+3E4h] [ebp-30h]
  int v188; // [esp+3E8h] [ebp-2Ch]
  __int16 i3; // [esp+3ECh] [ebp-28h]
  __int16 v190; // [esp+3F0h] [ebp-24h]
  __int16 jj; // [esp+3F4h] [ebp-20h]
  __int16 v192; // [esp+3F8h] [ebp-1Ch]
  __int16 k; // [esp+3FCh] [ebp-18h]
  int v194; // [esp+400h] [ebp-14h]
  unsigned __int8 v195; // [esp+404h] [ebp-10h]

  v140 = a1;
  v180 = ecx0;
  Q_Race_CalculateShipsAtLocation_sub_45958(a1, ASCEND_TREATY_WAR, (P_Location)a11, &v142);
  Q_Race_CalculateShipsAtLocation_sub_45958(v140, ASCEND_TREATY_ALLIANCE, (P_Location)a11, &v177);
  Q_Star_CalculateStrategicValueForRace_sub_1DA4C(a11, v140->index, 0, 0xFFFFFFFF);
  sub_1DB70(a11, v140->index, 0, 0xFFFFFFFF);
  v192 = 1;
  if ( ((1 << V_PlayerRaceIndex) & (a11->planetsRacesBits | a11->shipsRacesBits)) == 0 )
  {
    v192 = 1;
  }
  if ( v140->index == V_PlayerRaceIndex && V_SelfPlayMode == FALSE )
  {
    v192 = 1;
  }
  v195 = 0;
  for ( i = 0; i < a2; ++i )
  {
    v13 = (_BYTE *)(a4 + 2 * i);
    if ( (*(_WORD *)v13 & 0x20) != 0 )
    {
      v195 |= 1 << (*v13 & 7);
    }
  }
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)a11, ships);
  v143 = 0;
  for ( j = 0; j < ShipsAtLocation_sub_1D794; ++j )
  {
    v16 = ships[j];
    if ( v16->locationType == 4 && ((1 << v16->raceIndex) & v195) != 0 )
    {
      v143 = 0xFFFFFFFF;
      break;
    }
  }
  if ( !v143 && V_PlayerRaceIndex == v140->index && V_SelfPlayMode == FALSE )
  {
    return 2;
  }
  if ( (_WORD)v180 )
  {
    v17 = 0;
    v144 = 0;
    v154 = 0;
    if ( v192 == 1 )
    {
      if ( v143 )
      {
        memset(v104, 0, sizeof(v104));
        v145 = 0;
        pPlanet = 0;
        LOWORD(v183) = 0;
        if ( (__int16)v180 > 0 )
        {
          do
          {
            v18 = *(_BYTE *)(*(_DWORD *)(a6 + 4 * (__int16)v183) + 0x58);
            a3.pPlanet = *(P_Planet *)(a6 + 4 * (__int16)v183);
            if ( v18 == 4 )
            {
              for ( k = 0; k < ShipsAtLocation_sub_1D794; ++k )
              {
                v149 = 4 * k;
                pShip = ships[v149 / 4];
                if ( (v195 & (1 << pShip->raceIndex)) != 0 )
                {
                  Unknown_62 = pShip->Unknown_62;
                  pCurHullCell = pShip->pCurHullCell;
                  target = pShip->_target;
                  v104[0] = pShip->Unknown_6C;
                  v104[1] = pShip->Unknown_78;
                  Unknown_84 = pShip->Unknown_84;
                  if ( sub_4A480(pShip, 3u, a3) )
                  {
                    Q_Ship_SetAllShieldsState_sub_49A40(a3.pShip, 0xFFFFFFFF);
                    pPlanet = a3.pPlanet;
                    v145 = ships[v149 / 4];
                  }
                  v19 = ships[k];
                  v19->Unknown_62 = Unknown_62;
                  v19->pCurHullCell = pCurHullCell;
                  v19->_target = target;
                  v19->Unknown_6C = v104[0];
                  v19->Unknown_78 = v104[1];
                  v19->Unknown_84 = Unknown_84;
                }
              }
              if ( pPlanet != a3.pPlanet )
              {
                Q_Ship_SetAllShieldsState_sub_49A40(a3.pShip, 0);
              }
            }
            LOWORD(v183) = v183 + 1;
          }
          while ( (__int16)v183 < (__int16)v180 );
        }
        LOWORD(v178) = 0;
        if ( (__int16)v180 > 0 )
        {
          do
          {
            v20 = *(T_Ship **)(a6 + 4 * (__int16)v178);
            hasColonizer = v20->hasColonizer;
            v176 = v20;
            if ( (!hasColonizer || Q_Ship_HasGizmo_sub_4A534(v20, 0x49)) && v176->locationType == 4 && v176->availablePower )
            {
              if ( sub_4A564((int)v176) )
              {
                for ( m = 0; m < ShipsAtLocation_sub_1D794; ++m )
                {
                  v22 = ships[m];
                  if ( (v195 & (1 << v22->raceIndex)) != 0 )
                  {
                    if ( sub_4A480(v176, 3u, (P_TargetObject)v22) )
                    {
                      v23 = v176;
                      *(_BYTE *)a12 = 3;
                      *(_DWORD *)(a12 + 1) = v23;
                      return 0xFFFFFFFF;
                    }
                    v154 = v176;
                  }
                }
              }
              else
              {
                v144 = v176;
              }
            }
            LOWORD(v178) = v178 + 1;
          }
          while ( (__int16)v178 < (__int16)v180 );
        }
        v25 = v154;
        if ( v154 )
        {
          GizmoHullCellIndex_sub_4937C = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v154, 0x39u);
          if ( GizmoHullCellIndex_sub_4937C != 0xFFFFFFFF && (v25->specialEffects & 4) == 0 && v25->availablePower > 0xC )
          {
            v25->Unknown_62 = 1;
            v25->_target.type = 5;
            v25->pCurHullCell = &v25->hullCells[GizmoHullCellIndex_sub_4937C];
            *(_BYTE *)a12 = 3;
            *(_DWORD *)(a12 + 1) = v25;
            sub_49B3C(v25, 0);
            if ( (v25->Unknown_84 & 1) != 0 )
            {
              return 0xFFFFFFFF;
            }
          }
        }
        if ( v144 )
        {
          v27 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v144, 0x41u);
          if ( v27 != 0xFFFFFFFF )
          {
            v28 = v144;
            if ( v144->availablePower > 0xD )
            {
              v144->Unknown_62 = 1;
              v28->_target.type = 5;
              v29 = v144;
              v144->pCurHullCell = &v144->hullCells[v27];
              *(_BYTE *)a12 = 3;
              *(_DWORD *)(a12 + 1) = v29;
              sub_49B3C(v144, 0);
              if ( (v144->Unknown_84 & 1) != 0 )
              {
                return 0xFFFFFFFF;
              }
            }
          }
        }
        v175 = pPlanet;
        if ( pPlanet && sub_43184((int)v140, (int)pPlanet, (int)v145) )
        {
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = pPlanet;
          return 0xFFFFFFFF;
        }
        v30 = 0;
        for ( n = 0; n < (__int16)v180; ++n )
        {
          v32 = *(_DWORD *)(a6 + 4 * n);
          if ( (!*(_DWORD *)(v32 + 0x28) || Q_Ship_HasGizmo_sub_4A534(*(P_Ship *)(a6 + 4 * n), 0x49))
            && *(_BYTE *)(v32 + 0x58) == 4
            && *(_DWORD *)(v32 + 0x88) * *(_DWORD *)v32 * *(_DWORD *)(v32 + 0x8C) > v30 )
          {
            v30 = *(_DWORD *)(v32 + 0x88) * *(_DWORD *)v32 * *(_DWORD *)(v32 + 0x8C);
            v175 = (T_Planet *)v32;
          }
        }
        if ( !v175 )
        {
          return 0;
        }
        if ( !a7 || (v126 = 0.0, v127 = 0.0, v128 = 0.0, LOWORD(v188) = 0, a7 <= 0) )
        {
LABEL_101:
          v37 = 0;
          memset(&v125, 0, sizeof(v125));
          v148 = 99999.0;
          v38 = (float *)((char *)&v175[1].Unknown_22 + 1);
          for ( ii = 0; ii < ShipsAtLocation_sub_1D794; ++ii )
          {
            v40 = ships[ii];
            if ( (v195 & (1 << v40->raceIndex)) != 0 )
            {
              v156 = v120;
              memset(&v129, 0, sizeof(v129));
              v129.x = v40->position.x - *v38;
              v129.y = v40->position.y - v38[1];
              v129.z = v40->position.z - v38[2];
              v120[0] = v129;
              v125 = v129;
              v157 = sqrt(v129.y * v129.y + v129.x * v129.x + v129.z * v129.z);
              locationType = v40->locationType;
              v165 = v157;
              if ( locationType != 4 )
              {
                v165 = v157 + 10000.0;
              }
              if ( v165 < (double)v148 && v165 > 600.0 )
              {
                v37 = v40;
                v148 = v165;
              }
            }
          }
          v42 = (T_Ship *)v175;
          if ( v175 && v37 )
          {
            v158 = &v110;
            memset(&v130[1], 0, sizeof(T_Vector3D));
            v130[1].x = *v38 - v37->position.x;
            v130[1].y = v38[1] - v37->position.y;
            v43 = v38[2] - v37->position.z;
            v110 = v130[1];
            v130[1].z = v43;
            v131 = 0.0;
            v125 = v130[1];
            v132 = 0.0;
            v133 = 0.0;
            MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0xC8 + 0x64;
            v131 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0xC8 + 0x64;
            v132 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0xC8 + 0x64;
            v133 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            v159 = &v137;
            v108.x = v125.x + v131;
            v108.y = v125.y + v132;
            v108.z = v125.z + v133;
            v137 = v108;
            v125 = v108;
            MaxOrbitalDefenseRange_sub_35ED8 = sub_49B68(v42, 1);
            v168 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            if ( v168 < 0.0 )
            {
              MaxOrbitalDefenseRange_sub_35ED8 = sub_49B68(v37, 1);
              v168 = (double)MaxOrbitalDefenseRange_sub_35ED8 * 1.2;
            }
            if ( v168 >= 0.0 )
            {
              Q_Vector3D_SetLength_sub_53054(&v125, v168);
            }
            v160 = v130;
            memset(&v115[3], 0, 0xC);
            *(float *)&v115[3] = v125.x + v37->position.x;
            *(float *)&v115[4] = v125.y + v37->position.y;
            v44 = v125.z + v37->position.z;
            v130[0] = *(T_Vector3D *)&v115[3];
            *(float *)&v115[5] = v44;
            v125 = *(T_Vector3D *)&v115[3];
            v45 = (int)v175;
            *(_BYTE *)a12 = 3;
            *(_DWORD *)(a12 + 1) = v45;
            *(_BYTE *)(v45 + 0x62) = 0;
            *(_BYTE *)(v45 + 0x67) = 3;
            *(_DWORD *)(v45 + 0x63) = 0;
            *(_DWORD *)(v45 + 0x68) = 0;
            *(T_Vector3D *)(v45 + 0x6C) = v125;
            return 0xFFFFFFFF;
          }
          return 0;
        }
LABEL_79:
        v33 = *(_DWORD *)(a8 + 4 * (__int16)v188);
        for ( jj = 0; ; ++jj )
        {
          if ( jj >= (int)*(unsigned __int16 *)(v33 + 0x1A) )
          {
            LOWORD(v188) = v188 + 1;
            if ( (__int16)v188 >= a7 )
            {
              goto LABEL_101;
            }
            goto LABEL_79;
          }
          v34 = 4 * jj + *(_DWORD *)(v33 + 0x10);
          v35 = *(_BYTE *)(v34 + 1);
          if ( v35 != (char)0xFF
            && (*(_WORD *)(v34 + 2) & 1) != 0
            && (V_PlanetItems.item[*(unsigned __int8 *)(v34 + 1)].flags & 4) != 0
            && (v35 != 0x11 || *(_BYTE *)(v33 + 0x58)) )
          {
            v151 = 99999.0;
            for ( kk = 0; kk < ShipsAtLocation_sub_1D794; ++kk )
            {
              v36 = ships[kk];
              if ( (v195 & (1 << v36->raceIndex)) != 0 )
              {
                v153 = v106;
                v116 = 0.0;
                v117 = 0.0;
                v118 = 0.0;
                v116 = *(float *)v33 - v36->position.x;
                v117 = *(float *)(v33 + 4) - v36->position.y;
                v118 = *(float *)(v33 + 8) - v36->position.z;
                *(float *)v106 = v116;
                *(float *)&v106[1] = v117;
                *(float *)&v106[2] = v118;
                v126 = v116;
                v127 = v117;
                v128 = v118;
                v155 = sqrt(v117 * v117 + v116 * v116 + v118 * v118);
                v152 = v155;
                if ( v36->locationType != 4 )
                {
                  v152 = v155 + 10000.0;
                }
                if ( v152 < (double)v151 )
                {
                  a5.pPlanet = (P_Planet)v36;
                  v151 = v152;
                }
              }
            }
            if ( *(_BYTE *)(*(_DWORD *)(v33 + 0x10) + 4 * jj + 1) != 0x11 || v151 >= 1440.0 )
            {
              if ( !a5.pPlanet )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x13E7);
              }
              *(_DWORD *)(v33 + 0x6B) = 4 * jj + *(_DWORD *)(v33 + 0x10);
              *(P_TargetObject *)(v33 + 0x6F) = a5;
              sub_3676C((P_Planet)v33, 0);
              if ( (*(_BYTE *)(v33 + 0x73) & 1) != 0 )
              {
                break;
              }
            }
          }
        }
        *(_BYTE *)a12 = 2;
        *(_DWORD *)(a12 + 1) = v33;
        return 0xFFFFFFFF;
      }
      else
      {
        planetsNum = a11->planetsNum;
        LOWORD(v185) = 0;
        if ( planetsNum <= 0 )
        {
          return 0;
        }
        while ( 1 )
        {
          v48 = a11->planets[(__int16)v185];
          raceIndex = v48->raceIndex;
          if ( raceIndex != 0xFF
            && (_BYTE)raceIndex != v140->index
            && (v140->treaties[raceIndex] == 2
             || V_PlayerRaceIndex == v48->raceIndex && ((1 << v140->index) & (unsigned __int8)byte_D8460[a11->index]) != 0) )
          {
            v50 = a11->planets[(__int16)v185];
            if ( !v48 )
            {
              return 0;
            }
            v51 = v140;
            for ( mm = v48->surfaceSquaresNum; mm < (int)v50->totalSquaresNum; ++mm )
            {
              if ( v50->pSquares[mm].planetItemIndex == 0x17 && Q_Planet_GetShipAtSquare_sub_35A70(v50, mm)->raceIndex == v51->index )
              {
                ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(v50, mm);
                if ( ShipAtSquare_sub_35A70->raceIndex != v51->index )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1468);
                }
                Q_Planet_TryInvade_sub_36CD4(v50, mm, (int *)&v161);
                if ( ShipAtSquare_sub_35A70 != Q_Planet_GetShipAtSquare_sub_35A70(v50, mm) )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x146C);
                }
                v161 = Q_Planet_LaunchShip_sub_35C38(v50, ShipAtSquare_sub_35A70);
                if ( v161 != 0xFFFFFFFF )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x146E);
                }
                return 0xFFFFFFFF;
              }
            }
            v162 = Q_Planet_HasOrbitalDefense_sub_361B8(v50);
            if ( v162 == FALSE )
            {
              LOWORD(v184) = 0;
              if ( (__int16)v180 > 0 )
              {
                do
                {
                  if ( v17 )
                  {
                    break;
                  }
                  v54 = a6 + 4 * (__int16)v184;
                  v55 = *(T_Ship **)v54;
                  if ( *(_BYTE *)(*(_DWORD *)v54 + 0x58) == 4 )
                  {
                    for ( nn = 0; nn < v55->hullCellsNum; ++nn )
                    {
                      if ( v55->hullCells[nn].gizmoIndex == 0x49 )
                      {
                        v17 = v55;
                        break;
                      }
                    }
                  }
                  LOWORD(v184) = v184 + 1;
                }
                while ( (__int16)v184 < (__int16)v180 );
              }
              if ( v17 )
              {
                *(_BYTE *)a12 = 3;
                *(_DWORD *)(a12 + 1) = v17;
                v17->Unknown_62 = 0;
                v17->pCurHullCell = 0;
                v17->_target.type = 1;
                v17->_target.pObject.pPlanet = v50;
                return 0xFFFFFFFF;
              }
              v57 = 0;
              if ( (__int16)v180 > 0 )
              {
                while ( 1 )
                {
                  v58 = (P_Ship *)(a6 + 4 * v57);
                  v59 = *v58;
                  if ( !(*v58)->hasColonizer || Q_Ship_HasGizmo_sub_4A534(*v58, 0x49) )
                  {
                    v60 = 0;
                    if ( v59->order == 1 && v59->_orderTargetObject.pStar == a11 )
                    {
                      v60 = 0xFFFFFFFF;
                    }
                    if ( v59->locationType == 4 && !v60 && Q_Ship_HasGizmo_sub_4A534(v59, 0x46) )
                    {
                      break;
                    }
                  }
                  if ( ++v57 >= (__int16)v180 )
                  {
                    goto LABEL_162;
                  }
                }
                if ( sub_4A480(v59, 1u, (P_TargetObject)v50) )
                {
                  v17 = v59;
                }
              }
LABEL_162:
              if ( v17 )
              {
                *(_BYTE *)a12 = 3;
                *(_DWORD *)(a12 + 1) = v17;
                return 0xFFFFFFFF;
              }
            }
            v61 = 0;
            if ( v50->totalSquaresNum - v50->surfaceSquaresNum > (unsigned __int16)v50->freeOrbitalSquaresNum )
            {
              v61 = 0xFFFFFFFF;
            }
            if ( v162 == 0xFFFFFFFF || v61 == 0xFFFFFFFF )
            {
              break;
            }
          }
          v47 = a11->planetsNum;
          LOWORD(v185) = v185 + 1;
          if ( (__int16)v185 >= v47 )
          {
            return 0;
          }
        }
        v62 = 0;
        LOWORD(v187) = 0;
        if ( (__int16)v180 > 0 )
        {
          do
          {
            if ( v17 )
            {
              break;
            }
            v63 = *(T_Ship **)(a6 + 4 * (__int16)v187);
            if ( (!v63->hasColonizer || Q_Ship_HasGizmo_sub_4A534(*(P_Ship *)(a6 + 4 * (__int16)v187), 0x49))
              && v63->locationType == 4
              && (sub_4A564((int)v63) || Q_Ship_HasGizmo_sub_4A534(v63, 0x46)) )
            {
              v62 = v63;
              if ( sub_4A480(v63, 1u, (P_TargetObject)v50) )
              {
                v17 = v63;
              }
            }
            LOWORD(v187) = v187 + 1;
          }
          while ( (__int16)v187 < (__int16)v180 );
        }
        if ( v17 )
        {
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = v17;
          return 0xFFFFFFFF;
        }
        if ( !v62 )
        {
          return (int)v17;
        }
        memset(&v120[1], 0, sizeof(T_Vector3D));
        v166 = &v107;
        v120[1].x = v62->position.x - v50->position.x;
        v120[1].y = v62->position.y - v50->position.y;
        v120[1].z = v62->position.z - v50->position.z;
        v107 = v120[1];
        v111 = 0.0;
        v112 = 0.0;
        v113 = 0.0;
        MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0x64 + 0x14;
        v111 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0x64 + 0x14;
        v112 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0x64 + 0x14;
        v113 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        v167 = &v114;
        v109.x = v107.x + v111;
        v109.y = v107.y + v112;
        v109.z = v107.z + v113;
        v114 = v109;
        v107 = v109;
        MaxOrbitalDefenseRange_sub_35ED8 = sub_49B68(v62, 2);
        v163 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        if ( v163 < 0.0 )
        {
          MaxOrbitalDefenseRange_sub_35ED8 = Q_Planet_GetMaxOrbitalDefenseRange_sub_35ED8(v50);
          v163 = (double)MaxOrbitalDefenseRange_sub_35ED8 * 1.2;
        }
        if ( v163 >= 0.0 )
        {
          Q_Vector3D_SetLength_sub_53054(&v107, v163);
        }
        v170 = &v119;
        memset(&v124, 0, sizeof(v124));
        v124.x = v107.x + v50->position.x;
        v124.y = v107.y + v50->position.y;
        v64 = v107.z + v50->position.z;
        v119 = v124;
        v124.z = v64;
        v107 = v124;
        *(_BYTE *)a12 = 3;
        *(_DWORD *)(a12 + 1) = v62;
        v62->Unknown_62 = 0;
        v62->_target.type = 3;
        v62->pCurHullCell = 0;
        v62->_target.pObject.pPlanet = 0;
        v62->Unknown_6C = v107;
        return 0xFFFFFFFF;
      }
    }
    else
    {
      x = 0.0;
      y = 0.0;
      z = 0.0;
      v97 = 0.0;
      v98 = 0.0;
      v99 = 0.0;
      LOWORD(v194) = 0;
      if ( (__int16)v180 > 0 )
      {
        do
        {
          if ( v17 )
          {
            break;
          }
          v65 = *(_BYTE *)(*(_DWORD *)(a6 + 4 * (__int16)v194) + 0x58);
          v139.pPlanet = *(P_Planet *)(a6 + 4 * (__int16)v194);
          if ( v65 == 4 )
          {
            for ( i1 = 0; i1 < ShipsAtLocation_sub_1D794 && !v17; ++i1 )
            {
              v66 = ships[i1];
              v172 = 4 * i1;
              if ( (v195 & (1 << v66->raceIndex)) != 0 )
              {
                v90 = v66->Unknown_62;
                v91 = v66->pCurHullCell;
                type = v66->_target.type;
                v93.pPlanet = (P_Planet)v66->_target.pObject;
                x = v66->Unknown_6C.x;
                y = v66->Unknown_6C.y;
                z = v66->Unknown_6C.z;
                v97 = v66->Unknown_78.x;
                v98 = v66->Unknown_78.y;
                v99 = v66->Unknown_78.z;
                v100 = v66->Unknown_84;
                if ( sub_4A480(v66, 3u, v139) )
                {
                  v17 = (T_Ship *)v139.pPlanet;
                  v171 = ships[v172 / 4];
                }
                v67 = ships[i1];
                v67->Unknown_62 = v90;
                v67->pCurHullCell = v91;
                v67->_target.type = type;
                v67->_target.pObject = v93;
                v67->Unknown_6C.x = x;
                v67->Unknown_6C.y = y;
                v67->Unknown_6C.z = z;
                v67->Unknown_78.x = v97;
                v67->Unknown_78.y = v98;
                v67->Unknown_78.z = v99;
                v67->Unknown_84 = v100;
              }
            }
          }
          LOWORD(v194) = v194 + 1;
        }
        while ( (__int16)v194 < (__int16)v180 );
      }
      if ( v17 )
      {
        v68 = (int)v171;
        Q_Ship_SetAllShieldsState_sub_49A40(v17, 0xFFFFFFFF);
        if ( sub_43184((int)v140, (int)v17, v68) )
        {
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = v17;
          return 0xFFFFFFFF;
        }
      }
      LOWORD(v182) = 0;
      if ( (__int16)v180 > 0 )
      {
        do
        {
          if ( v17 )
          {
            break;
          }
          v69 = *(T_Ship **)(a6 + 4 * (__int16)v182);
          if ( v69->locationType == 4 && v69->availablePower )
          {
            if ( sub_4A564(*(_DWORD *)(a6 + 4 * (__int16)v182)) )
            {
              for ( i2 = 0; i2 < ShipsAtLocation_sub_1D794; ++i2 )
              {
                v70 = ships[i2];
                if ( (v195 & (1 << v70->raceIndex)) != 0 )
                {
                  if ( sub_4A480(v69, 3u, (P_TargetObject)v70) )
                  {
                    *(_BYTE *)a12 = 3;
                    *(_DWORD *)(a12 + 1) = v69;
                    return 0xFFFFFFFF;
                  }
                  v154 = v69;
                }
              }
            }
            else
            {
              v144 = v69;
            }
          }
          LOWORD(v182) = v182 + 1;
        }
        while ( (__int16)v182 < (__int16)v180 );
      }
      v71 = v154;
      if ( v154 )
      {
        v72 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v154, 0x39u);
        if ( v72 != 0xFFFFFFFF && (v71->specialEffects & 4) == 0 && v71->availablePower > 0xC )
        {
          v71->Unknown_62 = 1;
          v71->_target.type = 5;
          v71->pCurHullCell = &v71->hullCells[v72];
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = v71;
          sub_49B3C(v71, 0);
          if ( (v71->Unknown_84 & 1) != 0 )
          {
            return 0xFFFFFFFF;
          }
        }
      }
      if ( v144 )
      {
        v73 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v144, 0x41u);
        if ( v73 != 0xFFFFFFFF )
        {
          v74 = v144;
          if ( v144->availablePower > 0xD )
          {
            v144->Unknown_62 = 1;
            v74->_target.type = 5;
            v144->pCurHullCell = &v144->hullCells[v73];
            v75 = v144;
            *(_BYTE *)a12 = 3;
            *(_DWORD *)(a12 + 1) = v75;
            sub_49B3C(v144, 0);
            if ( (v144->Unknown_84 & 1) != 0 )
            {
              return 0xFFFFFFFF;
            }
          }
        }
      }
      v76 = a11->lanes[0];
      if ( v76->pStar1 == a11 )
      {
        pStar2 = v76->pStar2;
      }
      else
      {
        pStar2 = v76->pStar1;
      }
      v78 = pStar2;
      v79 = 0;
      if ( (__int16)v180 > 0 )
      {
        while ( 1 )
        {
          v17 = *(T_Ship **)(a6 + 4 * v79);
          v80 = v17->locationType;
          if ( v80 == 3 )
          {
            break;
          }
          if ( v80 != 4 )
          {
            ++v79;
            v17 = 0;
            if ( v79 < (__int16)v180 )
            {
              continue;
            }
          }
          goto LABEL_240;
        }
        Q_Planet_LaunchShip_sub_35C38(v17->pLocation.pPlanet, *(P_Ship *)(a6 + 4 * v79));
        if ( v17->locationType != 4 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x15E4);
        }
      }
LABEL_240:
      if ( !v17 )
      {
        return (int)v17;
      }
      if ( v17->locationType != 4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x15EF);
      }
      v17->order = 1;
      v17->_orderTargetObject.pPlanet = (P_Planet)v78;
      return 2;
    }
  }
  else
  {
    if ( !a7 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x15FD);
    }
    if ( !v143 )
    {
      return 0;
    }
    v134 = 0.0;
    v135 = 0.0;
    v136 = 0.0;
    v190 = 0;
    if ( a7 > 0 )
    {
      while ( 2 )
      {
        v81 = *(_DWORD *)(a8 + 4 * v190);
        for ( i3 = 0; i3 < (int)*(unsigned __int16 *)(v81 + 0x1A); ++i3 )
        {
          v82 = 4 * i3 + *(_DWORD *)(v81 + 0x10);
          if ( *(_BYTE *)(v82 + 1) != 0xFF
            && (*(_WORD *)(v82 + 2) & 1) != 0
            && (V_PlanetItems.item[*(unsigned __int8 *)(v82 + 1)].flags & 4) != 0
            && (*(_BYTE *)(v82 + 1) != 0x11 || *(_BYTE *)(v81 + 0x58)) )
          {
            v173 = 99999.0;
            for ( i4 = 0; i4 < ShipsAtLocation_sub_1D794; ++i4 )
            {
              v84 = ships[i4];
              if ( (v195 & (1 << v84->raceIndex)) != 0 )
              {
                v147 = v115;
                v121 = 0.0;
                v122 = 0.0;
                v123 = 0.0;
                v121 = *(float *)v81 - v84->position.x;
                v122 = *(float *)(v81 + 4) - v84->position.y;
                v123 = *(float *)(v81 + 8) - v84->position.z;
                *(float *)v115 = v121;
                *(float *)&v115[1] = v122;
                *(float *)&v115[2] = v123;
                v134 = v121;
                v135 = v122;
                v136 = v123;
                v141 = sqrt(v122 * v122 + v121 * v121 + v123 * v123);
                v85 = v84->locationType;
                v174 = v141;
                if ( v85 != 4 )
                {
                  v174 = v141 + 10000.0;
                }
                if ( v174 < (double)v173 )
                {
                  v138 = v84;
                  v173 = v174;
                }
              }
            }
            if ( *(_BYTE *)(*(_DWORD *)(v81 + 0x10) + 4 * i3 + 1) != 0x11 || v173 >= 1440.0 )
            {
              if ( !v138 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1633);
              }
              v86 = (int)v138;
              *(_DWORD *)(v81 + 0x6B) = 4 * i3 + *(_DWORD *)(v81 + 0x10);
              *(_DWORD *)(v81 + 0x6F) = v86;
              sub_3676C((P_Planet)v81, 0);
              if ( (*(_BYTE *)(v81 + 0x73) & 1) != 0 )
              {
                *(_BYTE *)a12 = 2;
                *(_DWORD *)(a12 + 1) = v81;
                return 0xFFFFFFFF;
              }
            }
          }
        }
        if ( ++v190 < a7 )
        {
          continue;
        }
        break;
      }
      return 0;
    }
    else
    {
      return 0;
    }
  }
}
// 42437: conditional instruction was optimized away because esi.4==0

//----- (00043184) --------------------------------------------------------
unsigned int __fastcall sub_43184(int a1, int a2, int a3)
{
  __int16 j; // bx
  int v5; // esi
  __int16 i; // di
  char v8[12]; // [esp+0h] [ebp-2Ch] BYREF
  _DWORD v9[2]; // [esp+Ch] [ebp-20h]
  __int16 v10; // [esp+14h] [ebp-18h]
  int v11; // [esp+18h] [ebp-14h]

  strcpy(v8, "E?2.-&%#!");
  v9[0] = unk_9696C;
  v9[1] = *((_DWORD *)&unk_9696C + 1);
  v10 = *((_WORD *)&unk_9696C + 4);
  if ( Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC((P_Ship)a2) / 2 < *(_DWORD *)(a2 + 0x88) )
  {
    *(_BYTE *)(a2 + 0x62) = 1;
    v11 = a2 + 0xAB;
    for ( i = 0; i < *(_DWORD *)(a2 + 0x15A); ++i )
    {
      if ( V_Gizmos[*(char *)(a2 + 7 * i + 0xAB)].cat == 5 )
      {
        for ( j = 0; j < 0xA; ++j )
        {
          v5 = 7 * i;
          if ( *(_BYTE *)(a2 + v5 + 0xAB) == v8[j] )
          {
            *(_DWORD *)(a2 + 0x63) = v5 + v11;
            *(_BYTE *)(a2 + 0x67) = *((_BYTE *)v9 + j);
            *(_DWORD *)(a2 + 0x68) = a3;
            sub_49B3C((P_Ship)a2, 0);
            if ( (*(_BYTE *)(a2 + 0x84) & 1) != 0 )
            {
              return 0xFFFFFFFF;
            }
          }
        }
      }
    }
  }
  return 0;
}

//----- (00043374) --------------------------------------------------------
// Generates a bitmask of races at war with the specified race, optionally filtered by war likelihood
//  * @param pRace Pointer to the race to check wars for
//  * @param threshold Minimum war likelihood score to include (0-100), or -1 for all wars
//  * @return Bitmask where each set bit indicates a qualifying race at war
char __fastcall Q_Race_GetEnemyRacesMask_sub_43374(P_Race pRace, int threshold)
{
  char enemyRacesMask; // ch
  WORD i; // bx

  enemyRacesMask = 0;
  if ( V_Game.racesNum > 0 )
  {
    i = 0;
    do
    {
      // Check race qualifies:
      // 1. Not the same race
      // 2. Not extinct
      // 3. Currently at war with us
      // 4. Either no threshold (-1) or war likelihood exceeds threshold
      if ( i != pRace->index
        && V_Game.races[i].extinct != TRUE
        && pRace->treaties[i] == ASCEND_TREATY_WAR
        && (threshold == -1u || Q_Race_GetRateFromAttitude_sub_43B7C(pRace, i) > threshold) )
      {
        // Set the corresponding bit in the mask
        enemyRacesMask |= 1 << i;
      }
      ++i;
    }
    while ( i < V_Game.racesNum );
  }
  return enemyRacesMask;
}

//----- (000433E0) --------------------------------------------------------
// Decays diplomatic relations between two races in a star system
MACRO_VFX_BOOL __fastcall Q_Race_DecayRelations_sub_433E0(P_Race pRace, WORD raceIndex, P_Star pStar)
{
  WORD v5; // kr02_2
  __int16 relationDecay; // dx
  int v7; // ebx
  WORD v8; // kr00_2
  WORD newRelationScore; // si
  WORD breakAlliance; // bx

  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1705);
  }
  if ( !pStar )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1706);
  }
  v5 = raceIndex;
  // No relation decay if at war
  if ( pRace->treaties[raceIndex] == ASCEND_TREATY_WAR )
  {
    return FALSE;
  }
  // Calculate base decay amount based on game atmosphere
  relationDecay = 10 * (V_Game.atmosphere + 1);
  // Alliances decay faster than normal relations
  if ( pRace->treaties[v5] == ASCEND_TREATY_ALLIANCE )
  {
    relationDecay = 20 * (V_Game.atmosphere + 1);
  }
  v7 = raceIndex;
  v8 = raceIndex;
  // Apply relation decay
  newRelationScore = pRace->attitudes[raceIndex] - relationDecay;
  pRace->attitudes[v8] = newRelationScore;
  // Prevent alliance score from exceeding maximum
  if ( pRace->treaties[v7] == ASCEND_TREATY_ALLIANCE )
  {
    breakAlliance = pRace->breakAlliance;
    if ( newRelationScore > breakAlliance )
    {
      // Keep score slightly below max to prevent oscillation
      pRace->attitudes[v8] = breakAlliance - 10;
    }
  }
  // Mark this star system as having updated diplomatic status
  byte_D8460[pStar->index] |= 1 << pRace->index;
  return TRUE;
}

//----- (000434E4) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Race_UseAbility_sub_434E4(P_Race pRace, int doUse)
{
  int ability; // eax
  int v4; // ebx
  int Ships_sub_40224; // eax
  int i; // kr04_4
  int newAttitude; // ebx
  int v9; // eax
  int k; // kr18_4
  int ShipsAtLocation_sub_1D794; // eax
  int n; // kr2C_4
  int v13; // kr30_4
  P_Ship v14; // edx
  int raceIndex; // eax
  T_Star *homeStar; // esi
  int v17; // eax
  int jj; // kr40_4
  P_Ship v19; // edx
  unsigned __int16 minPopulation; // cx
  UWORD population; // si
  P_Square pSquares; // kr50_4
  P_Lane pLane; // edx
  T_Star *pStar1; // ecx
  int i2; // eax
  int v26; // edx
  __int16 v27; // bx
  UWORD v28; // dx
  int i6; // eax
  int v30; // ebx
  int v31; // edx
  char v32; // al
  int j; // edx
  int kk; // edx
  int mm; // ebx
  int nn; // esi
  int i3; // edx
  int i4; // edi
  int i5; // edi
  int i7; // edi
  int i8; // eax
  int i9; // edx
  T_ShipsList v43; // [esp+0h] [ebp-6F8h] BYREF
  T_ShipsList v44; // [esp+1ACh] [ebp-54Ch] BYREF
  T_ShipsList v45; // [esp+358h] [ebp-3A0h] BYREF
  T_ShipsList v46; // [esp+504h] [ebp-1F4h] BYREF
  _DWORD v47[3]; // [esp+6B0h] [ebp-48h]
  int m; // [esp+6BCh] [ebp-3Ch]
  P_Race v49; // [esp+6C0h] [ebp-38h]
  MACRO_VFX_BOOL canUseAbility; // [esp+6C4h] [ebp-34h]
  int v51; // [esp+6C8h] [ebp-30h]
  int i1; // [esp+6CCh] [ebp-2Ch]
  T_Planet *pLeastPopulatedPlanet; // [esp+6D0h] [ebp-28h]
  int v54; // [esp+6D4h] [ebp-24h]
  int ii; // [esp+6D8h] [ebp-20h]
  T_Star *stars; // [esp+6DCh] [ebp-1Ch]
  int v57; // [esp+6E0h] [ebp-18h]

  ability = pRace->ability;
  canUseAbility = FALSE;
  if ( V_AbilityDays[ability] <= pRace->daysAfterAbilityUse )
  {
    canUseAbility = TRUE;
    if ( doUse != 1 )
    {
      return canUseAbility;
    }
    v4 = 0;
    v32 = pRace->ability - 5;
    v51 = 0;
    switch ( v32 )
    {
      case 0:
        // The Fludentri are resilient.  You can repair all damage to your ships.
        Ships_sub_40224 = Q_Race_GetShips_sub_40224(pRace, v45, 0);
        if ( Ships_sub_40224 > 0 )
        {
          for ( i = 0; i < Ships_sub_40224; ++i )
          {
            v45[i]->hullIntegrity = v45[i]->fullHullIntegrity;
          }
        }
        break;
      case 1:
        // The Baliflids are disarming diplomats.  You can force all aliens to make
        // peace with you.
        for ( j = 0; j < V_Game.racesNum; ++j )
        {
          if ( &V_Game.races[j] != pRace )
          {
            newAttitude = V_Game.races[j].proposePeace + 20;
            if ( V_Game.races[j].attitudes[pRace->index] < newAttitude )
            {
              V_Game.races[j].attitudes[pRace->index] = newAttitude;
            }
          }
        }
        break;
      case 2:
        // The Swaparamans produce extra power. You can double the power of all
        // your ships.
        v9 = Q_Race_GetShips_sub_40224(pRace, v43, 0);
        if ( v9 > 0 )
        {
          for ( k = 0; k < v9; ++k )
          {
            v43[k]->availablePower *= 2;
          }
        }
        break;
      case 3:
        // The Frutmaka are able to repel.  You can warp alien ships out of your
        // colonies' stars.
        for ( m = 0; V_Game.starsNum > m; ++m )
        {
          if ( ((1 << pRace->index) & V_Game.stars[m].planetsRacesBits) != 0 )
          {
            ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[m], v44);
            if ( ShipsAtLocation_sub_1D794 > 0 )
            {
              v13 = ShipsAtLocation_sub_1D794;
              v57 = 4 * ShipsAtLocation_sub_1D794;
              for ( n = 0; n < v13; ++n )
              {
                v14 = v44[n];
                raceIndex = v14->raceIndex;
                if ( raceIndex != pRace->index && v14->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
                {
                  homeStar = V_Game.races[raceIndex].homeStar;
                  Q_HandleShipDeparture_sub_1D538((P_Location)&V_Game.stars[m], v14);
                  Q_Star_HandleShipArrival_sub_1D3E8(homeStar, v44[n], 0);
                }
              }
            }
          }
        }
        break;
      case 4:
        // The Shevar are power-sappers.  You can wipe out the power of all alien
        // ships in systems you occupy.
        stars = V_Game.stars;
        for ( ii = 0; V_Game.starsNum > ii; ++ii )
        {
          if ( ((1 << pRace->index) & V_Game.stars[ii].shipsRacesBits) != 0 )
          {
            v17 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[ii], v46);
            if ( v17 > 0 )
            {
              for ( jj = 0; jj < v17; ++jj )
              {
                v19 = v46[jj];
                if ( v19->raceIndex != pRace->index )
                {
                  v19->availablePower = 0;
                }
              }
            }
          }
        }
        break;
      case 5:
        // The Govorom are nature-goddesses.  You can turn your least populated
        // colony into a rich world.
        minPopulation = 0xFFFF;
        pLeastPopulatedPlanet = 0;
        for ( kk = 0; kk < V_Game.planetsNum; ++kk )
        {
          if ( V_Game.planets[kk].raceIndex == pRace->index && V_Game.planets[kk].type != 0xA )
          {
            population = V_Game.planets[kk].population;
            if ( minPopulation > population )
            {
              pLeastPopulatedPlanet = &V_Game.planets[kk];
              minPopulation = population;
            }
          }
        }
        if ( pLeastPopulatedPlanet )
        {
          pSquares = pLeastPopulatedPlanet->pSquares;
          for ( mm = 0; mm < pLeastPopulatedPlanet->surfaceSquaresNum; ++mm )
          {
            if ( !pSquares[mm].color || pSquares[mm].color == 1 )
            {
              v47[0] = V_SquareColors[0];
              v47[1] = V_SquareColors[1];
              v47[2] = V_SquareColors[2];
              pSquares[mm].color = v47[rand() % 3];
            }
          }
        }
        break;
      case 6:
        // The Ungooma are mischievous.  You can bump all ships in star lanes
        // backward to their stars of origin.
        for ( nn = 0; nn < V_Game.shipsNum; ++nn )
        {
          if ( V_Game.ships[nn].raceIndex != 0xFFFFFFFF && V_Game.ships[nn].locationType == ASCEND_LOCATION_TYPE_STARLANE )
          {
            pLane = V_Game.ships[nn].pLocation.pLane;
            pStar1 = pLane->pStar1;
            if ( !V_Game.ships[nn].position.y )
            {
              pStar1 = pLane->pStar2;
            }
            Q_Star_HandleShipArrival_sub_1D3E8(pStar1, &V_Game.ships[nn], 0);
          }
        }
        break;
      case 7:
        // The Dubtaks are unsportsmanlike scientists.  You can steal any technology
        // known by at least two other races.
        v54 = 0;
        for ( i1 = 0; V_Research.num > i1; ++i1 )
        {
          v26 = 0;
          for ( i2 = 0; i2 < V_Game.racesNum; ++i2 )
          {
            if ( ((1 << i2) & V_Research.techs[i1].knownToRace) != 0 )
            {
              ++v26;
            }
          }
          if ( v26 >= 2 )
          {
            V_Research.techs[i1].knownToRace |= 1 << pRace->index;
            v27 = i1;
            v28 = V_Research.current.project[pRace->index];
            if ( v28 == i1 )
            {
              V_Research.current.project[pRace->index] = 0xFFFF;
              word_106FB4[pRace->index] = v27 ^ v28;
            }
          }
        }
        break;
      case 8:
        // The Capelons are self-preserving.  You can make all your colonies
        // invincible for one day.
        for ( i3 = 0; i3 < V_Game.planetsNum; ++i3 )
        {
          if ( V_Game.planets[i3].raceIndex == pRace->index )
          {
            V_Game.planets[i3].invincible = TRUE;
          }
        }
        v51 = pRace->daysAfterAbilityUse - V_AbilityDays[pRace->ability];
        break;
      case 9:
        // The Mebes are good at populating.  You can increase the maximum population
        // of all your colonies.
        for ( i4 = 0; i4 < V_Game.planetsNum; ++i4 )
        {
          if ( V_Game.planets[i4].raceIndex == pRace->index )
          {
            V_Game.planets[i4].maximumPopulation2 += 2;
            Q_Planet_CalcPoints_sub_34E70(&V_Game.planets[i4]);
          }
        }
        break;
      case 11:
        // The Arbryls can disrupt the flow of space.  You can block all
        // star lanes entering your colonized systems.
        for ( i5 = 0; i5 < V_Game.starsNum; ++i5 )
        {
          if ( ((1 << pRace->index) & V_Game.stars[i5].planetsRacesBits) != 0 )
          {
            for ( i6 = 0; i6 < V_Game.stars[i5].lanesNum; ++i6 )
            {
              V_Game.stars[i5].lanes[i6]->flags |= ASCEND_LANE_FLAGS_2_BLOCKED;
            }
          }
        }
        break;
      case 12:
        // The Marmosians can create hatred.  You can cause alien species to
        // strongly dislike any species at war with you.
        v49 = pRace;
        for ( i7 = 0; i7 < V_Game.racesNum; ++i7 )
        {
          if ( i7 != pRace->index && pRace->treaties[i7] == ASCEND_TREATY_WAR )
          {
            for ( i8 = 0; i8 < V_Game.racesNum; ++i8 )
            {
              if ( i8 != i7 && i8 != pRace->index && V_Game.races[i8].attitudes[i7] > V_Game.races[i8].declareWar )
              {
                V_Game.races[i8].attitudes[i7] = V_Game.races[i8].declareWar;
              }
            }
          }
        }
        break;
      case 14:
        // The Chamachies are brilliant scientists.  You can immediately achieve any
        // discovery you are pursuing.
        LOBYTE(v4) = pRace->index;
        v30 = v4;
        v31 = V_Research.current.project[v30];
        if ( (unsigned __int16)v31 != 0xFFFF )
        {
          word_106FB4[v30] = V_Research.techs[v31].cost;
        }
        break;
      case 15:
        // The Nimbuloids are extremely productive.  You can boost the progress on
        // all your colonies' projects.
        for ( i9 = 0; i9 < V_Game.planetsNum; ++i9 )
        {
          if ( V_Game.planets[i9].raceIndex == pRace->index && V_Game.planets[i9].buildingPlanetItemIndex != 0xFF )
          {
            V_Game.planets[i9].buildingProgress += 100;
          }
        }
        break;
      default:
        break;
    }
    pRace->daysAfterAbilityUse = v51;
  }
  return canUseAbility;
}
// 106FB4: using guessed type __int16 word_106FB4[7];

//----- (00043B7C) --------------------------------------------------------
// This may be a function that returns the probability of war.
// But there are some inconsistencies in the code.
int __fastcall Q_Race_GetRateFromAttitude_sub_43B7C(P_Race pRace, WORD raceIndex)
{
  int gap; // ebx
  int rate; // edx

  gap = pRace->acceptAlliance - pRace->attitudes[raceIndex];
  if ( gap <= 0 )
  {
    // If attitude greater or equal than ACCEPT_ALLIANCE, then return 100%
    // BUG? May be rate = 0 here?
    rate = 100;
  }
  else
  {
    // Else: the higher attitide - the lower rate
    // Attitide closer to ACCEPT_ALLIANCE gives 0%
    // Attitide closer to DECLARE_WAR gives 100%
    rate = 100 * gap / (pRace->acceptAlliance - pRace->declareWar);
  }
  // Cap maximum at 100%
  if ( rate > 100 )
  {
    return 100;
  }
  return rate;
}

//----- (00043BDC) --------------------------------------------------------
void __fastcall Q_Race_ReadWriteFile_sub_43BDC(P_Race pRace, P_CFile fi, int read)
{
  int homeStar; // eax
  T_Race vRace; // [esp+0h] [ebp-1F4h] BYREF
  P_CFile v6; // [esp+1F0h] [ebp-4h]

  v6 = fi;
  Q_RaceCtor_sub_3B120(&vRace);
  if ( read == TRUE )
  {
    Q_CFile_Read_sub_1BF94(v6, &vRace, 0x1EEu);
    qmemcpy(pRace, &vRace, 0x1ECu);
    HIWORD(pRace->Unknown_1EA) = HIWORD(vRace.Unknown_1EA);
    homeStar = (int)pRace->homeStar;
    pRace->Unknown_19B = 0;
    pRace->homeStar = &V_Game.stars[homeStar];
  }
  else
  {
    qmemcpy(&vRace, pRace, sizeof(vRace));
    vRace.homeStar = (P_Star)vRace.homeStar->index;
    Q_CFile_Write_sub_1C098(v6, &vRace, 0x1EEu);
  }
}

//----- (00043C80) --------------------------------------------------------
void __fastcall Q_Race_LoadDIPFile_sub_43C80(P_Race pRace)
{
  FILE *fp; // ecx
  __int16 v3; // ax
  WORD declareWar; // dx
  __int16 v5; // ax
  WORD acceptPeace; // bx
  __int16 v7; // ax
  WORD proposePeace; // di
  __int16 acceptAlliance_; // ax
  WORD breakAlliance; // dx
  __int16 v11; // ax
  WORD acceptAlliance; // bx
  int species; // [esp-4h] [ebp-11Ch]
  char bufc[204]; // [esp+0h] [ebp-118h] BYREF
  char s[52]; // [esp+CCh] [ebp-4Ch] BYREF
  int bufi; // [esp+100h] [ebp-18h] BYREF

  species = pRace->species;
  V_Day1 = -10;
  V_Day2 = -10;
  V_Day3 = -10;
  sprintf(s, "RACE%02d.DIP", species);
  fp = Q_OpenTextFile_sub_1BB10(s, 0);
  if ( !fp )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x55);
  }
  bufc[0] = 0;
  while ( strncmp(bufc, "DIPVALUES", 9u) )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, bufc);
  }
  // DECLARE_WAR
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->declareWar = bufi;
  // ACCEPT_PEACE
  fscanf(fp, "%s %d", bufc, &bufi);
  v3 = bufi;
  declareWar = pRace->declareWar;
  pRace->acceptPeace = bufi;
  if ( v3 <= declareWar )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x64);
  }
  // PROPOSE_PEACE
  fscanf(fp, "%s %d", bufc, &bufi);
  v5 = bufi;
  acceptPeace = pRace->acceptPeace;
  pRace->proposePeace = bufi;
  if ( v5 <= acceptPeace )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x68);
  }
  // BREAK_ALLIANCE
  fscanf(fp, "%s %d", bufc, &bufi);
  v7 = bufi;
  proposePeace = pRace->proposePeace;
  pRace->breakAlliance = bufi;
  if ( v7 <= proposePeace )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x6C);
  }
  // ACCEPT_ALLIANCE
  fscanf(fp, "%s %d", bufc, &bufi);
  acceptAlliance_ = bufi;
  breakAlliance = pRace->breakAlliance;
  pRace->acceptAlliance = bufi;
  if ( acceptAlliance_ <= breakAlliance )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x70);
  }
  // PROPOSE_ALLIANCE
  fscanf(fp, "%s %d", bufc, &bufi);
  v11 = bufi;
  acceptAlliance = pRace->acceptAlliance;
  pRace->proposeAlliance = bufi;
  if ( v11 <= acceptAlliance )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x74);
  }
  // START_ATTITUDE
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->startAttitude = bufi;
  // SHIP_PATIENCE
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->shipPatience = bufi;
  // BIO_PERIOD
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->bioPeriod = bufi;
  // BIO_MAXPOSITVE
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->bioMaxpositve = bufi;
  // BIO_MAXNEGATIVE
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->bioMaxnegative = bufi;
  // BIO_SIN_X
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->bioSinX = (float)(__int16)bufi;
  // BIO_SIN_HALF_X
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->bioSinHalfX = (float)(__int16)bufi;
  // BIO_SIN_TWICE_X
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->bioSinTwiceX = (float)(__int16)bufi;
  // NEG_PLAYER_TURNS
  fscanf(fp, "%s %d", bufc, &bufi);
  pRace->negPlayerTurns = bufi;
  pRace->ability = pRace->species;
  pRace->daysAfterAbilityUse = 0;
  fclose(fp);
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00044024) --------------------------------------------------------
unsigned int __fastcall sub_44024(_BYTE *a1, char a2)
{
  int exploredBits; // ebx
  int i; // eax
  int v6; // [esp+0h] [ebp-18h]

  v6 = 0;
  for ( i = 0; i < V_Game.starsNum; ++i )
  {
    exploredBits = V_Game.stars[i].exploredBits;
    if ( ((1 << *a1) & exploredBits) != 0 && ((1 << a2) & exploredBits) != 0 )
    {
      return 0xFFFFFFFF;
    }
  }
  return v6;
}

//----- (00044080) --------------------------------------------------------
T_Race *__fastcall sub_44080(P_Race a1)
{
  P_Race v2; // kr08_4
  P_Race v3; // kr00_4
  char v4; // al
  T_Race *result; // eax
  char v6; // al
  int Unknown_1E9; // ecx
  int index; // ebx
  int i; // edi
  char v10; // [esp+0h] [ebp-2Ch]
  int v11; // [esp+4h] [ebp-28h] BYREF
  int v12[9]; // [esp+8h] [ebp-24h] BYREF

  if ( a1->index == V_PlayerRaceIndex && V_SelfPlayMode != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0xCD);
  }
  v12[2] = (int)a1;
  v2 = a1;
  v3 = a1;
  a1->Unknown_1E9 = 0xE;
  v12[1] = (int)V_Game.races;
  for ( i = 0; i < 7; ++i )
  {
    if ( i != a1->index && V_Game.races[i].extinct != 0xFFFFFFFF )
    {
      if ( (i != V_PlayerRaceIndex || V_SelfPlayMode == 0xFFFFFFFF) && !v3->treaties[i] && sub_44024(a1, i) == 0xFFFFFFFF )
      {
        v2->attitudes[i] = a1->startAttitude;
        V_Game.races[i].attitudes[a1->index] = V_Game.races[i].startAttitude;
        V_Game.races[i].treaties[a1->index] = 1;
        v3->treaties[i] = 1;
      }
      if ( v3->treaties[i] )
      {
        v6 = sub_44434(a1, i, &v11);
        if ( v6 != 0xE )
        {
          if ( i != V_PlayerRaceIndex || V_SelfPlayMode )
          {
            v10 = v6;
            v4 = sub_44BCC(&V_Game.races[i], (__int16 *)a1->index, v6, v11, v12);
            sub_450B0(a1, i, v10, v4, v11, v12[0]);
          }
          else
          {
            a1->Unknown_1E9 = v6;
            Unknown_1E9 = a1->Unknown_1E9;
            index = a1->index;
            a1->Unknown_1EA = v11;
            Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_02_WOULD_LIKE_TO_SPEAK, index, Unknown_1E9);
          }
        }
      }
    }
    result = &V_Game.races[i + 1];
  }
  return result;
}

//----- (00044238) --------------------------------------------------------
int __fastcall sub_44238(int a1, __int16 a2, _BYTE *a3, __int16 a4)
{
  T_Race *v7; // edi
  int v8; // ecx
  char v9; // kr00_1
  _BYTE *v10; // eax
  int result; // eax
  int v12; // eax
  int v13; // eax
  int v14; // ecx
  int v15; // eax
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // ecx
  int v20; // eax
  _BYTE *v21; // [esp+4h] [ebp-10h]

  *a3 = 0xE;
  v7 = &V_Game.races[a2];
  v8 = 1;
  v9 = *(_BYTE *)(a1 + a2 + 0x1C0);
  v21 = a3 + 2;
  v10 = a3 + 1;
  switch ( v9 )
  {
    case 0:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x126);
      result = 1;
      break;
    case 1:
      *v10 = 2;
      *v21 = 3;
      v8 = 3;
      if ( V_Game.day - V_Day1 >= 5 )
      {
        v8 = 4;
        a3[3] = 4;
      }
      if ( V_Game.day - V_Day2 >= 5 )
      {
        v12 = (__int16)v8++;
        a3[v12] = 5;
      }
      if ( V_Game.day - V_Day3 >= 5 )
      {
        v13 = (__int16)v8++;
        a3[v13] = 6;
      }
      if ( !*(_BYTE *)(a1 + a4 + 0x1C0) || v7->treaties[a4] != 2 )
      {
        goto LABEL_29;
      }
      a3[(__int16)v8] = 7;
      result = v8 + 1;
      break;
    case 2:
      *v10 = 0xD;
      result = 2;
      break;
    case 3:
      *v10 = 8;
      v14 = 2;
      if ( V_Game.day - V_Day1 >= 5 )
      {
        v14 = 3;
        *v21 = 4;
      }
      if ( V_Game.day - V_Day2 >= 5 )
      {
        v15 = (__int16)v14++;
        a3[v15] = 5;
      }
      if ( V_Game.day - V_Day3 >= 5 )
      {
        v16 = (__int16)v14++;
        a3[v16] = 6;
      }
      a3[(__int16)v14] = 0xC;
      v8 = v14 + 1;
      if ( *(_BYTE *)(a1 + a4 + 0x1C0) && v7->treaties[a4] == 2 )
      {
        v17 = (__int16)v8++;
        a3[v17] = 7;
      }
      if ( *(_BYTE *)(a1 + a4 + 0x1C0) && v7->treaties[a4] == 1 )
      {
        v18 = (__int16)v8;
        v19 = v8 + 1;
        a3[v18] = 9;
        v20 = (__int16)v19;
        v8 = v19 + 1;
        a3[v20] = 0xB;
      }
      if ( !*(_BYTE *)(a1 + a4 + 0x1C0) || v7->treaties[a4] != 3 )
      {
        goto LABEL_29;
      }
      a3[(__int16)v8] = 0xA;
      result = v8 + 1;
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x17E);
LABEL_29:
      result = v8;
      break;
  }
  return result;
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00044434) --------------------------------------------------------
char __fastcall sub_44434(P_Race pRace, __int16 a2, _DWORD *a3)
{
  char EnemyRacesMask_sub_43374; // bh
  BYTE v6; // bl
  __int16 v8; // dx
  __int16 v9; // ax
  __int16 v10; // dx
  int v11; // [esp+0h] [ebp-18h]

  if ( pRace->index == V_PlayerRaceIndex && V_SelfPlayMode != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x18D);
  }
  EnemyRacesMask_sub_43374 = Q_Race_GetEnemyRacesMask_sub_43374(pRace, 0xFFFFFFFF);
  v6 = pRace->treaties[a2];
  if ( (unsigned __int8)v6 < 2u )
  {
    if ( v6 == 1 )
    {
      if ( V_Game.atmosphere )
      {
        if ( V_Game.atmosphere <= 1u )
        {
          if ( pRace->attitudes[a2] < pRace->declareWar && a2 == V_PlayerRaceIndex )
          {
            return 2;
          }
        }
        else if ( V_Game.atmosphere == 2 )
        {
          if ( pRace->attitudes[a2] < pRace->acceptPeace && a2 == V_PlayerRaceIndex )
          {
            pRace->attitudes[a2] = pRace->declareWar - 1;
            return 2;
          }
          if ( pRace->proposePeace > pRace->attitudes[a2] && a2 == V_PlayerRaceIndex )
          {
            pRace->attitudes[a2] = pRace->acceptPeace - 1;
          }
          else if ( pRace->breakAlliance > pRace->attitudes[a2] && a2 == V_PlayerRaceIndex )
          {
            pRace->attitudes[a2] = pRace->proposePeace - 1;
          }
          else if ( pRace->acceptAlliance > pRace->attitudes[a2] && a2 == V_PlayerRaceIndex )
          {
            pRace->attitudes[a2] = pRace->breakAlliance - 1;
          }
          else if ( pRace->proposeAlliance > pRace->attitudes[a2] && a2 == V_PlayerRaceIndex )
          {
            pRace->attitudes[a2] = pRace->acceptAlliance - 1;
          }
          else if ( a2 == V_PlayerRaceIndex )
          {
            pRace->attitudes[a2] = pRace->proposeAlliance - 1;
          }
        }
      }
      else if ( pRace->attitudes[a2] < pRace->declareWar
             && (!EnemyRacesMask_sub_43374 || a2 == V_PlayerRaceIndex)
             && (a2 == V_PlayerRaceIndex || V_Game.racePowerStats[pRace->index].planetsNum > 2) )
      {
        return 2;
      }
      if ( pRace->proposeAlliance < pRace->attitudes[a2] )
      {
        return 3;
      }
    }
  }
  else if ( (unsigned __int8)v6 <= 2u )
  {
    if ( pRace->attitudes[a2] > pRace->proposePeace )
    {
      return 0xD;
    }
  }
  else
  {
    if ( v6 != 3 )
    {
      goto LABEL_51;
    }
    if ( pRace->attitudes[a2] < pRace->declareWar && !EnemyRacesMask_sub_43374 )
    {
      if ( a2 == V_PlayerRaceIndex || V_Game.racePowerStats[pRace->index].planetsNum > 2 )
      {
        return 2;
      }
      return 8;
    }
    if ( pRace->breakAlliance > pRace->attitudes[a2] )
    {
      return 8;
    }
  }
LABEL_51:
  if ( V_Game.day % pRace->negPlayerTurns || a2 != V_PlayerRaceIndex || pRace->treaties[a2] == 2 )
  {
    return 0xE;
  }
  v11 = rand() % 0x64;
  if ( a2 != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x212);
  }
  if ( pRace->treaties[a2] != 3 || v11 >= 0x50 )
  {
LABEL_85:
    if ( pRace->declareWar <= pRace->attitudes[a2] )
    {
      if ( pRace->treaties[a2] == 3 )
      {
        v11 += 0xF;
      }
      if ( pRace->attitudes[a2] > pRace->breakAlliance + 0xA && v11 >= 0x5D && sub_46208(pRace, a2) )
      {
        return 6;
      }
      if ( pRace->breakAlliance < pRace->attitudes[a2] && v11 >= 0x58 && sub_46034(pRace, a2) )
      {
        return 5;
      }
      if ( pRace->attitudes[a2] > pRace->startAttitude + 0x14 && v11 >= 0x50 && sub_45E64(pRace, a2) )
      {
        return 4;
      }
    }
    return 0xE;
  }
  v8 = 0;
  if ( V_Game.racesNum > 0 )
  {
    while ( v8 == pRace->index
         || v8 == a2
         || V_Game.races[v8].extinct == 0xFFFFFFFF
         || pRace->treaties[v8] != 2
         || V_Game.races[V_PlayerRaceIndex].treaties[v8] != 3 )
    {
      if ( ++v8 >= V_Game.racesNum )
      {
        goto LABEL_67;
      }
    }
    *a3 = v8;
    return 0xA;
  }
  else
  {
LABEL_67:
    v9 = 0;
    if ( V_Game.racesNum > 0 )
    {
      while ( v9 == pRace->index
           || v9 == a2
           || V_Game.races[v9].extinct == 0xFFFFFFFF
           || pRace->treaties[v9] != 3
           || V_Game.races[V_PlayerRaceIndex].treaties[v9] != 2 )
      {
        if ( ++v9 >= V_Game.racesNum )
        {
          goto LABEL_76;
        }
      }
      *a3 = v9;
      return 7;
    }
    else
    {
LABEL_76:
      v10 = 0;
      if ( V_Game.racesNum <= 0 )
      {
        goto LABEL_85;
      }
      while ( v10 == pRace->index
           || v10 == a2
           || V_Game.races[v10].extinct == 0xFFFFFFFF
           || pRace->treaties[v10] != 2
           || V_Game.races[V_PlayerRaceIndex].treaties[v10] != 1 )
      {
        if ( ++v10 >= V_Game.racesNum )
        {
          goto LABEL_85;
        }
      }
      *a3 = v10;
      return 9;
    }
  }
}

//----- (00044A2C) --------------------------------------------------------
int __fastcall sub_44A2C(_BYTE *a1, int a2, char a3, _BYTE *a4)
{
  _BYTE *v4; // eax
  int result; // eax

  if ( *a1 != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x263);
  }
  v4 = a4 + 1;
  switch ( a3 )
  {
    case 0:
      *a4 = 0;
      result = 1;
      break;
    case 1:
      *a4 = 1;
      *v4 = 2;
      result = 2;
      break;
    case 2:
      *a4 = 3;
      result = 1;
      break;
    case 3:
      *a4 = 4;
      *v4 = 5;
      result = 2;
      break;
    case 4:
      *a4 = 6;
      *v4 = 7;
      result = 2;
      break;
    case 5:
      *a4 = 8;
      *v4 = 9;
      result = 2;
      break;
    case 6:
      *a4 = 0xA;
      *v4 = 0xB;
      result = 2;
      break;
    case 7:
      *a4 = 0xC;
      *v4 = 0xD;
      result = 2;
      break;
    case 8:
      *a4 = 0xE;
      result = 1;
      break;
    case 9:
      *a4 = 0xF;
      *v4 = 0x10;
      result = 2;
      break;
    case 0xA:
      *a4 = 0x11;
      *v4 = 0x12;
      result = 2;
      break;
    case 0xB:
      *a4 = 0x13;
      *v4 = 0x14;
      result = 2;
      break;
    case 0xC:
      *a4 = 0x15;
      *v4 = 0x16;
      result = 2;
      break;
    case 0xD:
      *a4 = 0x1B;
      *v4 = 0x1C;
      result = 2;
      break;
    case 0xE:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x2CF);
      result = 0xE;
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x2D4);
      JUMPOUT(0x44B91);
  }
  return result;
}
// 44B8C: control flows out of bounds to 44B91

//----- (00044BCC) --------------------------------------------------------
char __fastcall sub_44BCC(T_Race *a1, __int16 *a2, char a3, int a4, int *a5)
{
  WORD v7; // di
  int v8; // ebx
  const char *v9; // edx
  int v10; // [esp+0h] [ebp-1B8h] BYREF

  a1->Unknown_1EA = a4;
  switch ( a3 )
  {
    case 2:
      return 3;
    case 3:
      if ( a1->attitudes[(__int16)a2] <= a1->acceptAlliance )
      {
        return 5;
      }
      else
      {
        return 4;
      }
    case 4:
      if ( a1->attitudes[(__int16)a2] > a1->startAttitude + 0x14 && sub_45E64(a1, (__int16)a2) )
      {
        return 6;
      }
      else
      {
        return 7;
      }
    case 5:
      if ( a1->breakAlliance < a1->attitudes[(__int16)a2] && sub_46034(a1, (__int16)a2) )
      {
        return 8;
      }
      else
      {
        return 9;
      }
    case 6:
      if ( a1->attitudes[(__int16)a2] > a1->breakAlliance + 0xA && sub_46208(a1, (__int16)a2) )
      {
        return 0xA;
      }
      else
      {
        return 0xB;
      }
    case 7:
      if ( a1->treaties[a4] != 2 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x336);
      }
      if ( a1->attitudes[a4] + (__int16)(a1->attitudes[(__int16)a2] - V_Game.races[(__int16)a2].acceptAlliance) <= a1->proposePeace )
      {
        return 0xD;
      }
      else
      {
        return 0xC;
      }
    case 8:
      return 0xE;
    case 9:
      if ( a1->treaties[(__int16)a2] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x34A);
      }
      if ( a1->treaties[a4] != 1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x34B);
      }
      if ( (__int16)(a1->attitudes[(__int16)a2] - a1->attitudes[a4]) <= a1->startAttitude )
      {
        return 0x10;
      }
      else
      {
        return 0xF;
      }
    case 0xA:
      if ( a1->treaties[(__int16)a2] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x361);
      }
      if ( a1->treaties[a4] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x362);
      }
      v7 = a1->attitudes[a4];
      if ( (__int16)(a1->attitudes[(__int16)a2] - v7) <= 0
        || (__int16)(a1->attitudes[(__int16)a2] - V_Game.races[(__int16)a2].acceptAlliance)
         - (__int16)(v7 - V_Game.races[a4].acceptAlliance) <= 0 )
      {
        return 0x12;
      }
      else
      {
        return 0x11;
      }
    case 0xB:
      if ( a1->treaties[(__int16)a2] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x384);
      }
      if ( a1->treaties[a4] != 1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x385);
      }
      if ( a1->attitudes[a4] - (__int16)(a1->attitudes[(__int16)a2] - V_Game.races[(__int16)a2].acceptAlliance) >= a1->declareWar )
      {
        return 0x14;
      }
      else
      {
        return 0x13;
      }
    case 0xC:
      if ( !a4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x39D);
      }
      if ( a5 )
      {
        *a5 = a4;
      }
      if ( !Q_Race_CalculateShipsAtLocation_sub_45958(a1, 2, (P_Location)a4, 0) )
      {
        return 0x18;
      }
      if ( (unsigned __int16)sub_45848(&a1->index, a4, (int)&v10, a2) )
      {
        if ( ((1 << a1->index) & *(unsigned __int8 *)(a4 + 0x15)) != 0 )
        {
          return 0x1A;
        }
        else if ( a1->proposeAlliance >= a1->attitudes[(__int16)a2] )
        {
          return 0x16;
        }
        else
        {
          return 0x15;
        }
      }
      else if ( ((1 << a1->index) & *(unsigned __int8 *)(a4 + 0x15)) != 0 )
      {
        return 0x19;
      }
      else
      {
        return 0x17;
      }
    case 0xD:
      if ( a1->attitudes[(__int16)a2] < a1->acceptPeace )
      {
        return 0x1C;
      }
      else
      {
        return 0x1B;
      }
    case 0xE:
      v8 = 0x3CE;
      v9 = "..\\raceneg.cpp";
      break;
    default:
      v8 = 0x3D3;
      v9 = "..\\raceneg.cpp";
      break;
  }
  Q_AssertLogBreakExit_sub_261A8(0, v9, v8);
  JUMPOUT(0x45065);
}
// 45060: control flows out of bounds to 45065

//----- (000450B0) --------------------------------------------------------
void __fastcall sub_450B0(P_Race a1, __int16 a2, char a3, char a4, int a5, int a6)
{
  T_Race *v7; // edi
  char *v8; // edx
  int index; // eax
  int v10; // edx
  int v11; // eax
  int v12; // edx
  int v13; // eax
  int v14; // edx
  int v15; // eax
  int v16; // eax
  int v17; // edx
  WORD v18; // cx
  int v19; // edx
  int v20; // edx
  __int16 v21; // ax
  _BYTE v22[428]; // [esp+0h] [ebp-1D4h] BYREF
  int acceptAlliance; // [esp+1ACh] [ebp-28h]
  unsigned int v24; // [esp+1B0h] [ebp-24h]
  int v25; // [esp+1B4h] [ebp-20h]
  int v26; // [esp+1B8h] [ebp-1Ch]
  int v27; // [esp+1BCh] [ebp-18h]
  T_Race *v28; // [esp+1C0h] [ebp-14h]
  __int16 v29; // [esp+1C4h] [ebp-10h]

  v29 = a2;
  v26 = a2;
  v7 = &V_Game.races[a2];
  v25 = (int)v7 + a5;
  v24 = 0x1EE * a5;
  v28 = &V_Game.races[a5];
  v27 = (int)v28 + a2;
  v8 = (char *)v28 + 2 * a2;
  switch ( a3 )
  {
    case 0:
      index = a1->index;
      v10 = v29;
      v7->treaties[index] = 1;
      a1->treaties[v10] = v7->treaties[index];
      a1->attitudes[v29] = a1->startAttitude;
      v7->attitudes[a1->index] = v7->startAttitude;
      return;
    case 1:
      if ( a4 == 1 )
      {
        a1->attitudes[v29] += 0x28;
      }
      return;
    case 2:
      v11 = a1->index;
      v12 = v29;
      v7->treaties[v11] = 2;
      a1->treaties[v12] = v7->treaties[v11];
      v7->attitudes[a1->index] -= 0x28;
      return;
    case 3:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->attitudes[V_PlayerRaceIndex] += 3;
      }
      if ( a4 == 4 )
      {
        v13 = a1->index;
        v14 = v29;
        v7->treaties[v13] = 3;
        a1->treaties[v14] = v7->treaties[v13];
        a1->attitudes[v14] += 0xA;
        v7->attitudes[a1->index] += 0xA;
      }
      else
      {
        a1->attitudes[v29] = a1->acceptAlliance;
      }
      return;
    case 4:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->attitudes[V_PlayerRaceIndex] += 5;
        V_Day1 = V_Game.day;
      }
      if ( a4 == 6 )
      {
        sub_45F60(a1, v29, 0);
        a1->attitudes[v29] += 0xA;
        v7->attitudes[a1->index] += 5;
      }
      else
      {
        v17 = v29;
        v18 = a1->attitudes[v29] - 2;
        a1->attitudes[v29] = v18;
        if ( a1->treaties[v17] == 3 )
        {
          a1->attitudes[v29] = v18 - 2;
        }
      }
      return;
    case 5:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->attitudes[V_PlayerRaceIndex] += 8;
        V_Day2 = V_Game.day;
      }
      if ( a4 == 8 )
      {
        sub_46130(a1, v29, 0);
        a1->attitudes[v29] += 0xA;
        v7->attitudes[a1->index] += 5;
      }
      else
      {
        v19 = v29;
        a1->attitudes[v29] -= 3;
        if ( a1->treaties[v19] == 3 )
        {
          a1->attitudes[v29] -= 3;
        }
      }
      return;
    case 6:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->attitudes[V_PlayerRaceIndex] += 8;
        V_Day3 = V_Game.day;
      }
      if ( a4 == 0xA )
      {
        sub_46304(a1, v29, 0);
        a1->attitudes[v29] += 0xA;
        v7->attitudes[a1->index] += 0xA;
      }
      else
      {
        v20 = v29;
        a1->attitudes[v29] -= 2;
        if ( a1->treaties[v20] == 3 )
        {
          a1->attitudes[v29] -= 2;
        }
      }
      return;
    case 7:
      if ( a4 != 0xC )
      {
        goto LABEL_54;
      }
      a1->attitudes[v26] += 5;
      if ( *((__int16 *)v8 + 0xD9) > V_Game.races[v24 / 0x1EE].acceptPeace - 0xA )
      {
        a1->attitudes[v26] += 5;
        *(_BYTE *)(v25 + 0x1C0) = 1;
        *(_BYTE *)(v27 + 0x1C0) = 1;
        v7->attitudes[a5] += 0xA;
        v7->attitudes[a1->index] += 5;
        *((_WORD *)v8 + 0xD9) += 0xA;
        v28->attitudes[a1->index] += 0xF;
      }
      return;
    case 8:
      v16 = a1->index;
      v7->treaties[v16] = 1;
      a1->treaties[v26] = v7->treaties[v16];
      v7->attitudes[a1->index] -= 0x1E;
      return;
    case 9:
      if ( a4 == 0xF )
      {
        a1->attitudes[v26] += 0xA;
        *(_BYTE *)(v25 + 0x1C0) = 2;
        *(_BYTE *)(v27 + 0x1C0) = 2;
        v7->attitudes[a5] -= 0xF;
        v7->attitudes[a1->index] += 0xA;
        *((_WORD *)v8 + 0xD9) -= 0x14;
      }
      goto LABEL_38;
    case 0xA:
      if ( a4 == 0x11 )
      {
        a1->attitudes[v26] += 0xF;
        *(_BYTE *)(v25 + 0x1C0) = 1;
        *(_BYTE *)(v27 + 0x1C0) = 1;
        v7->attitudes[a5] -= 5;
        v7->attitudes[a1->index] -= 5;
        *((_WORD *)v8 + 0xD9) -= 0xA;
LABEL_41:
        a1->attitudes[v26] -= 5;
      }
      else
      {
LABEL_38:
        a1->attitudes[v26] -= 0xA;
      }
      break;
    case 0xB:
      if ( a4 != 0x13 )
      {
        goto LABEL_41;
      }
      a1->attitudes[v26] += 5;
      acceptAlliance = V_Game.races[v24 / 0x1EE].acceptAlliance;
      if ( *((__int16 *)v8 + 0xD9) > acceptAlliance - 0xA )
      {
        a1->attitudes[v26] += 5;
        *(_BYTE *)(v25 + 0x1C0) = 3;
        *(_BYTE *)(v27 + 0x1C0) = 3;
        v7->attitudes[a5] += 0xA;
        v7->attitudes[a1->index] += 5;
        *((_WORD *)v8 + 0xD9) += 0xF;
        v28->attitudes[a1->index] += 0xA;
      }
      break;
    case 0xC:
      if ( a4 == 0x15 || a4 == 0x1A )
      {
        if ( v29 != V_PlayerRaceIndex )
        {
          if ( !a5 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x4FA);
          }
          v21 = sub_45848(&v7->index, a5, (int)v22, (__int16 *)v7);
          if ( !v21 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x4FD);
          }
          sub_45A0C(v7, a5, (int)v22, v21);
          a1->attitudes[v29] += 0xA;
        }
      }
      else if ( a4 == 0x16 )
      {
LABEL_54:
        a1->attitudes[v26] -= 5;
      }
      return;
    case 0xD:
      if ( a1->index == V_PlayerRaceIndex )
      {
        v7->attitudes[V_PlayerRaceIndex] += 3;
      }
      if ( a4 == 0x1B )
      {
        v15 = v29;
        v7->treaties[a1->index] = 1;
        a1->treaties[v15] = v7->treaties[a1->index];
      }
      else
      {
        a1->attitudes[v29] -= 0x19;
      }
      return;
    case 0xE:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x515);
      return;
    default:
      return;
  }
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00045848) --------------------------------------------------------
int __usercall sub_45848@<eax>(unsigned __int8 *a1@<eax>, int a2@<edx>, int a3@<ebx>, __int16 *x_low@<edi>)
{
  __int16 i; // si
  int v6; // eax
  int v7; // ebx
  int v8; // ebx
  char v9; // al
  P_Location v10; // ebx
  int v12[107]; // [esp+0h] [ebp-1CCh] BYREF
  int v13; // [esp+1ACh] [ebp-20h]
  int v14; // [esp+1B0h] [ebp-1Ch]
  int v15; // [esp+1B4h] [ebp-18h]
  int Ships_sub_40224; // [esp+1B8h] [ebp-14h]

  v13 = a2;
  v14 = a3;
  LOWORD(v15) = 0;
  Ships_sub_40224 = Q_Race_GetShips_sub_40224((P_Race)a1, (P_ShipsList)v12, 0);
  if ( (__int16)Ships_sub_40224 > 0 )
  {
    for ( i = 0; i < (__int16)Ships_sub_40224; ++i )
    {
      v8 = v12[i];
      v9 = *(_BYTE *)(v8 + 0x58);
      v10.pPlanet = *(P_Planet *)(v8 + 0x59);
      if ( v9 != 1 && v9 != 2 )
      {
        if ( v9 == 3 )
        {
          x_low = (__int16 *)&V_Game.stars[v10.pPlanet->starIndex];
LABEL_8:
          if ( V_Game.starDistanceMatrix[x_low[2]][*(__int16 *)(v13 + 4)] < 3u )
          {
            v6 = 4 * (__int16)v15;
            v7 = v12[i];
            LOWORD(v15) = v15 + 1;
            *(_DWORD *)(v14 + v6) = v7;
          }
          continue;
        }
        if ( v9 != 4 )
        {
          if ( v9 == 5 )
          {
            x_low = (__int16 *)LODWORD(v10.pPlanet->position.x);
          }
          goto LABEL_8;
        }
        x_low = (__int16 *)v10.pPlanet;
        if ( !Q_Race_CalculateShipsAtLocation_sub_45958((P_Race)a1, 2, v10, 0) )
        {
          goto LABEL_8;
        }
      }
    }
  }
  return v15;
}
// 45848: using guessed type int var_1CC[107];

//----- (00045958) --------------------------------------------------------
// Calculates diplomatic relations and combat strength between a race and ships at a location
// Returns: Number of matching ships
// Outputs: Total combat strength through strengthOut parameter
int __fastcall Q_Race_CalculateShipsAtLocation_sub_45958(P_Race pRace, BYTE treaty, P_Location targetLocation, LONG *strengthOut)
{
  __int16 matchingShipsCount; // di
  LONG totalCombatStrength; // ecx
  P_Ship pShip; // eax
  __int16 i; // bx
  P_Ship shipsAtLocation[107]; // [esp+0h] [ebp-1C4h] BYREF
  int shipsFoundCount; // [esp+1ACh] [ebp-18h]
  LONG *strengthOutput; // [esp+1B0h] [ebp-14h]
  BYTE requiredTreaty; // [esp+1B4h] [ebp-10h]

  requiredTreaty = treaty;
  strengthOutput = strengthOut;
  if ( !targetLocation.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x54E);
  }
  matchingShipsCount = 0;
  totalCombatStrength = 0;
  shipsFoundCount = Q_FindShipsAtLocation_sub_1D794(targetLocation, shipsAtLocation);
  for ( i = 0; i < shipsFoundCount; ++i )
  {
    pShip = shipsAtLocation[i];
    if ( pShip
      && (pShip->raceIndex == pRace->index && requiredTreaty == ASCEND_TREATY_ALLIANCE || pRace->treaties[pShip->raceIndex] == requiredTreaty) )
    {
      ++matchingShipsCount;
      totalCombatStrength += pShip->totalWeaponDamage * pShip->hullIntegrity;
    }
  }
  if ( strengthOutput )
  {
    *strengthOutput = totalCombatStrength;
  }
  return matchingShipsCount;
}

//----- (00045A0C) --------------------------------------------------------
int __fastcall sub_45A0C(_BYTE *a1, int a2, int a3, __int16 a4)
{
  int result; // eax
  int v6; // edx

  if ( *a1 == V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x574);
  }
  for ( result = 0; (__int16)result < a4; *(_DWORD *)(v6 + 0x5E) = a2 )
  {
    *(_BYTE *)(*(_DWORD *)(a3 + 4 * (__int16)result) + 0x5D) = 1;
    v6 = *(_DWORD *)(a3 + 4 * (__int16)result++);
  }
  return result;
}

//----- (00045A54) --------------------------------------------------------
// Handle ship arrival at a star system and trigger appropriate events
// Returns TRUE if successful, FALSE if star was already processed
unsigned int __fastcall Q_Race_HandlePlayerShipArrivalAtStar_sub_45A54(P_Race pRace, P_Star pStar, P_Ship pShip)
{
  __int16 raceIndex; // ax
  int raceArrayIndex; // edx
  WORD i; // ax
  int jj; // kr04_4
  __int16 v9; // ax
  int shipsRacesBits; // edx
  __int16 eventId; // dx
  UBYTE playerRaceIndex; // cl
  WORD j; // si
  MACRO_VFX_BOOL foundUnknownRace; // [esp+0h] [ebp-2Ch]
  MACRO_VFX_BOOL foundHostilePlanets; // [esp+4h] [ebp-28h]
  MACRO_VFX_BOOL foundHostileShips; // [esp+8h] [ebp-24h]
  MACRO_VFX_BOOL foundOtherWarringRaces; // [esp+14h] [ebp-18h]
  int targetRaceIndex; // [esp+18h] [ebp-14h]

  if ( pRace->index != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x58A);
  }
  // Check if this star system was already processed
  if ( (byte_D8460[pStar->index] & 1) != 0 )
  {
    return FALSE;
  }
  targetRaceIndex = 0;
  foundUnknownRace = FALSE;
  foundHostileShips = FALSE;
  foundHostilePlanets = FALSE;
  foundOtherWarringRaces = FALSE;
  // FIRST PASS: Check for races we can establish peace with
  raceIndex = 0;
  if ( V_Game.racesNum > 0 )
  {
    while ( raceIndex == V_PlayerRaceIndex
         || pRace->treaties[raceIndex]
         || ((1 << raceIndex) & (pStar->planetsRacesBits | pStar->shipsRacesBits)) == 0 )
    {
      if ( ++raceIndex >= V_Game.racesNum )
      {
        goto NO_PEACEFUL_RACES_FOUND;
      }
    }
    // Found a race to make peace with
    targetRaceIndex = raceIndex;
    pRace->treaties[raceIndex] = ASCEND_TREATY_PEACE;
    foundUnknownRace = TRUE;
    pRace->attitudes[raceIndex] = pRace->startAttitude;
    // Make the other race also peaceful toward player
    raceArrayIndex = raceIndex;
    V_Game.races[raceArrayIndex].treaties[pRace->index] = ASCEND_TREATY_PEACE;
    V_Game.races[raceArrayIndex].attitudes[pRace->index] = V_Game.races[raceIndex].startAttitude;
  }
NO_PEACEFUL_RACES_FOUND:
  // SECOND PASS: Check for hostile races if no peaceful ones found
  if ( foundUnknownRace == FALSE )
  {
    for ( i = 0; i < V_Game.racesNum; ++i )
    {
      // Skip player and non-warring races
      if ( i != V_PlayerRaceIndex && pRace->treaties[i] == ASCEND_TREATY_WAR )
      {
        // Check for hostile ships in system (race presence bits)
        if ( ((1 << i) & pStar->shipsRacesBits) != 0 )
        {
          targetRaceIndex = i;
          foundHostileShips = TRUE;
        }
        // If no ships, check for hostile planets (races bits)
        if ( foundHostileShips == FALSE && ((1 << i) & pStar->planetsRacesBits) != 0 )
        {
          foundHostilePlanets = TRUE;
          targetRaceIndex = i;
        }
      }
    }
  }
  // THIRD PASS: Check for other races at war with each other
  if ( foundUnknownRace == FALSE && foundHostileShips == FALSE && foundHostilePlanets == FALSE && V_Game.racesNum > 0 )
  {
    jj = 0;
    j = 0;
    do
    {
      if ( j != V_PlayerRaceIndex )
      {
        v9 = 0;
        if ( V_Game.racesNum > 0 )
        {
          shipsRacesBits = pStar->shipsRacesBits;
          while ( ((1 << j) & shipsRacesBits) == 0
               || ((1 << v9) & shipsRacesBits) == 0
               || V_Game.races[jj].treaties[v9] != ASCEND_TREATY_WAR )
          {
            if ( ++v9 >= V_Game.racesNum )
            {
              goto NEXT_RACE_CHECK;
            }
          }
          foundOtherWarringRaces = TRUE;
        }
      }
NEXT_RACE_CHECK:
      ++j;
      ++jj;
    }
    while ( j < V_Game.racesNum );
  }
  if ( foundUnknownRace == TRUE )
  {
    // %s: We've entered the %s system and we're receiving a transmission from an
    // unknown species.
    eventId = ASCEND_EP_FINDRACE;
  }
  else if ( foundHostileShips == TRUE )
  {
    // %s: Entered %s system.  Hostile ships (%s) have been detected.
    eventId = ASCEND_EP_HOSTILESHIP;
  }
  else if ( foundHostilePlanets == TRUE )
  {
    // %s: We've arrived at %s.  The %s have hostile colonies here.
    eventId = ASCEND_EP_HOSTILEPLAN;
  }
  else if ( foundOtherWarringRaces == TRUE )
  {
    // %s: We've arrived at %s and found other species at war.  They do not seem
    // to be hostile toward us.
    eventId = ASCEND_EP_OTHERWAR;
  }
  else
  {
    playerRaceIndex = V_PlayerRaceIndex;
    pShip->order = ASCEND_SO_0_NOTHING;
    pShip->_orderTargetObject.pPlanet = 0;
    if ( ((1 << playerRaceIndex) & pStar->exploredBits) != 0 )
    {
      // %s: We've arrived in the %s system.  Awaiting orders.
      eventId = ASCEND_EP_SHIPARRIVE;
    }
    else
    {
      // We have discovered the %s System.  It contains %d planet%s and %d star
      // lane%s.  We're awaiting further orders.
      eventId = ASCEND_EP_20_DISCOVERED_SYSTEM;
    }
  }
  byte_D8460[pStar->index] |= 1u;
  Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, eventId, (int)pShip, targetRaceIndex);
  return TRUE;
}
// 45D0F: conditional instruction was optimized away because edx.4 is in (3..7|==14)

//----- (00045D50) --------------------------------------------------------
// Handles first contact and diplomatic events when a ship enters a star system
// Returns TRUE if an event was triggered, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Race_HandleStarSystemEntry_sub_45D50(P_Race pRace, P_Star pStar, P_Ship pShip)
{
  int shipsRacesBits; // ebx
  unsigned int eventId; // edx
  BYTE currentTreaty; // cl
  WORD shipRaceIndex; // [esp+2h] [ebp-14h]

  if ( pRace->index != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x61C);
  }
  shipRaceIndex = pShip->raceIndex;
  shipsRacesBits = pStar->shipsRacesBits;
  eventId = -1u;
  // Check if this race hasn't been encountered in this system before
  if ( ((1 << shipRaceIndex) & shipsRacesBits) == 0 )
  {
    currentTreaty = pRace->treaties[shipRaceIndex];
    if ( currentTreaty )
    {
      if ( currentTreaty == ASCEND_TREATY_WAR )
      {
        eventId = ASCEND_EP_BADSHIPENTERS;
      }
    }
    else
    {
      // Establish first contact and set initial peace treaty
      pRace->treaties[shipRaceIndex] = ASCEND_TREATY_PEACE;
      pRace->attitudes[shipRaceIndex] = pRace->startAttitude;
      V_Game.races[shipRaceIndex].treaties[pRace->index] = ASCEND_TREATY_PEACE;
      eventId = ASCEND_EP_RACEFINDUS;
      V_Game.races[shipRaceIndex].attitudes[pRace->index] = V_Game.races[shipRaceIndex].startAttitude;
    }
  }
  if ( eventId == -1u || (byte_D8460[pStar->index] & 1) != 0 )
  {
    return FALSE;
  }
  Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, (__int16)eventId, (int)pShip, shipRaceIndex);
  byte_D8460[pStar->index] |= 1u;
  return TRUE;
}

//----- (00045E64) --------------------------------------------------------
unsigned int __fastcall sub_45E64(_BYTE *a1, __int16 a2)
{
  unsigned __int8 v2; // al
  int i; // edx
  float v6; // [esp+4h] [ebp-24h]
  __int16 v7; // [esp+8h] [ebp-20h]
  __int16 v8; // [esp+Ch] [ebp-1Ch]
  unsigned __int8 v9; // [esp+14h] [ebp-14h]

  if ( a1[a2 + 0x1C0] == 3 )
  {
    return 0xFFFFFFFF;
  }
  v8 = 0;
  v9 = 1 << *a1;
  v7 = 0;
  v2 = 1 << a2;
  for ( i = 0; (__int16)i < V_Game.lanesNum; ++i )
  {
    if ( (v9 & V_Game.lanes[i].exploredBits) != 0 )
    {
      ++v8;
    }
    if ( (v2 & V_Game.lanes[i].exploredBits) != 0 )
    {
      ++v7;
    }
  }
  if ( v8 >= 5 )
  {
    if ( !v7 )
    {
      v7 = 1;
    }
    v6 = (float)v8;
    if ( v6 / (double)V_Game.lanesNum > 0.9 )
    {
      return 0;
    }
    if ( v6 / (double)v7 > 2.0 )
    {
      return 0;
    }
    return 0xFFFFFFFF;
  }
  return 0;
}

//----- (00045F60) --------------------------------------------------------
void __fastcall sub_45F60(_BYTE *a1, __int16 a2, int a3)
{
  int v5; // ebx
  int v6; // esi
  int v7; // eax
  int v8; // edx
  int v9; // ebp
  __int64 v10; // rtt
  unsigned __int8 v11; // dh
  unsigned __int8 v12; // dl
  int v13; // ecx
  int v14; // kr04_4
  int v16; // [esp+4h] [ebp-14h]

  v5 = 0;
  v6 = 0;
  if ( a1[a2 + 0x1C0] == 3 )
  {
    v7 = rand();
    v8 = v7;
    v9 = 6;
  }
  else
  {
    v7 = rand();
    v8 = v7;
    v9 = 3;
  }
  LODWORD(v10) = v7;
  HIDWORD(v10) = v8 >> 0x1F;
  v16 = v10 % v9 + 1;
  v11 = 1 << *a1;
  v12 = 1 << V_Game.races[a2].index;
  v13 = 0;
  if ( V_Game.lanesNum > 0 )
  {
    v14 = 0;
    do
    {
      if ( a3 || (v11 & V_Game.lanes[v14].exploredBits) == 0 )
      {
        if ( (v12 & V_Game.lanes[v14].exploredBits) != 0 && v5 < v16 && (v11 & V_Game.lanes[v14].exploredBits) == 0 )
        {
          ++v5;
          V_Game.lanes[v14].exploredBits |= v11;
        }
      }
      else if ( v6 < v16 && (v12 & V_Game.lanes[v14].exploredBits) == 0 )
      {
        ++v6;
        V_Game.lanes[v14].exploredBits |= v12;
      }
      ++v13;
      ++v14;
    }
    while ( (__int16)v13 < V_Game.lanesNum );
  }
}

//----- (00046034) --------------------------------------------------------
unsigned int __fastcall sub_46034(_BYTE *a1, __int16 a2)
{
  unsigned __int8 v2; // al
  int i; // edx
  float v6; // [esp+4h] [ebp-24h]
  __int16 v7; // [esp+8h] [ebp-20h]
  __int16 v8; // [esp+Ch] [ebp-1Ch]
  unsigned __int8 v9; // [esp+14h] [ebp-14h]

  if ( a1[a2 + 0x1C0] == 3 )
  {
    return 0xFFFFFFFF;
  }
  v8 = 0;
  v9 = 1 << *a1;
  v7 = 0;
  v2 = 1 << a2;
  for ( i = 0; (__int16)i < V_Game.starsNum; ++i )
  {
    if ( (v9 & V_Game.stars[i].exploredBits) != 0 )
    {
      ++v8;
    }
    if ( (v2 & V_Game.stars[i].exploredBits) != 0 )
    {
      ++v7;
    }
  }
  if ( v8 >= 3 )
  {
    if ( !v7 )
    {
      v7 = 1;
    }
    v6 = (float)v8;
    if ( v6 / (double)V_Game.starsNum > 0.9 )
    {
      return 0;
    }
    if ( v6 / (double)v7 > 1.6 )
    {
      return 0;
    }
    return 0xFFFFFFFF;
  }
  return 0;
}

//----- (00046130) --------------------------------------------------------
void __fastcall sub_46130(_BYTE *a1, __int16 a2, int a3)
{
  int v5; // esi
  int v6; // ebx
  int v7; // eax
  int v8; // edx
  int v9; // ebp
  __int64 v10; // rtt
  unsigned __int8 v11; // dh
  unsigned __int8 v12; // dl
  int v13; // ecx
  int v14; // kr04_4
  int v16; // [esp+4h] [ebp-14h]

  v5 = 0;
  v6 = 0;
  if ( a1[a2 + 0x1C0] == 3 )
  {
    v7 = rand();
    v8 = v7;
    v9 = 4;
  }
  else
  {
    v7 = rand();
    v8 = v7;
    v9 = 2;
  }
  LODWORD(v10) = v7;
  HIDWORD(v10) = v8 >> 0x1F;
  v16 = v10 % v9 + 1;
  v11 = 1 << *a1;
  v12 = 1 << V_Game.races[a2].index;
  v13 = 0;
  if ( V_Game.starsNum > 0 )
  {
    v14 = 0;
    do
    {
      if ( a3 || (v11 & V_Game.stars[v14].exploredBits) == 0 )
      {
        if ( (v12 & V_Game.stars[v14].exploredBits) != 0 && v5 < v16 && (v11 & V_Game.stars[v14].exploredBits) == 0 )
        {
          V_Game.stars[v14].exploredPathToBits |= v11;
          ++v5;
          V_Game.stars[v14].exploredBits |= v11;
        }
      }
      else if ( v6 < v16 && (v12 & V_Game.stars[v14].exploredBits) == 0 )
      {
        V_Game.stars[v14].exploredPathToBits |= v12;
        ++v6;
        V_Game.stars[v14].exploredBits |= v12;
      }
      ++v13;
      ++v14;
    }
    while ( (__int16)v13 < V_Game.starsNum );
  }
}

//----- (00046208) --------------------------------------------------------
unsigned int __fastcall sub_46208(_BYTE *a1, __int16 a2)
{
  unsigned __int8 v2; // al
  int v3; // kr04_4
  __int16 i; // dx
  float v7; // [esp+0h] [ebp-20h]
  __int16 v8; // [esp+8h] [ebp-18h]
  __int16 v9; // [esp+Ch] [ebp-14h]
  unsigned __int8 v10; // [esp+14h] [ebp-Ch]

  if ( a1[a2 + 0x1C0] == 3 )
  {
    return 0xFFFFFFFF;
  }
  v8 = 0;
  v10 = 1 << *a1;
  v9 = 0;
  v2 = 1 << a2;
  v3 = 0;
  for ( i = 0; i < (int)V_Research.num; ++i )
  {
    if ( (v10 & V_Research.techs[v3].knownToRace) != 0 )
    {
      ++v8;
    }
    if ( (v2 & V_Research.techs[v3].knownToRace) != 0 )
    {
      ++v9;
    }
    ++v3;
  }
  if ( v8 >= 5 )
  {
    if ( !v9 )
    {
      v9 = 1;
    }
    v7 = (float)v8;
    if ( v7 / (double)V_Research.num > 0.85 )
    {
      return 0;
    }
    if ( v7 / (double)v9 > 1.7 )
    {
      return 0;
    }
    return 0xFFFFFFFF;
  }
  return 0;
}

//----- (00046304) --------------------------------------------------------
int __fastcall sub_46304(_BYTE *a1, __int16 a2, int a3)
{
  int v4; // ebx
  int v5; // esi
  unsigned __int8 v6; // cl
  __int64 techs; // rax
  int v8; // kr04_4
  int v11; // [esp+Ch] [ebp-2Ch]
  __int16 v12; // [esp+18h] [ebp-20h]
  __int16 index; // [esp+20h] [ebp-18h]
  unsigned __int8 v14; // [esp+24h] [ebp-14h]

  v4 = 0;
  v5 = 0;
  if ( a1[a2 + 0x1C0] == 3 )
  {
    v11 = rand() % 2 + 1;
  }
  else
  {
    v11 = 1;
  }
  v14 = 1 << *a1;
  v6 = 1 << V_Game.races[a2].index;
  v12 = (unsigned __int8)*a1;
  index = V_Game.races[a2].index;
  techs = (unsigned int)V_Research.techs;
  v8 = 0;
  while ( V_Research.num > SWORD2(techs) )
  {
    if ( a3 || (V_Research.techs[v8].knownToRace & v14) == 0 )
    {
      if ( (v6 & V_Research.techs[v8].knownToRace) != 0 && v4 < v11 && (v14 & V_Research.techs[v8].knownToRace) == 0 )
      {
        V_Research.techs[v8].knownToRace |= v14;
        if ( V_Research.current.project[v12] == SWORD2(techs) )
        {
          V_Research.current.project[v12] = 0xFFFF;
        }
        ++v4;
      }
    }
    else if ( v5 < v11 && (V_Research.techs[v8].knownToRace & v6) == 0 )
    {
      V_Research.techs[v8].knownToRace |= v6;
      if ( V_Research.current.project[index] == SWORD2(techs) )
      {
        V_Research.current.project[index] = 0xFFFF;
      }
      ++v5;
    }
    ++WORD2(techs);
    ++v8;
  }
  return techs;
}

//----- (00046470) --------------------------------------------------------
void Q_Research_StaticCtor_sub_46470()
{
  Q_Research_LoadResTreeTxt_sub_46480(&V_Research, 0);
}

//----- (00046480) --------------------------------------------------------
void __fastcall __spoils<eax,edx> Q_Research_LoadResTreeTxt_sub_46480(P_Research pResearch, const char *fname)
{
  int i; // kr04_4
  int j; // kr0C_4
  const char *restreeFname; // eax
  FILE *v6; // edx
  int n; // eax
  int v8; // eax
  int v9; // ecx
  int v10; // kr3C_4
  UBYTE v11; // al
  int ii; // edi
  int v13; // ecx
  int jj; // kr34_4
  int k; // edx
  fpos_t v16; // [esp+4h] [ebp-30h] BYREF
  fpos_t pos; // [esp+8h] [ebp-2Ch] BYREF
  unsigned int bufi1; // [esp+Ch] [ebp-28h] BYREF
  int bufi2; // [esp+10h] [ebp-24h] BYREF
  P_Research v20; // [esp+14h] [ebp-20h]
  int m; // [esp+18h] [ebp-1Ch]
  FILE *fp; // [esp+1Ch] [ebp-18h]

  pResearch->b = 0;
  pResearch->allTechForShipReported = 0;
  for ( i = 0; i != 0x64; ++i )
  {
    pResearch->techs[i].Unknown_49 = 0;
    pResearch->techs[i].knownToRace = pResearch->techs[i].Unknown_49;
  }
  if ( !V_ResTreeTxtLoaded )
  {
    for ( j = 0; j != 0x64; ++j )
    {
      pResearch->techs[j].next[0] = 0xFF;
    }
    pResearch->num = 0;
    if ( fname )
    {
      restreeFname = fname;
    }
    else
    {
      restreeFname = "restree.txt";
    }
    fp = Q_OpenTextFile_sub_1BB10(restreeFname, &v16);
    if ( fp )
    {
      fscanf(fp, "%d", &bufi1);
      pResearch->num = bufi1;
      if ( pResearch->num > 100u )
      {
        pResearch->num = 100;
      }
      for ( m = 0; pResearch->num > m; ++m )
      {
        v6 = fp;
        fscanf(fp, "%s", &pResearch->techs[m]);
        fscanf(v6, "%d %d", &bufi1, &bufi2);
        pResearch->techs[m].type = bufi1;
        if ( m > 10 )
        {
          bufi2 *= 2 * m - 20;
        }
        if ( bufi2 > 65000 )
        {
          bufi2 = 65000;
        }
        pResearch->techs[m].cost = bufi2;
        for ( k = 0; k < 5; ++k )
        {
          fscanf(fp, "%d", &bufi1);
          pResearch->techs[m].preq[k] = bufi1;
          if ( bufi1 == 0xFF )
          {
            n = 0;
            goto LABEL_25;
          }
        }
        for ( n = 0; n < 60; ++n )
        {
LABEL_25:
          if ( pResearch->techs[m].name[n] == '^' )
          {
            pResearch->techs[m].name[n] = ' ';
          }
        }
      }
      v20 = pResearch;
      for ( m = 0; pResearch->num > m; ++m )
      {
        for ( ii = 0; ii < 5; ++ii )
        {
          v13 = pResearch->techs[m].preq[ii];
          if ( v13 == 0xFF )
          {
            break;
          }
          v9 = v13;
          v8 = 0;
          while ( 1 )
          {
            v10 = v8;
            if ( pResearch->techs[v9].next[v8] == 0xFF )
            {
              break;
            }
            if ( ++v8 >= 4 )
            {
              goto LABEL_31;
            }
          }
          v11 = m;
          pResearch->techs[v9].next[v10 + 1] = 0xFF;
          pResearch->techs[v9].next[v10] = v11;
LABEL_31:
          ;
        }
      }
      fgetpos(fp, &pos);
      if ( pos >= v16 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\research.cpp", 0x86);
      }
      fclose(fp);
    }
    V_ResTreeTxtLoaded = 0xFFFFFFFF;
  }
  for ( jj = 0; jj != 7; ++jj )
  {
    pResearch->current.project[jj] = -1;
    pResearch->current.progress[jj] = 0;
  }
}
// 105254: using guessed type int V_ResTreeTxtLoaded;

//----- (000466FC) --------------------------------------------------------
int __fastcall Q_Research_DoProgress_sub_466FC(P_Research pResearch)
{
  int v2; // ecx
  int j; // kr0C_4
  int raceIndex; // eax
  int v5; // ebx
  int k; // kr14_4
  int result; // eax
  int v8; // eax
  int v9; // eax
  int v10; // ebx
  char v11; // dl
  int v12; // edx
  int v13; // eax
  UWORD RPs[7]; // [esp+10h] [ebp-34h]
  int v15; // [esp+20h] [ebp-24h]
  int RP; // [esp+24h] [ebp-20h]
  int i; // [esp+28h] [ebp-1Ch]

  for ( i = 0; V_Game.racesNum > i; ++i )
  {
    RPs[i] = 0;
  }
  v2 = 0;
  for ( j = 0; ; ++j )
  {
    i = v2;
    if ( V_Game.planetsNum <= v2 )
    {
      break;
    }
    raceIndex = V_Game.planets[j].raceIndex;
    if ( raceIndex < V_Game.racesNum )
    {
      if ( (_BYTE)raceIndex != V_PlayerRaceIndex && V_Game.atmosphere == ASCEND_ATMOSPHERE_HOSTILE && V_Game.planets[j].research < 0xFu )
      {
        ++RPs[raceIndex];
      }
      RPs[V_Game.planets[j].raceIndex] += V_Game.planets[j].research;
    }
    v2 = i + 1;
  }
  v5 = 0;
  for ( k = 0; ; ++k )
  {
    i = v5;
    result = V_Game.racesNum;
    if ( V_Game.racesNum <= v5 )
    {
      break;
    }
    if ( pResearch->current.project[k] == 0xFFFF )
    {
      pResearch->current.progress[k] = 0;
    }
    else
    {
      v8 = RPs[v5];
      RP = (unsigned __int16)v8;
      if ( (_WORD)v8 )
      {
        v15 = v8 + 1;
        RP = (int)pow((double)(v8 + 1), 0.85);
      }
      v9 = pResearch->current.project[k];
      pResearch->current.progress[k] += RP;
      if ( pResearch->current.progress[k] >= pResearch->techs[v9].cost )
      {
        v10 = pResearch->current.project[k];
        v11 = 1 << i;
        pResearch->techs[(unsigned __int16)v10].knownToRace |= 1 << i;
        pResearch->techs[pResearch->current.project[k]].Unknown_49 |= v11;
        v12 = i;
        pResearch->current.project[k] = 0xFFFF;
        v13 = V_PlayerRaceIndex;
        pResearch->current.progress[k] = 0;
        if ( v13 == v12 )
        {
          Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_00_NEW_DISCOVERY, v10, 0);
          Q_Research_CheckAllTechForShip_sub_468BC(pResearch);
        }
      }
    }
    v5 = i + 1;
  }
  return result;
}

//----- (000468BC) --------------------------------------------------------
void __fastcall Q_Research_CheckAllTechForShip_sub_468BC(P_Research pResearch)
{
  if ( !pResearch->allTechForShipReported && Q_Research_HasAllTechsForShip_sub_46900(pResearch, V_PlayerRaceIndex) == TRUE )
  {
    Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_21_ALL_TECH_FOR_SHIP, 0, 0);
    pResearch->allTechForShipReported = TRUE;
  }
}

//----- (00046900) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Research_HasAllTechsForShip_sub_46900(P_Research pResearch, char raceIndex)
{
  int raceMask; // edx

  raceMask = 1 << raceIndex;
  if ( (raceMask & pResearch->techs[0].knownToRace) != 0
    && (raceMask & pResearch->techs[1].knownToRace) != 0
    && (raceMask & pResearch->techs[2].knownToRace) != 0
    && (raceMask & pResearch->techs[3].knownToRace) != 0 )
  {
    return TRUE;
  }
  else
  {
    return FALSE;
  }
}

//----- (0004694C) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_ResTree_TechIsAvailableToRace_sub_4694C(P_Research pResTree, unsigned __int16 techIndex, __int16 raceIndex)
{
  char raceIndex_; // di
  MACRO_VFX_BOOL v5; // ebp
  int i; // eax

  raceIndex_ = raceIndex;
  if ( raceIndex == 0xFFFFFFFF )
  {
    raceIndex_ = V_PlayerRaceIndex;
  }
  v5 = TRUE;
  if ( ((1 << raceIndex_) & pResTree->techs[techIndex].knownToRace) == 0 )
  {
    for ( i = 0; i < 5; ++i )
    {
      if ( pResTree->techs[techIndex].preq[i] == 0xFF )
      {
        break;
      }
      if ( ((1 << raceIndex_) & pResTree->techs[pResTree->techs[techIndex].preq[i]].knownToRace) == 0 )
      {
        v5 = FALSE;
      }
    }
  }
  return v5;
}

//----- (000469F0) --------------------------------------------------------
int __fastcall sub_469F0(P_Research pResTree, unsigned __int16 raceIndex)
{
  int tmp; // ebx
  int i; // edx
  int research; // [esp+14h] [ebp-10h]

  if ( raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\research.cpp", 0x116);
  }
  research = 0;
  for ( i = 0; i < V_Game.planetsNum; ++i )
  {
    tmp = V_Game.planets[i].raceIndex;
    if ( tmp == raceIndex )
    {
      LOWORD(tmp) = V_Game.planets[i].research;
      research += tmp;
    }
  }
  if ( research )
  {
    return (int)pow((double)(research + 1), 0.85);
  }
  return research;
}

//----- (00046A94) --------------------------------------------------------
__int16 __fastcall sub_46A94(P_Research a1, unsigned __int16 raceIndex, int a3)
{
  P_Research v4; // kr00_4
  unsigned __int16 v5; // dx
  unsigned __int16 v6; // cx
  int v7; // edi
  BYTE v8; // dl
  int i; // eax
  UWORD v11[100]; // [esp+0h] [ebp-E0h]
  int v12; // [esp+C8h] [ebp-18h]
  int v13; // [esp+CCh] [ebp-14h]

  LOWORD(v13) = raceIndex;
  v12 = a3;
  if ( raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\research.cpp", 0x12D);
  }
  v4 = a1;
  v5 = 0;
  for ( i = 0; i < a1->num; ++i )
  {
    if ( i != a1->current.project[(unsigned __int16)v13] && ((1 << v13) & v4->techs[i].knownToRace) == 0 )
    {
      v6 = v5++;
      v11[v6] = i;
    }
  }
  if ( v5 )
  {
    v7 = v11[rand() % v5];
    v8 = (1 << v13) | a1->techs[(unsigned __int16)v7].Unknown_49;
    a1->techs[(unsigned __int16)v7].knownToRace |= 1 << v13;
    a1->techs[(unsigned __int16)v7].Unknown_49 = v8;
    LOWORD(i) = v13;
    if ( (unsigned __int16)v13 == V_PlayerRaceIndex )
    {
      LOWORD(i) = Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_22_XENO_COMPLETE, v7, v12);
    }
  }
  return i;
}

//----- (00046BB0) --------------------------------------------------------
void __fastcall Q_ReadWriteResTree_sub_46BB0(P_Research a1, P_CFile a2, int read)
{
  T_Research v5; // [esp+0h] [ebp-1D80h] BYREF

  if ( read == TRUE )
  {
    Q_Research_LoadResTreeTxt_sub_46480(&v5, 0);
    Q_CFile_Read_sub_1BF94(a2, &v5, sizeof(T_Research));
    qmemcpy(a1, &v5, 0x1D70u);
    HIWORD(a1->allTechForShipReported) = HIWORD(v5.allTechForShipReported);
  }
  else
  {
    Q_CFile_Write_sub_1C098(a2, a1, sizeof(T_Research));
  }
}
// 46BE0: CONTAINING_RECORD: too small offset 7536 for struct 'T_Research'

//----- (00046C10) --------------------------------------------------------
void __fastcall __spoils<> Q_ResTreeCtor_sub_46C10(P_Research a1)
{
  Q_Research_LoadResTreeTxt_sub_46480(a1, 0);
}

//----- (00046C20) --------------------------------------------------------
int __fastcall Q_GetTurnsToComplete_sub_46C20(int cost, int done, int production)
{
  int result; // eax

  result = 0xFFFF;
  if ( production > 0 )
  {
    result = (cost - done - 1) / production + 1;
  }
  if ( result < 1 )
  {
    return 1;
  }
  return result;
}

//----- (00046C48) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd9RWDtor_sub_46C48(P_Wnd9RW a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd9RW);
    operator delete[](v3);
  }
  else
  {
    a1->a.pProcs = &Wnd9RW_Procs;
    Q_DestructVectors_sub_1A9E0(a1->vectors);
    Q_Ret_sub_1B66C();
    Q_WndA2_Dtor_sub_2C848(&a1->a, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00046CAC) --------------------------------------------------------
void __fastcall sub_46CAC(P_Wnd9RW a1)
{
  int j; // kr04_4
  double v3; // st7
  int v4; // ebx
  FILE *fp; // eax
  FILE *fp_; // esi
  T_Vector3D *v7; // kr08_4
  int v8; // eax
  int v9; // esi
  int v10; // eax
  int v11; // edx
  int v12; // edx
  int n; // eax
  int v14; // edx
  int v15; // ebp
  T_Vector3D *v16; // kr28_4
  int v17; // edi
  T_Vector3D *vectors; // kr00_4
  int i; // ebx
  int k; // edi
  int m; // ebx
  int ii; // ecx
  float v23; // [esp-4h] [ebp-124h]
  char v24[100]; // [esp+0h] [ebp-120h] BYREF
  char s[100]; // [esp+64h] [ebp-BCh] BYREF
  int v26; // [esp+C8h] [ebp-58h] BYREF
  int v27; // [esp+CCh] [ebp-54h] BYREF
  int v28; // [esp+D0h] [ebp-50h] BYREF
  int v29; // [esp+D4h] [ebp-4Ch]
  int v30; // [esp+D8h] [ebp-48h]
  int v31; // [esp+DCh] [ebp-44h]
  T_Vector3D *vector; // [esp+E0h] [ebp-40h]
  int v33; // [esp+E4h] [ebp-3Ch]
  int v34; // [esp+E8h] [ebp-38h]
  int v35; // [esp+ECh] [ebp-34h]
  int v36; // [esp+F0h] [ebp-30h]
  int v37; // [esp+F4h] [ebp-2Ch]
  int v38; // [esp+F8h] [ebp-28h]
  int v39; // [esp+FCh] [ebp-24h]
  float degrees; // [esp+100h] [ebp-20h]
  int v41; // [esp+104h] [ebp-1Ch]

  a1->Unknown_9DB = 0xFFFF;
  vectors = a1->vectors;
  v35 = 0;
  j = 0;
  do
  {
    vectors[j].x = 0.0;
    v3 = (double)v35;
    vectors[j].z = 0.0;
    v4 = v35;
    vectors[j].y = v3;
    v35 = v4 + 1;
    ++j;
  }
  while ( v4 + 1 < 100 );
  Q_Camera_InitializeProjection_sub_1B808(&a1->camera, 30.0, 1.0, 100000.0, 320);
  a1->camera.position.x = 0.0;
  a1->camera.position.y = 0.0;
  a1->camera.position.z = -150.0;
  fp = Q_OpenTextFile_sub_1BB10("reswin.txt", 0);
  fp_ = fp;
  if ( fp )
  {
    fscanf(fp, "%d", &v26);
    if ( V_Research.num == v26 )
    {
      v7 = a1->vectors;
      for ( i = 0; i < V_Research.num; ++i )
      {
        fscanf(fp_, "%d %d %d", &v26, &v27, &v28);
        v29 = v27;
        v8 = v28;
        v7[i].x = (float)v26;
        v30 = v8;
        v7[i].y = (float)v29;
        v7[i].z = (float)v30;
      }
    }
    fclose(fp_);
  }
  else
  {
    if ( V_ResTreeTxtLoaded != 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\reswin.cpp", 0x76);
    }
    memset(s, 0xFF, sizeof(s));
    v9 = 0;
    do
    {
      v37 = 0xFFFFFFFF;
      v41 = 0;
      for ( k = 0; k < V_Research.num; ++k )
      {
        if ( (unsigned __int8)s[k] == 0xFF )
        {
          v10 = 0;
          for ( m = 0; m < 5; ++m )
          {
            v11 = V_Research.techs[k].preq[m];
            if ( v11 == 0xFF )
            {
              break;
            }
            v12 = (unsigned __int8)s[v11];
            if ( v12 == 0xFF )
            {
              v37 = 0;
              LOBYTE(v10) = 0xFF;
              break;
            }
            if ( v12 >= v10 )
            {
              v10 = v12 + 1;
              if ( v12 + 1 >= v9 )
              {
                v9 = v12 + 2;
              }
            }
          }
          s[k] = v10;
        }
      }
    }
    while ( !v37 );
    memset(v24, 0, sizeof(v24));
    for ( n = 0; n < V_Research.num; ++n )
    {
      v14 = (unsigned __int8)s[n];
      ++v24[v14];
    }
    if ( v9 > 0 )
    {
      v38 = 0;
      v34 = 0;
      vector = a1->vectors;
      v33 = 0xF0;
      do
      {
        v39 = 4;
        degrees = (float)(0x1E * v38 + 0xF0);
        v15 = (unsigned __int8)v24[v38];
        if ( v38 % 2 && (unsigned __int8)v24[v38] > 2u )
        {
          --v15;
        }
        else if ( (unsigned __int8)v24[v38] > 1u )
        {
          v39 = 0x17;
        }
        v16 = vector;
        v17 = 0;
        v36 = 0x1E * v38;
        for ( ii = 0; ii < V_Research.num; ++ii )
        {
          if ( (unsigned __int8)s[ii] == v38 )
          {
            v31 = 0xF * (v17 & 1) + v36;
            v16[ii].y = (float)v31;
            v16[ii].z = (float)v39;
            v23 = degrees;
            v16[ii].x = 0.0;
            Q_Vector3D_RotateY_sub_532AC(&v16[ii], v23);
            v31 = 0x168 / v15;
            ++v17;
            v39 = 0x17;
            degrees = (double)(0x168 / v15) + degrees;
          }
        }
        ++v38;
      }
      while ( v9 > v38 );
    }
  }
}
// 105254: using guessed type int V_ResTreeTxtLoaded;
// 46CAC: using guessed type char s[100];
// 46CAC: using guessed type char var_120[100];

//----- (00047088) --------------------------------------------------------
int __fastcall sub_47088(P_Wnd9RW a1)
{
  int v1; // ebp
  int v2; // ecx
  char *v3; // edi
  int techIndex; // esi
  char *v5; // eax
  int v6; // edx
  int v7; // eax
  int result; // eax
  int v10; // [esp+4h] [ebp-20h]
  int v11; // [esp+8h] [ebp-1Ch]

  v11 = 0xFFFF;
  v1 = V_Mouse.x - a1->a.pane.x0;
  v2 = V_Research.num - 1;
  v10 = V_Mouse.y - a1->a.pane.y0;
  if ( v2 >= 0 )
  {
    v3 = (char *)a1 + 2 * v2;
    while ( 1 )
    {
      techIndex = *(unsigned __int16 *)(v3 + 0x913);
      if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, techIndex, 0xFFFFFFFF) )
      {
        v5 = (char *)a1 + 2 * techIndex;
        v6 = *(__int16 *)(v5 + 0x5F3);
        if ( v1 > v6 - 0x19 && v1 < v6 + 0x19 )
        {
          v7 = *(__int16 *)(v5 + 0x6BB);
          if ( v7 - 0x19 < v10 && v7 + 0x19 > v10 )
          {
            break;
          }
        }
      }
      --v2;
      v3 += 0xFFFFFFFE;
      if ( v2 < 0 )
      {
        goto LABEL_12;
      }
    }
    v11 = techIndex;
  }
LABEL_12:
  result = v11;
  if ( (_WORD)v11 != a1->Unknown_9DB )
  {
    a1->Unknown_9DB = v11;
    dword_106FD0 = 0xFFFFFFFF;
    dword_106FD4 = 0xFFFFFFFF;
  }
  return result;
}
// 106FD0: using guessed type int dword_106FD0;
// 106FD4: using guessed type int dword_106FD4;

//----- (00047224) --------------------------------------------------------
unsigned int __fastcall sub_47224(P_Wnd9RW a1, UWORD message, int param1, ULONG param2)
{
  char v7; // cl
  char v8; // cl
  int v9; // eax
  UBYTE v10; // cl
  int v11; // eax
  char v12; // cl
  P_Procs v13; // ebx
  P_Procs pProcs; // ebx
  int v15; // eax
  double v16; // st7
  int index; // edx
  int v18; // edx
  __int16 Unknown_9DB; // ax
  int i; // edx
  int j; // edx
  int k; // edx
  float v24; // [esp+10h] [ebp-14h]
  float v25; // [esp+10h] [ebp-14h]
  float v26; // [esp+14h] [ebp-10h]
  float v27; // [esp+14h] [ebp-10h]

  if ( message < 6u )
  {
    if ( message < 2u )
    {
      if ( message != 1 )
      {
        return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
      }
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);// 28: data\gizmos.shp
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1E]);// 30: data\planitem.shp
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE]);
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);// 31: data\restree.shp
      dword_106FD8 = 0;
      dword_106FCC = 0xFFFFFFFF;
      dword_106FD0 = 0xFFFFFFFF;
      a1->Unknown_9DB = 0xFFFF;
      Q_WndA2_Proc3_sub_2F424(&a1->a, 1u, param1, param2);
      Q_WinMgr_sub_56400(&WinMgr, a1->a.index, 0x3A, 0, 0, 0);
      return 0;
    }
    if ( message <= 2u )
    {
      v7 = 1 << V_PlayerRaceIndex;
      for ( i = 0; i < V_Research.num; ++i )
      {
        V_Research.techs[i].Unknown_49 &= ~v7;
      }
      Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
      Q_WinMgr_sub_564C0(&WinMgr, a1->a.index, 0xFFFFFFFF);
      return 0;
    }
    if ( message > 3u )
    {
      if ( !a1->a.Unknown_35 )
      {
        return 0;
      }
      sub_47088(a1);
      LOWORD(v18) = a1->Unknown_9DB;
      if ( (unsigned __int16)v18 == 0xFFFF )
      {
        return 0;
      }
      HIWORD(v18) = 0;
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[v18].knownToRace) != 0
        || Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, v18, 0xFFFFFFFF) == FALSE )
      {
        return 0;
      }
      Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 0);
      dword_106FD4 = 0xFFFFFFFF;
      Unknown_9DB = a1->Unknown_9DB;
      dword_106FD0 = 0xFFFFFFFF;
      V_Research.current.project[V_PlayerRaceIndex] = Unknown_9DB;
      return 0;
    }
    if ( param2 < 0x2E )
    {
      if ( param2 < 0xD )
      {
        if ( param2 == 0xC && WinMgr.j > 0.1 )
        {
          WinMgr.j = WinMgr.j * 0.8;
          sub_47088(a1);
          return 0;
        }
        goto LABEL_60;
      }
      if ( param2 <= 0xD )
      {
        if ( WinMgr.j < 10.0 )
        {
          WinMgr.j = WinMgr.j * 1.25;
          sub_47088(a1);
          return 0;
        }
        goto LABEL_60;
      }
      if ( param2 >= 0x20 )
      {
        if ( param2 <= 0x20 )
        {
          if ( V_CheatMode == FALSE )
          {
            goto LABEL_60;
          }
          v8 = 1 << V_PlayerRaceIndex;
          for ( j = 0; j < V_Research.num; ++j )
          {
            *((_BYTE *)&V_ResTreeTxtLoaded + 0x4B * j + 0x4E) = v8 | V_Research.techs[j].knownToRace;
          }
        }
        else
        {
          if ( param2 != 0x21 || V_CheatMode == FALSE )
          {
            goto LABEL_60;
          }
          v12 = 1 << V_PlayerRaceIndex;
          for ( k = 0; k < V_Research.num; ++k )
          {
            *((_BYTE *)&V_ResTreeTxtLoaded + 0x4B * k + 0x4E) = ~v12 & V_Research.techs[k].knownToRace;
          }
        }
        v9 = V_PlayerRaceIndex;
        V_Research.current.project[V_PlayerRaceIndex] = 0xFFFF;
        word_106FB4[v9] = 0;
        sub_47088(a1);
        return 0;
      }
    }
    else
    {
      if ( param2 > 0x2E )
      {
        if ( param2 < 0x49 )
        {
          if ( param2 < 0x32 )
          {
            goto LABEL_60;
          }
          if ( param2 <= 0x32 )
          {
            dword_106FC2 = ~dword_106FC2;
            Q_Proc_sub_5A320(0x14);
            dword_106FCC = 0xFFFFFFFF;
            dword_106FD4 = 0xFFFFFFFF;
            sub_47088(a1);
            return 0;
          }
          if ( param2 != 0x47 )
          {
            goto LABEL_60;
          }
        }
        else if ( param2 > 0x49 )
        {
          if ( param2 >= 0x4F && (param2 <= 0x4F || param2 == 0x51) )
          {
            pProcs = a1->a.pProcs;
            a1->camera.position.y = 1000000.0;
            pProcs->proc4_draw(&a1->a, 0);
            sub_47088(a1);
            return 0;
          }
          goto LABEL_60;
        }
        v13 = a1->a.pProcs;
        a1->camera.position.y = -100.0;
        v13->proc4_draw(&a1->a, 0);
        sub_47088(a1);
        return 0;
      }
      if ( V_CheatMode && V_Research.current.project[V_PlayerRaceIndex] != 0xFFFF )
      {
        v10 = V_PlayerRaceIndex;
        v11 = V_Research.current.project[V_PlayerRaceIndex];
        V_Research.techs[v11].knownToRace |= 1 << V_PlayerRaceIndex;
        V_Research.current.project[v10] = 0xFFFF;
        word_106FB4[v10] = 0;
        sub_47088(a1);
        return 0;
      }
    }
LABEL_60:
    sub_47088(a1);
    return 0;
  }
  if ( message <= 6u )
  {
    Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, a1->a.index, 8);
    sub_47088(a1);
    if ( (a1->a._mouseFocus & a1->a.Unknown_35 & a1->a.Unknown_39) == 0xFFFFFFFF )
    {
      ((void (*)(void))a1->a.pProcs->proc4_draw)();
    }
    return 0xFFFFFFFF;
  }
  if ( message < 0x32u )
  {
    if ( message <= 7u )
    {
      Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, a1->a.index, 4, 8, 0, 0);
      sub_47088(a1);
      if ( (a1->a._mouseFocus & a1->a.Unknown_35 & a1->a.Unknown_39) == 0xFFFFFFFF )
      {
        ((void (*)(void))a1->a.pProcs->proc5)();
      }
      return 0xFFFFFFFF;
    }
    if ( message != 8 )
    {
      return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
    }
    goto LABEL_60;
  }
  if ( message <= 0x35u )
  {
    if ( message == 0x32 )
    {
      if ( (dword_106FD8 & 4) != 0 )
      {
        if ( (dword_106FD8 & 8) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xF7;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFB;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 & 0xF3 | 4;
      }
    }
    if ( message == 0x33 )
    {
      if ( (dword_106FD8 & 4) != 0 )
      {
        if ( (dword_106FD8 & 8) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFB;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 | 8;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 | 0xC;
      }
    }
    if ( message == 0x34 )
    {
      if ( (dword_106FD8 & 1) != 0 )
      {
        if ( (dword_106FD8 & 2) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFD;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFE;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 & 0xFC | 1;
      }
    }
    if ( message == 0x35 )
    {
      if ( (dword_106FD8 & 1) != 0 )
      {
        if ( (dword_106FD8 & 2) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFE;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 | 2;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 | 3;
      }
    }
    if ( param1 != 4 )
    {
      return 0;
    }
    v15 = 4;
    if ( message == 0x34 || message == 0x35 )
    {
      v15 = 1;
    }
    Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, a1->a.index, 1, 0x38, v15, 0);
    return 0;
  }
  else
  {
    if ( message < 0x38u )
    {
      return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
    }
    if ( message > 0x38u )
    {
      if ( message != 0x3A )
      {
        return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
      }
      if ( (dword_106FD8 & 4) != 0 )
      {
        v26 = 3.0;
        if ( (dword_106FD8 & 8) != 0 )
        {
          v26 = -3.0;
        }
        v27 = v26 * WinMgr.j;
        Q_Matrix_RotateY_sub_53564((P_Matrix3x3D)&a1->camera._viewMatrix, v27);
        dword_106FD4 = 0xFFFFFFFF;
      }
      if ( (dword_106FD8 & 1) != 0 )
      {
        v24 = -2.0;
        if ( (dword_106FD8 & 2) != 0 )
        {
          v24 = 2.0;
        }
        v25 = v24 * WinMgr.j;
        v16 = a1->camera.position.y + v25;
        dword_106FD4 = 0xFFFFFFFF;
        a1->camera.position.y = v16;
      }
      if ( dword_106FD4 == 0xFFFFFFFF )
      {
        a1->a.pProcs->proc4_draw((P_WndA2)a1, 0);
        return 0;
      }
      return 0;
    }
    index = a1->a.index;
    dword_106FD8 &= ~param1;
    Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, index, 0xFFFF);
    return 0;
  }
}
// 105254: using guessed type int V_ResTreeTxtLoaded;
// 106FB4: using guessed type __int16 word_106FB4[7];
// 106FC2: using guessed type int dword_106FC2;
// 106FCC: using guessed type int dword_106FCC;
// 106FD0: using guessed type int dword_106FD0;
// 106FD4: using guessed type int dword_106FD4;
// 106FD8: using guessed type int dword_106FD8;

//----- (00047A64) --------------------------------------------------------
int __fastcall compar(WORD *a1, WORD *a2)
{
  unsigned __int16 v2; // si
  BOOL v3; // edx

  v2 = *a2;
  v3 = *(float *)&dword_106FDC[2 * (unsigned __int16)*a2] > (double)*(float *)&dword_106FDC[2 * (unsigned __int16)*a1];
  if ( *(float *)&dword_106FDC[2 * v2] < (double)*(float *)&dword_106FDC[2 * (unsigned __int16)*a1] )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (00047ABC) --------------------------------------------------------
void __fastcall sub_47ABC(P_Wnd9RW pWnd9RW)
{
  PANE *p_pane; // esi
  int v3; // eax
  int v4; // ebx
  P_Wnd9RW v5; // edx
  char v6; // bl
  unsigned __int16 v7; // dx
  int v8; // edx
  int v9; // eax
  int v10; // esi
  int v11; // edi
  int v12; // ecx
  __int16 v13; // ax
  void *ShapeTable_sub_1B084; // eax
  LONG v15; // esi
  UWORD ItemIndex_sub_1B270; // dx
  void *v17; // eax
  char *sub_1CEA8; // eax
  int v19; // esi
  void *v20; // eax
  void *v21; // eax
  LONG v22; // ebx
  UWORD v23; // di
  void *v24; // eax
  int v25; // edi
  int v26; // esi
  int v27; // eax
  int knownToRace; // edx
  int v29; // ebx
  int TurnsToComplete_sub_46C20; // eax
  int v31; // edx
  char *v32; // eax
  int v33; // eax
  char *v34; // eax
  int v35; // esi
  char *v36; // eax
  char *name; // eax
  int v38; // esi
  UWORD v39; // dx
  unsigned __int16 v40; // ax
  LONG v41; // ebp
  void *v42; // eax
  void *v43; // eax
  char *v44; // eax
  int v45; // esi
  int v46; // ebp
  void *v47; // esi
  char *v48; // eax
  unsigned __int16 v49; // di
  __int16 v50; // dx
  char *v51; // eax
  const char *v52; // eax
  UWORD v53; // dx
  void *v54; // eax
  void *v55; // eax
  int v56; // esi
  char *v57; // eax
  char *v58; // eax
  int v59; // kr0C_4
  LONG v60; // [esp-20h] [ebp-170h]
  LONG v61; // [esp-1Ch] [ebp-16Ch]
  LONG v62; // [esp-1Ch] [ebp-16Ch]
  LONG v63; // [esp-1Ch] [ebp-16Ch]
  LONG v64; // [esp-18h] [ebp-168h]
  LONG v65; // [esp-18h] [ebp-168h]
  LONG v66; // [esp-18h] [ebp-168h]
  LONG v67; // [esp-Ch] [ebp-15Ch]
  WORD v68; // [esp-Ch] [ebp-15Ch]
  WORD v69; // [esp-Ch] [ebp-15Ch]
  LONG v70; // [esp-Ch] [ebp-15Ch]
  WORD v71; // [esp-Ch] [ebp-15Ch]
  WORD v72; // [esp-Ch] [ebp-15Ch]
  WORD v73; // [esp-Ch] [ebp-15Ch]
  LONG v74; // [esp-8h] [ebp-158h]
  LONG v75; // [esp-8h] [ebp-158h]
  LONG v76; // [esp-8h] [ebp-158h]
  LONG v77; // [esp-8h] [ebp-158h]
  LONG v78; // [esp-8h] [ebp-158h]
  char *v79; // [esp-8h] [ebp-158h]
  UBYTE *v80; // [esp-4h] [ebp-154h]
  LONG v81; // [esp-4h] [ebp-154h]
  LONG v82; // [esp-4h] [ebp-154h]
  LONG v83; // [esp-4h] [ebp-154h]
  char *v84; // [esp-4h] [ebp-154h]
  char *v85; // [esp-4h] [ebp-154h]
  char v86[100]; // [esp+0h] [ebp-150h]
  char s[80]; // [esp+64h] [ebp-ECh] BYREF
  PANE pPane; // [esp+B4h] [ebp-9Ch] BYREF
  PANE v89; // [esp+C8h] [ebp-88h] BYREF
  T_Vector3D vector1; // [esp+DCh] [ebp-74h] BYREF
  LONG hotX; // [esp+E8h] [ebp-68h] BYREF
  LONG hotY; // [esp+ECh] [ebp-64h] BYREF
  float y_; // [esp+F0h] [ebp-60h]
  int v94; // [esp+F4h] [ebp-5Ch]
  int techIndex; // [esp+F8h] [ebp-58h]
  int v96; // [esp+FCh] [ebp-54h]
  int v97; // [esp+100h] [ebp-50h]
  T_Matrix3x4 *pTRS; // [esp+104h] [ebp-4Ch]
  float y; // [esp+108h] [ebp-48h]
  LONG x_scale; // [esp+10Ch] [ebp-44h]
  P_Wnd9RW v101; // [esp+110h] [ebp-40h]
  P_Wnd9RW v102; // [esp+114h] [ebp-3Ch]
  T_Wnd09RW *v103; // [esp+118h] [ebp-38h]
  int v104; // [esp+11Ch] [ebp-34h]
  int v105; // [esp+120h] [ebp-30h]
  int v106; // [esp+124h] [ebp-2Ch]
  LONG v107; // [esp+128h] [ebp-28h]
  int v108; // [esp+12Ch] [ebp-24h]
  PANE *pane; // [esp+130h] [ebp-20h]
  int v110; // [esp+134h] [ebp-1Ch]
  LONG shape_number; // [esp+138h] [ebp-18h]

  pPane = pWnd9RW->a.pane;
  p_pane = &pWnd9RW->a.pane;
  VFX_pane_wipe(&pWnd9RW->a.pane, 0);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, p_pane);
  y = pWnd9RW->vectors[0].y;
  y_ = y;
  for ( techIndex = 0; V_Research.num > techIndex; ++techIndex )
  {
    if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, techIndex, -1u) )
    {
      if ( pWnd9RW->vectors[techIndex].y < (double)y_ )
      {
        y_ = pWnd9RW->vectors[techIndex].y;
      }
      if ( pWnd9RW->vectors[techIndex].y > (double)y )
      {
        y = pWnd9RW->vectors[techIndex].y;
      }
    }
  }
  if ( pWnd9RW->camera.position.y >= (double)y_ )
  {
    if ( pWnd9RW->camera.position.y <= (double)y )
    {
      goto LABEL_14;
    }
    v3 = LODWORD(y);
  }
  else
  {
    v3 = LODWORD(y_);
  }
  LODWORD(pWnd9RW->camera.position.y) = v3;
LABEL_14:
  Q_Camera_BuildTransform_sub_1B864(&pWnd9RW->camera);
  techIndex = 0;
  pTRS = &pWnd9RW->camera.trs;
  v103 = pWnd9RW;
  v101 = pWnd9RW;
  v59 = 0;
  while ( V_Research.num > techIndex )
  {
    memset(&vector1, 0, sizeof(vector1));
    Q_M34xV_sub_53384(&pWnd9RW->vectors[v59], pTRS, &vector1);
    v4 = techIndex;
    *(float *)&pWnd9RW->Unknown_783[2 * v59] = vector1.z;
    v5 = v103;
    Q_Project3DTo2D_sub_533D4(&vector1, pWnd9RW->camera._scaleFactor, 235, 240, &pWnd9RW->Unknown_5F3[v59], &pWnd9RW->Unknown_6BB[v59]);
    v5->Unknown_913[0] = techIndex;
    techIndex = v4 + 1;
    v103 = (T_Wnd09RW *)((char *)&v5->a.magic12345678 + 2);
    ++v59;
  }
  dword_106FDC = pWnd9RW->Unknown_783;
  qsort(pWnd9RW->Unknown_913, V_Research.num, 2u, (int (__fastcall *)(const void *, const void *))compar);
  techIndex = 0;
  while ( V_Research.num > techIndex )
  {
    v6 = techIndex;
    v7 = pWnd9RW->Unknown_913[techIndex++];
    v86[v7] = v6;
  }
  v110 = V_Research.current.project[V_PlayerRaceIndex];
  pane = &pWnd9RW->a.pane;
  v102 = pWnd9RW;
  for ( techIndex = 0; V_Research.num > techIndex; ++techIndex )
  {
    v107 = (unsigned __int16)pWnd9RW->Unknown_913[techIndex];
    if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, v107, 0xFFFFFFFF) )
    {
      v104 = (int)((*(float *)&pWnd9RW->Unknown_783[2 * v107] + pWnd9RW->camera.position.z) * 0.25);
      if ( v104 >= (int)0xFFFFFFFD )
      {
        if ( v104 > 3 )
        {
          v104 = 3;
        }
      }
      else
      {
        v104 = 0xFFFFFFFD;
      }
      v80 = (*V_GSystem.hazeTables)[v104 + 4];
      v104 += 3;
      VFX_shape_lookaside(v80);
      v105 = 0;
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[v107].knownToRace) != 0 )
      {
        v105 = 0x14;
      }
      else if ( (unsigned __int16)v110 == v107 )
      {
        v8 = v107 ^ (unsigned __int16)v110;
        LOBYTE(v8) = V_PlayerRaceIndex;
        v9 = 18 * (unsigned __int16)word_106FB4[v8] / V_Research.techs[v107].cost + 2;
        v105 = v9;
        if ( v9 >= (int)0xFFFFFFEF )
        {
          if ( v9 > 17 )
          {
            v105 = 17;
          }
        }
        else
        {
          v105 = 0xFFFFFFEF;
        }
      }
      v10 = 0x4B * v107;
      v106 = (int)pWnd9RW + 2 * v107;
      v11 = 0;
      v108 = (int)pWnd9RW + 4 * v107;
      while ( 1 )
      {
        v12 = V_Research.techs[0].preq[v10];
        if ( v12 == 0xFF )
        {
          break;
        }
        if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, V_Research.techs[0].preq[v10], 0xFFFFFFFF) )
        {
          v96 = (int)(((*(float *)(v108 + 0x783) + *(float *)&pWnd9RW->Unknown_783[2 * v12]) * 0.5 + pWnd9RW->camera.position.z) * 0.25);
          if ( v96 <= 3 )
          {
            if ( v96 < (int)0xFFFFFFFD )
            {
              v96 = 0xFFFFFFFD;
            }
          }
          else
          {
            v96 = 3;
          }
          v13 = 0x6B - v96;
          if ( v12 == (unsigned __int16)pWnd9RW->Unknown_9DB )
          {
            v13 = 0xF3;
          }
          VFX_line_draw(
            pane,
            *(__int16 *)(v106 + 0x5F3),
            *(__int16 *)(v106 + 0x6BB) - 0x1B,
            pWnd9RW->Unknown_5F3[v12],
            pWnd9RW->Unknown_6BB[v12] + 0x1B,
            0,
            v13);
          ++v11;
          ++v10;
          if ( v11 >= 5 )
          {
            break;
          }
        }
        else
        {
          ++v11;
          ++v10;
          if ( v11 >= 5 )
          {
            break;
          }
        }
      }
      if ( v105 )
      {
        v105 = (v105 << 0x10) / 0x14;
        v74 = v105;
        v67 = v105;
        v64 = pWnd9RW->Unknown_6BB[v107];
        v61 = pWnd9RW->Unknown_5F3[v107];
        v60 = v107;
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);// 31: data\restree.shp
        VFX_shape_transform(pane, ShapeTable_sub_1B084, v60, v61, v64, V_BigBuffer, 0, v67, v74, 1);
      }
      v15 = 1;
      if ( (unsigned __int16)v110 == v107 && ((1 << V_PlayerRaceIndex) & V_Research.techs[v107].knownToRace) == 0 )
      {
        v15 = 0;
      }
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[v107].Unknown_49) != 0 )
      {
        v15 = 3;
      }
      if ( (unsigned __int16)pWnd9RW->Unknown_9DB == v107 )
      {
        v15 = 2;
      }
      ItemIndex_sub_1B270 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "data\\resring.shp", 0xFFFFFFFF);
      v81 = pWnd9RW->Unknown_6BB[v107];
      v75 = pWnd9RW->Unknown_5F3[v107];
      v17 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, ItemIndex_sub_1B270);
      if ( v15 == 2 )
      {
        VFX_shape_draw(pane, v17, 2, v75, v81);
      }
      else
      {
        VFX_shape_translate_draw(pane, v17, v15, v75, v81);
      }
    }
  }
  WinMgr.LargeFont.pane = pWnd9RW->a.pane;
  if ( dword_106FD0 == 0xFFFFFFFF )
  {
    pPane.y1 = 0x1AA;
    pPane.x0 = 0x1E5;
    pPane.y0 = 7;
    pPane.x1 = 0x278;
    VFX_pane_wipe(&pPane, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
    shape_number = 0xFFFF;
    if ( (unsigned __int16)v110 != 0xFFFF )
    {
      shape_number = (unsigned __int16)v110;
    }
    if ( (unsigned __int16)pWnd9RW->Unknown_9DB != 0xFFFF )
    {
      shape_number = (unsigned __int16)pWnd9RW->Unknown_9DB;
    }
    if ( (unsigned __int16)shape_number != 0xFFFF )
    {
      WinMgr.LargeFont.pane = pPane;
      v94 = 0xFFFFFFFF;
      v89 = pPane;
      if ( (_WORD)shape_number == (_WORD)v110 )
      {
        if ( (_WORD)shape_number != pWnd9RW->Unknown_9DB )
        {
          v94 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
        }
        v68 = v94;
        sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7A);// 122: "Current Project:"
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xA, sub_1CEA8, 2u, v68, 0xFFFF, 0x82);
      }
      v19 = (unsigned __int16)shape_number;
      v97 = 0x46;
      v89.y1 = 0x78;
      v20 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);// 31: data\restree.shp
      Q_Pane_CenterShape_sub_2BC40(&v89, v20, (unsigned __int16)v19, &hotX, &hotY);
      v82 = hotY;
      v76 = hotX;
      v21 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);// 31: data\restree.shp
      VFX_shape_draw(&v89, v21, (unsigned __int16)v19, v76, v82);
      v22 = 1;
      v23 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "data\\resring.shp", 0xFFFFFFFF);
      if ( (_WORD)v19 == (_WORD)v110 && ((1 << V_PlayerRaceIndex) & V_Research.techs[v19].knownToRace) == 0 )
      {
        v22 = 0;
      }
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[(unsigned __int16)shape_number].Unknown_49) != 0 )
      {
        v22 = 3;
      }
      if ( (_WORD)shape_number == pWnd9RW->Unknown_9DB )
      {
        v22 = 2;
      }
      v83 = hotY;
      v77 = hotX;
      v24 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v23);
      VFX_shape_draw(&v89, v24, v22, v77, v83);
      v26 = (unsigned __int16)shape_number;
      v97 += 0x19;
      v25 = v97;
      v27 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v97, V_Research.techs[v26].name, 2u, v94, 0xFFFF, 0x82);
      knownToRace = V_Research.techs[v26].knownToRace;
      v97 = v25 + v27;
      if ( ((1 << V_PlayerRaceIndex) & knownToRace) == 0 )
      {
        v29 = sub_469F0(&V_Research, V_PlayerRaceIndex);
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(
                                      V_Research.techs[v26].cost,
                                      (unsigned __int16)word_106FB4[V_PlayerRaceIndex],
                                      v29);
        v31 = TurnsToComplete_sub_46C20;
        if ( TurnsToComplete_sub_46C20 == 0xFFFF )
        {
          v32 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7B);// 123: "(No Progress)"
          strcpy(s, v32);
        }
        else
        {
          if ( TurnsToComplete_sub_46C20 == 1 )
          {
            v33 = 0x1C;                                // 28: ""
          }
          else
          {
            v33 = 0x1D;                                // 29: "s"
          }
          v84 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v33);
          v34 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7C);// 124: "(%d day%s)"
          sprintf(s, v34, v31, v84);
        }
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v97, s, 2u, v94, 0xFFFF, 0x82);
      }
      v35 = 0x8E;
      for ( techIndex = 0; techIndex < 0x27; ++techIndex )
      {
        if ( V_PlanetItems.item[techIndex].resReq == (unsigned __int16)shape_number )
        {
          if ( v35 == 0x8E )
          {
            v69 = v94;
            v36 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7D);// 125: "Allows"
            v35 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x8E, v36, 2u, v69, 0xFFFF, 0x82) + 0x98;
          }
          name = V_PlanetItems.item[techIndex].name;
          if ( (_BYTE)techIndex == 0x17 )
          {
            name = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7E);// 126: "Ships: Small and Medium Hulls"
          }
          v38 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, name, 2u, v94, 0xFFFF, 0x82) + v35;
          x_scale = (LONG)sub_10000;
          v89.y0 = v38 + 1;
          v39 = GwshareShpCacheIndexes[0x1E];          // 30: data\planitem.shp
          v89.y1 = v38 + 0x48;
          v40 = techIndex;
          if ( (_BYTE)techIndex == 0x17 )
          {
            x_scale = 0x8000;
            v39 = GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE];
            v40 = 0;
          }
          v41 = v40;
          v42 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v39);
          Q_Pane_CenterShape_sub_2BC40(&v89, v42, v41, &hotX, &hotY);
          v78 = x_scale;
          v70 = x_scale;
          v65 = hotY;
          v62 = hotX;
          v43 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v39);
          v35 = v38 + 0x48;
          VFX_shape_transform(&v89, v43, v41, v62, v65, V_BigBuffer, 0, v70, v78, 0);
        }
      }
      for ( techIndex = 0; techIndex < 0x4C; ++techIndex )
      {
        if ( V_Gizmos[techIndex].resReq == (unsigned __int16)shape_number )
        {
          if ( v35 == 0x8E )
          {
            v71 = v94;
            v44 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7D);// 125: "Allows"
            v35 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x8E, v44, 2u, v71, 0xFFFF, 0x82) + 0x98;
          }
          v45 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, V_Gizmos[techIndex].name, 2u, v94, 0xFFFF, 0x82) + v35;
          v89.y0 = v45 + 1;
          v46 = v45 + 0x48;
          v89.y1 = v45 + 0x48;
          v47 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);// 28: data\gizmos.shp
          Q_Pane_CenterShape_sub_2BC40(&v89, v47, techIndex, &hotX, &hotY);
          VFX_shape_draw(&v89, v47, techIndex, hotX, hotY);
          v35 = v46;
        }
      }
      if ( (unsigned __int16)shape_number == 0x13 || (unsigned __int16)shape_number == 0x1F )
      {
        if ( v35 == 0x8E )
        {
          v72 = v94;
          v48 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7D);// 125: "Allows"
          v35 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x8E, v48, 2u, v72, 0xFFFF, 0x82) + 0x98;
        }
        v49 = 2;
        v50 = shape_number;
        v51 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7F);// 127: "Large Ship Hull"
        if ( v50 == 0x1F )
        {
          v49 = 3;
          v51 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x80);// 128: "Gigantic Ship Hull"
        }
        v89.y0 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, v51, 2u, v94, 0xFFFF, 0x82) + v35 + 1;
        v53 = GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE];
        v89.y1 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, v52, 2u, v94, 0xFFFF, 0x82) + v35 + 0x48;
        v54 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v53);
        Q_Pane_CenterShape_sub_2BC40(&v89, v54, v49, &hotX, &hotY);
        v66 = hotY;
        v63 = hotX;
        v55 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v53);
        VFX_shape_transform(&v89, v55, v49, v63, v66, V_BigBuffer, 0, 0x8000, 0x8000, 0);
      }
    }
    dword_106FD0 = 0;
  }
  v56 = dword_106FCC;
  if ( dword_106FCC == 0xFFFFFFFF )
  {
    pPane.x0 = 7;
    pPane.x1 = 0x1DC;
    pPane.y1 = 0x25;
    pPane.y0 = 7;
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
    Q_DrawRaceFlagTinted_sub_53E38(&pPane, 3, 3, V_PlayerRaceIndex);
    v57 = (char *)&unk_92696;
    if ( dword_106FC2 == v56 )
    {
      v57 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x81);  // 129: "(Self Managed)"
    }
    v85 = v57;
    v79 = V_SpecNames[V_Game.races[V_PlayerRaceIndex].species];
    v58 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x82);    // 130: "%s Knowledge %s"
    sprintf(s, v58, v79, v85);
    v73 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
    WinMgr.LargeFont.pane = pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, s, 3u, v73, 0xFF, 0);
    dword_106FCC = 0;
  }
  dword_106FD4 = 0;
}
/* Orphan comments:
123: "(No Progress)"
*/
// 10000: using guessed type void __noreturn sub_10000();
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 106FB4: using guessed type __int16 word_106FB4[7];
// 106FC2: using guessed type int dword_106FC2;
// 106FCC: using guessed type int dword_106FCC;
// 106FD0: using guessed type int dword_106FD0;
// 106FD4: using guessed type int dword_106FD4;
// 47ABC: using guessed type char var_150[100];
// 47ABC: using guessed type char s[80];

//----- (00048B14) --------------------------------------------------------
int __fastcall sub_48B14(int a1, unsigned int count, int a3)
{
  void *v5; // edx

  v5 = (void *)(a1 + 0xAB);
  if ( a3 == 0xFFFFFFFF )
  {
    return Q_CFile_Read_sub_1BF94((P_CFile)count, v5, 0x98u);
  }
  else
  {
    return Q_CFile_Write_sub_1C098((P_CFile)count, v5, 0x98u);
  }
}

//----- (00048B40) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd9RWCtor_sub_48B40(P_Wnd9RW a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a);
  Q_Camera_ResetToIdentity_sub_1B4F0(&a1->camera);
  _wcpp_2_ctor_array_(a1->vectors, 100u, &C_Vector3D);
  a1->a.pProcs = &Wnd9RW_Procs;
  sub_46CAC(a1);
}

//----- (00048B90) --------------------------------------------------------
void __fastcall __spoils<> Q_Ship_Ctor_sub_48B90(P_Ship pShip)
{
  pShip->Unknown_6C.x = 0.0;
  pShip->Unknown_6C.y = 0.0;
  pShip->Unknown_6C.z = 0.0;
  pShip->Unknown_78.x = 0.0;
  pShip->Unknown_78.y = 0.0;
  pShip->Unknown_78.z = 0.0;
  pShip->position.x = 0.0;
  pShip->position.y = 0.0;
  pShip->position.z = 0.0;
  sub_48C5C(pShip, 0);
}

//----- (00048C5C) --------------------------------------------------------
void __fastcall sub_48C5C(P_Ship pShip, char hullSize)
{
  sub_48EAC(pShip);
  Q_Ship_SetSize_sub_49148(pShip, hullSize);
}

//----- (00048C84) --------------------------------------------------------
void __fastcall Q_Ship_LoadGizmosTxt_sub_48C84(P_Ship pShip)
{
  FILE *fp; // esi
  MACRO_VFX_BOOL found; // ecx
  T_Gizmo *v3; // kr04_4
  int v4; // ebx
  int v5; // kr10_4
  int zero; // eax
  int i; // ebp
  char buf[200]; // [esp+0h] [ebp-104h] BYREF
  BYTE val1; // [esp+C8h] [ebp-3Ch] BYREF
  int val2; // [esp+CCh] [ebp-38h] BYREF
  int val3; // [esp+D0h] [ebp-34h] BYREF
  int val4; // [esp+D4h] [ebp-30h] BYREF
  int val5; // [esp+D8h] [ebp-2Ch] BYREF
  int val6; // [esp+DCh] [ebp-28h] BYREF
  int val7; // [esp+E0h] [ebp-24h] BYREF
  int val8; // [esp+E4h] [ebp-20h] BYREF
  int val9; // [esp+E8h] [ebp-1Ch] BYREF

  fp = Q_OpenTextFile_sub_1BB10("gizmos.txt", 0);
  if ( fp )
  {
    found = FALSE;
    do
    {
      fgets(buf, 200, fp);
      if ( buf[0] == '#' )
      {
        found = TRUE;
      }
    }
    while ( found == FALSE );
    v3 = V_Gizmos;
    for ( i = 0; i < 76; ++i )
    {
      fscanf(fp, "%s", &v3[i]);
      v4 = 0;
      v3 = (T_Gizmo *)(strlen(v3[i].name) + 1);
      if ( (int)&v3[0xFFFFFFFF].generatorPower + 3 > 0 )
      {
        v5 = 0;
        do
        {
          if ( v3[i].name[v5] == '^' )
          {
            v3[i].name[v5] = ' ';
          }
          ++v4;
          ++v5;
        }
        while ( v4 < (int)&v3[0xFFFFFFFF].generatorPower + 3 );
      }
      fscanf(fp, "%d %d %d %d %d %d %d %d %d", &val1, &val2, &val3, &val4, &val5, &val6, &val7, &val8, &val9);
      v3[i].cat = val1;
      v3[i].power = val2;
      v3[i].range = val3;
      v3[i].level = val4;
      v3[i].numUses = val5;
      v3[i].industry = val6;
      v3[i].special1 = val7;
      v3[i].special2 = val8;
      v3[i].resReq = val9;
      fscanf(fp, "%d", &val9);
      v3[i].flags = 0;
      while ( val9 != 0xFF )
      {
        LOWORD(v4) = v3[i].flags;
        v4 |= 1 << val9;
        v3[i].flags = v4;
        fscanf(fp, "%d", &val9);
      }
      v3[i].generatorPower = 0;
      zero = v3[i].generatorPower;
      v3[i].scannerRangePerTurn = zero;
      v3[i].driveMaxDistance = zero;
      v3[i].Unknown_5A = zero;
      v3[i].shieldStrength = zero;
      v3[i].weaponDamage = zero;
      switch ( v3[i].cat )
      {
        case ASCEND_GIZMO_CAT_WEAPON:
          v3[i].weaponDamage = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_SHIELD:
          v3[i].shieldStrength = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_DRIVE:
          v3[i].driveMaxDistance = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_SCANNER:
          v3[i].scannerRangePerTurn = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_GENERATOR:
          v3[i].generatorPower = v3[i].power;
          break;
        default:
          continue;
      }
    }
    fclose(fp);
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0xBE);
  }
}
// 48C84: using guessed type char buf[200];

//----- (00048EAC) --------------------------------------------------------
void __fastcall sub_48EAC(P_Ship pShip)
{
  int i; // kr04_4
  char *sub_1CEA8; // eax
  int k; // ebp
  UBYTE v5; // dl
  int v6; // esi
  int v7; // ebx
  UBYTE v8; // di
  int v9; // ecx
  UBYTE v10; // dl
  int v11; // ebp
  int v12; // esi
  double v13; // st7
  int v14; // ebx
  int j; // kr0C_4
  int n; // [esp+4h] [ebp-38h]
  int m; // [esp+10h] [ebp-2Ch]
  UBYTE v18; // [esp+14h] [ebp-28h]
  float v19; // [esp+1Ch] [ebp-20h]
  float v20; // [esp+1Ch] [ebp-20h]
  float v21; // [esp+20h] [ebp-1Ch]

  pShip->gizmosNum = 0;
  pShip->totalWeaponDamage = 0;
  pShip->totalShieldStrength = 0;
  pShip->totalStarLaneDrivePotential = 0;
  pShip->totalDriveMaxDistance = 0;
  pShip->totalScannerRangePerTurn = 0;
  pShip->cloakingLevel = 0;
  pShip->totalGeneratorPower = 0;
  pShip->totalPowerForDrives = 0;
  pShip->Unknown_30 = 0;
  pShip->hasColonizer = 0;
  pShip->Unknown_2C = 0;
  pShip->name[0] = 0;
  pShip->raceIndex = 0xFFFF;
  pShip->locationType = 0;
  pShip->_currentShieldStrength = 0;
  pShip->hullIntegrity = 1;
  pShip->order = 0;
  pShip->_orderTargetObject.pPlanet = 0;
  pShip->availablePower = pShip->_currentShieldStrength;
  pShip->fullHullIntegrity = pShip->hullIntegrity;
  for ( i = 0; i != 0x19; ++i )
  {
    pShip->hullCells[i].gizmoIndex = 0xFF;
    pShip->hullCells[i]._usesPerTurnLeft = 0;
    pShip->hullCells[i].active = 0;
  }
  if ( !dword_10701C )
  {
    for ( j = 0; j != 4; ++j )
    {
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(j + 0x83);// 131: "Small"
      strcpy(V_HullNames[j], sub_1CEA8);
    }
    Q_Ship_LoadGizmosTxt_sub_48C84(pShip);
    word_107018 = 0;
    for ( k = 0; k < 14; ++k )
    {
      v5 = 1;
      v6 = byte_969B8[k];
      v7 = 0;
      if ( byte_969B8[k] )
      {
        v8 = byte_969C8[k];
        do
        {
          if ( (v5 & v8) != 0 )
          {
            ++word_107018;
          }
          ++v7;
          v5 *= 2;
        }
        while ( v7 < v6 );
      }
    }
    for ( m = 0; m < 4; ++m )
    {
      v9 = V_HullCells[m];
      v19 = (float)word_107018;
      v20 = v19 / (double)(v9 - 1);
      v21 = v20;
      for ( n = 0; n < 14; ++n )
      {
        if ( v9 <= 0 )
        {
          break;
        }
        v10 = 1;
        v11 = byte_969B8[n];
        v12 = 0;
        if ( byte_969B8[n] )
        {
          v18 = byte_969C8[n];
          do
          {
            if ( (v18 & v10) != 0 )
            {
              v13 = v21 + 1.0;
              v14 = m + 4 * n;
              v21 = v13;
              if ( v13 < v20 )
              {
                if ( v9 == 1 && v20 + -1.0 < v21 )
                {
                  v9 = 0;
                  byte_106FE0[v14] |= v10;
                }
              }
              else
              {
                --v9;
                v21 = v21 - v20;
                byte_106FE0[v14] |= v10;
              }
            }
            ++v12;
            v10 *= 2;
          }
          while ( v12 < v11 );
        }
      }
    }
    dword_10701C = TRUE;
  }
}
// 107018: using guessed type __int16 word_107018;
// 10701C: using guessed type int dword_10701C;

//----- (00049148) --------------------------------------------------------
void __fastcall Q_Ship_SetSize_sub_49148(P_Ship pShip, char hullSize)
{
  int raceIndex; // edx

  pShip->hullSize = hullSize;
  if ( hullSize >= 4 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x131);
  }
  pShip->hullCellsNum = V_HullCells[pShip->hullSize];
  if ( !pShip->name[0] || pShip->raceIndex != V_PlayerRaceIndex )
  {
    strcpy(pShip->name, V_HullNames[pShip->hullSize]);
  }
  raceIndex = pShip->raceIndex;
  pShip->hullIntegrity = 10 * (pShip->hullSize + 1);
  pShip->Unknown_14 = 0;
  if ( V_Game.races[raceIndex].ability == ASCEND_SA_DOUBLE_HULL )
  {
    pShip->hullIntegrity *= 2;
  }
  pShip->fullHullIntegrity = pShip->hullIntegrity;
}

//----- (000492AC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Ship_PutNewGizmoIntoCell_sub_492AC(P_Ship pShip, BYTE gizmoIndex, int hullCellIndex)
{
  BYTE gizmoIndexWas; // ch

  if ( hullCellIndex > pShip->hullCellsNum )
  {
    return FALSE;
  }
  gizmoIndexWas = pShip->hullCells[hullCellIndex].gizmoIndex;
  if ( gizmoIndex == gizmoIndexWas )
  {
    return FALSE;
  }
  if ( gizmoIndexWas == (BYTE)0xFF )
  {
    ++pShip->gizmosNum;
  }
  pShip->hullCells[hullCellIndex].gizmoIndex = gizmoIndex;
  Q_Ship_RecalcStats_sub_496E0(pShip);
  return TRUE;
}

//----- (000492F8) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Ship_RemoveGizmoFromCell_sub_492F8(P_Ship pShip, int hullCellIndex)
{
  if ( pShip->hullCells[hullCellIndex].gizmoIndex == (BYTE)0xFF )
  {
    return FALSE;
  }
  --pShip->gizmosNum;
  pShip->hullCells[hullCellIndex].gizmoIndex = 0xFF;
  Q_Ship_RecalcStats_sub_496E0(pShip);
  return TRUE;
}

//----- (00049328) --------------------------------------------------------
int __fastcall Q_Ship_FindFirstCellWithCat_sub_49328(P_Ship pShip, BYTE category)
{
  unsigned int NOT_FOUND; // edi
  int v5; // edx

  NOT_FOUND = 0xFFFFFFFF;
  v5 = 0;
  if ( pShip->hullCellsNum > 0 )
  {
    while ( pShip->hullCells[v5].gizmoIndex == (BYTE)0xFF || category != V_Gizmos[pShip->hullCells[v5].gizmoIndex].cat )
    {
      if ( ++v5 >= pShip->hullCellsNum )
      {
        return NOT_FOUND;
      }
    }
    return v5;
  }
  return NOT_FOUND;
}

//----- (0004937C) --------------------------------------------------------
// Finds the first hull cell index containing a specific gizmo
// Return Index of the hull cell containing the gizmo, or -1 if not found
int __fastcall Q_Ship_FindGizmoHullCellIndex_sub_4937C(P_Ship pShip, UBYTE gizmoIndex)
{
  int GIZMO_NOT_FOUND; // esi
  int hullCellsNum; // edx
  int hullCellIndex; // eax
  int i; // kr04_4

  GIZMO_NOT_FOUND = -1u;
  hullCellsNum = pShip->hullCellsNum;
  hullCellIndex = 0;
  if ( hullCellsNum > 0 )
  {
    for ( i = 0; gizmoIndex != pShip->hullCells[i].gizmoIndex; ++i )
    {
      if ( ++hullCellIndex >= pShip->hullCellsNum )
      {
        return GIZMO_NOT_FOUND;
      }
    }
    return hullCellIndex;
  }
  return GIZMO_NOT_FOUND;
}

//----- (000493BC) --------------------------------------------------------
// Changes a ship's hull size and reorganizes its components
// @return TRUE if successful, FALSE if new hull is too small for current components
MACRO_VFX_BOOL __fastcall Q_Ship_ChangeHullSize_sub_493BC(P_Ship pShip, BYTE newHullSize)
{
  int gizmosNum; // ebx
  MACRO_VFX_BOOL false; // eax
  int newCellIndex; // edi
  BYTE gizmoIndex; // bl
  int oldCellIndex; // esi

  if ( newHullSize != pShip->hullSize )
  {
    gizmosNum = pShip->gizmosNum;
    false = FALSE;
    // Check if new hull can accommodate current components
    if ( V_HullCells[newHullSize] < gizmosNum )
    {
      return false;
    }
    // Reorganize components if ship has any
    if ( pShip->hullCellsNum > 0 )
    {
      newCellIndex = 0;
      oldCellIndex = 0;
      do
      {
        gizmoIndex = pShip->hullCells[oldCellIndex].gizmoIndex;
        if ( gizmoIndex != (BYTE)0xFF )
        {
          Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, oldCellIndex);
          Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, gizmoIndex, newCellIndex++);
        }
        ++oldCellIndex;
      }
      while ( oldCellIndex < pShip->hullCellsNum );
    }
    Q_Ship_SetSize_sub_49148(pShip, newHullSize);
    strcpy(pShip->name, V_HullNames[pShip->hullSize]);
    Q_Ship_RecalcStats_sub_496E0(pShip);
  }
  return TRUE;
}

//----- (00049494) --------------------------------------------------------
void __fastcall Q_Ship_MoveIntoOrbit_sub_49494(P_Ship pShip, P_Planet pPlanet)
{
  double z; // st7
  int gyroInductor; // eax
  T_Vector3D v5; // [esp+0h] [ebp-3Ch] BYREF
  T_Vector3D v6; // [esp+Ch] [ebp-30h] BYREF
  T_Vector3D randomVector; // [esp+18h] [ebp-24h] BYREF
  int v8; // [esp+24h] [ebp-18h]
  T_Vector3D *v9; // [esp+28h] [ebp-14h]

  if ( Q_Planet_TryPlaceShipInOrbit_sub_35BB4(pPlanet, pShip) )
  {
    gyroInductor = Q_Ship_FindGizmoHullCellIndex_sub_4937C(pShip, ASCEND_GIZMO_67_GYRO_INDUCTOR);
    if ( gyroInductor != 0xFFFFFFFF && pShip->hullCells[gyroInductor]._usesPerTurnLeft )
    {
      // Generate power from Gyro-Inductor
      pShip->availablePower += V_Gizmos[ASCEND_GIZMO_67_GYRO_INDUCTOR].special1;
      --pShip->hullCells[gyroInductor]._usesPerTurnLeft;
    }
    if ( pShip->raceIndex == V_PlayerRaceIndex && pShip->order == ASCEND_SO_3_ORBITPLANET )
    {
      if ( WinMgr.state != ASCEND_WINMGR_STATE_BATTLE )
      {
        Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_16_ENTERED_ORBIT, (int)pShip, (int)pShip->_orderTargetObject.pPlanet);
      }
      pShip->order = ASCEND_SO_0_NOTHING;
      pShip->_orderTargetObject.pPlanet = 0;
    }
  }
  else
  {
    // Fail to orbit. Put in random location near planet.
    pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
    randomVector.x = (float)(rand() % 1000 - 500);
    randomVector.y = (float)(rand() % 1000 - 500);
    v8 = rand() % 1000 - 500;
    randomVector.z = (float)v8;
    Q_Vector3D_SetLength_sub_53054(&randomVector, 250.0);
    memset(&v6, 0, sizeof(v6));
    v9 = &v5;
    v6.x = pPlanet->position.x + randomVector.x;
    v6.y = pPlanet->position.y + randomVector.y;
    z = pPlanet->position.z;
    v5 = v6;
    v6.z = z + randomVector.z;
    Q_Ship_SetPositionAndSnapToGrid_sub_496BC(pShip, &v5);
  }
}

//----- (0004960C) --------------------------------------------------------
// Checks if a ship can travel through a star lane
// @return TRUE if ship can travel through lane, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Ship_CanTraverseStarLane_sub_4960C(P_Ship pShip, P_Lane pLane)
{
  if ( pShip->totalStarLaneHyperdrivePotential + pShip->totalStarLaneDrivePotential <= 0
    && V_Game.races[pShip->raceIndex].ability != ASCEND_SA_FAST_LANE_TRAVEL
    || (pLane->flags & ASCEND_LANE_FLAGS_2_BLOCKED) != 0 )
  {
    return FALSE;
  }
  else
  {
    return TRUE;
  }
}

//----- (00049648) --------------------------------------------------------
// Initiates star lane travel for a ship
void __fastcall Q_Ship_EnterStarLane_sub_49648(P_Ship pShip, P_Lane pLane)
{
  T_Star *pDepartureStar; // esi

  if ( Q_Ship_CanTraverseStarLane_sub_4960C(pShip, pLane) )
  {
    // Get departure star based on current location
    if ( pShip->locationType == ASCEND_LOCATION_TYPE_ORBIT )
    {
      pDepartureStar = &V_Game.stars[pShip->pLocation.pPlanet->starIndex];
    }
    else
    {
      pDepartureStar = pShip->pLocation.pStar;
    }
    // Handle departure from current location
    Q_HandleShipDeparture_sub_1D538((P_Location)pDepartureStar, pShip);
    // Update ship state for lane travel
    pShip->locationType = ASCEND_LOCATION_TYPE_STARLANE;
    pShip->position.x = 0.0;
    pShip->pLocation.pLane = pLane;
    // Set direction based on which star we're departing from
    if ( pDepartureStar == pLane->pStar1 )
    {
      // Traveling from star1 to star2
      pShip->position.y = 1.0;
    }
    else
    {
      // Traveling from star2 to star1
      pShip->position.y = 0.0;
    }
  }
}

//----- (000496BC) --------------------------------------------------------
void __fastcall Q_Ship_SetPositionAndSnapToGrid_sub_496BC(P_Ship pShip, P_Vector3D newPosition)
{
  pShip->position = *newPosition;
  Q_Vector3D_SnapToGrid_sub_53440(&pShip->position);
}

//----- (000496E0) --------------------------------------------------------
void __fastcall Q_Ship_RecalcStats_sub_496E0(P_Ship pShip)
{
  int Unknown_14; // eax
  int i; // esi
  int hullCellsNum; // edi
  T_Gizmo *pGizmo; // eax
  char gizmoIndex; // al
  int starLaneHyperdriveCount; // [esp+8h] [ebp-20h]
  int starLaneDriveCount; // [esp+Ch] [ebp-1Ch]

  pShip->totalWeaponDamage = 0;
  pShip->totalShieldStrength = 0;
  Unknown_14 = pShip->Unknown_14;
  pShip->totalScannerRangePerTurn = 0;
  pShip->cloakingLevel = 0;
  pShip->totalGeneratorPower = 0;
  pShip->totalPowerForDrives = 0;
  pShip->hasColonizer = 0;
  pShip->Unknown_2C = 0;
  starLaneDriveCount = 0;
  pShip->Unknown_30 = 0;
  starLaneHyperdriveCount = 0;
  hullCellsNum = pShip->hullCellsNum;
  pShip->totalDriveMaxDistance = Unknown_14;
  if ( hullCellsNum > 0 )
  {
    i = 0;
    do
    {
      if ( pShip->hullCells[i].gizmoIndex != (BYTE)0xFF )
      {
        pGizmo = &V_Gizmos[pShip->hullCells[i].gizmoIndex];
        pShip->totalWeaponDamage += pGizmo->weaponDamage;
        pShip->totalShieldStrength += pGizmo->shieldStrength;
        pShip->totalDriveMaxDistance += pGizmo->driveMaxDistance;
        pShip->totalScannerRangePerTurn += pGizmo->scannerRangePerTurn;
        pShip->totalGeneratorPower += pGizmo->generatorPower;
        if ( pGizmo->cat == ASCEND_GIZMO_CAT_DRIVE )
        {
          pShip->totalPowerForDrives += pGizmo->power;
        }
        gizmoIndex = pShip->hullCells[i].gizmoIndex;
        switch ( gizmoIndex )
        {
          case ASCEND_GIZMO_71_COLONIZER:
            pShip->hasColonizer = TRUE;
            break;
          case ASCEND_GIZMO_43_STAR_LANE_DRIVE:
            ++starLaneDriveCount;
            break;
          case ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE:
            ++starLaneHyperdriveCount;
            break;
          case ASCEND_GIZMO_42_CLOAKER:
            ++pShip->cloakingLevel;
            break;
        }
      }
      ++i;
    }
    while ( i < pShip->hullCellsNum );
  }
  pShip->totalStarLaneDrivePotential = (int)(sqrt((double)starLaneDriveCount) * 10.0);
  pShip->totalStarLaneHyperdrivePotential = (int)(sqrt((double)starLaneHyperdriveCount) * 20.0);
}

//----- (00049828) --------------------------------------------------------
void __fastcall sub_49828(P_Ship pShip)
{
  P_Planet pPlanet; // ecx
  int eventId; // edx
  P_Planet pPlanet_; // eax

  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SHIPYARD && pShip->locationType != ASCEND_LOCATION_TYPE_SHIPDOCK )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x260);
  }
  if ( !pShip->pLocation.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x261);
  }
  pPlanet = pShip->pLocation.pPlanet;
  if ( pShip->raceIndex != pPlanet->raceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x265);
  }
  if ( pShip->locationType == ASCEND_LOCATION_TYPE_SHIPYARD )
  {
    pShip->_dayBuilt = V_Game.day;
    if ( pShip->raceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_PLANET_ALLOC )
    {
      eventId = ASCEND_EP_17_SHIP_COMPLETE;
ADD_GAME_EVENT:
      Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, eventId, (int)pShip, (int)pPlanet);
    }
  }
  else if ( pShip->raceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_PLANET_ALLOC )
  {
    eventId = ASCEND_EP_18_REFIT_COMPLETE;
    goto ADD_GAME_EVENT;
  }
  pPlanet_ = pShip->pLocation.pPlanet;
  pShip->locationType = ASCEND_LOCATION_TYPE_ORBIT;
  Q_Star_HandleShipArrival_sub_1D3E8(&V_Game.stars[pPlanet_->starIndex], pShip, 0);
  Q_Ship_SetSize_sub_49148(pShip, pShip->hullSize);
  Q_Ship_Turn_sub_4A6AC(pShip);
}

//----- (00049940) --------------------------------------------------------
void __fastcall Q_Ship_RemoveFromTheGame_sub_49940(P_Ship pShip)
{
  P_Planet pPlanet; // esi
  int starIndex; // eax
  T_Star *pStar; // eax
  int squareIndex; // eax

  if ( !pShip->locationType )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x288);
  }
  switch ( pShip->locationType )
  {
    case ASCEND_LOCATION_TYPE_SHIPYARD:
    case ASCEND_LOCATION_TYPE_SHIPDOCK:
      pPlanet = pShip->pLocation.pPlanet;
      if ( pPlanet->_squareIndex >= pPlanet->totalSquaresNum )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x297);
      }
      if ( Q_Planet_GetShipAtSquare_sub_35A70(pShip->pLocation.pPlanet, pPlanet->_squareIndex) != pShip )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x29A);
      }
      starIndex = pPlanet->starIndex;
      pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
      pStar = &V_Game.stars[starIndex];
      pShip->pLocation.pStar = pStar;
      Q_HandleShipDeparture_sub_1D538((P_Location)pStar, pShip);
      squareIndex = pPlanet->_squareIndex;
      pPlanet->buildingPlanetItemIndex = 0xFF;
      if ( (unsigned __int16)squareIndex != 0xFFFF )
      {
        pPlanet->pSquares[squareIndex].planetItemIndex = 0xFF;
        pPlanet->_squareIndex = 0xFFFF;
      }
      break;
    case ASCEND_LOCATION_TYPE_ORBIT:
      Q_Planet_LaunchShip_sub_35C38(pShip->pLocation.pPlanet, pShip);
      if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x2B0);
      }
      goto LABEL_12;
    case ASCEND_LOCATION_TYPE_SYSTEM:
LABEL_12:
      Q_HandleShipDeparture_sub_1D538(pShip->pLocation, pShip);
      break;
    default:
      break;
  }
  Q_Game_RemoveShip_sub_20720(&V_Game, pShip);
}

//----- (00049A40) --------------------------------------------------------
// Activates or deactivates all shield gizmos on a ship
// This function iterates through all hull cells and toggles shield-type gizmos
// to match the desired active state. Used for bulk shield management.
void __fastcall Q_Ship_SetAllShieldsState_sub_49A40(P_Ship pShip, BOOL active)
{
  T_HullCell *hullCells; // kr00_4
  int ii; // kr04_4
  __int16 i; // si

  hullCells = pShip->hullCells;
  ii = 0;
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    // Only toggle if current active state doesn't match desired state
    if ( hullCells[ii].gizmoIndex != -1
      && V_Gizmos[hullCells[ii].gizmoIndex].cat == ASCEND_GIZMO_CAT_SHIELD
      && active != hullCells[ii].active )
    {
      // Toggle the shield gizmo to match desired state
      Q_Ship_ToggleGizmo_sub_49A8C(pShip, &hullCells[ii]);
    }
    ++ii;
  }
}

//----- (00049A8C) --------------------------------------------------------
// Toggles a ship's gizmo (special equipment) on or off
// Handles power management and shield adjustments for toggleable gizmos.
void __fastcall Q_Ship_ToggleGizmo_sub_49A8C(P_Ship pShip, P_HullCell pHulleCell)
{
  T_Gizmo *pGizmo; // eax
  int newShieldStrength; // edi
  int availablePower; // edx
  int requiredPower; // ebx

  if ( pHulleCell->gizmoIndex == -1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x2D3);
  }
  pGizmo = &V_Gizmos[pHulleCell->gizmoIndex];
  if ( (pGizmo->flags & ASCEND_GZ_TOGGLEABLE) != 0 )
  {
    if ( pHulleCell->active == TRUE )
    {
      // Case 1: Deactivating an active gizmo
      // Return power to the ship's available power pool
      pShip->availablePower += pGizmo->power;
      // If this is a shield gizmo, reduce shield strength
      if ( pGizmo->cat == ASCEND_GIZMO_CAT_SHIELD )
      {
        newShieldStrength = pShip->_currentShieldStrength - pGizmo->shieldStrength;
        pShip->_currentShieldStrength = newShieldStrength;
        // Ensure shield strength doesn't go negative
        if ( newShieldStrength < 0 )
        {
          pShip->_currentShieldStrength = 0;
        }
      }
      // Mark the gizmo as inactive
      pHulleCell->active = FALSE;
    }
    else
    {
      // Case 2: Activating an inactive gizmo
      // Check if ship has enough power to activate this gizmo
      availablePower = pShip->availablePower;
      requiredPower = pGizmo->power;
      if ( availablePower >= requiredPower )
      {
        // Deduct power from the ship's available power
        pShip->availablePower = availablePower - requiredPower;
        // If this is a shield gizmo, increase shield strength
        if ( pGizmo->cat == ASCEND_GIZMO_CAT_SHIELD )
        {
          pShip->_currentShieldStrength += pGizmo->shieldStrength;
        }
        // Mark the gizmo as active
        pHulleCell->active = TRUE;
      }
    }
  }
}

//----- (00049B3C) --------------------------------------------------------
int __fastcall sub_49B3C(P_Ship pShip, int a2)
{
  __int8 Unknown_62; // cl
  int result; // eax

  Unknown_62 = pShip->Unknown_62;
  result = 0;
  if ( Unknown_62 )
  {
    if ( Unknown_62 == 1 )
    {
      result = sub_4A0D0(pShip, a2);
    }
  }
  else
  {
    result = sub_49CC4(pShip, a2);
  }
  pShip->Unknown_84 = result;
  return result;
}

//----- (00049B68) --------------------------------------------------------
int __fastcall sub_49B68(P_Ship pShip, int a2)
{
  __int16 i; // dx
  bool v5; // zf
  UBYTE gizmoIndex; // al
  float v8; // [esp+8h] [ebp-20h]
  float v9; // [esp+10h] [ebp-18h]

  v9 = -1.0;
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    gizmoIndex = pShip->hullCells[i].gizmoIndex;
    v8 = -1.0;
    if ( gizmoIndex != 0xFF && (char)gizmoIndex < 76 && (!V_Gizmos[(char)gizmoIndex].numUses || pShip->hullCells[i]._usesPerTurnLeft) )
    {
      if ( (char)gizmoIndex > -1 && (char)gizmoIndex < 9 )
      {
LABEL_35:
        v8 = (double)(32 * V_Gizmos[(char)gizmoIndex].range) * 0.95;
        goto LABEL_25;
      }
      if ( a2 != 1 )
      {
        if ( a2 != 2 || gizmoIndex < 47u )
        {
          goto LABEL_25;
        }
        if ( gizmoIndex > 47u )
        {
          v5 = gizmoIndex == ASCEND_GIZMO_70_PHASE_BOMB;
          goto LABEL_24;
        }
LABEL_4:
        v8 = (double)(0x20 * V_Gizmos[(char)gizmoIndex].range) * 0.825;
        goto LABEL_25;
      }
      if ( gizmoIndex < 0x30u )
      {
        if ( gizmoIndex < 0x25u )
        {
          if ( gizmoIndex >= 0x21u && gizmoIndex <= 0x23u )
          {
            goto LABEL_35;
          }
        }
        else
        {
          if ( gizmoIndex <= 0x26u )
          {
            goto LABEL_35;
          }
          if ( gizmoIndex == ASCEND_GIZMO_47_MYRMIDONIC_CARBONIZER )
          {
            goto LABEL_4;
          }
        }
      }
      else
      {
        if ( gizmoIndex <= 0x32u )
        {
          goto LABEL_35;
        }
        if ( gizmoIndex < 0x3Du )
        {
          v5 = gizmoIndex == ASCEND_GIZMO_54_MOVING_PART_EXPLOITER;
LABEL_24:
          if ( v5 )
          {
            goto LABEL_35;
          }
        }
        else
        {
          if ( gizmoIndex <= 0x3Du )
          {
            goto LABEL_35;
          }
          if ( gizmoIndex >= 0x40u )
          {
            if ( gizmoIndex <= 0x40u )
            {
              goto LABEL_35;
            }
            v5 = gizmoIndex == ASCEND_GIZMO_66_SPECIALTY_BLASTER;
            goto LABEL_24;
          }
        }
      }
LABEL_25:
      if ( v8 > (double)v9 )
      {
        v9 = v8;
      }
      continue;
    }
  }
  return (int)v9;
}

//----- (00049CC4) --------------------------------------------------------
int __fastcall sub_49CC4(P_Ship pShip, int a2)
{
  BYTE type; // dh
  int v5; // ebx
  P_Lane pLane; // edx
  double v7; // st7
  double z; // st7
  int v9; // eax
  double v10; // st6
  BYTE targetType; // dl
  T_Vector3D v13; // [esp+8h] [ebp-C0h] BYREF
  T_Vector3D v14; // [esp+14h] [ebp-B4h] BYREF
  T_Vector3D v15; // [esp+20h] [ebp-A8h] BYREF
  T_Vector3D position; // [esp+2Ch] [ebp-9Ch] BYREF
  T_Vector3D v17; // [esp+38h] [ebp-90h]
  T_Vector3D v18; // [esp+44h] [ebp-84h] BYREF
  T_Vector3D v19; // [esp+50h] [ebp-78h] BYREF
  T_Vector3D v20; // [esp+5Ch] [ebp-6Ch] BYREF
  T_Vector3D v21; // [esp+68h] [ebp-60h]
  T_Vector3D v22; // [esp+74h] [ebp-54h]
  T_Vector3D v23; // [esp+80h] [ebp-48h] BYREF
  T_Vector3D *v24; // [esp+8Ch] [ebp-3Ch]
  T_Vector3D *v25; // [esp+90h] [ebp-38h]
  T_Vector3D *v26; // [esp+94h] [ebp-34h]
  T_Vector3D *v27; // [esp+98h] [ebp-30h]
  T_Vector3D *v28; // [esp+9Ch] [ebp-2Ch]
  float v29; // [esp+A4h] [ebp-24h]
  float availableMoves; // [esp+A8h] [ebp-20h]
  int availablePower; // [esp+ACh] [ebp-1Ch]
  float v32; // [esp+B0h] [ebp-18h]

  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x370);
  }
  memset(&position, 0, sizeof(position));
  type = pShip->_target.type;
  v5 = 1;
  switch ( type )
  {
    case 3:
      position = pShip->Unknown_6C;
      break;
    case 1:
      position = pShip->_target.pObject.pPlanet->position;
      break;
    case 2:
      position = pShip->_target.pObject.pLane->vector2;
      pLane = pShip->_target.pObject.pLane;
      if ( pShip->pLocation.pStar == pLane->pStar1 )
      {
        position = pLane->vector1;
      }
      break;
    default:
      v5 = 0;
      break;
  }
  if ( (v5 & 1) != 0 )
  {
    v27 = &v18;
    memset(&v14, 0, sizeof(v14));
    v14.x = position.x - pShip->position.x;
    v14.y = position.y - pShip->position.y;
    v14.z = position.z - pShip->position.z;
    v18 = v14;
    v32 = sqrt(v14.y * v14.y + v14.x * v14.x + v14.z * v14.z) * 0.0062500001;
    availableMoves = (float)pShip->availableMoves;
    v29 = v32;
    if ( v32 > (double)availableMoves )
    {
      v32 = availableMoves;
    }
    availablePower = (int)((double)pShip->totalPowerForDrives * (v32 + 1.0) / (double)pShip->totalDriveMaxDistance);
    if ( availablePower < 1 )
    {
      availablePower = 1;
    }
    if ( availablePower > pShip->availablePower )
    {
      v7 = (double)pShip->availablePower * v32 / (double)availablePower;
      availablePower = pShip->availablePower;
      v32 = v7;
    }
    if ( v32 == v29 )
    {
      LOBYTE(v5) = v5 | 8;
    }
    Q_Vector3D_Normalize_sub_53000(&v18);
    v24 = &v13;
    v22.x = v18.x * v32;
    v22.y = v18.y * v32;
    v22.z = v32 * v18.z;
    v13 = v22;
    v21.x = v22.x * 32.0;
    v25 = &v15;
    v21.y = v22.y * 32.0;
    v15 = v21;
    v21.z = 32.0 * v22.z;
    v17.x = v21.x * 5.0;
    v26 = &v19;
    v17.y = v21.y * 5.0;
    v19 = v17;
    v17.z = 5.0 * v21.z;
    v18 = v17;
    memset(&v20, 0, sizeof(v20));
    v28 = &v23;
    v20.x = pShip->position.x + v17.x;
    v20.y = pShip->position.y + v17.y;
    z = pShip->position.z;
    v23 = v20;
    v20.z = z + v17.z;
    pShip->Unknown_78.x = v20.x;
    pShip->Unknown_78.y = v23.y;
    pShip->Unknown_78.z = v23.z;
    Q_Vector3D_SnapToGrid_sub_53440(&pShip->Unknown_78);
    if ( a2 == 1 )
    {
      v9 = availablePower;
      pShip->position = pShip->Unknown_78;
      v10 = (double)pShip->availableMoves - v32;
      pShip->availablePower -= v9;
      pShip->availableMoves = (int)v10;
      if ( (v5 & 8) != 0 )
      {
        targetType = pShip->_target.type;
        if ( targetType == 1 )
        {
          Q_Ship_MoveIntoOrbit_sub_49494(pShip, pShip->_target.pObject.pPlanet);
        }
        else if ( targetType == 2 )
        {
          Q_Ship_EnterStarLane_sub_49648(pShip, pShip->_target.pObject.pLane);
        }
      }
    }
  }
  return v5;
}

//----- (0004A0D0) --------------------------------------------------------
int __fastcall sub_4A0D0(P_Ship pShip, int a2)
{
  P_HullCell pCurHullCell; // ecx
  unsigned int v3; // esi
  int v4; // ebx
  BYTE type; // cl

  pCurHullCell = pShip->pCurHullCell;
  v3 = 0xFFFFFFFF;
  v4 = 0;
  if ( V_Gizmos[pCurHullCell->gizmoIndex].numUses )
  {
    if ( pCurHullCell->_usesPerTurnLeft )
    {
      if ( a2 == 1 )
      {
        --pCurHullCell->_usesPerTurnLeft;
      }
    }
    else
    {
      v3 = 0;
    }
  }
  if ( v3 == 0xFFFFFFFF )
  {
    type = pShip->_target.type;
    switch ( type )
    {
      case 0:
        return sub_4B944(pShip, a2);
      case 2:
        return Q_Ship_ActivateLaneGizmo_sub_4CAB8(pShip, a2);
      case 1:
        return Q_Ship_ActivatePlanetGizmo_sub_4C7FC(pShip, a2);
      case 5:
        return Q_Ship_ActivateNoTargetGizmo_sub_4CDF8(pShip, a2);
    }
  }
  return v4;
}

//----- (0004A144) --------------------------------------------------------
int __fastcall Q_Ship_GetGizmosCost_sub_4A144(P_Ship pShip)
{
  int cost; // ebx
  unsigned __int16 i; // ax

  cost = 0;
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    if ( pShip->hullCells[i].gizmoIndex != (BYTE)0xFF )
    {
      cost += V_Gizmos[pShip->hullCells[i].gizmoIndex].industry;
    }
  }
  return cost;
}

//----- (0004A18C) --------------------------------------------------------
int __fastcall Q_Ship_GetCost_sub_4A18C(P_Ship pShip)
{
  int hullBaseCost; // edx
  _DWORD v3[4]; // [esp+0h] [ebp-10h]

  v3[0] = V_HullsBaseCost[0];
  v3[1] = V_HullsBaseCost[1];
  v3[2] = V_HullsBaseCost[2];
  v3[3] = V_HullsBaseCost[3];
  hullBaseCost = v3[pShip->hullSize];
  return hullBaseCost + Q_Ship_GetGizmosCost_sub_4A144(pShip);
}
// 969D8: using guessed type _DWORD V_HullsBaseCost[4];

//----- (0004A1CC) --------------------------------------------------------
// Calculates the upgrade potential of a ship by comparing its installed components (gizmos) 
// against the best available components researched by a given race.
// The result is an average score representing how much the ship can be improved.
// Returns
// A normalized score scaled by 10 (0higher) indicating upgrade potential, where:
// - 0 means no upgrades available.
// - Higher values mean better upgrade opportunities.
int __fastcall Q_Ship_UpgradePotential_sub_4A1CC(P_Ship pShip, WORD raceIndex)
{
  int totalUpgradePotential; // ecx
  int upgradableGizmoCount; // edi
  unsigned __int16 i; // dx
  int bestGizmoLevel; // eax
  int installedGizmoLevel; // ebp
  char bestWeapon; // [esp+6h] [ebp-28h]
  char bestGenerator; // [esp+Ah] [ebp-24h]
  char bestLaneDrive; // [esp+Eh] [ebp-20h]
  char bestShield; // [esp+12h] [ebp-1Ch]
  char bestDrive; // [esp+16h] [ebp-18h]

  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x408);
  }
  bestWeapon = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_WEAPON, raceIndex);
  bestGenerator = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_GENERATOR, raceIndex);
  bestDrive = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_DRIVE, raceIndex);
  totalUpgradePotential = 0;
  bestShield = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_SHIELD, raceIndex);
  bestLaneDrive = ASCEND_GIZMO_43_STAR_LANE_DRIVE;
  upgradableGizmoCount = 0;
  if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE) )
  {
    bestLaneDrive = ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE;
  }
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    if ( pShip->hullCells[i].gizmoIndex != (BYTE)0xFF )
    {
      bestGizmoLevel = 0xFFFFFFFF;
      switch ( V_Gizmos[i].cat )
      {
        case ASCEND_GIZMO_CAT_WEAPON:
          bestGizmoLevel = V_Gizmos[bestWeapon].level;
          break;
        case ASCEND_GIZMO_CAT_SHIELD:
          bestGizmoLevel = V_Gizmos[bestShield].level;
          break;
        case ASCEND_GIZMO_CAT_DRIVE:
          bestGizmoLevel = V_Gizmos[bestDrive].level;
          break;
        case ASCEND_GIZMO_CAT_GENERATOR:
          bestGizmoLevel = V_Gizmos[bestGenerator].level;
          break;
        default:
          break;
      }
      if ( pShip->hullCells[i].gizmoIndex == ASCEND_GIZMO_43_STAR_LANE_DRIVE && bestLaneDrive == ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE )
      {
        ++upgradableGizmoCount;
        ++totalUpgradePotential;
      }
      else if ( bestGizmoLevel != 0xFFFFFFFF )
      {
        installedGizmoLevel = V_Gizmos[pShip->hullCells[i].gizmoIndex].level;
        ++upgradableGizmoCount;
        if ( bestGizmoLevel > installedGizmoLevel )
        {
          totalUpgradePotential += bestGizmoLevel - installedGizmoLevel;
        }
      }
    }
  }
  if ( upgradableGizmoCount <= 0 )
  {
    // No upgradable gizmos found
    return 0;
  }
  else
  {
    // Return average upgrade potential (scaled by 10 for precision)
    return 10 * totalUpgradePotential / upgradableGizmoCount;
  }
}

//----- (0004A36C) --------------------------------------------------------
char __fastcall Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(P_Ship pShip, BYTE cat, WORD raceIndex)
{
  char raceIndex_; // di
  __int16 level; // bx
  __int16 i; // ax
  char gizmoIndex; // [esp+4h] [ebp-14h]

  raceIndex_ = raceIndex;
  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x45F);
  }
  level = 0;
  gizmoIndex = 0xFF;
  for ( i = 0; i < 76; ++i )
  {
    if ( V_Gizmos[i].cat == cat && ((1 << raceIndex_) & V_Research.techs[V_Gizmos[i].resReq].knownToRace) != 0 && level <= V_Gizmos[i].level )
    {
      gizmoIndex = i;
      level = V_Gizmos[i].level;
    }
  }
  return gizmoIndex;
}

//----- (0004A404) --------------------------------------------------------
int __fastcall Q_Ship_GizmoIsResearchedByRace_sub_4A404(P_Ship pShip, BYTE gizmoIndex)
{
  if ( V_Game.racesNum <= pShip->raceIndex || pShip->raceIndex < 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x476);
  }
  return (((1 << pShip->raceIndex) & V_Research.techs[V_Gizmos[gizmoIndex].resReq].knownToRace) == 0) - 1;
}

//----- (0004A480) --------------------------------------------------------
P_HullCell __fastcall sub_4A480(P_Ship pShip, unsigned __int16 a2, P_TargetObject a3)
{
  T_HullCell *hullCells; // ecx
  T_HullCell *v6; // edi
  int j; // kr04_4
  __int16 i; // bx

  if ( !pShip->availablePower )
  {
    return 0;
  }
  pShip->Unknown_62 = 1;
  v6 = 0;
  if ( a2 )
  {
    if ( a2 <= 2u )
    {
      pShip->_target.type = 1;
      pShip->_target.pObject = a3;
    }
    else
    {
      if ( a2 != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x4A3);
      }
      pShip->_target.type = 0;
      pShip->_target.pObject = a3;
    }
  }
  else
  {
    pShip->_target.type = 2;
    pShip->_target.pObject = a3;
  }
  hullCells = pShip->hullCells;
  j = 0;
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    if ( hullCells[j].gizmoIndex != (BYTE)0xFF
      && (!V_Gizmos[hullCells[j].gizmoIndex].cat || pShip->_target.type == 1 && hullCells[j].gizmoIndex == ASCEND_GIZMO_70_PHASE_BOMB) )
    {
      pShip->pCurHullCell = &hullCells[j];
      if ( (sub_49B3C(pShip, 0) & 1) != 0 )
      {
        return &hullCells[j];
      }
    }
    ++j;
  }
  return v6;
}

//----- (0004A534) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Ship_HasGizmo_sub_4A534(P_Ship pShip, BYTE gizmoIndex)
{
  __int16 i; // ax

  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    if ( gizmoIndex == pShip->hullCells[i].gizmoIndex )
    {
      return TRUE;
    }
  }
  return FALSE;
}

//----- (0004A564) --------------------------------------------------------
unsigned int __fastcall sub_4A564(int a1)
{
  __int16 i; // ax

  for ( i = 0; i < *(_DWORD *)(a1 + 0x15A); ++i )
  {
    if ( !V_Gizmos[*(char *)(a1 + 7 * i + 0xAB)].cat && (!V_Gizmos[*(char *)(a1 + 7 * i + 0xAB)].numUses || *(_WORD *)(a1 + 7 * i + 0xAC)) )
    {
      return 0xFFFFFFFF;
    }
  }
  return 0;
}

//----- (0004A5B8) --------------------------------------------------------
// Recalculates ship movement and shield status at start of turn
void __fastcall Q_Ship_RecalculateTurnResources_sub_4A5B8(P_Ship pShip)
{
  int totalDriveMaxDistance; // edx
  T_HullCell *shipHullCells; // ebx
  T_Gizmo *pGizmo; // edx
  int availablePower; // ecx
  int powerUsed; // edi
  int i; // esi

  if ( (pShip->specialEffects & 1) != 0 )
  {
    pShip->availableMoves = 0;
  }
  else
  {
    if ( (pShip->specialEffects & ASCEND_EFFECT_ENGINES_BOOST) != 0 )
    {
      // Apply engine boost
      totalDriveMaxDistance = V_Gizmos[ASCEND_GIZMO_63_TOROIDAL_BLASTER].special1 + pShip->totalDriveMaxDistance;
    }
    else
    {
      totalDriveMaxDistance = pShip->totalDriveMaxDistance;
    }
    pShip->availableMoves = totalDriveMaxDistance;
  }
  pShip->_currentShieldStrength = 0;
  // Process all installed gizmos
  if ( pShip->hullCellsNum > 0 )
  {
    shipHullCells = pShip->hullCells;
    i = 0;
    do
    {
      if ( shipHullCells[i].gizmoIndex != (BYTE)0xFF )
      {
        pGizmo = &V_Gizmos[shipHullCells[i].gizmoIndex];
        if ( (pGizmo->flags & ASCEND_GZ_TOGGLEABLE) != 0 && shipHullCells[i].active == TRUE )
        {
          availablePower = pShip->availablePower;
          powerUsed = pGizmo->power;
          if ( availablePower >= powerUsed )
          {
            pShip->availablePower = availablePower - powerUsed;
            if ( pGizmo->cat == ASCEND_GIZMO_CAT_SHIELD )
            {
              pShip->_currentShieldStrength += pGizmo->shieldStrength;
            }
          }
        }
      }
      ++i;
    }
    while ( i < pShip->hullCellsNum );
  }
  if ( (pShip->specialEffects & 8) != 0 )
  {
    pShip->_currentShieldStrength = 0;
  }
}

//----- (0004A6AC) --------------------------------------------------------
void __fastcall Q_Ship_Turn_sub_4A6AC(P_Ship pShip)
{
  int effectveGeneratorsPower; // eax
  int hullCellsNum; // ebx
  T_HullCell *hullCells; // eax
  P_Lane pLane; // edx
  P_Star pStar2; // eax
  P_Star pStar1; // ebx
  double dDistance; // st7
  int totalLanePotential; // eax
  double newLanePosition; // st7
  P_Star pDestinationStar; // edi
  T_Race *pRace; // eax
  int i; // edx
  T_Vector3D direction; // [esp+8h] [ebp-3Ch]
  T_Vector3D v15; // [esp+14h] [ebp-30h] BYREF
  T_Vector3D *v16; // [esp+20h] [ebp-24h]
  int v17; // [esp+24h] [ebp-20h]
  float fDistance; // [esp+28h] [ebp-1Ch]
  float fTravelDistance; // [esp+2Ch] [ebp-18h]

  pShip->specialEffects = 0;
  effectveGeneratorsPower = Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(pShip);
  hullCellsNum = pShip->hullCellsNum;
  pShip->availablePower = effectveGeneratorsPower;
  if ( hullCellsNum > 0 )
  {
    hullCells = pShip->hullCells;
    i = 0;
    do
    {
      if ( hullCells[i].gizmoIndex != (BYTE)0xFF )
      {
        hullCells[i]._usesPerTurnLeft = V_Gizmos[hullCells[i].gizmoIndex].numUses;
      }
      ++i;
    }
    while ( i < pShip->hullCellsNum );
  }
  if ( pShip->locationType == ASCEND_LOCATION_TYPE_STARLANE )
  {
    pLane = pShip->pLocation.pLane;
    pStar2 = pLane->pStar2;
    pStar1 = pLane->pStar1;
    v16 = &v15;
    direction.x = pStar1->position.x - pStar2->position.x;
    direction.y = pStar1->position.y - pStar2->position.y;
    direction.z = pStar1->position.z - pStar2->position.z;
    v15 = direction;
    dDistance = sqrt(direction.y * direction.y + direction.x * direction.x + direction.z * direction.z);
    totalLanePotential = pShip->totalStarLaneHyperdrivePotential + pShip->totalStarLaneDrivePotential;
    fDistance = dDistance;
    v17 = totalLanePotential;
    LOBYTE(pStar1) = pLane->flags;
    fTravelDistance = (float)totalLanePotential;
    if ( ((unsigned __int8)pStar1 & ASCEND_LANE_FLAGS_1_RED_LINK) != 0 )
    {
      fTravelDistance = fTravelDistance * 0.33333334;
    }
    if ( V_Game.races[pShip->raceIndex].ability == ASCEND_SA_FAST_LANE_TRAVEL )
    {
      if ( fTravelDistance < 1.0 )
      {
        fTravelDistance = 1.0;
      }
      fTravelDistance = fTravelDistance * 2.0;
    }
    newLanePosition = pShip->position.x + fTravelDistance;
    pShip->position.x = newLanePosition;
    if ( newLanePosition > fDistance )
    {
      pShip->position.x = fDistance;
    }
    if ( pShip->position.x == fDistance )
    {
      // Ship has arrived to the destination star
      if ( pShip->position.y )
      {
        pDestinationStar = pShip->pLocation.pLane->pStar2;
      }
      else
      {
        pDestinationStar = pShip->pLocation.pLane->pStar1;
      }
      pRace = &V_Game.races[V_PlayerRaceIndex];
      if ( pShip->raceIndex == V_PlayerRaceIndex )
      {
        Q_Race_HandlePlayerShipArrivalAtStar_sub_45A54(pRace, pDestinationStar, pShip);
      }
      else if ( ((1 << V_PlayerRaceIndex) & (pDestinationStar->planetsRacesBits | pDestinationStar->shipsRacesBits)) != 0 )
      {
        Q_Race_HandleStarSystemEntry_sub_45D50(pRace, pDestinationStar, pShip);
      }
      Q_Star_HandleShipArrival_sub_1D3E8(pDestinationStar, pShip, 0);
      if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x55A);
      }
    }
  }
  Q_Ship_RecalculateTurnResources_sub_4A5B8(pShip);
}

//----- (0004A8CC) --------------------------------------------------------
// Calculates a ship's rank based on how long it has been in service
// Rank increases by 1 every 100 days, with a maximum rank of 10
// Returns rank from 0 to 10
int __fastcall Q_Ship_GetRank_sub_4A8CC(P_Ship pShip)
{
  int calculatedRank; // eax

  calculatedRank = (V_Game.day - pShip->_dayBuilt) / 100;
  if ( calculatedRank < 0 )
  {
    return 0;
  }
  if ( calculatedRank > 10 )
  {
    return 10;
  }
  return calculatedRank;
}

//----- (0004A8FC) --------------------------------------------------------
// Calculates the effective generator power output for a ship,
// taking into account the ship's rank-based efficiency modifier.
// Rank  0 = 100% power
// ..
// Rank 10 = 200% power
int __fastcall Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(P_Ship pShip)
{
  int totalGeneratorPower; // [esp+4h] [ebp-Ch]
  float efficiencyModifier; // [esp+8h] [ebp-8h]

  totalGeneratorPower = pShip->totalGeneratorPower;
  // Calculate rank-based efficiency modifier (10% bonus per rank, capped at +100%)
  efficiencyModifier = (double)Q_Ship_GetRank_sub_4A8CC(pShip) * 0.1 + 1.0;
  if ( efficiencyModifier >= 1.0 )
  {
    if ( efficiencyModifier > 2.0 )
    {
      efficiencyModifier = 2.0;
    }
  }
  else
  {
    efficiencyModifier = 1.0;
  }
  return (int)((double)totalGeneratorPower * efficiencyModifier);
}

//----- (0004A988) --------------------------------------------------------
// Calculates a ship's combat rating based on its components and status
// Final rating formula:
// (4 * hull integrity + 10 * generator power + component values) / 10
int __fastcall Q_Ship_CalculateCombatRating_sub_4A988(P_Ship pShip)
{
  int componentValue; // ebx
  int i; // esi
  T_Gizmo *pGizmo; // edx

  componentValue = 0;
  if ( pShip->hullCellsNum > 0 )
  {
    i = 0;
    do
    {
      if ( pShip->hullCells[i]._usesPerTurnLeft == 1 && pShip->hullCells[i].gizmoIndex != (BYTE)0xFF )
      {
        pGizmo = &V_Gizmos[pShip->hullCells[i].gizmoIndex];
        // Base value from component's build cost
        componentValue += pGizmo->industry;
        // Add bonus value based on component category and level
        switch ( pGizmo->cat )
        {
          case ASCEND_GIZMO_CAT_WEAPON:
            componentValue += pGizmo->range / 5 + 10 * pGizmo->level;
            break;
          case ASCEND_GIZMO_CAT_SHIELD:
            componentValue += 5 * pGizmo->level;
            break;
          case ASCEND_GIZMO_CAT_DRIVE:
            componentValue += 2 * pGizmo->level;
            break;
          case ASCEND_GIZMO_CAT_SCANNER:
            componentValue += pGizmo->level;
            break;
          case ASCEND_GIZMO_CAT_SPECIAL:
            componentValue += pGizmo->range / 5 + 5 * pGizmo->level;
            break;
          default:
            break;
        }
      }
      ++i;
    }
    while ( i < pShip->hullCellsNum );
  }
  return (4 * pShip->hullIntegrity + 10 * Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(pShip) + componentValue) / 10;
}

//----- (0004AA78) --------------------------------------------------------
// Orders a ship to move to a target star system and returns the distance
// @param pShip Pointer to the ship to be ordered
// @param pStar Pointer to the target star system
// @return starDistance (0 if already there)
int __fastcall Q_Ship_OrderToStar_sub_4AA78(P_Ship pShip, P_Star pStar)
{
  P_Star pShipLocationStar; // eax

  if ( !pStar )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x5B6);
  }
  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x5B7);
  }
  pShipLocationStar = pShip->pLocation.pStar;
  if ( pStar == pShipLocationStar )
  {
    return 0;
  }
  pShip->order = ASCEND_SO_1_GOSTAR;
  pShip->_orderTargetObject.pStar = pStar;
  return V_Game.starDistanceMatrix[pShipLocationStar->index][pStar->index];
}

//----- (0004AAEC) --------------------------------------------------------
// Checks if a ship can be scanned by a specific race
// @param pShip The ship to check scannig for
// @param byRaceIndex The race attempting to scan the ship
// @return Scanning level:
//     0 = Not scanned
//     1 = Basic scanning
//     2 = Full scanning (with X-Ray Megaglasses)
int __fastcall Q_Ship_CheckScannedInSystemByRace_sub_4AAEC(P_Ship pShip, int byRaceIndex)
{
  int ShipsAtLocation_sub_1D794; // eax
  int ii; // kr04_4
  int shipsInSystem; // kr08_4
  P_Ship pOtherShip; // eax
  int scannersRange; // esi
  double distance; // st7
  P_Ship v8; // edx
  T_HullCell *hullCells; // edx
  P_Ship v10; // eax
  int gizmoIndex; // ebx
  int xRayMegaglasses; // eax
  P_Vector3D pShipPosition_; // esi
  P_Star pShipsStar; // eax
  P_Planet pPlanet; // ebx
  int observationInstallation; // eax
  int i; // ecx
  int j; // edi
  P_Ship shipsList[107]; // [esp+8h] [ebp-218h] BYREF
  T_Vector3D direction; // [esp+1B4h] [ebp-6Ch] BYREF
  T_Vector3D direction_; // [esp+1C0h] [ebp-60h] BYREF
  T_Vector3D v23; // [esp+1CCh] [ebp-54h] BYREF
  T_Vector3D v24; // [esp+1D8h] [ebp-48h] BYREF
  P_Ship pShip_; // [esp+1E4h] [ebp-3Ch]
  int scanLevel; // [esp+1E8h] [ebp-38h]
  T_Vector3D *v27; // [esp+1ECh] [ebp-34h]
  int v28; // [esp+1F0h] [ebp-30h]
  int v29; // [esp+1F4h] [ebp-2Ch]
  T_Vector3D *v30; // [esp+1F8h] [ebp-28h]
  float distance__; // [esp+1FCh] [ebp-24h]
  int raceIndex_; // [esp+200h] [ebp-20h]
  P_Vector3D pShipPosition; // [esp+204h] [ebp-1Ch]
  float distance_; // [esp+208h] [ebp-18h]

  pShip_ = pShip;
  raceIndex_ = byRaceIndex;
  scanLevel = 0;
  if ( pShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
  {
    // First check all ships scannig capabilities in the same system
    ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsList);
    if ( ShipsAtLocation_sub_1D794 > 0 )
    {
      shipsInSystem = ShipsAtLocation_sub_1D794;
      v28 = 4 * ShipsAtLocation_sub_1D794;
      pShipPosition = &pShip_->position;
      ii = 0;
      while ( 1 )
      {
        pOtherShip = shipsList[ii];
        if ( pOtherShip->raceIndex == raceIndex_ && pOtherShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
        {
          scannersRange = 0;
          v27 = &v23;
          memset(&direction, 0, sizeof(direction));
          direction.x = pShipPosition->x - pOtherShip->position.x;
          direction.y = pShipPosition->y - pOtherShip->position.y;
          direction.z = pShipPosition->z - pOtherShip->position.z;
          v23 = direction;
          distance = sqrt(direction.y * direction.y + direction.x * direction.x + direction.z * direction.z);
          v8 = shipsList[ii];
          distance_ = distance;
          hullCells = v8->hullCells;
          for ( i = 0; ; ++i )
          {
            v10 = shipsList[ii];
            if ( i >= v10->hullCellsNum )
            {
              break;
            }
            if ( hullCells->gizmoIndex != (BYTE)0xFF )
            {
              gizmoIndex = hullCells->gizmoIndex;
              if ( V_Gizmos[gizmoIndex].cat == ASCEND_GIZMO_CAT_SCANNER )
              {
                v29 = 32 * V_Gizmos[hullCells->gizmoIndex].range;
                if ( (double)v29 >= distance_ )
                {
                  scannersRange += V_Gizmos[gizmoIndex].scannerRangePerTurn;
                }
              }
            }
            ++hullCells;
          }
          if ( scannersRange > 0 && scannersRange > 2 * pShip_->cloakingLevel )
          {
            // The X Ray Megaglasses allow you to view the contents of any ship you are able to scan. 
            // They require no power to maintain but are fairly expensive to build. 
            // Used in conjunction with powerful scanners, they can be very informative.
            xRayMegaglasses = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v10, ASCEND_GIZMO_41_X_RAY_MEGAGLASSES);
            // Basic scanning
            scanLevel = 1;
            if ( xRayMegaglasses != 0xFFFFFFFF )
            {
              break;
            }
          }
        }
        if ( ++ii >= shipsInSystem )
        {
          goto END_OF_SHIPS_SECTION;
        }
      }
      // Full scanning (with X-Ray Megaglasses)
      scanLevel = 2;
    }
END_OF_SHIPS_SECTION:
    // Then, if not detected by ships, check planetary observation installations
    if ( !scanLevel )
    {
      pShipPosition_ = &pShip_->position;
      for ( j = 0; ; ++j )
      {
        pShipsStar = pShip_->pLocation.pStar;
        if ( j >= pShipsStar->planetsNum )
        {
          break;
        }
        pPlanet = pShipsStar->planets[j];
        if ( pPlanet->raceIndex == raceIndex_ )
        {
          v30 = &v24;
          memset(&direction_, 0, sizeof(direction_));
          direction_.x = pShipPosition_->x - pPlanet->position.x;
          direction_.y = pShipPosition_->y - pPlanet->position.y;
          direction_.z = pShipPosition_->z - pPlanet->position.z;
          v24 = direction_;
          distance__ = sqrt(direction_.y * direction_.y + direction_.x * direction_.x + direction_.z * direction_.z);
          // The Observation Installation scans nearby alien ships.
          // There is no need to build more than one Observation Installation on any
          // planet.
          observationInstallation = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_16_OBSERVATION_INSTALLATION);
          if ( observationInstallation != 0xFFFF
            && (pPlanet->pSquares[observationInstallation].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0
            && distance__ < 1600.0 )
          {
            // Basic scanning
            return 1;
          }
        }
      }
    }
  }
  return scanLevel;
}

//----- (0004AE8C) --------------------------------------------------------
void __fastcall Q_Ship_ReadWrite_sub_4AE8C(P_Ship pShip, P_CFile pfi, int read)
{
  UBYTE locationType; // al
  P_Planet pPlanet; // ebp
  P_Lane pLane; // ebp
  T_Ship vShip; // [esp+0h] [ebp-3BCh] BYREF
  T_Ship vShipa; // [esp+164h] [ebp-258h] BYREF
  T_Name15 v9[7]; // [esp+2C8h] [ebp-F4h] BYREF
  T_Name15 v10[7]; // [esp+334h] [ebp-88h] BYREF
  void *pShipHullCells; // [esp+3A0h] [ebp-1Ch]
  T_Vector3D *p_position; // [esp+3A4h] [ebp-18h]
  P_CFile vfi; // [esp+3A8h] [ebp-14h]

  vfi = pfi;
  pShipHullCells = pShip->hullCells;
  p_position = &pShip->position;
  if ( read == TRUE )
  {
    Q_Ship_Ctor_sub_48B90(&vShipa);
    Q_CFile_Read_sub_1BF94(vfi, &vShipa, 0x162u);
    pShip->totalWeaponDamage = vShipa.totalWeaponDamage;
    pShip->totalShieldStrength = vShipa.totalShieldStrength;
    pShip->totalStarLaneDrivePotential = vShipa.totalStarLaneDrivePotential;
    pShip->totalStarLaneHyperdrivePotential = vShipa.totalStarLaneHyperdrivePotential;
    pShip->totalDriveMaxDistance = vShipa.totalDriveMaxDistance;
    pShip->Unknown_14 = vShipa.Unknown_14;
    pShip->totalGeneratorPower = vShipa.totalGeneratorPower;
    pShip->totalPowerForDrives = vShipa.totalPowerForDrives;
    pShip->totalScannerRangePerTurn = vShipa.totalScannerRangePerTurn;
    pShip->cloakingLevel = vShipa.cloakingLevel;
    pShip->hasColonizer = vShipa.hasColonizer;
    pShip->Unknown_2C = vShipa.Unknown_2C;
    pShip->Unknown_30 = vShipa.Unknown_30;
    qmemcpy(pShip->name, vShipa.name, sizeof(pShip->name));
    pShip->Unknown_50 = vShipa.Unknown_50;
    pShip->_dayBuilt = vShipa._dayBuilt;
    pShip->raceIndex = vShipa.raceIndex;
    pShip->locationType = vShipa.locationType;
    pShip->pLocation.pPlanet = vShipa.pLocation.pPlanet;
    pShip->order = vShipa.order;
    pShip->_orderTargetObject.pPlanet = vShipa._orderTargetObject.pPlanet;
    pShip->Unknown_62 = vShipa.Unknown_62;
    pShip->pCurHullCell = vShipa.pCurHullCell;
    pShip->_target = vShipa._target;
    pShip->Unknown_6C = vShipa.Unknown_6C;
    pShip->Unknown_78 = vShipa.Unknown_78;
    pShip->Unknown_84 = vShipa.Unknown_84;
    pShip->availablePower = vShipa.availablePower;
    pShip->hullIntegrity = vShipa.hullIntegrity;
    pShip->_currentShieldStrength = vShipa._currentShieldStrength;
    pShip->availableMoves = vShipa.availableMoves;
    pShip->fullHullIntegrity = vShipa.fullHullIntegrity;
    pShip->specialEffects = vShipa.specialEffects;
    *p_position = vShipa.position;
    pShip->hullSize = vShipa.hullSize;
    _wcpp_2_assign_array_(pShipHullCells, vShipa.hullCells, 25u, 7u, (pFUNcopy)Q_HullCell_Copy_sub_4B780);
    pShip->hullCellsNum = vShipa.hullCellsNum;
    pShip->gizmosNum = vShipa.gizmosNum;
    switch ( pShip->order )
    {
      case 0:
      case 7:
        pShip->_orderTargetObject.pPlanet = 0;
        break;
      case 1:
        pShip->_orderTargetObject.pPlanet = (P_Planet)&V_Game.stars[(int)pShip->_orderTargetObject.pPlanet];
        break;
      case 2:
      case 3:
        pShip->_orderTargetObject.pPlanet = &V_Game.planets[(int)pShip->_orderTargetObject.pPlanet];
        break;
      case 4:
      case 5:
      case 6:
        Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x642);
        break;
      default:
        Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x647);
        break;
    }
    locationType = pShip->locationType;
    if ( locationType < (unsigned int)ASCEND_LOCATION_TYPE_ORBIT )
    {
      if ( !locationType )
      {
LABEL_16:
        qmemcpy(v10, V_Locations, sizeof(v10));
        sub_2620C("Bad m_LocationType: %s", v10[(char)pShip->locationType]);
        Q_PrintFailAndExit_sub_261B8(0, "..\\ship.cpp", 0x67A);
        return;
      }
    }
    else
    {
      if ( locationType > (unsigned int)ASCEND_LOCATION_TYPE_SYSTEM )
      {
        if ( locationType == ASCEND_LOCATION_TYPE_STARLANE )
        {
          pShip->pLocation.pLane = &V_Game.lanes[(int)pShip->pLocation.pLane];
          return;
        }
        goto LABEL_16;
      }
      if ( locationType == ASCEND_LOCATION_TYPE_SYSTEM )
      {
        pShip->pLocation.pStar = &V_Game.stars[(int)pShip->pLocation.pStar];
        return;
      }
    }
    pShip->pLocation.pPlanet = &V_Game.planets[(int)pShip->pLocation.pPlanet];
    return;
  }
  vShip.totalWeaponDamage = pShip->totalWeaponDamage;
  vShip.totalShieldStrength = pShip->totalShieldStrength;
  vShip.totalStarLaneDrivePotential = pShip->totalStarLaneDrivePotential;
  vShip.totalStarLaneHyperdrivePotential = pShip->totalStarLaneHyperdrivePotential;
  vShip.totalDriveMaxDistance = pShip->totalDriveMaxDistance;
  vShip.Unknown_14 = pShip->Unknown_14;
  vShip.totalGeneratorPower = pShip->totalGeneratorPower;
  vShip.totalPowerForDrives = pShip->totalPowerForDrives;
  vShip.totalScannerRangePerTurn = pShip->totalScannerRangePerTurn;
  vShip.cloakingLevel = pShip->cloakingLevel;
  vShip.hasColonizer = pShip->hasColonizer;
  vShip.Unknown_2C = pShip->Unknown_2C;
  vShip.Unknown_30 = pShip->Unknown_30;
  qmemcpy(vShip.name, pShip->name, 0x6Au);
  vShip.position = *p_position;
  vShip.hullSize = pShip->hullSize;
  _wcpp_2_copy_array_(vShip.hullCells, pShipHullCells, 25, &C_HullCell);
  vShip.hullCellsNum = pShip->hullCellsNum;
  vShip.gizmosNum = pShip->gizmosNum;
  switch ( pShip->order )
  {
    case 0:
    case 7:
      break;
    case 1:
      vShip._orderTargetObject.pPlanet = (P_Planet)SLOWORD(pShip->_orderTargetObject.pPlanet->position.y);
      break;
    case 2:
    case 3:
      vShip._orderTargetObject.pPlanet = (P_Planet)(pShip->_orderTargetObject.pPlanet - V_Game.planets);
      break;
    case 4:
    case 5:
    case 6:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x6A7);
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x6AC);
      break;
  }
  switch ( pShip->locationType )
  {
    case ASCEND_LOCATION_TYPE_SHIPYARD:
    case ASCEND_LOCATION_TYPE_SHIPDOCK:
      vShip.pLocation.pPlanet = (P_Planet)(pShip->pLocation.pPlanet - V_Game.planets);
      break;
    case ASCEND_LOCATION_TYPE_ORBIT:
      pPlanet = pShip->pLocation.pPlanet;
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x6C0);
      }
      vShip.pLocation.pPlanet = (P_Planet)(pPlanet - V_Game.planets);
      break;
    case ASCEND_LOCATION_TYPE_SYSTEM:
      vShip.pLocation.pStar = (P_Star)pShip->pLocation.pStar->index;
      break;
    case ASCEND_LOCATION_TYPE_STARLANE:
      pLane = pShip->pLocation.pLane;
      if ( !pLane )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x6CF);
      }
      vShip.pLocation.pLane = (P_Lane)(pLane - V_Game.lanes);
      break;
    default:
      qmemcpy(v9, V_Locations, sizeof(v9));
      sub_2620C("Bad m_LocationType: %s", v9[(char)pShip->locationType]);
      Q_PrintFailAndExit_sub_261B8(0, "..\\ship.cpp", 0x6EE);
      break;
  }
  Q_CFile_Write_sub_1C098(vfi, &vShip, 0x162u);
}
// 4AE8C: using guessed type T_Ship anonymous_0;

//----- (0004B5C0) --------------------------------------------------------
void __fastcall Q_HullCell_Copy_sub_4B5C0(P_HullCell dst, P_HullCell src)
{
  *dst = *src;
}

//----- (0004B5E0) --------------------------------------------------------
void __fastcall Q_Ship_Copy_sub_4B5E0(P_Ship dst, P_Ship src)
{
  dst->totalWeaponDamage = src->totalWeaponDamage;
  dst->totalShieldStrength = src->totalShieldStrength;
  dst->totalStarLaneDrivePotential = src->totalStarLaneDrivePotential;
  dst->totalStarLaneHyperdrivePotential = src->totalStarLaneHyperdrivePotential;
  dst->totalDriveMaxDistance = src->totalDriveMaxDistance;
  dst->Unknown_14 = src->Unknown_14;
  dst->totalGeneratorPower = src->totalGeneratorPower;
  dst->totalPowerForDrives = src->totalPowerForDrives;
  dst->totalScannerRangePerTurn = src->totalScannerRangePerTurn;
  dst->cloakingLevel = src->cloakingLevel;
  dst->hasColonizer = src->hasColonizer;
  dst->Unknown_2C = src->Unknown_2C;
  dst->Unknown_30 = src->Unknown_30;
  qmemcpy(dst->name, src->name, 0x77u);
  _wcpp_2_copy_array_(dst->hullCells, src->hullCells, 25, &C_HullCell);
  dst->hullCellsNum = src->hullCellsNum;
  dst->gizmosNum = src->gizmosNum;
}

//----- (0004B780) --------------------------------------------------------
void __fastcall Q_HullCell_Copy_sub_4B780(P_HullCell tgt, P_HullCell src)
{
  *tgt = *src;
}

//----- (0004B7A0) --------------------------------------------------------
int __fastcall Q_Ship_ApplyDamage_sub_4B7A0(P_Ship pShip, int makeChanges, int requestedDamage, WORD attackerRaceIndex)
{
  int actualDamage; // edi
  int hullDamage; // ebp
  int currentShieldStrength; // ebx
  UBYTE locationType; // dh
  T_Star *pStar; // ecx
  int newHullStrength; // ebx
  int hullSize; // ebx
  int victimRaceIndex; // edx
  int v15; // [esp+Ch] [ebp-14h]

  if ( attackerRaceIndex < 0 || attackerRaceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x2F);
  }
  if ( pShip->raceIndex < 0 || V_Game.racesNum <= pShip->raceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x30);
  }
  v15 = 0;
  actualDamage = requestedDamage;
  hullDamage = 0;
  if ( (pShip->specialEffects & 0x10) != 0 )
  {
    actualDamage = 0;
  }
  currentShieldStrength = pShip->_currentShieldStrength;
  if ( actualDamage > currentShieldStrength )
  {
    actualDamage = pShip->_currentShieldStrength;
    hullDamage = requestedDamage - currentShieldStrength;
    LOBYTE(v15) = 2;
  }
  if ( hullDamage >= pShip->hullIntegrity )
  {
    hullDamage = pShip->hullIntegrity;
    LOBYTE(v15) = v15 | 4;
  }
  if ( makeChanges == 1 )
  {
    locationType = pShip->locationType;
    pStar = 0;
    if ( locationType == ASCEND_LOCATION_TYPE_SYSTEM )
    {
      pStar = pShip->pLocation.pStar;
    }
    else if ( locationType == ASCEND_LOCATION_TYPE_ORBIT
           || locationType == ASCEND_LOCATION_TYPE_SHIPYARD
           || locationType == ASCEND_LOCATION_TYPE_SHIPDOCK )
    {
      pStar = &V_Game.stars[pShip->pLocation.pPlanet->starIndex];
    }
    if ( !pStar )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x53);
    }
    Q_Race_DecayRelations_sub_433E0(&V_Game.races[pShip->raceIndex], attackerRaceIndex, pStar);
    newHullStrength = pShip->hullIntegrity - hullDamage;
    pShip->_currentShieldStrength -= actualDamage;
    pShip->hullIntegrity = newHullStrength;
    if ( newHullStrength < 1 )
    {
      hullSize = pShip->hullSize;
      victimRaceIndex = pShip->raceIndex;
      Q_Ship_RemoveFromTheGame_sub_49940(pShip);
      if ( victimRaceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_BATTLE )
      {
        Q_WinMgr_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_SHIPDESTROYED, hullSize, (int)pStar);
      }
    }
  }
  return v15;
}

//----- (0004B944) --------------------------------------------------------
int __fastcall sub_4B944(P_Ship pShip, int makeChanges)
{
  P_HullCell pCurHullCell; // eax
  unsigned int v4; // ecx
  T_Gizmo *pGizmo; // edi
  P_Ship pTargetShip; // esi
  double dDistance; // st7
  WORD specialEffects; // ax
  BOOL v9; // eax
  int weaponDamage; // ebx
  int v11; // eax
  double v13; // st7
  double v14; // st7
  double v15; // st7
  double v16; // st7
  double v17; // st7
  int v18; // eax
  int k; // kr04_4
  int v20; // kr08_4
  P_Ship v21; // ebx
  double v22; // st7
  double v23; // st7
  double v24; // st7
  P_Ship v25; // ebx
  int special1; // eax
  int v27; // esi
  int v28; // eax
  int ShipsAtLocation_sub_1D794; // eax
  int v30; // ebp
  T_Vector3D *p_position; // ebx
  int i; // kr10_4
  int v33; // kr14_4
  P_Ship v34; // ecx
  double v35; // st7
  double z; // st7
  P_Ship v37; // ecx
  int gizmosNum; // ebx
  int v39; // edx
  char v40; // cl
  T_HullCell *v41; // eax
  int v42; // ebp
  int v43; // eax
  char v44; // ch
  T_HullCell *pHullCells; // edx
  int v46; // ebp
  int v47; // kr2C_4
  char v48; // bh
  int hullCellsNum; // edi
  T_HullCell *hullCells; // kr30_4
  char v51; // dh
  int v52; // edx
  UBYTE gizmoIndex_; // al
  T_Vector3D *v54; // ebx
  T_Vector3D *v55; // edx
  char v56; // ch
  int v57; // eax
  int v58; // edx
  int v59; // eax
  int j; // ebx
  float x_4; // [esp+4h] [ebp-524h]
  T_ShipsList shipsList; // [esp+8h] [ebp-520h] BYREF
  T_ShipsList v63; // [esp+1B4h] [ebp-374h] BYREF
  int v64[25]; // [esp+360h] [ebp-1C8h]
  T_Vector3D v65; // [esp+3C4h] [ebp-164h] BYREF
  float v66; // [esp+3D0h] [ebp-158h] BYREF
  float v67; // [esp+3D4h] [ebp-154h]
  float v68; // [esp+3D8h] [ebp-150h]
  float v69; // [esp+3DCh] [ebp-14Ch] BYREF
  float v70; // [esp+3E0h] [ebp-148h]
  float v71; // [esp+3E4h] [ebp-144h]
  T_Vector3D v72; // [esp+3E8h] [ebp-140h] BYREF
  float v73; // [esp+3F4h] [ebp-134h] BYREF
  float v74; // [esp+3F8h] [ebp-130h]
  float v75; // [esp+3FCh] [ebp-12Ch]
  T_Vector3D v76; // [esp+400h] [ebp-128h] BYREF
  T_Vector3D v77; // [esp+40Ch] [ebp-11Ch] BYREF
  float v78; // [esp+418h] [ebp-110h]
  float v79; // [esp+41Ch] [ebp-10Ch]
  float v80; // [esp+420h] [ebp-108h]
  T_Vector3D v81; // [esp+424h] [ebp-104h] BYREF
  float v82; // [esp+430h] [ebp-F8h]
  float v83; // [esp+434h] [ebp-F4h]
  float v84; // [esp+438h] [ebp-F0h]
  T_Vector3D v85; // [esp+43Ch] [ebp-ECh] BYREF
  T_Vector3D v86; // [esp+448h] [ebp-E0h] BYREF
  float v87; // [esp+454h] [ebp-D4h]
  float v88; // [esp+458h] [ebp-D0h]
  float v89; // [esp+45Ch] [ebp-CCh]
  float v90; // [esp+460h] [ebp-C8h] BYREF
  float v91; // [esp+464h] [ebp-C4h]
  float v92; // [esp+468h] [ebp-C0h]
  T_Vector3D direction; // [esp+46Ch] [ebp-BCh] BYREF
  T_Vector3D v94; // [esp+478h] [ebp-B0h] BYREF
  float v95; // [esp+484h] [ebp-A4h]
  float v96; // [esp+488h] [ebp-A0h]
  float v97; // [esp+48Ch] [ebp-9Ch]
  T_Vector3D v98; // [esp+490h] [ebp-98h] BYREF
  float x; // [esp+49Ch] [ebp-8Ch]
  float y; // [esp+4A0h] [ebp-88h]
  float v101; // [esp+4A4h] [ebp-84h]
  T_Vector3D *v102; // [esp+4A8h] [ebp-80h]
  float *v103; // [esp+4ACh] [ebp-7Ch]
  T_Vector3D *v104; // [esp+4B0h] [ebp-78h]
  T_Vector3D *v105; // [esp+4B4h] [ebp-74h]
  float *v106; // [esp+4B8h] [ebp-70h]
  float *v107; // [esp+4BCh] [ebp-6Ch]
  T_Vector3D *v108; // [esp+4C0h] [ebp-68h]
  T_Vector3D *v109; // [esp+4C8h] [ebp-60h]
  float *v110; // [esp+4CCh] [ebp-5Ch]
  int v111; // [esp+4D0h] [ebp-58h]
  int makeChanges_; // [esp+4D4h] [ebp-54h]
  int power; // [esp+4D8h] [ebp-50h]
  float fDistance; // [esp+4DCh] [ebp-4Ch]
  float v115; // [esp+4E0h] [ebp-48h]
  float fRange; // [esp+4E4h] [ebp-44h]
  int v117; // [esp+4E8h] [ebp-40h]
  int v118; // [esp+4ECh] [ebp-3Ch]
  int v119; // [esp+4F0h] [ebp-38h]
  float v120; // [esp+4F4h] [ebp-34h]
  float v121; // [esp+4F8h] [ebp-30h]
  float v122; // [esp+4FCh] [ebp-2Ch]
  float v123; // [esp+500h] [ebp-28h]
  int v124; // [esp+508h] [ebp-20h]
  UBYTE gizmoIndex; // [esp+50Ch] [ebp-1Ch]
  char v126; // [esp+510h] [ebp-18h]

  makeChanges_ = makeChanges;
  pCurHullCell = pShip->pCurHullCell;
  v111 = 0xFFFFFFFF;
  v4 = 0xFFFFFFFF;
  gizmoIndex = pCurHullCell->gizmoIndex;
  if ( gizmoIndex == 0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0xA2);
  }
  power = 0;
  v117 = 0;
  pGizmo = &V_Gizmos[(char)gizmoIndex];
  if ( pGizmo->power > pShip->availablePower )
  {
    v111 = 0;
  }
  else
  {
    power = pGizmo->power;
  }
  pTargetShip = pShip->_target.pObject.pShip;
  if ( !pTargetShip )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0xAD);
  }
  if ( pShip->locationType != 4 || pTargetShip->locationType != 4 || pShip->pLocation.pPlanet != pTargetShip->pLocation.pPlanet )
  {
    goto LABEL_18;
  }
  if ( pGizmo->range )
  {
    v102 = &v86;
    memset(&direction, 0, sizeof(direction));
    direction.x = pTargetShip->position.x - pShip->position.x;
    direction.y = pTargetShip->position.y - pShip->position.y;
    direction.z = pTargetShip->position.z - pShip->position.z;
    v86 = direction;
    dDistance = sqrt(direction.y * direction.y + direction.x * direction.x + direction.z * direction.z);
    v124 = 32 * pGizmo->range;
    specialEffects = pShip->specialEffects;
    fDistance = dDistance;
    fRange = (float)v124;
    if ( (specialEffects & ASCEND_EFFECT_WEAPONS_INCREASED_RANGE) != 0 )
    {
      fRange = fRange * 2.0;
    }
    if ( fDistance > (double)fRange )
    {
      v4 = 0;
    }
    if ( gizmoIndex == ASCEND_GIZMO_47_MYRMIDONIC_CARBONIZER && fRange * 0.75 > fDistance )
    {
LABEL_18:
      v4 = 0;
    }
  }
  v9 = v111 && v4 && pTargetShip != pShip && (pGizmo->flags & ASCEND_GZ_TARGETSHIP) != 0;
  v117 |= v9;
  if ( (v117 & 1) == 0 )
  {
    return v117;
  }
  pShip->Unknown_78 = pTargetShip->position;
  weaponDamage = 0;
  if ( !pGizmo->cat )
  {
    weaponDamage = pGizmo->weaponDamage;
  }
  if ( gizmoIndex == ASCEND_GIZMO_47_MYRMIDONIC_CARBONIZER )
  {
    weaponDamage = pGizmo->special1;
  }
  if ( weaponDamage )
  {
    v11 = Q_Ship_ApplyDamage_sub_4B7A0(pTargetShip, makeChanges_, weaponDamage, pShip->raceIndex);
    v117 |= v11;
  }
  else
  {
    LOBYTE(v117) = v117 | 0x10;
  }
  if ( makeChanges_ != 1 )
  {
    return v117;
  }
  v52 = pShip->availablePower - power;
  gizmoIndex_ = gizmoIndex;
  pShip->availablePower = v52;
  if ( gizmoIndex_ < 0x32u )
  {
    if ( gizmoIndex_ < 0x25u )
    {
      if ( gizmoIndex_ >= 0x22u )
      {
        if ( gizmoIndex_ <= 0x22u )
        {
          pTargetShip->_dayBuilt = V_Game.day;
          return v117;
        }
        else
        {
          if ( gizmoIndex_ == ASCEND_GIZMO_35_BRUNSWIK_DISSIPATOR )
          {
            pTargetShip->availablePower = 0;
          }
          return v117;
        }
      }
      if ( gizmoIndex_ == ASCEND_GIZMO_33_MOLECULAR_TIE_DOWN )
      {
        v51 = pTargetShip->specialEffects;
        pTargetShip->availableMoves = 0;
        LOBYTE(pTargetShip->specialEffects) = v51 | 1;
        return v117;
      }
      return v117;
    }
    if ( gizmoIndex_ > 0x25u )
    {
      if ( gizmoIndex_ < 0x2Du )
      {
        if ( gizmoIndex_ != ASCEND_GIZMO_40_FLEET_DISPERSER )
        {
          return v117;
        }
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsList);
        v30 = 0;
        if ( ShipsAtLocation_sub_1D794 > 0 )
        {
          p_position = &pTargetShip->position;
          v33 = ShipsAtLocation_sub_1D794;
          v118 = 4 * ShipsAtLocation_sub_1D794;
          for ( i = 0; i < v33; ++i )
          {
            v34 = shipsList[i];
            if ( pTargetShip != v34 )
            {
              v108 = &v77;
              memset(&v76, 0, sizeof(v76));
              v76.x = v34->position.x - p_position->x;
              v76.y = v34->position.y - pTargetShip->position.y;
              v76.z = v34->position.z - pTargetShip->position.z;
              v77 = v76;
              v35 = sqrt(v76.y * v76.y + v76.x * v76.x + v76.z * v76.z);
              v124 = 0x20 * pGizmo->special1;
              v120 = (float)v124;
              if ( v35 < v120 )
              {
                Q_Vector3D_SetLength_sub_53054(&v77, v120);
                v82 = 0.0;
                v83 = 0.0;
                v84 = 0.0;
                v106 = &v69;
                v82 = p_position->x + v77.x;
                v83 = pTargetShip->position.y + v77.y;
                z = pTargetShip->position.z;
                v69 = v82;
                v84 = z + v77.z;
                v70 = v83;
                v37 = shipsList[i];
                v71 = v84;
                v37->position.x = v82;
                v37->position.y = v70;
                v37->position.z = v71;
              }
            }
            ++v30;
          }
        }
      }
      else
      {
        if ( gizmoIndex_ <= 0x2Du )
        {
          v104 = &v65;
          memset(&v85, 0, sizeof(v85));
          v85.x = pTargetShip->position.x - pShip->position.x;
          v85.y = pTargetShip->position.y - pShip->position.y;
          v13 = pTargetShip->position.z - pShip->position.z;
          v65 = v85;
          v85.z = v13;
          v124 = 32 * pGizmo->special1;
          x_4 = (float)v124;
          Q_Vector3D_SetLength_sub_53054(&v65, x_4);
          v103 = &v73;
          v95 = 0.0;
          v96 = 0.0;
          v97 = 0.0;
          v95 = pTargetShip->position.x + v65.x;
          v96 = pTargetShip->position.y + v65.y;
          v14 = pTargetShip->position.z + v65.z;
          v73 = v95;
          v97 = v14;
          v74 = v96;
          v75 = v97;
          pTargetShip->position.x = v95;
          pTargetShip->position.y = v74;
          pTargetShip->position.z = v75;
          return v117;
        }
        if ( gizmoIndex_ >= 0x30u )
        {
          if ( gizmoIndex_ > 0x30u )
          {
            v56 = pTargetShip->specialEffects;
            pTargetShip->_currentShieldStrength = 0;
            LOBYTE(pTargetShip->specialEffects) = v56 | 8;
            return v117;
          }
          hullCellsNum = pTargetShip->hullCellsNum;
          hullCells = pTargetShip->hullCells;
          for ( j = 0; j < hullCellsNum; ++j )
          {
            if ( hullCells[j].gizmoIndex == ASCEND_GIZMO_71_COLONIZER || hullCells[j].gizmoIndex == ASCEND_GIZMO_73_INVASION_MODULE )
            {
              Q_Ship_RemoveGizmoFromCell_sub_492F8(pTargetShip, j);
            }
            hullCellsNum = pTargetShip->hullCellsNum;
          }
        }
      }
      return v117;
    }
LABEL_84:
    v126 = 0;
    if ( gizmoIndex == ASCEND_GIZMO_66_SPECIALTY_BLASTER )
    {
      v126 = 5;
    }
    v46 = 0;
    if ( pTargetShip->hullCellsNum > 0 )
    {
      pHullCells = pTargetShip->hullCells;
      v47 = 0;
      v59 = 0;
      do
      {
        if ( pHullCells[v59].gizmoIndex != (BYTE)0xFF && V_Gizmos[pHullCells[v59].gizmoIndex].cat == v126 )
        {
          ++v46;
          v64[v47++] = v59;
        }
        ++v59;
      }
      while ( v59 < pTargetShip->hullCellsNum );
    }
    if ( v46 )
    {
      Q_Ship_RemoveGizmoFromCell_sub_492F8(pTargetShip, v64[V_Game.day % v46]);
      return v117;
    }
    return v117;
  }
  if ( gizmoIndex_ <= 0x32u )
  {
LABEL_74:
    v40 = 5;
    if ( gizmoIndex == 0x32 )
    {
      v40 = 0;
    }
    v42 = 0;
    if ( pTargetShip->hullCellsNum > 0 )
    {
      v41 = pTargetShip->hullCells;
      v58 = 0;
      do
      {
        if ( v41[v58].gizmoIndex != (BYTE)0xFF && v40 == V_Gizmos[v41[v58].gizmoIndex].cat )
        {
          ++v42;
        }
        ++v58;
      }
      while ( v58 < pTargetShip->hullCellsNum );
    }
    v43 = pTargetShip->hullIntegrity - v42;
    pTargetShip->hullIntegrity = v43;
    if ( v43 < 1 )
    {
      v44 = v117 | 4;
      Q_Ship_RemoveFromTheGame_sub_49940(pTargetShip);
      LOBYTE(v117) = v44;
      return v117;
    }
    return v117;
  }
  v54 = &pTargetShip->position;
  if ( gizmoIndex_ < 0x3Du )
  {
    v55 = &pShip->position;
    if ( gizmoIndex_ < 0x36u )
    {
      if ( gizmoIndex_ != 0x34 )
      {
        return v117;
      }
      v109 = &v98;
      memset(&v72, 0, sizeof(v72));
      v72.x = v54->x - v55->x;
      v72.y = pTargetShip->position.y - pShip->position.y;
      v72.z = pTargetShip->position.z - pShip->position.z;
      v98 = v72;
      v15 = sqrt(v72.y * v72.y + v72.x * v72.x + v72.z * v72.z);
      v124 = 0x20 * pGizmo->special1;
      v16 = v15 - (double)v124;
      v115 = v16;
      if ( v16 < 64.0 )
      {
        v115 = 64.0;
      }
      Q_Vector3D_SetLength_sub_53054(&v98, v115);
      v87 = 0.0;
      v88 = 0.0;
      v89 = 0.0;
      v110 = &v90;
      v87 = pShip->position.x + v98.x;
      v88 = pShip->position.y + v98.y;
      v17 = pShip->position.z;
      v90 = v87;
      v89 = v17 + v98.z;
      v91 = v88;
      v92 = v89;
      pTargetShip->position.x = v87;
      pTargetShip->position.y = v91;
      pTargetShip->position.z = v92;
      return v117;
    }
    if ( gizmoIndex_ > 0x36u )
    {
      if ( gizmoIndex_ <= 0x37u )
      {
        x = v55->x;
        y = pShip->position.y;
        v101 = pShip->position.z;
        v55->x = v54->x;
        pShip->position.y = pTargetShip->position.y;
        pShip->position.z = pTargetShip->position.z;
        v54->x = x;
        pTargetShip->position.y = y;
        pTargetShip->position.z = v101;
        return v117;
      }
      if ( gizmoIndex_ != 0x3B )
      {
        return v117;
      }
      special1 = pTargetShip->fullHullIntegrity - pTargetShip->hullIntegrity;
      if ( special1 > pGizmo->special1 )
      {
        special1 = pGizmo->special1;
      }
      pTargetShip->hullIntegrity += special1;
      v27 = pShip->hullIntegrity - special1;
      pShip->hullIntegrity = v27;
      if ( v27 < 1 )
      {
        Q_Ship_RemoveFromTheGame_sub_49940(pShip);
        return v117;
      }
      return v117;
    }
    goto LABEL_74;
  }
  if ( gizmoIndex_ <= 0x3Du )
  {
    Q_Ship_RemoveFromTheGame_sub_49940(pTargetShip);
    v48 = v117 | 4;
    Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - pShip->hullCells);
    LOBYTE(v117) = v48;
    return v117;
  }
  if ( gizmoIndex_ < 0x42u )
  {
    if ( gizmoIndex_ != 0x40 )
    {
      return v117;
    }
    gizmosNum = pTargetShip->gizmosNum;
    if ( !gizmosNum )
    {
      return v117;
    }
    if ( pTargetShip->hullCellsNum <= 0 )
    {
      return v117;
    }
    v39 = 0;
    v57 = 0;
    do
    {
      if ( pTargetShip->hullCells[v57].gizmoIndex != (BYTE)0xFF )
      {
        if ( v39 == V_Game.day % gizmosNum )
        {
          Q_Ship_RemoveGizmoFromCell_sub_492F8(pTargetShip, v57);
          return v117;
        }
        ++v39;
      }
      ++v57;
    }
    while ( v57 < pTargetShip->hullCellsNum );
    return v117;
  }
  if ( gizmoIndex_ <= 0x42u )
  {
    goto LABEL_84;
  }
  if ( gizmoIndex_ < 0x44u )
  {
    return v117;
  }
  if ( gizmoIndex_ > 0x44u )
  {
    if ( gizmoIndex_ != ASCEND_GIZMO_74_MASS_CONDENSOR )
    {
      return v117;
    }
    v18 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, v63);
    if ( v18 > 0 )
    {
      v20 = v18;
      v119 = 4 * v18;
      for ( k = 0; k < v20; ++k )
      {
        v21 = v63[k];
        if ( pTargetShip != v21 )
        {
          v105 = &v81;
          memset(&v94, 0, sizeof(v94));
          v94.x = v21->position.x - pTargetShip->position.x;
          v94.y = v21->position.y - pTargetShip->position.y;
          v94.z = v21->position.z - pTargetShip->position.z;
          v81 = v94;
          v22 = sqrt(v94.y * v94.y + v94.x * v94.x + v94.z * v94.z);
          v124 = 0x20 * pGizmo->special2;
          v121 = v22;
          v122 = (float)v124;
          if ( v121 > (double)v122 )
          {
            v124 = 0x20 * pGizmo->special1;
            v23 = v121 - (double)v124;
            v123 = v23;
            if ( v23 < v122 )
            {
              v123 = v122;
            }
            Q_Vector3D_SetLength_sub_53054(&v81, v123);
            v107 = &v66;
            v78 = 0.0;
            v79 = 0.0;
            v80 = 0.0;
            v78 = pTargetShip->position.x + v81.x;
            v79 = pTargetShip->position.y + v81.y;
            v24 = pTargetShip->position.z;
            v66 = v78;
            v80 = v24 + v81.z;
            v67 = v79;
            v25 = v63[k];
            v68 = v80;
            v25->position.x = v78;
            v25->position.y = v67;
            v25->position.z = v68;
          }
        }
      }
    }
    return v117;
  }
  v28 = pTargetShip->totalGeneratorPower - pTargetShip->availablePower;
  if ( v28 > v52 )
  {
    v28 = v52;
  }
  pTargetShip->availablePower += v28;
  pShip->availablePower -= v28;
  return v117;
}
// 4B944: using guessed type int var_1C8[25];

//----- (0004C7FC) --------------------------------------------------------
// Function: Ship_ActivateGizmoOnPlanet
// Purpose: Handles the activation of a ship's gizmo (special ability/weapon) targeting a planet.
// Returns: TRUE (1) if activation was successful, FALSE (0) otherwise.
int __fastcall Q_Ship_ActivatePlanetGizmo_sub_4C7FC(P_Ship pShip, int bShouldConsumePower)
{
  BYTE gizmoIndex; // cl
  T_Gizmo *pGizmo; // esi
  MACRO_VFX_BOOL bInAreaOfEffect; // edi
  int availablePower; // ebp
  int gizmoPowerCost; // eax
  P_Planet pPlanet; // ebp
  P_Ship pShip__; // edx
  double distance_; // st7
  WORD specialEffects; // ax
  BOOL bCanActivateGizmo; // eax
  P_Square pSquares; // kr00_4
  int i; // edi
  float x; // [esp+8h] [ebp-60h]
  float y; // [esp+Ch] [ebp-5Ch]
  float z; // [esp+10h] [ebp-58h]
  T_Vector3D v18; // [esp+14h] [ebp-54h] BYREF
  T_Vector3D v19; // [esp+20h] [ebp-48h] BYREF
  T_Vector3D *v20; // [esp+2Ch] [ebp-3Ch]
  int gizmoBaseRange; // [esp+30h] [ebp-38h]
  int bShouldConsumePower_; // [esp+34h] [ebp-34h]
  float distance; // [esp+38h] [ebp-30h]
  int powerToConsume; // [esp+3Ch] [ebp-2Ch]
  MACRO_VFX_BOOL bHasEnoughPower; // [esp+40h] [ebp-28h]
  float gizmoEffectiveRange; // [esp+44h] [ebp-24h]
  int bActivationResult; // [esp+48h] [ebp-20h]
  P_Ship pShip_; // [esp+4Ch] [ebp-1Ch]
  int clearedSquaresCount; // [esp+50h] [ebp-18h]

  pShip_ = pShip;
  bShouldConsumePower_ = bShouldConsumePower;
  gizmoIndex = pShip->pCurHullCell->gizmoIndex;
  bActivationResult = 0;
  powerToConsume = 0;
  pGizmo = &V_Gizmos[gizmoIndex];
  bInAreaOfEffect = TRUE;
  availablePower = pShip->availablePower;
  gizmoPowerCost = pGizmo->power;
  bHasEnoughPower = TRUE;
  if ( gizmoPowerCost > availablePower )
  {
    bHasEnoughPower = FALSE;
  }
  else
  {
    powerToConsume = gizmoPowerCost;
  }
  pPlanet = pShip_->_target.pObject.pPlanet;
  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x217);
  }
  x = pPlanet->position.x;
  y = pPlanet->position.y;
  pShip__ = pShip_;
  z = pPlanet->position.z;
  pShip_->Unknown_78.x = pPlanet->position.x;
  pShip__->Unknown_78.y = y;
  pShip__->Unknown_78.z = z;
  if ( pGizmo->range )
  {
    v20 = &v18;
    memset(&v19, 0, sizeof(v19));
    v19.x = x - pShip_->position.x;
    v19.y = y - pShip_->position.y;
    v19.z = z - pShip_->position.z;
    v18 = v19;
    distance_ = sqrt(v19.y * v19.y + v19.x * v19.x + v19.z * v19.z);
    gizmoBaseRange = 32 * pGizmo->range;
    specialEffects = pShip_->specialEffects;
    distance = distance_;
    gizmoEffectiveRange = (float)gizmoBaseRange;
    if ( (specialEffects & ASCEND_EFFECT_WEAPONS_INCREASED_RANGE) != 0 )
    {
      gizmoEffectiveRange = gizmoEffectiveRange * 2.0;
    }
    if ( distance > (double)gizmoEffectiveRange )
    {
      bInAreaOfEffect = FALSE;
    }
    if ( gizmoIndex == ASCEND_GIZMO_47_MYRMIDONIC_CARBONIZER && gizmoEffectiveRange * 0.75 > distance )
    {
      bInAreaOfEffect = FALSE;
    }
  }
  bCanActivateGizmo = bHasEnoughPower && bInAreaOfEffect && (pGizmo->flags & 0xC) != 0;
  bActivationResult |= bCanActivateGizmo;
  // If activation failed or we're just testing (not consuming power), return the result
  if ( (bActivationResult & 1) == 0 || bShouldConsumePower_ != 1 )
  {
    return bActivationResult;
  }
  pShip_->availablePower -= powerToConsume;
  if ( !pGizmo->cat )
  {
    // ASCEND_GIZMO_CAT_WEAPON
    sub_36A5C(pPlanet, pGizmo->weaponDamage, pShip_->raceIndex);
    return bActivationResult;
  }
  if ( gizmoIndex != ASCEND_GIZMO_70_PHASE_BOMB )
  {
    return bActivationResult;
  }
  // 70. Phase Bomb
  // The %s is launched at a planet and destroys structures on the
  // planet's surface.  It can be used only once and must be launched at
  // short range.
  pSquares = pPlanet->pSquares;
  clearedSquaresCount = 0;
  for ( i = 0; i < pPlanet->surfaceSquaresNum && clearedSquaresCount < 5; ++i )
  {
    if ( pSquares[i].color != 0xFF
      && (pSquares[i].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0
      && !V_PlanetItems.item[pSquares[i].planetItemIndex].mpop
      && Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, i, 0xFFu, 1u) == 0xFFFFFFFF )
    {
      ++clearedSquaresCount;
    }
  }
  Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip_, pShip_->pCurHullCell - pShip_->hullCells);
  return bActivationResult;
}

//----- (0004CAB8) --------------------------------------------------------
int __fastcall Q_Ship_ActivateLaneGizmo_sub_4CAB8(P_Ship pShip, int a2)
{
  BYTE gizmoIndex; // cl
  T_Gizmo *pGizmo; // ebp
  int availablePower; // edx
  int requiredPower; // eax
  P_Lane pTargetLane; // esi
  double distanceToLane; // st7
  int gizmoRange; // eax
  BOOL canActivate; // eax
  P_Star oppositeStar; // eax
  P_Star pStar2; // edx
  P_Star pStar1; // eax
  int shipsProcessed; // edx
  T_Star *destinationStar; // ecx
  int i; // ebx
  T_Vector3D v18; // [esp+8h] [ebp-78h] BYREF
  T_Vector3D v19; // [esp+14h] [ebp-6Ch] BYREF
  T_Vector3D laneDirection; // [esp+20h] [ebp-60h] BYREF
  T_Vector3D directionToLane; // [esp+2Ch] [ebp-54h] BYREF
  T_Vector3D laneVector; // [esp+38h] [ebp-48h]
  T_Vector3D *v23; // [esp+44h] [ebp-3Ch]
  int v24; // [esp+48h] [ebp-38h]
  T_Vector3D *v25; // [esp+4Ch] [ebp-34h]
  float v26; // [esp+50h] [ebp-30h]
  int v27; // [esp+54h] [ebp-2Ch]
  int powerCost; // [esp+58h] [ebp-28h]
  MACRO_VFX_BOOL v29; // [esp+5Ch] [ebp-24h]
  MACRO_VFX_BOOL v30; // [esp+60h] [ebp-20h]
  int v31; // [esp+64h] [ebp-1Ch]
  float laneLength; // [esp+68h] [ebp-18h]

  v27 = a2;
  gizmoIndex = pShip->pCurHullCell->gizmoIndex;
  v31 = 0;
  v30 = TRUE;
  pGizmo = &V_Gizmos[gizmoIndex];
  powerCost = 0;
  availablePower = pShip->availablePower;
  requiredPower = pGizmo->power;
  v29 = TRUE;
  if ( requiredPower > availablePower )
  {
    v29 = FALSE;
  }
  else
  {
    powerCost = requiredPower;
  }
  pTargetLane = pShip->_target.pObject.pLane;
  if ( !pTargetLane )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x275);
  }
  laneVector = pTargetLane->vector2;
  if ( pTargetLane->pStar1 == pShip->pLocation.pStar )
  {
    laneVector = pTargetLane->vector1;
  }
  pShip->Unknown_78 = laneVector;
  memset(&directionToLane, 0, sizeof(directionToLane));
  v23 = &v18;
  directionToLane.x = laneVector.x - pShip->position.x;
  directionToLane.y = laneVector.y - pShip->position.y;
  directionToLane.z = laneVector.z - pShip->position.z;
  v18 = directionToLane;
  distanceToLane = sqrt(directionToLane.y * directionToLane.y + directionToLane.x * directionToLane.x + directionToLane.z
                                                                                                      * directionToLane.z);
  gizmoRange = pGizmo->range;
  v26 = distanceToLane;
  if ( gizmoRange )
  {
    v24 = 32 * gizmoRange;
    if ( (double)(32 * gizmoRange) < v26 )
    {
      v30 = FALSE;
    }
  }
  canActivate = v29 && v30 && (pGizmo->flags & ASCEND_GZ_TARGETLANE) != 0;
  v31 |= canActivate;
  if ( v27 != 1 || (v31 & 1) == 0 )
  {
    return v31;
  }
  pShip->availablePower -= powerCost;
  if ( !pGizmo->cat && pGizmo->weaponDamage > 1 )
  {
    pTargetLane->flags &= ~2u;
    return v31;
  }
  if ( (unsigned __int8)gizmoIndex < (unsigned int)ASCEND_GIZMO_51_LANE_DESTABILIZER )
  {
    if ( gizmoIndex == ASCEND_GIZMO_32_LANE_BLOCKER )
    {
      // 32. Lane Blocker
      // The %s is fired into a star lane opening where it sits, elevating the
      // inherent gravitational turbulence of the opening to the point where
      // Star Lane Drives and Star Lane Hyperdrives can no longer overcome it.
      pTargetLane->flags |= ASCEND_LANE_FLAGS_2_BLOCKED;
      return v31;
    }
    return v31;
  }
  if ( (unsigned __int8)gizmoIndex <= (unsigned int)ASCEND_GIZMO_51_LANE_DESTABILIZER )
  {
    // 51. Lane Destabilizer
    // When fired at a star lane or red link opening, the %s induces gravity
    // waves at the resonant frequency of the star lane.  This causes the
    // ships inside the star lane to be thrown quickly toward their destination
    // point.  The Lane Destabilizer itself is destroyed in the process.
    pStar2 = pTargetLane->pStar2;
    pStar1 = pTargetLane->pStar1;
    v25 = &v19;
    memset(&laneDirection, 0, sizeof(laneDirection));
    laneDirection.x = pStar1->position.x - pStar2->position.x;
    laneDirection.y = pStar1->position.y - pStar2->position.y;
    laneDirection.z = pStar1->position.z - pStar2->position.z;
    v19 = laneDirection;
    shipsProcessed = 0;
    laneLength = sqrt(laneDirection.y * laneDirection.y + laneDirection.x * laneDirection.x + laneDirection.z * laneDirection.z);
    for ( i = 0; i < 107; ++i )
    {
      if ( shipsProcessed >= V_Game.shipsNum )
      {
        break;
      }
      if ( V_Game.ships[i].raceIndex != 0xFFFFFFFF )
      {
        if ( V_Game.ships[i].locationType == ASCEND_LOCATION_TYPE_STARLANE && pTargetLane == V_Game.ships[i].pLocation.pLane )
        {
          V_Game.ships[i].position.x = laneLength;
        }
        ++shipsProcessed;
      }
    }
    goto REMOVE_GIZMO_AND_EXIT;
  }
  if ( (unsigned __int8)gizmoIndex < (unsigned int)ASCEND_GIZMO_60_LANE_MAGNETRON )
  {
    return v31;
  }
  if ( (unsigned __int8)gizmoIndex <= (unsigned int)ASCEND_GIZMO_60_LANE_MAGNETRON )
  {
    // 60. Lane Magnetron
    // The %s frees the ship using it from the gravitational turbulence-induced drag
    // normally encountered in star lane space, allowing the ship to slip through the
    // star lane almost instantly.  The Lane Magnetron uses fully as much power as a
    // Nanotwirler produces and can be used only once.
    destinationStar = pTargetLane->pStar1;
    if ( pTargetLane->pStar1 == pShip->pLocation.pStar )
    {
      destinationStar = pTargetLane->pStar2;
    }
    Q_HandleShipDeparture_sub_1D538(pShip->pLocation, pShip);
    pShip->locationType = ASCEND_LOCATION_TYPE_STARLANE;
    pShip->pLocation.pLane = pTargetLane;
    Q_Star_HandleShipArrival_sub_1D3E8(destinationStar, pShip, 0);
REMOVE_GIZMO_AND_EXIT:
    Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - pShip->hullCells);
    return v31;
  }
  if ( gizmoIndex != ASCEND_GIZMO_62_LANE_ENDOSCOPE )
  {
    return v31;
  }
  // 62. Lane Endoscope
  // The %s allows astronomical instruments to penetrate star lane space and scan
  // the system at the other end of a star lane or red link opening.  It requires a
  // lot of power to use.
  oppositeStar = pTargetLane->pStar1;
  if ( pTargetLane->pStar1 == pShip->pLocation.pStar )
  {
    oppositeStar = pTargetLane->pStar2;
  }
  oppositeStar->exploredBits |= 1 << LOBYTE(pShip->raceIndex);
  return v31;
}

//----- (0004CDF8) --------------------------------------------------------
int __fastcall Q_Ship_ActivateNoTargetGizmo_sub_4CDF8(P_Ship pShip, int a2)
{
  int powerCost; // ebp
  UBYTE gizmoIndex; // cl
  T_Gizmo *pGizmo; // edi
  double v7; // st7
  int shipsCount56; // eax
  int shipsCount56_; // kr08_4
  int j; // kr04_4
  P_Ship pTargetShip56; // eax
  double v12; // st7
  double v13; // st7
  int v14; // edi
  int fullHullIntegrity; // ebp
  T_Star *homeStar; // eax
  int targetCount; // eax
  int k; // kr10_4
  int targetCount_; // kr14_4
  P_Ship pBlastTargetShip; // edx
  double distance; // st7
  P_HullCell pCurrHullCell; // edx
  int hullIntegrity; // ecx
  int v24; // edx
  T_HullCell *hullCells; // eax
  BYTE v26; // bh
  int v27; // ebx
  int shipsCount38; // eax
  int v29; // kr20_4
  P_Ship pTargetShip; // eax
  int atackerRaceIndex; // ecx
  int targetRaceIndex; // edx
  int v33; // ebp
  int shipsCount39; // eax
  T_Vector3D *p_position; // edx
  int v36; // kr2C_4
  P_Ship pTargetShip39; // ecx
  double distance_; // st7
  double z; // st7
  P_Ship v40; // ecx
  int driveHullCell; // eax
  P_Ship shipsArray39[107]; // [esp+8h] [ebp-770h] BYREF
  P_Ship shipsArray38[107]; // [esp+1B4h] [ebp-5C4h] BYREF
  P_Ship shipsArray56[107]; // [esp+360h] [ebp-418h] BYREF
  P_Ship blastTargetShips[107]; // [esp+50Ch] [ebp-26Ch] BYREF
  T_Vector3D v46; // [esp+6B8h] [ebp-C0h] BYREF
  T_Vector3D v47; // [esp+6C4h] [ebp-B4h] BYREF
  float x; // [esp+6D0h] [ebp-A8h] BYREF
  float y; // [esp+6D4h] [ebp-A4h]
  float v50; // [esp+6D8h] [ebp-A0h]
  T_Vector3D v51; // [esp+6DCh] [ebp-9Ch] BYREF
  T_Vector3D v52; // [esp+6E8h] [ebp-90h] BYREF
  T_Vector3D v53; // [esp+6F4h] [ebp-84h] BYREF
  T_Vector3D v54; // [esp+700h] [ebp-78h] BYREF
  T_Vector3D v55; // [esp+70Ch] [ebp-6Ch] BYREF
  float *v56; // [esp+718h] [ebp-60h]
  T_Vector3D *v57; // [esp+71Ch] [ebp-5Ch]
  T_Vector3D *v58; // [esp+720h] [ebp-58h]
  T_Vector3D *v59; // [esp+728h] [ebp-50h]
  MACRO_VFX_BOOL activationSuccess; // [esp+730h] [ebp-48h]
  int statusFlags; // [esp+734h] [ebp-44h]
  int v62; // [esp+738h] [ebp-40h]
  int v63; // [esp+73Ch] [ebp-3Ch]
  int v64; // [esp+740h] [ebp-38h]
  int activationMode; // [esp+744h] [ebp-34h]
  int i; // [esp+748h] [ebp-30h]
  float effectRange_; // [esp+74Ch] [ebp-2Ch]
  float v68; // [esp+750h] [ebp-28h]
  T_Vector3D *epicenter; // [esp+754h] [ebp-24h]
  float gravimetricCondensorRange; // [esp+758h] [ebp-20h]
  float v71; // [esp+75Ch] [ebp-1Ch]
  int effectRange; // [esp+760h] [ebp-18h]

  activationMode = a2;
  gizmoIndex = pShip->pCurHullCell->gizmoIndex;
  activationSuccess = TRUE;
  if ( gizmoIndex == 0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x2EA);
  }
  statusFlags = 0;
  powerCost = 0;
  pGizmo = &V_Gizmos[(char)gizmoIndex];
  if ( pGizmo->power > pShip->availablePower )
  {
    activationSuccess = FALSE;
  }
  else
  {
    powerCost = pGizmo->power;
  }
  statusFlags |= activationSuccess != FALSE;
  if ( (statusFlags & 1) == 0 )
  {
    return statusFlags;
  }
  if ( activationMode != 1 )
  {
    return statusFlags;
  }
  pShip->availablePower -= powerCost;
  if ( gizmoIndex < 0x39u )
  {
    if ( gizmoIndex < 0x27u )
    {
      if ( gizmoIndex >= 0x24u )
      {
        if ( gizmoIndex <= 0x24u )
        {
          // 36. Recaller
          // The %s creates an unstable shunt through star lane space to a ship's home
          // system.  The ship using the Recaller moves instantly into the shunt
          // and arrives immediately at its home system.
          Q_HandleShipDeparture_sub_1D538(pShip->pLocation, pShip);
          homeStar = V_Game.races[pShip->raceIndex].homeStar;
          pShip->pLocation.pStar = homeStar;
          Q_Star_HandleShipArrival_sub_1D3E8(homeStar, pShip, 0);
          return statusFlags;
        }
        if ( gizmoIndex == ASCEND_GIZMO_38_SMART_BOMB )
        {
          // 38. Smart Bomb
          // The %s uses advanced empathic biosensor technology to determine the
          // relationships between the ship using it and the other ships
          // present in the star system.  Once activated, it fires in multiple directions
          // at every ship it has determined to be hostile, doing heavy damage comparable
          // to that of an Ueberlaser.  One use expends it.
          shipsCount38 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsArray38);
          if ( shipsCount38 > 0 )
          {
            v29 = shipsCount38;
            v63 = 4 * shipsCount38;
            for ( i = 0; i < v29; ++i )
            {
              pTargetShip = shipsArray38[i];
              atackerRaceIndex = pShip->raceIndex;
              targetRaceIndex = pTargetShip->raceIndex;
              // Damage only enemies
              if ( targetRaceIndex != atackerRaceIndex && V_Game.races[atackerRaceIndex].treaties[targetRaceIndex] == ASCEND_TREATY_WAR )
              {
                Q_Ship_ApplyDamage_sub_4B7A0(pTargetShip, activationMode, pGizmo->special1, atackerRaceIndex);
              }
            }
          }
          Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - pShip->hullCells);
          return statusFlags;
        }
      }
    }
    else if ( gizmoIndex <= 0x27u )
    {
      // 39. Gravity Distorter
      // The %s creates a gravitational wave front that
      // emanates from the ship using the device.  This pushes small objects, such as
      // space vessels, away from the ship that used the Distorter.
      shipsCount39 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsArray39);
      if ( shipsCount39 > 0 )
      {
        v33 = 0;
        p_position = &pShip->position;
        v36 = shipsCount39;
        v64 = 4 * shipsCount39;
        do
        {
          pTargetShip39 = shipsArray39[v33];
          if ( pShip != pTargetShip39 )
          {
            v59 = &v51;
            memset(&v46, 0, sizeof(v46));
            v46.x = pTargetShip39->position.x - p_position->x;
            v46.y = pTargetShip39->position.y - pShip->position.y;
            v46.z = pTargetShip39->position.z - pShip->position.z;
            v51 = v46;
            distance_ = sqrt(v46.y * v46.y + v46.x * v46.x + v46.z * v46.z);
            effectRange = 0x20 * pGizmo->special1;
            effectRange_ = (float)effectRange;
            if ( distance_ < effectRange_ )
            {
              Q_Vector3D_SetLength_sub_53054(&v51, effectRange_);
              memset(&v52, 0, sizeof(v52));
              v56 = &x;
              v52.x = p_position->x + v51.x;
              v52.y = pShip->position.y + v51.y;
              z = pShip->position.z;
              x = v52.x;
              v52.z = z + v51.z;
              y = v52.y;
              v40 = shipsArray39[v33];
              v50 = v52.z;
              v40->position.x = v52.x;
              v40->position.y = y;
              v40->position.z = v50;
            }
          }
          ++v33;
        }
        while ( v33 < v36 );
      }
    }
    else
    {
      if ( gizmoIndex < 53u )
      {
        if ( gizmoIndex == ASCEND_GIZMO_46_GRAVIMETRIC_CATAPULT )
        {
          // 46. Gravimetric Catapult
          // The %s causes the ship using it to experience temporarily exaggerated
          // gravitational force.  The ship is pulled toward the strongest gravity well in
          // the vicinity--the nearest sun.  The ship whips past the sun, stopping
          // opposite its previous position when it has run out of momentum.
          v57 = &v47;
          memset(&v55, 0, sizeof(v55));
          v55.x = -pShip->position.x;
          v55.y = -pShip->position.y;
          v7 = -pShip->position.z;
          v47 = v55;
          v55.z = v7;
          pShip->position.x = v55.x;
          pShip->position.y = v47.y;
          pShip->position.z = v47.z;
        }
        return statusFlags;
      }
      if ( gizmoIndex <= 53u )
      {
        // 53. Cannibalizer
        // The Cannibalizer is an emergency device that allows a ship to convert some of the mass
        // of its own hull into an energy reserve.  This is destructive to the
        // ship, so it is usually used only in a last ditch effort to survive.
        pShip->hullIntegrity -= pGizmo->special1;
        hullIntegrity = pShip->hullIntegrity;
        pShip->availablePower += pGizmo->special2;
        if ( hullIntegrity < 1 )
        {
          goto DESTROY_SHIP;
        }
      }
      else
      {
        if ( gizmoIndex != ASCEND_GIZMO_56_GRAVIMETRIC_CONDENSOR )
        {
          return statusFlags;
        }
        // 56. Gravimetric Condensor
        // The Gravimetric Condensor momentarily increases the gravitational field strength of a star,
        // causing all the ships in the system to be pulled toward the star with
        // great force. 
        shipsCount56 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsArray56);
        if ( shipsCount56 > 0 )
        {
          shipsCount56_ = shipsCount56;
          for ( j = 0; j < shipsCount56_; ++j )
          {
            pTargetShip56 = shipsArray56[j];
            if ( pTargetShip56->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
            {
              v12 = sqrt(
                      pTargetShip56->position.y * pTargetShip56->position.y
                    + pTargetShip56->position.x * pTargetShip56->position.x
                    + pTargetShip56->position.z * pTargetShip56->position.z);
              effectRange = 0x20 * pGizmo->special2;
              v68 = v12;
              gravimetricCondensorRange = (float)effectRange;
              if ( v68 > (double)gravimetricCondensorRange )
              {
                effectRange = 0x20 * pGizmo->special1;
                v13 = v68 - (double)effectRange;
                v71 = v13;
                if ( v13 < gravimetricCondensorRange )
                {
                  v71 = gravimetricCondensorRange;
                }
                Q_Vector3D_SetLength_sub_53054(&shipsArray56[j]->position, v71);
              }
            }
          }
        }
      }
    }
    return statusFlags;
  }
  if ( gizmoIndex <= 0x39u )
  {
    // 57. Accutron
    // The %s is a massive space analysis and targeting system that
    // increases the effective range of all the weapons on a ship.  It is fairly costly
    // to build, but can provide a strong advantage in battle.
    LOBYTE(pShip->specialEffects) |= ASCEND_EFFECT_WEAPONS_INCREASED_RANGE;
    return statusFlags;
  }
  if ( gizmoIndex < 0x41u )
  {
    if ( gizmoIndex <= 0x3Au )
    {
      // 58. Remote Repair Facility
      // The %s allows a ship to repair damage without having to enter
      // Orbital Docks.  It consists of automated systems spreading throughout the
      // ship, engineered so finely that the repair process resembles organic healing. 
      // It uses a lot of power when activated, and adding it to a ship is an
      // expensive project.
      v14 = pGizmo->special1 + pShip->hullIntegrity;
      fullHullIntegrity = pShip->fullHullIntegrity;
      pShip->hullIntegrity = v14;
      if ( v14 > fullHullIntegrity )
      {
        pShip->hullIntegrity = fullHullIntegrity;
        return statusFlags;
      }
    }
    else
    {
      if ( gizmoIndex != ASCEND_GIZMO_63_TOROIDAL_BLASTER )
      {
        return statusFlags;
      }
      // 63. Toroidal Blaster
      // The %s gives the ship using it a huge boost in engine performance,
      // but it is hard on the engines and usually damages some of them.  It
      // draws all the power it needs from the engines and needs no generator
      // power.
      driveHullCell = Q_Ship_FindFirstCellWithCat_sub_49328(pShip, ASCEND_GIZMO_CAT_DRIVE);
      if ( driveHullCell != 0xFFFFFFFF )
      {
        Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, driveHullCell);
        LOBYTE(pShip->specialEffects) |= ASCEND_EFFECT_ENGINES_BOOST;
        return statusFlags;
      }
    }
    return statusFlags;
  }
  hullCells = pShip->hullCells;
  if ( gizmoIndex <= 0x41u )
  {
    // 65. Replenisher
    // The %s fully recharges all of the weapons aboard a ship.
    // Its installation is involved and expensive, but it can be a lifesaver in
    // an intense battle.
    if ( pShip->hullCellsNum > 0 )
    {
      v24 = 0;
      do
      {
        v26 = hullCells->gizmoIndex;
        if ( hullCells->gizmoIndex != (BYTE)0xFF && v26 != ASCEND_GIZMO_65_REPLENISHER )
        {
          v27 = v26;
          if ( V_Gizmos[v27].numUses )
          {
            hullCells->_usesPerTurnLeft = V_Gizmos[v27].numUses;
          }
        }
        ++v24;
        ++hullCells;
      }
      while ( v24 < pShip->hullCellsNum );
    }
    return statusFlags;
  }
  if ( gizmoIndex >= 0x48u )
  {
    if ( gizmoIndex > 0x48u )
    {
      if ( gizmoIndex == ASCEND_GIZMO_75_HYPERFUEL )
      {
        // 75. Hyperfuel
        // %s is a one-time-use power reserve of great capacity.  It is a cheap,
        // disposable source of power.
        pCurrHullCell = pShip->pCurHullCell;
        pShip->availablePower += pGizmo->special1;
        Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pCurrHullCell - hullCells);
      }
      return statusFlags;
    }
    // 72. Self Destructotron
    // The %s is a desperation device.  It destroys the ship using it by
    // converting most of the ship's mass to energy, creating a huge explosion that
    // greatly damages other ships nearby.
    targetCount = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, blastTargetShips);
    if ( targetCount > 0 )
    {
      epicenter = &pShip->position;
      targetCount_ = targetCount;
      v62 = 4 * targetCount;
      for ( k = 0; k < targetCount_; ++k )
      {
        pBlastTargetShip = blastTargetShips[k];
        if ( pShip != pBlastTargetShip )
        {
          memset(&v53, 0, sizeof(v53));
          v58 = &v54;
          v53.x = pBlastTargetShip->position.x - epicenter->x;
          v53.y = pBlastTargetShip->position.y - epicenter->y;
          v53.z = pBlastTargetShip->position.z - epicenter->z;
          v54 = v53;
          distance = sqrt(v53.y * v53.y + v53.x * v53.x + v53.z * v53.z);
          effectRange = 0x20 * pGizmo->range;
          if ( (double)effectRange >= distance )
          {
            Q_Ship_ApplyDamage_sub_4B7A0(blastTargetShips[k], activationMode, pGizmo->special1, pShip->raceIndex);
          }
        }
      }
    }
DESTROY_SHIP:
    Q_Ship_RemoveFromTheGame_sub_49940(pShip);
    return statusFlags;
  }
  if ( gizmoIndex == ASCEND_GIZMO_69_INVULNERABLIZER )
  {
    // 69. Invulnerablizer
    // The %s sets up a temporary high-magitechnology shield around the
    // ship using it.  While it lasts, the shield will not allow the
    // ship to come to harm.  It consumes little power but it is costly to
    // build and can be used only once.
    LOBYTE(pShip->specialEffects) |= ASCEND_EFFECT_INVULNERABLE;
    Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - hullCells);
  }
  return statusFlags;
}

//----- (0004D700) --------------------------------------------------------
void Q_Ship_StaticCtor_sub_4D700()
{
  _wcpp_2_mod_register_((RW_DTREG *)&stru_96AC0);
  Q_Ship_Ctor_sub_48B90(&V_Ship);
  stru_96AC0.state_var = 1;
}

//----- (0004D724) --------------------------------------------------------
int __fastcall sub_4D724(PANE *pPane, int a2, LONG shapeNumber, int bWipe)
{
  void *gizmosShapeTable; // eax

  if ( bWipe )
  {
    VFX_pane_wipe(pPane, 0x96);
  }
  gizmosShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);// 28: data\gizmos.shp
  if ( !gizmosShapeTable )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x34);
  }
  VFX_shape_draw(pPane, gizmosShapeTable, shapeNumber, 63, 45);
  WinMgr.SmallFont.pane = *pPane;
  return Q_Font_DrawFormattedText_sub_2B8A8(
           &WinMgr.SmallFont,
           63,
           2,
           V_Gizmos[shapeNumber].name,
           ASCEND_TF_HALIGN_CENTERXOFF,
           0xFFFF,
           0xFF,
           122);
}

//----- (0004D7A8) --------------------------------------------------------
unsigned int __fastcall Q_GetHullCellIndexAtPos_sub_4D7A8(int x, int y, int hullSize)
{
  unsigned int v3; // ebx
  int v4; // esi
  int v5; // ecx
  int i; // edi
  UBYTE v7; // al
  int j; // edx
  UBYTE v9; // al
  int k; // edx
  int v13; // [esp+4h] [ebp-20h]
  int v14; // [esp+8h] [ebp-1Ch]
  int v15; // [esp+Ch] [ebp-18h]

  v3 = 0xFFFFFFFF;
  v4 = y - 148;
  v5 = x - 367;
  if ( y - 148 > 0 )
  {
    v15 = (v4 - v5 / 2 + 18) / 2 / 18;
    v14 = (v5 / 2 + v4 - 18) / 2 / 18;
    v13 = byte_969A8[v15];
    if ( v15 < 14 && v14 >= v13 && v13 + byte_969B8[v15] > v14 && ((1 << (v14 - v13)) & byte_106FE0[4 * v15 + hullSize]) != 0 )
    {
      if ( v15 > 0 )
      {
        for ( i = 0; i < v15; ++i )
        {
          v7 = 1;
          for ( j = 0; j < byte_969B8[i]; ++j )
          {
            if ( (v7 & byte_106FE0[4 * i + hullSize]) != 0 )
            {
              ++v3;
            }
            v7 *= 2;
          }
        }
      }
      v9 = 1;
      for ( k = 0; k <= v14 - v13; v9 *= 2 )
      {
        if ( (v9 & byte_106FE0[4 * v15 + hullSize]) != 0 )
        {
          ++v3;
        }
        ++k;
      }
    }
  }
  return v3;
}

//----- (0004D92C) --------------------------------------------------------
P_Wnd08SW __fastcall Q_Wnd8SWCtor_sub_4D92C(P_Wnd08SW pWnd)
{
  Q_WndA2_Ctor_sub_2C830(&pWnd->a);
  Q_Ship_Ctor_sub_48B90(&pWnd->Ship);
  pWnd->a.pProcs = &Wnd08SW_Procs;
  pWnd->selectedGizmoIndex = -1;
  pWnd->Unknown_BC = 0;
  pWnd->Unknown_BD = 0xFFFFFFFF;
  pWnd->Unknown_C1 = 0xFFFFFFFF;
  pWnd->pWnd10LB = 0;
  pWnd->pShip = 0;
  pWnd->Unknown_C9 = 0;
  sub_4DA5C(pWnd);
  return pWnd;
}

//----- (0004DA08) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd08SWDtor_sub_4DA08(int a1, char a2, int a3, int a4)
{
  char *v6; // eax
  T_WndA2 *v8; // eax
  T_WndA2 *v9; // ebx

  if ( (a2 & 4) != 0 )
  {
    v6 = _wcpp_2_dtor_array_store_((void *)a1, &C_Wnd8SW);
    operator delete[](v6);
    return (T_WndA2 *)a1;
  }
  else
  {
    *(_DWORD *)(a1 + 0xA7) = &Wnd08SW_Procs;
    v8 = (T_WndA2 *)(Q_ShipDtor_sub_48C58() - 0xCD);
    Q_WndA2_Dtor_sub_2C848(v8, 1);
    v9 = v8;
    if ( (a2 & 2) != 0 )
    {
      operator delete(v8);
    }
    return v9;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0004DA5C) --------------------------------------------------------
void __fastcall __spoils<> sub_4DA5C(P_Wnd08SW pWnd)
{
  if ( dword_96ACC )
  {
    pWnd->Unknown_B7 = 0x4C;
    dword_96ACC = 0;
  }
}
// 96ACC: using guessed type int dword_96ACC;

//----- (0004DA7C) --------------------------------------------------------
int __fastcall sub_4DA7C(P_Wnd08SW pWnd8SW, P_Ship pShip, int a3, int a4)
{
  T_Ship *p_Ship; // ebp
  int result; // eax
  P_Ship pShip_; // [esp+8h] [ebp-10h]

  sub_4DA5C(pWnd8SW);
  pWnd8SW->pShip = pShip;
  pWnd8SW->Unknown_C9 = a3;
  if ( a3 == 0xFFFFFFFF )
  {
    p_Ship = &pWnd8SW->Ship;
    pShip_ = pWnd8SW->pShip;
    pWnd8SW->Ship.totalWeaponDamage = pShip_->totalWeaponDamage;
    pWnd8SW->Ship.totalShieldStrength = pShip_->totalShieldStrength;
    pWnd8SW->Ship.totalStarLaneDrivePotential = pShip_->totalStarLaneDrivePotential;
    pWnd8SW->Ship.totalStarLaneHyperdrivePotential = pShip_->totalStarLaneHyperdrivePotential;
    pWnd8SW->Ship.totalDriveMaxDistance = pShip_->totalDriveMaxDistance;
    pWnd8SW->Ship.Unknown_14 = pShip_->Unknown_14;
    pWnd8SW->Ship.totalGeneratorPower = pShip_->totalGeneratorPower;
    pWnd8SW->Ship.totalPowerForDrives = pShip_->totalPowerForDrives;
    pWnd8SW->Ship.totalScannerRangePerTurn = pShip_->totalScannerRangePerTurn;
    pWnd8SW->Ship.cloakingLevel = pShip_->cloakingLevel;
    pWnd8SW->Ship.hasColonizer = pShip_->hasColonizer;
    pWnd8SW->Ship.Unknown_2C = pShip_->Unknown_2C;
    pWnd8SW->Ship.Unknown_30 = pShip_->Unknown_30;
    qmemcpy(pWnd8SW->Ship.name, pShip_->name, 0x29u);
    pWnd8SW->Ship.pLocation.pPlanet = pShip_->pLocation.pPlanet;
    pWnd8SW->Ship.pLocation.pPlanet = pShip_->pLocation.pPlanet;
    pWnd8SW->Ship.order = pShip_->order;
    pWnd8SW->Ship._orderTargetObject.pPlanet = pShip_->_orderTargetObject.pPlanet;
    pWnd8SW->Ship.Unknown_62 = pShip_->Unknown_62;
    pWnd8SW->Ship.pCurHullCell = pShip_->pCurHullCell;
    pWnd8SW->Ship._target = pShip_->_target;
    pWnd8SW->Ship._target.pObject.pPlanet = pShip_->_target.pObject.pPlanet;
    pWnd8SW->Ship._target.pObject.pPlanet = pShip_->_target.pObject.pPlanet;
    pWnd8SW->Ship._target.pObject.pPlanet = pShip_->_target.pObject.pPlanet;
    pWnd8SW->Ship.Unknown_6C = pShip_->Unknown_6C;
    pWnd8SW->Ship.Unknown_78 = pShip_->Unknown_78;
    pWnd8SW->Ship.Unknown_84 = pShip_->Unknown_84;
    pWnd8SW->Ship.availablePower = pShip_->availablePower;
    pWnd8SW->Ship.hullIntegrity = pShip_->hullIntegrity;
    pWnd8SW->Ship._currentShieldStrength = pShip_->_currentShieldStrength;
    pWnd8SW->Ship.availableMoves = pShip_->availableMoves;
    pWnd8SW->Ship.fullHullIntegrity = pShip_->fullHullIntegrity;
    pWnd8SW->Ship.specialEffects = pShip_->specialEffects;
    pWnd8SW->Ship.position = pShip_->position;
    pWnd8SW->Ship.hullSize = pShip_->hullSize;
    _wcpp_2_assign_array_(pWnd8SW->Ship.hullCells, pShip_->hullCells, 0x19u, 7u, (pFUNcopy)Q_HullCell_Copy_sub_4B780);
    p_Ship->hullCellsNum = pShip_->hullCellsNum;
    p_Ship->gizmosNum = pShip_->gizmosNum;
  }
  result = a4;
  pWnd8SW->Unknown_233 = a4;
  return result;
}

//----- (0004DD14) --------------------------------------------------------
void __fastcall sub_4DD14(int a1)
{
  int resReq; // eax
  unsigned __int16 v3; // ax
  int v4; // edi

  Q_Wnd10LB_Clear_sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xC5));
  if ( *(int *)(a1 + 0xB7) > 0 )
  {
    v4 = 0;
    do
    {
      if ( V_Gizmos[v4].cat == *(_BYTE *)(a1 + 0xBC) )
      {
        resReq = V_Gizmos[v4].resReq;
        if ( resReq == 0xFF || ((1 << V_PlayerRaceIndex) & V_Research.techs[resReq].knownToRace) != 0 )
        {
          v3 = Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(a1 + 0xC5), (BYTE *)a1, 0xFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xC5), v3, v4);
        }
      }
      ++v4;
    }
    while ( v4 < *(_DWORD *)(a1 + 0xB7) );
  }
}

//----- (0004DDB0) --------------------------------------------------------
int __fastcall Q_Wnd08SW_Proc3_sub_4DDB0(P_Wnd08SW pWnd08SW, UWORD message, int param1, int param2)
{
  BYTE v5; // al
  P_Procs v6; // ebx
  LONG ItemValue_sub_2ECA4; // ebx
  int result; // eax
  T_Wnd10LB *Wnd_sub_56DA8; // eax
  P_Ship pShip; // ecx
  double z; // st7
  double v12; // st7
  int i; // esi
  P_Procs v14; // edi
  int v15; // edx
  P_Procs v16; // ebx
  int soundNumber; // edx
  P_Procs pProcs; // ebx

  if ( message < 0x32u )
  {
    if ( message >= 5u )
    {
      if ( message <= 5u )
      {
        if ( pWnd08SW->a.Unknown_35
          && param1 >= pWnd08SW->a.pane.x0
          && param1 <= pWnd08SW->a.pane.x1
          && param2 >= pWnd08SW->a.pane.y0
          && param2 <= pWnd08SW->a.pane.y1 )
        {
          if ( pWnd08SW->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          if ( V_SelectedHullCellIndex >= 0 )
          {
            if ( !pWnd08SW->pShip )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x1D8);
            }
            if ( Q_Ship_RemoveGizmoFromCell_sub_492F8(pWnd08SW->pShip, V_SelectedHullCellIndex) )
            {
              soundNumber = pWnd08SW->a.soundNumber;
              if ( soundNumber != 0xFFFFFFFF )
              {
                Q_SSystem_StartSample_sub_4FB90(&V_SSystem, soundNumber);
              }
              pWnd08SW->Unknown_BD = 0xFFFFFFFF;
              pProcs = pWnd08SW->a.pProcs;
              pWnd08SW->Unknown_D1 = 0xFFFFFFFF;
              ((void (*)(void))pProcs->proc4_draw)();
            }
          }
          return 0xFFFFFFFF;
        }
      }
      else
      {
        if ( message < 7u )
        {
          if ( pWnd08SW->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          Q_WinMgr_RemoveWinEventSmall_sub_567BC(&WinMgr, pWnd08SW->a.index, 8);
          if ( pWnd08SW->a.Unknown_39 && pWnd08SW->a.Unknown_35 && (V_SelectedHullCellIndex >= 0 || pWnd08SW->a._mouseFocus) )
          {
            V_SelectedHullCellIndex = 0xFFFFFFFF;
            pWnd08SW->a.pProcs->proc4_draw((P_WndA2)pWnd08SW, 0);
          }
          else
          {
            V_SelectedHullCellIndex = 0xFFFFFFFF;
          }
          return 0xFFFFFFFF;
        }
        if ( message <= 7u )
        {
          if ( pWnd08SW->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          Q_WinMgr_AddWinEventSmall_sub_56728(&WinMgr, pWnd08SW->a.index, 4, 8, 0, 0);
          if ( (pWnd08SW->a._mouseFocus & pWnd08SW->a.Unknown_35 & pWnd08SW->a.Unknown_39) == 0xFFFFFFFF )
          {
            pWnd08SW->a.pProcs->proc5(&pWnd08SW->a, 0);
          }
          return 0xFFFFFFFF;
        }
        if ( message != 8 )
        {
          return Q_WndA2_Proc3_sub_2F424(&pWnd08SW->a, message, param1, param2);
        }
        if ( pWnd08SW->Unknown_233 != 0xFFFFFFFF )
        {
          if ( !pWnd08SW->pShip )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x13D);
          }
          V_SelectedHullCellIndex = Q_GetHullCellIndexAtPos_sub_4D7A8(param1, param2, pWnd08SW->pShip->hullSize);
          pWnd08SW->a.pProcs->proc4_draw((P_WndA2)pWnd08SW, 0);
          return 0;
        }
      }
      return 0;
    }
    if ( message < 2u )
    {
      if ( message == 1 )
      {
        if ( pWnd08SW->pShip )
        {
          sub_4DA5C(pWnd08SW);
        }
        else
        {
          pWnd08SW->pShip = &V_Ship;
        }
        pWnd08SW->Unknown_C1 = 0xFFFFFFFF;
        pWnd08SW->Unknown_D1 = 0;
        Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "GIZLIST", 0);
        pWnd08SW->pWnd10LB = Wnd_sub_56DA8;
        if ( !Wnd_sub_56DA8 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x153);
        }
        pWnd08SW->pWnd10LB->Unknown_AB = 0;
        Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pWnd08SW->pWnd10LB, (P_DrawItemFunc)sub_4D724);
        pWnd08SW->pWnd10LB->_defaultItemHeight = 0x40;
        Q_Wnd10LB_InitScrollBar_sub_2E9CC(pWnd08SW->pWnd10LB, 0);
        pWnd08SW->pWnd10LB->wipeColor = 0xF2;
        if ( pWnd08SW->selectedGizmoIndex == (BYTE)0xFF )
        {
          sub_4E644((int)pWnd08SW, 4, 0, param2);
        }
        else
        {
          sub_4DD14((int)pWnd08SW);
        }
        pWnd08SW->Unknown_BD = 0xFFFFFFFF;
        pWnd08SW->a.Unknown_39 = 0xFFFFFFFF;
        pWnd08SW->a.Unknown_35 = 0xFFFFFFFF;
        pWnd08SW->a.pProcs->proc4_draw((P_WndA2)pWnd08SW, 0);
        Q_WndA2_CallChildrenProc3_sub_2D258(&pWnd08SW->a, message, param1, param2);
        return 0;
      }
    }
    else
    {
      if ( message <= 2u )
      {
        pWnd08SW->a.Unknown_39 = 0;
        pWnd08SW->a.Unknown_35 = 0;
        pShip = pWnd08SW->pShip;
        V_SelectedHullCellIndex = -1u;
        if ( &V_Ship != pShip )
        {
          V_Ship.totalWeaponDamage = pShip->totalWeaponDamage;
          V_Ship.totalShieldStrength = pShip->totalShieldStrength;
          V_Ship.totalStarLaneDrivePotential = pShip->totalStarLaneDrivePotential;
          V_Ship.totalStarLaneHyperdrivePotential = pShip->totalStarLaneHyperdrivePotential;
          V_Ship.totalDriveMaxDistance = pShip->totalDriveMaxDistance;
          V_Ship.Unknown_14 = pShip->Unknown_14;
          V_Ship.totalGeneratorPower = pShip->totalGeneratorPower;
          V_Ship.totalPowerForDrives = pShip->totalPowerForDrives;
          V_Ship.totalScannerRangePerTurn = pShip->totalScannerRangePerTurn;
          V_Ship.cloakingLevel = pShip->cloakingLevel;
          V_Ship.hasColonizer = pShip->hasColonizer;
          V_Ship.Unknown_2C = pShip->Unknown_2C;
          V_Ship.Unknown_30 = pShip->Unknown_30;
          qmemcpy(V_Ship.name, pShip->name, 0x1Eu);
          V_Ship._dayBuilt = pShip->_dayBuilt;
          V_Ship.raceIndex = pShip->raceIndex;
          V_Ship.locationType = pShip->locationType;
          V_Ship.pLocation.pPlanet = pShip->pLocation.pPlanet;
          V_Ship.pLocation.pPlanet = pShip->pLocation.pPlanet;
          V_Ship.pLocation.pPlanet = pShip->pLocation.pPlanet;
          V_Ship.order = pShip->order;
          V_Ship._orderTargetObject.pPlanet = pShip->_orderTargetObject.pPlanet;
          V_Ship.Unknown_62 = pShip->Unknown_62;
          V_Ship.pCurHullCell = pShip->pCurHullCell;
          V_Ship._target = pShip->_target;
          V_Ship._target.pObject.pPlanet = pShip->_target.pObject.pPlanet;
          V_Ship._target.pObject.pPlanet = pShip->_target.pObject.pPlanet;
          V_Ship._target.pObject.pPlanet = pShip->_target.pObject.pPlanet;
          V_Ship.Unknown_6C.x = pShip->Unknown_6C.x;
          V_Ship.Unknown_6C.y = pShip->Unknown_6C.y;
          V_Ship.Unknown_6C.z = pShip->Unknown_6C.z;
          V_Ship.Unknown_78.x = pShip->Unknown_78.x;
          V_Ship.Unknown_78.y = pShip->Unknown_78.y;
          z = pShip->Unknown_78.z;
          V_Ship.Unknown_84 = pShip->Unknown_84;
          V_Ship.availablePower = pShip->availablePower;
          V_Ship.hullIntegrity = pShip->hullIntegrity;
          V_Ship._currentShieldStrength = pShip->_currentShieldStrength;
          V_Ship.availableMoves = pShip->availableMoves;
          V_Ship.fullHullIntegrity = pShip->fullHullIntegrity;
          V_Ship.specialEffects = pShip->specialEffects;
          V_Ship.Unknown_78.z = z;
          V_Ship.position.x = pShip->position.x;
          V_Ship.position.y = pShip->position.y;
          v12 = pShip->position.z;
          V_Ship.hullSize = pShip->hullSize;
          V_Ship.position.z = v12;
          _wcpp_2_assign_array_(V_Ship.hullCells, pShip->hullCells, 0x19u, 7u, (pFUNcopy)Q_HullCell_Copy_sub_4B780);
          V_Ship.hullCellsNum = pShip->hullCellsNum;
          V_Ship.gizmosNum = pShip->gizmosNum;
        }
        for ( i = 0; (__int16)i < pWnd08SW->a.childrenNum; ++i )
        {
          v14 = (*pWnd08SW->a.children)[(__int16)i]->pProcs;
          ((void (*)(void))v14->proc3_msg)();
        }
        if ( !pWnd08SW->Unknown_D1 )
        {
          pWnd08SW->pShip = 0;
          return 0;
        }
        return 0;
      }
      if ( message == 4 )
      {
        result = pWnd08SW->a.Unknown_35;
        if ( !result )
        {
          return result;
        }
        if ( param1 >= pWnd08SW->a.pane.x0
          && param1 <= pWnd08SW->a.pane.x1
          && param2 >= pWnd08SW->a.pane.y0
          && param2 <= pWnd08SW->a.pane.y1 )
        {
          if ( pWnd08SW->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          if ( V_SelectedHullCellIndex >= 0 )
          {
            if ( !pWnd08SW->pShip )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x1B2);
            }
            if ( Q_Ship_PutNewGizmoIntoCell_sub_492AC(pWnd08SW->pShip, pWnd08SW->selectedGizmoIndex, V_SelectedHullCellIndex) )
            {
              v15 = pWnd08SW->a.soundNumber;
              if ( v15 != 0xFFFFFFFF )
              {
                Q_SSystem_StartSample_sub_4FB90(&V_SSystem, v15);
              }
              pWnd08SW->Unknown_BD = 0xFFFFFFFF;
              v16 = pWnd08SW->a.pProcs;
              pWnd08SW->Unknown_D1 = 0xFFFFFFFF;
              ((void (*)(void))v16->proc4_draw)();
            }
          }
          return 0xFFFFFFFF;
        }
        return 0;
      }
    }
    return Q_WndA2_Proc3_sub_2F424(&pWnd08SW->a, message, param1, param2);
  }
  if ( message <= 0x32u )
  {
    if ( pWnd08SW->Unknown_233 != 0xFFFFFFFF )
    {
      if ( sub_4E69C((int)pWnd08SW) )
      {
        pWnd08SW->Unknown_C1 = 0xFFFFFFFF;
      }
      pWnd08SW->a.pProcs->proc4_draw((P_WndA2)pWnd08SW, 0);
      return 0;
    }
    return 0;
  }
  if ( message >= 0x36u )
  {
    if ( message <= 0x36u )
    {
      sub_4E644((int)pWnd08SW, 2, param1, param2);
      return 0;
    }
    if ( message < 0x39u )
    {
      if ( message == 0x37 )
      {
        sub_4E644((int)pWnd08SW, 4, param1, param2);
        return 0;
      }
      return Q_WndA2_Proc3_sub_2F424(&pWnd08SW->a, message, param1, param2);
    }
    if ( message <= 0x39u )
    {
      sub_4E644((int)pWnd08SW, 5, param1, param2);
      return 0;
    }
    if ( message < 0x1C01u )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd08SW->a, message, param1, param2);
    }
    if ( message > 0x1C01u )
    {
      if ( message == 0x1C02 )
      {
        ItemValue_sub_2ECA4 = (char)Q_Wnd10LB_GetItemValue_sub_2ECA4(pWnd08SW->pWnd10LB, param1);
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, ItemValue_sub_2ECA4, 4);
        return 0xFFFFFFFF;
      }
      return Q_WndA2_Proc3_sub_2F424(&pWnd08SW->a, message, param1, param2);
    }
    v5 = Q_Wnd10LB_GetItemValue_sub_2ECA4(pWnd08SW->pWnd10LB, param1);
    if ( v5 != pWnd08SW->selectedGizmoIndex )
    {
      v6 = pWnd08SW->a.pProcs;
      pWnd08SW->selectedGizmoIndex = v5;
      v6->proc4_draw(&pWnd08SW->a, 0);
    }
    return 0;
  }
  if ( message < 0x34u )
  {
    sub_4E644((int)pWnd08SW, 0, param1, param2);
    return 0;
  }
  else
  {
    if ( message <= 0x34u )
    {
      sub_4E644((int)pWnd08SW, 1, param1, param2);
    }
    else
    {
      sub_4E644((int)pWnd08SW, 3, param1, param2);
    }
    return 0;
  }
}
// 96AD0: using guessed type int V_SelectedHullCellIndex;

//----- (0004E644) --------------------------------------------------------
int __fastcall sub_4E644(int result, char a2, int a3, int a4)
{
  int v4; // ebx
  T_Wnd10LB *v5; // eax

  v4 = result;
  if ( a2 >= 0 && a2 < 6 && a2 != *(_BYTE *)(result + 0xBC) )
  {
    *(_BYTE *)(result + 0xBC) = a2;
    sub_4DD14(result);
    v5 = *(T_Wnd10LB **)(v4 + 0xC5);
    *(_BYTE *)(v4 + 0xBB) = 0xFF;
    if ( v5->itemCount )
    {
      *(_BYTE *)(v4 + 0xBB) = Q_Wnd10LB_GetItemValue_sub_2ECA4(v5, 0);
    }
    return (*(int (**)(void))(*(_DWORD *)(v4 + 0xA7) + 0xC))();
  }
  return result;
}

//----- (0004E69C) --------------------------------------------------------
unsigned int __fastcall sub_4E69C(int a1)
{
  unsigned int v2; // ebp
  int v3; // ebx
  unsigned int v4; // esi
  T_Ship *v5; // eax

  v2 = 0;
  v3 = *(char *)(*(_DWORD *)(a1 + 0xAB) + 0xAA);
  v4 = 0;
  if ( !*(_DWORD *)(a1 + 0xC9) )
  {
    while ( !v4 )
    {
      if ( v3 + 1 >= 4 )
      {
        v3 = 0;
      }
      if ( (v3 != 2 || ((1 << V_PlayerRaceIndex) & V_Research.techs[0x13].knownToRace) != 0)
        && (v3 != 3 || ((1 << V_PlayerRaceIndex) & V_Research.techs[0x1F].knownToRace) != 0) )
      {
        v5 = *(T_Ship **)(a1 + 0xAB);
        if ( v3 == v5->hullSize )
        {
          v4 = 0xFFFFFFFF;
          v2 = 0;
        }
        else if ( Q_Ship_ChangeHullSize_sub_493BC(v5, v3) )
        {
          v4 = 0xFFFFFFFF;
          v2 = 0xFFFFFFFF;
          *(_DWORD *)(a1 + 0xBD) = 0xFFFFFFFF;
        }
      }
    }
  }
  return v2;
}

//----- (0004E758) --------------------------------------------------------
void __fastcall Q_Wnd08SW_Proc4_sub_4E758(P_Wnd08SW pWnd, int a2)
{
  int hullSize; // esi
  int hullSize_; // kr00_4
  LONG gizsmosShp; // eax
  int v5; // edi
  int v6; // esi
  int v7; // eax
  int v8; // kr0C_4
  int v9; // kr30_4
  int v10; // kr34_4
  UWORD gizsmosShp__; // dx
  UWORD shapeCacheIndex; // ax
  BYTE gizmoIndex; // bh
  void *gizmosShpTable; // eax
  void *gizmosShpTable_; // eax
  void *dkshipShpTable; // ecx
  P_Wnd08SW v17; // ebx
  P_Planet pCurPlanet; // edx
  int Cost_sub_4A18C; // eax
  int TurnsToComplete_sub_46C20; // eax
  int v21; // eax
  char *sub_1CEA8; // eax
  P_Ship pShip; // eax
  int totalGeneratorPower; // eax
  int totalValue; // edx
  int v26; // esi
  int j; // kr14_4
  LONG selectedGizmoIndex; // [esp-Ch] [ebp-7Eh]
  LONG v29; // [esp-Ch] [ebp-7Eh]
  WORD v30; // [esp-Ch] [ebp-7Eh]
  LONG v31; // [esp-8h] [ebp-7Ah]
  int v32; // [esp-8h] [ebp-7Ah]
  LONG v33; // [esp-4h] [ebp-76h]
  char s[52]; // [esp+0h] [ebp-72h] BYREF
  char v35[52]; // [esp+34h] [ebp-3Eh] BYREF
  PANE pane; // [esp+68h] [ebp-Ah] BYREF
  PANE pane2; // [esp+7Ch] [ebp+Ah] BYREF
  int shipTotals[5]; // [esp+90h] [ebp+1Eh]
  PANE pPane; // [esp+A4h] [ebp+32h] BYREF
  P_Wnd08SW pShipDesignWindow; // [esp+B8h] [ebp+46h]
  int v41; // [esp+BCh] [ebp+4Ah]
  int v42; // [esp+C0h] [ebp+4Eh]
  int v43; // [esp+C4h] [ebp+52h]
  int v44; // [esp+C8h] [ebp+56h]
  int v45; // [esp+CCh] [ebp+5Ah]
  int v46; // [esp+D0h] [ebp+5Eh]
  int i; // [esp+D4h] [ebp+62h]
  void *shipiconShpTable; // [esp+D8h] [ebp+66h]
  LONG shape_number; // [esp+DCh] [ebp+6Ah]
  int v50; // [esp+E0h] [ebp+6Eh]
  int v51; // [esp+E4h] [ebp+72h]
  LONG hotY; // [esp+E8h] [ebp+76h]
  T_UWordPair gizsmosShp_; // [esp+ECh] [ebp+7Ah]
  unsigned __int8 v54; // [esp+F0h] [ebp+7Eh]

  pShipDesignWindow = pWnd;
  if ( !pWnd->pShip )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x24A);
  }
  hullSize = pShipDesignWindow->pShip->hullSize;
  pane.window = (WINDOW *)&V_GSystem;
  pane.x0 = 330;
  pane.y0 = 114;
  pane.x1 = 476;
  pane.y1 = 472;
  v45 = hullSize;
  hullSize_ = hullSize;
  VFX_pane_wipe(&pane, 0);
  pane.y1 = 472;
  pane.x1 = 329;
  pane.x0 = 7;
  pane.y0 = 345;
  gizsmosShp = VFX_pane_wipe(&pane, 0);
  LOWORD(gizsmosShp) = GwshareShpCacheIndexes[0x1C];   // 28: data\gizmos.shp
  v42 = 0;
  gizsmosShp_ = (T_UWordPair)gizsmosShp;
  for ( i = 0; i < 14; ++i )
  {
    v5 = 18 * (i + byte_969A8[i]) + 166;
    v6 = 36 * (byte_969A8[i] - i) + 403;
    v7 = byte_969B8[i];
    v54 = 1;
    v51 = v7;
    v41 = 0;
    if ( v7 > 0 )
    {
      v50 = hullSize_ + 4 * i;
      v43 = 7 * v42;
      v9 = v42;
      v8 = 0;
      v10 = 0;
      while ( (v54 & byte_106FE0[v50]) == 0 )
      {
LABEL_12:
        v54 *= 2;
        ++v41;
        ++v8;
        if ( v41 >= v51 )
        {
          goto LABEL_4;
        }
      }
      if ( V_SelectedHullCellIndex >= 0 && V_SelectedHullCellIndex == v42 )
      {
        if ( pShipDesignWindow->selectedGizmoIndex != -1 )
        {
          v33 = v5 + 0x12 * v8;
          v31 = v6 + 0x24 * v8;
          selectedGizmoIndex = pShipDesignWindow->selectedGizmoIndex;
          gizsmosShp__ = gizsmosShp_.word0;
LABEL_23:
          gizmosShpTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, gizsmosShp__);
          VFX_shape_draw(&V_GSystem.pane, gizmosShpTable, selectedGizmoIndex, v31, v33);
          ++v42;
          ++v10;
          goto LABEL_12;
        }
        v33 = v5 + 0x12 * v8;
        v31 = v6 + 0x24 * v8;
        shapeCacheIndex = pShipDesignWindow->a.shapeCacheIndex;
        selectedGizmoIndex = 1;
      }
      else
      {
        if ( !pShipDesignWindow->pShip )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x28D);
        }
        gizmoIndex = pShipDesignWindow->pShip->hullCells[v10 + v9].gizmoIndex;
        if ( gizmoIndex != -1 )
        {
          if ( gizmoIndex >= 0x4C )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x291);
          }
          v33 = v5 + 0x12 * v8;
          v31 = v6 + 0x24 * v8;
          selectedGizmoIndex = pShipDesignWindow->pShip->hullCells[v10 + v9].gizmoIndex;
          gizsmosShp__ = gizsmosShp_.word0;
          goto LABEL_23;
        }
        v33 = v5 + 0x12 * v8;
        v31 = v6 + 0x24 * v8;
        shapeCacheIndex = pShipDesignWindow->a.shapeCacheIndex;
        selectedGizmoIndex = 0;
      }
      gizsmosShp__ = shapeCacheIndex;
      goto LABEL_23;
    }
LABEL_4:
    ;
  }
  Q_WinMgr_AddDirtyArea_sub_55274(
    &WinMgr,
    pShipDesignWindow->a.pane.x0,
    pShipDesignWindow->a.pane.y0,
    pShipDesignWindow->a.pane.x1,
    pShipDesignWindow->a.pane.y1);
  if ( pShipDesignWindow->selectedGizmoIndex != -1 )
  {
    pPane.window = (WINDOW *)&V_GSystem;
    pPane.y1 = 105;
    pPane.x0 = 315;
    pPane.y0 = 7;
    pPane.x1 = 476;
    VFX_pane_wipe(&pPane, 0xF2);
    v32 = (pPane.x1 - pPane.x0) >> 1;
    v29 = pShipDesignWindow->selectedGizmoIndex;
    gizmosShpTable_ = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, gizsmosShp_.word0);
    VFX_shape_draw(&pPane, gizmosShpTable_, v29, v32, 58);
    WinMgr.SmallFont.pane = pPane;
    sprintf(s, "%s", V_Gizmos[pShipDesignWindow->selectedGizmoIndex].name);
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 3, 3, s, 0x42u, 0xF3, 0xFF, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
  }
  if ( pShipDesignWindow->Unknown_C1 )
  {
    pane.window = (WINDOW *)&V_GSystem;
    pane.x1 = 321;
    pane.x0 = 7;
    pane.y0 = 114;
    pane.y1 = 336;
    VFX_pane_wipe(&pane, 0);
    dkshipShpTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 0x15]);
    if ( !dkshipShpTable )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x2CB);
    }
    VFX_shape_draw(&pane, dkshipShpTable, pShipDesignWindow->pShip->hullSize, 0, 0);
    pShipDesignWindow->Unknown_C1 = 0;
  }
  if ( pShipDesignWindow->Unknown_BD )
  {
    pane.window = (WINDOW *)&V_GSystem;
    pane.x1 = 304;
    pane.x0 = 7;
    pane.y0 = 7;
    pane.y1 = 102;
    VFX_pane_wipe(&pane, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
    Q_DrawRaceFlagTinted_sub_53E38(&pane, 3, 3, V_PlayerRaceIndex);
    qmemcpy(v35, &unk_96AD4, 0x32u);
    if ( pShipDesignWindow->pShip != &V_Ship && pShipDesignWindow->Unknown_D1 == 0xFFFFFFFF )
    {
      v17 = pShipDesignWindow;
      pCurPlanet = V_Game.pCurPlanet;
      Cost_sub_4A18C = Q_Ship_GetCost_sub_4A18C(pShipDesignWindow->pShip);
      if ( v17->Unknown_C9 == 0xFFFFFFFF )
      {
        Cost_sub_4A18C = Q_Wnd08SW_CalculateShipRefitCost_sub_4EE00(v17);
      }
      TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(Cost_sub_4A18C, pCurPlanet->buildingProgress, pCurPlanet->industry);
      if ( TurnsToComplete_sub_46C20 != 0xFFFF )
      {
        if ( TurnsToComplete_sub_46C20 == 1 )
        {
          v21 = 0x1C;                                  // 28: ""
        }
        else
        {
          v21 = 0x1D;                                  // 29: "s"
        }
        Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v21);
        sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x87);// 135: " (%d Day%s)"
        sprintf(v35, sub_1CEA8);
      }
    }
    sprintf(s, "%s \"%s\"%s", V_SpecNames[V_Game.races[V_PlayerRaceIndex].species], pShipDesignWindow->pShip->name, v35);
    v30 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
    WinMgr.LargeFont.pane = pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 3, s, 2u, v30, 0xFFFF, 0);
    shipiconShpTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x23]);// 35: data\shipicon.shp
    shipTotals[0] = pShipDesignWindow->pShip->totalWeaponDamage;
    shipTotals[1] = pShipDesignWindow->pShip->totalShieldStrength;
    shipTotals[2] = pShipDesignWindow->pShip->totalDriveMaxDistance;
    shipTotals[3] = pShipDesignWindow->pShip->totalScannerRangePerTurn;
    pShip = pShipDesignWindow->pShip;
    v44 = 7;
    totalGeneratorPower = pShip->totalGeneratorPower;
    pane2 = pane;
    shipTotals[4] = totalGeneratorPower;
    hotY = 20;
    v46 = 0;
    for ( j = 0; j != 5; ++j )
    {
      pane2.x1 = pane2.x0 + 39;
      totalValue = shipTotals[j];
      if ( totalValue > 0 )
      {
        pane2.x1 += 14 * totalValue / 4;
      }
      v26 = 0;
      shape_number = j + 7;
      do
      {
        VFX_shape_draw(&pane2, shipiconShpTable, shape_number, 0xE * v26++ + 40, 0xE * j + 20);
      }
      while ( v26 < 15 );
    }
    pShipDesignWindow->Unknown_BD = 0;
  }
  sub_2D218(&pShipDesignWindow->a);
}
// 96AD0: using guessed type int V_SelectedHullCellIndex;

//----- (0004EE00) --------------------------------------------------------
int __fastcall Q_Wnd08SW_CalculateShipRefitCost_sub_4EE00(P_Wnd08SW pWnd08SW)
{
  int cost; // ebx
  int gizmosCost; // ecx
  int diff; // ecx

  // Default high cost
  cost = 10000;
  if ( pWnd08SW->Unknown_C9 == 0xFFFFFFFF )
  {
    if ( pWnd08SW->pShip )
    {
      gizmosCost = Q_Ship_GetGizmosCost_sub_4A144(pWnd08SW->pShip);
      diff = gizmosCost - Q_Ship_GetGizmosCost_sub_4A144(&pWnd08SW->Ship);
      // Base cost
      cost = 30;
      if ( diff > 0 )
      {
        return diff + 30;
      }
    }
  }
  return cost;
}

//----- (0004EE50) --------------------------------------------------------
void __fastcall Q_SSystem_StaticCtor_sub_4EE50()
{
  _wcpp_2_mod_register_((RW_DTREG *)&stru_96B08);
  Q_SSystem_Ctor_sub_4EE74(&V_SSystem);
  stru_96B08.state_var = 1;
}

//----- (0004EE74) --------------------------------------------------------
void __fastcall __spoils<> Q_SSystem_Ctor_sub_4EE74(P_SSystem self)
{
  Q_CFile_Ctor_sub_1BB78(&self->cfile);
  self->MDI_installed = 0;
  self->DIG_installed = 0;
  self->AIL_started = 0;
  self->soundEffectsOff = 0;
  self->_notstarted2 = 0;
  self->a = 0;
  self->playing = 0;
  self->musicOff = 0xFFFFFFFF;
  self->mdiFileName[0] = 0;
  self->digFileName[0] = 0;
  self->Unknown_1FE[0] = 0;
  self->mdidrv = 0;
  self->digdrv = 0;
  self->digitalMusicBuf1 = 0;
  self->digitalMusicBuf2 = 0;
  self->smplCnt = 0;
  self->Unknown_CA8 = 0;
  self->Unknown_CAA = 0;
  memset(self->Unknown_BB4, 0, sizeof(self->Unknown_BB4));
  memset(self->Unknown_C68, 0, sizeof(self->Unknown_C68));
  memset(self->files, 0, sizeof(self->files));
  self->tracks = 0;
  self->volume = 0x64;
  self->volume2 = 0x7F;
  self->Unknown_700 = 0;
  self->Unknown_BB2 = 0;
}

//----- (0004EF94) --------------------------------------------------------
T_SSystem *__fastcall Q_SSystem_Dtor_sub_4EF94(T_SSystem *a1)
{
  Q_SSystem_Stop_sub_4FE8C(a1);
  Q_CFile_Dtor_sub_1BBC8(&a1->cfile);
  return a1;
}

//----- (0004EFB0) --------------------------------------------------------
LONG __fastcall Q_SSystem_Start_sub_4EFB0(P_SSystem a1, int aDIG, int aMDI)
{
  LONG result; // eax

  AIL_startup();
  a1->AIL_started = TRUE;
  if ( aDIG == TRUE )
  {
    result = AIL_install_DIG_INI();
    a1->digdrv = (DIG_DRIVER *)result;
    if ( !result )
    {
      return result;
    }
    Q_SSystem_AllocateSamples_sub_4F5E8(a1, 8);
    Q_SSystem_LoadSoundfxTxt_sub_4FF94(a1);
    a1->DIG_installed = TRUE;
  }
  if ( aMDI == TRUE )
  {
    result = AIL_install_MDI_INI();
    a1->mdidrv = (MDI_DRIVER *)result;
    if ( !result )
    {
      return result;
    }
    Q_SSystem_MIDI_sub_4F184(a1, 8);
    a1->MDI_installed = TRUE;
  }
  return TRUE;
}

//----- (0004F028) --------------------------------------------------------
HMDIDRIVER __fastcall sub_4F028(P_SSystem a1, char *a2, char *a3, char *a4, char *a5)
{
  HDIGDRIVER started; // ebp

  AIL_startup();
  started = (HDIGDRIVER)0xFFFFFFFF;
  a1->AIL_started = 0xFFFFFFFF;
  if ( a3 )
  {
    started = Q_SSystem_StartDIG_sub_4F534(a1, a2, a3);
  }
  if ( a4 && a5 && started == (HDIGDRIVER)0xFFFFFFFF )
  {
    return Q_SSystem_MIDI_sub_4F088(a1, a2, a4, a5);
  }
  return (HMDIDRIVER)started;
}
// 4F028: could not find valid save-restore pair for ebx

//----- (0004F088) --------------------------------------------------------
HMDIDRIVER __fastcall Q_SSystem_MIDI_sub_4F088(P_SSystem a1, char *a2, char *a3, char *a4)
{
  HMDIDRIVER result; // eax
  IO_PARMS v7; // [esp+0h] [ebp-24h] BYREF

  strcpy(a1->mdiFileName, a2);
  strcat(a1->mdiFileName, "\\");
  strcat(a1->mdiFileName, a3);
  strcpy(a1->Unknown_1FE, a4);
  AIL_set_GTL_filename_prefix(a1->Unknown_1FE);
  memset(&v7, 0, sizeof(v7));
  v7.IO = 0x240;
  v7.IRQ = 9;
  result = AIL_install_MDI_driver_file(a1->mdiFileName, &v7);
  a1->mdidrv = result;
  if ( result )
  {
    Q_SSystem_MIDI_sub_4F184(a1, 8);
    result = (HMDIDRIVER)0xFFFFFFFF;
    a1->MDI_installed = 0xFFFFFFFF;
  }
  return result;
}

//----- (0004F184) --------------------------------------------------------
void __fastcall Q_SSystem_MIDI_sub_4F184(P_SSystem a1, int a2)
{
  __int16 i; // si
  HSEQUENCE sequence_handle; // edx
  __int16 v5; // kr00_2

  if ( !a1->Unknown_CA8 )
  {
    if ( a2 > 8 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0xDA);
    }
    for ( i = 0; i < a2; ++i )
    {
      sequence_handle = AIL_allocate_sequence_handle(a1->mdidrv);
      v5 = i;
      *(_DWORD *)&a1->Unknown_C68[8 * i] = sequence_handle;
      if ( !sequence_handle )
      {
        break;
      }
      *(_DWORD *)&a1->Unknown_C68[8 * v5 + 4] = 0;
    }
    a1->Unknown_CA8 = i;
  }
}

//----- (0004F32C) --------------------------------------------------------
void __fastcall Q_SSystem_StartSequence_sub_4F32C(P_SSystem a1, __int16 track, int a3)
{
  HSEQUENCE *v4; // [esp+0h] [ebp-14h]

  if ( a1->_notstarted2 != 0xFFFFFFFF && a1->MDI_installed )
  {
    if ( track < 0 || track >= a1->Unknown_CA8 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x12A);
    }
    if ( !*(_DWORD *)&a1->Unknown_C68[8 * track + 4] )
    {
      sprintf("Thank you for playing Ascendancy.", "Attempt play Sequence Track %d with NULL data.\n\n", track);
      Q_debugbreak_exit_sub_2624C();
    }
    v4 = (HSEQUENCE *)((char *)a1 + 8 * track);
    if ( AIL_sequence_status(v4[0x31A]) == 4 )
    {
      if ( a3 != 0xFFFFFFFF )
      {
        return;
      }
      AIL_stop_sequence(v4[0x31A]);
    }
    AIL_start_sequence(*(HSEQUENCE *)&a1->Unknown_C68[8 * track]);
  }
}
// 4F3A4: conditional instruction was optimized away because ecx.4!=0

//----- (0004F45C) --------------------------------------------------------
void __fastcall Q_SSystem_EndSequence_sub_4F45C(P_SSystem a1, __int16 index)
{
  if ( index < 0 || index >= a1->Unknown_CA8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x152);
  }
  if ( *(_DWORD *)&a1->Unknown_C68[8 * index + 4] )
  {
    AIL_end_sequence(*(HSEQUENCE *)&a1->Unknown_C68[8 * index]);
  }
}

//----- (0004F4D4) --------------------------------------------------------
void __fastcall Q_SSystem_MIDI_sub_4F4D4(P_SSystem a1, __int16 a2)
{
  int v2; // eax

  if ( a2 < 0 || a2 >= a1->Unknown_CA8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x166);
  }
  if ( *(_DWORD *)&a1->Unknown_C68[8 * a2 + 4] )
  {
    AIL_end_sequence(*(HSEQUENCE *)&a1->Unknown_C68[8 * a2]);
    if ( *(_DWORD *)(v2 + 8 * a2 + 0xC6C) )
    {
      MEM_free(*(void **)(v2 + 8 * a2 + 0xC6C));
    }
  }
}
// 4F525: variable 'v2' is possibly undefined

//----- (0004F534) --------------------------------------------------------
HDIGDRIVER __fastcall Q_SSystem_StartDIG_sub_4F534(P_SSystem a1, const char *dirName, const char *fileName)
{
  char *digFileName; // edx
  HDIGDRIVER result; // eax
  char *v7; // [esp-4h] [ebp-14h]

  digFileName = a1->digFileName;
  v7 = a1->digFileName;
  strcpy(a1->digFileName, dirName);
  strcat(v7, "\\");
  strcat(v7, fileName);
  result = AIL_install_DIG_driver_file(digFileName, 0);
  a1->digdrv = result;
  if ( result )
  {
    Q_SSystem_AllocateSamples_sub_4F5E8(a1, 8);
    Q_SSystem_LoadSoundfxTxt_sub_4FF94(a1);
    result = (HDIGDRIVER)0xFFFFFFFF;
    a1->DIG_installed = 0xFFFFFFFF;
  }
  return result;
}

//----- (0004F5E8) --------------------------------------------------------
int __fastcall Q_SSystem_AllocateSamples_sub_4F5E8(P_SSystem a1, int a2)
{
  WORD i; // si
  SAMPLE *sample_handle; // eax

  if ( a1->smplCnt )
  {
    return 0;
  }
  if ( a2 > 8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x199);
  }
  for ( i = 0; i < a2; ++i )
  {
    sample_handle = AIL_allocate_sample_handle(a1->digdrv);
    a1->smpl[i] = sample_handle;
    if ( !sample_handle )
    {
      break;
    }
  }
  a1->smplCnt = i;
  return a1->smplCnt;
}

//----- (0004F65C) --------------------------------------------------------
unsigned int __fastcall Q_SSystem_LoadMusic_sub_4F65C(P_SSystem a1, const char *aMusicFName)
{
  SAMPLE *smpl; // esi
  void *pBuf; // eax
  int v7; // edx
  void *digitalMusicBuf1; // ebx
  int v9; // ecx
  int v10; // eax
  __int16 i; // si
  DIG_DRIVER *digdrv; // [esp-Ch] [ebp-80h]
  char fname[80]; // [esp+0h] [ebp-74h] BYREF
  int lines; // [esp+50h] [ebp-24h] BYREF
  int bufSize; // [esp+54h] [ebp-20h]
  T_OpenedFile *files; // [esp+58h] [ebp-1Ch]
  FILE *fp; // [esp+5Ch] [ebp-18h]

  if ( a1->DIG_installed != TRUE )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1B4);
  }
  if ( a1->smplCnt <= 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1B5);
  }
  if ( !a1->DIG_installed || a1->smplCnt < 8 )
  {
    return 0;
  }
  if ( a1->a == 0xFFFFFFFF )
  {
    return 0xFFFFFFFF;
  }
  smpl = a1->smpl[0];
  AIL_init_sample(smpl);
  AIL_set_sample_type(smpl, 0, 0);
  AIL_set_sample_playback_rate(smpl, 22050);
  digdrv = a1->digdrv;
  bufSize = 0xC800;
  if ( AIL_minimum_sample_buffer_size(digdrv, 22050, 0) >= 0xC800 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1C9);
  }
  pBuf = Q_Allocate_sub_2628C(2 * bufSize, 4, "DigitalMusicBuf");
  v7 = bufSize;
  a1->digitalMusicBuf1 = pBuf;
  digitalMusicBuf1 = a1->digitalMusicBuf1;
  a1->digitalMusicBuf2 = (char *)pBuf + v7;
  if ( !digitalMusicBuf1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1D0);
  }
  if ( !a1->digitalMusicBuf1 )
  {
    return 0;
  }
  if ( aMusicFName )
  {
    fp = Q_OpenTextFile_sub_1BB10(aMusicFName, 0);
    if ( !fp )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1DB);
    }
    fscanf(fp, "%d", &lines);
    if ( lines > 0x20 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1E2);
    }
    files = a1->files;
    for ( i = 0; i < lines; ++i )
    {
      fscanf(fp, "%s", fname);
      if ( strlen(fname) >= 0x18 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1E8);
      }
      v9 = i;
      strncpy(files[v9].fname, fname, 0x18u);
      a1->files[v9].fname[0x17] = 0;
      a1->files[v9].fpos = 0;
    }
    a1->tracks = lines;
    fclose(fp);
  }
  a1->a = 0xFFFFFFFF;
  a1->musicOff = 0;
  a1->Unknown_233 = 0;
  v10 = bufSize;
  a1->bufNum = 0;
  a1->z2 = v10;
  return 0xFFFFFFFF;
}
// 4F738: conditional instruction was optimized away because eax.4<C800

//----- (0004F8CC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_4F8CC(P_SSystem a1, __int16 track, int setpos)
{
  MACRO_VFX_BOOL result; // eax
  SAMPLE *v5; // ebp

  if ( a1->musicOff == 0xFFFFFFFF || !a1->DIG_installed )
  {
    return FALSE;
  }
  if ( track < 0 || track >= a1->tracks )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x200);
  }
  if ( a1->current != 0xFFFFFFFF )
  {
    a1->files[a1->current].fpos = Q_CFile_GetPos_sub_1BEA0(&a1->cfile);
  }
  Q_SSystem_StopSample_sub_4FA1C(a1);
  v5 = a1->smpl[0];
  AIL_init_sample(v5);
  AIL_set_sample_type(v5, 0, 0);
  AIL_set_sample_playback_rate(v5, 22050);
  Q_SSystem_SetVolume_sub_4FF4C(a1, a1->volume);
  if ( Q_CFile_Open_sub_1BBFC(&a1->cfile, a1->files[track].fname, O_BINARY, 0) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x214);
  }
  if ( setpos == TRUE )
  {
    Q_CFile_SetPos_sub_1BF0C(&a1->cfile, a1->files[track].fpos);
  }
  a1->playing = TRUE;
  result = TRUE;
  a1->current = track;
  return result;
}

//----- (0004FA1C) --------------------------------------------------------
void __fastcall Q_SSystem_StopSample_sub_4FA1C(P_SSystem a1)
{
  SAMPLE *v2; // [esp-10h] [ebp-14h]

  if ( a1->playing == TRUE )
  {
    v2 = a1->smpl[0];
    a1->playing = FALSE;
    AIL_stop_sample(v2);
    a1->files[a1->current].fpos = Q_CFile_GetPos_sub_1BEA0(&a1->cfile);
  }
}

//----- (0004FAB4) --------------------------------------------------------
void __fastcall Q_SSystem_PlayMusic_sub_4FAB4(P_SSystem pSSystem)
{
  SAMPLE *hSmp; // edi
  LONG iNeed; // eax
  signed int readLen; // ebx
  int bytesRead; // eax
  ULONG smpLen; // edx

  if ( pSSystem->musicOff != TRUE && pSSystem->DIG_installed )
  {
    hSmp = pSSystem->smpl[0];
    // Check if the buffer needs new data
    iNeed = AIL_sample_buffer_ready(hSmp);
    if ( iNeed != 0xFFFFFFFF )
    {
      pSSystem->Unknown_233 = 0;
      pSSystem->bufNum = iNeed;
    }
    // Calculate how much data to read
    readLen = pSSystem->z2 - pSSystem->Unknown_233;
    if ( readLen > 5120 )
    {
      readLen = 5120;
    }
    if ( readLen )
    {
      // Read audio data from file
      bytesRead = Q_CFile_Read_sub_1BF94(
                    &pSSystem->cfile,
                    (void *)(pSSystem->Unknown_233 + *((_DWORD *)&pSSystem->digitalMusicBuf1 + pSSystem->bufNum)),
                    readLen);
      smpLen = bytesRead + pSSystem->Unknown_233;
      pSSystem->Unknown_233 = smpLen;
      if ( bytesRead )
      {
        // Feeds the new data into AIL
        AIL_load_sample_buffer(hSmp, pSSystem->bufNum, *(&pSSystem->digitalMusicBuf1 + pSSystem->bufNum), smpLen);
      }
      else
      {
        sub_1BECC(&pSSystem->cfile, 0, 0);
        Q_SSystem_StopSample_sub_4FA1C(pSSystem);
      }
    }
  }
}

//----- (0004FB90) --------------------------------------------------------
void __fastcall Q_SSystem_StartSample_sub_4FB90(P_SSystem a1, __int16 a2)
{
  SAMPLE *v2; // esi
  char *Unknown_BB4; // kr08_4
  int i; // kr04_4
  int j; // edx
  char *v6; // [esp+0h] [ebp-1Ch]

  if ( a1->soundEffectsOff != 0xFFFFFFFF )
  {
    if ( a1->DIG_installed )
    {
      v6 = sub_50140(a1, a2);
      if ( v6 )
      {
        for ( i = 0; i + 1 < a1->smplCnt; ++i )
        {
          v2 = a1->smpl[i + 1];
          if ( AIL_sample_status(v2) != 4 )
          {
            AIL_init_sample(v2);
            AIL_set_sample_type(v2, *((__int16 *)v6 + 8), 0);
            AIL_set_sample_address(v2, *((void **)v6 + 2), *((_DWORD *)v6 + 3));
            AIL_set_sample_playback_rate(v2, *((__int16 *)v6 + 9));
            AIL_set_sample_volume(v2, a1->volume2);
            AIL_set_sample_loop_count(v2, 1);
            AIL_start_sample(v2);
            *(_DWORD *)v6 = v2;
            Unknown_BB4 = a1->Unknown_BB4;
            for ( j = 0; j < 6; ++j )
            {
              if ( &Unknown_BB4[0x16 * j] != v6 && v2 == *(SAMPLE **)&Unknown_BB4[0x16 * j] )
              {
                *(_DWORD *)&Unknown_BB4[0x16 * j] = 0;
              }
            }
            return;
          }
        }
      }
    }
  }
}

//----- (0004FE8C) --------------------------------------------------------
void __fastcall Q_SSystem_Stop_sub_4FE8C(P_SSystem a1)
{
  __int16 i; // bx
  int j; // ebp

  if ( a1->AIL_started == 0xFFFFFFFF )
  {
    for ( i = 0; i < a1->Unknown_CA8; ++i )
    {
      Q_SSystem_MIDI_sub_4F4D4(a1, i);
    }
    for ( j = 0; j < a1->smplCnt; ++j )
    {
      AIL_stop_sample(a1->smpl[j]);
    }
    Q_RemoveWinDataFromWinMgr_sub_262CC(*(void **)&a1->Unknown_BB4[4]);
    AIL_shutdown();
    a1->AIL_started = 0;
  }
}

//----- (0004FF08) --------------------------------------------------------
void __fastcall Q_SSystem_SetNoSound_sub_4FF08(P_SSystem a1)
{
  sub_4FF1C(a1);
  sub_4FF28(a1);
}

//----- (0004FF1C) --------------------------------------------------------
void __fastcall sub_4FF1C(P_SSystem a1)
{
  a1->_notstarted2 = TRUE;
}

//----- (0004FF28) --------------------------------------------------------
void __fastcall sub_4FF28(P_SSystem a1)
{
  a1->soundEffectsOff = TRUE;
}

//----- (0004FF4C) --------------------------------------------------------
void __fastcall Q_SSystem_SetVolume_sub_4FF4C(P_SSystem a1, char newVolume)
{
  if ( newVolume >= 0 )
  {
    a1->volume = newVolume;
  }
  AIL_set_sample_volume(a1->smpl[0], a1->volume);
}

//----- (0004FF94) --------------------------------------------------------
int __fastcall Q_SSystem_LoadSoundfxTxt_sub_4FF94(P_SSystem a1)
{
  int v2; // esi
  FILE *fp; // ebp
  char *sub_2628C; // eax
  P_SSystem v5; // kr28_4
  char *v6; // ecx
  P_SSystem v7; // kr08_4
  char *Unknown_BB4; // kr18_4
  int v9; // kr2C_4
  P_SSystem v10; // edx
  P_SSystem v11; // kr20_4
  P_SSystem v12; // esi
  __int16 *Unknown_702; // kr10_4
  int i; // edi
  int j; // ebx
  int k; // edx
  int bufi1; // [esp+0h] [ebp-28h] BYREF
  int bufi2; // [esp+4h] [ebp-24h] BYREF
  P_SSystem v20; // [esp+8h] [ebp-20h]
  int v21; // [esp+Ch] [ebp-1Ch]

  v20 = a1;
  v2 = 0;
  fp = Q_OpenTextFile_sub_1BB10("soundfx.txt", 0);
  v21 = 0;
  // 2 10000
  // 3 45000
  // 1 65000
  for ( i = 0; i < 3; ++i )
  {
    fscanf(fp, "%d %d", &bufi1, &bufi2);
    a1->Unknown_C50[i] = v2;
    a1->Unknown_C5C[i] = v2 + bufi1 - 1;
    a1->Unknown_C44[i] = bufi2;
    v21 += bufi2 * bufi1;
    if ( i > 0 && a1->Unknown_C44[i] < a1->Unknown_C38[i + 2] )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x347);
    }
    v2 += bufi1;
  }
  if ( v2 != 6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x34D);
  }
  sub_2628C = (char *)Q_Allocate_sub_2628C(v21, 1, "SFX CACHE");
  v5 = v20;
  v6 = sub_2628C;
  v7 = v20;
  Unknown_BB4 = v20->Unknown_BB4;
  v9 = 0;
  for ( j = 0; j < 6; ++j )
  {
    *(_DWORD *)&Unknown_BB4[0x16 * j] = 0;
    *(_WORD *)&Unknown_BB4[0x16 * j + 0x10] = 0;
    *(_WORD *)&Unknown_BB4[0x16 * j + 0x12] = 0x5622;
    *(_WORD *)&Unknown_BB4[0x16 * j + 0x14] = 0xFFFF;
    if ( j > v5->Unknown_C5C[v9] )
    {
      ++v9;
    }
    *(_DWORD *)&v7->Unknown_BB4[0x16 * j + 4] = v6;
    v6 += v5->Unknown_C44[v9];
  }
  fscanf(fp, "%d", &bufi1);
  v10 = v20;
  v20->Unknown_700 = bufi1;
  if ( (unsigned __int16)v10->Unknown_700 >= 0x64u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x369);
  }
  v11 = v20;
  v12 = v20;
  Unknown_702 = v20->Unknown_702;
  for ( k = 0; k < (unsigned __int16)v12->Unknown_700; ++k )
  {
    fscanf(fp, "%s", &Unknown_702[5 * k]);
    v11->Unknown_702[k + 0x1F4] = 0xFFFF;
  }
  return fclose(fp);
}

//----- (00050140) --------------------------------------------------------
char *__fastcall sub_50140(P_SSystem a1, __int16 a2)
{
  int v4; // edx
  P_SSystem v5; // kr00_4
  int v6; // kr40_4
  int v7; // edi
  int v8; // ecx
  unsigned int v9; // edx
  int v10; // kr18_4
  int v11; // edi
  int v12; // ebp
  int v13; // kr38_4
  unsigned __int16 Unknown_BB2; // di
  char *v15; // edx
  int n; // kr0C_4
  int k; // kr34_4
  int m; // eax
  int v19; // kr1C_4
  int i; // ebp
  int j; // eax
  T_CFile v22; // [esp+0h] [ebp-178h] BYREF
  char s[52]; // [esp+118h] [ebp-60h] BYREF
  int v24; // [esp+14Ch] [ebp-2Ch]
  char *v25; // [esp+150h] [ebp-28h]
  unsigned int v26; // [esp+154h] [ebp-24h]
  int Length_sub_1BE28; // [esp+158h] [ebp-20h]
  P_SSystem v28; // [esp+15Ch] [ebp-1Ch]
  int v29; // [esp+160h] [ebp-18h]

  LOWORD(v29) = a2;
  if ( a1->soundEffectsOff == TRUE || !a1->DIG_installed )
  {
    return 0;
  }
  if ( (v29 & 0x8000u) != 0 || (__int16)v29 >= (int)(unsigned __int16)a1->Unknown_700 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x37B);
  }
  v25 = 0;
  if ( (v29 & 0x8000u) != 0 || (__int16)v29 >= (int)(unsigned __int16)a1->Unknown_700 )
  {
    return v25;
  }
  v4 = a1->Unknown_702[(__int16)v29 + 0x1F4];
  if ( v4 == 0xFFFFFFFF )
  {
    sprintf(s, "data\\%s.voc", (const char *)&a1->Unknown_702[5 * (__int16)v29]);
    Q_CFile_Ctor_sub_1BB78(&v22);
    Q_CFile_Open_sub_1BBFC(&v22, s, 0x200, 0);
    v9 = 0;
    Length_sub_1BE28 = Q_CFile_GetLength_sub_1BE28(&v22);
    v8 = 0;
    while ( Length_sub_1BE28 >= a1->Unknown_C44[v8] )
    {
      if ( ++v8 >= 3 )
      {
        goto LABEL_23;
      }
    }
    v9 = 0xFFFFFFFF;
LABEL_23:
    if ( v9 != 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x3AD);
    }
    v10 = a1->Unknown_C50[v8];
    v24 = 0xFFFFFFFF;
    v19 = 0;
    if ( v10 <= a1->Unknown_C5C[v8] )
    {
      while ( *(__int16 *)&a1->Unknown_BB4[0x16 * v10 + 0x14 + 0x16 * v19] != 0xFFFFFFFF )
      {
        ++v19;
        if ( v10 + v19 > a1->Unknown_C5C[v8] )
        {
          goto LABEL_30;
        }
      }
      v24 = v10 + v19;
    }
LABEL_30:
    if ( v24 == 0xFFFFFFFF )
    {
      v28 = a1;
      v26 = 4 * v8;
      for ( i = 0; i < (unsigned __int16)a1->Unknown_BB2; ++i )
      {
        v11 = a1->Unknown_702[*((unsigned __int16 *)a1->Unknown_C38 + i) + 0x1F4];
        if ( v11 >= a1->Unknown_C50[v26 / 4]
          && v11 <= a1->Unknown_C5C[v26 / 4]
          && (!*(_DWORD *)&a1->Unknown_BB4[0x16 * v11] || AIL_sample_status(*(HSAMPLE *)&a1->Unknown_BB4[0x16 * v11]) != 4) )
        {
          v24 = v11;
          break;
        }
      }
    }
    if ( v24 != 0xFFFFFFFF )
    {
      v12 = *(__int16 *)&a1->Unknown_BB4[0x16 * v24 + 0x14];
      v25 = &a1->Unknown_BB4[0x16 * v24];
      if ( v12 != 0xFFFFFFFF )
      {
        for ( j = 0; j < (unsigned __int16)a1->Unknown_BB2 && *((unsigned __int16 *)a1->Unknown_C38 + j) != v12; ++j )
        {
          ;
        }
        v13 = j;
        for ( k = 0; ; ++k )
        {
          Unknown_BB2 = a1->Unknown_BB2;
          if ( j >= Unknown_BB2 )
          {
            break;
          }
          ++j;
          *((_WORD *)a1->Unknown_C38 + v13 + k) = *((_WORD *)a1->Unknown_C38 + v13 + k + 1);
        }
        a1->Unknown_BB2 = Unknown_BB2 - 1;
        a1->Unknown_702[v12 + 0x1F4] = 0xFFFF;
      }
      Q_CFile_Load_sub_1BF1C(&v22, *((void **)v25 + 1));
      v15 = v25;
      *((_DWORD *)v25 + 2) = *((_DWORD *)v25 + 1) + 0x2A;
      *((_DWORD *)v15 + 3) = Length_sub_1BE28 - 0x2B;
      *((_WORD *)v15 + 0xA) = v29;
      a1->Unknown_702[(__int16)v29 + 0x1F4] = v24;
      LOWORD(v15) = a1->Unknown_BB2;
      a1->Unknown_BB2 = (_WORD)v15 + 1;
      *((_WORD *)a1->Unknown_C38 + (unsigned __int16)v15) = v29;
    }
    Q_CFile_Dtor_sub_1BBC8(&v22);
    return v25;
  }
  v5 = a1;
  v25 = &a1->Unknown_BB4[0x16 * v4];
  for ( m = 0; m < (unsigned __int16)a1->Unknown_BB2 && *((unsigned __int16 *)v5->Unknown_C38 + m) != (__int16)v29; ++m )
  {
    ;
  }
  v6 = m;
  for ( n = 0; ; ++n )
  {
    v7 = (unsigned __int16)a1->Unknown_BB2;
    if ( m >= (unsigned __int16)v7 )
    {
      break;
    }
    ++m;
    *((_WORD *)a1->Unknown_C38 + v6 + n) = *((_WORD *)a1->Unknown_C38 + v6 + n + 1);
  }
  *(_WORD *)&a1->Unknown_BB4[2 * v7 + 0x82] = v29;
  return v25;
}

//----- (00050530) --------------------------------------------------------
UWORD __fastcall sub_50530(T_Type5 *a1, P_Planet pPlanet, int a3, int a4)
{
  T_Star *v6; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v8; // ecx
  int planetsRacesBits; // edi
  char *name; // ecx
  int v11; // edx
  char *sub_1CEA8; // eax
  LONG *p_x0; // esi
  int Unknown_5A; // ebx
  PANE *v15; // esi
  WORD v16; // cx
  char *v17; // eax
  int DaysToCompleteItem_sub_358BC; // edx
  char *v19; // esi
  int v20; // eax
  char *v21; // eax
  char *v22; // eax
  char *v23; // eax
  UWORD v24; // di
  int v25; // kr04_4
  int SquareWithItem_sub_35930; // eax
  void *v27; // eax
  void *v28; // eax
  int v29; // eax
  void *v30; // eax
  int v31; // eax
  void *v32; // eax
  LONG v33; // edi
  int v34; // eax
  int v35; // kr0C_4
  UWORD result; // ax
  void *v37; // eax
  int i; // esi
  int j; // esi
  LONG v40; // [esp-10h] [ebp-F4h]
  LONG v41; // [esp-10h] [ebp-F4h]
  LONG v42; // [esp-10h] [ebp-F4h]
  LONG v43; // [esp-10h] [ebp-F4h]
  WORD x_4a; // [esp+4h] [ebp-E0h]
  LONG x_4c; // [esp+4h] [ebp-E0h]
  char *v46; // [esp+8h] [ebp-DCh]
  char *v47; // [esp+8h] [ebp-DCh]
  char *v48; // [esp+Ch] [ebp-D8h]
  char *v49; // [esp+Ch] [ebp-D8h]
  char s[100]; // [esp+10h] [ebp-D4h] BYREF
  char v51[60]; // [esp+74h] [ebp-70h] BYREF
  LONG v52; // [esp+B0h] [ebp-34h]
  LONG hotY; // [esp+B4h] [ebp-30h]
  int v54; // [esp+B8h] [ebp-2Ch]
  int v55; // [esp+BCh] [ebp-28h]
  PANE *pane; // [esp+C0h] [ebp-24h]
  int v57; // [esp+C4h] [ebp-20h]
  char *string; // [esp+C8h] [ebp-1Ch]
  char a2[4]; // [esp+CCh] [ebp-18h]
  int v60; // [esp+D0h] [ebp-14h]
  LONG shape_number; // [esp+D4h] [ebp-10h]

  pane = (PANE *)a1;
  v6 = &V_Game.stars[pPlanet->starIndex];
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, word_96B2A);
  if ( !ShapeTable_sub_1B084 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x41);
  }
  VFX_shape_draw(pane, ShapeTable_sub_1B084, v6->type, 0x4B, 0x4B);
  v8 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, word_96B2C);
  if ( !v8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x45);
  }
  VFX_shape_draw(pane, v8, pPlanet->size + 5 * pPlanet->type, 0xC8, 0x4B);
  v57 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  v54 = v57;
  if ( a4 )
  {
    if ( V_Mouse.x >= 0x96 )
    {
      v57 = 0xF3;
    }
    else
    {
      v54 = 0xF3;
    }
  }
  planetsRacesBits = v6->planetsRacesBits;
  if ( planetsRacesBits == 1 << V_PlayerRaceIndex
    || v6 == V_Game.races[V_PlayerRaceIndex].homeStar && ((1 << V_PlayerRaceIndex) & planetsRacesBits) != 0 )
  {
    Q_DrawRaceFlagTinted_sub_53E38(pane, 4, 0xA, V_PlayerRaceIndex);
  }
  name = V_Game.stars[pPlanet->starIndex].name;
  WinMgr.SmallFont.pane = *pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x78, 0x12, name, 0, v54, 0xFF, 0);
  string = pPlanet->name;
  v55 = (__int16)v57;
  WinMgr.LargeFont.pane = *pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x113, 0xF, pPlanet->name, 0, v57, 0xFF, 0);
  v11 = Q_Font_GetTextWidth_sub_2B4F4(&WinMgr.LargeFont, pPlanet->name) + 0x127;
  v48 = PlanetTypeTexts[pPlanet->type];
  v46 = PlanetSizeTexts[pPlanet->size];
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x88);// 136: "(%s %s Planet)"
  sprintf(s, sub_1CEA8, v46, v48);
  x_4a = v55;
  WinMgr.SmallFont.pane.window = pane->window;
  p_x0 = &pane->x0;
  WinMgr.SmallFont.pane.x0 = pane->x0;
  WinMgr.SmallFont.pane.y0 = *++p_x0;
  WinMgr.SmallFont.pane.x1 = *++p_x0;
  WinMgr.SmallFont.pane.y1 = p_x0[1];
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, v11, 0x10, s, 0, x_4a, 0xFF, 0);
  Unknown_5A = pPlanet->Unknown_5A;
  v52 = 0x1E;
  if ( Unknown_5A == 0xFFFFFFFF )
  {
    v15 = pane;
    v16 = v55;
    v17 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x89);    // 137: "Self-Managed"
    WinMgr.SmallFont.pane.window = v15->window;
    v15 = (PANE *)((char *)v15 + 4);
    WinMgr.SmallFont.pane.x0 = (LONG)v15->window;
    v15 = (PANE *)((char *)v15 + 4);
    WinMgr.SmallFont.pane.y0 = (LONG)v15->window;
    v15 = (PANE *)((char *)v15 + 4);
    WinMgr.SmallFont.pane.x1 = (LONG)v15->window;
    WinMgr.SmallFont.pane.y1 = v15->x0;
    v52 = 0x27;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x113, 0x1E, v17, 0, v16, 0xFF, 0);
  }
  if ( pPlanet->buildingPlanetItemIndex == 0xFF )
  {
    v23 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8D);    // 141: "No Project"
    strcpy(s, v23);
    if ( pPlanet->population == pPlanet->usedPopulation )
    {
      strcat(s, Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8E));// 142: "   (No Free Population)"
    }
    v57 = 0xF3;
  }
  else
  {
    qmemcpy(v51, &unk_96B30, sizeof(v51));
    if ( (V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].flags & 2) == 0 )
    {
      DaysToCompleteItem_sub_358BC = (unsigned __int16)Q_Planet_GetDaysToCompleteItem_sub_358BC(pPlanet);
      if ( (unsigned __int16)DaysToCompleteItem_sub_358BC == 0xFFFF )
      {
        v19 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8A);// 138: " - No Progress"
        strcpy(v51, v19);
      }
      else
      {
        if ( DaysToCompleteItem_sub_358BC == 1 )
        {
          v20 = 0x1C;                                  // 28: ""
        }
        else
        {
          v20 = 0x1D;                                  // 29: "s"
        }
        v49 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v20);
        v21 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8B);// 139: " - %d day%s until completion"
        sprintf(v51, v21, DaysToCompleteItem_sub_358BC, v49);
      }
    }
    v47 = V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].name;
    v22 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8C);    // 140: "Building %s%s"
    sprintf(s, v22, v47, v51);
  }
  WinMgr.SmallFont.pane = *pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x113, v52, s, 0, v57, 0xFF, 0);
  v52 = 0x19;
  v24 = GwshareShpCacheIndexes[0x1E];
  *(_DWORD *)a2 = (unsigned __int16)word_96B6C;
  v25 = 0;
  for ( i = 0; i < 2; ++i )
  {
    SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, a2[i]);
    if ( SquareWithItem_sub_35930 != 0xFFFF )
    {
      SquareWithItem_sub_35930 = pPlanet->pSquares[SquareWithItem_sub_35930].flags & 1;
      if ( SquareWithItem_sub_35930 )
      {
        v40 = (unsigned __int8)a2[i];
        v27 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v24);
        VFX_shape_transform(pane, v27, v40, 0xF5, 0x19 * v25++ + 0x19, V_BigBuffer, 0, 0x4000, 0x4000, 0);
      }
    }
  }
  LOWORD(SquareWithItem_sub_35930) = GwshareShpCacheIndexes[0x26];
  v60 = SquareWithItem_sub_35930;
  string = (char *)pPlanet->research;
  string = (char *)(int)pow((double)(int)string, 0.75);
  shape_number = (LONG)string;
  if ( (unsigned __int16)string > 0x14u )
  {
    shape_number = 0x14;
  }
  v41 = (unsigned __int16)shape_number;
  v28 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v60);
  VFX_shape_transform(pane, v28, v41, 0x118, 0x3C, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  LOWORD(v29) = GwshareShpCacheIndexes[0x27];
  v60 = v29;
  string = (char *)pPlanet->industry;
  string = (char *)(int)pow((double)(int)string, 0.75);
  shape_number = (LONG)string;
  if ( (unsigned __int16)string > 0x14u )
  {
    shape_number = 0x14;
  }
  v42 = (unsigned __int16)shape_number;
  v30 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v60);
  VFX_shape_transform(pane, v30, v42, 0x15E, 0x3C, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  LOWORD(v31) = GwshareShpCacheIndexes[0x28];
  v60 = v31;
  LOWORD(v31) = pPlanet->prosperity;
  shape_number = v31;
  if ( (unsigned __int16)v31 > 0x14u )
  {
    shape_number = 0x14;
  }
  v43 = (unsigned __int16)shape_number;
  v32 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v60);
  v33 = 0x1EA;
  VFX_shape_transform(pane, v32, v43, 0x1A4, 0x3C, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  LOWORD(v34) = GwshareShpCacheIndexes[0x2C];
  hotY = 0x3C;
  v60 = v34;
  shape_number = 6;
  v35 = 0;
  for ( j = 0; ; ++j )
  {
    result = pPlanet->maximumPopulation;
    if ( j >= result )
    {
      break;
    }
    if ( j == pPlanet->usedPopulation )
    {
      shape_number = 7;
    }
    if ( j == pPlanet->population )
    {
      shape_number = 8;
    }
    x_4c = (unsigned __int16)shape_number;
    v37 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v60);
    VFX_shape_draw(pane, v37, x_4c, v33, 5 * v35 + 0x3C);
    v33 += 5;
    if ( j % 0xA == 9 )
    {
      v33 = 0x1EA;
      ++v35;
    }
  }
  return result;
}
/* Orphan comments:
141: "No Project"
142: "   (No Free Population)"
*/
// 50A78: variable 'SquareWithItem_sub_35930' is possibly undefined
// 50B38: variable 'v29' is possibly undefined
// 50BF8: variable 'v31' is possibly undefined
// 50C99: variable 'v34' is possibly undefined
// 96B6C: using guessed type __int16 word_96B6C;
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 50530: using guessed type char s[100];
// 50530: using guessed type char var_70[60];

//----- (00050D70) --------------------------------------------------------
void __fastcall sub_50D70(PPANE pPANE, P_Ship pShip, int a3, int a4)
{
  void *smshipShape; // eax
  P_Planet pvPlanet3; // esi
  char *v7; // eax
  void *v8; // eax
  P_Star vpStar; // ecx
  char *v10; // eax
  void *v11; // eax
  P_Lane pLane; // edx
  P_Star pStar2; // esi
  P_Star pStar1; // eax
  P_Ship v15; // ebx
  double v16; // st7
  char flags; // ah
  char *name; // edi
  int etaDays; // esi
  P_Star destStar; // eax
  int v21; // eax
  char *v22; // eax
  P_Planet pvPlanet1; // esi
  char *sub_1CEA8; // eax
  void *ShapeTable_sub_1B084; // eax
  P_Planet pvPlanet2; // esi
  char *v27; // eax
  void *v28; // eax
  BYTE order; // bh
  P_Ship v30; // edx
  char *v31; // eax
  int tmp; // eax
  void *shpTable; // eax
  int v34; // edi
  int v35; // edi
  void *v36; // eax
  int fullHullIntegrity; // eax
  int v38; // ebx
  void *v39; // eax
  int i; // esi
  int j; // kr10_4
  int k; // kr20_4
  __int16 m; // si
  LONG v44; // [esp-4h] [ebp-174h]
  LONG v45; // [esp-4h] [ebp-174h]
  char *v46; // [esp+4h] [ebp-16Ch]
  WORD raceIndex; // [esp+4h] [ebp-16Ch]
  LONG hotY_1; // [esp+4h] [ebp-16Ch]
  char s[200]; // [esp+8h] [ebp-168h] BYREF
  PANE pane; // [esp+D0h] [ebp-A0h] BYREF
  int shipIcons[5]; // [esp+E4h] [ebp-8Ch]
  T_Vector3D v52; // [esp+F8h] [ebp-78h] BYREF
  T_Vector3D v53; // [esp+104h] [ebp-6Ch] BYREF
  LONG v54[2]; // [esp+110h] [ebp-60h]
  int v55[2]; // [esp+118h] [ebp-58h]
  int v56[2]; // [esp+120h] [ebp-50h]
  T_Vector3D *v57; // [esp+128h] [ebp-48h]
  int v58; // [esp+12Ch] [ebp-44h]
  float laneDistance; // [esp+130h] [ebp-40h]
  float travelSpeed; // [esp+134h] [ebp-3Ch]
  int shipRank; // [esp+138h] [ebp-38h]
  P_Ship vpShip; // [esp+13Ch] [ebp-34h]
  int v63; // [esp+140h] [ebp-30h]
  LONG x1; // [esp+144h] [ebp-2Ch]
  int v65; // [esp+148h] [ebp-28h]
  int v66; // [esp+14Ch] [ebp-24h]
  LONG shape_number; // [esp+150h] [ebp-20h]
  LONG hotY; // [esp+154h] [ebp-1Ch]
  unsigned int v69; // [esp+158h] [ebp-18h]
  int v70; // [esp+15Ch] [ebp-14h]
  int index; // [esp+160h] [ebp-10h]

  vpShip = pShip;
  smshipShape = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, smshipShpCacheIndex);
  VFX_shape_draw(pPANE, smshipShape, pShip->hullSize, 65, 50);
  v70 = 4 * V_Game.races[V_PlayerRaceIndex].colorSet + 0x13;
  if ( a4 )
  {
    v70 = 243;
  }
  switch ( vpShip->locationType )
  {
    case ASCEND_LOCATION_TYPE_SHIPYARD:
      pvPlanet1 = vpShip->pLocation.pPlanet;
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x93);// 147: "Under Construction at %s"
      sprintf(s, sub_1CEA8, pvPlanet1->name);
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planetsShpCacheIndex);
      VFX_shape_draw(pPANE, ShapeTable_sub_1B084, pvPlanet1->size + 5 * pvPlanet1->type, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_SHIPDOCK:
      pvPlanet2 = vpShip->pLocation.pPlanet;
      v27 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x94);  // 148: "Being Refitted at %s"
      sprintf(s, v27, pvPlanet2->name);
      v28 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planetsShpCacheIndex);
      VFX_shape_draw(pPANE, v28, 5 * pvPlanet2->type + pvPlanet2->size, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_ORBIT:
      pvPlanet3 = vpShip->pLocation.pPlanet;
      v7 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8F);   // 143: "Orbiting %s"
      sprintf(s, v7, pvPlanet3->name);
      v8 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planetsShpCacheIndex);
      VFX_shape_draw(pPANE, v8, pvPlanet3->size + 5 * pvPlanet3->type, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_SYSTEM:
      vpStar = vpShip->pLocation.pStar;
      v10 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x90);  // 144: "in %s System"
      sprintf(s, v10, vpStar->name);
      v11 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, sunsShpCacheIndex);
      VFX_shape_draw(pPANE, v11, vpStar->type, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_STARLANE:
      pLane = vpShip->pLocation.pLane;
      pStar2 = pLane->pStar2;
      pStar1 = pLane->pStar1;
      v57 = &v52;
      memset(&v53, 0, sizeof(v53));
      v53.x = pStar1->position.x - pStar2->position.x;
      v53.y = pStar1->position.y - pStar2->position.y;
      v53.z = pStar1->position.z - pStar2->position.z;
      v52 = v53;
      v15 = vpShip;
      v16 = sqrt(v53.y * v53.y + v53.x * v53.x + v53.z * v53.z);
      v58 = v15->totalStarLaneHyperdrivePotential + vpShip->totalStarLaneDrivePotential;
      laneDistance = v16;
      flags = pLane->flags;
      travelSpeed = (float)v58;
      if ( (flags & 1) != 0 )
      {
        // Red lanes
        travelSpeed = travelSpeed * 0.33333334;
      }
      if ( V_Game.races[vpShip->raceIndex].ability == ASCEND_SA_FAST_LANE_TRAVEL )
      {
        if ( travelSpeed < 1.0 )
        {
          travelSpeed = 1.0;
        }
        travelSpeed = travelSpeed * 2.0;
      }
      v58 = (int)((laneDistance - vpShip->position.x) / travelSpeed);
      name = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x91); // 145: "Unknown"
      etaDays = v58 + 1;
      if ( vpShip->position.y )
      {
        destStar = pLane->pStar2;
      }
      else
      {
        destStar = pLane->pStar1;
      }
      if ( ((1 << V_PlayerRaceIndex) & destStar->exploredBits) != 0 )
      {
        name = destStar->name;
      }
      if ( v58 )
      {
        v21 = 0x1D;                                    // 29: "s"
      }
      else
      {
        v21 = 0x1C;                                    // 28: ""
      }
      v46 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v21);
      v22 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x92);  // 146: "In Starlane to %s System\nETA - %d Day%s"
      sprintf(s, v22, name, etaDays, v46);
      break;
    default:
      sprintf(s, "Bad m_LocationType");
      break;
  }
  order = vpShip->order;
  if ( order && order != 7 && vpShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
  {
    v30 = vpShip;
    v31 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x95);    // 149: "\nMoving to Planet"
    if ( v30->order == 1 )
    {
      v31 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x96);  // 150: "\nMoving to Starlane"
    }
    strcat(s, v31);
  }
  v58 = (__int16)v70;
  WinMgr.SmallFont.pane = *pPANE;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x17C, 5, s, 0, v70, 0xFF, 0x8E);
  sprintf(s, "%s", vpShip->name);
  WinMgr.LargeFont.pane = *pPANE;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x96, 5, s, 0, v58, 0xFF, 0);
  shipRank = Q_Ship_GetRank_sub_4A8CC(vpShip);
  for ( i = 0; i < 9; ++i )
  {
    if ( i >= shipRank )
    {
      break;
    }
    raceIndex = vpShip->raceIndex;
    // data\shipicon.shp
    shpTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x23]);
    Q_DrawRaceTintedShape_sub_53EB8(pPANE, shpTable, 6, 9 * i + 259, 6, raceIndex);
  }
  shipIcons[0] = vpShip->totalWeaponDamage;
  shipIcons[1] = vpShip->totalShieldStrength;
  shipIcons[2] = vpShip->totalDriveMaxDistance;
  shipIcons[3] = vpShip->totalScannerRangePerTurn;
  tmp = vpShip->totalGeneratorPower;
  hotY = 25;
  shipIcons[4] = tmp;
  v65 = 0;
  pane = *pPANE;
  // data\shipicon.shp
  LOWORD(tmp) = GwshareShpCacheIndexes[0x23];
  index = tmp;
  v63 = 7;
  for ( j = 0; j != 5; ++j )
  {
    pane.x1 = pane.x0 + 149;
    v34 = shipIcons[j];
    if ( v34 > 0 )
    {
      pane.x1 += 0xE * v34 / 4;
    }
    v35 = 0;
    shape_number = j + 7;
    do
    {
      v44 = shape_number;
      v36 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index);
      VFX_shape_draw(&pane, v36, v44, 0xE * v35++ + 0x96, 0xE * j + 25);
    }
    while ( v35 < 14 );
  }
  v56[0] = vpShip->hullIntegrity;
  v56[1] = vpShip->availablePower;
  fullHullIntegrity = vpShip->fullHullIntegrity;
  v66 = 0;
  v55[0] = fullHullIntegrity;
  x1 = 0x16B;
  v55[1] = Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(vpShip);
  v54[1] = 11;
  v54[0] = 8;
  for ( k = 0; k != 2; ++k )
  {
    if ( v55[k] > 0 )
    {
      if ( v56[k] >= 0 )
      {
        v38 = v55[k];
        if ( v56[k] > v38 )
        {
          v56[k] = v38;
        }
      }
      else
      {
        v56[k] = 0;
      }
      v69 = 4 * k;
      for ( m = 0; m < 7; ++m )
      {
        hotY_1 = 14 * m + 5;
        v45 = v54[v69 / 4];
        v39 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index);
        VFX_shape_draw(pPANE, v39, v45, 0xE * k + 0x15E, hotY_1);
      }
      Q_Pane_CopyOrDrawRectangle_sub_2BB74(
        pPANE,
        0xE * k + 0x15E,
        4,
        0xE * k + 0x16B,
        0x66 - 0x62 * v56[v69 / 4] / v55[v69 / 4],
        0,
        0xFFFFFFFF);
    }
  }
}
/* Orphan comments:
Check travel direction
*/
// 50D70: using guessed type char s[200];

//----- (00051610) --------------------------------------------------------
void __fastcall sub_51610(PPANE pPane, LONG shapeNumber, int a3, BOOL bWipe)
{
  void *smraces; // eax
  void *racering; // eax

  if ( bWipe == TRUE )
  {
    VFX_pane_wipe(pPane, 0x96);
  }
  smraces = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);
  VFX_shape_draw(pPane, smraces, shapeNumber, 56, 55);
  racering = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x21]);
  VFX_shape_draw(pPane, racering, 7, 56, 55);
}

//----- (00051674) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd16SW_Ctor_sub_51674(P_Wnd16SW a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a.a);
  a1->a.a.pProcs = &Wnd16SW_Procs;
  Q_A11_sub_516D4(&a1->a);
}

//----- (00051690) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd16SW_Dtor_sub_51690(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd16SW);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = &Wnd16SW_Procs;
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (000516D4) --------------------------------------------------------
void __fastcall __spoils<> Q_A11_sub_516D4(P_TypeA11 result)
{
  result->pListBox = 0;
}

//----- (000516E0) --------------------------------------------------------
void __fastcall Q_Wnd16SW_Proc4_sub_516E0(_DWORD *a1)
{
  int v1; // ebx
  int v2; // eax
  int v3; // eax
  char *v4; // eax
  UBYTE colorSet; // al
  int v6; // edx
  char *v7; // [esp-14h] [ebp-6Ch]
  int v8; // [esp-10h] [ebp-68h]
  char *v9; // [esp-Ch] [ebp-64h]
  char *sub_1CEA8; // [esp-4h] [ebp-5Ch]
  char s[80]; // [esp+0h] [ebp-58h] BYREF
  PANE *p_pane; // [esp+50h] [ebp-8h]
  P_WndA2 result; // [esp+54h] [ebp-4h]

  result = (P_WndA2)a1;
  v1 = 0;
  if ( V_Game.starsNum > 0 )
  {
    v6 = 0;
    do
    {
      if ( V_Game.stars[v6].planetsRacesBits == 1 << V_PlayerRaceIndex && &V_Game.stars[v6] != V_Game.races[V_PlayerRaceIndex].homeStar )
      {
        ++v1;
      }
      ++v6;
    }
    while ( (__int16)v6 < V_Game.starsNum );
  }
  if ( ((1 << V_PlayerRaceIndex) & V_Game.races[V_PlayerRaceIndex].homeStar->planetsRacesBits) != 0 )
  {
    ++v1;
  }
  if ( v1 == 1 )
  {
    v2 = 0x1C;
  }
  else
  {
    v2 = 0x1D;
  }
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v2);
  if ( *(_WORD *)(result[1].magic12345678 + 0x8C7) == 1 )
  {
    v3 = 0x1C;
  }
  else
  {
    v3 = 0x1D;
  }
  v9 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v3);
  v8 = *(unsigned __int16 *)(result[1].magic12345678 + 0x8C7);
  v7 = V_SpecNames[V_Game.races[V_PlayerRaceIndex].species];
  v4 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x97);
  sprintf(s, v4, v7, v8, v9, v1, sub_1CEA8);
  colorSet = V_Game.races[V_PlayerRaceIndex].colorSet;
  p_pane = &result->pane;
  WinMgr.LargeFont.pane = result->pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x19, 9, s, 2u, 4 * colorSet + 0x13, 0xFF, 0);
  Q_DrawRaceFlagTinted_sub_53E38(p_pane, 3, 3, V_PlayerRaceIndex);
  sub_2D218(result);
}

//----- (00051894) --------------------------------------------------------
int __fastcall Q_Wnd16SW_Proc3_sub_51894(int a1, __int16 a2, __int16 a3, LONG a4)
{
  T_Wnd10LB *Wnd_sub_56DA8; // eax
  WORD v7; // di
  T_Planet *v8; // esi
  unsigned __int16 v9; // ax
  T_Planet *ItemData_sub_2ED14; // eax

  if ( (unsigned __int16)a2 < 2u )
  {
    if ( a2 != 1 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
    }
    if ( !*(_DWORD *)(a1 + 0xAB) )
    {
      Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "STATPLANLST", 0);
      *(_DWORD *)(a1 + 0xAB) = Wnd_sub_56DA8;
      if ( !Wnd_sub_56DA8 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x1CB);
      }
      *(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xAB) = 0;
      *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8C9) = 0x8D;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), (P_DrawItemFunc)sub_50530);
      Q_Wnd10LB_SetCompareProc_sub_2F1D8(*(P_Wnd10LB *)(a1 + 0xAB), Q_CompareListBoxItems_sub_10A14);
      *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + 0xC5) = 0;
      *(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xBB) = 0xFFFFFFFF;
    }
    if ( (unsigned __int16)word_96B2C == 0xFFFF )
    {
      LOWORD(word_96B2C) = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\planets.shp", 0);
      if ( (unsigned __int16)word_96B2C == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x1D9);
      }
    }
    if ( (unsigned __int16)word_96B2A == 0xFFFF )
    {
      LOWORD(word_96B2A) = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\suns.shp", 0);
      if ( (unsigned __int16)word_96B2A == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x1E0);
      }
    }
    Q_Wnd10LB_Clear_sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xAB));
    if ( V_Game.planetsNum > 0 )
    {
      v7 = 0;
      do
      {
        v8 = &V_Game.planets[v7];
        if ( v8->raceIndex == V_PlayerRaceIndex )
        {
          v9 = Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(a1 + 0xAB), (BYTE *)v8, 0x96, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xAB), v9, v8->dayColonized);
        }
        ++v7;
      }
      while ( v7 < V_Game.planetsNum );
    }
    Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(*(P_Wnd10LB *)(a1 + 0xAB));
    Q_Wnd10LB_SetSelectedIndex_sub_2ECDC(*(P_Wnd10LB *)(a1 + 0xAB), *(_WORD *)(a1 + 0xAF));
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  else if ( (unsigned __int16)a2 <= 2u )
  {
    *(_WORD *)(a1 + 0xAF) = *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8CD);
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  else
  {
    if ( a2 != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
    }
    ItemData_sub_2ED14 = (T_Planet *)Q_Wnd10LB_GetItemData_sub_2ED14(*(P_Wnd10LB *)(a1 + 0xAB), a3);
    if ( V_Mouse.x <= 0x96 )
    {
      V_Game.pCurStar = &V_Game.stars[ItemData_sub_2ED14->starIndex];
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 1);
    }
    else
    {
      V_Game.pCurPlanet = ItemData_sub_2ED14;
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
    }
    *(_WORD *)(a1 + 0xAF) = *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8CD);
    return 0;
  }
}

//----- (00051B64) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd17FW_Ctor_sub_51B64(P_Wnd17FW a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a11.a);
  a1->a11.a.pProcs = &Wnd17FW_Procs;
  Q_A11_sub_516D4(&a1->a11);
}

//----- (00051B80) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd17FW_Dtor_sub_51B80(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd17FW);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = &Wnd17FW_Procs;
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00051BC4) --------------------------------------------------------
void __fastcall Q_Wnd17FW_Proc4_sub_51BC4(P_Wnd17FW pWnd, int a2)
{
  int MoreAllowedShips_sub_3EFE0; // eax
  int v3; // edx
  const char *v4; // eax
  char *sub_1CEA8; // eax
  UBYTE colorSet; // al
  char *v7; // [esp-10h] [ebp-68h]
  int itemCount; // [esp-Ch] [ebp-64h]
  const char *v9; // [esp-8h] [ebp-60h]
  char s[80]; // [esp+0h] [ebp-58h] BYREF
  P_Wnd17FW v11; // [esp+50h] [ebp-8h]
  PANE *p_pane; // [esp+54h] [ebp-4h]

  v11 = pWnd;
  MoreAllowedShips_sub_3EFE0 = Q_Race_GetMoreAllowedShips_sub_3EFE0(&V_Game.races[V_PlayerRaceIndex]);
  v3 = MoreAllowedShips_sub_3EFE0;
  if ( MoreAllowedShips_sub_3EFE0 >= 0 )
  {
    if ( MoreAllowedShips_sub_3EFE0 > 100 )
    {
      v3 = 100;
    }
  }
  else
  {
    v3 = 0;
  }
  if ( v11->a11.pListBox->itemCount == 1 )
  {
    v4 = (_BYTE *)&unk_92C97;
  }
  else
  {
    v4 = "s";
  }
  v9 = v4;
  itemCount = v11->a11.pListBox->itemCount;
  v7 = V_SpecNames[V_Game.races[V_PlayerRaceIndex].species];
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x98);// 152: "%s  (%d Ship%s, %d more allowed)"
  sprintf(s, sub_1CEA8, v7, itemCount, v9, v3);
  colorSet = V_Game.races[V_PlayerRaceIndex].colorSet;
  p_pane = &v11->a11.a.pane;
  WinMgr.LargeFont.pane = v11->a11.a.pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x19, 9, s, 2u, 4 * colorSet + 0x13, 0xFF, 0);
  Q_DrawRaceFlagTinted_sub_53E38(p_pane, 3, 3, V_PlayerRaceIndex);
  sub_2D218(&v11->a11.a);
}

//----- (00051D24) --------------------------------------------------------
int __fastcall Q_Wnd17FW_Proc3_sub_51D24(P_Wnd17FW pWnd, UWORD message, int param1, int param2)
{
  int result; // eax
  P_Wnd10LB pWnd10LB; // eax
  int shipsNum; // ebp
  P_Ship pShip; // esi
  unsigned __int16 newItemIndex; // ax
  int v10; // ecx
  int v11; // ebx
  UWORD v12; // dx
  T_Ship *pShip_1; // eax
  T_Ship *v14; // esi
  T_Wnd08SW *Wnd_sub_56DA8; // eax
  P_Ship shipsList[107]; // [esp+0h] [ebp-1C8h] BYREF
  int param2a; // [esp+1ACh] [ebp-1Ch]
  int param1a; // [esp+1B0h] [ebp-18h]
  UWORD v19; // [esp+1B4h] [ebp-14h]
  __int16 i; // [esp+1B8h] [ebp-10h]

  v19 = message;
  param1a = param1;
  param2a = param2;
  if ( message < 2u )
  {
    if ( message != 1 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v19, param1a, param2a);
    }
    if ( !pWnd->a11.pListBox )
    {
      pWnd10LB = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "STATSHIPLST", 0);
      pWnd->a11.pListBox = pWnd10LB;
      if ( !pWnd10LB )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x259);
      }
      pWnd->a11.pListBox->Unknown_AB = 0;
      pWnd->a11.pListBox->_defaultItemHeight = 106;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pWnd->a11.pListBox, (P_DrawItemFunc)sub_50D70);
      Q_Wnd10LB_SetCompareProc_sub_2F1D8(pWnd->a11.pListBox, Q_CompareListBoxItems_sub_10A14);
      pWnd->a11.pListBox->Unknown_C5 = 0;
    }
    // data\smship00.shp .. data\smship06.shp
    smshipShpCacheIndex = GwshareShpCacheIndexes[V_PlayerRaceIndex + 14];
    if ( planetsShpCacheIndex == 0xFFFF )
    {
      planetsShpCacheIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\planets.shp", 0);
      if ( planetsShpCacheIndex == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x269);
      }
    }
    if ( sunsShpCacheIndex == 0xFFFF )
    {
      sunsShpCacheIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\suns.shp", 0);
      if ( sunsShpCacheIndex == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x270);
      }
    }
    Q_Wnd10LB_Clear_sub_2ED4C(pWnd->a11.pListBox);
    shipsNum = Q_Race_GetShips_sub_40224(&V_Game.races[V_PlayerRaceIndex], shipsList, 0);
    for ( i = 0; i < shipsNum; ++i )
    {
      pShip = shipsList[i];
      newItemIndex = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd->a11.pListBox, (BYTE *)pShip, 100, FALSE);
      Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd->a11.pListBox, newItemIndex, pShip->_dayBuilt);
    }
    v10 = param2a;
    Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(pWnd->a11.pListBox);
    v11 = param1a;
    Q_Wnd10LB_SetSelectedIndex_sub_2ECDC(pWnd->a11.pListBox, pWnd->Unknown_AF);
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v19, v11, v10);
  }
  else if ( message <= 2u )
  {
    v12 = v19;
    pWnd->Unknown_AF = pWnd->a11.pListBox->_selectedIndex;
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v12, param1, param2);
  }
  else
  {
    if ( message != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v19, param1a, param2a);
    }
    pShip_1 = (T_Ship *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->a11.pListBox, param1a);
    v14 = pShip_1;
    if ( param2 == 5 )
    {
      Wnd_sub_56DA8 = (T_Wnd08SW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "SHIPDESSCREEN", 0);
      sub_4DA7C(Wnd_sub_56DA8, v14, 0, 0xFFFFFFFF);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 8, 1);
      pWnd->Unknown_AF = pWnd->a11.pListBox->_selectedIndex;
      return 0xFFFFFFFF;
    }
    else
    {
      switch ( pShip_1->locationType )
      {
        case ASCEND_LOCATION_TYPE_SHIPYARD:
        case ASCEND_LOCATION_TYPE_SHIPDOCK:
        case ASCEND_LOCATION_TYPE_ORBIT:
          V_Game.pCurPlanet = pShip_1->pLocation.pPlanet;
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
          pWnd->Unknown_AF = pWnd->a11.pListBox->_selectedIndex;
          result = 0xFFFFFFFF;
          break;
        case ASCEND_LOCATION_TYPE_SYSTEM:
          V_Game.pCurStar = pShip_1->pLocation.pStar;
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 1);
          pWnd->Unknown_AF = pWnd->a11.pListBox->_selectedIndex;
          result = 0xFFFFFFFF;
          break;
        case ASCEND_LOCATION_TYPE_STARLANE:
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
          result = 0xFFFFFFFF;
          break;
        default:
          result = 0;
          break;
      }
    }
  }
  return result;
}

//----- (000520EC) --------------------------------------------------------
void __fastcall __spoils<> Q_WndNGCtor_sub_520EC(P_Wnd18NG a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a);
  a1->a.pProcs = &Wnd18NG_Procs;
  Q_WndNG_sub_5214C(a1);
}

//----- (00052108) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd18NG_Dtor_sub_52108(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd18NG);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = &Wnd18NG_Procs;
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0005214C) --------------------------------------------------------
void __fastcall Q_WndNG_sub_5214C(P_Wnd18NG result)
{
  result->speciesDescriptions = 0;
  result->pListBox = 0;
  result->Unknown_B3 = 0;
  result->Unknown_B5 = 0;
}

//----- (00052174) --------------------------------------------------------
int __fastcall Q_Wnd18NG_LoadSpeciesDescriptions_sub_52174(P_Wnd18NG pWnd18NG)
{
  T_Text200 *speciesDescriptions; // kr00_4
  FILE *fp; // edi
  int i; // esi

  pWnd18NG->speciesDescriptions = V_SpeciesDescriptions;
  speciesDescriptions = pWnd18NG->speciesDescriptions;
  fp = Q_OpenTextFile_sub_1BB10("newgame.txt", 0);
  for ( i = 0; i < 21; ++i )
  {
    fgets(speciesDescriptions[i], 199, fp);
  }
  return fclose(fp);
}

//----- (000521C0) --------------------------------------------------------
void __fastcall Q_Wnd18NG_Proc4_sub_521C0(P_Wnd18NG pWnd18NG, int a2)
{
  char *sub_1CEA8; // eax
  int v4; // edi
  void *ShapeTable_sub_1B084; // ecx
  void *v6; // ecx
  UWORD ItemIndex_sub_1B270; // ax
  void *v8; // eax
  int v9; // ebx
  char *v10; // eax
  int Unknown_B5; // eax
  char *v12; // eax
  int v13; // kr1C_4
  int v14; // kr3C_4
  LONG v15; // ebx
  void *v16; // eax
  int i; // kr04_4
  int j; // kr0C_4
  int k; // kr14_4
  __int16 m; // si
  LONG Unknown_B3; // [esp-Ch] [ebp-15Ch]
  char *v22; // [esp-Ch] [ebp-15Ch]
  char *v23; // [esp-8h] [ebp-158h]
  char *v24; // [esp-4h] [ebp-154h]
  char *v25; // [esp-4h] [ebp-154h]
  char s[240]; // [esp+0h] [ebp-150h] BYREF
  char *v27[5]; // [esp+F0h] [ebp-60h]
  char *v28[5]; // [esp+104h] [ebp-4Ch]
  PANE pPane; // [esp+118h] [ebp-38h] BYREF
  char *v30[3]; // [esp+12Ch] [ebp-24h]
  int v31; // [esp+138h] [ebp-18h]

  v31 = a2;
  sub_52714(pWnd18NG);
  pPane.window = pWnd18NG->a.pane.window;
  pPane.x0 = 0x1F6;
  pPane.y0 = 7;
  pPane.x1 = 0x278;
  pPane.y1 = 0x24;
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x99);// 153: "Player Species"
  sprintf(s, sub_1CEA8);
  WinMgr.LargeFont.pane = pPane;
  v4 = v31;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, s, 3u, 0xF3, 0xFF, 0x6E);
  if ( !v4 )
  {
    pPane = pWnd18NG->a.pane;
    VFX_pane_wipe(&pWnd18NG->a.pane, 0);
    pPane.y1 = 0x23;
    WinMgr.LargeFont.pane = pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(
      &WinMgr.LargeFont,
      0,
      0,
      V_SpecNames[pWnd18NG->Unknown_B3],
      3u,
      (unsigned __int8)byte_96779[pWnd18NG->Unknown_B5],
      0xFF,
      0);
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);
    if ( !ShapeTable_sub_1B084 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x325);
    }
    VFX_shape_draw(&pWnd18NG->a.pane, ShapeTable_sub_1B084, pWnd18NG->Unknown_B3, 0x4B, 0x55);
    v6 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x21]);
    if ( !v6 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x329);
    }
    VFX_shape_draw(&pWnd18NG->a.pane, v6, pWnd18NG->Unknown_B5, 0x4B, 0x55);
    ItemIndex_sub_1B270 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\smhome.shp", 0xFFFFFFFF);
    if ( ItemIndex_sub_1B270 == 0xFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x334);
    }
    Unknown_B3 = pWnd18NG->Unknown_B3;
    v8 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, ItemIndex_sub_1B270);
    VFX_shape_draw(&pWnd18NG->a.pane, v8, Unknown_B3, 0x48, 0xCD);
    Q_DrawRaceFlagTinted_sub_53E38(&pWnd18NG->a.pane, 0x6B, 0xC1, V_PlayerRaceIndex);
    if ( !pWnd18NG->speciesDescriptions )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x340);
    }
    if ( pWnd18NG->Unknown_B3 >= 0x15 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x341);
    }
    v9 = pWnd18NG->Unknown_B3;
    v24 = pWnd18NG->speciesDescriptions[v9];
    v10 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x9A);    // 154: "The %s %s"
    sprintf(s, v10, V_SpecNames[v9], v24);
    pPane.y0 = 0x109;
    pPane.y1 = pWnd18NG->a.pane.y1;
    Unknown_B5 = pWnd18NG->Unknown_B5;
    WinMgr.SmallFont.pane = pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0, 0, s, 0, (unsigned __int8)byte_96779[Unknown_B5], 0xFF, 0x96);
    for ( i = 0; i != 5; ++i )
    {
      v27[i] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(i + 0x9B);// 155: "Vacuous"
    }
    for ( j = 0; j != 3; ++j )
    {
      v30[j] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(j + 0xA0);// 160: "Peaceful"
    }
    for ( k = 0; k != 5; ++k )
    {
      v28[k] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(k + 0xA3);// 163: "Three"
    }
    pPane.x0 = 0x11;
    pPane.y0 = 0x145;
    pPane.x1 = 0x144;
    pPane.y1 = 0x172;
    v25 = v30[pWnd18NG->atmosphere];
    v23 = v27[pWnd18NG->Unknown_B9 + 2];
    v22 = v27[pWnd18NG->starDensity];
    v12 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xA8);    // 168: "%s Star Cluster\n%s Species\n%s Atmosphere"
    sprintf(s, v12, v22, v23, v25);
    WinMgr.LargeFont.pane = pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, s, 0x82u, 0xFFFF, 0, 0xFA);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pWnd18NG->a.pane);
    pPane.window = V_GSystem.pane.window;
    pPane.x1 = 0x18B;
    pPane.y1 = 0x1CF;
    pPane.x0 = 0x17D;
    pPane.y0 = 0x1B1;
    v13 = 0;
    v14 = 0;
    for ( m = 0; m < 7; ++m )
    {
      v15 = pWnd18NG->Unknown_B3;
      v16 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x20]);
      Q_DrawTintedShape_sub_53F40(&pPane, v16, v15, 0, 0, m);
      if ( m == pWnd18NG->Unknown_B5 )
      {
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(&pPane, 0, 0, 0xE, 0x18, 0xF3u, 0);
      }
      ++v13;
      ++v14;
    }
    Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, 0x17B, 0x1A4, 0x1ED, 0x1D8);
  }
}

//----- (000526D8) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Wnd18NG_IsMouseInBeginNewGameButton_sub_526D8(P_Wnd18NG pWnd)
{
  if ( V_Mouse.x <= 502 || V_Mouse.x >= 632 || V_Mouse.y <= 381 || V_Mouse.y >= 472 )
  {
    return FALSE;
  }
  else
  {
    return TRUE;
  }
}

//----- (00052714) --------------------------------------------------------
int __fastcall sub_52714(P_Wnd18NG pWnd)
{
  LONG v1; // edx
  int v2; // eax
  T_Wnd02COSWt1 *p_Unknown_172; // esi
  int v4; // ecx
  int v5; // edx
  int v6; // ebx
  char v7; // ah
  _DWORD *v8; // ebp
  void *ShapeTable_sub_1B084; // eax
  void *v10; // eax
  char *sub_1CEA8; // eax
  int v13; // edi
  LONG Unknown_B3; // [esp-20h] [ebp-60h]
  PANE pane; // [esp+0h] [ebp-40h] BYREF
  P_Wnd18NG v16; // [esp+14h] [ebp-2Ch]
  int v17; // [esp+18h] [ebp-28h]
  T_Wnd02COSW *pWnd02COSW; // [esp+1Ch] [ebp-24h]
  int v19; // [esp+20h] [ebp-20h]
  int v20; // [esp+24h] [ebp-1Ch]

  v16 = pWnd;
  pane.window = V_GSystem.pane.window;
  pane.x0 = 0x1F6;
  pane.y0 = 0x17D;
  pane.x1 = 0x278;
  v1 = 0xF2;
  pane.y1 = 0x1D8;
  if ( Q_Wnd18NG_IsMouseInBeginNewGameButton_sub_526D8(pWnd) == TRUE )
  {
    v1 = 0x96;
  }
  VFX_pane_wipe(&pane, v1);
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, 502, 381, 632, 472);
  pWnd02COSW = (T_Wnd02COSW *)Q_WinMgr_FindWndWithState_sub_56E18(&WinMgr, "COSMOSWnd", ASCEND_WINMGR_STATE_NEW_GAME, 0);
  if ( !pWnd02COSW )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x3BB);
  }
  HIWORD(v2) = HIWORD(pWnd02COSW);
  LOWORD(v2) = pWnd02COSW->Unknown_172.num;
  v20 = v2;
  if ( (__int16)v2 > 0 )
  {
    p_Unknown_172 = &pWnd02COSW->Unknown_172;
    v13 = 0;
    do
    {
      v6 = p_Unknown_172->Unknown_0[v13];
      v7 = *(_BYTE *)(v6 + 4);
      v19 = (int)(*(float *)(v6 + 0xD) + -1500.0);
      if ( !v7 )
      {
        v4 = 3;
        v8 = *(_DWORD **)v6;
        if ( v19 <= 0xDC )
        {
          if ( v19 <= 0 )
          {
            if ( v19 > (int)0xFFFFFF24 )
            {
              v4 = 2;
            }
          }
          else
          {
            v4 = 1;
          }
        }
        else
        {
          v4 = 0;
        }
        v5 = *(__int16 *)(v6 + 7);
        v17 = 5;
        VFX_shape_draw(&pane, pWnd02COSW->Unknown_AB, 4 * *v8 + v4, *(__int16 *)(v6 + 5) / 5 + 5, v5 / 5 + 5);
      }
      ++v13;
    }
    while ( (__int16)v13 < (__int16)v20 );
  }
  Unknown_B3 = v16->Unknown_B3;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);
  VFX_shape_transform(&pane, ShapeTable_sub_1B084, Unknown_B3, 0x62, 0x24, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  v10 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
  Q_DrawRaceTintedShape_sub_53EB8(&pane, v10, 3, 0x62, 0x24, 0);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xA9);// 169: "Begin New Game"
  WinMgr.LargeFont.pane = pane;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x41, 0x50, sub_1CEA8, 0xCu, 0xFFFF, 0xFF, 0);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (0005294C) --------------------------------------------------------
int __fastcall Q_Wnd18NG_Proc3_sub_5294C(P_Wnd18NG pWnd18NG, UWORD message, int param1, int param2)
{
  T_Wnd04BM *v6; // kr00_4
  int j; // kr04_4
  T_Wnd02COSW *v8; // eax
  T_Matrix3x3 *p_viewMatrix; // eax
  T_Wnd03CTW *pWnd03CTW; // eax
  P_Wnd10LB pListBox; // eax
  T_Wnd10LB *Wnd_sub_56DA8; // eax
  __int16 i; // si
  T_ChildWindows *children; // eax
  T_ChildWindows *v15; // eax
  T_ChildWindows *v16; // eax
  __int16 Unknown_B9; // bx
  UWORD v18; // dx
  int v19; // ecx
  int v20; // ebx
  __int16 v21; // dx
  _WORD v22[3]; // [esp+0h] [ebp-42h]
  int v23; // [esp+6h] [ebp-3Ch]
  int v24; // [esp+Ah] [ebp-38h]
  int v25; // [esp+Eh] [ebp-34h]
  int v26; // [esp+12h] [ebp-30h]
  PANE pPane; // [esp+16h] [ebp-2Ch] BYREF
  int param2a; // [esp+2Ah] [ebp-18h]
  int param1a; // [esp+2Eh] [ebp-14h]
  UWORD v30; // [esp+32h] [ebp-10h]

  v30 = message;
  param1a = param1;
  param2a = param2;
  *(_DWORD *)&v22[1] = dword_96B74[0];
  v23 = dword_96B74[1];
  v24 = dword_96B74[2];
  v25 = dword_96B74[3];
  v26 = dword_96B74[4];
  if ( message < 0x1F5u )
  {
    if ( message < 2u )
    {
      if ( message == 1 )
      {
        Q_SaveGam_sub_54048("resume.gam");
        dword_96BC0 = 0xFFFFFFFF;
        pListBox = pWnd18NG->pListBox;
        WinMgr.stealingCheatMode = 0;
        if ( !pListBox )
        {
          Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "RACELIST", 0);
          pWnd18NG->pListBox = Wnd_sub_56DA8;
          if ( !Wnd_sub_56DA8 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x463);
          }
          pWnd18NG->pListBox->Unknown_AB = 0;
          pWnd18NG->pListBox->_defaultItemHeight = 0x6D;
          Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pWnd18NG->pListBox, (P_DrawItemFunc)sub_51610);
          Q_Wnd10LB_InitScrollBar_sub_2E9CC(pWnd18NG->pListBox, 0);
          pWnd18NG->pListBox->wipeColor = 0xF2;
        }
        Q_Wnd10LB_Clear_sub_2ED4C(pWnd18NG->pListBox);
        for ( i = 0; i < 21; ++i )
        {
          Q_Wnd10LB_AddItem_sub_2EA8C(pWnd18NG->pListBox, (BYTE *)i, 0x73, FALSE);
        }
        children = pWnd18NG->a.children;
        pWnd18NG->starDensity = 2;
        (*children)[0]->_t19[0]._shapeNumber = 2;
        v15 = pWnd18NG->a.children;
        pWnd18NG->Unknown_B9 = 5;
        (*v15)[1]->_t19[0]._shapeNumber = 7;
        v16 = pWnd18NG->a.children;
        pWnd18NG->atmosphere = 1;
        (*v16)[2]->_t19[0]._shapeNumber = 0xB;
        Unknown_B9 = pWnd18NG->Unknown_B9;
        V_Game.atmosphere = 1;
        pWnd18NG->Unknown_B3 = 0;
        sub_1E10C(&V_Game, v22[2 * pWnd18NG->starDensity + 1], Unknown_B9, pWnd18NG->Unknown_B3);
        pWnd18NG->Unknown_B5 = 0;
        V_PlayerRaceIndex = 0;
        V_Game.races[0].species = 0;
        Q_Game_SetRacesRandomColors_sub_1EE08(&V_Game, pWnd18NG->Unknown_B5);
        pPane.window = pWnd18NG->a.pane.window;
        pPane.y1 = 472;
        pPane.x0 = 379;
        pPane.y0 = 420;
        pPane.x1 = 493;
        VFX_pane_wipe(&pPane, 0xF2);
        Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
        v18 = v30;
        v19 = param2a;
        v20 = param1a;
        Q_Wnd18NG_LoadSpeciesDescriptions_sub_52174(pWnd18NG);
        return Q_WndA2_Proc3_sub_2F424(&pWnd18NG->a, v18, v20, v19);
      }
    }
    else
    {
      if ( message <= 2u )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd18NG->a, v30, param1, param2);
      }
      if ( message >= 4u )
      {
        if ( message <= 5u )
        {
          if ( param1 <= 0x17B || param1 >= 0x1ED || param2 <= 0x1A4 || param2 >= 0x1D8 )
          {
            if ( Q_Wnd18NG_IsMouseInBeginNewGameButton_sub_526D8(pWnd18NG) == TRUE )
            {
              Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 0);
              sub_1F404(&V_Game);
              Q_Game_InitializeStarConnections_sub_1F038(&V_Game);
              v6 = (T_Wnd04BM *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "BatModeWnd", 0);
              for ( j = 0; j != 0x64; ++j )
              {
                v6->Unknown_137E[j] = 0;
              }
              v8 = (T_Wnd02COSW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "COSMOSWnd", 0);
              Q_Wnd02COSW_InitializeCameraDefaults_sub_2280C(v8);
              p_viewMatrix = &((T_Wnd09RW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "RESWIN", 0))->camera._viewMatrix;
              p_viewMatrix->_[0][1] = 0.0;
              p_viewMatrix->_[0][2] = 0.0;
              p_viewMatrix->_[0][0] = 1.0;
              p_viewMatrix->_[1][0] = 0.0;
              p_viewMatrix->_[1][1] = 1.0;
              p_viewMatrix->_[1][2] = 0.0;
              p_viewMatrix->_[2][0] = 0.0;
              p_viewMatrix->_[2][1] = 0.0;
              p_viewMatrix->_[2][2] = 1.0;
              pWnd03CTW = (T_Wnd03CTW *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "RACECONTROLS", 0);
              if ( !pWnd03CTW )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x444);
              }
              Q_Wnd03CTW_sub_2DD70(pWnd03CTW);
              V_Game.atmosphere = pWnd18NG->atmosphere;
              sub_1EEA4(&V_Game);
              dword_96BC0 = 0;
              Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0xC, 0);
              return 0xFFFFFFFF;
            }
            else
            {
              return 0;
            }
          }
          else
          {
            Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 0);
            pWnd18NG->Unknown_B5 = (param1 - 0x17B) / 0x10;
            Q_Game_SetRacesRandomColors_sub_1EE08(&V_Game, pWnd18NG->Unknown_B5);
            ((void (__cdecl *)(_DWORD, int, int, int, int))pWnd18NG->a.pProcs->proc4_draw)(*(_DWORD *)&v22[1], v23, v24, v25, v26);
            return 0xFFFFFFFF;
          }
        }
        if ( message == 0xC )
        {
          if ( param1 > 0x17B && param1 < 0x1ED && param2 > 0x1A4 && param2 < 0x1D8 )
          {
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)"pcolor", 0);
            return 0xFFFFFFFF;
          }
          if ( Q_Wnd18NG_IsMouseInBeginNewGameButton_sub_526D8(pWnd18NG) == TRUE )
          {
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)"beghelp", 0);
            return 0xFFFFFFFF;
          }
        }
      }
    }
    return Q_WndA2_Proc3_sub_2F424(&pWnd18NG->a, v30, param1a, param2a);
  }
  if ( message <= 0x1F5u )
  {
    if ( ++pWnd18NG->starDensity == 5 )
    {
      pWnd18NG->starDensity = 0;
    }
    sub_1E10C(&V_Game, v22[2 * pWnd18NG->starDensity + 1], pWnd18NG->Unknown_B9, pWnd18NG->Unknown_B3);
    sub_24D30((P_Wnd02COSW)WinMgr.wnds[dword_96BAC].pWndA2);
    pWnd18NG->a.pProcs->proc4_draw((P_WndA2)pWnd18NG, 0);
    (*pWnd18NG->a.children)[0]->_t19[0]._shapeNumber = pWnd18NG->starDensity;
    ((void (__cdecl *)(_DWORD, int, int, int, int))(*pWnd18NG->a.children)[0]->pProcs->proc4_draw)(*(_DWORD *)&v22[1], v23, v24, v25, v26);
    return 0xFFFFFFFF;
  }
  if ( message < 0x1F9u )
  {
    if ( message == 0x1F7 )
    {
      if ( ++pWnd18NG->Unknown_B9 == 8 )
      {
        pWnd18NG->Unknown_B9 = 3;
      }
      Q_Game_NewGame_sub_1E70C(&V_Game, pWnd18NG->Unknown_B9, pWnd18NG->Unknown_B3);
      sub_24D30((P_Wnd02COSW)WinMgr.wnds[dword_96BAC].pWndA2);
      pWnd18NG->a.pProcs->proc4_draw((P_WndA2)pWnd18NG, 0);
      (*pWnd18NG->a.children)[1]->_t19[0]._shapeNumber = pWnd18NG->Unknown_B9 + 2;
      ((void (__cdecl *)(_DWORD, int, int, int, int))(*pWnd18NG->a.children)[1]->pProcs->proc4_draw)(*(_DWORD *)&v22[1], v23, v24, v25, v26);
      return 0xFFFFFFFF;
    }
    return Q_WndA2_Proc3_sub_2F424(&pWnd18NG->a, v30, param1a, param2a);
  }
  if ( message <= 0x1F9u )
  {
    if ( ++pWnd18NG->atmosphere == 3 )
    {
      pWnd18NG->atmosphere = 0;
    }
    pWnd18NG->a.pProcs->proc4_draw((P_WndA2)pWnd18NG, 0);
    (*pWnd18NG->a.children)[2]->_t19[0]._shapeNumber = pWnd18NG->atmosphere + 0xA;
    ((void (__cdecl *)(_DWORD, int, int, int, int))(*pWnd18NG->a.children)[2]->pProcs->proc4_draw)(*(_DWORD *)&v22[1], v23, v24, v25, v26);
    return 0xFFFFFFFF;
  }
  else
  {
    if ( message <= 0x1FAu || message != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd18NG->a, v30, param1a, param2a);
    }
    if ( pWnd18NG->Unknown_B3 != param1 )
    {
      v21 = pWnd18NG->Unknown_B9;
      pWnd18NG->Unknown_B3 = param1a;
      Q_Game_NewGame_sub_1E70C(&V_Game, v21, pWnd18NG->Unknown_B3);
      pWnd18NG->a.pProcs->proc4_draw(&pWnd18NG->a, 0);
    }
    return 0xFFFFFFFF;
  }
}
// 96B74: using guessed type _DWORD dword_96B74[5];
// 96BAC: using guessed type int dword_96BAC;
// 96BC0: using guessed type int dword_96BC0;

//----- (00053000) --------------------------------------------------------
void __fastcall Q_Vector3D_Normalize_sub_53000(P_Vector3D pVector)
{
  double invLength; // st7
  float length; // [esp+Ch] [ebp-8h]

  length = sqrt(pVector->y * pVector->y + pVector->x * pVector->x + pVector->z * pVector->z);
  if ( length > 0.0 )
  {
    invLength = 1.0 / length;
    pVector->x = pVector->x * invLength;
    pVector->y = pVector->y * invLength;
    pVector->z = invLength * pVector->z;
  }
}

//----- (00053054) --------------------------------------------------------
void __fastcall Q_Vector3D_SetLength_sub_53054(P_Vector3D pVector, float length)
{
  Q_Vector3D_Normalize_sub_53000(pVector);
  pVector->x = pVector->x * length;
  pVector->y = pVector->y * length;
  pVector->z = length * pVector->z;
}

//----- (00053078) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Vector3D_IsZero_sub_53078(P_Vector3D v)
{
  if ( v->x || v->y || v->z )
  {
    return FALSE;
  }
  else
  {
    return TRUE;
  }
}

//----- (0005309C) --------------------------------------------------------
double __fastcall Q_Vector3D_AngleBetween_sub_5309C(P_Vector3D a1, P_Vector3D a2)
{
  double x; // st7
  float v4; // [esp+8h] [ebp-4h]
  float v5; // [esp+8h] [ebp-4h]

  v4 = a1->y * a2->y + a1->x * a2->x + a1->z * a2->z;
  v5 = v4 / sqrt(a1->y * a1->y + a1->x * a1->x + a1->z * a1->z);
  x = v5 / sqrt(a2->y * a2->y + a2->x * a2->x + a2->z * a2->z);
  return acos(x) * 57.29578;
}

//----- (00053114) --------------------------------------------------------
void __fastcall __spoils<> Q_M33xV_sub_53114(P_Vector3D v, T_Matrix3x3 *m)
{
  T_Vector3D v0; // [esp+0h] [ebp-1Ch]

  v0 = *v;
  v->x = v0.y * m->_[0][1] + v->x * m->_[0][0] + v0.z * m->_[0][2];
  v->y = v0.y * m->_[1][1] + v0.x * m->_[1][0] + v0.z * m->_[1][2];
  v->z = v0.y * m->_[2][1] + v0.x * m->_[2][0] + v0.z * m->_[2][2];
}

//----- (0005323C) --------------------------------------------------------
void __fastcall Q_Vector3D_RotateX_sub_5323C(P_Vector3D v, float degrees)
{
  double b; // st7
  float y; // [esp+8h] [ebp-18h]
  float a; // [esp+Ch] [ebp-14h]

  if ( degrees )
  {
    a = cos(degrees * 0.017453292);
    b = sin(degrees * 0.017453292);
    y = v->y;
    v->y = y * a - v->z * b;
    v->z = b * y + v->z * a;
  }
}
// 5323C: could not find valid save-restore pair for esi

//----- (000532AC) --------------------------------------------------------
void __fastcall Q_Vector3D_RotateY_sub_532AC(T_Vector3D *vector, float degrees)
{
  double b; // st7
  float x; // [esp+8h] [ebp-18h]
  float a; // [esp+Ch] [ebp-14h]

  if ( degrees )
  {
    a = cos(degrees * 0.017453292);
    b = sin(degrees * 0.017453292);
    x = vector->x;
    vector->x = vector->z * b + vector->x * a;
    vector->z = vector->z * a - b * x;
  }
}
// 532AC: could not find valid save-restore pair for esi

//----- (00053318) --------------------------------------------------------
void __fastcall Q_Vector3D_RotateZ_sub_53318(P_Vector3D vector, float degrees)
{
  double b; // st7
  float x; // [esp+8h] [ebp-18h]
  float a; // [esp+Ch] [ebp-14h]

  if ( degrees )
  {
    a = cos(degrees * 0.017453292);
    b = sin(degrees * 0.017453292);
    x = vector->x;
    vector->x = vector->x * a - vector->y * b;
    vector->y = b * x + vector->y * a;
  }
}
// 53318: could not find valid save-restore pair for esi

//----- (00053384) --------------------------------------------------------
void __fastcall __spoils<> Q_M34xV_sub_53384(P_Vector3D v, T_Matrix3x4 *trs, P_Vector3D result)
{
  result->x = trs->_[0][1] * v->y + trs->_[0][0] * v->x + trs->_[0][2] * v->z + trs->_[0][3];
  result->y = trs->_[1][1] * v->y + trs->_[1][0] * v->x + trs->_[1][2] * v->z + trs->_[1][3];
  result->z = trs->_[2][1] * v->y + trs->_[2][0] * v->x + trs->_[2][2] * v->z + trs->_[2][3];
}

//----- (000533D4) --------------------------------------------------------
void __fastcall Q_Project3DTo2D_sub_533D4(P_Vector3D v, float scaleFactor, int xOffset, int yOffset, WORD *outX, WORD *outY)
{
  double zreciprocal; // st5
  double v7; // st7

  zreciprocal = 1.0 / v->z;
  v7 = scaleFactor * v->y * zreciprocal;
  *outX = (int)(v->x * scaleFactor * zreciprocal + 0.5);
  *outY = (int)(v7 + 0.5);
  *outX += xOffset;
  *outY += yOffset;
}

//----- (00053440) --------------------------------------------------------
// Snaps a 3D vector's components to a grid of specified size
void __fastcall Q_Vector3D_SnapToGrid_sub_53440(P_Vector3D pVector)
{
  int gridSize; // ebx
  int edx2; // edx
  int xOffset; // eax
  int v1; // ett
  int v6; // edx
  int yOffset; // eax
  int v2; // ett
  int v9; // edx
  int zOffset; // eax
  int v3; // ett

  gridSize = V_GridSize;
  // Process X component
  if ( pVector->x < 0.0 )
  {
    edx2 = -V_GridSize;
    xOffset = -V_GridSize;
  }
  else
  {
    edx2 = V_GridSize;
    xOffset = V_GridSize;
  }
  v1 = (int)((double)((xOffset - (edx2 >> 0x1F)) >> 1) + pVector->x);
  pVector->x = (float)(V_GridSize * (v1 / V_GridSize));
  // Process Y component
  if ( pVector->y < 0.0 )
  {
    v6 = -gridSize;
    yOffset = -gridSize;
  }
  else
  {
    v6 = gridSize;
    yOffset = gridSize;
  }
  v2 = (int)((double)((yOffset - (v6 >> 0x1F)) >> 1) + pVector->y);
  pVector->y = (float)(gridSize * (v2 / gridSize));
  // Process Z component
  if ( pVector->z < 0.0 )
  {
    v9 = -gridSize;
    zOffset = -gridSize;
  }
  else
  {
    v9 = gridSize;
    zOffset = gridSize;
  }
  v3 = (int)((double)((zOffset - (v9 >> 0x1F)) >> 1) + pVector->z);
  pVector->z = (float)(gridSize * (v3 / gridSize));
  V_GridSize = gridSize;
}
// 96B88: using guessed type int V_GridSize;

//----- (0005353C) --------------------------------------------------------
void __fastcall Q_Matrix_RotateX_sub_5353C(P_Matrix3x3D mat, float degrees)
{
  if ( degrees )
  {
    Q_Vector3D_RotateX_sub_5323C(&mat->vector3, degrees);
    // Fix numerical drift
    Q_Matrix_Orthonormalize1_sub_53644(mat);
  }
}

//----- (00053564) --------------------------------------------------------
void __fastcall Q_Matrix_RotateY_sub_53564(P_Matrix3x3D mat, float degrees)
{
  if ( degrees )
  {
    Q_Vector3D_RotateY_sub_532AC(&mat->vector3, degrees);
    // Fix numerical drift
    Q_Matrix_Orthonormalize2_sub_53754(mat);
  }
}

//----- (0005358C) --------------------------------------------------------
void __fastcall Q_Matrix_RotateZ_sub_5358C(P_Matrix3x3D mat, float degrees)
{
  if ( degrees )
  {
    Q_Vector3D_RotateZ_sub_53318(&mat->vector2, degrees);
    // Fix numerical drift
    Q_Matrix_Orthonormalize3_sub_53864(mat);
  }
}

//----- (000535B4) --------------------------------------------------------
void __fastcall Q_Matrix_RotateXX_sub_535B4(P_Matrix3x3D mat, float degrees)
{
  if ( degrees )
  {
    Q_Vector3D_RotateX_sub_5323C(&mat->vector3, degrees);
    Q_Vector3D_RotateX_sub_5323C(&mat->vector2, degrees);
    Q_Matrix_Orthonormalize3_sub_53864(mat);
  }
}

//----- (000535E4) --------------------------------------------------------
void __userpurge Q_Matrix_RotateYY_sub_535E4(P_Matrix3x3D mat@<eax>, float degrees)
{
  if ( degrees )
  {
    Q_Vector3D_RotateY_sub_532AC(&mat->vector3, degrees);
    Q_Vector3D_RotateY_sub_532AC(&mat->vector2, degrees);
    Q_Matrix_Orthonormalize3_sub_53864(mat);
  }
}

//----- (00053644) --------------------------------------------------------
// This is a Gram-Schmidt-like orthonormalization process for a 3x3 matrix, ensuring:
//     All vectors are unit length (normalized).
//     All vectors are mutually perpendicular (orthogonal).
void __fastcall Q_Matrix_Orthonormalize1_sub_53644(P_Matrix3x3D a1)
{
  double v2; // st7
  double v3; // st6
  double v4; // st7
  double v5; // st6
  float v6; // [esp+0h] [ebp-48h]
  float v7; // [esp+4h] [ebp-44h]
  float v8; // [esp+8h] [ebp-40h]
  T_Vector3D v9; // [esp+Ch] [ebp-3Ch] BYREF
  T_Vector3D v10; // [esp+18h] [ebp-30h] BYREF
  float v11; // [esp+24h] [ebp-24h] BYREF
  float v12; // [esp+28h] [ebp-20h]
  float v13; // [esp+2Ch] [ebp-1Ch]
  T_Vector3D *v14; // [esp+30h] [ebp-18h]
  float *v15; // [esp+34h] [ebp-14h]

  // Step 1: Normalize the first vector
  Q_Vector3D_Normalize_sub_53000(&a1->vector1);
  // Step 2: Compute second vector (orthogonal to vector1 and vector3)
  v14 = &v9;
  memset(&v10, 0, sizeof(v10));
  v10.x = a1->vector3.y * a1->vector1.z - a1->vector3.z * a1->vector1.y;
  v10.y = a1->vector3.z * a1->vector1.x - a1->vector3.x * a1->vector1.z;
  v2 = a1->vector3.x * a1->vector1.y;
  v3 = a1->vector3.y * a1->vector1.x;
  v9 = v10;
  v10.z = v2 - v3;
  a1->vector2.x = v10.x;
  a1->vector2.y = v9.y;
  a1->vector2.z = v9.z;
  Q_Vector3D_Normalize_sub_53000(&a1->vector2);
  // Step 3: Recompute third vector (orthogonal to vector1 and vector2)
  v15 = &v11;
  v6 = a1->vector1.y * a1->vector2.z - a1->vector1.z * a1->vector2.y;
  v7 = a1->vector1.z * a1->vector2.x - a1->vector1.x * a1->vector2.z;
  v4 = a1->vector1.x * a1->vector2.y;
  v5 = a1->vector1.y * a1->vector2.x;
  v11 = v6;
  v8 = v4 - v5;
  v12 = v7;
  v13 = v8;
  a1->vector3.x = v6;
  a1->vector3.y = v12;
  a1->vector3.z = v13;
  Q_Vector3D_Normalize_sub_53000(&a1->vector3);
}

//----- (00053754) --------------------------------------------------------
void __fastcall Q_Matrix_Orthonormalize2_sub_53754(P_Matrix3x3D mat)
{
  T_Vector3D *p_vector2; // edx
  double v3; // st7
  double v4; // st6
  double v5; // st7
  double v6; // st6
  float v7; // [esp+0h] [ebp-48h]
  float v8; // [esp+4h] [ebp-44h]
  float v9; // [esp+8h] [ebp-40h]
  T_Vector3D v10; // [esp+Ch] [ebp-3Ch] BYREF
  T_Vector3D v11; // [esp+18h] [ebp-30h] BYREF
  float v12; // [esp+24h] [ebp-24h] BYREF
  float v13; // [esp+28h] [ebp-20h]
  float v14; // [esp+2Ch] [ebp-1Ch]
  T_Vector3D *v15; // [esp+30h] [ebp-18h]
  float *v16; // [esp+34h] [ebp-14h]

  // // Step 1: Normalize the SECOND vector (unlike the previous function)
  p_vector2 = &mat->vector2;
  Q_Vector3D_Normalize_sub_53000(&mat->vector2);
  // // Step 2: Compute first vector as (vector2 x vector3)
  memset(&v11, 0, sizeof(v11));
  v15 = &v10;
  v11.x = p_vector2->y * mat->vector3.z - p_vector2->z * mat->vector3.y;
  v11.y = p_vector2->z * mat->vector3.x - p_vector2->x * mat->vector3.z;
  v3 = p_vector2->x * mat->vector3.y;
  v4 = p_vector2->y * mat->vector3.x;
  v10 = v11;
  v11.z = v3 - v4;
  mat->vector1.x = v11.x;
  mat->vector1.y = v10.y;
  mat->vector1.z = v10.z;
  Q_Vector3D_Normalize_sub_53000(&mat->vector1);
  // // Step 3: Recompute third vector as (vector1 x vector2)
  v16 = &v12;
  v7 = mat->vector1.y * p_vector2->z - mat->vector1.z * p_vector2->y;
  v8 = mat->vector1.z * p_vector2->x - mat->vector1.x * p_vector2->z;
  v5 = mat->vector1.x * p_vector2->y;
  v6 = mat->vector1.y * p_vector2->x;
  v12 = v7;
  v9 = v5 - v6;
  v13 = v8;
  v14 = v9;
  mat->vector3.x = v7;
  mat->vector3.y = v13;
  mat->vector3.z = v14;
  Q_Vector3D_Normalize_sub_53000(&mat->vector3);
}

//----- (00053864) --------------------------------------------------------
void __fastcall Q_Matrix_Orthonormalize3_sub_53864(P_Matrix3x3D mat)
{
  T_Vector3D *p_vector3; // edx
  T_Vector3D *p_vector2; // ecx
  double v4; // st7
  double v5; // st6
  double v6; // st7
  double v7; // st6
  float v8; // [esp+0h] [ebp-48h]
  float v9; // [esp+4h] [ebp-44h]
  float v10; // [esp+8h] [ebp-40h]
  T_Vector3D v11; // [esp+Ch] [ebp-3Ch] BYREF
  T_Vector3D v12; // [esp+18h] [ebp-30h] BYREF
  float v13; // [esp+24h] [ebp-24h] BYREF
  float v14; // [esp+28h] [ebp-20h]
  float v15; // [esp+2Ch] [ebp-1Ch]
  T_Vector3D *v16; // [esp+30h] [ebp-18h]
  float *v17; // [esp+34h] [ebp-14h]

  p_vector3 = &mat->vector3;
  p_vector2 = &mat->vector2;
  // // Step 1: Normalize the THIRD vector (primary axis)
  Q_Vector3D_Normalize_sub_53000(&mat->vector3);
  // // Step 2: Compute first vector as (vector2 x vector3)
  memset(&v12, 0, sizeof(v12));
  v16 = &v11;
  v12.x = p_vector2->y * p_vector3->z - p_vector2->z * p_vector3->y;
  v12.y = p_vector2->z * p_vector3->x - p_vector2->x * p_vector3->z;
  v4 = p_vector2->x * p_vector3->y;
  v5 = p_vector2->y * p_vector3->x;
  v11 = v12;
  v12.z = v4 - v5;
  mat->vector1.x = v12.x;
  mat->vector1.y = v11.y;
  mat->vector1.z = v11.z;
  Q_Vector3D_Normalize_sub_53000(&mat->vector1);
  // // Step 3: Recompute second vector as (vector3 x vector1)
  v17 = &v13;
  v8 = p_vector3->y * mat->vector1.z - p_vector3->z * mat->vector1.y;
  v9 = p_vector3->z * mat->vector1.x - p_vector3->x * mat->vector1.z;
  v6 = p_vector3->x * mat->vector1.y;
  v7 = p_vector3->y * mat->vector1.x;
  v13 = v8;
  v10 = v6 - v7;
  v14 = v9;
  v15 = v10;
  p_vector2->x = v8;
  p_vector2->y = v14;
  p_vector2->z = v15;
  Q_Vector3D_Normalize_sub_53000(p_vector2);
}

//----- (00053B08) --------------------------------------------------------
// TRS = A * R + T
//     A is a 3x3 matrix (likely representing scale or skew)
//     R is a 3x3 rotation matrix
//     T is a 3D translation vector
//     TRS is the resulting 3x4 affine transform (rotation/scale + translation)
void __fastcall __spoils<> Q_BuildTransformMatrix_sub_53B08(T_Matrix3x4 *trs, T_Matrix3x3 *a, T_Matrix3x3 *r, P_Vector3D t)
{
  // Compute A * R (unusual order - verify if this is intentional)
  trs->_[0][0] = r->_[0][1] * a->_[0][1] + r->_[0][0] * a->_[0][0] + r->_[0][2] * a->_[0][2];
  trs->_[0][1] = r->_[1][1] * a->_[0][1] + r->_[1][0] * a->_[0][0] + r->_[1][2] * a->_[0][2];
  trs->_[0][2] = r->_[2][1] * a->_[0][1] + r->_[2][0] * a->_[0][0] + r->_[2][2] * a->_[0][2];
  trs->_[1][0] = r->_[0][1] * a->_[1][1] + r->_[0][0] * a->_[1][0] + r->_[0][2] * a->_[1][2];
  trs->_[1][1] = r->_[1][0] * a->_[1][0] + r->_[1][1] * a->_[1][1] + r->_[1][2] * a->_[1][2];
  trs->_[1][2] = r->_[2][0] * a->_[1][0] + r->_[2][1] * a->_[1][1] + r->_[2][2] * a->_[1][2];
  trs->_[2][0] = r->_[0][1] * a->_[2][1] + r->_[0][0] * a->_[2][0] + r->_[0][2] * a->_[2][2];
  trs->_[2][1] = r->_[1][0] * a->_[2][0] + r->_[1][1] * a->_[2][1] + r->_[1][2] * a->_[2][2];
  trs->_[2][2] = r->_[2][0] * a->_[2][0] + r->_[2][1] * a->_[2][1] + r->_[2][2] * a->_[2][2];
  // Compute A * T (translation transformed by scale/shear)
  trs->_[0][3] = t->y * a->_[0][1] + t->x * a->_[0][0] + t->z * a->_[0][2];
  trs->_[1][3] = t->y * a->_[1][1] + t->x * a->_[1][0] + t->z * a->_[1][2];
  trs->_[2][3] = t->y * a->_[2][1] + t->x * a->_[2][0] + t->z * a->_[2][2];
}

//----- (00053D22) --------------------------------------------------------
// write access to const memory has been detected, the output may be wrong!
int __cdecl sub_53D22(int a1)
{
  int v5; // edx
  unsigned int v6; // kr00_4
  int result; // eax
  __int16 v8; // [esp-Ah] [ebp-16h]
  void *retaddr; // [esp+10h] [ebp+4h]

  v6 = __readeflags();
  _disable();
  __asm { int     31h; DPMI Services   ax=func xxxxh }
  DMPI_selector_dword_53D1C = v5;
  DMPI_real_mode_segment_base_word_53D0C = 0x100;
  word_53CEA = 0;
  word_53D06 = 0x4F01;
  word_53D02 = a1;
  word_53D0E = 0;
  __asm { pushfw }
  word_53D0A = v8;
  __asm
  {
    int     31h; DPMI Services   ax=func xxxxh
    int     31h; DPMI Services   ax=func xxxxh
  }
  result = 0;
  _ZF = (BYTE1(retaddr) & 2) == 0;
  _disable();
  if ( !_ZF )
  {
    _enable();
  }
  __writeeflags(v6);
  return result;
}
// 53D37: write access to const memory at 53D1C has been detected
// 53D3D: write access to const memory at 53D0C has been detected
// 53D43: write access to const memory at 53CEA has been detected
// 53D51: write access to const memory at 53D06 has been detected
// 53D5A: write access to const memory at 53D02 has been detected
// 53D60: write access to const memory at 53D0E has been detected
// 53D6D: write access to const memory at 53D0A has been detected
// 53D37: variable 'v5' is possibly undefined
// 53D6D: variable 'v8' is possibly undefined
// 53CEA: using guessed type __int16 word_53CEA;
// 53D02: using guessed type __int16 word_53D02;
// 53D06: using guessed type __int16 word_53D06;
// 53D0A: using guessed type __int16 word_53D0A;
// 53D0C: using guessed type __int16 DMPI_real_mode_segment_base_word_53D0C;
// 53D0E: using guessed type __int16 word_53D0E;
// 53D1C: using guessed type int DMPI_selector_dword_53D1C;

//----- (00053DC0) --------------------------------------------------------
void Q_WinMgr_StaticCtor_sub_53DC0()
{
  _wcpp_2_mod_register_((RW_DTREG *)&stru_96B8C);
  Q_WinMgr_Ctor_sub_54344(&WinMgr);
  stru_96B8C.state_var = 1;
}

//----- (00053DE4) --------------------------------------------------------
void __cdecl Q_TimerIncrease_sub_53DE4()
{
  ++V_Timer_dword_132B58;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00053DEC) --------------------------------------------------------
int Q_CheckFreeMemory_sub_53DEC()
{
  int chunk; // edx
  int largest; // ecx
  MACRO_VFX_BOOL finished; // edi
  void *tmp; // eax

  chunk = 0x2000000;
  largest = 0;
  finished = FALSE;
  do
  {
    tmp = malloc(largest + chunk);
    if ( tmp )
    {
      largest += chunk;
    }
    if ( largest == 0x2000000 || chunk < 0x1000 )
    {
      finished = TRUE;
    }
    free(tmp);
    chunk >>= 1;
  }
  while ( finished == FALSE );
  return largest;
}

//----- (00053E38) --------------------------------------------------------
void __fastcall Q_DrawRaceFlagTinted_sub_53E38(PANE *pane, LONG hotX, LONG hotY, WORD raceIndex)
{
  void *raceFlagShapeTable; // ebp

  if ( raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD0);
  }
  raceFlagShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x20]);// 32: data\raceflag.shp
  if ( !raceFlagShapeTable )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD5);
  }
  Q_DrawRaceTintedShape_sub_53EB8(pane, raceFlagShapeTable, V_Game.races[raceIndex].species, hotX, hotY, raceIndex);
}

//----- (00053EB8) --------------------------------------------------------
// Draws a shape with color tinting for a specific race.
void __fastcall Q_DrawRaceTintedShape_sub_53EB8(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY, WORD raceIndex)
{
  UBYTE baseTintColor; // dl
  int colorIndex; // ecx
  __int16 i; // ax

  // Calculate base tint color for this race
  baseTintColor = 4 * V_Game.races[raceIndex].colorSet + 0x13;
  // Create a 4-color gradient in the lookaside table (indices 0x10-0x13)
  for ( i = 0; i < 4; ++i )
  {
    // Fill the table from high to low (0x13 -> 0x10)
    colorIndex = 0x13 - i;
    (*WinMgr.hazeTableMapRaces)[colorIndex] = baseTintColor--;
  }
  // Register our custom color translation table
  VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapRaces);
  // Draw the shape with color translation applied
  VFX_shape_translate_draw(pane, shape_table, shape_number, hotX, hotY);
}

//----- (00053F40) --------------------------------------------------------
void __fastcall Q_DrawTintedShape_sub_53F40(PANE *pPane, void *shapeTable, LONG shapeNumber, LONG hotX, LONG hotY, char colorSet)
{
  UBYTE baseTintColor; // dl
  int v9; // ecx
  __int16 i; // ax

  baseTintColor = 4 * colorSet + 0x13;
  for ( i = 0; i < 4; ++i )
  {
    v9 = 0x13 - i;
    (*WinMgr.hazeTableMapRaces)[v9] = baseTintColor--;
  }
  VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapRaces);
  VFX_shape_translate_draw(pPane, shapeTable, shapeNumber, hotX, hotY);
}

//----- (00053FB0) --------------------------------------------------------
void __fastcall Q_LoadGam_sub_53FB0(const char *fname)
{
  char *sub_1CEA8; // eax
  T_CFile fi; // [esp+0h] [ebp-18Ch] BYREF
  char buf[116]; // [esp+118h] [ebp-74h] BYREF

  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( Q_CFile_Open_sub_1BBFC(&fi, fname, O_BINARY, 0) )
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAA);// 170: "Unable to open file."
    Q_WinMgr_ShowMsgBox_sub_556CC(&WinMgr, sub_1CEA8);
  }
  else
  {
    Q_CFile_Read_sub_1BF94(&fi, buf, 0x74u);
    Q_Game_LoadGam_sub_21AA0(&V_Game, &fi);
    sub_56BE8(&WinMgr, 0xDu, 0, 0, 0);
    Q_WinMgr_CallProc6_sub_5A294(&WinMgr, &fi, TRUE);
  }
  Q_CFile_Dtor_sub_1BBC8(&fi);
}

//----- (00054048) --------------------------------------------------------
T_CFile *__fastcall Q_SaveGam_sub_54048(const char *fname)
{
  T_CFile *result; // eax
  char *v1; // eax
  int i; // edx
  int j; // eax
  int k; // eax
  T_CFile fi; // [esp-118h] [ebp-198h] BYREF
  T_SavBlock0Header v7; // [esp+0h] [ebp-80h] BYREF

  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( Q_CFile_Create_sub_1BCA8(&fi, fname) )
  {
    v1 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAA);     // 170: "Unable to open file."
    Q_WinMgr_ShowMsgBox_sub_556CC(&WinMgr, v1);
    result = &fi;
    Q_CFile_Dtor_sub_1BBC8(&fi);
  }
  else
  {
    v7.day = V_Game.day;
    v7.races = V_Game.racesNum;
    v7._playerRaceIndex = V_PlayerRaceIndex;
    for ( i = 0; i < V_Game.racesNum; ++i )
    {
      v7.z1[i] = V_Game.races[i].species;
    }
    for ( j = 0; j < V_Game.racesNum; ++j )
    {
      v7.z2[j] = V_Game.races[j].colorSet;
    }
    for ( k = 0; k < V_Game.racesNum; ++k )
    {
      v7.z3[k] = V_Game.races[V_PlayerRaceIndex].treaties[k];
    }
    v7.playerShipsNum = Q_Race_GetShips_sub_40224(&V_Game.races[V_PlayerRaceIndex], 0, 0);
    v7.playerPlanetsNum = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[V_PlayerRaceIndex]);
    v7.playerTechsNum = Q_Race_GetTechsNum_sub_40664(&V_Game.races[V_PlayerRaceIndex]);
    Q_CFile_Write_sub_1C098(&fi, &v7, 0x74u);
    Q_Game_SaveGam_sub_21374(&V_Game, &fi);
    Q_WinMgr_CallProc6_sub_5A294(&WinMgr, &fi, FALSE);
    result = &fi;
    Q_CFile_Dtor_sub_1BBC8(&fi);
  }
  return result;
}
// 541F4: returning address of temporary local variable '%0x0'

//----- (00054208) --------------------------------------------------------
LONG __fastcall Q_CopyPaneToBuffer_sub_54208(PANE *sourcePane)
{
  LONG result; // eax
  WINDOW targetWindow; // [esp+0h] [ebp-3Ch] BYREF
  PANE targetPane; // [esp+14h] [ebp-28h] BYREF

  targetWindow.buffer = V_BigBuffer;
  targetWindow.x_max = sourcePane->x1 - sourcePane->x0;
  targetWindow.y_max = sourcePane->y1 - sourcePane->y0;
  targetWindow.stencil = 0;
  targetWindow.shadow = 0;
  if ( targetWindow.y_max * targetWindow.x_max >= 160000 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x13E);
  }
  targetPane.x1 = targetWindow.x_max;
  targetPane.y1 = targetWindow.y_max;
  targetPane.window = &targetWindow;
  targetPane.x0 = 0;
  targetPane.y0 = 0;
  result = VFX_pane_copy(sourcePane, 0, 0, &targetPane, 0, 0, NO_COLOR);
  if ( result )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x147);
  }
  return result;
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (000542B0) --------------------------------------------------------
LONG __fastcall Q_CopyBufferToPane_sub_542B0(PANE *targetPane)
{
  WINDOW sourceWindow; // [esp+0h] [ebp-3Ch] BYREF
  PANE sourcePane; // [esp+14h] [ebp-28h] BYREF

  sourceWindow.buffer = V_BigBuffer;
  sourceWindow.x_max = targetPane->x1 - targetPane->x0;
  sourceWindow.y_max = targetPane->y1 - targetPane->y0;
  sourceWindow.stencil = 0;
  sourceWindow.shadow = 0;
  if ( sourceWindow.y_max * sourceWindow.x_max >= 160000 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x158);
  }
  sourcePane.x1 = sourceWindow.x_max;
  sourcePane.y1 = sourceWindow.y_max;
  sourcePane.window = &sourceWindow;
  sourcePane.x0 = 0;
  sourcePane.y0 = 0;
  return VFX_pane_copy(&sourcePane, 0, 0, targetPane, 0, 0, 0xFFFFFFFF);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00054344) --------------------------------------------------------
void __fastcall __spoils<> Q_WinMgr_Ctor_sub_54344(P_WinMgr a1)
{
  Q_Font_Init_sub_2B2C0(&a1->SmallFont);
  Q_Font_Init_sub_2B2C0(&a1->LargeFont);
  Q_Cache_Init_sub_1ACC0(&a1->cache);
  Q_WinMgr_Init_sub_54448(a1);
}

//----- (00054374) --------------------------------------------------------
void __fastcall Q_WinMgrDtor_sub_54374(P_WinMgr pWinMgr)
{
  __int16 i; // cx
  T_WndA2 *pWndA2; // eax
  __int16 j; // dx
  int v5; // edx
  T_WinMgr *v6; // eax

  for ( i = 0; i < 0x400; ++i )
  {
    if ( pWinMgr->wnds[i].pWndA2 )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(pWinMgr->wnds[i].pWndA2);
    }
    pWndA2 = pWinMgr->wnds[i].pWndA2;
    if ( pWndA2 )
    {
      pWndA2->pProcs->dtor(pWndA2, 2);
    }
  }
  for ( j = 0; j < 6; ++j )
  {
    if ( *(_DWORD *)&pWinMgr->z1c[4 * j] )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)&pWinMgr->z1c[4 * j]);
    }
    operator delete[](*(void **)&pWinMgr->z1c[4 * j]);
  }
  if ( pWinMgr->aaa == 0xFFFFFFFF )
  {
    v5 = 0xFFFFFFFF;
    v6 = pWinMgr;
LABEL_17:
    Q_WinMgr_RecordWinEvents_sub_59934(v6, v5);
    goto LABEL_18;
  }
  if ( pWinMgr->bbb == 0xFFFFFFFF )
  {
    v6 = pWinMgr;
    v5 = 0;
    goto LABEL_17;
  }
LABEL_18:
  Q_WinMgr_StopAndReleaseAILTimer_sub_54664(pWinMgr);
  sub_1ACF4(&pWinMgr->cache);
  sub_2B2E0(&pWinMgr->LargeFont);
  sub_2B2E0(&pWinMgr->SmallFont);
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (00054448) --------------------------------------------------------
T_WinData *__fastcall Q_WinMgr_Init_sub_54448(P_WinMgr pWinMgr)
{
  __int16 i; // ax
  int v3; // edx
  T_WinData *result; // eax

  pWinMgr->_activeStateCount = 0;
  pWinMgr->wndsCnt = 0;
  pWinMgr->state = 0xFFFF;
  pWinMgr->Unknown_4756 = 0;
  pWinMgr->Unknown_4758 = 0;
  pWinMgr->messageQueueCount = 0;
  pWinMgr->counter1 = 0;
  pWinMgr->winEventSmallNum = 0;
  pWinMgr->_wndIndex = 0xFFFFFFFF;
  pWinMgr->timer = 0xFFFFFFFF;
  pWinMgr->gameEventsNum = 0;
  pWinMgr->Unknown_475C = 0;
  pWinMgr->j = 1.0;
  V_Timer_dword_132B58 = 0;
  memset(pWinMgr->winStates, 0, sizeof(pWinMgr->winStates));
  memset(pWinMgr, 0, 0x3000u);                         // pWinMgr->wnds
  memset(pWinMgr->b1, 0, sizeof(pWinMgr->b1));
  memset(pWinMgr->winEventsSmall, 0, sizeof(pWinMgr->winEventsSmall));
  memset(pWinMgr->z1c, 0, 0x18u);
  memset(pWinMgr->Unknown_4736, 0xFFFFFFFF, sizeof(pWinMgr->Unknown_4736));
  for ( i = 0; i < 32; ++i )
  {
    v3 = i;
    pWinMgr->winStates[v3].Unknown_0 = 0xFFFF;
    pWinMgr->winStates[v3].Unknown_84 = 0xFFFF;
  }
  pWinMgr->Unknown_489E = 0;
  pWinMgr->Unknown_48A2 = 0;
  pWinMgr->Unknown_24D9C = 0;
  pWinMgr->stealingCheatMode = 0;
  pWinMgr->Unknown_24DA4 = 0;
  pWinMgr->prevCornerIndex = 0xFFFFFFFF;
  pWinMgr->aaa = 0;
  pWinMgr->bbb = 0;
  pWinMgr->Unknown_48AE = 0;
  memset(pWinMgr->Unknown_21D82, 0x10, 0);             // BUG? 0x10 <-> 0
  result = pWinMgr->winDatas;
  pWinMgr->Unknown_21D82[0] = 0x3C;
  pWinMgr->winDatasNum = 0;
  memset(pWinMgr->winDatas, 0, sizeof(pWinMgr->winDatas));
  return result;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (000545EC) --------------------------------------------------------
unsigned int __fastcall Q_WINMGR_CPP_StartTimer_sub_545EC(P_WinMgr a1)
{
  HTIMER timer; // ebx
  HTIMER v3; // eax
  HTIMER v4; // edi

  timer = a1->timer;
  V_Timer_dword_132B58 = 0;
  if ( timer == 0xFFFFFFFF )
  {
    v3 = AIL_register_timer((AILTIMERCB)Q_TimerIncrease_sub_53DE4);
    a1->timer = v3;
    if ( v3 == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x1E5);
    }
    v4 = a1->timer;
    if ( v4 == 0xFFFFFFFF )
    {
      return 0;
    }
    AIL_set_timer_frequency(v4, 100u);
    AIL_start_timer(a1->timer);
  }
  return 0xFFFFFFFF;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00054664) --------------------------------------------------------
void __fastcall Q_WinMgr_StopAndReleaseAILTimer_sub_54664(P_WinMgr pWinMgr)
{
  if ( pWinMgr->timer != -1u )
  {
    AIL_stop_timer(pWinMgr->timer);
    AIL_release_timer_handle(pWinMgr->timer);
    pWinMgr->timer = -1u;
  }
}

//----- (0005469C) --------------------------------------------------------
int __fastcall sub_5469C(P_WinMgr pWinMgr)
{
  int bShift; // edi
  int wndIndex; // ecx
  int corner; // eax
  int mouseShapeNumber; // edx
  T_Wnd20HW *Wnd_sub_56DA8; // ecx
  LONG right; // eax
  unsigned int v8; // eax
  WORD v9; // ax
  P_Wnd13DBGWND pWnd13DBGWND; // eax
  int aaa; // edx
  int state; // eax
  unsigned int v13; // esi
  int v14; // ebx
  char v15; // dl
  int result; // eax
  int infoIndex; // [esp-4h] [ebp-30h]
  char helpTopic[44]; // [esp+0h] [ebp-2Ch] BYREF

  if ( pWinMgr->aaa == 0xFFFFFFFF || pWinMgr->bbb == 0xFFFFFFFF )
  {
    ++pWinMgr->_time;
  }
  bShift = V_Keyboard.Shift;
  pWinMgr->Unknown_48B2 = 0xFFFFFFFF;
  if ( !bShift || pWinMgr->Unknown_24DA4 || pWinMgr->Unknown_489E )
  {
    if ( pWinMgr->Unknown_24DA4 )
    {
      if ( !V_Keyboard.Shift )
      {
        pWinMgr->Unknown_24DA4 = 0;
        Q_GSystem_SetMousePointerShape_sub_2C7D0(&V_GSystem, 0, 0);
        wndIndex = pWinMgr->_wndIndex;
        if ( wndIndex != 0xFFFFFFFF )
        {
          Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, 6, 0, 0);
          Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 7, 0, 0);
        }
      }
    }
  }
  else
  {
    pWinMgr->Unknown_24DA4 = 0xFFFFFFFF;
    Q_GSystem_SetMousePointerShape_sub_2C7D0(&V_GSystem, 1, 0);
  }
  corner = -1;
  if ( !pWinMgr->Unknown_24DA4 && !pWinMgr->Unknown_489E && pWinMgr->state )
  {
    if ( V_Mouse.y )
    {
      if ( V_Mouse.y == 479 )
      {
        if ( V_Mouse.x )
        {
          if ( V_Mouse.x == 639 )
          {
            corner = 3;
          }
        }
        else
        {
          corner = 2;
        }
      }
    }
    else if ( V_Mouse.x )
    {
      if ( V_Mouse.x == 639 )
      {
        corner = 1;
      }
    }
    else
    {
      corner = 0;
    }
  }
  if ( corner != pWinMgr->prevCornerIndex )
  {
    mouseShapeNumber = 0;
    pWinMgr->prevCornerIndex = corner;
    if ( corner != -1 )
    {
      mouseShapeNumber = corner + 4;
    }
    Q_WinMgr_SetMousePointerShape_sub_5A270(pWinMgr, mouseShapeNumber, NULL, FALSE);
  }
  if ( V_Mouse.moved == TRUE )
  {
    if ( V_Mouse.moved == pWinMgr->aaa && pWinMgr->Unknown_48B2 )
    {
      Q_WinMgr_sub_59C80(pWinMgr, 0, 1, 0, V_Mouse.x, V_Mouse.y, 0);
      pWinMgr->Unknown_48B2 = 0;
    }
    sub_5691C(pWinMgr);
  }
  if ( !pWinMgr->Unknown_489E )
  {
    if ( pWinMgr->winEventSmallNum )
    {
      sub_56824(pWinMgr);
    }
    if ( pWinMgr->counter1 )
    {
      sub_56694(pWinMgr);
    }
  }
  if ( V_Keyboard.Pressed == TRUE )
  {
    if ( V_Keyboard.Pressed == pWinMgr->aaa && (!V_Keyboard.Alt || V_Keyboard.ScanCode != 0x13 && V_Keyboard.ScanCode != 0x19) )
    {
      Q_WinMgr_sub_59C80(pWinMgr, 0, 3, V_Keyboard.Flags, V_Keyboard.ScanCode, V_Keyboard.ASCIIChar, V_Keyboard.Alt);
    }
    // Scancode 0x19 = P
    if ( pWinMgr->bbb == TRUE && V_Keyboard.Ctrl && V_Keyboard.ScanCode == 0x19 )
    {
      infoIndex = V_TutorialInfoIndex;
      pWinMgr->bbb = FALSE;
      sprintf(helpTopic, "info%02d", infoIndex);
      Wnd_sub_56DA8 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", NULL);
      Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, byte_132B20, helpTopic);
      sub_552F8(pWinMgr, &Wnd_sub_56DA8->super, 0);
      V_Keyboard.Alt = FALSE;
      dword_132B14 = V_Mouse.left;
      right = V_Mouse.right;
      pWinMgr->bbb = TRUE;
      dword_132B18 = right;
      V_Keyboard.ScanCode = 0;
      ++V_TutorialInfoIndex;
    }
    v8 = TRUE;
    // Alt pressed or Esc
    if ( V_Keyboard.Alt == TRUE || V_Keyboard.ScanCode == 1 )
    {
      v8 = Q_WinMgr_AltScanCodes_sub_54D64(pWinMgr);
    }
    if ( v8 == TRUE )
    {
      sub_56BE8(pWinMgr, 3u, V_Keyboard.ASCIIChar, V_Keyboard.ScanCode, 0);
    }
  }
  if ( V_Mouse.leftClicked == TRUE )
  {
    if ( V_Mouse.leftClicked == pWinMgr->aaa && !V_Keyboard.Alt )
    {
      v9 = 0;
      if ( V_Mouse.left && V_Keyboard.Shift )
      {
        v9 = 1;
      }
      Q_WinMgr_sub_59C80(pWinMgr, 0, 2, v9, 0, V_Mouse.left, 0);
    }
    if ( V_Mouse.left )
    {
      if ( pWinMgr->prevCornerIndex == 0xFFFFFFFF )
      {
        if ( V_Keyboard.Alt == 0xFFFFFFFF )
        {
          V_DebugPickedColor = VFX_pixel_read(&V_GSystem.pane, V_Mouse.x, V_Mouse.y);
          pWnd13DBGWND = pWinMgr->pWnd13DBGWND;
          if ( pWnd13DBGWND->a2.Unknown_39 )
          {
            pWnd13DBGWND->a2.pProcs->proc3_msg(&pWnd13DBGWND->a2, 0x3F1u, 0, 0);
          }
        }
        else if ( pWinMgr->Unknown_24DA4 != 0xFFFFFFFF || pWinMgr->Unknown_489E )
        {
          sub_56BE8(pWinMgr, 4u, V_Mouse.x, V_Mouse.y, 0);
        }
        else
        {
          sub_56BE8(pWinMgr, 0xCu, V_Mouse.x, V_Mouse.y, 0);
        }
      }
      else if ( pWinMgr->Unknown_489E )
      {
        pWinMgr->Unknown_489E = 0;
        pWinMgr->Unknown_48A2 = 0xFFFFFFFF;
      }
      else
      {
        Q_SSystem_StartSample_sub_4FB90(&V_SSystem, 0);
        Q_WinMgr_SetMousePointerShape_sub_5A270(pWinMgr, 0, 0, 0);
        pWinMgr->prevCornerIndex = 0xFFFFFFFF;
        sub_570AC(pWinMgr, 0xFFFFFFFF);
      }
    }
  }
  if ( V_Mouse.rightClicked == 0xFFFFFFFF )
  {
    aaa = pWinMgr->aaa;
    if ( aaa == V_Mouse.rightClicked )
    {
      Q_WinMgr_sub_59C80(pWinMgr, V_Mouse.rightClicked ^ aaa, 2, 0, 1, V_Mouse.right, 0);
    }
    if ( V_Mouse.right )
    {
      if ( pWinMgr->Unknown_24DA4 == 0xFFFFFFFF )
      {
        pWinMgr->Unknown_24DA4 = 0;
        Q_GSystem_PreloadMouseShp_sub_2C744(&V_GSystem);
      }
      else
      {
        sub_56BE8(pWinMgr, 5u, V_Mouse.x, V_Mouse.y, 0);
      }
    }
  }
  while ( pWinMgr->messageQueueCount > 0 )
  {
    sub_55E80(pWinMgr);
  }
  if ( pWinMgr->gameEventsNum && pWinMgr->state == 1 && !pWinMgr->Unknown_489E )
  {
    sub_55B74(pWinMgr);
  }
  if ( pWinMgr->Unknown_24D9C == 0xFFFFFFFF && !pWinMgr->gameEventsNum && !pWinMgr->Unknown_489E )
  {
    Q_WinMgr_QueueMessage_sub_56B60(pWinMgr, 7, 0, 0);
  }
  if ( V_SSystem.a == 0xFFFFFFFF && !V_SSystem.musicOff )
  {
    if ( !V_SSystem.playing )
    {
      state = pWinMgr->state;
      if ( state != 7 && state != 0xD && state != 6 )
      {
        LOWORD(v13) = 0xFFFF;
        v14 = 0;
        if ( word_96BB0 != 0xFFFFFFFF && V_SSystem.files[word_96BB0].fpos )
        {
          v14 = 0xFFFFFFFF;
          LOWORD(v13) = word_96BB0;
          dword_96BB4 = 0;
        }
        if ( (__int16)v13 == 0xFFFFFFFF )
        {
          if ( word_96BB0 == 0xFFFFFFFF )
          {
            LOWORD(v13) = 0;
          }
          else
          {
            v13 = (V_Mouse.x + V_Timer_dword_132B58) % 5u;
            if ( (_WORD)v13 == word_96BB0 )
            {
              v13 = (word_96BB0 + 1) % 5;
            }
          }
        }
        sub_4F8CC(&V_SSystem, v13, v14);
        word_96BB0 = v13;
      }
    }
    if ( dword_96BB4 != 0xFFFFFFFF )
    {
      v15 = dword_96BB4++;
      Q_SSystem_SetVolume_sub_4FF4C(&V_SSystem, v15);
      if ( dword_96BB4 == 0x64 )
      {
        dword_96BB4 = 0xFFFFFFFF;
      }
    }
  }
  do
  {
    if ( V_SSystem.a == 0xFFFFFFFF && V_SSystem.a == V_SSystem.playing )
    {
      if ( V_SSystem.playing == V_SSystem.musicOff )
      {
        Q_SSystem_StopSample_sub_4FA1C(&V_SSystem);
      }
      else
      {
        Q_SSystem_PlayMusic_sub_4FAB4(&V_SSystem);
      }
    }
  }
  while ( (unsigned int)(V_Timer_dword_132B58 - dword_132B34) < 3 );
  result = V_Timer_dword_132B58;
  dword_132B34 = V_Timer_dword_132B58;
  return result;
}
// 96BB0: using guessed type __int16 word_96BB0;
// 96BB4: using guessed type int dword_96BB4;
// 132B14: using guessed type int dword_132B14;
// 132B18: using guessed type int dword_132B18;
// 132B1C: using guessed type int V_TutorialInfoIndex;
// 132B34: using guessed type int dword_132B34;
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00054D64) --------------------------------------------------------
// Returns FALSE if the key was handled and TRUE if it wasn't recognized or no action was taken
unsigned int __fastcall Q_WinMgr_AltScanCodes_sub_54D64(P_WinMgr pWinMgr)
{
  if ( V_Keyboard.ScanCode >= 0x20u )
  {
    // ScanCode 0x20 = D
    // Display coordinates
    if ( V_Keyboard.ScanCode <= 0x20u )
    {
      if ( V_CheatMode == TRUE )
      {
        V_ShowMousePosition = ~V_ShowMousePosition;
      }
    }
    else
    {
      if ( V_Keyboard.ScanCode >= 0x26u )
      {
        // ScanCode 0x26 = L
        // Load game
        if ( V_Keyboard.ScanCode <= 0x26u )
        {
          if ( !pWinMgr->Unknown_489E && pWinMgr->state != ASCEND_WINMGR_STATE_SHIP_DESIGN )
          {
            sub_56E9C(pWinMgr, ASCEND_WINMGR_STATE_LOAD_GAME, 0xFFFFFFFF);
            return FALSE;
          }
        }
        else
        {
          if ( V_Keyboard.ScanCode >= 0x31u )
          {
            // ScanCode 0x31 = N
            // Toggle sound effects
            if ( V_Keyboard.ScanCode <= 0x31u )
            {
              V_SSystem.soundEffectsOff = ~V_SSystem.soundEffectsOff;
              return FALSE;
            }
            // ScanCode 0x32 = M
            // Toggle music
            if ( V_Keyboard.ScanCode == 0x32 )
            {
              V_SSystem.musicOff = ~V_SSystem.musicOff;
              return FALSE;
            }
            return TRUE;
          }
          if ( V_Keyboard.ScanCode != 0x2D )
          {
            return TRUE;
          }
          // ScanCode 0x2D = X
          // Exit to DOS
          if ( !pWinMgr->Unknown_489E )
          {
            Q_GameLoop_dword_96774 = 0;
            return FALSE;
          }
        }
        return FALSE;
      }
      if ( V_Keyboard.ScanCode > 0x21u )
      {
        if ( V_Keyboard.ScanCode != 0x22 )
        {
          return TRUE;
        }
        // ScanCode 0x22 = G
        // Save screenshot
        Q_Cache_Free_sub_1B4D0(&pWinMgr->cache);
        Q_SaveScreenshot_sub_31C18((UBYTE *)pWinMgr->cache.pShapeCache, pWinMgr->cache.size);
        Q_Cache_Lock_sub_1ACE8(&pWinMgr->cache);
        return FALSE;
      }
      // ScanCode 0x21 = F
      // Toggle FPS
      if ( V_CheatMode == TRUE )
      {
        if ( V_CheatMode == pWinMgr->showFPS )
        {
          pWinMgr->showFPS = FALSE;
        }
        else
        {
          pWinMgr->showFPS = V_CheatMode;
        }
        return FALSE;
      }
    }
    return FALSE;
  }
  if ( V_Keyboard.ScanCode < 0x12u )
  {
    if ( V_Keyboard.ScanCode )
    {
      if ( V_Keyboard.ScanCode > 1u )
      {
        if ( V_Keyboard.ScanCode != 0x11 )
        {
          return TRUE;
        }
        // Scancode 0x11 = W
        // Display debug window
        if ( V_CheatMode == TRUE )
        {
          sub_552F8(pWinMgr, &pWinMgr->pWnd13DBGWND->a2, 0);
          return FALSE;
        }
        return FALSE;
      }
      // Scancode 0x01 = Esc
      if ( pWinMgr->Unknown_489E )
      {
        pWinMgr->Unknown_489E = 0;
        pWinMgr->Unknown_48A2 = 0;
        return FALSE;
      }
      if ( pWinMgr->state != ASCEND_WINMGR_STATE_PLANET_ALLOC )
      {
        sub_570AC(pWinMgr, TRUE);
        return FALSE;
      }
    }
    return TRUE;
  }
  // Scancode 0x12 = E
  // Toggle stealing mode
  if ( V_Keyboard.ScanCode <= 0x12u )
  {
    if ( V_CheatMode == TRUE )
    {
      pWinMgr->stealingCheatMode = ~pWinMgr->stealingCheatMode;
      return FALSE;
    }
    return FALSE;
  }
  if ( V_Keyboard.ScanCode < 0x19u )
  {
    if ( V_Keyboard.ScanCode != 0x13 )
    {
      return TRUE;
    }
    // Scancode 0x13 = R
    // Record WINEVENT
    if ( pWinMgr->bbb || V_CheatMode != TRUE )
    {
      return FALSE;
    }
    if ( pWinMgr->aaa )
    {
      Q_WinMgr_RecordWinEvents_sub_59934(pWinMgr, V_CheatMode);
    }
    else
    {
      srand(0);
      pWinMgr->j = 1.0;
      sub_59908(pWinMgr);
    }
    return FALSE;
  }
  else
  {
    if ( V_Keyboard.ScanCode > 0x19u )
    {
      if ( V_Keyboard.ScanCode != 0x1F )
      {
        return TRUE;
      }
      // Scancode 0x1F = S
      // Save game
      if ( !pWinMgr->Unknown_489E && pWinMgr->state != ASCEND_WINMGR_STATE_SHIP_DESIGN )
      {
        sub_56E9C(pWinMgr, ASCEND_WINMGR_STATE_SAVE_GAME, TRUE);
      }
      return FALSE;
    }
    // Scancode 0x19 = P
    // Play WINEVENT
    if ( pWinMgr->aaa || V_CheatMode != TRUE )
    {
      return FALSE;
    }
    if ( pWinMgr->bbb )
    {
      Q_WinMgr_RecordWinEvents_sub_59934(pWinMgr, FALSE);
    }
    else
    {
      Q_WinMgr_PlayWinEvents_sub_59988(pWinMgr, "WINEVENT.BIN", 0);
    }
    return FALSE;
  }
}
// 54D64: could not find valid save-restore pair for esi
// 96774: using guessed type int Q_GameLoop_dword_96774;
// 132B5C: using guessed type int V_ShowMousePosition;

//----- (0005508C) --------------------------------------------------------
void __fastcall Q_WinMgr_OverlayEffects_sub_5508C(P_WinMgr pWinMgr)
{
  int lastTimer; // esi
  unsigned int frameTimeDelta; // ebx
  int textY; // ebx
  char s[40]; // [esp+0h] [ebp-2Ch] BYREF
  P_WinMgr pWinMgr_; // [esp+28h] [ebp-4h]

  pWinMgr_ = pWinMgr;
  // FPS
  if ( pWinMgr->showFPS == TRUE )
  {
    // Every 10 frames
    if ( ++V_FPS.counter == 10 )
    {
      lastTimer = V_FPS.lastTimer;
      V_FPS.prevTimer = V_Timer_dword_132B58;
      V_FPS.lastTimer = V_Timer_dword_132B58;
      frameTimeDelta = V_Timer_dword_132B58 - lastTimer;
      V_FPS.counter = 0;
      // Prevent division by zero
      if ( V_Timer_dword_132B58 == lastTimer )
      {
        frameTimeDelta = 1;
      }
      sprintf("FPS DUDE", "FPS %lu  %lu", 1000 / frameTimeDelta, frameTimeDelta);
    }
    Q_Font_SetPaneRect_sub_2B3E0(&WinMgr.LargeFont, 25, 10, 150, 30);
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, "FPS DUDE", 0, 0xFFFF, 0xFFFF, 0);
  }
  // Mouse position
  if ( V_ShowMousePosition )
  {
    textY = 0;
    if ( V_Mouse.y < 240 )
    {
      textY = 460;
    }
    sprintf(s, "(%d,%d)", V_Mouse.x, V_Mouse.y);
    WinMgr.LargeFont.pane = V_GSystem.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, textY, s, 0, 0xFFFF, 0xFFFF, 0);
  }
  // Refresh pane list based on mouse state
  if ( V_Mouse.initialized == 1 )
  {
    MOUSE_pane_list_refresh(pWinMgr_->pPaneList);
  }
  else
  {
    VFX_pane_list_refresh(pWinMgr_->pPaneList);
  }
  VFX_pane_list_clear(pWinMgr_->pPaneList);
  // Handle palette fading effect
  if ( V_FadeEffect == TRUE )
  {
    Q_GSystem_FadePalette_sub_2C5E4(&V_GSystem, V_FadeIndex);
    if ( ++V_FadeIndex > 64 )
    {
      V_FadeIndex = 0;
      V_FadeEffect = 0;
    }
  }
}
// 132B58: using guessed type int V_Timer_dword_132B58;
// 132B5C: using guessed type int V_ShowMousePosition;
// 132B60: using guessed type int V_FadeEffect;
// 132B64: using guessed type int V_FadeIndex;

//----- (00055214) --------------------------------------------------------
void __fastcall Q_WinMgr_WipeAndAddDirtyArea_sub_55214(P_WinMgr pWinMgr, LONG x0, LONG y0, LONG x1, int y1)
{
  PANE pane; // [esp+0h] [ebp-18h] BYREF
  P_WinMgr pWinMgr_; // [esp+14h] [ebp-4h]

  pWinMgr_ = pWinMgr;
  pane.x0 = x0;
  pane.y1 = y1;
  pane.y0 = y0;
  pane.x1 = x1;
  pane.window = pWinMgr->window;
  VFX_pane_wipe(&pane, 0);
  Q_WinMgr_AddDirtyArea_sub_55274(pWinMgr_, x0, y0, x1, y1);
}

//----- (00055274) --------------------------------------------------------
void __fastcall Q_WinMgr_AddDirtyArea_sub_55274(P_WinMgr pWinMgr, int x0, int y0, int x1, int y1)
{
  if ( VFX_pane_list_add_area(pWinMgr->pPaneList, pWinMgr->window, x0, y0, x1, y1) == -1u )
  {
    VFX_pane_list_clear(pWinMgr->pPaneList);
    VFX_pane_list_add_area(pWinMgr->pPaneList, pWinMgr->window, 0, 0, 639, 479);
  }
}

//----- (000552CC) --------------------------------------------------------
void __fastcall Q_WinMgr_AddDirtyArea_sub_552CC(P_WinMgr pWinMgr, PANE *pPane)
{
  if ( pPane )
  {
    Q_WinMgr_AddDirtyArea_sub_55274(pWinMgr, pPane->x0, pPane->y0, pPane->x1, pPane->y1);
  }
  else
  {
    Q_WinMgr_AddDirtyArea_sub_55274(pWinMgr, 0, 0, 639, 479);
  }
}

//----- (000552F8) --------------------------------------------------------
int __fastcall sub_552F8(P_WinMgr pWinMgr, P_WndA2 a2, int a3)
{
  MACRO_VFX_BOOL selfPlayMode; // ebx
  P_Wnd25TW pWnd25TW; // eax
  P_Procs pProcs; // ebx
  int wndIndex; // ecx
  __int16 childrenNum; // di
  __int16 i; // cx
  __int16 j; // si
  int index; // edx
  int v12; // edi
  int result; // eax
  PANE pane; // [esp+0h] [ebp-20h] BYREF
  int Unknown_24D9C; // [esp+14h] [ebp-Ch]
  int v16; // [esp+18h] [ebp-8h]
  P_WndA2 v17; // [esp+1Ch] [ebp-4h]

  v17 = a2;
  v16 = a3;
  if ( pWinMgr->Unknown_489E )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x4CC);
  }
  selfPlayMode = V_SelfPlayMode;
  Unknown_24D9C = pWinMgr->Unknown_24D9C;
  pWinMgr->Unknown_24D9C = 0;
  if ( selfPlayMode == FALSE )
  {
    pWnd25TW = (T_Wnd25TW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "NEXTTURNCONT", 0);
    pProcs = pWnd25TW->a2.pProcs;
    pWnd25TW->buttonState = 0;
    pProcs->proc4_draw(&pWnd25TW->a2, 0);
  }
  wndIndex = pWinMgr->_wndIndex;
  if ( wndIndex != 0xFFFFFFFF )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, 6, 0, 0);
  }
  pWinMgr->_wndIndex = 0xFFFFFFFF;
  memset(byte_132B38, 1, sizeof(byte_132B38));
  sub_56BE8(pWinMgr, 0xFu, 0, 0, 0xFFFFFFFF);
  if ( dword_96BB8 == 0xFFFFFFFF )
  {
    Q_CopyPaneToBuffer_sub_54208(&v17->pane);
  }
  if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, v17->index, pWinMgr->state) != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x4EE);
  }
  childrenNum = v17->childrenNum;
  if ( childrenNum > 0 )
  {
    for ( i = 0; i < childrenNum; ++i )
    {
      if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, (*v17->children)[i]->index, pWinMgr->state) != 0xFFFFFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x4F4);
      }
    }
  }
  v17->pProcs->proc3_msg(v17, 0xC8, 0, 0);
  v17->pProcs->proc3_msg(v17, 1, 0, 0);
  sub_55618(pWinMgr);
  v17->pProcs->proc3_msg(v17, 2, 0, 0);
  for ( j = 0; j < childrenNum; ++j )
  {
    index = (*v17->children)[j]->index;
    sub_57310(pWinMgr, index, pWinMgr->state, v16);
  }
  pane = v17->pane;
  sub_57310(pWinMgr, v17->index, pWinMgr->state, v16);
  v12 = dword_96BB8;
  pWinMgr->_wndIndex = 0xFFFFFFFF;
  if ( v12 == 0xFFFFFFFF )
  {
    Q_CopyBufferToPane_sub_542B0(&pane);
  }
  sub_56BE8(pWinMgr, 0xEu, 0, 0, 0xFFFFFFFF);
  Q_WinMgr_AddDirtyArea_sub_552CC(pWinMgr, 0);
  if ( V_SelfPlayMode == 0xFFFFFFFF )
  {
    pWinMgr->Unknown_24D9C = Unknown_24D9C;
  }
  result = pWinMgr->Unknown_48A2;
  dword_96BB8 = 0xFFFFFFFF;
  return result;
}
// 96BB8: using guessed type int dword_96BB8;

//----- (00055554) --------------------------------------------------------
void __fastcall sub_55554(int a1, _DWORD *a2)
{
  SCRNVERTEX vlist; // [esp+0h] [ebp-6Ch] BYREF
  int v3; // [esp+18h] [ebp-54h]
  int v4; // [esp+1Ch] [ebp-50h]
  int v5; // [esp+30h] [ebp-3Ch]
  int v6; // [esp+34h] [ebp-38h]
  int v7; // [esp+48h] [ebp-24h]
  int v8; // [esp+4Ch] [ebp-20h]

  v3 = 0x27F;
  v5 = 0x27F;
  v6 = 0x1DF;
  v8 = 0x1DF;
  vlist.x = 0;
  vlist.y = 0;
  v4 = 0;
  v7 = 0;
  VFX_translate_polygon(&V_GSystem.pane, 4, &vlist, V_GSystem.hazeTables);
  vlist.x = a2[1] + 0x14;
  vlist.y = a2[2] + 0x14;
  v3 = a2[3] + 0x14;
  v4 = a2[2] + 0x14;
  v5 = a2[3] + 0x14;
  v6 = a2[4] + 0x14;
  v7 = a2[1] + 0x14;
  v8 = a2[4] + 0x14;
  VFX_translate_polygon(&V_GSystem.pane, 4, &vlist, (*V_GSystem.hazeTables)[7]);
}

//----- (00055618) --------------------------------------------------------
void __fastcall sub_55618(P_WinMgr a1)
{
  int v2; // ebx

  if ( a1->Unknown_489E )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x57E);
  }
  a1->Unknown_489E = 0xFFFFFFFF;
  v2 = Q_GameLoop_dword_96774;
  a1->Unknown_48A2 = 0;
  if ( v2 == 0xFFFFFFFF )
  {
    do
    {
      if ( a1->Unknown_489E != 0xFFFFFFFF )
      {
        break;
      }
      if ( WinMgr.bbb == 0xFFFFFFFF )
      {
        sub_59B80(&WinMgr);
      }
      else
      {
        Q_ProcessInput_sub_2656C(&V_InputSystem);
      }
      sub_5469C(&WinMgr);
      Q_WinMgr_OverlayEffects_sub_5508C(&WinMgr);
      if ( WinMgr.bbb )
      {
        sub_59A54(&WinMgr);
      }
    }
    while ( Q_GameLoop_dword_96774 == 0xFFFFFFFF );
  }
  V_Mouse.leftClicked = 0;
  V_Mouse.rightClicked = 0;
  V_Keyboard.Pressed = 0;
}
// 96774: using guessed type int Q_GameLoop_dword_96774;

//----- (000556CC) --------------------------------------------------------
void __fastcall Q_WinMgr_ShowMsgBox_sub_556CC(P_WinMgr pWinMgr, char *a2)
{
  T_Wnd26MW *ctrBox; // eax
  T_Wnd26MW *v5; // edx
  T_WndA2 *ctrBox_1; // ecx
  T_WndA2 *ctrBut; // eax
  P_WndA2 ctrBut_1; // edx
  char *sub_1CEA8; // eax
  WINDOW *window; // eax

  ctrBox = (T_Wnd26MW *)operator new(0xB3u);
  if ( ctrBox )
  {
    Q_Wnd26MW_Ctor_sub_2FA18(ctrBox);
  }
  Q_RegisterDataInWinMgr_sub_2625C(ctrBox, 2, "MSGBOX");
  v5 = ctrBox;
  ctrBox_1 = &ctrBox->a2;
  Q_RegisterWindowInWinMgr_sub_2C978(&ctrBox->a2);
  v5->a2._mouseFocus = 0;
  v5->a2.pane.y0 = 0x32;
  v5->a2.pane.y1 = 0x12C;
  v5->Unknown_AB = (int)a2;
  v5->a2.pane.x0 = v5->a2.pane.y0;
  v5->a2.pane.x1 = v5->a2.pane.y1;
  v5->a2.pane.window = pWinMgr->window;
  ctrBut = (T_WndA2 *)operator new(0xABu);
  if ( ctrBut )
  {
    Q_WndA2_Ctor_sub_2C830(ctrBut);
  }
  Q_RegisterDataInWinMgr_sub_2625C(ctrBut, 2, "MSGBOXBUTTON");
  ctrBut_1 = ctrBut;
  Q_RegisterWindowInWinMgr_sub_2C978(ctrBut);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);
  strcpy(ctrBut_1->name, sub_1CEA8);
  ctrBut_1->pane.y0 = 0x104;
  ctrBut_1->pane.y1 = 0x122;
  ctrBut_1->pane.x0 = ctrBut_1->pane.y0;
  ctrBut_1->pane.x1 = ctrBut_1->pane.y1;
  window = pWinMgr->window;
  ctrBut_1->_mouseFocus = 0xFFFFFFFF;
  ctrBut_1->sendMessage = 0xC9;
  ctrBut_1->pane.window = window;
  ctrBut_1->parentIndex = ctrBox_1->index;
  Q_GWINDOW_CPP_LinkChild_sub_2C990(ctrBox_1, ctrBut_1);
  sub_552F8(pWinMgr, ctrBox_1, 0xFFFFFFFF);
}
/* Orphan comments:
30: "OK"
*/

//----- (000557D4) --------------------------------------------------------
char *__fastcall sub_557D4(T_WinMgr *pWinMgr, char *wndName, const char *newText, WORD maxTextLength)
{
  T_WndA2 *v5; // eax
  T_WndA2 *v6; // ecx
  T_WndA2 *v7; // ebp
  int v8; // ebx
  int v9; // eax
  P_WinMgr v10; // eax
  T_WndA2 *v11; // eax
  T_WndA2 *v12; // ebx
  char *sub_1CEA8; // eax
  char *v14; // eax
  WINDOW *window; // eax
  T_WndEDITWND *v16; // eax
  P_Wnd v17; // edx
  T_WndEDITWND *v18; // edx
  LONG v19; // eax
  LONG v20; // ebx
  int index; // eax
  void *ShapeTable_sub_1B084; // eax
  PANE pane; // [esp+0h] [ebp-3Ch] BYREF
  T_WndA2 *v25; // [esp+14h] [ebp-28h]
  int v26; // [esp+18h] [ebp-24h]
  char *pNewText; // [esp+1Ch] [ebp-20h]
  LONG Height_sub_2B594; // [esp+20h] [ebp-1Ch]
  P_WinMgr pWinMgr_; // [esp+24h] [ebp-18h]
  P_Wnd v30; // [esp+28h] [ebp-14h]
  WORD v31; // [esp+2Ch] [ebp-10h]

  pWinMgr_ = pWinMgr;
  pNewText = (char *)newText;
  v31 = maxTextLength;
  Height_sub_2B594 = Q_Font_GetHeight_sub_2B594(&WinMgr.LargeFont);
  v26 = 5 * Height_sub_2B594 + 5;
  v5 = (T_WndA2 *)operator new(0xABu);
  if ( v5 )
  {
    Q_WndA2_Ctor_sub_2C830(v5);
  }
  Q_RegisterDataInWinMgr_sub_2625C(v5, 2, "INPUTBOX");
  v6 = v5;
  v7 = v5;
  Q_RegisterWindowInWinMgr_sub_2C978(v5);
  strncpy(v6->name, wndName, 19u);
  v8 = v26;
  v6->pane.x0 = 242;
  v6->pane.x1 = 397;
  v9 = (480 - v8) / 2;
  v6->name[19] = 0;
  v6->_x = 0xFFFF;
  v6->pane.y0 = v9;
  v6->pane.y1 = v8 + v9;
  v10 = pWinMgr_;
  v6->_y = 5;
  v6->pane.window = v10->window;
  v11 = (T_WndA2 *)operator new(0xABu);
  if ( v11 )
  {
    Q_WndA2_Ctor_sub_2C830(v11);
  }
  Q_RegisterDataInWinMgr_sub_2625C(v11, 2, "MSGBOXBUTTON");
  v12 = v11;
  v25 = v11;
  Q_RegisterWindowInWinMgr_sub_2C978(v11);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);// 30: "OK"
  strcpy(v12->name, sub_1CEA8);
  v12->_x = 0xFFFF;
  v12->_y = 2;
  v14 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);      // 30: "OK"
  v12->pane.x0 = v7->pane.x1 - Q_Font_GetTextWidth_sub_2B4F4(&WinMgr.LargeFont, v14) - 0xA;
  v12->pane.x1 = v7->pane.x1 - 3;
  v12->pane.y0 = v7->pane.y1 - Height_sub_2B594 - 5;
  v12->pane.y1 = v7->pane.y1 - 2;
  window = pWinMgr_->window;
  v12->_mouseFocus = 0xFFFFFFFF;
  v12->framed = 0xFFFFFFFF;
  v12->sendMessage = 0xC9;
  v12->pane.window = window;
  v12->parentIndex = v7->index;
  Q_GWINDOW_CPP_LinkChild_sub_2C990(v7, v12);
  v16 = (T_WndEDITWND *)operator new(0xC1u);
  if ( v16 )
  {
    Q_WndEDITWND_Ctor_sub_2F48C(v16);
  }
  Q_RegisterDataInWinMgr_sub_2625C(v16, 2, "EDITWND");
  v30 = (P_Wnd)v16;
  if ( !v16 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x5F7);
  }
  Q_RegisterWindowInWinMgr_sub_2C978((P_WndA2)v30);
  v17 = v30;
  v30->pane.x0 = v7->pane.x0 + 0xF;
  v17->pane.x1 = v7->pane.x1 - 0xF;
  v18 = (T_WndEDITWND *)v30;
  v19 = Height_sub_2B594 + v7->pane.y0 + 8;
  v20 = Height_sub_2B594;
  v30->pane.y0 = v19;
  v18->a2.pane.y1 = v20 + v19 + 8;
  v18->a2.pane.window = pWinMgr_->window;
  LOWORD(v20) = v31;
  index = v7->index;
  v18->a2.sendMessage = 0;
  v18->a2.parentIndex = index;
  Q_WndEDITWND_SetNewText_sub_2F9A4(v18, pNewText, v20);
  Q_GWINDOW_CPP_LinkChild_sub_2C990(v7, (P_WndA2)v30);
  pane = v7->pane;
  dword_96BB8 = 0;
  pane.x0 -= 8;
  pane.x1 += 8;
  pane.y0 -= 8;
  pane.y1 += 7;
  Q_CopyPaneToBuffer_sub_54208(&pane);
  Q_WinMgr_AddDirtyArea_sub_552CC(pWinMgr_, &pane);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x25]);
  VFX_shape_draw(&pane, ShapeTable_sub_1B084, 1, 0, 0);
  sub_552F8(pWinMgr_, v7, 0);
  Q_CopyBufferToPane_sub_542B0(&pane);
  Q_WinMgr_AddDirtyArea_sub_552CC(pWinMgr_, &pane);
  sub_57530(pWinMgr_, v25->index, 0);
  sub_57530(pWinMgr_, v30->index, 0);
  sub_57530(pWinMgr_, v7->index, 0);
  return pNewText;
}
// 96BB8: using guessed type int dword_96BB8;

//----- (00055AEC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_WinMgr_AddGameEvent_sub_55AEC(P_WinMgr pWinMgr, int eventId, int p1, int p2)
{
  int gameEventsNum; // edx

  if ( V_SelfPlayMode == TRUE )
  {
    return FALSE;
  }
  gameEventsNum = pWinMgr->gameEventsNum;
  if ( gameEventsNum == 32 )
  {
    return FALSE;
  }
  pWinMgr->gameEvents[gameEventsNum].eventId = eventId;
  pWinMgr->gameEvents[pWinMgr->gameEventsNum].p1 = p1;
  pWinMgr->gameEvents[pWinMgr->gameEventsNum++].p2 = p2;
  return TRUE;
}

//----- (00055B74) --------------------------------------------------------
void __fastcall sub_55B74(P_WinMgr pWinMgr)
{
  P_Wnd23EW pWnd23EW; // eax
  P_Wnd23EW v3; // ebp
  __int16 v4; // di
  P_Location pLocation; // ebp
  unsigned int eventId; // ecx
  P_Ship pShip; // eax
  bool v8; // zf
  __int16 v9; // dx
  WORD gameEventsNum; // bx
  int v11; // [esp+8h] [ebp-20h]
  int p2; // [esp+Ch] [ebp-1Ch]

  if ( dword_10AE6C == 0xFFFFFFFF || !pWinMgr->gameEventsNum || pWinMgr->state != 1 )
  {
    return;
  }
  pWnd23EW = (T_Wnd23EW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "EVENTWIN", 0);
  v3 = pWnd23EW;
  if ( !pWnd23EW )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x63B);
  }
  sub_26874(pWnd23EW, &pWinMgr->gameEvents[pWinMgr->Unknown_475C]);
  dword_10AE6C = 0xFFFFFFFF;
  v11 = 0;
  if ( V_SelfPlayMode == FALSE )
  {
    v11 = sub_552F8(pWinMgr, &v3->a2, 0);
  }
  v4 = 0;
  dword_10AE6C = 0;
  if ( !v11 )
  {
    goto LABEL_47;
  }
  eventId = pWinMgr->gameEvents[pWinMgr->Unknown_475C].eventId;
  pShip = (P_Ship)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
  p2 = pWinMgr->gameEvents[pWinMgr->Unknown_475C].p2;
  if ( eventId < ASCEND_EP_BADSHIPENTERS )
  {
    if ( eventId >= ASCEND_EP_SHIPARRIVE )
    {
      goto LABEL_16;
    }
    if ( !pWinMgr->gameEvents[pWinMgr->Unknown_475C].eventId )
    {
      v8 = 1;
      goto LABEL_45;
    }
    if ( eventId > 1 )
    {
      v4 = 0xD;
      byte_968DD = pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
      goto LABEL_47;
    }
    goto LABEL_10;
  }
  if ( eventId <= ASCEND_EP_BADSHIPENTERS )
  {
    goto LABEL_16;
  }
  if ( eventId >= 0x14 )
  {
    if ( eventId > 0x14 )
    {
      if ( eventId < 0x17 )
      {
        v8 = eventId == ASCEND_EP_22_XENO_COMPLETE;
      }
      else
      {
        if ( eventId <= 0x17 )
        {
          v4 = 0xD;
          byte_968DD = pWinMgr->gameEvents[pWinMgr->Unknown_475C].p2;
          goto LABEL_47;
        }
        v8 = eventId == ASCEND_EP_25_FIRST_LAB;
      }
LABEL_45:
      if ( v8 )
      {
        v4 = 0x14;
      }
      goto LABEL_47;
    }
LABEL_16:
    if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x6A8);
    }
    pLocation.pPlanet = (P_Planet)pShip->pLocation;
    if ( (eventId == ASCEND_EP_FINDRACE || eventId == ASCEND_EP_RACEFINDUS) && v11 != 2 )
    {
      v4 = 0xD;
      if ( Q_Race_CalculateShipsAtLocation_sub_45958(&V_Game.races[p2], ASCEND_TREATY_WAR, pLocation, 0) )
      {
        V_Game.races[p2].Unknown_1E9 = 1;
        V_Game.races[p2].Unknown_1EA = (int)pLocation.pPlanet;
      }
      else
      {
        V_Game.races[p2].Unknown_1E9 = 0;
      }
      byte_968DD = p2;
    }
    else
    {
      v4 = 0x10;
      V_Game.pCurStar = pShip->pLocation.pStar;
    }
    goto LABEL_47;
  }
  if ( eventId >= ASCEND_EP_16_ENTERED_ORBIT )
  {
    if ( eventId <= ASCEND_EP_18_REFIT_COMPLETE )
    {
      v4 = 0x11;
      V_Game.pCurPlanet = (P_Planet)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p2;
    }
    else if ( v11 == 1 )
    {
      v4 = 0x10;
      V_Game.pCurStar = (P_Star)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
    }
    else if ( p2 == 7 )
    {
      Q_WinMgr_QueueMessage_sub_56B60(pWinMgr, 7, 0, 0);
    }
    else
    {
      pWinMgr->Unknown_24D9C = 0xFFFFFFFF;
    }
    goto LABEL_47;
  }
  if ( eventId == ASCEND_EP_15_HAS_FREE_POPULATION )
  {
LABEL_10:
    v4 = 0x11;
    V_Game.pCurPlanet = (P_Planet)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
  }
LABEL_47:
  v9 = pWinMgr->Unknown_475C + 1;
  gameEventsNum = pWinMgr->gameEventsNum;
  pWinMgr->Unknown_475C = v9;
  if ( v9 == gameEventsNum )
  {
    pWinMgr->Unknown_475C = 0;
    pWinMgr->gameEventsNum = 0;
  }
  if ( v4 )
  {
    Q_WinMgr_QueueMessage_sub_56B60(pWinMgr, 1, v4, 1);
  }
}
// 968DD: using guessed type char byte_968DD;
// 10AE6C: using guessed type int dword_10AE6C;

//----- (00055E80) --------------------------------------------------------
void __fastcall sub_55E80(P_WinMgr pWinMgr)
{
  T_HelpItem *pText; // edx
  WORD messageQueueCount; // ax
  int v4; // eax
  LONG param1; // ecx
  T_Star *v6; // ebx
  int v7; // ecx
  __int16 i; // si
  T_Star *v9; // eax
  T_Wnd20HW *v10; // ecx
  T_Wnd20HW *v11; // esi
  char Unknown_04; // bl
  int v13; // eax
  T_Wnd20HW *v14; // esi
  char v15; // dl
  int v16; // eax
  UBYTE v17; // al
  T_Wnd20HW *v18; // eax
  char format[600]; // [esp+0h] [ebp-53Ch] BYREF
  char v20[600]; // [esp+258h] [ebp-2E4h] BYREF
  char s[28]; // [esp+4B0h] [ebp-8Ch] BYREF
  char helptopic[28]; // [esp+4CCh] [ebp-70h] BYREF
  char v23[28]; // [esp+4E8h] [ebp-54h] BYREF
  T_HelpItem *v24; // [esp+504h] [ebp-38h]
  T_HelpItem *v25; // [esp+508h] [ebp-34h]
  T_HelpItem *v26; // [esp+50Ch] [ebp-30h]
  T_HelpItem *helpItems; // [esp+510h] [ebp-2Ch]
  LONG param2; // [esp+514h] [ebp-28h]
  T_Wnd22AW *Wnd_sub_56DA8; // [esp+518h] [ebp-24h]
  int v30; // [esp+51Ch] [ebp-20h]
  int v31; // [esp+520h] [ebp-1Ch]

  HIWORD(pText) = 0;
  qmemcpy(&pWinMgr->messageQueue[0x20], pWinMgr->messageQueue, 0x140u);
  messageQueueCount = pWinMgr->messageQueueCount;
  v30 = (unsigned __int16)messageQueueCount;
  pWinMgr->messageQueueCount = 0;
  LOWORD(v31) = 0;
  if ( messageQueueCount > 0 )
  {
    do
    {
      v4 = (__int16)v31;
      LOWORD(pText) = pWinMgr->messageQueue[v4 + 0x20].message;
      param1 = pWinMgr->messageQueue[v4 + 0x20].param1;
      param2 = pWinMgr->messageQueue[v4 + 0x20].param2;
      switch ( (__int16)pText )
      {
        case 0:
          break;
        case 1:
          pText = (T_HelpItem *)(__int16)param1;
          sub_56E9C(pWinMgr, param1, (param2 == 0) - 1);
          break;
        case 2:
          HIWORD(pText) = 0;
          Q_GameLoop_dword_96774 = 0;
          break;
        case 3:
          HIWORD(pText) = 0xFFFF;
          sub_570AC(pWinMgr, 0xFFFFFFFF);
          break;
        case 4:
          if ( !pWinMgr->aaa && !pWinMgr->bbb )
          {
            pText = (T_HelpItem *)"WINEVENT.BIN";
            Q_WinMgr_PlayWinEvents_sub_59988(pWinMgr, "WINEVENT.BIN", 0xFFFFFFFF);
          }
          break;
        case 5:
          switch ( param2 )
          {
            case 1:
              pText = (T_HelpItem *)"ABILITYWIN";
              Wnd_sub_56DA8 = (T_Wnd22AW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "ABILITYWIN", 0);
              Q_Wnd22AW_ShowHelpTopicAbil_sub_33884(Wnd_sub_56DA8);
              break;
            case 2:
              v10 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = (T_Wnd22AW *)v10;
              sprintf(s, "STATE%02d", pWinMgr->state);
              pText = (T_HelpItem *)"help.txt";
              Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(v10, "help.txt", s);
              break;
            case 3:
              pText = (T_HelpItem *)"help.txt";
              Wnd_sub_56DA8 = (T_Wnd22AW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(&Wnd_sub_56DA8->super, "help.txt", "NOINTRO");
              break;
            case 4:
              sprintf(helptopic, "gizmo%02d", param1);
              pText = (T_HelpItem *)"gizhelp.txt";
              v11 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = (T_Wnd22AW *)v11;
              Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(v11, "gizhelp.txt", helptopic);
              Unknown_04 = v11->helpItems[0].Unknown_04;
              helpItems = v11->helpItems;
              v24 = &v11->helpItems[1];
              if ( Unknown_04 != 1 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x784);
              }
              if ( v24->Unknown_04 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x785);
              }
              strcpy(format, helpItems->pText);
              sprintf(helpItems->pText, format, &V_Gizmos[param1]);
              v13 = (int)v24;
              v24->x0 = 0x1C;
              *(_WORD *)(v13 + 3) = param1;
              break;
            case 5:
              sprintf(v23, "plitem%02d", param1);
              v14 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = (T_Wnd22AW *)v14;
              Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(v14, "planhelp.txt", v23);
              v15 = v14->helpItems[0].Unknown_04;
              v26 = v14->helpItems;
              v25 = &v14->helpItems[1];
              if ( v15 != 1 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x79F);
              }
              if ( v25->Unknown_04 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x7A0);
              }
              strcpy(v20, v26->pText);
              pText = (T_HelpItem *)v26->pText;
              sprintf(&pText->Unknown_04, v20, V_PlanetItems.item[param1].name);
              if ( param1 == 0x17 )
              {
                pText = v25;
                v17 = V_PlayerRaceIndex;
                v25->y0 = 0;
                pText->x0 = v17 + 0xE;
              }
              else
              {
                v16 = (int)v25;
                v25->x0 = 0x1E;
                *(_WORD *)(v16 + 3) = param1;
              }
              break;
            default:
              pText = (T_HelpItem *)"HELPWINDOW";
              v18 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = (T_Wnd22AW *)v18;
              if ( param1 )
              {
                pText = (T_HelpItem *)"help.txt";
                Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(v18, "help.txt", (char *)param1);
              }
              break;
          }
          if ( !pWinMgr->Unknown_489E )
          {
            HIWORD(pText) = HIWORD(Wnd_sub_56DA8);
            sub_552F8(pWinMgr, &Wnd_sub_56DA8->super.super, 0);
          }
          if ( param2 == 1 )
          {
            pText = (T_HelpItem *)((T_Wnd02COSW *)Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, "COSMOSWnd", 0))->a.index;
            Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, (int)pText, 0xD, 0, 0);
          }
          break;
        case 6:
          pWinMgr->Unknown_489E = 0;
          pWinMgr->Unknown_48A2 = param1;
          break;
        case 7:
          v6 = sub_20B3C(&V_Game);
          if ( v6 )
          {
            v7 = 7;
            if ( *(int *)((char *)&pWinMgr->wnds[0].activeCount + (_DWORD)&loc_24D9B + 1) == 0xFFFFFFFF )
            {
              v7 = 8;
            }
            HIWORD(pText) = 0;
            Q_WinMgr_AddGameEvent_sub_55AEC(pWinMgr, 0x13, (int)v6, v7);
          }
          else
          {
            sub_20C94(&V_Game, (int)pText, 0, param1);
            if ( *(int *)((char *)&pWinMgr->wnds[0].activeCount + (_DWORD)&loc_24D9E + 2) == 0xFFFFFFFF )
            {
              for ( i = 0; i < V_Game.racesNum; ++i )
              {
                if ( i != V_PlayerRaceIndex )
                {
                  sub_46130(&V_Game.races[V_PlayerRaceIndex].index, i, 0xFFFFFFFF);
                  sub_45F60(&V_Game.races[V_PlayerRaceIndex].index, i, 0xFFFFFFFF);
                }
              }
            }
            HIWORD(pText) = 0;
            sub_56BE8(pWinMgr, 0xDu, 0, 0, 0);
            Q_WinMgr_OverlayEffects_sub_5508C(pWinMgr);
          }
          break;
        case 8:
          v9 = sub_20B3C(&V_Game);
          if ( !v9 || V_SelfPlayMode )
          {
            pWinMgr->Unknown_24D9C = ~pWinMgr->Unknown_24D9C;
          }
          else
          {
            HIWORD(pText) = 0;
            Q_WinMgr_AddGameEvent_sub_55AEC(pWinMgr, 0x13, (int)v9, (__int16)pText);
          }
          break;
        default:
          pText = (T_HelpItem *)"..\\winmgr.cpp";
          Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x7D7);
          break;
      }
      LOWORD(v31) = v31 + 1;
    }
    while ( (__int16)v31 < (__int16)v30 );
  }
}
// 96774: using guessed type int Q_GameLoop_dword_96774;

//----- (00056400) --------------------------------------------------------
void __fastcall Q_WinMgr_sub_56400(T_WinMgr *pWinMgr, int a2, __int16 a3, int a4, int a5, int a6)
{
  __int16 i; // ax
  __int16 v9; // kr00_2
  int v10; // eax

  if ( pWinMgr->counter1 == 0x10 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x7ED);
  }
  if ( pWinMgr->aaa == 0xFFFFFFFF || pWinMgr->bbb == 0xFFFFFFFF )
  {
    a6 = 0;
  }
  for ( i = 0; i < 0x10; ++i )
  {
    v9 = i;
    if ( !pWinMgr->b1[i].a )
    {
      pWinMgr->b1[i].a = a2;
      pWinMgr->b1[i].c = a4;
      pWinMgr->b1[i].b = a3;
      pWinMgr->b1[i].d = a5;
      v10 = V_Timer_dword_132B58;
      pWinMgr->b1[v9].e = a6;
      pWinMgr->b1[v9].f = a6 + v10;
      ++pWinMgr->counter1;
      break;
    }
  }
  Q_WinMgr_sub_59C80(pWinMgr, a2, 4, a3, a4, a5, 0);
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (000564C0) --------------------------------------------------------
void __fastcall Q_WinMgr_sub_564C0(T_WinMgr *pWinMgr, int a2, __int16 a3)
{
  __int16 i; // dx

  for ( i = 0; i < 0x10; ++i )
  {
    if ( a2 == pWinMgr->b1[i].a && (a3 == 0xFFFFFFFF || a3 == pWinMgr->b1[i].b) )
    {
      pWinMgr->b1[i].a = 0;
      --pWinMgr->counter1;
    }
  }
  Q_WinMgr_sub_59C80(pWinMgr, a2, 5, a3, 0, 0, 0);
}

//----- (00056528) --------------------------------------------------------
int __fastcall sub_56528(P_WinMgr pWinMgr, int a2, __int16 a3)
{
  __int16 i; // ax

  for ( i = 0; i < 16; ++i )
  {
    if ( a2 == pWinMgr->b1[i].a && a3 == pWinMgr->b1[i].b )
    {
      return pWinMgr->b1[i].e;
    }
  }
  return 0xFFFF;
}

//----- (00056564) --------------------------------------------------------
unsigned int __fastcall sub_56564(P_WinMgr pWinMgr, int a2, __int16 a3, int a4)
{
  __int16 i; // dx

  for ( i = 0; i < 16; ++i )
  {
    if ( a2 == pWinMgr->b1[i].a && a3 == pWinMgr->b1[i].b )
    {
      pWinMgr->b1[i].e = a4;
      return 0xFFFFFFFF;
    }
  }
  return 0;
}

//----- (00056694) --------------------------------------------------------
int __fastcall sub_56694(T_WinMgr *a1)
{
  __int16 counter1; // di
  int result; // eax
  T_SomeStruct5 *v4; // esi
  void (__fastcall *a)(int, int); // edx
  T_SomeStruct5 *b1; // [esp+4h] [ebp-20h]
  __int16 i; // [esp+8h] [ebp-1Ch]

  counter1 = a1->counter1;
  b1 = a1->b1;
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= 0x10 || counter1 <= 0 )
    {
      break;
    }
    v4 = &b1[i];
    a = (void (__fastcall *)(int, int))v4->a;
    if ( v4->a )
    {
      if ( (unsigned int)V_Timer_dword_132B58 >= v4->f )
      {
        if ( v4->b == 0x29A )
        {
          a(v4->c, v4->d);
        }
        else
        {
          Q_WinMgr_DispatchMessageProc3_sub_56D30(a1, (int)a, v4->b, v4->c, v4->d);
        }
        v4->f += v4->e;
      }
      --counter1;
    }
  }
  return result;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00056728) --------------------------------------------------------
void __fastcall Q_WinMgr_AddWinEventSmall_sub_56728(P_WinMgr pWinMgr, int hwnd, int f, WORD msg, int p1, int p2)
{
  __int16 i; // ax

  if ( pWinMgr->winEventSmallNum == 16 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x8C6);
  }
  for ( i = 0; i < 16; ++i )
  {
    if ( !pWinMgr->winEventsSmall[i].hwnd )
    {
      pWinMgr->winEventsSmall[i].hwnd = hwnd;
      pWinMgr->winEventsSmall[i].f = f;
      pWinMgr->winEventsSmall[i].msg = msg;
      pWinMgr->winEventsSmall[i].p1 = p1;
      pWinMgr->winEventsSmall[i].p2 = p2;
      ++pWinMgr->winEventSmallNum;
      break;
    }
  }
  Q_WinMgr_sub_59C80(pWinMgr, hwnd, EVT_REQ_CHANGE, msg, p1, p2, f);
}

//----- (000567BC) --------------------------------------------------------
void __fastcall Q_WinMgr_RemoveWinEventSmall_sub_567BC(P_WinMgr a1, int hwnd, WORD message)
{
  __int16 i; // dx

  for ( i = 0; i < 16; ++i )
  {
    if ( hwnd == a1->winEventsSmall[i].hwnd && (message == 0xFFFFFFFF || message == a1->winEventsSmall[i].msg) )
    {
      a1->winEventsSmall[i].hwnd = 0;
      --a1->winEventSmallNum;
    }
  }
  Q_WinMgr_sub_59C80(a1, hwnd, EVT_CAN_CHANGE, message, 0, 0, 0);
}

//----- (00056824) --------------------------------------------------------
void __fastcall sub_56824(P_WinMgr pWinMgr)
{
  int hwnd; // edi
  int v3; // [esp+0h] [ebp-28h]
  int v4; // [esp+4h] [ebp-24h]
  __int16 i; // [esp+8h] [ebp-20h]
  WORD winEventSmallNum; // [esp+Ch] [ebp-1Ch]

  winEventSmallNum = pWinMgr->winEventSmallNum;
  v4 = 0;
  v3 = 0;
  if ( V_Mouse.leftClicked == TRUE )
  {
    v4 = 1;
  }
  if ( V_Mouse.rightClicked == TRUE )
  {
    LOBYTE(v4) = v4 | 2;
  }
  if ( V_Mouse.moved == TRUE )
  {
    LOBYTE(v3) = 4;
  }
  for ( i = 0; i < 16 && winEventSmallNum > 0; ++i )
  {
    hwnd = pWinMgr->winEventsSmall[i].hwnd;
    if ( hwnd )
    {
      if ( (v4 & pWinMgr->winEventsSmall[i].f) != 0 )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(
          pWinMgr,
          pWinMgr->winEventsSmall[i].hwnd,
          pWinMgr->winEventsSmall[i].msg,
          pWinMgr->winEventsSmall[i].p1,
          pWinMgr->winEventsSmall[i].p2);
      }
      if ( (v3 & pWinMgr->winEventsSmall[i].f) != 0 )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, hwnd, pWinMgr->winEventsSmall[i].msg, V_Mouse.x, V_Mouse.y);
      }
      --winEventSmallNum;
    }
  }
}

//----- (0005691C) --------------------------------------------------------
void __fastcall sub_5691C(P_WinMgr pWinMgr)
{
  LONG x; // edi
  int v3; // edx
  LONG y; // ebp
  T_WndA2 *pWndA2; // ecx
  __int16 v6; // dx
  P_WndA2 v7; // eax
  LONG x1; // ebx
  PANE *p_pane; // eax
  int state; // edx
  __int16 v11; // cx
  int v12; // eax
  T_WndA2 *v13; // edx
  unsigned int v14; // [esp+4h] [ebp-28h]
  int wndIndex; // [esp+8h] [ebp-24h]
  P_WndA2 v16; // [esp+Ch] [ebp-20h]
  WORD windowCount; // [esp+10h] [ebp-1Ch]

  x = V_Mouse.x;
  v3 = pWinMgr->_wndIndex;
  y = V_Mouse.y;
  if ( v3 == 0xFFFFFFFF )
  {
    goto LABEL_17;
  }
  pWndA2 = pWinMgr->wnds[v3].pWndA2;
  if ( V_Mouse.x > pWndA2->pane.x1 || V_Mouse.x < pWndA2->pane.x0 || V_Mouse.y > pWndA2->pane.y1 || V_Mouse.y < pWndA2->pane.y0 )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 8, V_Mouse.x, V_Mouse.y);
    Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 6, 0, 0);
    pWinMgr->_wndIndex = 0xFFFFFFFF;
LABEL_17:
    state = pWinMgr->state;
    if ( state >= 0 )
    {
      v11 = 0x1F;
      v14 = 0;
      windowCount = pWinMgr->winStates[state]._windowCount;
      while ( windowCount > 0 && !v14 )
      {
        if ( v11 < 0 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x992);
        }
        v12 = pWinMgr->winStates[pWinMgr->state]._wndIndexes[v11];
        wndIndex = v12;
        if ( v12 )
        {
          v13 = pWinMgr->wnds[v12].pWndA2;
          if ( v13->Unknown_A3 == 0xFFFFFFFF
            && x <= v13->pane.x1
            && x >= v13->pane.x0
            && y <= v13->pane.y1
            && y >= v13->pane.y0
            && v13->Unknown_35 == 0xFFFFFFFF )
          {
            v14 = 0xFFFFFFFF;
          }
          --windowCount;
        }
        --v11;
      }
      if ( v14 == 0xFFFFFFFF )
      {
        pWinMgr->_wndIndex = wndIndex;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, 7, 0, 0);
      }
    }
    return;
  }
  if ( pWndA2->childrenNum )
  {
    v6 = 0;
    if ( pWndA2->childrenNum > 0 )
    {
      while ( 1 )
      {
        v7 = (*pWndA2->children)[v6];
        v16 = v7;
        if ( v7->Unknown_35 )
        {
          x1 = v7->pane.x1;
          p_pane = &v7->pane;
          if ( V_Mouse.x <= x1 && V_Mouse.x >= p_pane->x0 && V_Mouse.y <= p_pane->y1 && V_Mouse.y >= p_pane->y0 )
          {
            break;
          }
        }
        if ( ++v6 >= pWndA2->childrenNum )
        {
          return;
        }
      }
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 8, V_Mouse.x, V_Mouse.y);
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 6, 0, 0);
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, v16->index, 7, 0, 0);
      pWinMgr->_wndIndex = v16->index;
    }
  }
}
// 56B46: variable 'wndIndex' is possibly undefined

//----- (00056B60) --------------------------------------------------------
void __fastcall Q_WinMgr_QueueMessage_sub_56B60(P_WinMgr pWinMgr, WORD message, LONG param1, LONG param2)
{
  if ( pWinMgr->messageQueueCount == 32 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x9B5);
  }
  pWinMgr->messageQueue[pWinMgr->messageQueueCount].message = message;
  pWinMgr->messageQueue[pWinMgr->messageQueueCount].param1 = param1;
  pWinMgr->messageQueue[pWinMgr->messageQueueCount++].param2 = param2;
}

//----- (00056BE8) --------------------------------------------------------
void __fastcall sub_56BE8(P_WinMgr pWinMgr, UWORD message, int param1, int param2, int a5)
{
  int state; // edx
  __int16 v7; // si
  int v8; // ecx
  int v9; // eax
  T_WndA2 *pWndA2; // eax
  unsigned int v11; // edx
  WORD windowCount; // [esp+Ch] [ebp-10h]

  state = pWinMgr->state;
  if ( state >= 0 )
  {
    v7 = 0x1F;
    v8 = 0;
    windowCount = pWinMgr->winStates[state]._windowCount;
    while ( windowCount > 0 && !v8 )
    {
      v8 = 0;
      if ( v7 < 0 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x9EA);
      }
      v9 = pWinMgr->winStates[pWinMgr->state]._wndIndexes[v7];
      if ( v9 )
      {
        pWndA2 = pWinMgr->wnds[v9].pWndA2;
        if ( !a5 || byte_132B38[v7] )
        {
          if ( (pWndA2->Unknown_35 || message == 1 || message == 0xE) && (!pWndA2->parentIndex || (__int16)message > 2) )
          {
            v11 = 0xFFFFFFFF;
          }
          else
          {
            v11 = 0;
          }
          if ( v11 )
          {
            if ( a5 )
            {
              byte_132B38[v7] = 1;
            }
            v8 = pWndA2->pProcs->proc3_msg(pWndA2, message, param1, param2);
          }
          else if ( a5 )
          {
            byte_132B38[v7] = 0;
          }
        }
        --windowCount;
      }
      --v7;
    }
  }
}

//----- (00056D30) --------------------------------------------------------
// Dispatches a message to a window's handler if the WinMgr is in a valid state
int __fastcall Q_WinMgr_DispatchMessageProc3_sub_56D30(P_WinMgr pWinMgr, int wndIndex, WORD message, LONG param1, LONG param2)
{
  if ( pWinMgr->state >= 0 )
  {
    return pWinMgr->wnds[wndIndex].pWndA2->pProcs->proc3_msg(pWinMgr->wnds[wndIndex].pWndA2, message, param1, param2);
  }
  else
  {
    return FALSE;
  }
}

//----- (00056D70) --------------------------------------------------------
T_WndA2 *__fastcall Q_WinMgr_DispatchMessageProc3_sub_56D70(P_WinMgr pWinMgr, char *wndName, WORD message, LONG param1, LONG param2)
{
  T_WndA2 *result; // eax
  WORD wndIndex; // [esp+0h] [ebp-4h] BYREF

  result = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, wndName, &wndIndex);
  if ( result )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, message, param1, param2);
    return (T_WndA2 *)0xFFFFFFFF;
  }
  return result;
}

//----- (00056DA8) --------------------------------------------------------
T_WndA2 *__fastcall Q_WinMgr_FindWnd_sub_56DA8(P_WinMgr pWinMgr, char *name, WORD *outIndex)
{
  WORD j; // si
  WORD i; // cx
  T_WndA2 *pWndA2; // edx

  j = 0;
  for ( i = 0; ; ++i )
  {
    if ( i >= 1024 || j > pWinMgr->wndsCnt )
    {
      return 0;
    }
    pWndA2 = pWinMgr->wnds[i].pWndA2;
    if ( pWndA2 )
    {
      ++j;
      if ( !strncmp(name, pWndA2->name, 10u) )
      {
        break;
      }
    }
  }
  if ( outIndex )
  {
    *outIndex = i;
  }
  return pWinMgr->wnds[i].pWndA2;
}

//----- (00056E18) --------------------------------------------------------
T_WndA2 *__fastcall Q_WinMgr_FindWndWithState_sub_56E18(P_WinMgr pWinMgr, char *name, WORD state, WORD *outIndex)
{
  WORD i; // cx
  int foundIndex; // edi
  T_WndA2 *pWndA2; // edx

  if ( state < pWinMgr->_activeStateCount )
  {
    for ( i = 0; i < pWinMgr->winStates[state]._windowCount; ++i )
    {
      foundIndex = pWinMgr->winStates[state]._wndIndexes[i];
      pWndA2 = pWinMgr->wnds[foundIndex].pWndA2;
      if ( pWndA2 && !strncmp(name, pWndA2->name, 10u) )
      {
        if ( outIndex )
        {
          *outIndex = foundIndex;
        }
        return pWinMgr->wnds[foundIndex].pWndA2;
      }
    }
  }
  return 0;
}

//----- (00056E9C) --------------------------------------------------------
void __fastcall sub_56E9C(P_WinMgr pWinMgr, WORD stateIndex, BOOL a3)
{
  int state; // ebx
  int Unknown_0; // edx
  int track; // edx
  int v8; // ebx
  int wndIndex; // eax
  __int16 Unknown_4758; // ax
  PANE_LIST *pPaneList; // eax
  int v12; // eax

  if ( stateIndex != pWinMgr->state )
  {
    if ( stateIndex < 0 || stateIndex >= 0x20 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xA9B);
    }
    state = pWinMgr->state;
    if ( state >= 0 )
    {
      Unknown_0 = pWinMgr->winStates[state].Unknown_0;
      if ( Unknown_0 != 0xFFFFFFFF )
      {
        Q_SSystem_EndSequence_sub_4F45C(&V_SSystem, Unknown_0);
      }
    }
    track = pWinMgr->winStates[stateIndex].Unknown_0;
    if ( track != 0xFFFFFFFF )
    {
      Q_SSystem_StartSequence_sub_4F32C(&V_SSystem, track, 0);
    }
    v8 = pWinMgr->state;
    if ( v8 >= 0 && pWinMgr->winStates[v8].Proc2 )
    {
      ((void (__fastcall *)(_DWORD, T_WinState *))pWinMgr->winStates[v8].Proc2)(pWinMgr->state, &pWinMgr->winStates[v8]);
    }
    wndIndex = pWinMgr->_wndIndex;
    if ( wndIndex != 0xFFFFFFFF )
    {
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, 6, 0, 0);
    }
    sub_56BE8(pWinMgr, 2u, 0, 0, 0);
    if ( a3 == TRUE && pWinMgr->state >= 0 )
    {
      Unknown_4758 = pWinMgr->Unknown_4758;
      pWinMgr->Unknown_4758 = Unknown_4758 + 1;
      pWinMgr->Unknown_4736[Unknown_4758] = pWinMgr->state;
      if ( pWinMgr->Unknown_4758 == 0x10 )
      {
        pWinMgr->Unknown_4758 = 0;
      }
      ++pWinMgr->Unknown_4756;
    }
    pWinMgr->state = stateIndex;
    if ( !pWinMgr->state && dword_96BC0 == 0xFFFFFFFF && !access("resume.gam", 0) )
    {
      Q_LoadGam_sub_53FB0("resume.gam");
    }
    pPaneList = pWinMgr->pPaneList;
    dword_96BC0 = 0;
    VFX_pane_list_clear(pPaneList);
    Q_WinMgr_WipeAndAddDirtyArea_sub_55214(pWinMgr, 0, 0, 639, 479);
    v12 = stateIndex;
    if ( pWinMgr->winStates[v12].Proc1 )
    {
      ((void (__fastcall *)(_DWORD, T_WinState *))pWinMgr->winStates[v12].Proc1)(stateIndex, &pWinMgr->winStates[v12]);
    }
    sub_56BE8(pWinMgr, 1u, 0, 0, 0);
    pWinMgr->_wndIndex = 0xFFFFFFFF;
    sub_5691C(pWinMgr);
  }
}
// 96BC0: using guessed type int dword_96BC0;

//----- (000570AC) --------------------------------------------------------
int __fastcall sub_570AC(P_WinMgr pWinMgr, BOOL a2)
{
  __int16 v4; // dx
  int v5; // ecx

  if ( !pWinMgr->Unknown_4756 )
  {
    return 0;
  }
  if ( pWinMgr->Unknown_4758 )
  {
    v4 = pWinMgr->Unknown_4758 - 1;
  }
  else
  {
    v4 = 0xF;
  }
  v5 = v4;
  LOWORD(v5) = pWinMgr->Unknown_4736[v4];
  if ( a2 == TRUE )
  {
    pWinMgr->Unknown_4758 = v4;
    pWinMgr->Unknown_4736[pWinMgr->Unknown_4758] = 0xFFFF;
    --pWinMgr->Unknown_4756;
    sub_56E9C(pWinMgr, v5, 0);
  }
  return v5;
}

//----- (000571B8) --------------------------------------------------------
int __fastcall Q_WinMgr_RegisterWindow_sub_571B8(P_WinMgr pWinMgr, P_WndA2 pWnd)
{
  __int16 i; // dx
  int result; // eax
  T_WinEntry *winEntry; // ebx

  if ( !pWnd || pWinMgr->wndsCnt == 0x3FF )
  {
    return 0;
  }
  for ( i = 1; ; ++i )
  {
    result = i;
    if ( i >= 1024 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB37);
    }
    winEntry = &pWinMgr->wnds[i];
    if ( !winEntry->activeCount )
    {
      break;
    }
  }
  winEntry->activeCount = 1;
  winEntry->pWndA2 = pWnd;
  ++pWinMgr->wndsCnt;
  pWnd->magic12345678 = 0x12345678;
  return result;
}

//----- (00057220) --------------------------------------------------------
// Adds a window to a window manager state
// @param pWinMgr Window manager instance
// @param windowIndex Index of window to add (1-1023)
// @param state State to add window to (0-31)
// @return TRUE if window was added successfully, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_WinMgr_AddWindowToState_sub_57220(P_WinMgr pWinMgr, int windowIndex, WORD state)
{
  P_WinMgr pWinMgr_; // kr00_4
  __int16 slot; // ax

  // Validate state parameter
  if ( state < 0 || state >= 32 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB42);
  }
  // Validate window index
  if ( windowIndex >= 1024 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB43);
  }
  // Return FALSE for invalid window index 0
  if ( !windowIndex )
  {
    return FALSE;
  }
  pWinMgr_ = pWinMgr;
  // Check if state is full
  if ( pWinMgr->winStates[state]._windowCount == 32 )
  {
    return FALSE;
  }
  // Try to find empty slot in existing state
  slot = 0;
  if ( pWinMgr_->winStates[state]._windowCount )
  {
    while ( slot < 32 )
    {
      if ( !pWinMgr->winStates[state]._wndIndexes[slot] )
      {
        // Found empty slot
        pWinMgr->winStates[state]._wndIndexes[slot] = windowIndex;
        ++pWinMgr->winStates[state]._windowCount;
        break;
      }
      ++slot;
    }
  }
  else
  {
    // Initialize new state
    ++pWinMgr->_activeStateCount;
    pWinMgr_->winStates[state]._windowCount = 1;
    pWinMgr_->winStates[state]._wndIndexes[0] = windowIndex;
  }
  // Increment window's active count
  ++pWinMgr->wnds[windowIndex].activeCount;
  if ( slot >= 32 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB65);
  }
  return TRUE;
}

//----- (00057310) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_57310(P_WinMgr pWinMgr, int a2, WORD stateIndex, int a4)
{
  __int16 i; // cx
  int v7; // ebx

  if ( stateIndex < 0 || stateIndex >= 32 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB75);
  }
  if ( a2 >= 1024 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB76);
  }
  if ( !a2 || !pWinMgr->winStates[stateIndex]._windowCount )
  {
    return FALSE;
  }
  for ( i = 0; i < 32; ++i )
  {
    v7 = pWinMgr->winStates[stateIndex]._wndIndexes[i];
    if ( a2 == v7 )
    {
      pWinMgr->winStates[stateIndex]._wndIndexes[i] = 0;
      --pWinMgr->winStates[stateIndex]._windowCount;
      --pWinMgr->wnds[v7].activeCount;
      if ( a4 )
      {
        sub_57530(pWinMgr, a2, 0);
      }
      break;
    }
  }
  if ( i < 32 )
  {
    return TRUE;
  }
  else
  {
    return FALSE;
  }
}

//----- (0005748C) --------------------------------------------------------
unsigned int __fastcall sub_5748C(P_WinMgr a1, __int16 stateNumber, __int16 a3)
{
  unsigned int result; // eax

  if ( stateNumber < 0 || stateNumber >= 0x20 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xBA8);
  }
  if ( (unsigned __int16)a1->winStates[stateNumber].Unknown_84 != 0xFFFF )
  {
    return 0;
  }
  result = 0xFFFFFFFF;
  a1->winStates[stateNumber].Unknown_84 = a3;
  return result;
}

//----- (000574F0) --------------------------------------------------------
void __fastcall Q_WinMgr_SetStateProc1_sub_574F0(P_WinMgr pWinMgr, WORD stateIndex, void *proc)
{
  pWinMgr->winStates[stateIndex].Proc1 = proc;
}

//----- (00057510) --------------------------------------------------------
void __fastcall Q_WinMgr_SetStateProc2_sub_57510(P_WinMgr pWinMgr, WORD stateIndex, void *proc)
{
  pWinMgr->winStates[stateIndex].Proc2 = proc;
}

//----- (00057530) --------------------------------------------------------
void __fastcall sub_57530(P_WinMgr pWinMgr, int wndIndex, int a3)
{
  int v5; // edx
  P_WinMgr v6; // kr00_4
  T_WndA2 *pWndA2; // eax
  int v8; // eax

  if ( wndIndex >= 1024 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xBDB);
  }
  if ( wndIndex )
  {
    v5 = pWinMgr->wnds[wndIndex].activeCount - 1;
    pWinMgr->wnds[wndIndex].activeCount = v5;
    if ( !v5 || a3 )
    {
      v6 = pWinMgr;
      Q_RemoveWinDataFromWinMgr_sub_2627C(pWinMgr->wnds[wndIndex].pWndA2);
      pWndA2 = v6->wnds[wndIndex].pWndA2;
      if ( pWndA2 )
      {
        pWndA2->pProcs->dtor(pWndA2, 2);
      }
      v8 = wndIndex;
      pWinMgr->wnds[v8].pWndA2 = 0;
      pWinMgr->wnds[v8].activeCount = 0;
      --pWinMgr->wndsCnt;
    }
  }
}

//----- (000575BC) --------------------------------------------------------
void __fastcall sub_575BC(P_WinMgr a1)
{
  void *v2; // eax
  T_HazeTable *v3; // ecx
  _BYTE *v4; // kr00_4
  void *v5; // eax
  T_HazeTable *v6; // ecx
  _BYTE *v7; // kr08_4
  int i; // eax
  int j; // eax

  v2 = operator new[](0x100u);
  Q_RegisterDataInWinMgr_sub_2625C(v2, 1, "WMGR MAPFOCUS");
  v3 = (T_HazeTable *)v2;
  if ( !v2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xBF7);
  }
  v4 = v2;
  for ( i = 0; i < 0x100; ++i )
  {
    v4[i] = i;
  }
  (*v3)[0xF2] = 0x96;
  a1->hazeTableMapFocus = v3;
  v5 = operator new[](0x100u);
  Q_RegisterDataInWinMgr_sub_2625C(v5, 1, "WMGR MAPRACES");
  v6 = (T_HazeTable *)v5;
  if ( !v5 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xC01);
  }
  v7 = v5;
  for ( j = 0; j < 0x100; ++j )
  {
    v7[j] = j;
  }
  a1->hazeTableMapRaces = v6;
  a1->pPaneList = VFX_pane_list_construct(0x80);
  Q_WINMGR_CPP_LoadWindowsTxt_sub_57670(a1, "windows.txt");
}

//----- (00057670) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_LoadWindowsTxt_sub_57670(P_WinMgr pWinMgr, const char *fname)
{
  FILE *fp0; // edx
  FILE *fp; // esi
  int largestMem; // ecx
  char *v6; // ebx
  T_Wnd *pTypeA1; // eax
  int v8; // edx
  T_Camera *p_pane; // eax
  T_Camera *v10; // eax
  T_Wnd *v11; // edx
  char *pName; // ebp
  T_WndA2 *v13; // ecx
  T_WndA2 *v14; // edx
  __int16 mm; // cx
  P_Wnd v16; // edx
  WORD v17; // ax
  P_Wnd v18; // edx
  P_Wnd v19; // edx
  int t19; // ecx
  WORD *p_hotX; // ebp
  WORD *v22; // ebx
  T_Wnd01FLIC *v23; // eax
  P_Wnd01FLIC pFlicWnd; // ebp
  char *name; // edx
  T_WndA2 *Wnd_sub_56DA8; // eax
  int i; // ecx
  int skipFrame; // ebx
  int j; // ecx
  WINDOW *window; // eax
  WORD racesNum; // dx
  int v32; // eax
  WORD v33; // bx
  char v34; // dh
  T_Wnd03CTW *v35; // eax
  T_Wnd03CTW *v36; // ebp
  char *v37; // edx
  T_WndA2 *v38; // eax
  __int16 k; // cx
  WORD Unknown_84; // ax
  P_Wnd04BM v41; // eax
  P_Wnd04BM v42; // ebp
  char *v43; // edx
  T_WndA2 *v44; // eax
  int ii; // ecx
  WINDOW *v46; // eax
  __int16 jj; // cx
  WORD v48; // ax
  P_Wnd10LB vpWnd10LB; // eax
  P_Wnd10LB v50; // ebp
  char *v51; // edx
  T_WndA2 *v52; // eax
  int kk; // ecx
  __int16 v54; // ax
  signed __int16 l; // cx
  unsigned __int16 v56; // bx
  P_Wnd13DBGWND v57; // eax
  P_Wnd13DBGWND v58; // ecx
  WINDOW *v59; // eax
  P_Wnd08SW v60; // eax
  P_Wnd08SW v61; // ebp
  char *v62; // edx
  T_WndA2 *v63; // eax
  P_Wnd02COSW vpWnd2COSW; // eax
  char *v65; // edx
  P_Wnd02COSW vpWnd2COSW__; // ebp
  T_WndA2 *v67; // eax
  WORD *v68; // [esp-Ch] [ebp-3C8h]
  WORD *v69; // [esp-Ch] [ebp-3C8h]
  WORD *v70; // [esp-4h] [ebp-3C0h]
  WORD *v71; // [esp-4h] [ebp-3C0h]
  char v72[108]; // [esp+0h] [ebp-3BCh] BYREF
  char v73[108]; // [esp+80h] [ebp-33Ch] BYREF
  char bufc2[108]; // [esp+100h] [ebp-2BCh] BYREF
  char bufc4[108]; // [esp+180h] [ebp-23Ch] BYREF
  char bufc3[108]; // [esp+200h] [ebp-1BCh] BYREF
  char flicName[108]; // [esp+280h] [ebp-13Ch] BYREF
  char v78[32]; // [esp+300h] [ebp-BCh] BYREF
  char bufc1[32]; // [esp+334h] [ebp-88h] BYREF
  WORD v80[7]; // [esp+368h] [ebp-54h] BYREF
  int bufi; // [esp+378h] [ebp-44h] BYREF
  P_Wnd a1a; // [esp+37Ch] [ebp-40h]
  int v83; // [esp+380h] [ebp-3Ch]
  P_Cache p_cache; // [esp+384h] [ebp-38h]
  P_Cache v85; // [esp+388h] [ebp-34h]
  P_Font p_SmallFont; // [esp+38Ch] [ebp-30h]
  P_Font p_LargeFont; // [esp+390h] [ebp-2Ch]
  WORD *p_hotY; // [esp+394h] [ebp-28h]
  WORD *p_shapeNumber; // [esp+398h] [ebp-24h]
  int m; // [esp+39Ch] [ebp-20h]
  int bufi2; // [esp+3A0h] [ebp-1Ch] BYREF
  int v92; // [esp+3A4h] [ebp-18h] BYREF
  __int16 wndType; // [esp+3A8h] [ebp-14h]
  int winItems; // [esp+3ACh] [ebp-10h]
  int v95; // [esp+3B0h] [ebp-Ch]
  __int16 numControls; // [esp+3B4h] [ebp-8h] BYREF
  WORD n; // [esp+3B8h] [ebp-4h]

  fp0 = Q_OpenTextFile_sub_1BB10(fname, 0);
  fp = fp0;
  if ( fp0 )
  {
    // MEM_REQ        2300000
    fscanf(fp0, "%s %d", bufc1, &bufi);
    largestMem = Q_CheckFreeMemory_sub_53DEC();
    if ( largestMem <= bufi )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xC27);
    }
    Q_Cache_RegisterShapeCache_sub_1AD1C(&pWinMgr->cache, largestMem - 200000);
    Q_LoadGwshareTxt_sub_2D2CC();
    p_cache = &pWinMgr->cache;
    p_LargeFont = &pWinMgr->LargeFont;
    v85 = &pWinMgr->cache;
    p_SmallFont = &pWinMgr->SmallFont;
    while ( 1 )
    {
      fscanf(fp, "%s %d", bufc1, &bufi);
      if ( bufi == 0xFFFFFFFF )
      {
        // END            -1
        fclose(fp);
        return;
      }
      wndType = bufi;
      if ( (unsigned int)bufi < 9 )
      {
        if ( (unsigned int)bufi < 3 )
        {
          if ( !bufi )
          {
            goto LABEL_16;
          }
          if ( (unsigned int)bufi <= 1 )
          {
            // TYPE           1
            // Intro video
            v23 = (T_Wnd01FLIC *)operator new(0xA09u);
            if ( v23 )
            {
              Q_Wnd01FLIC_Ctor_sub_2AE80(v23);
            }
            Q_RegisterDataInWinMgr_sub_2625C(v23, 2, "FLIC");
            pFlicWnd = v23;
            name = v23->a2.name;
            Q_RegisterWindowInWinMgr_sub_2C978(&v23->a2);
            // NAME           INTROFLIC
            fscanf(fp, "%s %s", bufc1, name);
            // PARENT         NONE
            fscanf(fp, "%s", bufc1);
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              Wnd_sub_56DA8 = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, bufc1, 0);
              if ( !Wnd_sub_56DA8 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xCF8);
              }
              pFlicWnd->a2.parentIndex = Wnd_sub_56DA8->index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(Wnd_sub_56DA8, &pFlicWnd->a2);
            }
            // STATE          1 6
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( i = 0; (__int16)i < (__int16)bufi2; ++i )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, pFlicWnd->a2.index, bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xD02);
              }
            }
            fscanf(fp, "%s %d", bufc1, &pFlicWnd->a2.pane.x0);
            fscanf(fp, "%s %d", bufc1, &pFlicWnd->a2.pane.y0);
            fscanf(fp, "%s %d", bufc1, &pFlicWnd->a2.pane.x1);
            fscanf(fp, "%s %d", bufc1, &pFlicWnd->a2.pane.y1);
            // FLICFILE       data\intro65a.flc
            fscanf(fp, "%s %s", bufc1, flicName);
            Q_Wnd01FLIC_LoadFlicHeader_sub_2AF04(pFlicWnd, flicName);
            // BUFFERMEGS     2
            fscanf(fp, "%s %d", bufc1, &bufi);
            pFlicWnd->t2.bufferMegs = bufi;
            // PRELOADMEGS    2
            fscanf(fp, "%s %d", bufc1, &bufi);
            pFlicWnd->t2.preloadMegs = bufi;
            // MAXFRAME_KB    64
            fscanf(fp, "%s %d", bufc1, &bufi);
            pFlicWnd->t2.maxFrame = bufi;
            // READSIZE_KB    24
            fscanf(fp, "%s %d", bufc1, &bufi);
            pFlicWnd->t2.readSizeKB = bufi;
            // SKIPFRAME      -1
            fscanf(fp, "%s %d", bufc1, &bufi);
            skipFrame = bufi;
            if ( bufi != 0xFFFFFFFF )
            {
              pFlicWnd->t2.Unknown_93A = 0xFFFFFFFF;
              pFlicWnd->t2.skipFrame = skipFrame;
            }
            fscanf(fp, "%s %d", bufc1, &pFlicWnd->a2.sendMessage);
            fscanf(fp, "%s %d", bufc1, &pFlicWnd->a2.sendParam1);
            fscanf(fp, "%s %d", bufc1, &pFlicWnd->a2.sendParam2);
            fscanf(fp, "%s %s", bufc1, pFlicWnd->a2.helpIndex);
            // LOOPCOUNT      1
            fscanf(fp, "%s %d", bufc1, &bufi);
            pFlicWnd->t2.loopCount = bufi;
            // SHOWINFO       0
            fscanf(fp, "%s %d", bufc1, &bufi);
            if ( bufi )
            {
              pFlicWnd->t2.showInfo = TRUE;
            }
            pFlicWnd->a2.pane.window = pWinMgr->window;
          }
          else
          {
            // TYPE           2
            // Cosmos Window (Galactic Display)
            vpWnd2COSW = (P_Wnd02COSW)operator new(0x596u);
            if ( vpWnd2COSW )
            {
              Q_Wnd02COSW_Ctor_sub_224A4(vpWnd2COSW);
            }
            Q_RegisterDataInWinMgr_sub_2625C(vpWnd2COSW, 2, "COSW");
            v65 = vpWnd2COSW->a.name;
            vpWnd2COSW__ = vpWnd2COSW;
            Q_RegisterWindowInWinMgr_sub_2C978(&vpWnd2COSW->a);
            dword_96BAC = *(_DWORD *)(v65 + 0x21);
            // NAME           COSMOSWnd
            fscanf(fp, "%s %s", bufc1, v65);
            // PARENT
            fscanf(fp, "%s", bufc1);
            // NONE
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              v67 = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, bufc1, 0);
              if ( !v67 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD41);
              }
              vpWnd2COSW__->a.parentIndex = v67->index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(v67, &vpWnd2COSW__->a);
            }
            // STATE          4 1 3 7 13
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( j = 0; (__int16)j < (__int16)bufi2; ++j )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, vpWnd2COSW__->a.index, bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xD4B);
              }
            }
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.pane.x0);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.pane.y0);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.pane.x1);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.pane.y1);
            // BACKGRNDCOLOR
            fscanf(fp, "%s %d", bufc1, &bufi);
            vpWnd2COSW__->backgroundColor = bufi;
            // STAR_SHAPES
            fscanf(fp, "%s %s", bufc1, v72);
            // SHIP_SHAPES
            fscanf(fp, "%s %s", bufc1, v73);
            Q_Wnd02COSW_sub_22644(vpWnd2COSW__, v72, v73);
            // NUM_STARS
            fscanf(fp, "%s %d", bufc1, &bufi);
            // NUM_LANES
            fscanf(fp, "%s %d", bufc1, &v92);
            // SMALLSEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // MEDIUMSEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // LARGESEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // HUGESEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // CURSORSHAPE
            fscanf(fp, "%s %d", bufc1, &bufi);
            vpWnd2COSW__->cursorShape = bufi;
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.sendMessage);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.sendParam1);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.sendParam2);
            fscanf(fp, "%s %s", bufc1, vpWnd2COSW__->a.helpIndex);
            window = pWinMgr->window;
            vpWnd2COSW__->a.shapeCacheIndex = 0xFFFF;
            vpWnd2COSW__->a.Unknown_1A = 0;
            racesNum = V_Game.racesNum;
            vpWnd2COSW__->Unknown_D9 = 0;
            vpWnd2COSW__->a.pane.window = window;
            v32 = 0;
            if ( racesNum > 0 )
            {
              do
              {
                v33 = V_Game.racesNum;
                v34 = (1 << v32++) | vpWnd2COSW__->Unknown_D9;
                vpWnd2COSW__->Unknown_D9 = v34;
              }
              while ( (__int16)v32 < v33 );
            }
          }
        }
        else if ( (unsigned int)bufi <= 3 )
        {
          // TYPE           3
          v35 = (T_Wnd03CTW *)operator new(0xB3u);
          if ( v35 )
          {
            Q_Wnd03CTW_Ctor_sub_2D9C4(v35);
          }
          Q_RegisterDataInWinMgr_sub_2625C(v35, 2, "CTW");
          v36 = v35;
          v37 = v35->a2.name;
          Q_Wnd03CTW_Register_sub_2DA68(v35);
          // NAME = RACECONTROLS
          fscanf(fp, "%s %s", bufc1, v37);
          // PARENT
          fscanf(fp, "%s", bufc1);
          fscanf(fp, "%s", bufc1);
          if ( strcmp(bufc1, "NONE") )
          {
            v38 = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, bufc1, 0);
            if ( !v38 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD8D);
            }
            v36->a2.parentIndex = v38->index;
            Q_GWINDOW_CPP_LinkChild_sub_2C990(v38, &v36->a2);
          }
          // STATE
          fscanf(fp, "%s %d", bufc1, &bufi2);
          for ( k = 0; k < (__int16)bufi2; ++k )
          {
            fscanf(fp, "%d", &bufi);
            if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, v36->a2.index, bufi) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xD97);
            }
            if ( !k )
            {
              Unknown_84 = pWinMgr->winStates[bufi].Unknown_84;
              v36->a2.Unknown_1A = 0;
              v36->a2.shapeCacheIndex = Unknown_84;
            }
          }
          fscanf(fp, "%s %d", bufc1, &v36->a2.pane.x0);
          fscanf(fp, "%s %d", bufc1, &v36->a2.pane.y0);
          fscanf(fp, "%s %d", bufc1, &v36->a2.pane.x1);
          fscanf(fp, "%s %d", bufc1, &v36->a2.pane.y1);
          // SHAPEFRAME
          fscanf(fp, "%s %d", bufc1, &bufi);
          v36->a2.shapeNumber = bufi;
          v36->a2.soundNumber = 0;
          fscanf(fp, "%s %d", bufc1, &v36->a2.sendMessage);
          fscanf(fp, "%s %d", bufc1, &v36->a2.sendParam1);
          fscanf(fp, "%s %d", bufc1, &v36->a2.sendParam2);
          fscanf(fp, "%s %s", bufc1, v36->a2.helpIndex);
          v36->a2.pane.window = pWinMgr->window;
          // NUMCONTROLS
          fscanf(fp, "%s %d", bufc1, &numControls);
          if ( Q_Wnd03CTW_AllocateControls_sub_2DA80(v36, numControls) == FALSE )
          {
            Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xDB9);
          }
          for ( m = 0; (__int16)m < numControls; ++m )
          {
            // RACE1CONTROL
            fscanf(fp, "%s %d", bufc1, &bufi);
            v80[0] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[1] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[3] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[2] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[4] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[5] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[6] = bufi;
            if ( Q_Wnd03CTW_SetControl_sub_2DAC8(v36, 0, 0, (P_Control)v80) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xDD4);
            }
          }
          for ( n = 0; n < V_Game.racesNum; ++n )
          {
            Q_Wnd03CTW_SetControl_sub_2DAC8(v36, 1 << n, 1, 0);
          }
        }
        else if ( (unsigned int)bufi < 5 )
        {
          // TYPE           4
          // Battle Mode Window (System Display)
          v41 = (P_Wnd04BM)operator new(0x504Eu);
          if ( v41 )
          {
            Q_Wnd04BM_Ctor_sub_15ED4(v41);
          }
          Q_RegisterDataInWinMgr_sub_2625C(v41, 2, "BM");
          v42 = v41;
          v43 = v41->a2.name;
          Q_RegisterWindowInWinMgr_sub_2C978(&v41->a2);
          // NAME           BatModeWnd
          fscanf(fp, "%s %s", bufc1, v43);
          // PARENT
          fscanf(fp, "%s", bufc1);
          fscanf(fp, "%s", bufc1);
          if ( strcmp(bufc1, "NONE") )
          {
            v44 = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, bufc1, 0);
            if ( !v44 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xDE9);
            }
            v42->a2.parentIndex = v44->index;
            Q_GWINDOW_CPP_LinkChild_sub_2C990(v44, &v42->a2);
          }
          fscanf(fp, "%s %d", bufc1, &bufi2);
          for ( ii = 0; (__int16)ii < (__int16)bufi2; ++ii )
          {
            fscanf(fp, "%d", &bufi);
            if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, v42->a2.index, bufi) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xDF3);
            }
          }
          fscanf(fp, "%s %d", bufc1, &v42->a2.pane.x0);
          fscanf(fp, "%s %d", bufc1, &v42->a2.pane.y0);
          fscanf(fp, "%s %d", bufc1, &v42->a2.pane.x1);
          fscanf(fp, "%s %d", bufc1, &v42->a2.pane.y1);
          // BACKGRNDCOLOR
          fscanf(fp, "%s %d", bufc1, &bufi);
          v42->backgroundColor = bufi;
          // CURSORSHAPE
          fscanf(fp, "%s %d", bufc1, &bufi);
          v42->cursorShape = bufi;
          sub_18370(v42);
          fscanf(fp, "%s %d", bufc1, &v42->a2.sendMessage);
          fscanf(fp, "%s %d", bufc1, &v42->a2.sendParam1);
          fscanf(fp, "%s %d", bufc1, &v42->a2.sendParam2);
          fscanf(fp, "%s %s", bufc1, v42->a2.helpIndex);
          v46 = pWinMgr->window;
          v42->a2.shapeCacheIndex = 0xFFFF;
          v42->a2.Unknown_1A = 0;
          v42->a2.pane.window = v46;
        }
        else
        {
          if ( (unsigned int)bufi <= 7 )
          {
            goto LABEL_16;
          }
          // TYPE           8
          // Ship Design Screen
          v60 = (P_Wnd08SW)operator new(0x237u);
          if ( v60 )
          {
            v60 = Q_Wnd8SWCtor_sub_4D92C(v60);
          }
          Q_RegisterDataInWinMgr_sub_2625C(v60, 2, "SW");
          v61 = v60;
          v62 = v60->a.name;
          Q_RegisterWindowInWinMgr_sub_2C978(&v60->a);
          fscanf(fp, "%s %s", bufc1, v62);
          fscanf(fp, "%s", bufc1);
          fscanf(fp, "%s", bufc1);
          if ( strcmp(bufc1, "NONE") )
          {
            v63 = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, bufc1, 0);
            if ( !v63 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xE21);
            }
            v61->a.parentIndex = v63->index;
            Q_GWINDOW_CPP_LinkChild_sub_2C990(v63, &v61->a);
          }
          fscanf(fp, "%s %d", bufc1, &bufi2);
          for ( jj = 0; jj < (__int16)bufi2; ++jj )
          {
            fscanf(fp, "%d", &bufi);
            if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, v61->a.index, bufi) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xE2B);
            }
            if ( !jj )
            {
              v48 = pWinMgr->winStates[bufi].Unknown_84;
              v61->a.Unknown_1A = 0;
              v61->a.shapeCacheIndex = v48;
            }
          }
          fscanf(fp, "%s %d", bufc1, &bufi);
          if ( bufi )
          {
            v61->a._mouseFocus = 0xFFFFFFFF;
          }
          fscanf(fp, "%s %d", bufc1, &v61->a.pane.x0);
          fscanf(fp, "%s %d", bufc1, &v61->a.pane.y0);
          fscanf(fp, "%s %d", bufc1, &v61->a.pane.x1);
          fscanf(fp, "%s %d", bufc1, &v61->a.pane.y1);
          fscanf(fp, "%s %d", bufc1, &bufi);
          v61->a.soundNumber = bufi;
          fscanf(fp, "%s %d", bufc1, &v61->a.sendMessage);
          fscanf(fp, "%s %d", bufc1, &v61->a.sendParam1);
          fscanf(fp, "%s %d", bufc1, &v61->a.sendParam2);
          fscanf(fp, "%s %s", bufc1, v61->a.helpIndex);
          v61->a.pane.window = pWinMgr->window;
        }
      }
      else
      {
        if ( (unsigned int)bufi <= 9 )
        {
          goto LABEL_16;
        }
        if ( (unsigned int)bufi < 14 )
        {
          if ( (unsigned int)bufi < 11 )
          {
            // TYPE           10
            // List
            vpWnd10LB = (P_Wnd10LB)operator new(0x902u);
            if ( vpWnd10LB )
            {
              Q_Wnd10LB_Ctor_sub_2E248(vpWnd10LB);
            }
            Q_RegisterDataInWinMgr_sub_2625C(vpWnd10LB, 2, "LB");
            v50 = vpWnd10LB;
            v51 = vpWnd10LB->a2.name;
            Q_Wnd10LB_Register_sub_2E3BC(vpWnd10LB);
            fscanf(fp, "%s %s", bufc1, v51);
            fscanf(fp, "%s", bufc1);
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              v52 = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, bufc1, 0);
              if ( !v52 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xE5E);
              }
              v50->a2.parentIndex = v52->index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(v52, &v50->a2);
            }
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( kk = 0; (__int16)kk < (__int16)bufi2; ++kk )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, v50->a2.index, bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xE68);
              }
            }
            fscanf(fp, "%s %d", bufc1, &bufi);
            if ( bufi )
            {
              v50->a2._mouseFocus = 0xFFFFFFFF;
            }
            fscanf(fp, "%s %d", bufc1, &v50->a2.pane.x0);
            fscanf(fp, "%s %d", bufc1, &v50->a2.pane.y0);
            fscanf(fp, "%s %d", bufc1, &v50->a2.pane.x1);
            fscanf(fp, "%s %d", bufc1, &v50->a2.pane.y1);
            fscanf(fp, "%s %d", bufc1, &bufi);
            v50->a2.shapeNumber = bufi;
            fscanf(fp, "%s %d", bufc1, &bufi);
            v50->a2.soundNumber = bufi;
            fscanf(fp, "%s %d", bufc1, &v50->a2.sendMessage);
            fscanf(fp, "%s %d", bufc1, &v50->a2.sendParam1);
            fscanf(fp, "%s %d", bufc1, &v50->a2.sendParam2);
            fscanf(fp, "%s %s", bufc1, v50->a2.helpIndex);
            v50->a2.pane.window = pWinMgr->window;
          }
          else
          {
            if ( (unsigned int)bufi <= 12 )
            {
              goto LABEL_16;
            }
            // TYPE           13
            // Debug Window
            v57 = (P_Wnd13DBGWND)operator new(0xC0u);
            if ( v57 )
            {
              Q_Wnd13DBGWND_Ctor_sub_5A594(v57);
            }
            Q_RegisterDataInWinMgr_sub_2625C(v57, 2, "DBGWND");
            v58 = v57;
            if ( !v57 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xE8E);
            }
            Q_WINMGR_CPP_RegisterWindow_sub_5A5F4((P_Wnd)v57);
            pWinMgr->pWnd13DBGWND = v58;
            // NAME           WMGRDEBUG
            fscanf(fp, "%s %s", bufc1, v58->a2.name);
            fscanf(fp, "%s %d", bufc1, &v58->a2.pane.x0);
            fscanf(fp, "%s %d", bufc1, &v58->a2.pane.y0);
            fscanf(fp, "%s %d", bufc1, &v58->a2.pane.x1);
            fscanf(fp, "%s %d", bufc1, &v58->a2.pane.y1);
            fscanf(fp, "%s %d", bufc1, &v58->pane.x0);
            fscanf(fp, "%s %d", bufc1, &v58->pane.y0);
            fscanf(fp, "%s %d", bufc1, &v58->pane.x1);
            fscanf(fp, "%s %d", bufc1, &v58->pane.y1);
            fscanf(fp, "%s %s", bufc1, v78);
            v58->a2.shapeCacheIndex = Q_Cache_AddFile_sub_1ADAC(p_cache, v78);
            v59 = pWinMgr->window;
            v58->a2.pane.window = v59;
            v58->pane.window = v59;
          }
        }
        else
        {
          if ( (unsigned int)bufi <= 27 )
          {
            goto LABEL_16;
          }
          if ( (unsigned int)bufi < 100 )
          {
            if ( (unsigned int)bufi < 29 || (unsigned int)bufi > 32 )
            {
LABEL_262:
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xEF2);
            }
LABEL_16:
            if ( bufi )
            {
              switch ( bufi )
              {
                case 5:
                  // Races Window
                  v6 = "RW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd05RW_Ctor_sub_25BF8((P_WndA2)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 6:
                  // Race Selection Window
                  v6 = "RSW";
                  pTypeA1 = (T_Wnd *)operator new(0xB1u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd06RSW_Ctor_sub_25CB8((P_Wnd06RSW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 7:
                  // Planet Window
                  v6 = "PW";
                  pTypeA1 = (T_Wnd *)operator new(0x18Cu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd7PW_Ctor_sub_372B0((P_Wnd07PW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 11:
                  // Load Window
                  v6 = "LW";
                  pTypeA1 = (T_Wnd *)operator new(0xFE0u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd11LW_Ctor_sub_31200((P_Wnd11LW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 12:
                  // Intelligence Window
                  v6 = "IW";
                  pTypeA1 = (T_Wnd *)operator new(0xAFu);
                  if ( pTypeA1 )
                  {
                    Q_WndIW_sub_33598((P_WndIW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 9:
                  // Research Window
                  pTypeA1 = (T_Wnd *)operator new(0x9DDu);
                  v83 = 2;
                  if ( pTypeA1 )
                  {
                    Q_WndA2_Ctor_sub_2C830((P_WndA2)pTypeA1);
                    p_pane = (T_Camera *)&pTypeA1[1].pane;
                    Q_Camera_ResetToIdentity_sub_1B4F0(p_pane);
                    v10 = &p_pane[1];
                    _wcpp_2_ctor_array_(v10, 0x64u, &C_Vector3D);
                    v11 = (T_Wnd *)((char *)&v10[0xFFFFFFFD]._viewMatrix._[1][1] + 1);
                    LODWORD(v10[0xFFFFFFFE]._viewMatrix._[2][2]) = &Wnd9RW_Procs;
                    sub_46CAC((P_Wnd9RW)((char *)&v10[0xFFFFFFFD]._viewMatrix._[1][1] + 1));
                    pTypeA1 = v11;
                  }
                  v8 = v83;
                  v6 = "RW";
                  break;
                case 14:
                  // Planet Square Window
                  v6 = "PSW";
                  pTypeA1 = (T_Wnd *)operator new(0xADu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd14PSW_Ctor_sub_39D80((P_Wnd14PSW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 15:
                  // Number of turns
                  v6 = "NT";
                  pTypeA1 = (T_Wnd *)operator new(0xAFu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd15NT_Ctor_sub_2F2F4((P_Wnd15NT)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 16:
                  // Status Window (Planet Status Screen)
                  v6 = "SW";
                  pTypeA1 = (T_Wnd *)operator new(0xB1u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd16SW_Ctor_sub_51674((P_Wnd16SW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 17:
                  // Fleet Window (Ship Status Screen)
                  v6 = "FW";
                  pTypeA1 = (T_Wnd *)operator new(0xB1u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd17FW_Ctor_sub_51B64((P_Wnd17FW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 18:
                  // New Game Display
                  v6 = "NG";
                  pTypeA1 = (T_Wnd *)operator new(0xBDu);
                  if ( pTypeA1 )
                  {
                    Q_WndNGCtor_sub_520EC((P_Wnd18NG)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 19:
                  // Battle Control Window
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0x108u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd19BC_Ctor_sub_10A3C((P_Wnd19BC)pTypeA1);
                  }
                  v6 = "BC";
                  break;
                case 20:
                  // Help Window
                  v6 = "HW";
                  pTypeA1 = (T_Wnd *)operator new(0xDAFu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd20HW_Ctor_sub_2FC50((P_Wnd20HW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 21:
                  // Negotiation Window
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0xC3u);
                  if ( pTypeA1 )
                  {
                    Q_WndNW_sub_3201C((P_WndNW)pTypeA1);
                  }
                  v6 = "NW";
                  break;
                case 22:
                  // Ability Window
                  v6 = "AW";
                  pTypeA1 = (T_Wnd *)operator new(0xDAFu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd22AW_Ctor_sub_33830((P_Wnd22AW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 23:
                  // Event Window
                  v6 = "EW";
                  pTypeA1 = (T_Wnd *)operator new(0xDB3u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd23EW_Ctor_sub_267A0((P_Wnd23EW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 24:
                  // End Game Window
                  v6 = "EW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd24EW_Ctor_sub_27BF8((P_WndA2)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 25:
                  // Toggle Window
                  v6 = "TW";
                  pTypeA1 = (T_Wnd *)operator new(0xAFu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd25TW_Ctor_sub_2D464((P_Wnd25TW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 26:
                  // Alien Diplomacy (Communication Display)
                  v6 = "MW";
                  pTypeA1 = (T_Wnd *)operator new(0xB3u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd26MW_Ctor_sub_2FA18((P_Wnd26MW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 29:
                  // Planet Research, Prosperity, Production, Industry, Population, Project
                  v6 = "GSW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd29GSW_Ctor_sub_395EC((P_Wnd29GSW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 30:
                  // Start Game
                  v6 = "EW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd30EW_Ctor_sub_2712C((T_WndA2 *)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 31:
                  // Abandon Button
                  v6 = "pcw";
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_WndA2_Ctor_sub_2C830((P_WndA2)pTypeA1);
                    pTypeA1[1].magic12345678 = (int)&stru_961DC;
                  }
                  break;
                case 32:
                  // My Items (Player Items in this system)
                  v6 = "miw";
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_WndA2_Ctor_sub_2C830((P_WndA2)pTypeA1);
                    pTypeA1[1].magic12345678 = (int)&stru_961C4;
                  }
                  break;
                default:
                  goto LABEL_111;
              }
            }
            else
            {
              // TYPE           0
              v6 = "GW";
              pTypeA1 = (T_Wnd *)operator new(0xABu);
              if ( pTypeA1 )
              {
                Q_WndA2_Ctor_sub_2C830((P_WndA2)pTypeA1);
              }
              v8 = 2;
            }
            Q_RegisterDataInWinMgr_sub_2625C(pTypeA1, v8, v6);
            a1a = pTypeA1;
LABEL_111:
            pName = a1a->name;
            Q_RegisterWindowInWinMgr_sub_2C978((P_WndA2)a1a);
            // NAME
            fscanf(fp, "%s %s", bufc1, pName);
            // PARENT
            fscanf(fp, "%s", bufc1);
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              v13 = Q_WinMgr_FindWnd_sub_56DA8(pWinMgr, bufc1, 0);
              if ( !v13 )
              {
                sub_2620C("%s bad parent", pName);
                Q_PrintFailAndExit_sub_261B8(0, "..\\winmgr.cpp", 0xC8D);
              }
              v14 = (T_WndA2 *)a1a;
              a1a->parentIndex = v13->index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(v13, v14);
            }
            // STATE
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( mm = 0; mm < (__int16)bufi2; ++mm )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pWinMgr, a1a->index, bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xC97);
              }
              if ( !mm )
              {
                v16 = a1a;
                v17 = pWinMgr->winStates[bufi].Unknown_84;
                a1a->Unknown_1A = 0;
                v16->shapeCacheIndex = v17;
              }
            }
            // MOUSEFOCUS
            fscanf(fp, "%s %d", bufc1, &bufi);
            if ( bufi )
            {
              a1a->_mouseFocus = TRUE;
            }
            if ( wndType == 25 )
            {
              // BUTTONSTATE
              fscanf(fp, "%s %d", bufc1, &bufi);
              if ( bufi )
              {
                a1a[1].pane.window = (WINDOW *)0xFFFFFFFF;
              }
            }
            fscanf(fp, "%s %d", bufc1, &a1a->pane.x0);
            fscanf(fp, "%s %d", bufc1, &a1a->pane.y0);
            fscanf(fp, "%s %d", bufc1, &a1a->pane.x1);
            fscanf(fp, "%s %d", bufc1, &a1a->pane.y1);
            fscanf(fp, "%s %d", bufc1, &bufi);
            v18 = a1a;
            a1a->shapeNumber = bufi;
            if ( wndType == 0xF )
            {
              fscanf(fp, "%s %d", bufc1, &bufi);
              v18[1].pane.window = (WINDOW *)bufi;
            }
            fscanf(fp, "%s %d", bufc1, &bufi);
            v19 = a1a;
            a1a->Unknown_59 = bufi;
            fscanf(fp, "%s %d", bufc1, &v19->sendMessage);
            fscanf(fp, "%s %d", bufc1, &v19->sendParam1);
            fscanf(fp, "%s %d", bufc1, &v19->sendParam2);
            fscanf(fp, "%s %s", bufc1, v19->helpIndex);
            // WINITEMS
            fscanf(fp, "%s %d", bufc1, &bufi);
            t19 = (int)v19->_t19;
            v95 = 0;
            winItems = bufi;
            if ( (__int16)bufi > 0 )
            {
              p_hotX = &v19->_t19[0].hotX;
              p_hotY = &v19->_t19[0].hotY;
              p_shapeNumber = (WORD *)&v19->_t19[0]._shapeNumber;
              do
              {
                fscanf(fp, "%s %d", bufc1, &bufi);
                if ( bufi )
                {
                  if ( bufi == 1 )
                  {
                    // SHAPEITEM      1
                    v71 = p_hotY;
                    v69 = p_shapeNumber;
                    *(_BYTE *)t19 = 1;
                    fscanf(fp, "%s %d %d %d", bufc1, v69, p_hotX, v71);
                    *(_DWORD *)(t19 + 1) = (unsigned __int16)Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, bufc1, 0xFFFFFFFF);
                  }
                  else
                  {
                    Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xCE1);
                  }
                }
                else
                {
                  // TEXTITEM       0
                  v70 = p_hotY;
                  v68 = p_shapeNumber;
                  *(_BYTE *)t19 = 0;
                  fscanf(fp, "%s %d %d %d", bufc1, v68, p_hotX, v70);
                  *(_DWORD *)(t19 + 1) = sub_2D334(bufc1);
                }
                v22 = p_hotY;
                sub_2D400((int)a1a, t19);
                p_hotX = (WORD *)((char *)p_hotX + 0xD);
                t19 += 0xD;
                p_hotY = (WORD *)((char *)v22 + 0xD);
                ++v95;
                p_shapeNumber = (WORD *)((char *)p_shapeNumber + 0xD);
              }
              while ( (__int16)v95 < (__int16)winItems );
            }
            a1a->pane.window = pWinMgr->window;
          }
          else if ( (unsigned int)bufi <= 100 )
          {
            // TYPE           100
            // STATENUMBER    0
            // SHAPEFILE      DATA\0OPENING.SHP
            fscanf(fp, "%s %d", bufc1, &bufi);
            fscanf(fp, "%s %s", bufc1, bufc4);
            v54 = Q_Cache_AddFile_sub_1ADAC(v85, bufc4);
            if ( !sub_5748C(pWinMgr, bufi, v54) )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xECA);
            }
          }
          else
          {
            if ( (unsigned int)bufi < 200 )
            {
              goto LABEL_262;
            }
            if ( (unsigned int)bufi <= 200 )
            {
              // HAZEVIBLES     200
              // NUMTABLES      23
              fscanf(fp, "%s %d", bufc1, &bufi);
              l = 0;
              Q_AllocateHazeTables_sub_2C08C(&V_GSystem, bufi);
              while ( l < bufi )
              {
                v56 = l;
                fscanf(fp, "%s %s", bufc1, bufc2);
                ++l;
                Q_LoadHazeTables_sub_2C0C0(&V_GSystem, bufc2, v56);
              }
            }
            else
            {
              if ( bufi != 300 )
              {
                goto LABEL_262;
              }
              // FONTS          300
              // SMALLFONT      DATA\SMFONT.FNT
              fscanf(fp, "%s %s", bufc1, bufc3);
              if ( sub_2B360(p_SmallFont, bufc3) != TRUE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xEE6);
              }
              pWinMgr->SmallFont.backColor = 0;
              // LARGEFONT      DATA\BIGFONT.FNT
              fscanf(fp, "%s %s", bufc1, bufc3);
              if ( sub_2B360(p_LargeFont, bufc3) != TRUE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xEEB);
              }
              pWinMgr->LargeFont.backColor = 0;
            }
          }
        }
      }
    }
  }
}
// 96BAC: using guessed type int dword_96BAC;
// 57670: using guessed type T_Control var_54;
// 57670: using guessed type char anonymous_3[108];
// 57670: using guessed type char anonymous_4[108];
// 57670: using guessed type char bufc2[108];
// 57670: using guessed type char bufc4[108];
// 57670: using guessed type char flicName[108];
// 57670: using guessed type char anonymous_8[32];

//----- (00059828) --------------------------------------------------------
void __fastcall Q_LoadAscendCfg_sub_59828(P_WinMgr a1)
{
  T_CFile v2; // [esp-124h] [ebp-128h] BYREF

  Q_CFile_Ctor_sub_1BB78(&v2);
  if ( !Q_CFile_Open_sub_1BBFC(&v2, "ascend.cfg", O_BINARY, 0) )
  {
    Q_CFile_Read_sub_1BF94(&v2, &V_SSystem.soundEffectsOff, 4u);
    Q_CFile_Read_sub_1BF94(&v2, &V_SSystem.musicOff, 4u);
    Q_CFile_Read_sub_1BF94(&v2, &a1->j, 4u);
  }
  Q_CFile_Dtor_sub_1BBC8(&v2);
}

//----- (0005989C) --------------------------------------------------------
void __fastcall Q_SaveAscendCfg_sub_5989C(P_WinMgr pWinMgr)
{
  T_CFile CFile; // [esp-120h] [ebp-124h] BYREF

  Q_CFile_Ctor_sub_1BB78(&CFile);
  if ( !Q_CFile_Create_sub_1BCA8(&CFile, "ascend.cfg") )
  {
    Q_CFile_Write_sub_1C098(&CFile, &V_SSystem.soundEffectsOff, 4u);
    Q_CFile_Write_sub_1C098(&CFile, &V_SSystem.musicOff, 4u);
    Q_CFile_Write_sub_1C098(&CFile, &pWinMgr->j, 4u);
  }
  Q_CFile_Dtor_sub_1BBC8(&CFile);
}

//----- (00059908) --------------------------------------------------------
void __fastcall __spoils<> sub_59908(P_WinMgr pWinMgr)
{
  if ( !pWinMgr->aaa && !pWinMgr->bbb )
  {
    pWinMgr->aaa = TRUE;
    pWinMgr->winEventsNum = 0;
    pWinMgr->_time = 0;
  }
}

//----- (00059934) --------------------------------------------------------
void __fastcall Q_WinMgr_RecordWinEvents_sub_59934(P_WinMgr pWinMgr, int toTxt)
{
  if ( pWinMgr->aaa == 0xFFFFFFFF || pWinMgr->bbb == 0xFFFFFFFF )
  {
    if ( pWinMgr->aaa == 0xFFFFFFFF )
    {
      pWinMgr->aaa = 0;
      Q_WINMGR_CPP_WriteWinEventBin_sub_59DE0(pWinMgr);
      if ( toTxt )
      {
        Q_WINMGR_CPP_WinEventBinToTxt_sub_59E88(pWinMgr, "WINEVENT.BIN", "WINEVENT.TXT");
      }
    }
    pWinMgr->bbb = 0;
  }
}

//----- (00059988) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_WinMgr_PlayWinEvents_sub_59988(P_WinMgr a1, char *wineventBinFileName, int a3)
{
  int aaa; // ecx
  MACRO_VFX_BOOL result; // eax

  strcpy(byte_132B20, wineventBinFileName);
  strcpy(&byte_132B20[strlen(byte_132B20) - 4], ".txt");
  dword_132B14 = V_Mouse.left;
  aaa = a1->aaa;
  dword_132B18 = V_Mouse.right;
  if ( aaa == TRUE || a1->bbb == TRUE )
  {
    return FALSE;
  }
  result = sub_59CFC(a1, wineventBinFileName);
  if ( result )
  {
    a1->bbb = TRUE;
    a1->_time = 0;
    result = TRUE;
    a1->Unknown_48BE = 0;
    a1->Unknown_48AE = a3;
    V_TutorialInfoIndex = 0;
  }
  return result;
}
// 132B14: using guessed type int dword_132B14;
// 132B18: using guessed type int dword_132B18;
// 132B1C: using guessed type int V_TutorialInfoIndex;

//----- (00059A54) --------------------------------------------------------
P_WinMgr __fastcall sub_59A54(P_WinMgr a1)
{
  P_WinMgr v1; // ecx
  unsigned int v2; // edi
  LONG y; // ebp
  LONG v4; // eax
  int v5; // eax
  T_Wnd20HW *Wnd_sub_56DA8; // esi
  unsigned int v7; // eax
  LONG x; // [esp+0h] [ebp-1Ch]

  v1 = a1;
  if ( a1->bbb )
  {
    x = V_Mouse.x;
    V_Mouse.left = dword_132B14;
    v2 = 0xFFFFFFFF;
    V_Mouse.right = dword_132B18;
    y = V_Mouse.y;
    Q_ProcessInput_sub_2656C(&V_InputSystem);
    if ( V_Keyboard.Pressed == 0xFFFFFFFF
      || V_Mouse.leftClicked == 0xFFFFFFFF && V_Mouse.left
      || V_Mouse.rightClicked == 0xFFFFFFFF && V_Mouse.right )
    {
      v4 = V_Mouse.x;
      v1->bbb = 0;
      y = V_Mouse.y;
      x = v4;
      v5 = 0;
      if ( !v1->Unknown_489E )
      {
        Wnd_sub_56DA8 = (T_Wnd20HW *)Q_WinMgr_FindWnd_sub_56DA8(v1, "HELPWINDOW", 0);
        Q_Wnd20HW_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, "help.txt", "endtut");
        v5 = sub_552F8(v1, &Wnd_sub_56DA8->super, 0);
      }
      if ( v5 )
      {
        v7 = time(0);
        srand(v7);
        v2 = 0;
        LODWORD(v1->j) = dword_96BBC;
      }
      else
      {
        v1->bbb = 0xFFFFFFFF;
      }
    }
    if ( v2 )
    {
      V_Mouse.y = y;
      V_Mouse.moved = 0;
      V_Mouse.x = x;
    }
    dword_132B14 = V_Mouse.left;
    a1 = (P_WinMgr)V_Mouse.right;
    dword_132B18 = V_Mouse.right;
  }
  return a1;
}
// 96BBC: using guessed type int dword_96BBC;
// 132B14: using guessed type int dword_132B14;
// 132B18: using guessed type int dword_132B18;

//----- (00059B80) --------------------------------------------------------
void __fastcall sub_59B80(P_WinMgr pWinMgr)
{
  T_WinEvent *winEvents; // esi
  int Unknown_48BE; // eax
  P_WinEvent pWinEvent; // eax
  WORD eventType; // dx
  int v6; // edx
  int winEventsNum; // ebx

  winEvents = pWinMgr->winEvents;
  V_Mouse.leftClicked = 0;
  V_Mouse.rightClicked = 0;
  V_Mouse.moved = 0;
  V_Keyboard.Pressed = 0;
  while ( 1 )
  {
    Unknown_48BE = pWinMgr->Unknown_48BE;
    if ( pWinMgr->_time < (unsigned int)pWinMgr->winEvents[Unknown_48BE].time )
    {
      break;
    }
    pWinEvent = &winEvents[Unknown_48BE];
    eventType = pWinEvent->eventType;
    if ( !eventType )
    {
      goto LABEL_5;
    }
    if ( (unsigned __int16)eventType <= 3u )
    {
      Q_WinEvent_ProcessInput_sub_265A8(pWinEvent);
    }
    else if ( (unsigned __int16)eventType > 7u )
    {
LABEL_5:
      sprintf(
        "Thank you for playing Ascendancy.",
        "\nBad Trace Event: %d of %d\n\nEVENT[%d] HWND[%0d] MSG[%d] P1[%d] P2[%d]\n",
        pWinMgr->Unknown_48BE,
        pWinMgr->winEventsNum,
        pWinEvent->eventType,
        pWinEvent->hwnd,
        pWinEvent->msg,
        pWinEvent->p1,
        pWinEvent->p2);
      Q_debugbreak_exit_sub_2624C();
    }
    v6 = pWinMgr->Unknown_48BE + 1;
    winEventsNum = pWinMgr->winEventsNum;
    pWinMgr->Unknown_48BE = v6;
    if ( v6 >= winEventsNum )
    {
      if ( pWinMgr->Unknown_48AE != 0xFFFFFFFF )
      {
        Q_WinMgr_RecordWinEvents_sub_59934(pWinMgr, 0);
        return;
      }
      pWinMgr->Unknown_48BE = 0;
      pWinMgr->_time = 0;
    }
  }
}

//----- (00059C80) --------------------------------------------------------
void __fastcall Q_WinMgr_sub_59C80(P_WinMgr pWinMgr, int hwnd, WORD eventType, WORD msg, int p1, int p2, int f)
{
  T_WinEvent *v8; // edx
  int v9; // edi

  if ( pWinMgr->aaa == TRUE && !pWinMgr->bbb )
  {
    v8 = &pWinMgr->winEvents[pWinMgr->winEventsNum];
    v8->time = pWinMgr->_time;
    v8->hwnd = hwnd;
    v8->eventType = eventType;
    v8->msg = msg;
    v8->p1 = p1;
    v8->p2 = p2;
    v8->f = f;
    v9 = pWinMgr->winEventsNum + 1;
    pWinMgr->winEventsNum = v9;
    if ( v9 == 5000 )
    {
      Q_WinMgr_RecordWinEvents_sub_59934(pWinMgr, FALSE);
    }
  }
}

//----- (00059CFC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_59CFC(P_WinMgr a1, const char *a2)
{
  MACRO_VFX_BOOL v3; // ebx
  unsigned int v4; // eax
  T_CFile CFile; // [esp+0h] [ebp-124h] BYREF

  Q_CFile_Ctor_sub_1BB78(&CFile);
  if ( a1->aaa == TRUE )
  {
    Q_CFile_Dtor_sub_1BBC8(&CFile);
    return FALSE;
  }
  else
  {
    if ( Q_CFile_Open_sub_1BBFC(&CFile, a2, 0x200, 0) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x104F);
    }
    if ( (unsigned int)Q_CFile_GetLength_sub_1BE28(&CFile) > 120016 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1052);
    }
    Q_CFile_Read_sub_1BF94(&CFile, a1->Unknown_21D82, 16u);
    v4 = Q_CFile_Read_sub_1BF94(&CFile, a1->winEvents, 120000u);
    a1->winEventsNum = v4 / sizeof(T_WinEvent);
    if ( v4 % sizeof(T_WinEvent) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x1059);
    }
    v3 = TRUE;
    a1->Unknown_48BE = 0;
    Q_CFile_Dtor_sub_1BBC8(&CFile);
  }
  return v3;
}

//----- (00059DE0) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_WriteWinEventBin_sub_59DE0(P_WinMgr a1)
{
  T_CFile fi; // [esp-124h] [ebp-128h] BYREF

  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( a1->aaa != 0xFFFFFFFF )
  {
    if ( Q_CFile_Open_sub_1BBFC(&fi, "WINEVENT.BIN", 0x21, 0) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x106C);
    }
    Q_CFile_Write_sub_1C098(&fi, a1->Unknown_21D82, 0x10u);
    Q_CFile_Write_sub_1C098(&fi, a1->winEvents, 0x18 * a1->winEventsNum);
  }
  Q_CFile_Dtor_sub_1BBC8(&fi);
}

//----- (00059E88) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_WinEventBinToTxt_sub_59E88(P_WinMgr pWinMgr, char *binname, char *txtname)
{
  FILE *fp; // ecx
  __int16 i; // bx
  const char *v6; // eax
  const char *v7; // eax
  const char *v8; // eax
  const char *v9; // eax
  T_WinEvent *pWinEvent; // edx
  const char *v11; // [esp-4h] [ebp-8h]

  if ( !pWinMgr->aaa && !pWinMgr->bbb )
  {
    fp = fopen(txtname, "w");
    if ( !fp )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x107D);
    }
    if ( sub_59CFC(pWinMgr, binname) != 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x1080);
    }
    for ( i = 0; i < pWinMgr->winEventsNum; ++i )
    {
      pWinEvent = &pWinMgr->winEvents[i];
      switch ( pWinEvent->eventType )
      {
        case EVT_MOUSE_POS:
          fprintf(fp, " TIME[%05lu]  EVT_MOUSE_POS    : ", pWinEvent->time);
          fprintf(fp, " Moved to (%03d,%03d)\n", pWinEvent->p1, pWinEvent->p2);
          break;
        case EVT_MOUSE_BUTTON:
          fprintf(fp, " TIME[%05lu]  EVT_MOUSE_BUTTON :  ", pWinEvent->time);
          if ( pWinEvent->p2 )
          {
            v6 = "DOWN";
          }
          else
          {
            v6 = "UP";
          }
          v11 = v6;
          if ( pWinEvent->p1 )
          {
            v7 = "Right";
          }
          else
          {
            v7 = "Left";
          }
          fprintf(fp, "%s Button %s\n", v7, v11);
          break;
        case EVT_KEYBOARD:
          fprintf(fp, " TIME[%05lu]  EVT_KEYBOARD     : ", pWinEvent->time);
          fprintf(fp, " '%c'  (%04d)\n", SLOBYTE(pWinEvent->p2), pWinEvent->p1);
          break;
        case EVT_REQ_CONT:
        case EVT_CAN_CONT:
          if ( pWinEvent->eventType == 4 )
          {
            v8 = "EVT_REQ_CONT";
          }
          else
          {
            v8 = "EVT_CAN_CONT";
          }
          fprintf(fp, " TIME[%05lu]  %-15s: ", pWinEvent->time, v8);
          fprintf(fp, " HWND[%04d] MSG[%04d] P1[%04d] P2[%04d]\n", pWinEvent->hwnd, pWinEvent->msg, pWinEvent->p1, pWinEvent->p2);
          break;
        case EVT_REQ_CHANGE:
        case EVT_CAN_CHANGE:
          if ( pWinEvent->eventType == 6 )
          {
            v9 = "EVT_REQ_CHANGE";
          }
          else
          {
            v9 = "EVT_CAN_CHANGE";
          }
          fprintf(fp, " TIME[%05lu]  %-15s: ", pWinEvent->time, v9);
          fprintf(
            fp,
            " HWND[%04d] MSG[%04d] P1[%04d] P2[%04d] F[%04d]\n",
            pWinEvent->hwnd,
            pWinEvent->msg,
            pWinEvent->p1,
            pWinEvent->p2,
            pWinEvent->f);
          break;
        default:
          fprintf(fp, " *** Unrecognized event type : %d\n", pWinEvent->eventType);
          break;
      }
    }
    fclose(fp);
  }
}

//----- (0005A094) --------------------------------------------------------
void __fastcall Q_WinMgr_AddWinData_sub_5A094(P_WinMgr pWinMgr, void *pData, int category, char *name)
{
  __int16 i; // dx
  int v8; // eax
  char *v9; // ecx
  char *v10; // edi

  if ( pWinMgr->winDatasNum == 384 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x10CB);
  }
  for ( i = 0; ; ++i )
  {
    if ( i >= 384 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x10DD);
    }
    v8 = i;
    v9 = (char *)pWinMgr + v8 * 0x20;
    if ( !pWinMgr->winDatas[v8].pData )
    {
      break;
    }
  }
  *(_DWORD *)(v9 + 0x21DB2) = pData;
  *(_DWORD *)(v9 + 0x21D96) = category;
  v10 = pWinMgr->winDatas[v8].name;
  strncpy(v10, name, 19u);
  v9[0x21DB1] = 0;
  strupr(v10);
  *(_DWORD *)(v9 + 0x21D9A) = V_Timer_dword_132B58;
  ++pWinMgr->winDatasNum;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (0005A144) --------------------------------------------------------
void __fastcall Q_WinMgr_RemoveWinData_sub_5A144(P_WinMgr pWinMgr, void *pData)
{
  __int16 i; // dx

  if ( pData )
  {
    for ( i = 0; i < 384; ++i )
    {
      if ( pData == pWinMgr->winDatas[i].pData )
      {
        pWinMgr->winDatas[i].pData = 0;
        --pWinMgr->winDatasNum;
        return;
      }
    }
    Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x10F1);
  }
}

//----- (0005A194) --------------------------------------------------------
char *__fastcall sub_5A194(P_WinMgr pWinMgr, void *a2, int *outCategory, int *outTime)
{
  WORD winDatasNum; // dx
  __int16 v7; // ax

  winDatasNum = pWinMgr->winDatasNum;
  v7 = 0;
  if ( winDatasNum <= 0 )
  {
    return NULL;
  }
  while ( a2 != pWinMgr->winDatas[v7].pData )
  {
    if ( ++v7 >= pWinMgr->winDatasNum )
    {
      return NULL;
    }
  }
  if ( outCategory )
  {
    *outCategory = pWinMgr->winDatas[v7].category;
  }
  if ( outTime )
  {
    *outTime = pWinMgr->winDatas[v7].time;
  }
  return pWinMgr->winDatas[v7].name;
}

//----- (0005A270) --------------------------------------------------------
void __fastcall Q_WinMgr_SetMousePointerShape_sub_5A270(P_WinMgr pWinMgr, int mouseShapeNumber, void *table, BOOL bForce)
{
  if ( !pWinMgr->Unknown_24DA4 || bForce == TRUE )
  {
    Q_GSystem_SetMousePointerShape_sub_2C7D0(&V_GSystem, mouseShapeNumber, table);
  }
}

//----- (0005A294) --------------------------------------------------------
void __fastcall Q_WinMgr_CallProc6_sub_5A294(P_WinMgr a1, P_CFile pfi, int read)
{
  int i; // kr04_4

  for ( i = 0; i != 0x400; ++i )
  {
    if ( a1->wnds[i].activeCount )
    {
      a1->wnds[i].pWndA2->pProcs->proc6_file(a1->wnds[i].pWndA2, pfi, read);
    }
  }
}

//----- (0005A320) --------------------------------------------------------
void __fastcall Q_Proc_sub_5A320(__int16 a1)
{
  UWORD itemIndex; // cx
  void *ShapeTable_sub_1B084; // eax

  switch ( a1 )
  {
    case 1:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\1starmap.tmp", TRUE);
      goto LABEL_12;
    case 2:
    case 4:
    case 0xA:
    case 0xE:
    case 0xF:
    case 0x12:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\10status.tmp", TRUE);
      goto LABEL_12;
    case 3:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\3cfgnew.tmp", TRUE);
      goto LABEL_12;
    case 7:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\7racesel.tmp", TRUE);
      goto LABEL_12;
    case 8:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\8shipdes.tmp", TRUE);
      goto LABEL_12;
    case 9:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\9ENDGAME.tmp", TRUE);
      goto LABEL_12;
    case 0xC:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\12start.tmp", TRUE);
      goto LABEL_12;
    case 0xD:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\13negot.tmp", TRUE);
      goto LABEL_12;
    case 0x10:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\16battle.tmp", TRUE);
      goto LABEL_12;
    case 0x14:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\20res.tmp", TRUE);
LABEL_12:
      if ( itemIndex == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1168);
      }
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, itemIndex);
      VFX_shape_draw(&V_GSystem.pane, ShapeTable_sub_1B084, 0, 0, 0);
      break;
    default:
      return;
  }
}

//----- (0005A47C) --------------------------------------------------------
void __fastcall sub_5A47C(PANE *pPane, void *pData, int param1, BOOL hovered)
{
  __int16 v5; // ax
  WORD v6; // [esp+2h] [ebp-10h]

  v5 = 0xF2;
  v6 = word_96BC4[param1];
  if ( hovered == 0xFFFFFFFF )
  {
    v5 = 0x96;
  }
  VFX_pane_wipe(pPane, v5);
  WinMgr.LargeFont.pane = *pPane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, (const char *)pData, 0x40u, v6, 0xFF, 0);
}
// 96BC4: using guessed type __int16 word_96BC4[8];

//----- (0005A4E4) --------------------------------------------------------
LONG __fastcall sub_5A4E4(PANE *a1, LONG a2, int a3, int a4)
{
  WORD bgColor; // bx
  WORD wipeColor; // ax
  PANE v8; // [esp+0h] [ebp-30h] BYREF
  char s[12]; // [esp+14h] [ebp-1Ch] BYREF
  LONG color; // [esp+20h] [ebp-10h]

  bgColor = 0xF3;
  color = a2;
  sprintf(s, "%03d", a2);
  wipeColor = 0xF2;
  if ( a2 == V_DebugPickedColor )
  {
    wipeColor = 0xFE;
    bgColor = 0;
  }
  if ( a4 )
  {
    wipeColor = 0xF1;
  }
  WinMgr.LargeFont.pane = *a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, s, 0x40u, bgColor, wipeColor, 0);
  v8 = *a1;
  v8.x0 += 35;
  --v8.y1;
  ++v8.y0;
  return VFX_pane_wipe(&v8, color);
}

//----- (0005A594) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd13DBGWND_Ctor_sub_5A594(P_Wnd13DBGWND a1)
{
  Q_WndA2_Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = &Win13DBGWND_Procs;
}

//----- (0005A5AC) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd13DBGWND_Dtor_sub_5A5AC(P_Wnd13DBGWND self, unsigned int a2)
{
  char v2; // cl
  char *v3; // eax

  v2 = a2;
  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(self, &C_Wnd13DBGWND);
    operator delete[](v3);
  }
  else
  {
    self->a2.pProcs = &Win13DBGWND_Procs;
    Q_WndA2_Dtor_sub_2C848(&self->a2, 1);
    if ( (v2 & 2) != 0 )
    {
      operator delete(self);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0005A5F4) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_5A5F4(P_Wnd a1)
{
  a1->index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, (P_WndA2)a1);
}

//----- (0005A60C) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Wnd13DBGWND_Proc3_sub_5A60C(P_Wnd13DBGWND pWnd13DBGWND, UWORD message, int param1, int param2)
{
  T_Wnd10LB *pDbgWndList; // eax
  T_Wnd10LB *v7; // ecx
  T_Wnd10LB *pDbgWndList_; // eax
  T_Wnd10LB *v9; // ecx
  T_Wnd10LB *Wnd_sub_56DA8; // eax
  T_Wnd10LB *v11; // ecx
  T_Wnd10LB *v12; // eax
  T_Wnd10LB *v13; // ecx
  T_Wnd10LB *v14; // eax
  T_Wnd10LB *v15; // ecx
  char tabIndex; // ah
  T_Wnd10LB *pListBox; // eax
  T_Wnd10LB *v18; // eax
  T_Wnd10LB *v19; // ecx

  if ( message < (unsigned int)ASCEND_WM_DBGWND_MEMORY )
  {
    if ( message < 0xC8u )
    {
      if ( message && (message <= 2u || message >= 6u && message <= 7u) )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd13DBGWND->a2, message, (unsigned __int16)param1, param2);
      }
      return FALSE;
    }
    if ( message <= 0xC8u )
    {
      pWnd13DBGWND->tabIndex = 0;
      pDbgWndList = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
      v7 = pDbgWndList;
      if ( !pDbgWndList )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x11D1);
      }
      Q_Wnd10LB_Clear_sub_2ED4C(pDbgWndList);
      v7->Unknown_AB = 0xFFFFFFFF;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(v7, sub_5A47C);
      if ( !v7->memPoolAllocated && Q_Wnd10LB_InitMemPool_sub_2F228(v7, 0x2000, 0) == FALSE )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x11D9);
      }
      sub_5AE68(pWnd13DBGWND, v7);
      return FALSE;
    }
    else if ( message <= 0xCAu )
    {
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, (__int16)message, 0);
      return TRUE;
    }
    else if ( message == 0x3EA )
    {
      if ( pWnd13DBGWND->tabIndex )
      {
        pWnd13DBGWND->tabIndex = 0;
        pDbgWndList_ = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
        v9 = pDbgWndList_;
        if ( !pDbgWndList_ )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x11F0);
        }
        pDbgWndList_->Unknown_AB = 0xFFFFFFFF;
        Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(pDbgWndList_, sub_5A47C);
        Q_Wnd10LB_Clear_sub_2ED4C(pDbgWndList_);
        sub_5AE68(pWnd13DBGWND, v9);
        pWnd13DBGWND->a2.pProcs->proc4_draw((P_WndA2)pWnd13DBGWND, 0);
      }
      return TRUE;
    }
    else
    {
      return FALSE;
    }
  }
  else if ( message <= (unsigned int)ASCEND_WM_DBGWND_MEMORY )
  {
    if ( pWnd13DBGWND->tabIndex != 1 )
    {
      // MEMORY
      pWnd13DBGWND->tabIndex = 1;
      Wnd_sub_56DA8 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
      v11 = Wnd_sub_56DA8;
      if ( !Wnd_sub_56DA8 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1204);
      }
      Wnd_sub_56DA8->Unknown_AB = 0xFFFFFFFF;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(Wnd_sub_56DA8, sub_5A47C);
      Q_Wnd10LB_Clear_sub_2ED4C(Wnd_sub_56DA8);
      sub_5AB2C(pWnd13DBGWND, v11);
      pWnd13DBGWND->a2.pProcs->proc4_draw((P_WndA2)pWnd13DBGWND, 0);
    }
    return TRUE;
  }
  else if ( message < 0x3EEu )
  {
    if ( message <= (unsigned int)ASCEND_WM_DBGWND_CACHE )
    {
      if ( pWnd13DBGWND->tabIndex != 2 )
      {
        // CACHE
        pWnd13DBGWND->tabIndex = 2;
        v12 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
        v13 = v12;
        if ( !v12 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1218);
        }
        v12->Unknown_AB = 0xFFFFFFFF;
        Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(v12, sub_5A47C);
        Q_Wnd10LB_Clear_sub_2ED4C(v12);
        sub_5AF30((int)pWnd13DBGWND, v13);
        pWnd13DBGWND->a2.pProcs->proc4_draw((P_WndA2)pWnd13DBGWND, 0);
      }
      return TRUE;
    }
    else
    {
      if ( pWnd13DBGWND->tabIndex != 3 )
      {
        // PALETTE
        pWnd13DBGWND->tabIndex = 3;
        v18 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
        v19 = v18;
        if ( !v18 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x122B);
        }
        v18->Unknown_AB = 0;
        Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(v18, (P_DrawItemFunc)sub_5A4E4);
        Q_Wnd10LB_Clear_sub_2ED4C(v18);
        sub_5B200(pWnd13DBGWND, v19);
        pWnd13DBGWND->a2.pProcs->proc4_draw((P_WndA2)pWnd13DBGWND, 0);
      }
      return TRUE;
    }
  }
  else
  {
    if ( message > 0x3EEu )
    {
      if ( message >= 0x3F1u )
      {
        if ( message <= 0x3F1u )
        {
          if ( pWnd13DBGWND->tabIndex == 3 )
          {
            pListBox = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
            if ( !pListBox )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1262);
            }
            Q_Wnd10LB_SetSelectedIndex_sub_2ECDC(pListBox, V_DebugPickedColor);
            pWnd13DBGWND->a2.pProcs->proc4_draw((P_WndA2)pWnd13DBGWND, 0);
          }
          return TRUE;
        }
        else if ( message == 0x1C01 )
        {
          tabIndex = pWnd13DBGWND->tabIndex;
          if ( tabIndex == 3 )
          {
            if ( param2 == 5 )
            {
              (*WinMgr.hazeTableMapFocus)[0xF2] = param1;
            }
          }
          else if ( tabIndex == 4 )
          {
            sub_4F8CC(&V_SSystem, param1, 0);
          }
          return TRUE;
        }
        else
        {
          return FALSE;
        }
      }
      return FALSE;
    }
    if ( pWnd13DBGWND->tabIndex != 4 )
    {
      pWnd13DBGWND->tabIndex = 4;
      v14 = (T_Wnd10LB *)Q_WinMgr_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
      v15 = v14;
      if ( !v14 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x123E);
      }
      v14->Unknown_AB = 0xFFFFFFFF;
      Q_Wnd10LB_SetDrawItemFunc_sub_2F1C8(v14, sub_5A47C);
      Q_Wnd10LB_Clear_sub_2ED4C(v14);
      sub_5B244((int)pWnd13DBGWND, v15);
      pWnd13DBGWND->a2.pProcs->proc4_draw((P_WndA2)pWnd13DBGWND, 0);
    }
    return TRUE;
  }
}

//----- (0005AA08) --------------------------------------------------------
void __fastcall Q_Wnd13DBGWND_Proc4_sub_5AA08(P_Wnd13DBGWND pWnd13DBGWND, int a2)
{
  void *ShapeTable_sub_1B084; // eax
  char tabIndex; // dl
  const char *title; // esi
  char textOut[20]; // [esp+0h] [ebp-18h] BYREF
  P_Wnd13DBGWND pWnd13DBGWND_; // [esp+14h] [ebp-4h]

  pWnd13DBGWND_ = pWnd13DBGWND;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd13DBGWND->a2.shapeCacheIndex);
  VFX_shape_draw(&pWnd13DBGWND_->a2.pane, ShapeTable_sub_1B084, 0, 0, 0);
  VFX_pane_wipe(&pWnd13DBGWND_->pane, 0xF2);
  tabIndex = pWnd13DBGWND_->tabIndex;
  if ( tabIndex )
  {
    if ( tabIndex == 1 )
    {
      title = "MEMORY    ";
    }
    else if ( tabIndex == 2 )
    {
      title = "CACHE     ";
    }
    else
    {
      title = "PALETTE   ";
    }
  }
  else
  {
    title = "WINDOWS   ";
  }
  strcpy(textOut, title);
  Q_Font_SetPaneRect_sub_2B3E0(
    &WinMgr.LargeFont,
    pWnd13DBGWND_->pane.x0,
    pWnd13DBGWND_->pane.y0,
    pWnd13DBGWND_->pane.x1,
    pWnd13DBGWND_->pane.y0 + 50);
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, textOut, 0, 0xFFFF, 0xFFFF, 0);
  sub_2D218(&pWnd13DBGWND_->a2);
}
// 5AA08: using guessed type char textOut[20];

//----- (0005AB04) --------------------------------------------------------
int __fastcall proc(const char **a1, const char **a2)
{
  return strncmp(*a1, *a2, 6u);
}

//----- (0005AB2C) --------------------------------------------------------
void __fastcall sub_5AB2C(P_Wnd13DBGWND a1, P_Wnd10LB result)
{
  int v2; // ebp
  int v3; // edi
  char *name; // eax
  unsigned __int16 v5; // ax
  __int16 v6; // cx
  unsigned __int16 v7; // ax
  int v8; // edi
  unsigned __int16 v9; // ax
  unsigned __int16 v10; // ax
  int v11; // ecx
  unsigned __int16 v12; // ax
  int v13; // edi
  unsigned __int16 v14; // ax
  unsigned __int16 v15; // ax
  unsigned __int16 v16; // ax
  char s[80]; // [esp+0h] [ebp-98h] BYREF
  struct _heapinfo heapinfo; // [esp+50h] [ebp-48h] BYREF
  int winDataCategory; // [esp+60h] [ebp-38h] BYREF
  int winDataTime; // [esp+64h] [ebp-34h] BYREF
  int v21; // [esp+68h] [ebp-30h]
  int v22; // [esp+6Ch] [ebp-2Ch]
  int v23; // [esp+70h] [ebp-28h]
  int v24; // [esp+74h] [ebp-24h]
  int v25; // [esp+78h] [ebp-20h]
  int v26; // [esp+7Ch] [ebp-1Ch]
  __int16 v27; // [esp+80h] [ebp-18h]

  a1->tabIndex = 1;
  v23 = 0;
  LOWORD(v25) = 0;
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x12A9);
  }
  LOWORD(v24) = 0;
  v27 = 0;
  LOWORD(v26) = 0;
  v21 = 0;
  v22 = 0;
  v2 = 0;
  HIWORD(heapinfo._pentry) = 0;
  LODWORD(heapinfo._pentry) = 0;
  while ( !heapwalk(&heapinfo) )
  {
    if ( heapinfo._useflag )
    {
      v2 += heapinfo._size;
    }
    else
    {
      v3 = LODWORD(heapinfo._pentry) + 4;
      name = sub_5A194(&WinMgr, (void *)(LODWORD(heapinfo._pentry) + 4), &winDataCategory, &winDataTime);
      if ( name )
      {
        switch ( winDataCategory )
        {
          case 1:
          case 4:
          case 5:
            sprintf(s, "%06lu S%07lu %s", winDataTime, heapinfo._size, name);
            v9 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
            Q_Wnd10LB_SetItemValue_sub_2EC50(result, v9, winDataCategory);
            break;
          case 2:
            sprintf(s, "%06lu S%07lu WND[%s]", winDataTime, heapinfo._size, (const char *)(v3 + 0x20));
            v5 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
            v6 = v24;
            Q_Wnd10LB_SetItemValue_sub_2EC50(result, v5, winDataCategory);
            LOWORD(v24) = v6 + 1;
            v21 += heapinfo._size;
            break;
          case 3:
            sprintf(s, "%06lu S%07lu %s", winDataTime, heapinfo._size, name);
            v7 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
            v8 = v23;
            Q_Wnd10LB_SetItemValue_sub_2EC50(result, v7, winDataCategory);
            v23 = heapinfo._size + v8;
            LOWORD(v25) = v25 + 1;
            break;
          default:
            Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x12E3);
            break;
        }
      }
      else
      {
        ++v27;
      }
      v22 += heapinfo._size;
      LOWORD(v26) = v26 + 1;
    }
  }
  sprintf(s, "** %d WNDS USING %lu BYTES", (__int16)v24, v21);
  v10 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
  v11 = v23;
  Q_Wnd10LB_SetItemValue_sub_2EC50(result, v10, 0);
  sprintf(s, "** %d SHAPES USING %lu BYTES", (__int16)v25, v11);
  v12 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
  v13 = v22;
  Q_Wnd10LB_SetItemValue_sub_2EC50(result, v12, 0);
  sprintf(s, "** %d ITEMS IN HEAP USE %lu BYTES", (__int16)v26, v13);
  v14 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(result, v14, 0);
  sprintf(s, "** %d ITEMS ARE UNIDENTIFIED", v27);
  v15 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(result, v15, 0);
  sprintf(s, "** TOTAL FREE IN HEAP %lu BYTES", v2);
  v16 = Q_Wnd10LB_AddItem_sub_2EA8C(result, s, 0xFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(result, v16, 0);
  Q_Wnd10LB_SetCompareProc_sub_2F1D8(result, proc);
  Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(result);
}

//----- (0005AE68) --------------------------------------------------------
int __fastcall sub_5AE68(P_Wnd13DBGWND pDbgWnd, P_Wnd10LB pListBox)
{
  int state; // edx
  __int16 v4; // si
  WORD windowCount; // di
  int result; // eax
  int v7; // eax
  T_WndA2 *pWndA2; // edx
  char v9; // bl
  char s[72]; // [esp+0h] [ebp-48h] BYREF

  state = WinMgr.state;
  pDbgWnd->tabIndex = 0;
  v4 = 0x1F;
  windowCount = WinMgr.winStates[state]._windowCount;
  while ( 1 )
  {
    result = windowCount;
    if ( windowCount <= 0 )
    {
      break;
    }
    if ( v4 < 0 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x131E);
    }
    v7 = WinMgr.winStates[WinMgr.state]._wndIndexes[v4];
    if ( v7 )
    {
      pWndA2 = WinMgr.wnds[v7].pWndA2;
      if ( pWndA2->parentIndex )
      {
        v9 = 0x43;
      }
      else
      {
        v9 = 0x20;
      }
      sprintf(s, "%c HWND%03d %s", v9, v7, pWndA2->name);
      --windowCount;
      Q_Wnd10LB_AddItem_sub_2EA8C(pListBox, s, 0xFFFF, 0);
    }
    --v4;
  }
  return result;
}

//----- (0005AF30) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_5AF30(int a1, T_Wnd10LB *a2)
{
  int v3; // edi
  int v4; // edx
  unsigned __int16 v5; // ax
  int v6; // ecx
  T_Cache *v7; // kr08_4
  T_Cache *v8; // kr18_4
  int v9; // edx
  unsigned __int16 v10; // ax
  unsigned __int16 v11; // ax
  unsigned __int16 v12; // ax
  unsigned __int16 v13; // ax
  unsigned __int16 v14; // ax
  unsigned __int16 v15; // dx
  int v17; // kr04_4
  int i; // ebp
  char s[100]; // [esp+0h] [ebp-94h] BYREF
  T_Cache *v20; // [esp+64h] [ebp-30h]
  T_Cache *names; // [esp+68h] [ebp-2Ch]
  T_Cache *v22; // [esp+6Ch] [ebp-28h]
  T_Cache *p_cache; // [esp+70h] [ebp-24h]
  T_Cache *v24; // [esp+74h] [ebp-20h]
  T_Cache *v25; // [esp+78h] [ebp-1Ch]
  int v26; // [esp+7Ch] [ebp-18h]

  v3 = 0;
  p_cache = &WinMgr.cache;
  v26 = 0;
  names = (T_Cache *)WinMgr.cache.names;
  v24 = &WinMgr.cache;
  v17 = 0;
  while ( p_cache->activeCount > v26 )
  {
    sprintf(
      s,
      "%07d %s",
      WinMgr.cache.sizes[(unsigned __int16)WinMgr.cache.usageOrder[v17]],
      (const char *)names + 0x32 * (unsigned __int16)WinMgr.cache.usageOrder[v17]);
    v4 = WinMgr.cache.sizes[v17];
    strupr(s);
    v3 += v4;
    v5 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0);
    v6 = v26;
    Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v5, 1);
    v26 = v6 + 1;
    ++v17;
  }
  Q_Wnd10LB_AddItem_sub_2EA8C(a2, " ", 0xFFFF, 0);
  v22 = (T_Cache *)p_cache->names;
  v20 = p_cache;
  v7 = p_cache;
  v25 = p_cache;
  v8 = p_cache;
  for ( i = 0; i < 0xC8; ++i )
  {
    if ( v7->names[i][0] )
    {
      sprintf(s, "%s", (const char *)v22 + 0x32 * i);
      v9 = v8->sizes[i];
      strupr(s);
      v3 += v9;
      v10 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0);
      Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v10, 0);
    }
  }
  Q_Wnd10LB_AddItem_sub_2EA8C(a2, " ", 0xFFFF, 0);
  sprintf(s, "%03d ITEMS IN CACHE", p_cache->count);
  v11 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v11, 0);
  sprintf(s, "%03d ITEMS LOADED", p_cache->activeCount);
  v12 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v12, 0);
  Q_Wnd10LB_AddItem_sub_2EA8C(a2, " ", 0xFFFF, 0);
  sprintf(s, "%07d TOTAL CACHE SIZE", p_cache->size);
  v13 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v13, 0);
  sprintf(s, "%07d USED", v3);
  v14 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v14, 0);
  sprintf(s, "%07d FREE", p_cache->size - v3);
  v15 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0);
  return Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v15, 0);
}

//----- (0005B200) --------------------------------------------------------
int __fastcall sub_5B200(P_Wnd13DBGWND a1, T_Wnd10LB *a2)
{
  __int16 i; // si
  int result; // eax

  a1->tabIndex = 3;
  for ( i = 0; i < 0x100; result = Q_Wnd10LB_AddItem_sub_2EA8C(a2, (BYTE *)i++, 0xFFFF, FALSE) )
  {
    ;
  }
  return result;
}

//----- (0005B244) --------------------------------------------------------
int __fastcall sub_5B244(int result, T_Wnd10LB *a2)
{
  int i; // esi
  char s[96]; // [esp+0h] [ebp-60h] BYREF

  *(_BYTE *)(result + 0xBF) = 4;
  for ( i = 0; (__int16)i < V_SSystem.tracks; result = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFF, 0) )
  {
    sprintf(s, "%02d. %-24s (%d)", (__int16)i, V_SSystem.files[(__int16)i].fname, V_SSystem.files[(__int16)i].fpos);
    ++i;
  }
  return result;
}

//----- (0005B2B0) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B2B0(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &stru_96184);
    operator delete[](v4);
    return a1;
  }
  else
  {
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0005B2F0) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B2F0(T_WndA2 *result)
{
  Q_WndA2_Ctor_sub_2C830(result);
  result->pProcs = &stru_961C4;
  return result;
}

//----- (0005B300) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B300(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &stru_96198);
    operator delete[](v4);
    return a1;
  }
  else
  {
    Q_WndA2_Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0005B340) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B340(T_WndA2 *result)
{
  Q_WndA2_Ctor_sub_2C830(result);
  result->pProcs = &stru_961DC;
  return result;
}

// nfuncs=1993 queued=823 decompiled=823 lumina nreq=0 worse=0 better=0
#error "There were 1 decompilation failure(s) on 823 function(s)"

/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Watcom C++
*/

#include <math.h>
#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

void __noreturn sub_10000(); // weak
void __fastcall Q_BATCON_CPP_sub_10010(PANE *pane, int, int, int);
void __fastcall Q_BATCON_CPP_sub_10668(PANE *pane, char *a2, int powerState, int a4);
int __fastcall sub_10878(_DWORD *, int, int, int);
int __fastcall Q_CompareListBoxItems_sub_10A14(P_ListBoxItem item1, P_ListBoxItem item2);
void __fastcall __spoils<> Q_Wnd19BC_Ctor_sub_10A3C(P_Wnd19BC pWnd19BC);
void __fastcall __spoils<edx> Q_Wnd19BC_Dtor_sub_10A80(P_Wnd19BC a1, char a2);
void __fastcall __spoils<> Q_Wnd19BC_Init_sub_10AC4(P_Wnd19BC a1);
int __fastcall Q_Wnd19BC_Proc3_sub_10B24(P_Wnd19BC pWnd, UWORD message, int param1, int param2);
void __fastcall Q_Wnd19BC_Proc4_sub_11870(int a1, int a2);
int __fastcall sub_11BA4(P_Wnd19BC pWnd19BC);
int __fastcall sub_12140(P_Wnd19BC pWnd19BC);
void __fastcall sub_12238(P_Wnd19BC pWnd19BC, int a2);
void __fastcall sub_1229C(P_Wnd19BC pWnd19BC, int a2);
int __fastcall sub_12368(P_Wnd19BC pWnd19BC, int a2);
void __fastcall sub_1240C(int, int);
char *__fastcall sub_12440(char *result);
int __fastcall sub_12480(float *, float *, float);
unsigned int __fastcall sub_12618(int);
void __fastcall sub_12674(int);
// T_Wnd04BM *__usercall sub_126F8@<eax>(T_Wnd04BM *@<eax>, int sfx2@<edx>, int@<ebp>);
P_Type21 __fastcall sub_12AE4(P_Wnd04BM pWnd04BM, P_TargetObject a2);
void __fastcall sub_12B4C(int, int);
unsigned int __fastcall sub_12C98(P_Wnd04BM a1, int a2, int a3);
unsigned int __fastcall sub_12E88(int);
// int __usercall sub_12F7C@<eax>(int@<eax>, int ebp0@<ebp>);
unsigned int __fastcall sub_13370(int, int, int);
unsigned int __fastcall sub_136C4(int);
unsigned int __fastcall sub_1380C(int);
void __fastcall sub_139E0(P_Wnd04BM a1, int a2);
void __fastcall sub_13A28(P_Wnd04BM a1, int a2);
void __fastcall sub_13AD8(P_Wnd04BM a1, int a2);
void __fastcall __spoils<> Q_Vector3DCopy_sub_13BC0(P_Vector3D dst, P_Vector3D src);
void __fastcall __spoils<> Q_Vector3DCtor_sub_13BF0(P_Vector3D a1);
unsigned int __fastcall sub_13C10(P_Wnd04BM pWnd04BM);
unsigned int __fastcall sub_14224(T_Wnd04BM *);
int __fastcall sub_142D8(int);
int __fastcall sub_14490(int);
unsigned int __fastcall sub_145C0(int);
unsigned int __fastcall sub_147CC(int);
unsigned int __fastcall sub_14B18(int, int, int);
unsigned int __fastcall sub_15078(T_Wnd04BM *);
unsigned int __fastcall sub_15164(int);
unsigned int __fastcall sub_152E4(int, int, int, int);
void __fastcall sub_15630(P_Wnd04BM a1, int a2);
void __fastcall sub_156C0(int a1, int a2, unsigned __int16 shpNum);
void __fastcall __spoils<> sub_1577C(T_Wnd04BMt3 *a1);
void __fastcall __spoils<> sub_15788(T_Wnd04BMt3 *result);
int __fastcall sub_15794(int result, int);
int __fastcall sub_157B4(const void *, const void *); // idb
void __fastcall sub_157EC(P_Wnd04BMt3 a1);
char *__fastcall sub_15808(int, int, int);
int __fastcall sub_15948(P_Wnd04BMt3 a1, P_Wnd04BM a2);
void __fastcall __spoils<> sub_15D20(T_Wnd04BMt1 *a1);
void __fastcall __spoils<> sub_15D2C(T_Wnd04BMt1 *result);
int __fastcall sub_15D38(int result, const void *);
void __fastcall sub_15D74(P_Wnd04BMt1 a1, P_Wnd04BM a2);
void __fastcall sub_15DA4(P_Wnd04BMt1 a1, P_Wnd04BM a2, unsigned __int16 a3);
void __fastcall sub_15E1C(P_Wnd04BMt1 a1, P_Wnd04BM pWnd4BM);
void __fastcall __spoils<> Q_Wnd4BMCtor_sub_15ED4(P_Wnd04BM);
T_Vector3D *__fastcall Q_Wnd4BMDtor_sub_1604C(P_Wnd04BM, char);
int __fastcall sub_16120(P_Wnd04BM a1);
int __fastcall sub_16348(P_Wnd04BM pWnd4BM, unsigned __int16 message, LONG param1, signed int param2);
void __fastcall sub_16D6C(T_Wnd04BM *, int, int, int);
void __fastcall sub_16FC0(int, int edx0, int, int);
void __fastcall sub_171D0(int, int, int);
char *__fastcall sub_17204(int, int, int);
void __fastcall sub_17260(P_Wnd04BM pWnd);
void __fastcall sub_172B0(P_Wnd04BM pWnd04BM);
int __fastcall sub_173F4(P_Wnd04BM pWnd04BM);
int __fastcall sub_17430(P_Wnd04BM pWnd04BM);
void __fastcall sub_17E50(P_Wnd04BM a1, int a2);
void __fastcall sub_17E88(P_Wnd04BM pWnd04BM, P_Target pTarget);
void __fastcall sub_17F54(P_Wnd04BM a1);
void __fastcall sub_17FF0(P_Wnd04BM a1);
void __fastcall sub_181F0(P_Wnd04BM a1);
void __fastcall sub_1826C(P_Wnd04BM a1, int a2, unsigned __int16 a3, unsigned __int16 a4);
void __fastcall sub_182B8(P_Wnd04BM a1, int a2);
unsigned int __fastcall sub_18370(P_Wnd04BM a1);
void __fastcall sub_185CC(P_Wnd04BM pWnd4BM);
void __fastcall sub_186B8(P_Wnd04BM pWnd4BM, int a2, int a3);
int __fastcall sub_187EC(P_Wnd04BM a1);
void __fastcall sub_18C2C(P_Wnd04BM pWnd04BM, int a2);
void __fastcall Q_Wnd4BM_Proc4_sub_18CA8(P_Wnd04BM pWnd4BM, int a2);
void __fastcall sub_1936C(P_Wnd04BM pWnd4BM);
void __fastcall sub_19AE8(P_Wnd04BM a1);
void __fastcall sub_19E2C(P_Wnd04BM a1, P_CFile pfi, int read);
void *__fastcall sub_1A9C0(void *result);
void __fastcall __spoils<edx> Q_DestructVectors_sub_1A9E0(P_Vector3D a1);
void *__fastcall sub_1AA00(void *result);
void *__fastcall Q_NC_sub_1AA20(void *result);
void __fastcall sub_1AA40(P_Type16 a1, P_Type16 a2);
T_Vector3D *__fastcall sub_1AA90(int);
_DWORD *__fastcall sub_1AAC0(_DWORD *result);
void __fastcall __spoils<> sub_1ABE0(P_Type16 a1);
void __fastcall Q_Vector3D_FromInt_sub_1AC70(P_Vector3D a1, int x, int y, int z);
void __fastcall Q_Vector3D_Clear_sub_1ACA0(P_Vector3D a1);
void __fastcall __spoils<> Q_Cache_Init_sub_1ACC0(P_Cache a1);
void __fastcall __spoils<> sub_1ACE8(P_Cache a1);
void __fastcall __spoils<> sub_1ACF4(P_Cache a1);
void __fastcall Q_Cache_RegisterShapeCache_sub_1AD1C(P_Cache a1, int a2);
int __fastcall Q_Cache_AddFile_sub_1ADAC(P_Cache pCache, const char *filename);
unsigned int __fastcall sub_1AEB0(P_Cache pCache, UWORD index, char *filename);
void __fastcall Q_Cache_RemoveItem_sub_1B000(P_Cache pCache, UWORD index);
void *__fastcall Q_Cache_GetShapeTable_sub_1B084(P_Cache pCache, UWORD index);
int __fastcall Q_Cache_GetItemIndex_sub_1B270(P_Cache pCache, const char *filename, int addIfNotFound);
char *__fastcall sub_1B2DC(P_Cache a1, int size);
char *__fastcall Q_Cache_RemoveEntry_sub_1B354(P_Cache pCache, UWORD index);
P_Cache __fastcall sub_1B498(P_Cache pCache);
_DWORD *__fastcall sub_1B4D0(P_Cache pCache);
void __fastcall __spoils<> sub_1B4F0(P_Matrices a1);
void __fastcall __spoils<> Q_Ret_sub_1B66C();
_DWORD *__fastcall Q_NC_sub_1B670(_DWORD *, int, int, int, int, int, int, int);
// void __userpurge sub_1B808(P_Matrices a1@<eax>, float a2, float a3, float a4, int a5);
void __fastcall sub_1B834(P_Matrices a1, int a2);
void __fastcall __spoils<> sub_1B864(P_Matrices a1);
void __fastcall __spoils<> sub_1B958(P_Matrices a1, P_Vector3D v);
void __fastcall Q_NC_sub_1BA90(float *, int, int, int, int);
void __fastcall Q_NC_sub_1BAB0(int, int, int, int, float degrees);
void __fastcall sub_1BAF0(P_Matrices, float);
FILE *__fastcall Q_OpenFile_sub_1BB10(const char *aFName, fpos_t *endOffset);
void __fastcall __spoils<> Q_CFile_Ctor_sub_1BB78(P_CFile pCFile);
void __fastcall __spoils<> Q_CFile_Dtor_sub_1BBC8(P_CFile pCFile);
BOOL __fastcall Q_CFile_OpenFile_sub_1BBFC(P_CFile pCFile, const char *filename, int oflags, int preload);
BOOL __fastcall Q_OpenFile_sub_1BCA8(T_CFile *, const char *);
BOOL __fastcall Q_CFILE_CPP_OpenFile_sub_1BCBC(P_CFile pCFile, int oflags);
int __fastcall Q_CFile_Close_sub_1BE00(P_CFile a1);
int __fastcall Q_GetFileLength_sub_1BE28(P_CFile a1);
int __fastcall Q_GetFilePos_sub_1BEA0(P_CFile a1);
int __fastcall sub_1BECC(int *, int offset, int);
int __fastcall Q_SetFilePos_sub_1BF0C(P_CFile a1, int offset);
void *__fastcall Q_CFile_Load_sub_1BF1C(P_CFile pCFile, void *a2);
int __fastcall Q_ReadFile_sub_1BF94(P_CFile pfi, void *pBuf, ULONG aReadLen);
unsigned int __fastcall sub_1BFD4(int *, void *buf, unsigned int, unsigned int, int);
unsigned int __fastcall Q_CFile_DosWrite_sub_1C098(P_CFile pCFile, void *buf, unsigned int size);
void __fastcall Q_CFILE_CPP_IndexOneCob_sub_1C278(P_CobFiles a1, char *CobFileName);
void __fastcall Q_CobFilesLoad_sub_1C3C4(P_CobFiles a1);
void Q_AtExitFunc_sub_1C410(void); // idb
int __fastcall main(int argc, char *argv[]);
void Q_Proc_sub_1CC94();
int Q_CORN_CPP_StaticTxtLoad_sub_1CD3C();
char *__fastcall Q_CORN_CPP_StaticTxtRead_sub_1CEA8(int aTextIndex);
T_Game *sub_1CEF0();
void __fastcall sub_1CF14(unsigned __int8 a1);
void __fastcall Q_StarCtor_sub_1CF40(P_Star pStar);
T_Lane *__fastcall sub_1CF68(T_Star *, T_Star *);
__int16 __fastcall Q_Star_ChangePlanetOwnership_sub_1D234(P_Star pStar, P_Planet pPlanet, WORD newRaceIndex);
MACRO_VFX_BOOL __fastcall Q_Star_HandleShipArrival_sub_1D3E8(P_Star pStar, P_Ship pShip, int);
MACRO_VFX_BOOL __fastcall Q_HandleShipDeparture_sub_1D538(P_Location pLocation, P_Ship pShip);
void __fastcall sub_1D654(P_Location pLocation, P_Star pStar, P_Lane pLane);
int __fastcall sub_1D734(P_Star pStar, WORD *a2);
int __fastcall Q_FindShipsAtLocation_sub_1D794(P_Location pLocation, P_Ship *outShipsArray);
unsigned int __fastcall sub_1D834(P_Star pStar, __int16 raceIndex);
void __fastcall Q_ReadWriteStar_sub_1D920(P_Star pStar, P_CFile pfi, int read);
int __fastcall sub_1DA04(int, int);
int __fastcall sub_1DA4C(T_Star *, __int16, int, int);
int __fastcall sub_1DB70(T_Star *, __int16, int *, int);
void __fastcall __spoils<> Q_GameCtor_sub_1DE64(P_Game pGame);
void __fastcall Q_GameDtor_sub_1E03C(P_Game a1);
void __fastcall sub_1E094(P_Game pGame);
void __fastcall sub_1E10C(P_Game pGame, WORD starsNum, WORD racesNum, unsigned __int8 a4);
void __fastcall sub_1E150(P_Game pGame, __int16 sectors);
int __fastcall sub_1E2A0(P_Game a1, __int16 stars);
P_Game __fastcall sub_1E70C(P_Game pGame, WORD racesNum, unsigned __int8 a3);
char __fastcall sub_1EE08(int, char);
__int16 __fastcall sub_1EEA4(P_Game pGame);
void __fastcall sub_1EFC0(P_Game a1);
unsigned int __fastcall sub_1F038(P_Game pGame);
int __fastcall sub_1F404(P_Game pGame);
int sub_1F91C();
int __fastcall sub_1FB34(P_Game a1);
void __fastcall sub_1FD18(P_Game a1, int a2);
int __fastcall sub_1FD90(int, int, int);
int __fastcall sub_1FDF0(int, int, int, int);
int __fastcall sub_1FFE0(P_Game a1, int a2);
void __fastcall sub_2016C(P_Game a1, int a2, __int16 a3);
void __fastcall sub_201D8(P_Game a1);
T_Lane *__fastcall sub_205A0(P_Game, T_Star *, T_Star *);
P_Ship __fastcall sub_20684(P_Game pGame, __int16 raceIndex);
void __fastcall Q_Game_RemoveShip_sub_20720(P_Game pGame, P_Ship pShip);
void __fastcall sub_207A0(P_Game);
T_Star *__fastcall sub_20B3C(P_Game pGame);
void __fastcall sub_20C94(P_Game pGame, int, int, int);
P_Game __fastcall sub_2106C(P_Game result);
void __fastcall sub_21170(P_Game a1);
void __fastcall sub_211EC(P_Game pGame, P_Star pStar, int a3);
void __fastcall sub_21314(P_Game a1);
void __fastcall Q_Game_SaveGam_sub_21374(P_Game pGame, P_CFile pfi);
void __fastcall Q_Game_LoadGam_sub_21AA0(P_Game pGame, P_CFile pfi);
WORD __fastcall sub_220CC(P_Game pGame);
void __fastcall __spoils<edx> sub_22260(void *result);
void __fastcall __spoils<edx> sub_22280(void *);
void __fastcall __spoils<edx> sub_222A0(void *result);
void __fastcall __spoils<edx> sub_222C0(void *);
void __fastcall __spoils<edx> sub_222E0(void *);
void __fastcall __spoils<edx> sub_22300(void *result);
void __fastcall __spoils<edx> sub_22320(void *result);
P_Lane __fastcall sub_22360(P_Lane result);
void __fastcall __spoils<> Q_SectorCtor_sub_223B0(P_Sector pSector);
void __fastcall __spoils<> sub_223E0(P_Type09 a1);
void __fastcall __spoils<> Q_PlanetCtor_sub_22400(P_Planet pPlanet);
int __fastcall sub_22430(const void *, const void *); // idb
void __fastcall Q_Proc_sub_22468();
void __fastcall __spoils<> Q_Wnd2COSWCtor_sub_224A4(P_Wnd2COSW result);
char *__fastcall Q_Wnd2COSWDtor_sub_22588(char *, char);
unsigned int __fastcall Q_COSWND_CPP_sub_22644(P_Wnd2COSW a1, const char *starShapes, const char *shipShapes);
LONG *__fastcall sub_2280C(P_Wnd2COSW a1);
void __fastcall sub_23BF0(int, int);
int __fastcall sub_23FD4(int);
void __fastcall sub_24154(float *, int, float);
void __fastcall sub_24198(int, int, int, int);
void __fastcall sub_2422C(int, int, int, int);
int __fastcall sub_24948(int result, int, int);
void __fastcall sub_24BE0(P_Wnd2COSW a1);
int __fastcall sub_24D30(int, int, int, int);
void __fastcall sub_24FCC(P_Wnd2COSW a1, P_CFile pfi, int read);
void __fastcall __spoils<> sub_254A4(int);
void __fastcall __spoils<> sub_254B0(int result);
int __fastcall sub_254BC(int result, int);
void __fastcall sub_254DC(size_t *);
void __fastcall sub_254F8(int *, int);
void __fastcall __spoils<> sub_25BF8(P_WndA2 a1);
T_WndA2 *__fastcall sub_25C08(T_WndA2 *, char);
void __fastcall sub_25C4C(unsigned int, int);
void __fastcall __spoils<> Q_WndRSWCtor_sub_25CB8(P_WndRSW result);
T_WndA2 *__fastcall Q_WndRSWDtor_sub_25CD4(P_WndRSW a1, char a2);
void __fastcall sub_25D18(int result, LONG);
int __fastcall sub_25FB4(int result);
int __fastcall sub_26000(int, __int16, __int16, LONG);
void sub_26140();
char *__fastcall sub_26150(char *result);
int Q_StopSystems_sub_26160();
void Q_debugbreak_sub_26194();
void __fastcall __noreturn Q_AssertLogBreakExit_sub_26198(int ignore, const char *sourcefile, int line);
void __fastcall Q_AssertLogBreakExit_sub_261A8(int ignore, const char *sourcefile, int line);
void __fastcall Q_PrintFailAndExit_sub_261B8(int ignore, const char *sourceFile, int line);
int sub_2620C(char *format, ...);
void __noreturn Q_debugbreak_exit_sub_2624C();
void __fastcall __spoils<edx,ebx> Q_RegisterData_sub_2625C(void *aData, int a2, char *name);
void __fastcall Q_RemoveWinDataFromWinMgr_sub_2627C(void *pdata);
void *__fastcall Q_Allocate_sub_2628C(size_t, int, char *);
void *__fastcall sub_262B0(size_t num, size_t size, int a3, char *name);
void __fastcall sub_262CC(void *ptr);
void sub_262F0();
void sub_26314();
void sub_2631C();
void Q_Null_sub_26328();
void Q_StopMouse_sub_2632C();
int Q_StartMouse_sub_2633C();
void __fastcall Q_ProcessKeyboard_sub_26360();
void __fastcall Q_ProcessMouse_sub_264B4();
int __fastcall Q_ProcessInput_sub_2656C();
void __fastcall sub_265A8(int);
void __fastcall __spoils<> Q_Wnd23EWCtor_sub_267A0(P_Wnd23EW a1);
void __fastcall __spoils<> Q_Wnd23EWDtor_sub_267BC(P_Wnd23EW a1, char a2);
void __fastcall __spoils<> Q_WndEW_sub_26800(P_Wnd23EW result);
void __fastcall sub_26874(P_Wnd23EW a1, P_GameEvent pGameEvent);
unsigned int __fastcall sub_270F4(int, __int16, LONG, LONG);
void __fastcall __spoils<> Q_A2_sub_2712C(T_WndA2 *a1);
T_WndA2 *__fastcall sub_2713C(T_WndA2 *, char);
unsigned int __fastcall sub_27184(T_WndA2 *, __int16, LONG, LONG);
__int64 __fastcall sub_271FC(int);
void __fastcall __spoils<> Q_A2_sub_27BF8(P_WndA2 a1);
T_WndA2 *__fastcall sub_27C08(T_WndA2 *, char);
int __fastcall sub_27C50(T_WndA2 *, __int16, LONG, LONG);
void __fastcall sub_27D18(int, int, int, int);
void __cdecl callback_fn();
int __fastcall sub_28C4C(__int16 *, __int16 *);
int __fastcall Q_NC_sub_28C58(int result, __int16);
void __fastcall __spoils<> sub_28C74(P_Type2 a1);
void __fastcall __spoils<> sub_28DA4(P_Type2 a1);
UBYTE *__fastcall sub_28EB4(int, const char *, int, int, int);
int __fastcall sub_29038(int, size_t, unsigned int, int, int, int);
unsigned int __fastcall Q_NC_sub_291F8(int);
unsigned int __fastcall Q_NC_sub_2936C(int);
unsigned int __fastcall sub_296B4(int, int, int, int);
void __fastcall sub_29B24(_DWORD *);
unsigned __int16 __fastcall sub_29C6C(int, _WORD *);
int __fastcall sub_29D54(int, unsigned __int8 *);
void __fastcall sub_29F58(int, const void *);
void __fastcall Q_NC_sub_29FF8(int, _WORD *);
FILE *__fastcall sub_2A1DC(int, const char *);
void __fastcall sub_2AA88(int);
int __fastcall Q_FLIC_CPP_StartTimer_sub_2AC84(int, ULONG hertz);
void __fastcall __spoils<> sub_2AD08(P_Type2 a1);
__int16 __cdecl sub_2AD40(unsigned __int16 *, int, LONG y);
int __cdecl Q_NC_sub_2AE48(unsigned __int16);
__int16 Q_NC_sub_2AE69();
void __fastcall __spoils<> Q_Wnd1FLICCtor_sub_2AE80(P_Wnd1FLIC a1);
P_Wnd1FLIC __fastcall Q_Wnd1FLICDtor_sub_2AEB0(P_Wnd1FLIC, char);
UBYTE *__fastcall sub_2AF04(int, const char *);
int __fastcall sub_2AF3C(int);
int __fastcall sub_2AFF0(int, __int16, LONG, LONG);
void __fastcall __spoils<> Q_Font_Init_sub_2B2C0(P_Font a1);
void __fastcall __spoils<> sub_2B2E0(P_Font a1);
MACRO_VFX_BOOL __fastcall sub_2B2FC(P_Font pFont, const char *aFName);
MACRO_VFX_BOOL __fastcall sub_2B360(void **data, const char *aFName);
void __fastcall sub_2B3E0(P_Font pFont, int x1, int y1, int x2, int y2);
int __fastcall Q_Font_ParseTextColor_sub_2B3F4(P_Font pFont, char *input, char *output, int update);
int __fastcall Q_Font_GetTextWidth_sub_2B4F4(P_Font pFont, char *text);
LONG __fastcall Q_Font_GetHeight_sub_2B594(P_Font pFont);
int __fastcall sub_2B5BC(int *, char *);
void __fastcall Q_Font_RenderText_sub_2B610(P_Font pFont, LONG xOffset, LONG yOffset, char *text, char flags, __int16 a6, __int16 a7);
void __fastcall Q_NC_sub_2B804(LONG *, int);
LONG __fastcall Q_NC_sub_2B838(int, __int16, __int16);
int __fastcall Q_Font_DrawFormattedText_sub_2B8A8(P_Font pFont, int xOffset, int yOffset, const char *text, __int16 flags, WORD bgColor, WORD wipeColor, int maxWidth);
void sub_2BB50();
void __fastcall Q_Pane_CopyOrDrawRectangle_sub_2BB74(PANE *pPane, LONG x0, LONG yTop, LONG x1, LONG yBottom, UBYTE color, int copy);
void __fastcall Q_GSYSTEM_CPP_sub_2BC40(PANE *pane, void *shape_table, LONG shape_number, int *hotX, int *hotY);
void __fastcall sub_2BCF4(int, unsigned __int8);
void __fastcall sub_2BD04(P_Type6, char, char *);
void __fastcall Q_Type6Ctor_sub_2BD4C(P_Type6 a1);
T_Type6 *__fastcall Q_Type6Dtor_sub_2BD7C(T_Type6 *);
unsigned int __fastcall sub_2BD88(P_Type6 a1, const char *a2, const char *a3, int a4);
unsigned int __fastcall Q_GSYSTEM_CPP_sub_2BFDC(P_Type6 a1, int a2, int a3, int a4);
void __fastcall Q_AllocateHazeTables_sub_2C08C(P_Type6 a1, unsigned __int16 numTables);
int __fastcall Q_LoadHazeTables_sub_2C0C0(P_Type6 a1, const char *a2, unsigned __int16 num);
unsigned int __fastcall Q_LoadPal_sub_2C158(P_Type6 a1, const char *aFName, int a3, unsigned __int16 a4);
unsigned int __fastcall sub_2C1E0(int, unsigned __int16, unsigned __int16, unsigned int);
void __fastcall Q_PaletteSet_sub_2C224(P_Type6 a1, unsigned __int16 from, __int16 count, RGB *palette);
void __fastcall Q_NC_sub_2C264(T_Type6 *);
void __fastcall Q_NC_sub_2C280(P_Type6, signed __int16, __int16);
void __fastcall Q_PaletteGet_sub_2C2B0(P_Type6 a1, unsigned __int16 from, __int16 count, RGB *palette);
void __fastcall sub_2C2F8(T_Type6 *, char *);
void __fastcall sub_2C418(P_Type6 a1, int a2, __int16 a3);
void __fastcall sub_2C4C0(P_Type6 a1, int a2, int a3);
void __fastcall Q_NC_sub_2C5C0(T_Type6 *);
void __fastcall Q_FadePalette_sub_2C5E4(P_Type6, char);
void __fastcall sub_2C670(int, int, int, char *);
void __fastcall Q_StopVideoSystem_sub_2C6CC(P_Type6 a1);
void __fastcall Q_GSYSTEM_CPP_PreloadMouseShp_sub_2C744(P_Type6 a1);
void __fastcall Q_GSYSTEM_CPP_sub_2C7D0(T_Type6 *a1, int a2, int a3);
void __fastcall __spoils<> Q_A2Ctor_sub_2C830(P_WndA2 a1);
void __fastcall __spoils<edx> Q_A2Dtor_sub_2C848(P_WndA2 a1, char a2);
void __fastcall __spoils<> Q_A1_sub_2C8E4(P_Wnd a1);
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_2C978(P_Wnd a1);
unsigned int __fastcall Q_GWINDOW_CPP_LinkChild_sub_2C990(P_Wnd a1, P_Wnd a2);
unsigned int __fastcall sub_2CA0C(P_Wnd a1, P_Wnd a2, int a3);
int __fastcall Q_NC_sub_2CA58(int);
P_Wnd __fastcall Q_Wnd_Proc2TranslatePane_sub_2CA78(P_Wnd result, WORD xOffset, WORD yOffset);
void __fastcall sub_2CD24(unsigned int, int);
void __fastcall Q_Wnd_Proc5_sub_2CF28(P_Wnd pWnd, int a2);
P_Wnd __fastcall sub_2D0F4(P_Wnd pWnd, int a2);
void __fastcall sub_2D218(_DWORD *);
void __fastcall sub_2D258(P_WndA2 a1, __int16 a2);
int Q_GWINDOW_CPP_LoadGwshareTxt_sub_2D2CC();
int __fastcall sub_2D334(const char *);
char *__fastcall sub_2D3D0(char *result);
unsigned int __fastcall sub_2D400(int, int);
void __fastcall __spoils<> Q_Wnd25TW_Ctor_sub_2D464(P_Wnd25TW a1);
void __fastcall __spoils<edx> Q_Wnd25TW_Dtor_sub_2D480(P_Wnd25TW a1, char a2);
void __fastcall __spoils<> Q_Wnd25TW_Init_sub_2D4C4(P_Wnd25TW result);
int __fastcall Q_Wnd25TW_Proc3_sub_2D4D0(P_Wnd25TW pWnd25TW, UWORD message, int param1, int param2);
void __fastcall Q_Wnd25TW_Proc4_sub_2D528(P_Wnd25TW pWnd, int a2);
void __fastcall Q_Wnd25TW_Proc5_sub_2D79C(P_Wnd25TW pWnd, int a2);
void __fastcall Q_Wnd25TW_Proc6_sub_2D99C(P_Wnd25TW pWnd, P_CFile pfi, BOOL read);
void __fastcall __spoils<> Q_A3_sub_2D9C4(P_TypeA3 a1);
T_WndA2 *__fastcall sub_2D9FC(T_WndA2 *, char);
void __fastcall __spoils<> Q_A1_sub_2DA60(P_Wnd result);
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_2DA68(P_Wnd a1);
MACRO_VFX_BOOL __fastcall sub_2DA80(P_TypeA3, __int16 numControls);
unsigned int __fastcall sub_2DAC8(P_TypeA3 a1, __int16 a2, __int16 a3, WORD *a4);
int __fastcall sub_2DB54(int result, __int16, __int16);
int __fastcall sub_2DBE4(int, int, int);
int __fastcall sub_2DCA0(int result, __int16);
int __fastcall Q_NC_sub_2DD2C(int, __int16, __int16);
int __fastcall sub_2DD70(int);
unsigned int __fastcall sub_2DDB8(int, __int16);
int __fastcall sub_2DE68(T_TypeA3 *, __int16, LONG, LONG);
// void __usercall sub_2E084(int@<eax>, __int16@<si>);
int __fastcall sub_2E1B4(int, unsigned int count, int);
int __fastcall sub_2E208(_DWORD *, const char *, int, int);
void __fastcall __spoils<> Q_Wnd10LBCtor_sub_2E248(T_Wnd10LB *);
T_WndA2 *__fastcall sub_2E264(T_WndA2 *, char);
void __fastcall Q_A10_sub_2E2B8(P_Wnd10LB);
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_2E3BC(P_Wnd a1);
int __fastcall sub_2E3D4(T_Wnd10LB *, __int16, signed int, signed int);
void __fastcall sub_2E6C0(int);
void __fastcall sub_2E868(int, int);
void __fastcall sub_2E9CC(P_Wnd10LB a1, char a2);
int __fastcall Q_Wnd10LB_AddItem_sub_2EA8C(P_Wnd10LB pListBox, BYTE *pData, __int16 a3, BOOL bRedraw);
MACRO_VFX_BOOL __fastcall Q_Wnd10LB_SetItemValue_sub_2EC50(P_Wnd10LB, unsigned __int16 itemIndex, int value);
int __fastcall sub_2ECA4(int, unsigned __int16);
void __fastcall __spoils<> sub_2ECDC(P_Wnd10LB pListBox, unsigned __int16 a2);
void *__fastcall Q_Wnd10LB_GetItemData_sub_2ED14(P_Wnd10LB pListBox, unsigned __int16 itemIndex);
void __fastcall sub_2ED4C(P_Wnd10LB);
void __fastcall sub_2EDC8(int, unsigned int, unsigned int);
void __fastcall sub_2F090(int, unsigned int, unsigned int, __int16);
void __fastcall __spoils<> Q_Wnd10LB_SetProc1_sub_2F1C8(P_Wnd10LB result, void *a2);
void __fastcall __spoils<> Q_Wnd10LB_SetCompareProc_sub_2F1D8(P_Wnd10LB result, void *proc);
void __fastcall Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(P_Wnd10LB pListBox);
int __fastcall sub_2F228(int, size_t, int);
void __fastcall sub_2F2B4(int);
void __fastcall __spoils<> Q_WndNT_sub_2F2F4(P_WndNT result);
T_WndA2 *__fastcall sub_2F30C(T_WndA2 *, char);
void __fastcall sub_2F354(int);
int __fastcall sub_2F414(int);
int __fastcall sub_2F420(T_WndA2 *pWndA2, __int16 message, LONG param1, LONG param2);
int __fastcall Q_WndA2_Proc3_sub_2F424(P_WndA2 pWndA2, UWORD message, int param1, int param2);
int __fastcall sub_2F478(T_WndA2 *, __int16, LONG, LONG);
T_WndA2 *__fastcall sub_2F48C(T_WndA2 *);
T_WndA2 *__fastcall sub_2F4A8(T_WndA2 *, char);
int __fastcall sub_2F4EC(int result);
void __fastcall sub_2F540(int);
int __fastcall sub_2F6B0(int, __int16, char, unsigned int);
int __fastcall sub_2F8A4(int, int);
// char __usercall sub_2F8F8@<al>(int@<eax>, __int16@<dx>, char@<bl>, int@<edi>);
int __fastcall sub_2F9A4(int, const char *, __int16);
void __fastcall __spoils<> Q_A3_sub_2FA18(P_TypeA3 a1);
T_WndA2 *__fastcall sub_2FA34(T_WndA2 *, char);
void __fastcall __spoils<> Q_A3_sub_2FA78(P_TypeA3 result);
void __fastcall sub_2FA98(int);
void __fastcall sub_2FBA4(int, int);
int __fastcall sub_2FC3C(int);
void __fastcall __spoils<> Q_A2_sub_2FC50(P_WndA2 a1);
T_WndA2 *__fastcall sub_2FC68(T_WndA2 *, char);
void __fastcall Q_ShowHelpTopic_sub_2FCB0(P_Wnd20HW a1, char *helpfile, char *helptopic);
unsigned int __fastcall sub_2FD68(int, __int16, LONG, LONG);
void __fastcall Q_HELPWIN_CPP_FgetsLine_sub_2FE58(FILE *fp, char *line);
int __fastcall sub_2FEB8(P_Wnd20HW a1);
void __fastcall sub_30774(int);
int __fastcall sub_30A90(T_Type5 *, int edx0, int, int);
int __fastcall sub_31158(_DWORD *, int, int, int);
void __fastcall __spoils<> Q_WndLW_sub_31200(P_WndLW result);
T_WndA2 *__fastcall sub_3121C(T_WndA2 *, char);
int __fastcall sub_31268(int, unsigned __int16, LONG, LONG);
void __fastcall sub_3160C(int);
void __fastcall sub_316A8(int, int);
int __fastcall sub_317D0(int);
int __fastcall sub_318A0(unsigned __int16, unsigned __int8);
unsigned __int8 __fastcall sub_31934(int a1);
int __fastcall sub_31A34(unsigned __int16, char);
int sub_31B08();
int __fastcall sub_31C18(int result, int);
void __fastcall Q_AppendRomanNum_sub_31E60(char *a1, int number);
int __fastcall sub_31FB0(_DWORD *, const char *, int, int);
void __fastcall __spoils<> Q_WndNW_sub_3201C(P_WndNW a1);
T_WndA2 *__fastcall sub_32038(T_WndA2 *, char);
void __fastcall __spoils<> Q_WndNW_sub_3207C(P_WndNW result);
unsigned int __fastcall sub_320B8(int, __int16, LONG, LONG);
void __fastcall sub_32414(int);
void *__fastcall sub_32658(int);
int __fastcall sub_32714(int, int, __int16);
void __fastcall sub_32800(int, int);
__int64 __fastcall sub_32A1C(int);
__int64 __fastcall sub_32A48(int, int, __int16, int, int);
__int64 __fastcall sub_32B44(int, int, __int16);
__int64 __fastcall sub_32BDC(int, char);
__int64 __fastcall sub_32C14(int, char);
char *__fastcall sub_32C48(int, char, int, int);
int __fastcall sub_32E84(int, int, int, int);
int __fastcall sub_32FD8(int, FILE *, int);
void __fastcall sub_330DC(T_Type5 *, unsigned __int8 *);
void __fastcall __spoils<> Q_WndIW_sub_33598(P_WndIW a1);
T_WndA2 *__fastcall sub_335B4(T_WndA2 *, char);
void __fastcall __spoils<> Q_WndIW_sub_335F8(P_WndIW result);
int __fastcall sub_33604(int, __int16, LONG, LONG);
void __fastcall sub_33674(int);
void __fastcall __spoils<> Q_WndAW_sub_33830(P_WndAW a1);
T_WndA2 *__fastcall sub_33840(T_WndA2 *, char);
void __fastcall Q_ShowHelpTopicAbil_sub_33884(P_Wnd20HW a1, char *a2, int a3, int a4);
unsigned int __fastcall sub_338DC(int, __int16, LONG, LONG);
void __fastcall sub_33A68(int);
UWORD __fastcall Q_Planet_Initialize_sub_33AF0(P_Planet pPlanet, UWORD planetSize, UWORD planetType, P_Square pSquaresArray);
void __fastcall Q_PLANET_CPP_LoadPlanItemTxt_sub_33D30();
int __fastcall Q_Planet_CountAvailableBuildSquares_sub_3407C(P_Planet pPlanet);
int __fastcall Q_Planet_CountTerraformableSquares_sub_3420C(P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall Q_Planet_CanPlaceItem_sub_34368(P_Planet pPlanet, UBYTE planetItemIndex, unsigned __int16 squareIndex);
void __fastcall Q_Planet_StartConstruction_sub_34774(P_Planet pPlanet, UBYTE planetItemIndex, int squareIndex, BOOL _immediate);
int __fastcall Q_Planet_FindOptimalBuildLocation_sub_347CC(P_Planet pPlanet, UBYTE planetItemIndex);
void __fastcall Q_Planet_CountBuildableSquaresByColor_sub_34A44(P_Planet pPlanet, LONG *outBlue, LONG *outRed, LONG *outGreen);
int __fastcall Q_Planet_BuildAtOptimalLocation_sub_34AE4(P_Planet pPlanet, UBYTE planetItemIndex, BOOL _immediate);
MACRO_VFX_BOOL __fastcall Q_Planet_HandleItemConstruction_sub_34B0C(P_Planet pPlanet, UWORD squareIndex, unsigned __int8 planetItemIndex, unsigned __int8 actionType);
void __fastcall Q_Planet_CalcPoints_sub_34E70(P_Planet pPlanet);
void __fastcall sub_352E0(P_Planet pPlanet);
UWORD __fastcall Q_Planet_GetItemCost_sub_3583C(P_Planet pPlanet, unsigned __int16 a2, unsigned __int8 planetItemIndex);
int __fastcall Q_Planet_GetDaysToCompleteItem_sub_358BC(P_Planet pPlanet);
int __fastcall Q_Planet_CountSurfaceBuildings_sub_358F0(P_Planet pPlanet);
UWORD __fastcall Q_Planet_GetSquareWithItem_sub_35930(P_Planet pPlanet, UBYTE planetItemIndex);
int __fastcall Q_Planet_GetSquareIndex_sub_35968(P_Planet pPlanet, int column, int row);
T_SquareGridCoord __fastcall Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(P_Planet pPlanet, unsigned __int16 squareIndex);
P_Ship __fastcall Q_Planet_GetShipAtSquare_sub_35A70(P_Planet pPlanet, UWORD squareIndex);
void __fastcall Q_Planet_AssignShipToOrbitalSquare_sub_35B04(P_Planet pPlanet, unsigned __int16 squareIndex, P_Ship pShip);
MACRO_VFX_BOOL __fastcall Q_Planet_TryPlaceShipInOrbit_sub_35BB4(P_Planet pPlanet, P_Ship pShip);
MACRO_VFX_BOOL __fastcall Q_Planet_LaunchShip_sub_35C38(P_Planet pPlanet, P_Ship pShip);
char __fastcall Q_Planet_GetBestAvailableOrbitalShield_sub_35DA4(P_Planet pPlanet);
char __fastcall Q_Planet_GetBestAvailableOrbitalWeapon_sub_35E24(P_Planet pPlanet);
int __fastcall Q_Planet_GetMaxOrbitalDefenseRange_sub_35ED8(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateOrbitalDefenseStrength_sub_360D8(P_Planet pPlanet);
int __fastcall Q_Planet_CalculateSurfaceShieldStrength_sub_36158(P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall Q_Planet_HasOrbitalDefense_sub_361B8(P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall sub_3623C(P_Planet pPlanet);
void __fastcall Q_Planet_SetPosition_sub_362C8(P_Planet pPlanet, P_Vector3D newPosition);
MACRO_VFX_BOOL __fastcall Q_Planet_CanBuildShip_sub_362E0(P_Planet pPlanet);
int __fastcall Q_Planet_GetSquaresValue_sub_3636C(P_Planet pPlanet, BOOL withBlack);
int __fastcall Q_Planet_GetTotalValue_sub_363B0(P_Planet pPlanet);
int __fastcall sub_364B4(P_Planet pPlanet, __int16 a2);
void __fastcall Q_Planet_GetOrbitalWeaponStats_sub_366C8(P_Planet pPlanet, UBYTE planetItemIndex, LONG *outRange, LONG *outDamage, LONG *outNumUses);
int __fastcall sub_3676C(P_Planet pPlanet, int);
void __fastcall sub_36A5C(P_Planet pPlanet, int a2, WORD raceIndex);
MACRO_VFX_BOOL __fastcall Q_Planet_TryInvade_sub_36CD4(P_Planet pPlanet, unsigned __int16 squareIndex_1, int *outModulesUse);
void __fastcall Q_Planet_Abandon_sub_37040(P_Planet pPlanet);
void __fastcall Q_Planet_ReadWrite_sub_370B8(P_Planet pPlanet, P_CFile pfi, int read);
void __fastcall __spoils<> Q_Wnd7PW_Ctor_sub_372B0(P_Wnd07PW pWnd7PW);
void __fastcall __spoils<edx> Q_Wnd7PW_Dtor_sub_372CC(P_Wnd07PW a1, char a2);
void __fastcall Q_Wnd7PW_Init_sub_37310(P_Wnd07PW pWnd7PW);
int __fastcall sub_37380(int, int);
int __fastcall sub_373E0(int, int);
int __fastcall sub_3745C(T_Type5 *, unsigned __int8 *, int, int);
int __fastcall Q_Wnd7PW_Proc3_sub_37568(P_Wnd07PW pWnd7PW, UWORD message, int param1, int param2);
void __fastcall Q_Wnd7PW_Proc4_sub_384B0(P_Wnd07PW pWnd7PW);
void __fastcall sub_39390(P_Wnd07PW pWnd7PW, UBYTE a2, UWORD *pCacheIndex, UWORD *a4);
__int16 __fastcall sub_393F4(int, unsigned __int16, _WORD *, _WORD *);
void __fastcall sub_394BC(P_Wnd07PW pWnd07PW);
void __fastcall Q_Wnd7PW_Proc6_sub_395C4(P_Wnd07PW pWnd7PW, P_CFile pfi, BOOL read);
void __fastcall __spoils<> Q_A2_sub_395EC(P_WndA2 result);
T_WndA2 *__fastcall sub_395FC(T_WndA2 *, char);
int __fastcall sub_39644(T_WndA2 *, __int16, LONG, LONG);
void __fastcall sub_396F0(int, int);
void __fastcall __spoils<> Q_Wnd14PSW_Ctor_sub_39D80(P_Wnd14PSW pWnd14PSW);
void __fastcall __spoils<edx> Q_Wnd14PSW_Dtor_sub_39D9C(P_Wnd14PSW pWnd14PSW, char a2);
void __fastcall Q_ReadPlanetTexts_sub_39DE0();
int __fastcall Q_Wnd14PSW_Proc3_sub_39E3C(P_Wnd14PSW pWnd14PSW, UWORD message, int param1, int param2);
void __fastcall Q_Wnd14PSW_Proc4_sub_3A6BC(P_Wnd14PSW pWnd14PSW);
void __fastcall Q_RaceCtor_sub_3B120(P_Race pRace);
void __fastcall sub_3B188(P_Race pRace);
int __fastcall sub_3B1FC(P_Race a1, UBYTE a2, __int16 a3);
char __fastcall sub_3B220(P_Race);
char __fastcall Q_NC_sub_3B38C(unsigned __int8 *);
int __fastcall sub_3B56C(P_Race pRace, P_Location pLocation);
void __fastcall sub_3B5B8(T_Race *);
MACRO_VFX_BOOL __fastcall Q_Race_ShouldUpgradeShip_sub_3C12C(P_Race pRace, P_Ship pShip);
char __fastcall sub_3C1C0(P_Race pRace, P_Ship *shipsArray, int a3);
int __fastcall sub_3C2E8(T_Race *a1, P_ShipsList a2, int a3);
void __fastcall Q_NC_sub_3C4EC(P_Star pStar, int a2);
char __fastcall sub_3C670(P_Race a1);
void __fastcall sub_3C968(P_Race pRace);
int __fastcall sub_3CB60(P_Race pRace, P_Planet pPlanet, unsigned __int8 a3);
unsigned int __fastcall Q_NC_sub_3CC90(_BYTE *, unsigned __int8);
unsigned int __fastcall sub_3CCE4(P_Race pRace, P_Planet pPlanet);
void __fastcall sub_3D8F0(int a1, P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall sub_3E020(int eax0, P_Planet edx0, unsigned __int8 bl0);
int __fastcall sub_3E1CC(int eax0, P_Planet);
unsigned int __fastcall sub_3E520(int a1, P_Planet a2);
int __fastcall sub_3E800(_BYTE *, unsigned __int16 *);
__int16 __fastcall sub_3EA7C(_BYTE *);
void __fastcall sub_3EBDC(P_Race pRace, P_Ship pShip);
int __fastcall Q_Race_GetMoreAllowedShips_sub_3EFE0(P_Race pRace);
void __fastcall sub_3F060(P_Race pRace, P_Ship pShip, P_Planet pPlanet, unsigned __int8 a4);
void __fastcall Q_Race_BuildSmallShip_sub_3F324(P_Race pRace, char a2, char a3, char a4, int a5, char a6, P_Ship pShip, unsigned __int8 a8);
MACRO_VFX_BOOL __fastcall Q_Race_BuildMediumShip_sub_3F3F8(P_Race pRace, BYTE a2, BYTE a3, BYTE a4, BYTE a5, BYTE a6, P_Ship pShip, unsigned __int8 a8);
void __fastcall Q_Race_BuildLargeShip_sub_3F784(P_Race pRace, BYTE a2, BYTE a3, BYTE a4, BYTE a5, BYTE a6, P_Ship pShip, unsigned __int8 a8);
void __fastcall Q_Race_BuildEnormousShip_sub_3FBAC(T_Race *eax0, char, char, char, char, char, _DWORD *pShip, unsigned __int8);
void __fastcall sub_40084(P_Race pRace, P_Ship pShip, int startCell, BYTE restGizmoIndex);
T_Ship *__fastcall sub_40144(P_Race pRace, P_Planet pPlanet);
int __fastcall Q_CompareShipsByDayBuilt_sub_40218(P_Ship *ppShip1, P_Ship *ppShip2); // idb
int __fastcall Q_Race_GetShips_sub_40224(P_Race pRace, P_ShipsList pShipsList, int *totalSize);
int __fastcall Q_Race_GetPlanetsNum_sub_402E0(P_Race pRace);
P_Planet __fastcall Q_Race_GetMostInterestingPlanet_sub_403C0(P_Race pRace, P_Star pStar);
int __fastcall sub_40590(P_Race pRace);
unsigned int __fastcall sub_405F4(P_Race pRace);
int __fastcall Q_Race_GetTechsNum_sub_40664(P_Race ppRace);
int __fastcall sub_406C4(P_Race pRace, P_Star pStar, P_Target pTarget);
// int __userpurge sub_41268@<eax>(unsigned __int8 *eax0@<eax>, __int16@<dx>, int@<ecx>, int@<ebx>, char *@<ebp>, int, __int16, int, int, int, int, int);
unsigned int __fastcall sub_43184(int, int, int);
char __fastcall sub_43374(P_Race pRace, int a2);
MACRO_VFX_BOOL __fastcall Q_Race_DecayRelations_sub_433E0(P_Race pRace, WORD raceIndex, P_Star pStar);
int __fastcall sub_434E4(P_Race pRace, int a2);
int __fastcall sub_43B7C(P_Race pRace, __int16 raceIndex);
void __fastcall Q_ReadWriteRace_sub_43BDC(P_Race pRace, P_CFile fi, int read);
int __fastcall Q_RACENEG_CPP_sub_43C80(P_Race a1);
unsigned int __fastcall sub_44024(_BYTE *, char);
T_Race *__fastcall sub_44080(P_Race a1);
int __fastcall sub_44238(int, __int16, _BYTE *, __int16);
char __fastcall sub_44434(P_Race a1, __int16 a2, _DWORD *a3);
int __fastcall sub_44A2C(_BYTE *, int, char, _BYTE *);
char __fastcall sub_44BCC(T_Race *, __int16 *, char, int, int *);
void __fastcall sub_450B0(P_Race a1, __int16 a2, char a3, char a4, int a5, int a6);
// int __usercall sub_45848@<eax>(unsigned __int8 *@<eax>, int@<edx>, int@<ebx>, __int16 *@<edi>);
int __fastcall Q_Race_CalculateShipsAtLocation_sub_45958(P_Race pRace, BYTE treaty, P_Location targetLocation, LONG *strengthOut);
int __fastcall sub_45A0C(_BYTE *, int, int, __int16);
unsigned int __fastcall sub_45A54(P_Race pRace, P_Star pStar, P_Ship pShip);
unsigned int __fastcall sub_45D50(P_Race pRace, P_Star pStar, P_Ship pShip);
unsigned int __fastcall sub_45E64(_BYTE *, __int16);
void __fastcall sub_45F60(_BYTE *, __int16, int);
unsigned int __fastcall sub_46034(_BYTE *, __int16);
void __fastcall sub_46130(_BYTE *, __int16, int);
unsigned int __fastcall sub_46208(_BYTE *, __int16);
int __fastcall sub_46304(_BYTE *, __int16, int);
void sub_46470();
void __fastcall __spoils<eax,edx> Q_Research_LoadResTreeTxt_sub_46480(P_Research pResearch, const char *fname);
int __fastcall Q_Research_DoProgress_sub_466FC(P_Research pResearch);
void __fastcall Q_Research_CheckAllTechForShip_sub_468BC(P_Research pResearch);
MACRO_VFX_BOOL __fastcall Q_Research_HasAllTechsForShip_sub_46900(P_Research pResearch, char raceIndex);
MACRO_VFX_BOOL __fastcall Q_ResTree_TechIsAvailableToRace_sub_4694C(P_Research pResTree, unsigned __int16 techIndex, __int16 raceIndex);
int __fastcall sub_469F0(P_Research pResTree, unsigned __int16 raceIndex);
__int16 __fastcall sub_46A94(P_Research a1, unsigned __int16 raceIndex, int a3);
void __fastcall Q_ReadWriteResTree_sub_46BB0(P_Research a1, P_CFile a2, int read);
void __fastcall __spoils<> Q_ResTreeCtor_sub_46C10(P_Research a1);
int __fastcall Q_GetTurnsToComplete_sub_46C20(int cost, int done, int production);
void __fastcall __spoils<edx> Q_Wnd9RWDtor_sub_46C48(P_Wnd9RW, char);
void __fastcall sub_46CAC(P_Wnd9RW a1);
int __fastcall sub_47088(P_Wnd9RW a1);
unsigned int __fastcall sub_47224(P_Wnd9RW a1, UWORD message, int param1, ULONG param2);
int __fastcall compar(WORD *a1, WORD *a2); // idb
void __fastcall sub_47ABC(P_Wnd9RW pWnd9RW);
int __fastcall sub_48B14(int, unsigned int count, int);
void __fastcall __spoils<> Q_Wnd9RWCtor_sub_48B40(P_Wnd9RW a1);
void __fastcall __spoils<> Q_ShipCtor_sub_48B90(P_Ship pShip);
int __cdecl Q_ShipDtor_sub_48C58();
void __fastcall sub_48C5C(P_Ship pShip, char hullSize);
void __fastcall Q_Ship_LoadGizmosTxt_sub_48C84(P_Ship pShip);
void __fastcall sub_48EAC(P_Ship pShip);
void __fastcall Q_Ship_SetSize_sub_49148(P_Ship pShip, char hullSize);
MACRO_VFX_BOOL __fastcall Q_Ship_PutNewGizmoIntoCell_sub_492AC(P_Ship pShip, BYTE gizmoIndex, int hullCellIndex);
MACRO_VFX_BOOL __fastcall Q_Ship_RemoveGizmoFromCell_sub_492F8(P_Ship pShip, int hullCellIndex);
unsigned int __fastcall Q_Ship_FindFirstCellWithCat_sub_49328(P_Ship pShip, BYTE category);
int __fastcall Q_Ship_FindGizmoHullCellIndex_sub_4937C(P_Ship pShip, UBYTE gizmoIndex);
MACRO_VFX_BOOL __fastcall Q_Ship_ChangeHullSize_sub_493BC(P_Ship pShip, BYTE newHullSize);
void __fastcall Q_Ship_MoveIntoOrbit_sub_49494(P_Ship pShip, P_Planet pPlanet);
MACRO_VFX_BOOL __fastcall Q_Ship_CanTraverseStarLane_sub_4960C(P_Ship pShip, P_Lane pLane);
void __fastcall Q_Ship_EnterStarLane_sub_49648(P_Ship pShip, P_Lane pLane);
void __fastcall Q_Ship_SetPositionAndSnapToGrid_sub_496BC(P_Ship pShip, P_Vector3D newPosition);
void __fastcall Q_Ship_RecalcStats_sub_496E0(P_Ship pShip);
void __fastcall sub_49828(P_Ship pShip);
void __fastcall Q_Ship_RemoveFromTheGame_sub_49940(P_Ship pShip);
void __fastcall sub_49A40(int a1, int a2);
T_Gizmo *__fastcall sub_49A8C(int, char *);
int __fastcall sub_49B3C(P_Ship pShip, int a2);
int __fastcall sub_49B68(int, int);
int __fastcall sub_49CC4(P_Ship pShip, int a2);
int __fastcall sub_4A0D0(P_Ship pShip, int a2);
int __fastcall Q_Ship_GetGizmosCost_sub_4A144(P_Ship pShip);
int __fastcall Q_Ship_GetCost_sub_4A18C(P_Ship pShip);
int __fastcall Q_Ship_UpgradePotential_sub_4A1CC(P_Ship pShip, WORD raceIndex);
char __fastcall Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(P_Ship pShip, BYTE cat, WORD raceIndex);
int __fastcall Q_Ship_GizmoIsResearchedByRace_sub_4A404(P_Ship pShip, BYTE gizmoIndex);
P_HullCell __fastcall sub_4A480(P_Ship pShip, unsigned __int16 a2, P_TargetObject a3);
MACRO_VFX_BOOL __fastcall Q_ShipHasGizmo_sub_4A534(P_Ship pShip, BYTE);
unsigned int __fastcall sub_4A564(int);
void __fastcall Q_Ship_RecalculateTurnResources_sub_4A5B8(P_Ship pShip);
void __fastcall sub_4A6AC(P_Ship pShip);
int __fastcall Q_GetShipRank_sub_4A8CC(P_Ship pShip);
int __fastcall Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(P_Ship pShip);
int __fastcall sub_4A988(P_Ship pShip);
int __fastcall sub_4AA78(P_Ship pShip, P_Star pStar);
int __fastcall sub_4AAEC(int, int);
void __fastcall Q_ReadWriteShip_sub_4AE8C(P_Ship pShip, P_CFile pfi, int read);
void __fastcall Q_Type17Copy_sub_4B5C0(P_HullCell dst, P_HullCell src);
char *__fastcall Q_ShipCopy_sub_4B5E0(P_Ship, P_Ship);
int __fastcall sub_4B780(int result, int);
int __fastcall Q_Ship_ApplyDamage_sub_4B7A0(P_Ship pShip, int a2, int requestedDamage, WORD attackerRaceIndex);
int __fastcall sub_4B944(P_Ship pShip, int a2);
int __fastcall Q_Ship_ActivatePlanetGizmo_sub_4C7FC(P_Ship pShip, int bShouldConsumePower);
int __fastcall Q_Ship_ActivateLaneGizmo_sub_4CAB8(P_Ship pShip, int a2);
int __fastcall Q_Ship_ActivateNoTargetGizmo_sub_4CDF8(P_Ship pShip, int a2);
void sub_4D700();
int __fastcall sub_4D724(T_Type5 *, int, LONG, int);
unsigned int __fastcall sub_4D7A8(int, int, int);
P_Wnd08SW __fastcall Q_Wnd8SWCtor_sub_4D92C(P_Wnd08SW a1);
T_WndA2 *__fastcall Q_Wnd8SWDtor_sub_4DA08(int a1, char a2, int a3, int a4);
void __fastcall __spoils<> sub_4DA5C(P_Wnd08SW result);
int __fastcall sub_4DA7C(P_Wnd08SW pWnd8SW, P_Ship pShip, int a3, int a4);
void __fastcall sub_4DD14(int);
unsigned int __fastcall sub_4DDB0(P_Wnd08SW a1, __int16 a2, int a3, int a4);
int __fastcall sub_4E644(int result, char, int, int);
unsigned int __fastcall sub_4E69C(int);
void __fastcall sub_4E758(P_Wnd08SW a1);
int __fastcall sub_4EE00(P_Wnd08SW pWnd08SW);
char *sub_4EE50();
P_SoundSystem __fastcall sub_4EE74(P_SoundSystem);
T_SoundSystem *__fastcall sub_4EF94(T_SoundSystem *);
LONG __fastcall Q_StartSoundSystem_sub_4EFB0(T_SoundSystem *, int aDIG, int aMDI);
HMDIDRIVER __fastcall sub_4F088(char *path, char *, char *, char *);
int __fastcall sub_4F184(P_SoundSystem a1, int a2);
void __fastcall Q_SSystem_StartSequence_sub_4F32C(P_SoundSystem a1, __int16 track, int a3);
void __fastcall Q_SSystem_EndSequence_sub_4F45C(P_SoundSystem a1, __int16 index);
void __fastcall sub_4F4D4(int, __int16);
HDIGDRIVER __fastcall sub_4F534(_DWORD *, char *, char *);
int __fastcall Q_AllocateSamples_sub_4F5E8(P_SoundSystem a1, int a2);
unsigned int __fastcall Q_LoadMusic_sub_4F65C(P_SoundSystem a1, const char *aMusicFName);
MACRO_VFX_BOOL __fastcall sub_4F8CC(P_SoundSystem, __int16 track, int setpos);
void __fastcall Q_StopSample_sub_4FA1C(P_SoundSystem a1);
void __fastcall sub_4FAB4(int);
void __fastcall Q_StartSample_sub_4FB90(P_SoundSystem a1, __int16 a2);
void __fastcall Q_StopSoundSystem_sub_4FE8C(P_SoundSystem a1);
void __fastcall Q_SetNoSound_sub_4FF08(P_SoundSystem a1);
void __fastcall sub_4FF1C(P_SoundSystem a1);
void __fastcall sub_4FF28(P_SoundSystem a1);
void __fastcall Q_SetVolume_sub_4FF4C(P_SoundSystem a1, char a2);
int __fastcall sub_4FF94(P_SoundSystem a1);
char *__fastcall sub_50140(P_SoundSystem, __int16);
UWORD __fastcall sub_50530(T_Type5 *a1, P_Planet pPlanet, int a3, int a4);
void __fastcall sub_50D70(PPANE pPANE, P_Ship pShip, int a3, int a4);
void __fastcall sub_51610(T_Type5 *, LONG, int, int);
void __fastcall __spoils<> Q_Wnd16SW_Ctor_sub_51674(P_Wnd16SW a1);
T_WndA2 *__fastcall Q_Wnd16SW_Dtor_sub_51690(T_WndA2 *, char);
void __fastcall __spoils<> Q_A11_sub_516D4(P_TypeA11 result);
void __fastcall Q_Wnd16SW_Proc4_sub_516E0(_DWORD *);
int __fastcall Q_Wnd16SW_Proc3_sub_51894(int, __int16, __int16, LONG);
void __fastcall __spoils<> Q_Wnd17FW_Ctor_sub_51B64(P_Wnd17FW a1);
T_WndA2 *__fastcall Q_Wnd17FW_Dtor_sub_51B80(T_WndA2 *, char);
void __fastcall Q_Wnd17FW_Proc4_sub_51BC4(P_Wnd17FW pWnd, int a2);
int __fastcall Q_Wnd17FW_Proc3_sub_51D24(P_Wnd17FW pWnd, UWORD message, int param1, int param2);
void __fastcall __spoils<> Q_WndNGCtor_sub_520EC(P_WndNG a1);
T_WndA2 *__fastcall Q_WndNGDtor_sub_52108(T_WndA2 *, char);
void __fastcall Q_WndNG_sub_5214C(P_WndNG result);
int __fastcall sub_52174(int);
void __fastcall sub_521C0(int, int edx0);
unsigned int sub_526D8();
int __fastcall sub_52714(int);
int __fastcall sub_5294C(int, __int16 dx0, LONG, LONG);
void __fastcall Q_Vector3D_Normalize_sub_53000(P_Vector3D pVector);
void __fastcall Q_Vector3D_SetLength_sub_53054(P_Vector3D pVector, float length);
MACRO_VFX_BOOL __fastcall Q_IsZeroVector_sub_53078(P_Vector3D v);
double __fastcall sub_5309C(float *, float *);
void __fastcall __spoils<> Q_M33xV_sub_53114(P_Vector3D v, T_Matrix3x3 *m);
P_Vector3D __fastcall sub_5323C(P_Vector3D result, float a2);
void __fastcall Q_RotateVectorY_sub_532AC(T_Vector3D *vector, float degrees);
float *__fastcall sub_53318(float *result, float);
void __fastcall __spoils<> Q_M34xV_sub_53384(P_Vector3D v, T_Matrix3x4 *trs, P_Vector3D result);
void __fastcall Q_Project3DTo2D_sub_533D4(P_Vector3D v, float scaleFactor, int xOffset, int yOffset, WORD *outX, WORD *outY);
void __fastcall Q_Vector3D_SnapToGrid_sub_53440(P_Vector3D pVector);
void __fastcall sub_5353C(float *, int, int, int, int);
void __fastcall sub_53564(float *, int, int, int, int);
// void __userpurge sub_5358C(P_Matrices a1@<eax>, float a2);
void __fastcall sub_535B4(P_Matrices a1, float a2);
// void __userpurge sub_535E4(P_Matrices a1@<eax>, float degrees);
void __fastcall sub_53644(float *, int, int, int);
void __fastcall sub_53754(float *, int, int, int);
void __fastcall sub_53864(P_Matrix a1);
void __fastcall __spoils<> sub_53B08(T_Matrix3x4 *trs, T_Matrix3x3 *a, T_Matrix3x3 *r, P_Vector3D t);
int __cdecl sub_53D22(int);
void sub_53DC0();
void __cdecl Q_Timer_sub_53DE4();
int Q_CheckFreeMemory_sub_53DEC();
void __fastcall Q_WINMGR_CPP_sub_53E38(PANE *pane, LONG hotX, LONG hotY, __int16 a4);
void __fastcall Q_DrawRaceTintedShape_sub_53EB8(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY, WORD raceIndex);
void __fastcall sub_53F40(T_Type5 *, void *, LONG, LONG, int, char);
void __fastcall Q_LoadGam_sub_53FB0(const char *fname);
T_CFile *__fastcall Q_SaveGam_sub_54048(const char *fname);
LONG __fastcall sub_54208(PANE *source);
LONG __fastcall Q_WINMGR_CPP_sub_542B0(PANE *target);
void __fastcall __spoils<> Q_WinMgr_Ctor_sub_54344(P_WinMgr a1);
void __fastcall Q_WinMgrDtor_sub_54374(P_WinMgr pWinMgr);
T_WinData *__fastcall Q_WinMgr_Init_sub_54448(P_WinMgr pWinMgr);
unsigned int __fastcall Q_WINMGR_CPP_StartTimer_sub_545EC(P_WinMgr a1);
void __fastcall sub_54664(P_WinMgr a1);
int __fastcall sub_5469C(P_WinMgr pWinMgr);
unsigned int __fastcall sub_54D64(P_WinMgr a1);
void __fastcall sub_5508C(P_WinMgr);
void __fastcall Q_WinMgr_WipeAndAddDirtyArea_sub_55214(P_WinMgr pWinMgr, LONG x0, LONG y0, LONG x1, int y1);
void __fastcall Q_WinMgr_AddDirtyArea_sub_55274(P_WinMgr pWinMgr, int x0, int y0, int x1, int y1);
void __fastcall Q_WinMgr_AddDirtyArea_sub_552CC(P_WinMgr pWinMgr, PANE *pPane);
int __fastcall sub_552F8(P_WinMgr a1, P_WndA2 a2, int a3);
void __fastcall sub_55554(int, _DWORD *);
void __fastcall sub_55618(P_WinMgr a1);
void __fastcall Q_ShowMsgBox_sub_556CC(P_WinMgr a1, char *a2);
const char *__fastcall sub_557D4(T_WinMgr *eax0, char *s2, const char *, __int16);
MACRO_VFX_BOOL __fastcall Q_AddGameEvent_sub_55AEC(P_WinMgr pWinMgr, int eventId, int p1, int p2);
void __fastcall sub_55B74(P_WinMgr pWinMgr);
void __fastcall sub_55E80(P_WinMgr pWinMgr);
void __fastcall sub_56400(T_WinMgr *, int, __int16, int, int, int);
void __fastcall sub_564C0(T_WinMgr *, int, __int16);
int __fastcall sub_56528(int, int, __int16);
unsigned int __fastcall sub_56564(int, int, __int16, int);
int __fastcall sub_56694(T_WinMgr *);
void __fastcall sub_56728(P_WinMgr a1, int hwnd, int f, WORD msg, int p1, int p2);
void __fastcall sub_567BC(P_WinMgr a1, int a2, __int16 a3);
void __fastcall sub_56824(T_WinMgr *);
void __fastcall sub_5691C(P_WinMgr pWinMgr);
void __fastcall Q_WinMgr_QueueMessage_sub_56B60(P_WinMgr pWinMgr, WORD message, LONG param1, LONG param2);
void __fastcall sub_56BE8(P_WinMgr pWinMgr, __int16 message, int param1, int param2, int a5);
int __fastcall Q_WinMgr_DispatchMessageProc3_sub_56D30(P_WinMgr pWinMgr, int wndIndex, WORD message, LONG param1, LONG param2);
T_WndA2 *__fastcall sub_56D70(T_WinMgr *, char *, __int16, LONG, int param2);
T_WndA2 *__fastcall Q_FindWnd_sub_56DA8(P_WinMgr pWinMgr, char *name, _WORD *pIndex);
T_WndA2 *__fastcall sub_56E18(P_WinMgr, char *s1, __int16, _WORD *);
void __fastcall sub_56E9C(P_WinMgr pWinMgr, WORD, int);
int __fastcall sub_570AC(P_WinMgr a1, int a2);
int __fastcall Q_WinMgr_RegisterWindow_sub_571B8(P_WinMgr pWinMgr, P_Wnd pWnd);
MACRO_VFX_BOOL __fastcall Q_WinMgr_AddWindowToState_sub_57220(P_WinMgr pWinMgr, int windowIndex, WORD state);
unsigned int __fastcall sub_57310(P_WinMgr a1, int a2, __int16 a3, int a4);
unsigned int __fastcall sub_5748C(P_WinMgr a1, __int16 stateNumber, __int16 a3);
void __fastcall Q_SetProc1_sub_574F0(P_WinMgr a1, __int16 index, void *proc);
void __fastcall Q_SetProc2_sub_57510(P_WinMgr a1, __int16 index, void *proc);
void __fastcall sub_57530(P_WinMgr a1, int wndIndex, int a3);
void __fastcall sub_575BC(P_WinMgr);
void __fastcall Q_WINMGR_CPP_LoadWindowsTxt_sub_57670(P_WinMgr pType3, const char *fname);
void __fastcall Q_LoadAscendCfg_sub_59828(P_WinMgr);
T_CFile *__fastcall Q_SaveAscendCfg_sub_5989C(P_WinMgr);
int __fastcall sub_59908(int result);
void __fastcall sub_59934(P_WinMgr a1, int toTxt);
unsigned int __fastcall sub_59988(P_WinMgr, char *, int);
P_WinMgr __fastcall sub_59A54(P_WinMgr a1);
void __fastcall sub_59B80(T_WinMgr *);
void __fastcall sub_59C80(P_WinMgr a1, int hwnd, WORD eventType, WORD msg, int p1, int p2, int f);
unsigned int __fastcall sub_59CFC(P_WinMgr a1, const char *a2);
void __fastcall Q_WINMGR_CPP_WriteWinEventBin_sub_59DE0(P_WinMgr a1);
void __fastcall Q_WINMGR_CPP_WinEventBinToTxt_sub_59E88(P_WinMgr a1, char *binname, char *txtname);
void __fastcall Q_WinMgr_AddWinData_sub_5A094(P_WinMgr pWinMgr, void *pData, int category, char *name);
void __fastcall Q_WinMgr_RemoveWinData_sub_5A144(P_WinMgr pWinMgr, void *pData);
char *__fastcall sub_5A194(int, int, _DWORD *, _DWORD *);
void __fastcall sub_5A270(T_WinMgr *a1, int a2, int a3, int a4);
void __fastcall Q_WinMgr_CallProc6_sub_5A294(P_WinMgr a1, P_CFile pfi, int read);
void __fastcall Q_Proc_sub_5A320(__int16);
int __fastcall sub_5A47C(T_Type5 *, const char *, int, int);
LONG __fastcall sub_5A4E4(_DWORD *, LONG, int, int);
void __fastcall __spoils<> Q_Wnd13DBGWNDCtor_sub_5A594(P_Wnd13DBGWND a1);
T_WndA2 *__fastcall Q_Wnd13DBGWNDDtor_sub_5A5AC(T_WndA2 *, char);
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_5A5F4(P_Wnd a1);
int __fastcall sub_5A60C(int, __int16, __int16, LONG);
void __fastcall sub_5AA08(int);
int __fastcall sub_5AB04(const char **, const char **);
void __fastcall sub_5AB2C(int, T_Wnd10LB *);
int __fastcall sub_5AE68(int, T_Wnd10LB *);
MACRO_VFX_BOOL __fastcall sub_5AF30(int, T_Wnd10LB *);
int __fastcall sub_5B200(int, T_Wnd10LB *);
int __fastcall sub_5B244(int result, T_Wnd10LB *);
T_WndA2 *__fastcall sub_5B2B0(T_WndA2 *, char);
T_WndA2 *__fastcall sub_5B2F0(T_WndA2 *result);
T_WndA2 *__fastcall sub_5B300(T_WndA2 *, char);
T_WndA2 *__fastcall sub_5B340(T_WndA2 *result);
// PANE_LIST *__fastcall VFX_pane_list_construct(LONG n_entries);
// void __fastcall VFX_pane_list_clear(PANE_LIST *list);
// LONG __fastcall VFX_pane_list_add_area(PANE_LIST *list, WINDOW *window, LONG x0, LONG y0, LONG x1, LONG y1);
// void __fastcall VFX_pane_list_refresh(PANE_LIST *list);
// BYTE *__cdecl VFX_driver_name(void *VFXScanDLL);
// LONG __cdecl VFX_register_driver(void *DLLbase);
// LONG __cdecl VFX_pixel_write(PANE *pane, LONG x, LONG y, ULONG color);
// LONG __cdecl VFX_pixel_read(PANE *pane, LONG x, LONG y);
// LONG __cdecl VFX_line_draw(PANE *pane, LONG x0, LONG y0, LONG x1, LONG y1, LONG mode, LONG parm);
// void __cdecl VFX_shape_draw(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY);
// void __cdecl VFX_shape_lookaside(UBYTE *table);
// void __cdecl VFX_shape_translate_draw(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY);
// void __cdecl VFX_shape_transform(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY, void *buffer, LONG rot, LONG x_scale, LONG y_scale, LONG flags);
// void __cdecl VFX_shape_visible_rectangle(void *shape_table, LONG shape_number, LONG hotX, LONG hotY, LONG mirror, RECT *rectangle);
// LONG __cdecl VFX_pane_wipe(PANE *pane, LONG color);
// LONG __cdecl VFX_pane_copy(PANE *source, LONG sx, LONG sy, PANE *target, LONG tx, LONG ty, LONG fill);
// void __cdecl VFX_ellipse_draw(PANE *pane, LONG xc, LONG yc, LONG width, LONG height, LONG color);
// void __cdecl VFX_ellipse_fill(PANE *pane, LONG xc, LONG yc, LONG width, LONG height, LONG color);
// LONG __cdecl VFX_font_height(VFX_FONT *font);
// LONG __cdecl VFX_character_width(void *font, LONG character);
// LONG __cdecl VFX_character_draw(PANE *pane, LONG x, LONG y, void *font, LONG character, UBYTE *color_translate);
// void __cdecl VFX_string_draw(PANE *pane, LONG x, LONG y, void *font, char *string, UBYTE *color_translate);
// LONG __cdecl VFX_GIF_draw(PANE *pane, UBYTE *GIF_buffer, void *GIF_scratch);
// LONG __cdecl VFX_shape_resolution(void *shape_table, LONG shape_num);
// LONG __cdecl VFX_shape_count(void *shape_table);
// void __cdecl VFX_window_fade(WINDOW *buffer, RGB *palette, LONG intervals);
// void __cdecl VFX_flat_polygon(PANE *pane, LONG vcnt, SCRNVERTEX *vlist);
// void __cdecl VFX_translate_polygon(PANE *pane, LONG vcnt, SCRNVERTEX *vlist, void *lookaside);
// void MOUSE_show(void);
// void MOUSE_hide(void);
// void __fastcall MOUSE_set_pointer(void *table, LONG shape);
// void __fastcall MOUSE_status(LONG *mx, LONG *my, LONG *ml, LONG *mr, LONG *mc);
// void __fastcall MOUSE_force_move(LONG new_x, LONG new_y);
// void __fastcall MOUSE_pane_list_refresh(PANE_LIST *list);
// LONG __fastcall MOUSE_init(LONG xsize, LONG ysize);
// void MOUSE_shutdown(void);
// void *__cdecl DLL_load(void *source, ULONG flags, void *dll);
// void __cdecl AIL_startup();
// void __cdecl AIL_shutdown();
// HTIMER __cdecl AIL_register_timer(AILTIMERCB callback_fn);
// void __cdecl AIL_set_timer_frequency(HTIMER timer, ULONG hertz);
// void __cdecl AIL_start_timer(HTIMER timer);
// void __cdecl AIL_stop_timer(HTIMER timer);
// void __cdecl AIL_release_timer_handle(HTIMER timer);
// LONG __cdecl AIL_install_DIG_INI();
// HDIGDRIVER __cdecl AIL_install_DIG_driver_file(BYTE *filename, IO_PARMS *IO);
// HSAMPLE __cdecl AIL_allocate_sample_handle(HDIGDRIVER dig);
// void __cdecl AIL_init_sample(HSAMPLE S);
// void __cdecl AIL_set_sample_address(HSAMPLE S, void *start, ULONG len);
// void __cdecl AIL_set_sample_type(HSAMPLE S, LONG format, ULONG flags);
// void __cdecl AIL_start_sample(HSAMPLE S);
// void __cdecl AIL_stop_sample(HSAMPLE S);
// void __cdecl AIL_set_sample_playback_rate(HSAMPLE S, LONG playback_rate);
// void __cdecl AIL_set_sample_volume(HSAMPLE S, LONG volume);
// void __cdecl AIL_set_sample_loop_count(HSAMPLE S, LONG loop_count);
// ULONG __cdecl AIL_sample_status(HSAMPLE S);
// LONG __cdecl AIL_minimum_sample_buffer_size(HDIGDRIVER dig, LONG playback_rate, LONG format);
// LONG __cdecl AIL_sample_buffer_ready(HSAMPLE S);
// void __cdecl AIL_load_sample_buffer(HSAMPLE S, ULONG buff_num, void *buffer, ULONG len);
// LONG __cdecl AIL_install_MDI_INI();
// HMDIDRIVER __cdecl AIL_install_MDI_driver_file(BYTE *filename, IO_PARMS *IO);
// HSEQUENCE __cdecl AIL_allocate_sequence_handle(HMDIDRIVER mdi);
// void __cdecl AIL_start_sequence(HSEQUENCE S);
// void __cdecl AIL_stop_sequence(HSEQUENCE S);
// void __cdecl AIL_end_sequence(HSEQUENCE S);
// ULONG __cdecl AIL_sequence_status(HSEQUENCE S);
// void __cdecl AIL_set_GTL_filename_prefix(BYTE *prefix);
// __int16 UVB_sub_7501C();
// FILE *__usercall UVB_sub_75098@<eax>(int@<eax>, int@<edx>, int@<ecx>, int@<ebx>, char *, int);
// int sprintf(char *s, const char *format, ...);
// char *__fastcall _wcpp_2_dtor_array_store_(void *a1, rt_type_sig_clss *a2);
// void __fastcall operator delete[](void *); weak
// void __fastcall operator delete(void *); weak
// int __fastcall strcmp(const char *s1, const char *s2);
// double __fastcall sqrt(double x);
// void _CHP();
// void __fastcall __spoils<edx> memset(void *s, int c, size_t n);
// void __fastcall qsort(void *base, size_t nmemb, size_t size, int (__fastcall *compar)(const void *, const void *));
// void __fastcall __spoils<edx,ebx> _wcpp_2_ctor_array_(void *array, unsigned int count, rt_type_sig_clss *sig);
// int sscanf(const char *s, const char *format, ...);
// int __fastcall fclose(FILE *fp);
// double __fastcall cos(double x);
// double __fastcall sin(double x);
// double __fastcall tan(double x);
// void *__fastcall operator new[](size_t size);
// void __fastcall __spoils<edx,ebx> _wcpp_2_dtor_array_(void *array, int count, rt_type_sig_clss *a3);
// int __fastcall stricmp(const char *s1, const char *s2);
// FILE *__fastcall fdopen(int handle, const char *mode);
// int __fastcall fgetpos(FILE *fp, fpos_t *pos);
// char *__fastcall strncpy(char *s1, const char *s2, size_t n);
// int __fastcall filelength(int handle);
// int open(const char *path, int oflag, ...);
// int __fastcall lseek(int handle, int offset, int origin);
// int __fastcall close(int handle);
// int __fastcall tell(int handle);
// volatile int *__fastcall _get_errno_ptr();
// int __fastcall read(int handle, void *buf, unsigned int len);
// unsigned int __usercall dos_write@<eax>(int handle@<eax>, const void *buf@<ebx>, unsigned int count@<edx>, unsigned int *bytes);
// void __fastcall _assert(int, char *, char *, int);
// int __fastcall write(int handle, const void *buf, unsigned int len);
// FILE *__fastcall fopen(const char *filename, const char *mode);
// int fscanf(FILE *fp, const char *format, ...);
// clock_t clock(void);
// int printf(const char *format, ...);
// int __fastcall atexit(void (*func)(void));
// int getch(void);
// void __fastcall exit(int status);
// int heapchk(void);
// time_t __fastcall time(time_t *timer);
// int rand(void);
// void __fastcall srand(unsigned int seed);
// int __fastcall access(const char *path, int mode);
// char *__fastcall fgets(char *s, int n, FILE *fp);
// _DWORD *__fastcall _wcpp_2_mod_register_(_DWORD *result);
// int fprintf(FILE *fp, const char *format, ...);
// int __fastcall vsprintf(char *s, const char *format, __va_list arg);
// void *__fastcall malloc(size_t size);
// void *__fastcall calloc(size_t n, size_t size);
// void __fastcall free(void *ptr);
// int __fastcall strnicmp(const char *s1, const char *s2, size_t n);
// int __fastcall atoi(const char *nptr);
// char *__fastcall strdup(const char *string);
// void __fastcall delay(unsigned int milliseconds);
// unsigned int __fastcall dos_getftime(int handle, unsigned __int16 *date, unsigned __int16 *time);
// int __fastcall strncmp(const char *s1, const char *s2, size_t n);
// double __fastcall pow(double x, double y);
// _DWORD __stdcall _wcpp_2_assign_array_(_DWORD); weak
// void *__fastcall _wcpp_2_copy_array_(void *arrayd, void *arrays, int count, rt_type_sig_clss *sig);
// double __fastcall acos(double x);
// void *__fastcall operator new(size_t size);
// char *__fastcall strupr(char *string);
// int __fastcall heapwalk(struct _heapinfo *entry);
// char *__fastcall strcpy(char *dst, const char *src);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_21D90; // weak
_UNKNOWN loc_21D96; // weak
_UNKNOWN loc_21DB2; // weak
_UNKNOWN loc_24D98; // weak
_UNKNOWN loc_24D9B; // weak
_UNKNOWN loc_24D9E; // weak
_UNKNOWN loc_24DA4; // weak
_UNKNOWN loc_24DAA; // weak
_UNKNOWN loc_27281; // weak
_UNKNOWN loc_32DCD; // weak
_UNKNOWN loc_32DDA; // weak
_UNKNOWN loc_493DC; // weak
__int16 word_53CEA = 0; // weak
__int16 word_53D02 = 0; // weak
__int16 word_53D06 = 0; // weak
__int16 word_53D0A = 0; // weak
__int16 DMPI_real_mode_segment_base_word_53D0C = 0; // weak
__int16 word_53D0E = 0; // weak
int DMPI_selector_dword_53D1C = 0; // weak
double dbl_91DD9 = 4000000.0; // weak
_UNKNOWN unk_920AA; // weak
_UNKNOWN unk_92696; // weak
_UNKNOWN unk_92C97; // weak
rt_type_sig_clss C_Wnd19BC =
{
  0,
  &Q_Wnd19BC_Ctor_sub_10A3C,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd19BC_Dtor_sub_10A80,
  264,
  ""
};
T_Procs Wnd19BC_Procs =
{
  &Q_Wnd19BC_Dtor_sub_10A80,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd19BC_Proc3_sub_10B24,
  &Q_Wnd19BC_Proc4_sub_11870,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Vector3D =
{
  0,
  &Q_Vector3DCtor_sub_13BF0,
  &Q_Vector3DCopy_sub_13BC0,
  &Q_Vector3DDtor_sub_13BE0,
  12,
  ""
}; // idb
rt_type_sig_clss C_Wnd4BM =
{
  0,
  &Q_Wnd4BMCtor_sub_15ED4,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd4BMDtor_sub_1604C,
  20558,
  ""
};
rt_type_sig_clss C_Type16 = { 0, &sub_1ABE0, &sub_1AA40, &sub_1ABD0, 36, "" }; // idb
T_Procs Wnd4BM_Procs =
{
  &Q_Wnd4BMDtor_sub_1604C,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &sub_16348,
  &Q_Wnd4BM_Proc4_sub_18CA8,
  &Q_Wnd_Proc5_sub_2CF28,
  &sub_19E2C
};
rt_type_sig_clss C_Type09 = { 0, &sub_223E0, &_wcpp_2_undefed_cdtor_, &sub_223D0, 414, "" };
rt_type_sig_clss C_Sector =
{
  0,
  &Q_SectorCtor_sub_223B0,
  &_wcpp_2_undefed_cdtor_,
  &Q_SectorDtor_sub_223A0,
  13,
  ""
};
rt_type_sig_clss C_Ship =
{
  0,
  &Q_ShipCtor_sub_48B90,
  &Q_ShipCopy_sub_4B5E0,
  &Q_ShipDtor_sub_48C58,
  354,
  ""
};
rt_type_sig_clss C_Planet =
{
  0,
  &Q_PlanetCtor_sub_22400,
  &_wcpp_2_undefed_cdtor_,
  &Q_PlanetDtor_sub_22340,
  123,
  ""
};
rt_type_sig_clss C_Lane = { 0, &sub_22360, &_wcpp_2_undefed_cdtor_, &sub_22350, 39, "" };
rt_type_sig_clss C_Race =
{
  0,
  &Q_RaceCtor_sub_3B120,
  &_wcpp_2_undefed_cdtor_,
  &Q_RaceDtor_3B184,
  494,
  ""
};
rt_type_sig_clss C_Star = { 0, &Q_StarCtor_sub_1CF40, &_wcpp_2_undefed_cdtor_, &Q_StarDtor_1CF64, 96, "" };
rt_type_sig_clss C_WndRSW =
{
  0,
  &Q_WndRSWCtor_sub_25CB8,
  &_wcpp_2_undefed_cdtor_,
  &Q_WndRSWDtor_sub_25CD4,
  177,
  ""
};
_UNKNOWN unk_95B48; // weak
rt_type_sig_clss C_Wnd2COSW =
{
  0,
  &Q_Wnd2COSWCtor_sub_224A4,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd2COSWDtor_sub_22588,
  1430,
  ""
};
int (__fastcall *off_95B84)(P_WndA2 a1) = &Q_WndRSWDtor_sub_25CD4; // weak
int (__fastcall *off_95B9C)(P_WndA2 a1) = &sub_25C08; // weak
T_Procs Wnd2COSW_Procs =
{
  &Q_Wnd2COSWDtor_sub_22588,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &frame_is_wrong_sub_228A4,
  &sub_23BF0,
  &Q_Wnd_Proc5_sub_2CF28,
  &sub_24FCC
};
_UNKNOWN unk_95C04; // weak
_UNKNOWN unk_95C18; // weak
rt_type_sig_clss C_Wnd23EW =
{
  0,
  &Q_Wnd23EWCtor_sub_267A0,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd23EWDtor_sub_267BC,
  3507,
  ""
};
int (__fastcall *off_95C40)(P_WndA2 a1) = &sub_27C08; // weak
int (__fastcall *off_95C58)(P_WndA2 a1) = &sub_2713C; // weak
T_Procs Wnd23EW_Procs =
{
  &Q_Wnd23EWDtor_sub_267BC,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &sub_270F4,
  &sub_27124,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd1FLIC =
{
  0,
  &Q_Wnd1FLICCtor_sub_2AE80,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd1FLICDtor_sub_2AEB0,
  2569,
  ""
};
int (*off_95CB4[2])() = { &Q_Wnd1FLICDtor_sub_2AEB0, &Q_Wnd_Proc2TranslatePane_sub_2CA78 }; // weak
_UNKNOWN unk_95D04; // weak
_UNKNOWN unk_95D18; // weak
_UNKNOWN unk_95D2C; // weak
rt_type_sig_clss stru_95D40 = { 0, &Q_Wnd10LBCtor_sub_2E248, &_wcpp_2_undefed_cdtor_, &sub_2E264, 2306, "" };
_UNKNOWN unk_95D54; // weak
rt_type_sig_clss C_Wnd25TW =
{
  0,
  &Q_Wnd25TW_Ctor_sub_2D464,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd25TW_Dtor_sub_2D480,
  175,
  ""
};
rt_type_sig_clss C_A2 =
{
  0,
  &Q_A2Ctor_sub_2C830,
  &_wcpp_2_undefed_cdtor_,
  &Q_A2Dtor_sub_2C848,
  171,
  ""
};
int (__fastcall *off_95D90)(P_WndA2 a1) = &sub_2FA34; // weak
int (__fastcall *off_95DA8)(P_WndA2 a1) = &sub_2F4A8; // weak
int (__fastcall *off_95DC0)(P_WndA2 a1) = &sub_2F30C; // weak
int (__fastcall *off_95DD8)(P_Wnd10LB) = &sub_2E264; // weak
int (__fastcall *off_95DF0)(P_WndA2 a1) = &sub_2D9FC; // weak
T_Procs Wnd25TW_Procs =
{
  &Q_Wnd25TW_Dtor_sub_2D480,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd25TW_Proc3_sub_2D4D0,
  &Q_Wnd25TW_Proc4_sub_2D528,
  &Q_Wnd25TW_Proc5_sub_2D79C,
  &Q_Wnd25TW_Proc6_sub_2D99C
};
T_Procs A2_Procs =
{
  &Q_A2Dtor_sub_2C848,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_WndA2_Proc3_sub_2F424,
  &sub_2CD24,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
_UNKNOWN unk_95E40; // weak
int (__fastcall *off_95E54)(P_WndA2 a1) = &sub_2FC68; // weak
_UNKNOWN unk_95E74; // weak
int (__fastcall *off_95E88)(P_WndA2 a1) = &sub_3121C; // weak
_UNKNOWN unk_95EB0; // weak
_UNKNOWN unk_95EC4; // weak
_UNKNOWN unk_95ED8; // weak
int (*off_95EEC[2])() = { &sub_33840, &Q_Wnd_Proc2TranslatePane_sub_2CA78 }; // weak
int (__fastcall *off_95F04)(P_WndA2 a1) = &sub_335B4; // weak
int (__fastcall *off_95F1C)(P_WndA2 a1) = &sub_32038; // weak
_UNKNOWN unk_95F44; // weak
rt_type_sig_clss C_Wnd7PW =
{
  0,
  &Q_Wnd7PW_Ctor_sub_372B0,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd7PW_Dtor_sub_372CC,
  396,
  ""
};
int (__fastcall *off_95F6C)(P_WndA2 a1) = &sub_395FC; // weak
T_Procs Wnd7PW_Procs =
{
  &Q_Wnd7PW_Dtor_sub_372CC,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd7PW_Proc3_sub_37568,
  &Q_Wnd7PW_Proc4_sub_384B0,
  &Q_Wnd_Proc5_sub_2CF28,
  &Q_Wnd7PW_Proc6_sub_395C4
};
rt_type_sig_clss C_Wnd14PSW =
{
  0,
  &Q_Wnd14PSW_Ctor_sub_39D80,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd14PSW_Dtor_sub_39D9C,
  173,
  ""
};
T_Procs Wnd14PSW_Procs =
{
  &Q_Wnd14PSW_Dtor_sub_39D9C,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd14PSW_Proc3_sub_39E3C,
  &Q_Wnd14PSW_Proc4_sub_3A6BC,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_Wnd9RW =
{
  0,
  &Q_Wnd9RWCtor_sub_48B40,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd9RWDtor_sub_46C48,
  2525,
  ""
};
T_Procs Wnd9RW_Procs =
{
  &Q_Wnd9RWDtor_sub_46C48,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &sub_47224,
  &sub_47ABC,
  &Q_Wnd_Proc5_sub_2CF28,
  &sub_48B14
};
rt_type_sig_clss C_HullCell =
{
  0,
  &_wcpp_2_undefed_cdtor_,
  &Q_Type17Copy_sub_4B5C0,
  &_wcpp_2_undefed_cdtor_,
  7,
  ""
};
rt_type_sig_clss C_Wnd8SW =
{
  0,
  &Q_Wnd8SWCtor_sub_4D92C,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd8SWDtor_sub_4DA08,
  567,
  ""
};
T_Procs Wnd8SW_Procs =
{
  &Q_Wnd8SWDtor_sub_4DA08,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &sub_4DDB0,
  &sub_4E758,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
rt_type_sig_clss C_WndNG =
{
  0,
  &Q_WndNGCtor_sub_520EC,
  &_wcpp_2_undefed_cdtor_,
  &Q_WndNGDtor_sub_52108,
  189,
  ""
};
rt_type_sig_clss C_Wnd17FW =
{
  0,
  &Q_Wnd17FW_Ctor_sub_51B64,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd17FW_Dtor_sub_51B80,
  177,
  ""
};
rt_type_sig_clss C_Wnd16SW =
{
  0,
  &Q_Wnd16SW_Ctor_sub_51674,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd16SW_Dtor_sub_51690,
  177,
  ""
};
int (__fastcall *off_960F8)(P_WndA2 a1) = &Q_WndNGDtor_sub_52108; // weak
T_Procs Wnd17FW_Procs =
{
  &Q_Wnd17FW_Dtor_sub_51B80,
  &Q_Wnd_Proc2TranslatePane_sub_2CA78,
  &Q_Wnd17FW_Proc3_sub_51D24,
  &Q_Wnd17FW_Proc4_sub_51BC4,
  &Q_Wnd_Proc5_sub_2CF28,
  &locret_2D460
};
int (__fastcall *Wnd16SW_Procs)(P_WndA2 a1) = &Q_Wnd16SW_Dtor_sub_51690; // weak
rt_type_sig_clss C_Wnd13DBGWND =
{
  0,
  &Q_Wnd13DBGWNDCtor_sub_5A594,
  &_wcpp_2_undefed_cdtor_,
  &Q_Wnd13DBGWNDDtor_sub_5A5AC,
  192,
  ""
};
_UNKNOWN unk_96184; // weak
_UNKNOWN unk_96198; // weak
int (__fastcall *off_961AC)(P_WndA2 a1) = &Q_Wnd13DBGWNDDtor_sub_5A5AC; // weak
int (__fastcall *off_961C4)(P_WndA2 a1) = &sub_5B2B0; // weak
int (__fastcall *off_961DC)(P_WndA2 a1) = &sub_5B300; // weak
char aDataRacea03Haz[17] = "DATA\\RACEA03.HAZ"; // weak
T_Name20 V_OrdersTexts[10] =
{
  {
    'S',
    'O',
    'N',
    'o',
    't',
    'h',
    'i',
    'n',
    'g',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0'
  },
  "SOGoStar",
  "SOColonize",
  "SOOrbitPlanet",
  "SOPatrol",
  "SODefendPlanet",
  "SOAttack",
  "SOGoSpace",
  "BAD",
  "BAD"
};
int off_964E0 = 592479; // idb
_DWORD dword_964E4 = 0; // weak
int dword_964EC = 0; // weak
__int16 word_964F0[5] = { 10, 25, 40, 55, 70 };
__int16 word_964FA[13] = { 30, 30, 30, 30, 20, 20, 20, 20, 20, 20, 15, 15, 15 };
__int16 word_96514[13] = { 16, 4, 6, 4, 8, 13, 11, 8, 5, 6, 2, 9, 8 };
__int16 word_9652E[13] = { 6, 6, 6, 6, 4, 4, 4, 4, 4, 4, 3, 3, 3 };
int dword_96548[21] = { 4, 4, 3, 4, 3, 4, 3, 3, 4, 3, 3, 3, 4, 4, 4, 3, 4, 3, 2, 3, 3 }; // weak
int dword_9659C[21] = { 5, 1, 1, 6, 3, 2, 8, 6, 4, 4, 10, 2, 7, 8, 9, 7, 3, 5, 3, 7, 9 }; // weak
char byte_965F8[5] = { '\x05', '\x05', '\x05', '\x0E', '\x0E' }; // weak
int dword_965FD = -33549042; // weak
T_Name12 V_Atmospheres[3] =
{
  { 'P', 'e', 'a', 'c', 'e', 'f', 'u', 'l', '\0', '\0', '\0', '\0' },
  "Neutral",
  "Hostile"
};
T_Name10 V_Treaties[4] =
{
  { 'U', 'n', 'k', 'n', 'o', 'w', 'n', '\0', '\0', '\0' },
  "Peace",
  "War",
  "Alliance"
};
_DWORD dword_96654[5] = { 0, 0, 0, 0, 0 }; // weak
char aThank[] = "Thank you for playing Ascendancy."; // idb
_DWORD dword_96768 = 0; // weak
int dword_96770 = 0; // weak
int Q_GameLoop_dword_96774 = -1; // weak
char byte_96778 = '\xF3'; // weak
char byte_96779[7] = { '\x13', '\x17', '\x1B', '\x1F', '#', '\'', '+' }; // weak
_DWORD dword_96780 = 0; // weak
int dword_96788 = 0; // weak
char V_Romans100[10][5] =
{
  { '\0', '\0', '\0', '\0', '\0' },
  "C",
  "CC",
  "CCC",
  "CD",
  "D",
  "DC",
  "DCC",
  "DCCC",
  "CM"
};
char V_Romans10[10][5] =
{
  { '\0', '\0', '\0', '\0', '\0' },
  "X",
  "XX",
  "XXX",
  "XL",
  "L",
  "LX",
  "LXX",
  "LXXX",
  "XC"
};
char V_Romans1[10][5] =
{
  { '\0', '\0', '\0', '\0', '\0' },
  "I",
  "II",
  "III",
  "IV",
  "V",
  "VI",
  "VII",
  "VIII",
  "IX"
};
__int16 word_9682E[5] = { 207, 297, 252, 207, 297 }; // weak
__int16 word_96838[4] = { 358, 358, 403, 442 }; // weak
int dword_96840 = -65094; // weak
int V_PopGrowthAmount50 = 100; // weak
char *off_96850[5] = { "PLRES", "PLIND", "PLPRO", "PLPOP", "PLBUILD" }; // weak
_DWORD dword_96864[2] = { 50397184, 33686273 }; // weak
_UNKNOWN unk_9686C; // weak
_UNKNOWN unk_968A8; // weak
char V_RaceIndexMask = '\x01'; // weak
char byte_968DD = '\xFF'; // weak
__int16 word_968E8[21] =
{
  0,
  0,
  0,
  0,
  0,
  60,
  100,
  62,
  77,
  90,
  150,
  140,
  63,
  66,
  72,
  0,
  92,
  100,
  0,
  89,
  68
}; // weak
_UNKNOWN unk_96912; // weak
_UNKNOWN unk_96918; // weak
_UNKNOWN unk_9691E; // weak
_UNKNOWN unk_9696C; // weak
_UNKNOWN unk_96994; // weak
__int16 V_HullCells[5] = { 0, 5, 10, 15, 25 };
char byte_969A8[] = { '\0' }; // weak
char byte_969B8[16] =
{
  '\x02',
  '\x03',
  '\x03',
  '\x03',
  '\x03',
  '\x03',
  '\x03',
  '\x04',
  '\x05',
  '\x05',
  '\x05',
  '\x05',
  '\x03',
  '\x01',
  '\0',
  '\0'
}; // weak
char byte_969C8[16] =
{
  '\x03',
  '\a',
  '\a',
  '\a',
  '\a',
  '\a',
  '\a',
  '\x0F',
  '\x1F',
  '\x1F',
  '\x1F',
  '\x1F',
  '\a',
  '\x01',
  '\0',
  '\0'
}; // weak
_DWORD dword_969D8[4] = { 70, 170, 240, 410 }; // weak
T_Name15 V_Locations[7] =
{
  {
    'I',
    'n',
    'V',
    'o',
    'i',
    'd',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0'
  },
  "InShipyard",
  "InShipdock",
  "InOrbit",
  "InSystem",
  "InStarLane",
  "BOGUS"
};
T_Name15 V_Locations[7] =
{
  {
    'I',
    'n',
    'V',
    'o',
    'i',
    'd',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0'
  },
  "InShipyard",
  "InShipdock",
  "InOrbit",
  "InSystem",
  "InStarLane",
  "BOGUS"
};
_DWORD dword_96AC0 = 0; // weak
int dword_96AC8 = 0; // weak
int dword_96ACC = -1; // weak
int dword_96AD0 = -1; // weak
_UNKNOWN unk_96AD4; // weak
_DWORD dword_96B08 = 0; // weak
int dword_96B10 = 0; // weak
int word_96B2A = -1; // idb
int word_96B2C = 65535; // idb
_UNKNOWN unk_96B30; // weak
__int16 word_96B6C = 6166; // weak
UWORD smshipShpCacheIndex = 65535u; // idb
UWORD sunsShpCacheIndex = 65535u; // idb
UWORD planetsShpCacheIndex = 65535u; // idb
_DWORD dword_96B74[5] = { 15, 25, 50, 75, 100 }; // weak
int V_GridSize = 5; // weak
_DWORD dword_96B8C = 0; // weak
int dword_96B94 = 0; // weak
int dword_96BAC = -1; // weak
__int16 word_96BB0 = -1; // weak
int dword_96BB4 = -1; // weak
int dword_96BB8 = -1; // weak
int dword_96BBC = 1065353216; // weak
int dword_96BC0 = -1; // weak
__int16 word_96BC4[8] = { 243, 19, 27, 31, 23, 39, 35, 15 }; // weak
VFX_DESC *(__cdecl *VFX_describe_driver)() = NULL;
void (__cdecl *VFX_init_driver)() = NULL;
void (__cdecl *VFX_shutdown_driver)() = NULL;
void (__cdecl *VFX_area_wipe)(LONG x0, LONG y0, LONG x1, LONG y1, LONG color) = NULL;
void (__cdecl *VFX_wait_vblank_leading)() = NULL;
void (__cdecl *VFX_window_read)(WINDOW *destination, LONG x0, LONG y0, LONG x1, LONG y1) = NULL;
void (__cdecl *VFX_DAC_read)(LONG color_number, RGB *triplet) = NULL;
void (__cdecl *VFX_DAC_write)(LONG color_number, RGB *triplet) = NULL;
void (__cdecl *VFX_pane_refresh)(PANE *target, LONG x0, LONG y0, LONG x1, LONG y1) = NULL;
void (__cdecl *VFX_line_address)(LONG x, LONG y, UBYTE **addr, ULONG *nbytes) = NULL;
void (__fastcall *MEM_free)(void *ptr) = &free;
int dword_9A234 = 0; // weak
int dword_9A238 = 0; // weak
PANE pPane = { NULL, 0, 0, 0, 0 }; // idb
int V_CobFilesLoaded = 0; // weak
T_CobFiles V_CobFiles =
{
  {
    {
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0',
      '\0'
    },
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    "",
    {  }
  }
};
int dword_A0CF8; // weak
MACRO_VFX_BOOL V_NougatLfExists_dword_A0CFC;
MACRO_VFX_BOOL V_FlashPopExists;
T_StaticStrings V_StaticStrings_dword_A0D04;
T_Game V_Game;
__int16 word_D845C; // weak
char byte_D8460[100]; // weak
T_Name20 V_StarTypeTexts_D84C4[13];
_UNKNOWN unk_D85C8; // weak
__int16 word_D85CA[13]; // weak
PANE stru_D85E4; // idb
T_Keyboard V_Keyboard;
T_Mouse V_Mouse;
int dword_D8650; // weak
T_Type6 V_Type6_stru_D8654;
UBYTE V_BigBuffer[94816]; // weak
UWORD GwshareShpCacheIndexes[45];
char byte_FFF04[251]; // weak
int dword_100302; // weak
int dword_100308; // weak
WINDOW V_Window1; // idb
void *buf; // idb
int dword_100324; // weak
int dword_100328; // weak
void *dword_10032C; // idb
__int16 word_100330; // weak
__int16 word_100332; // weak
char byte_100334; // weak
char byte_100335; // weak
int dword_100338; // weak
int dword_10033C; // weak
char byte_100340[16]; // weak
__int16 word_100350; // weak
_UNKNOWN unk_100744; // weak
_UNKNOWN unk_100EC4; // weak
char byte_101DC4[16]; // weak
_UNKNOWN unk_101DD4; // weak
_UNKNOWN unk_102554; // weak
_UNKNOWN unk_103454; // weak
__int16 word_103F94; // weak
T_PlanetItems V_PlanetItems;
T_PlanetCfg V_PlanetCfg;
char *dword_10467C;
char *dword_104680; // idb
int dword_104684; // weak
char *PlanetSizeTexts[5];
char *PlanetTypeTexts[11];
char *PlanetButtonTexts[8];
int dword_1046E8[100]; // weak
int dword_104878[100]; // weak
int dword_104A08[100]; // weak
int dword_104B98[]; // weak
int dword_104BC0[9]; // weak
__int16 word_104BE8; // weak
UBYTE V_PlayerRaceIndex;
int dword_104BEC[100]; // weak
int dword_104D7C[99]; // weak
int dword_104F09; // weak
int dword_104F6D; // weak
int dword_104FD1; // weak
int dword_105035; // weak
int dword_10509C; // weak
int dword_1050A0; // weak
T_Name20 V_SpecNames[21];
int V_Day1; // weak
int V_Day2; // weak
int V_Day3; // weak
int V_ResTreeTxtLoaded; // weak
T_Research V_Research;
__int16 word_106FB4[7]; // weak
int dword_106FC2; // weak
int dword_106FCC; // weak
int dword_106FD0; // weak
int dword_106FD4; // weak
int dword_106FD8; // weak
WORD *dword_106FDC;
char byte_106FE0[56]; // weak
__int16 word_107018; // weak
int dword_10701C; // weak
T_Gizmos V_Gizmos;
T_Name20 V_HullNames[4];
T_Ship stru_108FE8;
T_SoundSystem V_SoundSystem;
_UNKNOWN unk_109DF8; // weak
int dword_10AE60; // weak
int dword_10AE64; // weak
int dword_10AE68; // weak
int dword_10AE6C; // weak
T_WinMgr WinMgr;
unsigned __int16 dword_132B10; // idb
int dword_132B14; // weak
int dword_132B18; // weak
int dword_132B1C; // weak
char byte_132B20[20]; // weak
int dword_132B34; // weak
char byte_132B38[32]; // weak
int V_Timer_dword_132B58; // weak
int dword_132B5C; // weak
int dword_132B60; // weak
int dword_132B64; // weak


//----- (00010000) --------------------------------------------------------
void __noreturn sub_10000()
{
  while ( 1 )
  {
    __debugbreak();
  }
}
// 10000: using guessed type void __noreturn sub_10000();

//----- (00010010) --------------------------------------------------------
void __fastcall Q_BATCON_CPP_sub_10010(PANE *pane, int a2, int a3, int a4)
{
  void *ShapeTable_sub_1B084; // eax
  void *v6; // ebp
  LONG v7; // edi
  int v8; // ecx
  const char *v9; // ecx
  LONG *p_x0; // esi
  UWORD v11; // dx
  void *v12; // esi
  int raceIndex; // eax
  PANE *v14; // esi
  char *name; // ecx
  void *v16; // ebp
  int v17; // esi
  int v18; // esi
  int v19; // edx
  int v20; // ebx
  int k; // kr1C_4
  __int16 v22; // si
  int i; // esi
  WORD v24; // [esp-Ch] [ebp-98h]
  LONG v25; // [esp-4h] [ebp-90h]
  PANE v26; // [esp+0h] [ebp-8Ch] BYREF
  int v27[5]; // [esp+14h] [ebp-78h]
  int v28[2]; // [esp+28h] [ebp-64h]
  LONG v29[2]; // [esp+30h] [ebp-5Ch]
  int v30[2]; // [esp+38h] [ebp-54h]
  int hotX; // [esp+40h] [ebp-4Ch] BYREF
  int hotY; // [esp+44h] [ebp-48h] BYREF
  int v33; // [esp+48h] [ebp-44h]
  int v34; // [esp+4Ch] [ebp-40h]
  int v35; // [esp+50h] [ebp-3Ch]
  int ShipRank_sub_4A8CC; // [esp+54h] [ebp-38h]
  int v37; // [esp+58h] [ebp-34h]
  P_Ship v38; // [esp+5Ch] [ebp-30h]
  LONG x1; // [esp+60h] [ebp-2Ch]
  int v40; // [esp+64h] [ebp-28h]
  int j; // [esp+68h] [ebp-24h]
  int v42; // [esp+6Ch] [ebp-20h]
  LONG shape_number; // [esp+70h] [ebp-1Ch]
  LONG v44; // [esp+74h] [ebp-18h]
  PANE *panea; // [esp+78h] [ebp-14h]
  unsigned int v46; // [esp+7Ch] [ebp-10h]

  panea = pane;
  v37 = 0;
  if ( a4 )
  {
    VFX_pane_wipe(pane, 0x96);
    v37 = 0x96;
  }
  if ( a3 < 0 )
  {
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1D]);
    v6 = ShapeTable_sub_1B084;
    if ( !ShapeTable_sub_1B084 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x46);
    }
    v7 = 5 * *(unsigned __int16 *)(a2 + 0x16) + *(unsigned __int16 *)(a2 + 0x14);
    Q_GSYSTEM_CPP_sub_2BC40(panea, ShapeTable_sub_1B084, v7, &hotX, &hotY);
    v33 = a2;
    VFX_shape_draw(panea, v6, v7, hotX, hotY);
    v8 = *(unsigned __int8 *)(a2 + 0x57);
    v34 = 0xF3;
    if ( v8 != 0xFF )
    {
      Q_WINMGR_CPP_sub_53E38(panea, 2, 4, v8);
      v34 = 4 * V_Game.races[*(unsigned __int8 *)(a2 + 0x57)].Unknown_02 + 0x13;
    }
    v24 = v34;
    v9 = (const char *)(v33 + 0x24);
    WinMgr.SmallFont.pane.window = panea->window;
    p_x0 = &panea->x0;
    WinMgr.SmallFont.pane.x0 = panea->x0;
    WinMgr.SmallFont.pane.y0 = *++p_x0;
    WinMgr.SmallFont.pane.x1 = *++p_x0;
    WinMgr.SmallFont.pane.y1 = p_x0[1];
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x12, 7, v9, 0, v24, 0xFF, 0);
    return;
  }
  v11 = GwshareShpCacheIndexes[*(__int16 *)(a2 + 0x56) + 0xE];
  v38 = (P_Ship)a2;
  v12 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v11);
  if ( !v12 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x5C);
  }
  raceIndex = v38->raceIndex;
  v35 = 0;
  if ( raceIndex == V_PlayerRaceIndex || sub_4AAEC((int)v38, V_PlayerRaceIndex) > 0 )
  {
    v35 = 0xFFFFFFFF;
  }
  Q_GSYSTEM_CPP_sub_2BC40(panea, v12, v38->hullSize, &hotX, &hotY);
  if ( v35 != 0xFFFFFFFF )
  {
    goto LABEL_25;
  }
  if ( v38->availablePower > 0 )
  {
    if ( 4 * v38->hullIntegrity < v38->Unknown_98 || v38->hullIntegrity < 5 )
    {
      VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[8]);
      VFX_shape_translate_draw(panea, v12, v38->hullSize, hotX, hotY);
      goto LABEL_26;
    }
    if ( !V_Game.races[v38->raceIndex]._nameIndex )
    {
      VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[3]);
      VFX_shape_translate_draw(panea, v12, v38->hullSize, hotX, hotY);
      goto LABEL_26;
    }
    if ( V_Game.races[v38->raceIndex]._nameIndex != 0xD )
    {
      VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[6]);
      VFX_shape_translate_draw(panea, v12, v38->hullSize, hotX, hotY);
      goto LABEL_26;
    }
LABEL_25:
    VFX_shape_draw(panea, v12, v38->hullSize, hotX, hotY);
    goto LABEL_26;
  }
  VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[0x16]);
  VFX_shape_translate_draw(panea, v12, v38->hullSize, hotX, hotY);
LABEL_26:
  v14 = panea;
  Q_WINMGR_CPP_sub_53E38(panea, 2, 4, v38->raceIndex);
  name = v38->name;
  WinMgr.SmallFont.pane.window = v14->window;
  v14 = (PANE *)((char *)v14 + 4);
  WinMgr.SmallFont.pane.x0 = (LONG)v14->window;
  v14 = (PANE *)((char *)v14 + 4);
  WinMgr.SmallFont.pane.y0 = (LONG)v14->window;
  v14 = (PANE *)((char *)v14 + 4);
  WinMgr.SmallFont.pane.x1 = (LONG)v14->window;
  WinMgr.SmallFont.pane.y1 = v14->x0;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x12, 7, name, 0, 0xF, 0xFF, 0);
  v16 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x23]);
  if ( !v16 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0xA4);
  }
  if ( v35 == 0xFFFFFFFF )
  {
    ShipRank_sub_4A8CC = Q_GetShipRank_sub_4A8CC(v38);
    for ( i = 0; i < 0xA; ++i )
    {
      if ( i >= ShipRank_sub_4A8CC )
      {
        break;
      }
      Q_DrawRaceTintedShape_sub_53EB8(panea, v16, 0, 5 * i + 0x12, 0x11, v38->raceIndex);
    }
    v27[0] = v38->totalWeaponDamage;
    v27[1] = v38->totalShieldStrength;
    v27[2] = v38->totalDriveMaxDistance;
    v27[3] = v38->totalScannerRangePerTurn;
    v44 = 0x1F;
    v27[4] = v38->totalGeneratorPower;
    v40 = 0;
    v26 = *panea;
    for ( j = 0; j < 5; ++j )
    {
      v26.x1 = v26.x0 + 1;
      v17 = v27[j];
      if ( v17 > 0 )
      {
        v26.x1 += 8 * v17 / 4;
      }
      v18 = 0;
      shape_number = j + 1;
      do
      {
        VFX_shape_draw(&v26, v16, shape_number, 8 * v18++ + 2, 9 * j + 0x1F);
      }
      while ( v18 < 0xF );
    }
    v28[0] = v38->hullIntegrity;
    v28[1] = v38->availablePower;
    v30[0] = v38->Unknown_98;
    v42 = 0;
    v30[1] = Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(v38);
    v29[0] = 2;
    v29[1] = 5;
    x1 = 0x82;
    for ( k = 0; k != 2; ++k )
    {
      v19 = v30[k];
      if ( v19 > 0 )
      {
        v20 = v28[k];
        if ( v20 >= 0 )
        {
          if ( v20 > v19 )
          {
            v28[k] = v30[k];
          }
          v46 = 4 * k;
          v22 = 0;
        }
        else
        {
          v28[k] = 0;
          v46 = 4 * k;
          v22 = 0;
        }
        while ( v22 < 9 )
        {
          v25 = 8 * v22++ + 9;
          VFX_shape_draw(panea, v16, v29[v46 / 4], 0x7C, v25);
        }
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(
          panea,
          8 * k + 0x7C,
          8,
          8 * k + 0x82,
          0x50 - 0x48 * v28[v46 / 4] / v30[v46 / 4],
          v37,
          0xFFFFFFFF);
      }
    }
  }
}

//----- (00010668) --------------------------------------------------------
void __fastcall Q_BATCON_CPP_sub_10668(PANE *pane, char *a2, int powerState, int a4)
{
  void *shapeTable; // edi
  char *v6; // esi
  UBYTE Unknown_02; // al
  int v8; // eax
  char *text; // eax
  char s[68]; // [esp+0h] [ebp-60h] BYREF
  LONG hotY; // [esp+50h] [ebp-10h] BYREF
  LONG hotX; // [esp+54h] [ebp-Ch] BYREF
  int ps; // [esp+58h] [ebp-8h]
  char *shapeNumber; // [esp+5Ch] [ebp-4h]

  shapeNumber = a2;
  ps = powerState;
  shapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);
  if ( !shapeTable )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0xEA);
  }
  v6 = shapeNumber;
  if ( a4 && !ps && (V_Gizmos[*shapeNumber].flags & 0x80) == 0 )
  {
    VFX_pane_wipe(pane, 0x96);
  }
  if ( *shapeNumber == (char)0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0xFB);
  }
  Q_GSYSTEM_CPP_sub_2BC40(pane, shapeTable, *shapeNumber, &hotX, &hotY);
  if ( ps == 2 || ps == 3 )
  {
    VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[7]);
    VFX_shape_translate_draw(pane, shapeTable, *v6, hotX, hotY);
  }
  else
  {
    VFX_shape_draw(pane, shapeTable, *v6, hotX, hotY);
  }
  if ( *(_DWORD *)(v6 + 3) )
  {
    if ( (V_Gizmos[*v6].flags & 0x20) != 0 )
    {
      Q_Pane_CopyOrDrawRectangle_sub_2BB74(
        pane,
        1,
        1,
        pane->x1 - pane->x0 - 1,
        pane->y1 - pane->y0 - 1,
        4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13,
        0);
    }
  }
  sprintf(s, "%s", V_Gizmos[*v6].name);
  Unknown_02 = V_Game.races[V_PlayerRaceIndex].Unknown_02;
  WinMgr.SmallFont.pane = *pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 2, s, 0, 4 * Unknown_02 + 0x13, 0xFF, 0);
  if ( ps == 2 )
  {
    v8 = 0;                                            // 0: "(depleted)"
  }
  else
  {
    if ( ps != 3 )
    {
      return;
    }
    v8 = 1;                                            // 1: "(insufficient power)"
  }
  text = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v8);
  WinMgr.SmallFont.pane = *pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 0xC, text, 0, 0xF, 0xFF, 0);
}

//----- (00010878) --------------------------------------------------------
int __fastcall sub_10878(_DWORD *a1, int a2, int a3, int a4)
{
  void *ShapeTable_sub_1B084; // edi
  UBYTE Unknown_02; // al
  int result; // eax
  __int16 v8; // dx
  char *sub_1CEA8; // eax
  char s[80]; // [esp+0h] [ebp-68h] BYREF
  LONG hotX; // [esp+50h] [ebp-18h] BYREF
  LONG hotY; // [esp+54h] [ebp-14h] BYREF
  int v13; // [esp+58h] [ebp-10h]

  v13 = a3;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1E]);
  if ( !ShapeTable_sub_1B084 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x122);
  }
  if ( a4 && !v13 )
  {
    VFX_pane_wipe((PANE *)a1, 0x96);
  }
  Q_GSYSTEM_CPP_sub_2BC40((PANE *)a1, ShapeTable_sub_1B084, *(unsigned __int8 *)(a2 + 1), &hotX, &hotY);
  if ( v13 == 1 )
  {
    VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[7]);
    VFX_shape_translate_draw((PANE *)a1, ShapeTable_sub_1B084, *(unsigned __int8 *)(a2 + 1), hotX, hotY);
  }
  else
  {
    VFX_shape_draw((PANE *)a1, ShapeTable_sub_1B084, *(unsigned __int8 *)(a2 + 1), hotX, hotY);
  }
  sprintf(s, "%s", V_PlanetItems.item[*(unsigned __int8 *)(a2 + 1)].name);
  Unknown_02 = V_Game.races[V_PlayerRaceIndex].Unknown_02;
  WinMgr.SmallFont.pane = *(PANE *)a1;
  result = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 2, s, 0, 4 * Unknown_02 + 0x13, 0xFF, 0);
  if ( v13 == 1 )
  {
    v8 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02;
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0); // 0: "(depleted)"
    WinMgr.SmallFont.pane = *(PANE *)a1;
    return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 5, 0xC, sub_1CEA8, 0, v8 + 0x13, 0xFF, 0);
  }
  return result;
}

//----- (00010A14) --------------------------------------------------------
int __fastcall Q_CompareListBoxItems_sub_10A14(P_ListBoxItem item1, P_ListBoxItem item2)
{
  int value; // ecx
  int v3; // esi
  int result; // eax

  value = item1->value;
  v3 = item2->value;
  result = -1u;
  if ( value > v3 )
  {
    return 1;
  }
  if ( value == v3 )
  {
    return 0;
  }
  return result;
}

//----- (00010A3C) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd19BC_Ctor_sub_10A3C(P_Wnd19BC pWnd19BC)
{
  Q_A2Ctor_sub_2C830(&pWnd19BC->a2);
  pWnd19BC->Unknown_C8 = 0;
  pWnd19BC->Unknown_CC = 0;
  pWnd19BC->Unknown_D0 = 0;
  pWnd19BC->a2.pProcs = &Wnd19BC_Procs;
  Q_Wnd19BC_Init_sub_10AC4(pWnd19BC);
}

//----- (00010A80) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd19BC_Dtor_sub_10A80(P_Wnd19BC a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd19BC);
    operator delete[](v3);
  }
  else
  {
    a1->a2.pProcs = &Wnd19BC_Procs;
    Q_A2Dtor_sub_2C848(&a1->a2, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00010AC4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd19BC_Init_sub_10AC4(P_Wnd19BC a1)
{
  a1->target.type = 0;
  a1->target.pObject.pPlanet = 0;
  a1->Unknown_B0 = 0;
  a1->Unknown_B1 = 0;
  a1->pWnd10LB = 0;
  a1->Unknown_B9 = 0;
  a1->Unknown_BF = 0;
}

//----- (00010B24) --------------------------------------------------------
int __fastcall Q_Wnd19BC_Proc3_sub_10B24(P_Wnd19BC pWnd, UWORD message, int param1, int param2)
{
  int result; // eax
  T_Wnd04BM *Wnd_sub_56DA8; // eax
  T_Wnd10LB *v9; // eax
  P_Star pCurStar; // ebx
  int v11; // eax
  __int16 i; // ax
  int v13; // edx
  int Unknown_BF; // edx
  int v15; // eax
  BYTE v16; // al
  BYTE v17; // al
  int v18; // ecx
  BYTE v19; // bh
  P_TargetObject v20; // edx
  T_Type22 *p_t22; // edi
  int v22; // eax
  P_TargetObject v23; // edx
  int v24; // eax
  P_Procs pProcs; // ebx
  char v26; // al
  void *ItemData_sub_2ED14; // eax
  P_Wnd04BM pWnd04BM; // edx
  void *v29; // eax
  P_Type21 v30; // eax
  char *v31; // eax
  char *v32; // esi
  T_Gizmo *v33; // eax
  int v34; // edx
  int *p_Unknown_62; // edx
  void *v36; // eax
  P_Wnd04BM v37; // edx
  LONG v38; // ebx
  LONG v39; // ebx
  BYTE type; // cl
  int *p_Unknown_C8; // ecx
  LONG v42; // [esp-4h] [ebp-9Ch]
  char v43; // [esp+0h] [ebp-98h] BYREF
  int Unknown_B1; // [esp+1h] [ebp-97h]
  char v45; // [esp+5h] [ebp-93h]
  int pPlanet; // [esp+6h] [ebp-92h]
  int v47; // [esp+Ah] [ebp-8Eh]
  int v48; // [esp+Eh] [ebp-8Ah]
  T_Square *v49; // [esp+12h] [ebp-86h]
  int v50; // [esp+16h] [ebp-82h]
  int v51; // [esp+1Ah] [ebp-7Eh]
  int v52; // [esp+1Eh] [ebp-7Ah]
  int v53; // [esp+22h] [ebp-76h]
  char v54; // [esp+28h] [ebp-70h]
  int v55; // [esp+29h] [ebp-6Fh]
  char v56; // [esp+2Dh] [ebp-6Bh]
  int v57; // [esp+2Eh] [ebp-6Ah]
  int v58; // [esp+32h] [ebp-66h]
  int v59; // [esp+36h] [ebp-62h]
  int v60; // [esp+3Ah] [ebp-5Eh]
  int v61; // [esp+3Eh] [ebp-5Ah]
  int v62; // [esp+42h] [ebp-56h]
  int v63; // [esp+46h] [ebp-52h]
  int v64; // [esp+4Ah] [ebp-4Eh]
  char v65; // [esp+50h] [ebp-48h]
  int v66; // [esp+51h] [ebp-47h]
  char v67; // [esp+55h] [ebp-43h]
  int v68; // [esp+56h] [ebp-42h]
  int v69; // [esp+5Ah] [ebp-3Eh]
  int v70; // [esp+5Eh] [ebp-3Ah]
  T_Square *v71; // [esp+62h] [ebp-36h]
  int v72; // [esp+66h] [ebp-32h]
  int v73; // [esp+6Ah] [ebp-2Eh]
  int v74; // [esp+6Eh] [ebp-2Ah]
  int v75; // [esp+72h] [ebp-26h]
  T_Type23 *v76; // [esp+78h] [ebp-20h]
  T_Type23 *v77; // [esp+7Ch] [ebp-1Ch]
  T_Ship *v78; // [esp+80h] [ebp-18h]
  int param1a; // [esp+84h] [ebp-14h]
  char v80; // [esp+88h] [ebp-10h]

  param1a = param1;
  if ( message < 0x327u )
  {
    if ( message >= 0x322u )
    {
      if ( message > 0x322u )
      {
        if ( message < 0x325u )
        {
          if ( message != 0x324 )
          {
            return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
          }
          if ( pWnd->Unknown_B9 != 1 )
          {
            pWnd->Unknown_B9 = 1;
            sub_12140(pWnd);
            pWnd->a2.pProcs->proc4_draw(&pWnd->a2.a1, 0);
          }
          return 0xFFFFFFFF;
        }
        else if ( message <= 0x325u )
        {
          if ( pWnd->Unknown_B9 != 4 )
          {
            pWnd->Unknown_B9 = 4;
            sub_12140(pWnd);
            pWnd->a2.pProcs->proc4_draw(&pWnd->a2.a1, 0);
          }
          return 0xFFFFFFFF;
        }
        else
        {
          pWnd->Unknown_BF = 0;
          if ( !param1 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x2E1);
          }
          if ( !param2 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x2E2);
          }
          if ( pWnd->Unknown_D4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x2E4);
          }
          type = pWnd->target.type;
          if ( type == 3 )
          {
            v47 = 0;
            v48 = 0;
            v49 = 0;
            v51 = 0;
            v52 = 0;
            v50 = 0;
            v43 = 2;
            HIBYTE(pWnd->target.pObject.pPlanet->z7) = 0;
            p_Unknown_C8 = (int *)param2;
            if ( pWnd->Unknown_B0 )
            {
              v43 = 1;
              Unknown_B1 = pWnd->Unknown_B1;
              v45 = 0;
              pPlanet = (int)pWnd->target.pObject.pPlanet;
            }
            else
            {
              v43 = 0;
              v80 = param1a;
              switch ( (_BYTE)param1a )
              {
                case 5:
                  v45 = 3;
                  v47 = *(_DWORD *)param2;
                  v48 = *(_DWORD *)(param2 + 4);
                  v49 = *(T_Square **)(param2 + 8);
                  pWnd->Unknown_C8 = *(_DWORD *)param2;
                  p_Unknown_C8 = &pWnd->Unknown_C8;
                  pWnd->Unknown_CC = *(_DWORD *)(param2 + 4);
                  pWnd->Unknown_D0 = *(_DWORD *)(param2 + 8);
                  HIBYTE(pWnd->target.pObject.pPlanet->z7) = 7;
                  pWnd->target.pObject.pPlanet->Unknown_5E = 0;
                  break;
                case 2:
                  pPlanet = param2;
                  v45 = 1;
                  HIBYTE(pWnd->target.pObject.pPlanet->z7) = 3;
                  pWnd->target.pObject.pPlanet->Unknown_5E = param2;
                  break;
                case 4:
                  v45 = 2;
                  pPlanet = param2;
                  HIBYTE(pWnd->target.pObject.pPlanet->z7) = 1;
                  v22 = *(_DWORD *)param2;
                  if ( *(P_Star *)param2 == V_Game.pCurStar )
                  {
                    v22 = *(_DWORD *)(param2 + 4);
                  }
                  pWnd->target.pObject.pPlanet->Unknown_5E = v22;
                  break;
              }
              v23.pPlanet = (P_Planet)pWnd->target.pObject;
              LOBYTE(v23.pPlanet->Unknown_62) = v43;
              *(int *)((char *)&v23.pPlanet->Unknown_62 + 1) = Unknown_B1;
              LOBYTE(v23.pPlanet->dayColonized) = v45;
              v23.pPlanet = (P_Planet)((char *)v23.pPlanet + 0x62);
              *(_DWORD *)((char *)&v23.pPlanet->position.y + 2) = pPlanet;
              *(_DWORD *)((char *)&v23.pPlanet->position.z + 2) = v47;
              *(_DWORD *)&v23.pPlanet->Unknown_E = v48;
              *(P_Square *)((char *)&v23.pPlanet->pSquares + 2) = v49;
              *(_DWORD *)&v23.pPlanet->type = v50;
              *(_DWORD *)&v23.pPlanet->totalSquaresNum = v51;
              *(_DWORD *)&v23.pPlanet->freeOrbitalSquaresNum = v52;
              *(_DWORD *)&v23.pPlanet->z5 = v53;
              sub_49B3C(pWnd->target.pObject.pShip, 0);
              v24 = (int)pWnd->target.pObject.pPlanet;
              if ( (*(_BYTE *)(v24 + 0x84) & 8) == 0 )
              {
                pWnd->Unknown_BF = v24;
                pWnd->j1 = (int)p_Unknown_C8;
                pWnd->z = v80;
              }
            }
          }
          else if ( type == 2 )
          {
            if ( pWnd->Unknown_B0 != 2 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x33B);
            }
            if ( (_BYTE)param1a != 3 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x33C);
            }
          }
          pWnd->Unknown_B9 = 1;
          sub_12140(pWnd);
          pWnd->Unknown_B0 = 0;
          pProcs = pWnd->a2.pProcs;
          pWnd->Unknown_B1 = 0;
          pProcs->proc4_draw(&pWnd->a2.a1, 0);
          sub_12674((int)pWnd->pWnd04BM);
          return 0;
        }
      }
      v18 = 0;
      v19 = pWnd->target.type;
      pWnd->Unknown_BF = 0;
      if ( v19 == 3 && (_BYTE)param1a )
      {
        v69 = 0;
        v70 = 0;
        v71 = 0;
        *(_DWORD *)(&v43 + 0xFFFFFFF6 + 0x70) = 0;
        *(_DWORD *)(&v43 + 0xFFFFFFF6 + 0x74) = 0;
        *(_DWORD *)(&v43 + 0xFFFFFFF6 + 0x78) = 0;
        v65 = 1;
        v66 = pWnd->Unknown_B1;
        v67 = 5;
        if ( (unsigned __int8)param1a < 3u )
        {
          if ( (_BYTE)param1a == 2 )
          {
            v67 = 1;
            v68 = param2;
          }
        }
        else if ( (unsigned __int8)param1a <= 3u )
        {
          v68 = param2;
          v67 = 0;
        }
        else if ( (_BYTE)param1a == 4 && pWnd->Unknown_B0 == 1 )
        {
          v68 = param2;
          v67 = 2;
        }
        v20.pPlanet = (P_Planet)pWnd->target.pObject;
        LOBYTE(v20.pPlanet->Unknown_62) = v65;
        *(int *)((char *)&v20.pPlanet->Unknown_62 + 1) = v66;
        LOBYTE(v20.pPlanet->dayColonized) = v67;
        v20.pPlanet = (P_Planet)((char *)v20.pPlanet + 0x62);
        *(_DWORD *)((char *)&v20.pPlanet->position.y + 2) = v68;
        *(_DWORD *)((char *)&v20.pPlanet->position.z + 2) = v69;
        *(_DWORD *)&v20.pPlanet->Unknown_E = v70;
        *(P_Square *)((char *)&v20.pPlanet->pSquares + 2) = v71;
        *(_DWORD *)&v20.pPlanet->type = v72;
        *(_DWORD *)&v20.pPlanet->totalSquaresNum = v73;
        *(_DWORD *)&v20.pPlanet->freeOrbitalSquaresNum = v74;
        *(_DWORD *)&v20.pPlanet->z5 = v75;
        sub_49B3C(pWnd->target.pObject.pShip, 0);
        if ( (BYTE1(pWnd->target.pObject.pPlanet[1].position.z) & 1) == 0 )
        {
          return v18;
        }
      }
      else
      {
        if ( pWnd->target.type != 2 )
        {
          return v18;
        }
        if ( (_BYTE)param1a != 3 )
        {
          return v18;
        }
        v77 = (T_Type23 *)param2;
        p_t22 = &pWnd->target.pObject.pPlanet->t22;
        v76 = (T_Type23 *)pWnd->Unknown_B1;
        p_t22->pt23 = v76;
        p_t22 = (T_Type22 *)((char *)p_t22 + 4);
        p_t22->pt23 = v77;
        p_t22->pShip = v78;
        sub_3676C(pWnd->target.pObject.pPlanet, 0);
        if ( (pWnd->target.pObject.pPlanet->t22.Unknown_8 & 1) == 0 )
        {
          return v18;
        }
      }
      return 0xFFFFFFFF;
    }
    if ( message < 0xDu )
    {
      if ( message != 1 )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
      }
      Wnd_sub_56DA8 = (T_Wnd04BM *)Q_FindWnd_sub_56DA8(&WinMgr, "BatModeWnd", 0);
      pWnd->pWnd04BM = Wnd_sub_56DA8;
      if ( !Wnd_sub_56DA8 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x184);
      }
      v9 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "BatListWnd", 0);
      pWnd->pWnd10LB = v9;
      if ( !v9 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x187);
      }
      pWnd->pWnd10LB->Unknown_AB = 0;
      sub_2E9CC(pWnd->pWnd10LB, 0);
      pWnd->pWnd10LB->Unknown_C5 = 0;
      sub_2ED4C(pWnd->pWnd10LB);
      pWnd->a2.a1.Unknown_39 = 0xFFFFFFFF;
      pCurStar = V_Game.pCurStar;
      pWnd->a2.a1.Unknown_35 = 0xFFFFFFFF;
      pWnd->Unknown_BF = 0;
      v11 = sub_1D734(pCurStar, pWnd->Unknown_DA);
      pWnd->Unknown_D4 = 0;
      pWnd->Unknown_104 = 0;
      pWnd->Unknown_D6 = v11;
      if ( ((1 << V_PlayerRaceIndex) & (pCurStar->racePresenceBits | pCurStar->racesBits)) != 0 )
      {
        pWnd->Unknown_B9 = 1;
      }
      else
      {
        pWnd->Unknown_B9 = 4;
      }
      pWnd->h = 0;
      for ( i = 0; ; ++i )
      {
        v13 = i;
        if ( i >= pWnd->Unknown_D6 )
        {
          break;
        }
        pWnd->Unknown_E8[v13] = 0xFFFFFFFF;
      }
      sub_2D258(&pWnd->a2, message);
      sub_12140(pWnd);
      pWnd->a2.pProcs->proc4_draw((P_Wnd)pWnd, 0);
      return 0;
    }
    if ( message <= 0xDu )
    {
      pWnd->a2.pProcs->proc4_draw((P_Wnd)pWnd, 0);
      return 0;
    }
    if ( message != 0x320 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
    }
    pWnd->Unknown_B0 = 0;
    v16 = param1a;
    pWnd->Unknown_B1 = 0;
    pWnd->target.type = v16;
    v17 = pWnd->target.type;
    pWnd->target.pObject.pPlanet = (P_Planet)param2;
    if ( (unsigned __int8)v17 < 2u )
    {
      if ( !v17 )
      {
        pWnd->Unknown_B9 = 1;
        goto LABEL_55;
      }
    }
    else
    {
      if ( (unsigned __int8)v17 <= 2u )
      {
        pWnd->Unknown_B9 = 3;
        goto LABEL_55;
      }
      if ( v17 == 3 )
      {
        pWnd->Unknown_B9 = 2;
        goto LABEL_55;
      }
    }
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batcon.cpp", 0x263);
LABEL_55:
    sub_12140(pWnd);
    ((void (*)(void))pWnd->a2.pProcs->proc4_draw)();
    return 0xFFFFFFFF;
  }
  if ( message <= 0x327u )
  {
    if ( pWnd->pWnd04BM->Unknown_B7 != 4
      && ((1 << V_PlayerRaceIndex) & (V_Game.pCurStar->racesBits | V_Game.pCurStar->racePresenceBits)) != 0
      && !pWnd->Unknown_104
      && !pWnd->Unknown_D4 )
    {
      sub_1229C(pWnd, 0xFFFFFFFF);
      return 0;
    }
    return 0;
  }
  if ( message < 0x32Bu )
  {
    if ( message < 0x329u )
    {
      if ( pWnd->pWnd04BM->Unknown_B7 != 4
        && ((1 << V_PlayerRaceIndex) & (V_Game.pCurStar->racePresenceBits | V_Game.pCurStar->racesBits)) != 0
        && !pWnd->Unknown_104
        && !pWnd->Unknown_D4 )
      {
        pWnd->Unknown_D4 = 0xFFFF;
        pWnd->Unknown_104 = 0xFFFFFFFF;
        sub_1229C(pWnd, 0xFFFFFFFF);
        return 0;
      }
    }
    else
    {
      if ( message > 0x329u )
      {
        if ( pWnd->h )
        {
          pWnd->h = 0;
          sub_11BA4(pWnd);
        }
        return 0xFFFFFFFF;
      }
      if ( pWnd->pWnd04BM->Unknown_B7 != 4 )
      {
        Unknown_BF = pWnd->Unknown_BF;
        if ( Unknown_BF )
        {
          if ( *(_BYTE *)(Unknown_BF + 0x58) == 4 && V_Game.pCurStar == *(P_Star *)(pWnd->Unknown_BF + 0x59) )
          {
            pWnd->target.type = 3;
            pWnd->Unknown_B0 = 0;
            v15 = pWnd->Unknown_BF;
            pWnd->Unknown_B1 = 0;
            pWnd->target.pObject.pPlanet = (P_Planet)v15;
            pWnd->a2.pProcs->proc3(&pWnd->a2, 0x326u, pWnd->z, pWnd->j1);
            return 0;
          }
        }
      }
    }
    return 0;
  }
  if ( message <= 0x32Bu )
  {
    if ( pWnd->h != 1 )
    {
      pWnd->h = 1;
      sub_11BA4(pWnd);
    }
    return 0xFFFFFFFF;
  }
  if ( message < 0x32Du )
  {
    if ( pWnd->h != 4 )
    {
      pWnd->h = 4;
      sub_11BA4(pWnd);
    }
    return 0xFFFFFFFF;
  }
  if ( message <= 0x32Du )
  {
    if ( pWnd->h != 5 )
    {
      pWnd->h = 5;
      sub_11BA4(pWnd);
    }
    return 0xFFFFFFFF;
  }
  if ( message < 0x1C01u )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
  }
  if ( message <= 0x1C01u )
  {
    if ( pWnd->pWnd04BM->Unknown_B7 != 4 )
    {
      v26 = pWnd->Unknown_B9 - 1;
      pWnd->Unknown_BF = 0;
      switch ( v26 )
      {
        case 0:
        case 3:
          if ( param2 == 4 )
          {
            if ( sub_2ECA4((int)pWnd->pWnd10LB, param1a) >= 0 )
            {
              pWnd->target.type = 3;
              pWnd->Unknown_B9 = 2;
            }
            else
            {
              pWnd->target.type = 2;
              pWnd->Unknown_B9 = 3;
            }
            sub_12140(pWnd);
            ItemData_sub_2ED14 = Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
            v42 = 0;
            pWnd04BM = pWnd->pWnd04BM;
            pWnd->target.pObject.pPlanet = (P_Planet)ItemData_sub_2ED14;
            Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd04BM->a.a1.index, 0x53, 0, v42);
            ((void (*)(void))pWnd->a2.pProcs->proc4_draw)();
            result = 0xFFFFFFFF;
          }
          else
          {
            v29 = Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
            v30 = sub_12AE4(pWnd->pWnd04BM, (P_TargetObject)v29);
            if ( !v30 )
            {
              return 0xFFFFFFFF;
            }
            sub_17E88(pWnd->pWnd04BM, &v30->target);
            sub_18C2C(pWnd->pWnd04BM, 0);
            result = 0xFFFFFFFF;
          }
          break;
        case 1:
          if ( sub_2ECA4((int)pWnd->pWnd10LB, param1a) )
          {
            return 0xFFFFFFFF;
          }
          v31 = (char *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
          v32 = v31;
          if ( *v31 == (char)0xFF )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x39C);
          }
          v33 = &V_Gizmos[*v31];
          if ( (v33->flags & 0x80) != 0 )
          {
            return 0xFFFFFFFF;
          }
          v34 = v33->flags & 0x20;
          if ( (_BYTE)v34 )
          {
            sub_49A8C((int)pWnd->target.pObject.pPlanet, v32);
          }
          else
          {
            pWnd->Unknown_B0 = 1;
            pWnd->Unknown_B1 = (int)v32;
            if ( (v33->flags & 0x40) != 0 )
            {
              v58 = v34;
              v59 = v34;
              v60 = v34;
              v61 = v34;
              v62 = v34;
              v63 = v34;
              v54 = 1;
              v55 = pWnd->Unknown_B1;
              v56 = 5;
              p_Unknown_62 = &pWnd->target.pObject.pPlanet->Unknown_62;
              *(_BYTE *)p_Unknown_62 = 1;
              *(int *)((char *)p_Unknown_62 + 1) = v55;
              *((_BYTE *)p_Unknown_62 + 5) = v56;
              *(int *)((char *)p_Unknown_62 + 6) = v57;
              *(int *)((char *)p_Unknown_62 + 0xA) = v58;
              *(int *)((char *)p_Unknown_62 + 0xE) = v59;
              *(int *)((char *)p_Unknown_62 + 0x12) = v60;
              *(int *)((char *)p_Unknown_62 + 0x16) = v61;
              *(int *)((char *)p_Unknown_62 + 0x1A) = v62;
              *(int *)((char *)p_Unknown_62 + 0x1E) = v63;
              *(int *)((char *)p_Unknown_62 + 0x22) = v64;
              pWnd->Unknown_B0 = 0;
              pWnd->Unknown_B1 = 0;
              pWnd->Unknown_B9 = 1;
              sub_12140(pWnd);
              sub_12674((int)pWnd->pWnd04BM);
            }
            else
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd->pWnd04BM->a.a1.index, 0x51, 0, v34);
            }
          }
          ((void (*)(void))pWnd->a2.pProcs->proc4_draw)();
          return 0xFFFFFFFF;
        case 2:
          if ( sub_2ECA4((int)pWnd->pWnd10LB, param1a) )
          {
            return 0xFFFFFFFF;
          }
          v36 = Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
          v42 = 0;
          pWnd->Unknown_B0 = 2;
          v37 = pWnd->pWnd04BM;
          pWnd->Unknown_B1 = (int)v36;
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v37->a.a1.index, 0x51, 0, v42);
          return 0xFFFFFFFF;
        default:
          return 0xFFFFFFFF;
      }
      return result;
    }
    return 0;
  }
  if ( message != 0x1C02 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a2, message, param1a, param2);
  }
  switch ( pWnd->Unknown_B9 )
  {
    case 2:
      v38 = *(char *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, v38, 4);
      result = 0xFFFFFFFF;
      break;
    case 3:
      v39 = *((unsigned __int8 *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->pWnd10LB, param1a) + 1);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, v39, 5);
      goto LABEL_122;
    default:
LABEL_122:
      result = 0xFFFFFFFF;
      break;
  }
  return result;
}

//----- (00011870) --------------------------------------------------------
void __fastcall Q_Wnd19BC_Proc4_sub_11870(int a1, int a2)
{
  LONG v3; // esi
  char v4; // ah
  int v5; // esi
  int v6; // edx
  int v7; // ebx
  void *ShapeTable_sub_1B084; // eax
  char v9; // bl
  void *v10; // eax
  UBYTE racesBits; // cl
  __int16 v12; // ax
  int type; // [esp-20h] [ebp-A0h]
  char s[40]; // [esp+0h] [ebp-80h] BYREF
  PANE pane3; // [esp+28h] [ebp-58h] BYREF
  PANE pane2; // [esp+3Ch] [ebp-44h] BYREF
  PANE pane1; // [esp+50h] [ebp-30h] BYREF
  __int16 v18; // [esp+64h] [ebp-1Ch]
  WORD v19; // [esp+68h] [ebp-18h]

  if ( a2 != 0x1C01 )
  {
    sub_11BA4((P_Wnd19BC)a1);
  }
  pane1.window = *(WINDOW **)(a1 + 4);
  pane1.x0 = 466;
  pane1.y0 = 0;
  pane1.x1 = 639;
  pane1.y1 = 141;
  VFX_pane_wipe(&pane1, 0);
  v3 = 0xA;
  v4 = *(_BYTE *)(a1 + 0xB9);
  if ( v4 == 2 || v4 == 3 )
  {
    v5 = *(_DWORD *)(a1 + 0xB5) + 4;
    pane3.window = *(WINDOW **)v5;
    v5 += 4;
    pane3.x0 = *(_DWORD *)v5;
    v5 += 4;
    pane3.y0 = *(_DWORD *)v5;
    v5 += 4;
    pane3.x1 = *(_DWORD *)v5;
    pane3.y1 = *(_DWORD *)(v5 + 4);
    pane3.y0 = 7;
    pane3.y1 = *(unsigned __int16 *)(*(_DWORD *)(a1 + 0xB5) + 0x8C9) + 8;
    if ( *(_BYTE *)(a1 + 0xB9) == 2 )
    {
      v6 = *(_DWORD *)(a1 + 0xAC);
      v7 = 0;
      v3 = 0xB;
    }
    else
    {
      v7 = 0xFFFFFFFF;
      v6 = *(_DWORD *)(a1 + 0xAC);
      v3 = 0x13;
    }
    Q_BATCON_CPP_sub_10010(&pane3, v6, v7, 0);
  }
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
  VFX_shape_draw(&pane1, ShapeTable_sub_1B084, v3, 0, 0);
  sub_2D218((_DWORD *)a1);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane1);
  v9 = *(_BYTE *)(a1 + 0xB9);
  if ( v9 == 1 || v9 == 4 )
  {
    pane2.window = *(WINDOW **)(a1 + 4);
    pane2.x0 = 0x1DA;
    pane2.y0 = 7;
    pane2.x1 = 0x278;
    pane2.y1 = 0x25;
    type = V_Game.pCurStar->type;
    v10 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(*(_DWORD *)(a1 + 0xBB) + 0x19C8));
    VFX_shape_transform(&pane2, v10, type, 0xF, 0xF, V_BigBuffer, 0, 0x3333, 0x3333, 0);
    v19 = 0xF3;
    v18 = 0xFFFF;
    v12 = 0;
    if ( V_Game.racesNum > 0 )
    {
      while ( 1 )
      {
        if ( V_Game.races[v12].Unknown_03 != 0xFFFFFFFF )
        {
          racesBits = V_Game.pCurStar->racesBits;
          if ( racesBits )
          {
            if ( ((1 << v12) | racesBits) == 1 << v12 || V_Game.pCurStar == V_Game.races[v12]._homeStar && ((1 << v12) & racesBits) != 0 )
            {
              break;
            }
          }
        }
        if ( ++v12 >= V_Game.racesNum )
        {
          goto LABEL_20;
        }
      }
      v18 = v12;
    }
LABEL_20:
    if ( v18 != 0xFFFFFFFF )
    {
      v19 = 4 * V_Game.races[v12].Unknown_02 + 0x13;
      Q_WINMGR_CPP_sub_53E38(&pane2, 0x8D, 3, v12);
    }
    sprintf(s, "%s", V_Game.pCurStar->name);
    WinMgr.LargeFont.pane = pane2;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x28, 5, s, 0, v19, 0xFF, 0x6C);
    sprintf(s, "%s", V_StarTypeTexts_D84C4[V_Game.pCurStar->type]);
    WinMgr.SmallFont.pane = pane2;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x28, 0x12, s, 0, 0xF3, 0xFF, 0x6C);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane2);
  }
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 11870: using guessed type _DWORD pane3[2];

//----- (00011BA4) --------------------------------------------------------
int __fastcall sub_11BA4(P_Wnd19BC pWnd19BC)
{
  int ShipsAtLocation_sub_1D794; // ebp
  P_Ship v3; // edi
  unsigned __int16 v4; // ax
  WORD j; // di
  BYTE *v6; // edx
  unsigned __int16 v7; // ax
  int v9; // kr04_4
  int v10; // kr08_4
  int v11; // ebx
  BYTE cat; // ah
  int v13; // ebp
  BYTE v14; // al
  T_Gizmo *v15; // ebp
  unsigned __int16 v16; // dx
  T_Planet *pPlanet; // edi
  int v18; // edx
  int v19; // ebp
  int v20; // ebp
  int v21; // edx
  unsigned __int16 v22; // ax
  WORD n; // di
  BYTE *v24; // edx
  unsigned __int16 v25; // ax
  __int16 m; // di
  P_Ship ships[107]; // [esp+0h] [ebp-39Ch] BYREF
  int v28[107]; // [esp+1ACh] [ebp-1F0h] BYREF
  int v29; // [esp+358h] [ebp-44h]
  int v30; // [esp+35Ch] [ebp-40h]
  int a3; // [esp+360h] [ebp-3Ch] BYREF
  int a4; // [esp+364h] [ebp-38h] BYREF
  LONG v33; // [esp+368h] [ebp-34h] BYREF
  int result_4; // [esp+36Ch] [ebp-30h]
  unsigned int v35; // [esp+370h] [ebp-2Ch]
  int v36; // [esp+374h] [ebp-28h]
  int v37; // [esp+378h] [ebp-24h]
  __int16 i; // [esp+37Ch] [ebp-20h]
  __int16 k; // [esp+380h] [ebp-1Ch]

  sub_2ED4C(pWnd19BC->pWnd10LB);
  switch ( pWnd19BC->Unknown_B9 )
  {
    case 1:
      pWnd19BC->pWnd10LB->Unknown_8C9 = 0x54;
      Q_Wnd10LB_SetProc1_sub_2F1C8(pWnd19BC->pWnd10LB, Q_BATCON_CPP_sub_10010);
      ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)V_Game.pCurStar, ships);
      for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
      {
        v3 = ships[i];
        if ( v3->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
        {
          if ( v3->raceIndex >= 7 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x4AC);
          }
          if ( v3->raceIndex == V_PlayerRaceIndex )
          {
            v4 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, (BYTE *)ships[i], 0xFFFFFFFF, 0);
            Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v4, i);
          }
        }
      }
      for ( j = 0; j < V_Game.pCurStar->planetsNum; ++j )
      {
        v6 = (BYTE *)V_Game.pCurStar->planets[j];
        if ( v6[0x57] == V_PlayerRaceIndex )
        {
          v7 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, v6, 0xFFFFFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v7, j | 0x80000000);
        }
      }
      goto LABEL_15;
    case 2:
      if ( pWnd19BC->target.type != ASCEND_TARGET_TYPE_3_LANE )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x4D8);
      }
      if ( !pWnd19BC->target.pObject.pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x4D9);
      }
      pWnd19BC->pWnd10LB->Unknown_8C9 = 0x54;
      Q_Wnd10LB_SetProc1_sub_2F1C8(pWnd19BC->pWnd10LB, Q_BATCON_CPP_sub_10668);
      result_4 = (int)pWnd19BC->target.pObject.pPlanet;
      v30 = *(_DWORD *)(result_4 + 0x88);
      if ( *(_WORD *)(result_4 + 0x56) == V_PlayerRaceIndex || sub_4AAEC(result_4, V_PlayerRaceIndex) == 2 )
      {
        v9 = result_4 + 0xAB;
        v10 = 0;
        LOWORD(v37) = 0;
        while ( (__int16)v37 < *(_DWORD *)(result_4 + 0x15A) )
        {
          if ( *(_BYTE *)(v9 + 7 * v10) != 0xFF )
          {
            if ( (v13 = *(char *)(v9 + 7 * v10), v14 = V_Gizmos[v13].cat, v15 = &V_Gizmos[v13], v14 == pWnd19BC->h)
              && (v15->flags & 0x80) == 0
              || pWnd19BC->h == 4 && (v15->flags & 0x80) != 0 )
            {
              v16 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, (BYTE *)(v9 + 7 * v10), 0xFFFFFFFF, 0);
              v29 = *(__int16 *)(result_4 + 0x56);
              v11 = 0;
              if ( V_PlayerRaceIndex == v29 )
              {
                if ( (v15->flags & 0x20) == 0 )
                {
                  if ( !v15->numUses || *(_WORD *)(v9 + 7 * v10 + 1) )
                  {
                    if ( v30 < v15->power )
                    {
                      v11 = 3;
                    }
                  }
                  else
                  {
                    v11 = 2;
                  }
                }
              }
              else
              {
                v11 = 1;
              }
              if ( (v15->flags & 0x80) != 0 )
              {
                v11 = *(char *)(v9 + 7 * v10) + 0x1F4;
              }
              cat = v15->cat;
              if ( cat == 2 )
              {
                v11 = *(char *)(v9 + 7 * v10) + 0x258;
              }
              else if ( cat == 4 )
              {
                v11 = *(char *)(v9 + 7 * v10) + 0x2BC;
              }
              Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v16, v11);
            }
          }
          LOWORD(v37) = v37 + 1;
          ++v10;
        }
      }
      goto LABEL_15;
    case 3:
      pWnd19BC->pWnd10LB->Unknown_8C9 = 0x54;
      Q_Wnd10LB_SetProc1_sub_2F1C8(pWnd19BC->pWnd10LB, sub_10878);
      pPlanet = pWnd19BC->target.pObject.pPlanet;
      if ( pWnd19BC->target.type != ASCEND_TARGET_TYPE_2_SHIP )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x51F);
      }
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x520);
      }
      if ( V_PlayerRaceIndex == pPlanet->raceIndex )
      {
        for ( k = 0; k < (int)pPlanet->totalSquaresNum; ++k )
        {
          v18 = (int)&pPlanet->pSquares[k];
          v35 = 4 * k;
          v19 = 0;
          if ( (*(_WORD *)(v18 + 2) & 1) != 0 && (V_PlanetItems.item[*(unsigned __int8 *)(v18 + 1)].flags & 4) != 0 )
          {
            v36 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, (BYTE *)v18, 0xFFFFFFFF, 0);
            Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, pPlanet->pSquares[v35 / 4].planetItemIndex, &a3, &a4, &v33);
            if ( v33 && !((int)pPlanet->pSquares[v35 / 4].flags >> 8) )
            {
              v19 = 1;
            }
            Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v36, v19);
          }
        }
      }
      goto LABEL_15;
    case 4:
      pWnd19BC->pWnd10LB->Unknown_8C9 = 0x54;
      Q_Wnd10LB_SetProc1_sub_2F1C8(pWnd19BC->pWnd10LB, Q_BATCON_CPP_sub_10010);
      v20 = Q_FindShipsAtLocation_sub_1D794((P_Location)V_Game.pCurStar, (P_Ship *)v28);
      for ( m = 0; m < v20; ++m )
      {
        v21 = v28[m];
        if ( *(_BYTE *)(v21 + 0x58) == 4 && *(_WORD *)(v21 + 0x56) != V_PlayerRaceIndex )
        {
          v22 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, (BYTE *)v21, 0xFFFFFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v22, m);
        }
      }
      for ( n = 0; n < V_Game.pCurStar->planetsNum; ++n )
      {
        v24 = (BYTE *)V_Game.pCurStar->planets[n];
        if ( V_PlayerRaceIndex != v24[0x57] )
        {
          v25 = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd19BC->pWnd10LB, v24, 0xFFFFFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd19BC->pWnd10LB, v25, n | 0x80000000);
        }
      }
LABEL_15:
      Q_Wnd10LB_SetCompareProc_sub_2F1D8(pWnd19BC->pWnd10LB, Q_CompareListBoxItems_sub_10A14);
      Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(pWnd19BC->pWnd10LB);
      break;
    default:
      return ((int (*)(void))pWnd19BC->pWnd10LB->a.pProcs->proc4_draw)();
  }
  return ((int (*)(void))pWnd19BC->pWnd10LB->a.pProcs->proc4_draw)();
}
// 11BA4: using guessed type int var_1F0[107];

//----- (00012140) --------------------------------------------------------
int __fastcall sub_12140(P_Wnd19BC pWnd19BC)
{
  WORD i; // si
  unsigned int v3; // edx
  BYTE Unknown_B9; // ah
  __int16 j; // bx
  int v6; // eax
  int result; // eax
  int v8; // eax
  unsigned int v9; // [esp+4h] [ebp-1Ch]

  for ( i = 0; i < pWnd19BC->a2.a1.childrenNum; ++i )
  {
    if ( !strcmp((*pWnd19BC->a2.a1.children)[i]->name, "My^Items") )
    {
      break;
    }
  }
  if ( i >= pWnd19BC->a2.a1.childrenNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batcon.cpp", 0x58C);
  }
  v3 = 0xFFFFFFFF;
  Unknown_B9 = pWnd19BC->Unknown_B9;
  v9 = 0;
  if ( Unknown_B9 == 2 )
  {
    v3 = 0;
  }
  else if ( Unknown_B9 == 3 )
  {
    v9 = 0xFFFFFFFF;
  }
  for ( j = 0; ; ++j )
  {
    result = j;
    if ( j >= 9 )
    {
      break;
    }
    if ( v9 )
    {
      v6 = i + j;
      (*pWnd19BC->a2.a1.children)[v6]->Unknown_35 = 0;
      (*pWnd19BC->a2.a1.children)[v6]->Unknown_39 = 0;
    }
    else
    {
      v8 = i + j;
      if ( j >= 5 )
      {
        (*pWnd19BC->a2.a1.children)[v8]->Unknown_35 = ~v3;
        (*pWnd19BC->a2.a1.children)[v8]->Unknown_39 = ~v3;
      }
      else
      {
        (*pWnd19BC->a2.a1.children)[v8]->Unknown_35 = v3;
        (*pWnd19BC->a2.a1.children)[v8]->Unknown_39 = v3;
      }
    }
  }
  return result;
}

//----- (00012238) --------------------------------------------------------
void __fastcall sub_12238(P_Wnd19BC pWnd19BC, int a2)
{
  if ( pWnd19BC->target.type == ASCEND_TARGET_TYPE_3_LANE )
  {
    sub_49B3C(pWnd19BC->target.pObject.pShip, 1);
  }
  else if ( pWnd19BC->target.type == ASCEND_TARGET_TYPE_2_SHIP )
  {
    sub_3676C(pWnd19BC->target.pObject.pPlanet, 1);
  }
  pWnd19BC->target.type = 0;
  pWnd19BC->target.pObject.pPlanet = 0;
  if ( a2 == 0xFFFFFFFF )
  {
    sub_11BA4(pWnd19BC);
  }
  sub_1229C(pWnd19BC, a2);
}

//----- (0001229C) --------------------------------------------------------
void __fastcall sub_1229C(P_Wnd19BC pWnd19BC, int a2)
{
  T_Star *pCurStar; // esi
  T_Target target; // [esp+0h] [ebp-8h] BYREF

  pCurStar = V_Game.pCurStar;
  while ( ++pWnd19BC->Unknown_D4 < pWnd19BC->Unknown_D6 || sub_12368(pWnd19BC, a2) )
  {
    target.type = 0;
    pWnd19BC->Unknown_E8[pWnd19BC->Unknown_D4] = sub_406C4(&V_Game.races[pWnd19BC->Unknown_DA[pWnd19BC->Unknown_D4]], pCurStar, &target);
    if ( target.type )
    {
      pWnd19BC->target = target;
      if ( target.type == 3 )
      {
        sub_49B3C((P_Ship)target.pObject.pPlanet, 0);
      }
      else
      {
        sub_3676C(target.pObject.pPlanet, 0);
      }
      if ( a2 == 0xFFFFFFFF )
      {
        sub_12674((int)pWnd19BC->pWnd04BM);
      }
      else
      {
        sub_12238(pWnd19BC, a2);
      }
      return;
    }
  }
}
// 1229C: using guessed type T_Target target;

//----- (00012368) --------------------------------------------------------
int __fastcall sub_12368(P_Wnd19BC pWnd19BC, int a2)
{
  P_Star pCurStar; // esi
  int v4; // edi
  __int16 i; // ax
  T_Star *v6; // eax
  int v7; // eax
  T_Race *v8; // eax
  __int16 j; // cx

  pCurStar = V_Game.pCurStar;
  v4 = 0;
  if ( pWnd19BC->Unknown_104 == 0xFFFFFFFF )
  {
    for ( i = 0; i < pWnd19BC->Unknown_D6; ++i )
    {
      if ( pWnd19BC->Unknown_E8[i] == 0xFFFFFFFF )
      {
        v4 = 0xFFFFFFFF;
        break;
      }
    }
  }
  v6 = V_Game.pCurStar;
  pWnd19BC->Unknown_104 = v4;
  v7 = sub_1D734(v6, pWnd19BC->Unknown_DA);
  pWnd19BC->Unknown_D4 = 0;
  pWnd19BC->Unknown_D6 = v7;
  for ( j = 0; j < pWnd19BC->Unknown_D6; ++j )
  {
    v8 = &V_Game.races[pWnd19BC->Unknown_DA[j]];
    sub_3B56C(v8, (P_Location)pCurStar);
  }
  if ( a2 == 0xFFFFFFFF )
  {
    pWnd19BC->a2.pProcs->proc4_draw((P_Wnd)pWnd19BC, 0);
  }
  return v4;
}

//----- (0001240C) --------------------------------------------------------
void __fastcall sub_1240C(int a1, int a2)
{
  sub_2FBA4(a1, a2);
  Q_WINMGR_CPP_sub_53E38((PANE *)(a1 + 4), 3, 3, V_PlayerRaceIndex);
}

//----- (00012440) --------------------------------------------------------
char *__fastcall sub_12440(char *result)
{
  *(_DWORD *)(result + 0xA) = 0;
  *(_DWORD *)(result + 0xE) = 0;
  *(_DWORD *)(result + 0x12) = 0;
  *(_DWORD *)(result + 0x1A) = 0;
  *(_DWORD *)(result + 0x1E) = 0;
  *(_DWORD *)(result + 0x16) = 0;
  return result;
}

//----- (00012480) --------------------------------------------------------
int __fastcall sub_12480(float *a1, float *a2, float a3)
{
  double v6; // st7
  double v7; // st7
  float v9; // [esp+8h] [ebp-80h] BYREF
  float v10; // [esp+Ch] [ebp-7Ch]
  float v11; // [esp+10h] [ebp-78h]
  float v12; // [esp+14h] [ebp-74h] BYREF
  float v13; // [esp+18h] [ebp-70h]
  float v14; // [esp+1Ch] [ebp-6Ch]
  int v15[3]; // [esp+20h] [ebp-68h] BYREF
  float v16; // [esp+2Ch] [ebp-5Ch]
  int v17; // [esp+30h] [ebp-58h]
  int v18; // [esp+34h] [ebp-54h]
  float v19; // [esp+38h] [ebp-50h]
  float v20; // [esp+3Ch] [ebp-4Ch]
  float v21; // [esp+40h] [ebp-48h]
  int v22[3]; // [esp+44h] [ebp-44h] BYREF
  float v23; // [esp+50h] [ebp-38h]
  float v24; // [esp+54h] [ebp-34h]
  float v25; // [esp+58h] [ebp-30h]
  float v26; // [esp+5Ch] [ebp-2Ch]
  int v27; // [esp+60h] [ebp-28h]
  int v28; // [esp+64h] [ebp-24h]
  int *v29; // [esp+68h] [ebp-20h]
  float *v30; // [esp+6Ch] [ebp-1Ch]
  int *v31; // [esp+70h] [ebp-18h]
  float *v32; // [esp+74h] [ebp-14h]
  float v33; // [esp+7Ch] [ebp-Ch]

  v30 = &v12;
  v23 = 0.0;
  v24 = 0.0;
  v25 = 0.0;
  v23 = *a2 - *a1;
  v24 = a2[1] - a1[1];
  v25 = a2[2] - a1[2];
  v12 = v23;
  v13 = v24;
  v14 = v25;
  v33 = sqrt(v24 * v24 + v23 * v23 + v25 * v25);
  if ( a3 >= (double)v33 )
  {
    *a1 = *a2;
    a1[1] = a2[1];
    a1[2] = a2[2];
    return 0xFFFFFFFF;
  }
  else
  {
    v26 = v12 * a3;
    *(float *)&v27 = v13 * a3;
    *(float *)&v28 = a3 * v14;
    v6 = 1.0 / v33;
    v29 = v22;
    *(float *)v22 = v26;
    v22[1] = v27;
    v22[2] = v28;
    v16 = v26 * v6;
    v31 = v15;
    *(float *)&v17 = *(float *)&v27 * v6;
    *(float *)v15 = v16;
    v19 = 0.0;
    v15[1] = v17;
    *(float *)&v18 = v6 * *(float *)&v28;
    v20 = 0.0;
    v15[2] = v18;
    v21 = 0.0;
    v32 = &v9;
    v19 = *a1 + v16;
    v20 = a1[1] + *(float *)&v17;
    v7 = a1[2];
    v9 = v19;
    v21 = v7 + *(float *)&v18;
    v10 = v20;
    v11 = v21;
    *a1 = v19;
    a1[1] = v10;
    a1[2] = v11;
    return 0;
  }
}

//----- (00012618) --------------------------------------------------------
unsigned int __fastcall sub_12618(int a1)
{
  int v2; // esi
  void *ShapeTable_sub_1B084; // eax
  unsigned int v4; // ebp
  LONG v5; // esi
  UWORD v7; // [esp+0h] [ebp-1Ch]

  v7 = *(_WORD *)(a1 + 5);
  v2 = *(_DWORD *)(a1 + 7);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v7);
  v4 = 0;
  v5 = v2 + 1;
  if ( v5 >= VFX_shape_count(ShapeTable_sub_1B084) )
  {
    v4 = 0xFFFFFFFF;
    LOWORD(v5) = 0;
  }
  sub_156C0(a1, v7, v5);
  return v4;
}

//----- (00012674) --------------------------------------------------------
void __fastcall sub_12674(int a1)
{
  *(_BYTE *)(a1 + 0x4F37) = 0xFF;
  *(_DWORD *)(a1 + 0xB3) = 0;
  *(_WORD *)(a1 + 0x5034) = 0;
  *(_BYTE *)(a1 + 0xB7) = 4;
  sub_56400(&WinMgr, *(_DWORD *)(a1 + 0x41), 0x52, 0, 0, 0);
}

//----- (000126F8) --------------------------------------------------------
T_Wnd04BM *__usercall sub_126F8@<eax>(T_Wnd04BM *a1@<eax>, int sfx2@<edx>, int a3@<ebp>)
{
  unsigned int v4; // edi
  P_Wnd19BC pWnd19BC; // edx
  char v6; // al
  char type; // bl
  T_Target *p_target; // edx
  P_TargetObject v9; // edx
  int *p_Unknown_62; // edx
  char v11; // al
  T_Wnd04BM *result; // eax
  int index; // edx
  int i; // ebx
  int j; // ebx
  int k; // kr14_4

  v4 = 0;
  if ( a1->Unknown_4F37 != (char)0xFF )
  {
    goto LABEL_42;
  }
  sub_187EC(a1);
  sub_18C2C(a1, 0);
  pWnd19BC = a1->pWnd19BC;
  a1->Unknown_4F38[0] = 0;
  v6 = 0;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    if ( type != 2 )
    {
      goto LABEL_41;
    }
    v6 = 0x34;
    if ( p_target->pObject.pPlanet->t22.pt23->planetItemIndex == 0x11 )
    {
      a1->Unknown_4F37 = 3;
      goto LABEL_41;
    }
    goto LABEL_40;
  }
  v9.pPlanet = (P_Planet)p_target->pObject;
  type = v9.pPlanet->Unknown_62;
  p_Unknown_62 = &v9.pPlanet->Unknown_62;
  if ( type )
  {
    if ( type != 1 )
    {
      goto LABEL_41;
    }
    v6 = **(_BYTE **)((char *)p_Unknown_62 + 1);
    switch ( v6 )
    {
      case '4':
        a1->Unknown_4F37 = 3;
        goto LABEL_41;
      case '7':
        a1->Unknown_4F37 = 4;
        goto LABEL_41;
      case ' ':
        a1->Unknown_4F37 = 5;
        goto LABEL_41;
      case '8':
      case 'J':
        a1->Unknown_4F37 = 6;
        goto LABEL_41;
      case ':':
        a1->Unknown_4F37 = 7;
        goto LABEL_41;
      case '.':
        a1->Unknown_4F37 = 8;
        goto LABEL_41;
      case '<':
        a1->Unknown_4F37 = 9;
        goto LABEL_41;
      case ';':
      case 'D':
        a1->Unknown_4F37 = 0xA;
        goto LABEL_41;
      case '-':
        a1->Unknown_4F37 = 0xB;
        goto LABEL_41;
      case '(':
      case '\'':
        a1->Unknown_4F37 = 0xC;
        goto LABEL_41;
      case '$':
        a1->Unknown_4F37 = 0xD;
        goto LABEL_41;
      case 'H':
        a1->Unknown_4F37 = 0xE;
        goto LABEL_41;
      case '&':
        a1->Unknown_4F37 = 0xF;
        goto LABEL_41;
    }
    if ( (V_Gizmos[v6].flags & 0x40) == 0 )
    {
      a1->Unknown_4F37 = 2;
      goto LABEL_41;
    }
LABEL_40:
    a1->Unknown_4F37 = type;
    goto LABEL_41;
  }
  a1->Unknown_4F37 = 0;
LABEL_41:
  Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a1->Unknown_19C6[a1->gvShape[v6].shape1]);
  Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a1->Unknown_19C6[a1->gvShape[v11].shape2]);
  sub_50140(&V_SoundSystem, a1->gvSfx[v11].sfx1);
  sfx2 = a1->gvSfx[v11].sfx2;
  sub_50140(&V_SoundSystem, sfx2);
LABEL_42:
  for ( i = 0; i < a1->Unknown_5034; ++i )
  {
    sfx2 = a1->Unknown_4F38[i + 3];
    sub_12B4C((int)a1, sfx2);
  }
  switch ( a1->Unknown_4F37 )
  {
    case 0xFF:
      v4 = 0xFFFFFFFF;
      break;
    case 0:
      v4 = sub_12C98(a1, sfx2, i);
      break;
    case 1:
      v4 = sub_12E88((int)a1);
      break;
    case 2:
      v4 = sub_12F7C((int)a1, a3);
      break;
    case 3:
      v4 = sub_13370((int)a1, sfx2, i);
      break;
    case 4:
      v4 = sub_136C4((int)a1);
      break;
    case 5:
      v4 = sub_1380C((int)a1);
      break;
    case 6:
      v4 = sub_13C10(a1);
      break;
    case 7:
      v4 = sub_14224(a1);
      break;
    case 8:
      v4 = sub_142D8((int)a1);
      break;
    case 9:
      v4 = sub_14490((int)a1);
      break;
    case 0xA:
      v4 = sub_145C0((int)a1);
      break;
    case 0xB:
      v4 = sub_147CC((int)a1);
      break;
    case 0xC:
      v4 = sub_14B18((int)a1, sfx2, i);
      break;
    case 0xD:
      v4 = sub_15078(a1);
      break;
    case 0xE:
      v4 = sub_15164((int)a1);
      break;
    case 0xF:
      v4 = sub_152E4((int)a1, sfx2, i, (int)a1);
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0xF8);
      break;
  }
  if ( *(_DWORD *)a1->Unknown_5036 == 0xFFFFFFFF )
  {
    v4 = 0xFFFFFFFF;
    *(_DWORD *)a1->Unknown_5036 = 0;
  }
  sub_18C2C(a1, 1);
  for ( j = 0; j < a1->Unknown_5034; ++j )
  {
    sub_12B4C((int)a1, a1->Unknown_4F38[j + 3]);
  }
  result = (T_Wnd04BM *)((int (__fastcall *)(T_Wnd04BM *, int))a1->a.pProcs->proc4_draw)(a1, 1);
  ++a1->Unknown_4F38[0];
  if ( v4 == 0xFFFFFFFF )
  {
    index = a1->a.a1.index;
    a1->Unknown_B7 = 0;
    sub_564C0(&WinMgr, index, 0x52);
    sub_12238(a1->pWnd19BC, 0xFFFFFFFF);
    sub_187EC(a1);
    sub_18C2C(a1, 0);
    a1->Unknown_4F37 = 0xFF;
    result = a1;
    for ( k = 0; k < a1->Unknown_5034; ++k )
    {
      *(_BYTE *)(a1->Unknown_4F38[k + 3] + 0x33) &= 1u;
    }
  }
  return result;
}

//----- (00012AE4) --------------------------------------------------------
P_Type21 __fastcall sub_12AE4(P_Wnd04BM pWnd04BM, P_TargetObject a2)
{
  T_Type21 *v3; // edi
  int v4; // edx
  P_Type21 t21; // kr00_4

  if ( !a2.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x122);
  }
  v3 = 0;
  if ( pWnd04BM->Unknown_1D32 > 0 )
  {
    t21 = pWnd04BM->_t21;
    v4 = 0;
    while ( a2.pPlanet != t21[v4].target.pObject.pPlanet )
    {
      if ( ++v4 >= pWnd04BM->Unknown_1D32 )
      {
        goto LABEL_10;
      }
    }
    v3 = &t21[v4];
  }
LABEL_10:
  if ( !v3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x12F);
  }
  return v3;
}

//----- (00012B4C) --------------------------------------------------------
void __fastcall sub_12B4C(int a1, int a2)
{
  int v2; // ebx
  int v3; // esi
  int v4; // ecx
  LONG v5; // eax
  int v6; // eax
  LONG v7; // ebx
  double v8; // st7
  double v9; // st6
  double v10; // st5
  int v11; // [esp+Ch] [ebp-18h]

  if ( *(_BYTE *)a2 == 8 )
  {
    v2 = *(_DWORD *)(a2 + 1);
    if ( *(_WORD *)(a2 + 0x27) >= *(_WORD *)(v2 + 0x27) )
    {
      v3 = *(_DWORD *)(a1 + 8);
      pPane.x0 = v3 + *(__int16 *)(v2 + 0x27);
      v4 = *(__int16 *)(a2 + 0x27);
    }
    else
    {
      v3 = *(__int16 *)(v2 + 0x27);
      pPane.x0 = *(_DWORD *)(a1 + 8) + *(__int16 *)(a2 + 0x27);
      v4 = *(_DWORD *)(a1 + 8);
    }
    pPane.x1 = v3 + v4;
    if ( *(_WORD *)(a2 + 0x29) >= *(_WORD *)(v2 + 0x29) )
    {
      v6 = *(_DWORD *)(a1 + 0xC);
      v7 = *(__int16 *)(v2 + 0x29) + v6;
      v5 = *(__int16 *)(a2 + 0x29) + v6;
      pPane.y0 = v7;
    }
    else
    {
      pPane.y0 = *(__int16 *)(a2 + 0x29) + *(_DWORD *)(a1 + 0xC);
      v5 = *(__int16 *)(v2 + 0x29) + *(_DWORD *)(a1 + 0xC);
    }
    pPane.y1 = v5;
  }
  else
  {
    v11 = *(__int16 *)(a2 + 0x29) + *(_DWORD *)(a1 + 0xC);
    v8 = (double)*(unsigned int *)(a2 + 0xF) * 0.0000152587890625;
    v9 = (double)(*(__int16 *)(a2 + 0x27) + *(_DWORD *)(a1 + 8));
    pPane.x0 = (int)((double)*(__int16 *)(a2 + 0x13) * v8 + v9);
    v10 = (double)v11;
    pPane.y0 = (int)((double)*(__int16 *)(a2 + 0x15) * v8 + v10);
    pPane.x1 = (int)(v9 + (double)*(__int16 *)(a2 + 0x17) * v8);
    pPane.y1 = (int)(v8 * (double)*(__int16 *)(a2 + 0x19) + v10);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
}

//----- (00012C98) --------------------------------------------------------
unsigned int __fastcall sub_12C98(P_Wnd04BM a1, int a2, int a3)
{
  P_Wnd19BC pWnd19BC; // edi
  unsigned int v5; // ebp
  BYTE type; // ah
  T_Target *p_target; // edi
  P_TargetObject v8; // edi
  char dayColonized; // dl
  P_Type21 v10; // eax
  P_Type21 v11; // eax
  int v13; // edi
  void *ShapeTable_sub_1B084; // eax
  int v15; // edi
  int v16; // ecx
  unsigned __int16 v17; // [esp+0h] [ebp-1Ch]

  pWnd19BC = a1->pWnd19BC;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x16B);
  }
  v5 = 0;
  v8.pPlanet = (P_Planet)p_target->pObject;
  dayColonized = v8.pPlanet->dayColonized;
  if ( dayColonized != 3 && dayColonized != 1 && dayColonized != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x171);
  }
  if ( !a1->Unknown_4F38[0] )
  {
    a1->Unknown_5034 = 1;
    v10 = sub_12AE4(a1, v8);
    a1->Unknown_4F44 = v10;
    v10->Unknown_33 = 0x12;
    *((_BYTE *)a1->Unknown_4F44 + 0x34) = 0;
    a1->vectors3[0].x = *(float *)((char *)&v8.pPlanet[1].z5 + 1);
    a1->vectors3[0].y = *(float *)&v8.pPlanet[1].name[3];
    a1->vectors3[0].z = *(float *)&v8.pPlanet[1].name[7];
    a1->Unknown_4F38[1] = 0;
    if ( *(_DWORD *)((char *)&v8.pPlanet[1].surfaceSquaresNum + 1) )
    {
      if ( *(_DWORD *)((char *)&v8.pPlanet[1].starIndex + 1) )
      {
        Q_StartSample_sub_4FB90(&V_SoundSystem, 7);
      }
    }
  }
  if ( a1->Unknown_4F38[1] )
  {
    v17 = 7;
    if ( (*(_BYTE *)(*(int *)((char *)&v8.pPlanet->dayColonized + 1) + 0x23) & 1) != 0 )
    {
      v17 = 8;
    }
    v13 = a1->Unknown_4F38[1];
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a1->Unknown_19C6[v17]);
    v15 = v13 >> 2;
    v16 = VFX_shape_count(ShapeTable_sub_1B084) - 1;
    if ( v15 <= v16 || v15 > 2 * v16 )
    {
      if ( v15 > 2 * v16 )
      {
        v5 = 0xFFFFFFFF;
        LOWORD(v15) = 0;
      }
    }
    else
    {
      LOWORD(v15) = 2 * v16 - v15;
    }
    sub_1826C(a1, a1->Unknown_4F48, v17, v15);
    ++a1->Unknown_4F38[1];
  }
  else if ( sub_12480(&a1->vectors3[0].x, (float *)((char *)&v8.pPlanet->Unknown_77 + 1), 20.0) == 0xFFFFFFFF )
  {
    if ( (v8.pShip->Unknown_84 & 8) == 0
      || v8.pShip->_target.type != 2
      || Q_Ship_CanTraverseStarLane_sub_4960C(v8.pShip, (P_Lane)v8.pShip->_target.pObject.pShip) != 0xFFFFFFFF )
    {
      return 0xFFFFFFFF;
    }
    *((_BYTE *)a1->Unknown_4F44 + 0x33) |= 8u;
    a1->Unknown_5034 = 2;
    v11 = sub_12AE4(a1, *(P_TargetObject *)((char *)&v8.pPlanet->dayColonized + 1));
    a1->Unknown_4F38[1] = 1;
    a1->Unknown_4F48 = (int)v11;
  }
  return v5;
}

//----- (00012E88) --------------------------------------------------------
unsigned int __fastcall sub_12E88(int a1)
{
  int v2; // ebp
  int v3; // edi
  char v4; // ah
  int v5; // ebp
  int v6; // eax
  char v7; // bl
  _BYTE *v8; // edx

  v2 = *(_DWORD *)(a1 + 0xAB);
  v4 = *(_BYTE *)(v2 + 0xAB);
  v5 = v2 + 0xAB;
  if ( v4 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x1BA);
  }
  v3 = 0;
  v6 = *(_DWORD *)(v5 + 1);
  v7 = **(_BYTE **)(v6 + 0x63);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    v8 = *(_BYTE **)(a1 + 0x1D2A);
    *(_WORD *)(a1 + 0x5034) = 1;
    v8 += 0x35;
    *(_DWORD *)(a1 + 0x4F44) = v8;
    *v8 = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)(v6 + 0x9E);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)(v6 + 0xA2);
    *(float *)(a1 + 0x4F88) = *(float *)(v6 + 0xA6);
    sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F44), *(_WORD *)(a1 + 4 * v7 + 0x1A92), 0);
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 4 * v7 + 0x1BCE));
  }
  if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618(*(_DWORD *)(a1 + 0x4F44)) == 0xFFFFFFFF )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (00012F7C) --------------------------------------------------------
int __usercall sub_12F7C@<eax>(int a1@<eax>, int ebp0@<ebp>)
{
  int v3; // edx
  char v4; // bl
  int v5; // ebp
  int v6; // ebp
  int *v7; // edi
  int v8; // ebp
  UBYTE v9; // al
  char v10; // cl
  _BYTE *v11; // eax
  int v12; // edi
  __int16 v14; // di
  unsigned __int16 v15; // ax
  _BYTE *v16; // eax
  char v17; // bl
  int v18; // eax
  float x_4; // [esp+4h] [ebp-7Ch]
  float v20; // [esp+8h] [ebp-78h] BYREF
  _DWORD *a2; // [esp+Ch] [ebp-74h]
  _DWORD *a3; // [esp+10h] [ebp-70h]
  _DWORD *a4; // [esp+14h] [ebp-6Ch]
  float v24; // [esp+18h] [ebp-68h]
  float v25; // [esp+1Ch] [ebp-64h]
  int v26[3]; // [esp+20h] [ebp-60h] BYREF
  float v27; // [esp+2Ch] [ebp-54h]
  int v28; // [esp+30h] [ebp-50h]
  int v29; // [esp+34h] [ebp-4Ch]
  int v30; // [esp+38h] [ebp-48h] BYREF
  __int64 result; // [esp+3Ch] [ebp-44h] BYREF
  _DWORD v32[2]; // [esp+48h] [ebp-38h] BYREF
  int v33; // [esp+50h] [ebp-30h]
  float v34; // [esp+54h] [ebp-2Ch]
  int v35; // [esp+58h] [ebp-28h]
  int v36; // [esp+5Ch] [ebp-24h]
  _BYTE *v37; // [esp+60h] [ebp-20h]
  char v38; // [esp+64h] [ebp-1Ch]

  v33 = 0;
  v3 = *(_DWORD *)(a1 + 0xAB) + 0xAB;
  *(float *)&a4 = 0.0;
  v24 = 0.0;
  v25 = 0.0;
  v20 = 0.0;
  *(float *)&a2 = 0.0;
  *(float *)&a3 = 0.0;
  v32[0] = 0;
  v4 = *(_BYTE *)v3;
  v38 = 0;
  if ( v4 == 3 )
  {
    v5 = *(_DWORD *)(v3 + 1);
    a4 = *(_DWORD **)(v5 + 0x9E);
    v24 = *(float *)(v5 + 0xA2);
    v25 = *(float *)(v5 + 0xA6);
    v20 = *(float *)(v5 + 0x78);
    a2 = *(_DWORD **)(v5 + 0x7C);
    a3 = *(_DWORD **)(v5 + 0x80);
    v36 = **(char **)(v5 + 0x63);
    v35 = *(_DWORD *)(v5 + 0x84);
    v38 = *(_BYTE *)(v5 + 0x67);
    ebp0 = *(_DWORD *)(v5 + 0x68);
    v32[0] = V_Gizmos[v36].range;
  }
  else if ( v4 == 2 )
  {
    v6 = *(_DWORD *)(v3 + 1);
    a4 = *(_DWORD **)v6;
    v24 = *(float *)(v6 + 4);
    v7 = (int *)(v6 + 0x6B);
    v25 = *(float *)(v6 + 8);
    v8 = *(_DWORD *)(v6 + 0x6F);
    v20 = *(float *)(v8 + 0x9E);
    a2 = *(_DWORD **)(v8 + 0xA2);
    a3 = *(_DWORD **)(v8 + 0xA6);
    v35 = v7[2];
    ebp0 = v7[1];
    v9 = *(_BYTE *)(*v7 + 1);
    HIDWORD(result) = *(_DWORD *)(v3 + 1);
    Q_Planet_GetOrbitalWeaponStats_sub_366C8((P_Planet)HIDWORD(result), v9, v32, &v30, (LONG *)&result);
    v10 = *(_BYTE *)(*v7 + 1);
    switch ( v10 )
    {
      case 0x1C:
        v36 = 0x4C;
        break;
      case 0x1D:
        v36 = 0x4D;
        break;
      case 0x1E:
        v36 = 0x4E;
        break;
    }
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0x20E);
  }
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v11 = *(_BYTE **)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    v11 += 0x35;
    *(_DWORD *)(a1 + 0x4F44) = v11;
    *v11 = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = *(float *)&a4;
    *(float *)(a1 + 0x4F84) = v24;
    v12 = v36;
    *(float *)(a1 + 0x4F88) = v25;
    sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F44), *(_WORD *)(a1 + 4 * v12 + 0x1A92), 0);
    *(_DWORD *)(a1 + 0x4F48) = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)ebp0);
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 4 * v12 + 0x1BCE));
  }
  if ( *(_DWORD *)(a1 + 0x4F3C) )
  {
    v14 = 1;
    v34 = 1.0;
    v15 = 4;
    if ( (v35 & 4) != 0 || v36 == 0x3D )
    {
      v16 = *(_BYTE **)(a1 + 0x4F48);
      if ( *v16 == 2 )
      {
        LOWORD(v16) = *(char *)(ebp0 + 0xAA);
        v37 = v16;
        v34 = (double)(__int16)v16 * 0.3333333333333333 + 1.0;
      }
      v14 = 5;
      v17 = v36;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 8u;
      v15 = (char)(((v17 & 1) == 0) + 5);
      if ( v36 != 0x3D )
      {
        goto LABEL_29;
      }
      v18 = 0x3D;
    }
    else
    {
      if ( (v35 & 2) == 0 && (v35 & 0x10) == 0 && v38 != 1 && v38 != 2 )
      {
        goto LABEL_29;
      }
      v18 = v36;
    }
    v14 = *(_WORD *)(a1 + 4 * v18 + 0x1BD0);
    v15 = *(_WORD *)(a1 + 4 * v18 + 0x1A94);
LABEL_29:
    if ( *(_DWORD *)(a1 + 0x4F3C) == 1 )
    {
      sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F44), v15, 0);
      Q_StartSample_sub_4FB90(&V_SoundSystem, v14);
      *(_DWORD *)(a1 + 0x4F3C) = 2;
    }
    if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618(*(_DWORD *)(a1 + 0x4F44)) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 8u;
      v33 = 0xFFFFFFFF;
    }
    *(float *)(*(_DWORD *)(a1 + 0x4F44) + 0xB) = v34;
    return v33;
  }
  v27 = v20 - *(float *)&a4;
  v32[1] = v26;
  *(float *)&v28 = *(float *)&a2 - v24;
  *(float *)&v29 = *(float *)&a3 - v25;
  *(float *)v26 = v27;
  v26[1] = v28;
  v26[2] = v29;
  x_4 = sqrt(*(float *)&v28 * *(float *)&v28 + v27 * v27 + *(float *)&v29 * *(float *)&v29) * 0.015625 + 20.0;
  if ( sub_12480((float *)(a1 + 0x4F80), &v20, x_4) != 0xFFFFFFFF )
  {
    sub_12618(*(_DWORD *)(a1 + 0x4F44));
    return v33;
  }
  *(_DWORD *)(a1 + 0x4F3C) = 1;
  return v33;
}

//----- (00013370) --------------------------------------------------------
unsigned int __fastcall sub_13370(int a1, int a2, int a3)
{
  int v4; // ebp
  int v5; // eax
  P_TargetObject v6; // esi
  char v7; // dl
  int v8; // edi
  int *v9; // ebx
  int v10; // eax
  P_Type21 v11; // eax
  int v12; // eax
  double v13; // st7
  double v14; // st7
  float v16; // [esp+8h] [ebp-6Ch] BYREF
  float v17; // [esp+Ch] [ebp-68h]
  float v18; // [esp+10h] [ebp-64h]
  T_Vector3D v19; // [esp+14h] [ebp-60h] BYREF
  T_Vector3D v20; // [esp+20h] [ebp-54h] BYREF
  float v21; // [esp+2Ch] [ebp-48h]
  float v22; // [esp+30h] [ebp-44h]
  float v23; // [esp+34h] [ebp-40h]
  float v24; // [esp+38h] [ebp-3Ch]
  float v25; // [esp+3Ch] [ebp-38h]
  float v26; // [esp+40h] [ebp-34h]
  int v27; // [esp+44h] [ebp-30h]
  T_Vector3D *v28; // [esp+48h] [ebp-2Ch]
  float *v29; // [esp+4Ch] [ebp-28h]
  float v30; // [esp+50h] [ebp-24h]
  P_Type21 v31; // [esp+54h] [ebp-20h]
  float v32; // [esp+58h] [ebp-1Ch]

  v4 = 0;
  v5 = *(_DWORD *)(a1 + 0xAB) + 0xAB;
  v21 = 0.0;
  v22 = 0.0;
  v23 = 0.0;
  v6.pPlanet = 0;
  v7 = *(_BYTE *)v5;
  v31 = 0;
  if ( v7 == 3 )
  {
    v8 = *(_DWORD *)(v5 + 1);
    if ( *(_BYTE *)(v8 + 0x67) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x27D);
    }
    v6.pPlanet = *(P_Planet *)(v8 + 0x68);
    v31 = sub_12AE4((P_Wnd04BM)a1, *(P_TargetObject *)(v5 + 1));
    v21 = *(float *)(v8 + 0x9E);
    v22 = *(float *)(v8 + 0xA2);
    v23 = *(float *)(v8 + 0xA6);
    v27 = 0x20 * V_Gizmos[0x34].special1;
    v30 = (float)(0x20 * V_Gizmos[0x34].special1);
  }
  else if ( v7 == 2 )
  {
    v9 = *(int **)(v5 + 1);
    v6.pPlanet = *(P_Planet *)((char *)v9 + 0x6F);
    v31 = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)v9);
    v21 = *(float *)v9;
    v22 = *((float *)v9 + 1);
    v23 = *((float *)v9 + 2);
    v30 = 3200.0;
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0x28E);
  }
  sub_12AE4((P_Wnd04BM)a1, v6);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v10 = *(_DWORD *)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F44) = v10 + 0x35;
    *(_BYTE *)(v10 + 0x35) = 8;
    *(_DWORD *)(*(_DWORD *)(a1 + 0x4F44) + 1) = v31;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = v21;
    *(float *)(a1 + 0x4F84) = v22;
    *(float *)(a1 + 0x4F88) = v23;
    v11 = sub_12AE4((P_Wnd04BM)a1, v6);
    *(_DWORD *)(a1 + 0x4F48) = v11;
    v11->Unknown_33 = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v6.pPlanet[1].z5 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v6.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v6.pPlanet[1].name[7];
    Q_StartSample_sub_4FB90(&V_SoundSystem, 1);
  }
  v12 = *(_DWORD *)(a1 + 0x4F3C);
  if ( !v12 )
  {
    if ( sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), 40.0) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 2u;
      memset(&v19, 0, sizeof(v19));
      v28 = &v20;
      v19.x = *(float *)(a1 + 0x4F8C) - v21;
      v19.y = *(float *)(a1 + 0x4F90) - v22;
      v19.z = *(float *)(a1 + 0x4F94) - v23;
      v20 = v19;
      v13 = sqrt(v19.y * v19.y + v19.x * v19.x + v19.z * v19.z);
      v14 = v13 - v30;
      v32 = v14;
      if ( v14 < 1280.0 )
      {
        v32 = 1280.0;
      }
      Q_Vector3D_SetLength_sub_53054(&v20, v32);
      v29 = &v16;
      v24 = v21 + v20.x;
      v16 = v24;
      v25 = v22 + v20.y;
      v17 = v25;
      v26 = v23 + v20.z;
      v18 = v26;
      *(float *)(a1 + 0x4F98) = v24;
      *(float *)(a1 + 0x4F9C) = v17;
      *(float *)(a1 + 0x4FA0) = v18;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
      return 0;
    }
    return v4;
  }
  if ( v12 != 1 )
  {
    return 0xFFFFFFFF;
  }
  if ( sub_12480((float *)(a1 + 0x4F8C), (float *)(a1 + 0x4F98), 4.0) == 0xFFFFFFFF )
  {
    *(_DWORD *)(a1 + 0x4F3C) = 2;
  }
  *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)(a1 + 0x4F8C);
  *(float *)(a1 + 0x4F84) = *(float *)(a1 + 0x4F90);
  *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)(a1 + 0x4F94);
  return 0;
}

//----- (000136C4) --------------------------------------------------------
unsigned int __fastcall sub_136C4(int a1)
{
  int v2; // edi
  int v3; // esi
  char v4; // ah
  int v5; // edi
  _DWORD *v6; // ebx
  P_TargetObject v7; // edi
  P_Type21 v8; // eax
  P_Type21 v9; // eax
  int v10; // ebx
  int v12; // [esp+0h] [ebp-24h]
  int v13; // [esp+4h] [ebp-20h]
  int v14; // [esp+8h] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  v4 = *(_BYTE *)(v2 + 0xAB);
  v5 = v2 + 0xAB;
  if ( v4 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x2D8);
  }
  v3 = 0;
  v6 = *(_DWORD **)(v5 + 1);
  v7.pPlanet = (P_Planet)v6[0x1A];
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v8 = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)v6);
    *(_DWORD *)(a1 + 0x4F44) = v8;
    v8->Unknown_33 = 0x14;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)((char *)v6 + 0x9E);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)((char *)v6 + 0xA2);
    *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)((char *)v6 + 0xA6);
    v9 = sub_12AE4((P_Wnd04BM)a1, v7);
    *(_DWORD *)(a1 + 0x4F48) = v9;
    v9->Unknown_33 = 0x14;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v7.pPlanet[1].z5 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v7.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v7.pPlanet[1].name[7];
  }
  v10 = *(_DWORD *)(a1 + 0x4F38);
  if ( v10 == 0x14 )
  {
    v12 = *(_DWORD *)(a1 + 0x4F8C);
    v13 = *(_DWORD *)(a1 + 0x4F90);
    v14 = *(_DWORD *)(a1 + 0x4F94);
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)(a1 + 0x4F80);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)(a1 + 0x4F84);
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)(a1 + 0x4F88);
    *(_DWORD *)(a1 + 0x4F80) = v12;
    *(_DWORD *)(a1 + 0x4F84) = v13;
    *(_DWORD *)(a1 + 0x4F88) = v14;
  }
  else if ( v10 == 0x29 )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (0001380C) --------------------------------------------------------
unsigned int __fastcall sub_1380C(int a1)
{
  int v2; // ecx
  int v3; // edi
  int v4; // eax
  P_TargetObject v5; // ebp
  int v6; // edx
  int v7; // eax
  int v8; // eax
  double v9; // st7
  int v10; // eax
  int v11; // edx
  int v12; // ebx
  _BYTE *v13; // eax
  int v15[3]; // [esp+0h] [ebp-30h] BYREF
  int v16; // [esp+Ch] [ebp-24h]
  int v17; // [esp+10h] [ebp-20h]
  char v18; // [esp+14h] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x30D);
  }
  v4 = *(_DWORD *)(v2 + 0xAC);
  v17 = v4;
  if ( *(_BYTE *)(v4 + 0x67) != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x312);
  }
  v3 = 0;
  v5.pPlanet = *(P_Planet *)(v4 + 0x68);
  v15[0] = *(_DWORD *)(v4 + 0x78);
  v15[1] = *(_DWORD *)(v4 + 0x7C);
  v15[2] = *(_DWORD *)(v4 + 0x80);
  v6 = *(_DWORD *)(a1 + 0x4F38);
  v18 = **(_BYTE **)(v4 + 0x63);
  if ( !v6 )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v7 = *(_DWORD *)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F44) = v7 + 0x35;
    *(_BYTE *)(v7 + 0x35) = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) = 0x12;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    v8 = v17 + 0x9E;
    *(float *)(a1 + 0x4F80) = *(float *)(v17 + 0x9E);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)(v8 + 4);
    v9 = *(float *)(v8 + 8);
    v10 = 4 * v18;
    *(float *)(a1 + 0x4F88) = v9;
    v16 = a1 + v10;
    sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F44), *(_WORD *)(a1 + v10 + 0x1A92), 0);
    v11 = v16;
    *(_DWORD *)(a1 + 0x4F48) = sub_12AE4((P_Wnd04BM)a1, v5);
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(v11 + 0x1BCE));
  }
  v12 = *(_DWORD *)(a1 + 0x4F3C);
  if ( v12 )
  {
    *(_DWORD *)(a1 + 0x4F3C) = v12 + 1;
    if ( v12 + 1 > 0x14 )
    {
      return 0xFFFFFFFF;
    }
  }
  else if ( sub_12480((float *)(a1 + 0x4F80), (float *)v15, 40.0) == 0xFFFFFFFF )
  {
    v13 = *(_BYTE **)(a1 + 0x4F44);
    *(_DWORD *)(a1 + 0x4F3C) = 1;
    *v13 = 0xFF;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 4u;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 4 * v18 + 0x1BD0));
  }
  return v3;
}

//----- (000139E0) --------------------------------------------------------
void __fastcall sub_139E0(P_Wnd04BM a1, int a2)
{
  switch ( a1->Unknown_4F37 )
  {
    case 4:
      sub_13A28(a1, a2);
      break;
    case 5:
      sub_13AD8(a1, a2);
      break;
    case 7:
    case 0xA:
    case 0xC:
    case 0xD:
    case 0xE:
      sub_15630(a1, a2);
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\batfx.cpp", 0x362);
      break;
  }
}

//----- (00013A28) --------------------------------------------------------
void __fastcall sub_13A28(P_Wnd04BM a1, int a2)
{
  double v3; // st7
  void *ShapeTable_sub_1B084; // eax
  LONG v5; // [esp-20h] [ebp-3Ch]
  LONG v6; // [esp-1Ch] [ebp-38h]
  LONG v7; // [esp-18h] [ebp-34h]
  LONG v8; // [esp-Ch] [ebp-28h]
  float v9; // [esp+8h] [ebp-14h]

  if ( *(_BYTE *)a2 != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfx.cpp", 0x36B);
  }
  if ( a1->Unknown_4F38[0] >= 0x14 )
  {
    v3 = (double)a1->Unknown_4F38[0] + -20.0;
  }
  else
  {
    v3 = 20.0 - (double)a1->Unknown_4F38[0];
  }
  v9 = v3 * 0.05;
  v8 = (int)((double)*(int *)(a2 + 0xF) * v9);
  v7 = *(__int16 *)(a2 + 0x29);
  v6 = *(__int16 *)(a2 + 0x27);
  v5 = *(_DWORD *)(a2 + 7);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a2 + 5));
  VFX_shape_transform(&a1->a.a1.pane, ShapeTable_sub_1B084, v5, v6, v7, V_BigBuffer, 0, v8, v8, 0);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00013AD8) --------------------------------------------------------
void __fastcall sub_13AD8(P_Wnd04BM a1, int a2)
{
  void *ShapeTable_sub_1B084; // eax
  LONG v4; // [esp-20h] [ebp-44h]
  LONG v5; // [esp-1Ch] [ebp-40h]
  LONG v6; // [esp-18h] [ebp-3Ch]
  LONG v7; // [esp-8h] [ebp-2Ch]
  LONG width; // [esp+10h] [ebp-14h]
  int widtha; // [esp+10h] [ebp-14h]

  width = a1->Unknown_4F38[1];
  if ( width > 0xA )
  {
    width = 0x14 - width;
    sub_1826C(a1, a2, a1->gvShape[0x20].shape2, 2u);
  }
  v7 = *(_DWORD *)(a2 + 0xF);
  v6 = *(__int16 *)(a2 + 0x29);
  v5 = *(__int16 *)(a2 + 0x27);
  v4 = *(_DWORD *)(a2 + 7);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a2 + 5));
  VFX_shape_transform(&a1->a.a1.pane, ShapeTable_sub_1B084, v4, v5, v6, V_BigBuffer, 0, v7, v7, 0);
  widtha = (int)((double)*(unsigned int *)(a2 + 0xF)
               * 0.0000152587890625
               * (double)((*(__int16 *)(a2 + 0x17) - *(__int16 *)(a2 + 0x13)) * width)
               * 0.050000001);
  VFX_ellipse_fill(&a1->a.a1.pane, *(__int16 *)(a2 + 0x27), *(__int16 *)(a2 + 0x29), widtha, widtha, 0x96);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00013BC0) --------------------------------------------------------
void __fastcall __spoils<> Q_Vector3DCopy_sub_13BC0(P_Vector3D dst, P_Vector3D src)
{
  *dst = *src;
}

//----- (00013BF0) --------------------------------------------------------
void __fastcall __spoils<> Q_Vector3DCtor_sub_13BF0(P_Vector3D a1)
{
  a1->x = 0.0;
  a1->y = 0.0;
  a1->z = 0.0;
}

//----- (00013C10) --------------------------------------------------------
unsigned int __fastcall sub_13C10(P_Wnd04BM pWnd04BM)
{
  P_Wnd19BC pWnd19BC; // ecx
  P_Ship pShip_1; // ecx
  P_Ship v4; // ebp
  UBYTE gizmoIndex; // al
  char gizmoIndex__; // bl
  int shipsNum; // edi
  P_Type21 v8; // eax
  int i; // kr04_4
  P_Ship pShip; // edx
  P_Type21 v11; // eax
  float *p_totalWeaponDamage; // ecx
  T_Vector3D *v13; // edx
  double v14; // st7
  int v15; // eax
  T_Vector3D *p_position; // edx
  int v17; // ebp
  char *Unknown_4F44; // eax
  int v20; // eax
  double special1; // st7
  double v22; // st7
  T_Vector3D *v23; // edi
  int v24; // kr14_4
  int v25; // edx
  int v26; // edx
  double v27; // st7
  double v28; // st7
  char *v29; // edx
  int j; // kr10_4
  P_Ship ships[107]; // [esp+8h] [ebp-238h] BYREF
  T_Vector3D v32; // [esp+1B4h] [ebp-8Ch] BYREF
  float v33; // [esp+1C0h] [ebp-80h]
  float v34; // [esp+1C4h] [ebp-7Ch]
  float v35; // [esp+1C8h] [ebp-78h]
  T_Vector3D v36; // [esp+1CCh] [ebp-74h] BYREF
  float v37; // [esp+1D8h] [ebp-68h] BYREF
  float v38; // [esp+1DCh] [ebp-64h]
  float v39; // [esp+1E0h] [ebp-60h]
  float x; // [esp+1E4h] [ebp-5Ch]
  float y; // [esp+1E8h] [ebp-58h]
  float z; // [esp+1ECh] [ebp-54h]
  T_Vector3D *v43; // [esp+1F0h] [ebp-50h]
  int v44; // [esp+1F4h] [ebp-4Ch]
  float v45; // [esp+1F8h] [ebp-48h]
  float *v46; // [esp+1FCh] [ebp-44h]
  int v47; // [esp+200h] [ebp-40h]
  float v48; // [esp+204h] [ebp-3Ch]
  int v49; // [esp+208h] [ebp-38h]
  T_Vector3D *vectors3; // [esp+20Ch] [ebp-34h]
  int v51; // [esp+210h] [ebp-30h]
  float v52; // [esp+214h] [ebp-2Ch]
  float v53; // [esp+218h] [ebp-28h]
  float v54; // [esp+21Ch] [ebp-24h]
  int v55; // [esp+220h] [ebp-20h]
  char gizmoIndex_; // [esp+224h] [ebp-1Ch]

  pWnd19BC = pWnd04BM->pWnd19BC;
  if ( pWnd19BC->target.type != ASCEND_TARGET_TYPE_3_LANE )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x31);
  }
  v47 = 0;
  pShip_1 = *(P_Ship *)((char *)&pWnd19BC->a2.a1.magic12345678 + 1);
  v4 = 0;
  gizmoIndex = pShip_1->pCurHullCell->gizmoIndex;
  v49 = 1;
  gizmoIndex_ = gizmoIndex;
  if ( gizmoIndex == ASCEND_GIZMO_74_MASS_CONDENSOR )
  {
    if ( pShip_1->_target.type )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x3A);
    }
    v4 = pShip_1->_target.pObject.pShip;
    v49 = 2;
  }
  if ( !pWnd04BM->Unknown_4F38[0] )
  {
    gizmoIndex__ = gizmoIndex_;
    shipsNum = Q_FindShipsAtLocation_sub_1D794(pShip_1->pLocation, ships);
    pWnd04BM->Unknown_5034 = 1;
    if ( gizmoIndex__ == ASCEND_GIZMO_74_MASS_CONDENSOR )
    {
      pWnd04BM->Unknown_5034 = 2;
      pWnd04BM->Unknown_4F44 = sub_12AE4(pWnd04BM, (P_TargetObject)v4);
      v8 = pWnd04BM->_t21 + 1;
      pWnd04BM->Unknown_4F48 = (int)v8;
      v8->target.type = 7;
      *(_BYTE *)(pWnd04BM->Unknown_4F48 + 0x33) = 0x12;
      *(_BYTE *)(pWnd04BM->Unknown_4F48 + 0x34) = 1;
      pWnd04BM->vectors3[1] = pShip_1->position;
      sub_1826C(pWnd04BM, pWnd04BM->Unknown_4F48, pWnd04BM->gvShape[gizmoIndex_].shape1, 0);
      if ( shipsNum <= 0 )
      {
        goto LABEL_18;
      }
    }
    else
    {
      pWnd04BM->Unknown_4F44 = sub_12AE4(pWnd04BM, (P_TargetObject)pShip_1->pLocation.pPlanet);
      if ( shipsNum <= 0 )
      {
LABEL_18:
        v15 = gizmoIndex_;
        pWnd04BM->Unknown_4F38[1] = 0;
        Q_StartSample_sub_4FB90(&V_SoundSystem, pWnd04BM->gvSfx[v15].sfx1);
        goto LABEL_19;
      }
    }
    vectors3 = pWnd04BM->vectors3;
    v51 = 4 * shipsNum;
    for ( i = 0; i < shipsNum; ++i )
    {
      if ( pWnd04BM->Unknown_5034 >= 0xF )
      {
        break;
      }
      pShip = ships[i];
      if ( pShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM && pShip != v4 )
      {
        v11 = sub_12AE4(pWnd04BM, (P_TargetObject)pShip);
        v11->Unknown_33 |= 0x12u;
        v11->Unknown_34 = pWnd04BM->Unknown_5034;
        p_totalWeaponDamage = (float *)&ships[i]->totalWeaponDamage;
        v13 = &pWnd04BM->vectors3[v11->Unknown_34];
        v14 = *(float *)((char *)p_totalWeaponDamage + 0x9E);
        p_totalWeaponDamage = (float *)((char *)p_totalWeaponDamage + 0x9E);
        v13->x = v14;
        v13->y = p_totalWeaponDamage[1];
        v13->z = p_totalWeaponDamage[2];
        LOWORD(v13) = pWnd04BM->Unknown_5034;
        pWnd04BM->Unknown_5034 = (_WORD)v13 + 1;
        pWnd04BM->Unknown_4F38[(__int16)v13 + 3] = (int)v11;
      }
    }
    goto LABEL_18;
  }
LABEL_19:
  p_position = &v4->position;
  v17 = pWnd04BM->Unknown_4F38[1];
  if ( v17 )
  {
    if ( v17 == 1 )
    {
      *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) = *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) + 0.039999999;
      Unknown_4F44 = (char *)pWnd04BM->Unknown_4F44;
      dword_9A234 = 0;
      if ( *(float *)(Unknown_4F44 + 0xB) >= 2.0 )
      {
        pWnd04BM->Unknown_4F38[1] = 2;
        return v47;
      }
    }
    else if ( v17 == 2 )
    {
      x = 0.0;
      y = 0.0;
      z = 0.0;
      if ( gizmoIndex_ == 0x4A )
      {
        x = p_position->x;
        y = p_position->y;
        z = p_position->z;
      }
      v20 = gizmoIndex_;
      special1 = (double)V_Gizmos[v20].special1;
      v55 = 0x20 * V_Gizmos[v20].special2;
      v48 = special1;
      v45 = (float)v55;
      v22 = v48 - *(float *)&dword_9A234;
      v52 = v22;
      if ( v22 > 0.2 )
      {
        v52 = 0.2;
      }
      v23 = pWnd04BM->vectors3;
      v44 = 0xFFFFFFFF;
      v24 = v49;
      *(float *)&dword_9A234 = *(float *)&dword_9A234 + v52;
      for ( j = 0; v24 + j < pWnd04BM->Unknown_5034; ++j )
      {
        v26 = *(char *)(pWnd04BM->Unknown_4F38[v49 + 3 + j] + 0x34);
        v43 = &v36;
        memset(&v32, 0, sizeof(v32));
        v32.x = v23[v26].x - x;
        v32.y = v23[v26].y - y;
        v32.z = v23[v26].z - z;
        v36 = v32;
        v27 = sqrt(v32.y * v32.y + v32.x * v32.x + v32.z * v32.z);
        v53 = v27;
        if ( v27 > v45 )
        {
          v28 = v53 - v52 * 32.0;
          v54 = v28;
          if ( v28 >= v45 )
          {
            v44 = 0;
          }
          else
          {
            v54 = v45;
          }
          v25 = v26;
          Q_Vector3D_SetLength_sub_53054(&v36, v54);
          v46 = &v37;
          v33 = x + v36.x;
          v37 = v33;
          v34 = y + v36.y;
          v38 = v34;
          v35 = z + v36.z;
          v39 = v35;
          v23[v25].x = v33;
          v23[v25].y = v38;
          v23[v25].z = v39;
        }
      }
      if ( *(float *)&dword_9A234 >= (double)v48 || v44 == 0xFFFFFFFF )
      {
        pWnd04BM->Unknown_4F38[1] = 3;
        return v47;
      }
    }
    else
    {
      *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) = *(float *)((char *)pWnd04BM->Unknown_4F44 + 0xB) + -0.039999999;
      v29 = (char *)pWnd04BM->Unknown_4F44;
      if ( *(float *)(v29 + 0xB) <= 1.0 )
      {
        *(_DWORD *)(v29 + 0xB) = 0x3F800000;
        return 0xFFFFFFFF;
      }
    }
  }
  else
  {
    if ( gizmoIndex_ == 0x4A )
    {
      if ( sub_12480(&pWnd04BM->vectors3[1].x, &p_position->x, 10.0) != 0xFFFFFFFF )
      {
        sub_12618(pWnd04BM->Unknown_4F48);
        return v47;
      }
      *(_BYTE *)(pWnd04BM->Unknown_4F48 + 0x33) |= 8u;
    }
    pWnd04BM->Unknown_4F38[1] = 1;
  }
  return v47;
}
// 9A234: using guessed type int dword_9A234;

//----- (00014224) --------------------------------------------------------
unsigned int __fastcall sub_14224(T_Wnd04BM *a1)
{
  P_Wnd19BC pWnd19BC; // edi
  int v3; // esi
  BYTE type; // ah
  T_Target *p_target; // edi
  P_TargetObject v6; // edx
  char v7; // bl
  P_Type21 v8; // eax
  int v9; // eax

  pWnd19BC = a1->pWnd19BC;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0xCC);
  }
  v3 = 0;
  v6.pPlanet = (P_Planet)p_target->pObject;
  v7 = **(_BYTE **)((char *)&v6.pPlanet->Unknown_62 + 1);
  if ( !a1->Unknown_4F38[0] )
  {
    a1->Unknown_5034 = 1;
    v8 = sub_12AE4(a1, v6);
    a1->Unknown_4F44 = v8;
    v8->Unknown_33 |= 4u;
    a1->Unknown_4F38[1] = 0;
    a1->Unknown_4F38[2] = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, a1->gvSfx[v7].sfx1);
  }
  v9 = a1->Unknown_4F38[0];
  a1->Unknown_4F38[2] += v9 & 1;
  if ( v9 == 0x24 )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (000142D8) --------------------------------------------------------
int __fastcall sub_142D8(int a1)
{
  int v2; // esi
  char v3; // ah
  int v4; // esi
  P_TargetObject v5; // ebx
  int v6; // edx
  P_Type21 v7; // eax
  double v8; // st7
  int v9; // edx
  double v10; // st7
  double v11; // st6
  float v13; // [esp+8h] [ebp-40h] BYREF
  float v14; // [esp+Ch] [ebp-3Ch]
  float v15; // [esp+10h] [ebp-38h]
  float v16; // [esp+14h] [ebp-34h]
  float v17; // [esp+18h] [ebp-30h]
  float v18; // [esp+1Ch] [ebp-2Ch]
  float *v19; // [esp+20h] [ebp-28h]
  float v20; // [esp+24h] [ebp-24h]
  float v21; // [esp+28h] [ebp-20h]
  float v22; // [esp+2Ch] [ebp-1Ch]
  char v23; // [esp+30h] [ebp-18h]

  v2 = *(_DWORD *)(a1 + 0xAB);
  v3 = *(_BYTE *)(v2 + 0xAB);
  v4 = v2 + 0xAB;
  if ( v3 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0xF5);
  }
  v5.pPlanet = *(P_Planet *)(v4 + 1);
  v6 = *(_DWORD *)(a1 + 0x4F38);
  v23 = **(_BYTE **)((char *)&v5.pPlanet->Unknown_62 + 1);
  if ( !v6 )
  {
    *(_WORD *)(a1 + 0x5034) = 1;
    v7 = sub_12AE4((P_Wnd04BM)a1, v5);
    *(_DWORD *)(a1 + 0x4F44) = v7;
    v7->Unknown_33 |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = *(float *)((char *)&v5.pPlanet[1].z5 + 1);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)&v5.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)&v5.pPlanet[1].name[7];
    v16 = 0.0;
    v17 = 0.0;
    v18 = 0.0;
    v19 = &v13;
    v16 = -*(float *)((char *)&v5.pPlanet[1].z5 + 1);
    v17 = -*(float *)&v5.pPlanet[1].name[3];
    v8 = -*(float *)&v5.pPlanet[1].name[7];
    v13 = v16;
    v18 = v8;
    v14 = v17;
    v15 = v18;
    *(float *)(a1 + 0x4F8C) = v16;
    *(float *)(a1 + 0x4F90) = v14;
    *(float *)(a1 + 0x4F94) = v15;
    v9 = v23;
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 4 * v9 + 0x1BCE));
  }
  v10 = *(float *)(a1 + 0x4F90) * *(float *)(a1 + 0x4F90) + *(float *)(a1 + 0x4F8C) * *(float *)(a1 + 0x4F8C);
  v11 = *(float *)(a1 + 0x4F94) * *(float *)(a1 + 0x4F94);
  v22 = 0.0;
  v21 = sqrt(v10 + v11);
  v20 = sqrt(
          *(float *)(a1 + 0x4F84) * *(float *)(a1 + 0x4F84)
        + *(float *)(a1 + 0x4F80) * *(float *)(a1 + 0x4F80)
        + *(float *)(a1 + 0x4F88) * *(float *)(a1 + 0x4F88));
  if ( v21 > 1.0 )
  {
    v22 = (v21 - v20) * 96.0 / v21;
  }
  if ( v22 < 3.2 )
  {
    v22 = 3.2;
  }
  return sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), v22);
}

//----- (00014490) --------------------------------------------------------
int __fastcall sub_14490(int a1)
{
  int v2; // esi
  char v3; // ah
  int v4; // esi
  P_TargetObject v5; // esi
  _DWORD *v6; // ebx
  P_Type21 v7; // eax
  float v9; // [esp+0h] [ebp-1Ch]
  char v10; // [esp+4h] [ebp-18h]

  v2 = *(_DWORD *)(a1 + 0xAB);
  v3 = *(_BYTE *)(v2 + 0xAB);
  v4 = v2 + 0xAB;
  if ( v3 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x127);
  }
  v5.pPlanet = *(P_Planet *)(v4 + 1);
  if ( LOBYTE(v5.pPlanet->dayColonized) != 2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x12B);
  }
  v6 = *(_DWORD **)((char *)&v5.pPlanet->dayColonized + 1);
  v10 = **(_BYTE **)((char *)&v5.pPlanet->Unknown_62 + 1);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 1;
    v7 = sub_12AE4((P_Wnd04BM)a1, v5);
    *(_DWORD *)(a1 + 0x4F44) = v7;
    v7->Unknown_33 |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)((char *)&v5.pPlanet[1].z5 + 1);
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)&v5.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F88) = *(_DWORD *)&v5.pPlanet[1].name[7];
    *(_DWORD *)(a1 + 0x4F8C) = v6[5];
    *(_DWORD *)(a1 + 0x4F90) = v6[6];
    *(_DWORD *)(a1 + 0x4F94) = v6[7];
    if ( *(_DWORD *)&v5.pPlanet->byte59 == *v6 )
    {
      *(_DWORD *)(a1 + 0x4F8C) = v6[2];
      *(_DWORD *)(a1 + 0x4F90) = v6[3];
      *(_DWORD *)(a1 + 0x4F94) = v6[4];
    }
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 4 * v10 + 0x1BCE));
  }
  v9 = (double)*(int *)(a1 + 0x4F38) * 3.2;
  return sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), v9);
}

//----- (000145C0) --------------------------------------------------------
unsigned int __fastcall sub_145C0(int a1)
{
  int v2; // ecx
  P_TargetObject v3; // ecx
  P_TargetObject v4; // edi
  char v5; // bl
  P_Type21 v6; // eax
  _BYTE *v7; // eax
  P_Type21 v8; // eax
  int v9; // eax
  int v10; // edi
  int v12; // ebx
  int v13; // [esp+0h] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x158);
  }
  v3.pPlanet = *(P_Planet *)(v2 + 1);
  if ( LOBYTE(v3.pPlanet->dayColonized) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x15C);
  }
  v13 = 0;
  v4.pPlanet = *(P_Planet *)((char *)&v3.pPlanet->dayColonized + 1);
  v5 = **(_BYTE **)((char *)&v3.pPlanet->Unknown_62 + 1);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 3;
    v6 = sub_12AE4((P_Wnd04BM)a1, v3);
    *(_DWORD *)(a1 + 0x4F44) = v6;
    v6->Unknown_33 |= 4u;
    v7 = (_BYTE *)(*(_DWORD *)(a1 + 0x1D2A) + 0x35);
    *(_DWORD *)(a1 + 0x4F48) = v7;
    *v7 = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) = 0x1A;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v3.pPlanet[1].z5 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v3.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v3.pPlanet[1].name[7];
    sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F48), *(_WORD *)(a1 + 4 * v5 + 0x1A92), 0);
    v8 = sub_12AE4((P_Wnd04BM)a1, v4);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F40) = 0;
    *(_DWORD *)(a1 + 0x4F4C) = v8;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 4 * v5 + 0x1BCE));
  }
  v9 = *(_DWORD *)(a1 + 0x4F3C);
  if ( !v9 )
  {
    v10 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
    *(_DWORD *)(a1 + 0x4F40) = v10;
    if ( v10 == 0x12 )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) &= ~4u;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) &= ~8u;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
      *(_DWORD *)(a1 + 0x4F40) = 0;
    }
    return v13;
  }
  if ( v9 != 1 )
  {
    v12 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
    *(_DWORD *)(a1 + 0x4F40) = v12;
    if ( v12 == 0x12 )
    {
      return 0xFFFFFFFF;
    }
    return v13;
  }
  if ( sub_12480((float *)(a1 + 0x4F8C), (float *)((char *)&v4.pPlanet[1].z5 + 1), 20.0) == 0xFFFFFFFF )
  {
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 8u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F4C) + 0x33) |= 4u;
    *(_DWORD *)(a1 + 0x4F3C) = 2;
  }
  else
  {
    sub_12618(*(_DWORD *)(a1 + 0x4F48));
  }
  return 0;
}

//----- (000147CC) --------------------------------------------------------
unsigned int __fastcall sub_147CC(int a1)
{
  int v2; // edi
  char v3; // ah
  int v4; // edi
  int v5; // ecx
  int v6; // edx
  P_TargetObject v7; // ebp
  int v8; // eax
  P_Type21 v9; // eax
  double v10; // st7
  double v11; // st7
  int v12; // edx
  float *v13; // edx
  double v14; // st7
  float v16; // [esp+4h] [ebp-84h]
  int v17[3]; // [esp+8h] [ebp-80h] BYREF
  float v18; // [esp+14h] [ebp-74h] BYREF
  float v19; // [esp+18h] [ebp-70h]
  float v20; // [esp+1Ch] [ebp-6Ch]
  float v21; // [esp+20h] [ebp-68h] BYREF
  float v22; // [esp+24h] [ebp-64h]
  float v23; // [esp+28h] [ebp-60h]
  float v24; // [esp+2Ch] [ebp-5Ch]
  float v25; // [esp+30h] [ebp-58h]
  float v26; // [esp+34h] [ebp-54h]
  float v27; // [esp+38h] [ebp-50h]
  float v28; // [esp+3Ch] [ebp-4Ch]
  float v29; // [esp+40h] [ebp-48h]
  float v30; // [esp+44h] [ebp-44h]
  float v31; // [esp+48h] [ebp-40h]
  float v32; // [esp+4Ch] [ebp-3Ch]
  float *v33; // [esp+50h] [ebp-38h]
  int *v34; // [esp+54h] [ebp-34h]
  T_Gizmo *v35; // [esp+58h] [ebp-30h]
  int v36; // [esp+5Ch] [ebp-2Ch]
  int v37; // [esp+60h] [ebp-28h]
  float v38; // [esp+64h] [ebp-24h]
  float *v39; // [esp+68h] [ebp-20h]
  int v40; // [esp+6Ch] [ebp-1Ch]

  v2 = *(_DWORD *)(a1 + 0xAB);
  v3 = *(_BYTE *)(v2 + 0xAB);
  v4 = v2 + 0xAB;
  if ( v3 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x1AC);
  }
  v5 = *(_DWORD *)(v4 + 1);
  if ( *(_BYTE *)(v5 + 0x67) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x1B0);
  }
  v37 = 0;
  v6 = **(char **)(v5 + 0x63);
  v35 = &V_Gizmos[v6];
  v7.pPlanet = *(P_Planet *)(v5 + 0x68);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    v8 = *(_DWORD *)(a1 + 0x1D2A);
    *(_WORD *)(a1 + 0x5034) = 2;
    *(_DWORD *)(a1 + 0x4F44) = v8 + 0x35;
    *(_BYTE *)(v8 + 0x35) = 7;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(float *)(a1 + 0x4F80) = *(float *)(v5 + 0x9E);
    *(float *)(a1 + 0x4F84) = *(float *)(v5 + 0xA2);
    *(float *)(a1 + 0x4F88) = *(float *)(v5 + 0xA6);
    v36 = a1 + 4 * v6;
    sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F44), *(_WORD *)(v36 + 0x1A92), 0);
    v9 = sub_12AE4((P_Wnd04BM)a1, v7);
    *(_DWORD *)(a1 + 0x4F48) = v9;
    v9->Unknown_33 |= 0x12u;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
    *(float *)(a1 + 0x4F8C) = *(float *)((char *)&v7.pPlanet[1].z5 + 1);
    *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v7.pPlanet[1].name[3];
    *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v7.pPlanet[1].name[7];
    v39 = &v18;
    v30 = 0.0;
    v31 = 0.0;
    v32 = 0.0;
    v30 = *(float *)(a1 + 0x4F8C) - *(float *)(a1 + 0x4F80);
    v31 = *(float *)(a1 + 0x4F90) - *(float *)(a1 + 0x4F84);
    v10 = *(float *)(a1 + 0x4F94) - *(float *)(a1 + 0x4F88);
    v18 = v30;
    v32 = v10;
    v19 = v31;
    v20 = v32;
    *(float *)(a1 + 0x4F98) = v30;
    *(float *)(a1 + 0x4F9C) = v19;
    *(float *)(a1 + 0x4FA0) = v20;
    v40 = 0x20 * v35->special1;
    v16 = (float)v40;
    Q_Vector3D_SetLength_sub_53054((P_Vector3D)(a1 + 0x4F98), v16);
    v24 = 0.0;
    v25 = 0.0;
    v26 = 0.0;
    v33 = &v21;
    v24 = *(float *)(a1 + 0x4F8C) + *(float *)(a1 + 0x4F98);
    v25 = *(float *)(a1 + 0x4F90) + *(float *)(a1 + 0x4F9C);
    v11 = *(float *)(a1 + 0x4F94) + *(float *)(a1 + 0x4FA0);
    v21 = v24;
    v26 = v11;
    v22 = v25;
    v23 = v26;
    *(float *)(a1 + 0x4F98) = v24;
    *(float *)(a1 + 0x4F9C) = v22;
    *(float *)(a1 + 0x4FA0) = v23;
    v12 = v36;
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(v12 + 0x1BCE));
  }
  v13 = (float *)(a1 + 0x4F8C);
  if ( *(_DWORD *)(a1 + 0x4F3C) )
  {
    v34 = v17;
    v27 = 0.0;
    v28 = 0.0;
    v29 = 0.0;
    v27 = *(float *)(a1 + 0x4F98) - *v13;
    v28 = *(float *)(a1 + 0x4F9C) - *(float *)(a1 + 0x4F90);
    v29 = *(float *)(a1 + 0x4FA0) - *(float *)(a1 + 0x4F94);
    *(float *)v17 = v27;
    *(float *)&v17[1] = v28;
    *(float *)&v17[2] = v29;
    v14 = sqrt(v28 * v28 + v27 * v27 + v29 * v29) * 0.050000001;
    v38 = v14;
    if ( v14 >= 3.2 )
    {
      if ( v38 > 50.0 )
      {
        v38 = 50.0;
      }
    }
    else
    {
      v38 = 3.2;
    }
    if ( sub_12480((float *)(a1 + 0x4F8C), (float *)(a1 + 0x4F98), v38) == 0xFFFFFFFF )
    {
      return 0xFFFFFFFF;
    }
  }
  else
  {
    sub_12618(*(_DWORD *)(a1 + 0x4F44));
    if ( sub_12480((float *)(a1 + 0x4F80), v13, 50.0) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 8u;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
    }
  }
  return v37;
}

//----- (00014B18) --------------------------------------------------------
unsigned int __fastcall sub_14B18(int a1, int a2, int a3)
{
  int v4; // ecx
  P_TargetObject v5; // ecx
  P_TargetObject v6; // ebp
  int ShipsAtLocation_sub_1D794; // edi
  _BYTE *v8; // eax
  char v9; // bl
  int i; // kr04_4
  _BYTE *v11; // edx
  P_Type21 v12; // eax
  float *v13; // ecx
  float *v14; // edx
  double v15; // st7
  char v16; // bh
  int v17; // eax
  float *v18; // edx
  int v19; // ebp
  int v20; // eax
  int v22; // edi
  int v23; // edx
  int v24; // edx
  double v25; // st7
  int v26; // ecx
  int j; // kr10_4
  float v28; // [esp+4h] [ebp-228h]
  void *v29[107]; // [esp+8h] [ebp-224h] BYREF
  T_Vector3D v30; // [esp+1B4h] [ebp-78h] BYREF
  float v31; // [esp+1C0h] [ebp-6Ch]
  float v32; // [esp+1C4h] [ebp-68h]
  float v33; // [esp+1C8h] [ebp-64h]
  T_Vector3D v34; // [esp+1CCh] [ebp-60h] BYREF
  float v35; // [esp+1D8h] [ebp-54h] BYREF
  float v36; // [esp+1DCh] [ebp-50h]
  float v37; // [esp+1E0h] [ebp-4Ch]
  float v38; // [esp+1E4h] [ebp-48h]
  float v39; // [esp+1E8h] [ebp-44h]
  float v40; // [esp+1ECh] [ebp-40h]
  int v41; // [esp+1F0h] [ebp-3Ch]
  T_Vector3D *v42; // [esp+1F4h] [ebp-38h]
  float special1; // [esp+1F8h] [ebp-34h]
  float *v44; // [esp+1FCh] [ebp-30h]
  int v45; // [esp+200h] [ebp-2Ch]
  int v46; // [esp+204h] [ebp-28h]
  int v47; // [esp+208h] [ebp-24h]
  float v48; // [esp+20Ch] [ebp-20h]
  char v49; // [esp+210h] [ebp-1Ch]

  v4 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v4 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x1F9);
  }
  v45 = 0;
  v5.pPlanet = *(P_Planet *)(v4 + 1);
  v6.pPlanet = v5.pPlanet;
  v49 = **(_BYTE **)((char *)&v5.pPlanet->Unknown_62 + 1);
  if ( v49 == 0x28 )
  {
    if ( LOBYTE(v5.pPlanet->dayColonized) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x201);
    }
    v6.pPlanet = *(P_Planet *)((char *)&v5.pPlanet->dayColonized + 1);
  }
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(*(P_Location *)&v5.pPlanet->byte59, (P_Ship *)v29);
    *(_WORD *)(a1 + 0x5034) = 2;
    *(_DWORD *)(a1 + 0x4F44) = sub_12AE4((P_Wnd04BM)a1, v6);
    v8 = (_BYTE *)(*(_DWORD *)(a1 + 0x1D2A) + 0x35);
    *(_DWORD *)(a1 + 0x4F48) = v8;
    v9 = v49;
    *v8 = 0xFF;
    if ( v9 == 0x28 )
    {
      **(_BYTE **)(a1 + 0x4F48) = 7;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) = 0x12;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
      *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)((char *)&v5.pPlanet[1].z5 + 1);
      *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v5.pPlanet[1].name[3];
      *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v5.pPlanet[1].name[7];
      sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F48), *(_WORD *)(a1 + 4 * v49 + 0x1A92), 0);
    }
    if ( ShipsAtLocation_sub_1D794 > 0 )
    {
      v41 = a1 + 0x4F80;
      v47 = 4 * ShipsAtLocation_sub_1D794;
      for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
      {
        if ( *(__int16 *)(a1 + 0x5034) >= 0xF )
        {
          break;
        }
        v11 = v29[i];
        if ( v11[0x58] == 4 && v11 != (_BYTE *)v6.pPlanet )
        {
          v12 = sub_12AE4((P_Wnd04BM)a1, (P_TargetObject)v11);
          v12->Unknown_33 |= 0x12u;
          v12->Unknown_34 = *(_BYTE *)(a1 + 0x5034);
          v13 = (float *)v29[i];
          v14 = (float *)(a1 + 0x4F80 + 0xC * v12->Unknown_34);
          v15 = *(float *)((char *)v13 + 0x9E);
          v13 = (float *)((char *)v13 + 0x9E);
          *v14 = v15;
          v14[1] = v13[1];
          v14[2] = v13[2];
          LOWORD(v14) = *(_WORD *)(a1 + 0x5034);
          *(_WORD *)(a1 + 0x5034) = (_WORD)v14 + 1;
          *(_DWORD *)(a1 + 4 * (__int16)v14 + 0x4F44) = v12;
        }
      }
    }
    v16 = v49;
    *(_DWORD *)(a1 + 0x4F3C) = 1;
    if ( v16 == 0x28 )
    {
      *(_DWORD *)(a1 + 0x4F3C) = 0;
    }
    v17 = v49;
    *(_DWORD *)(a1 + 0x4F40) = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 4 * v17 + 0x1BCE));
    dword_9A238 = 0;
  }
  v18 = (float *)((char *)&v6.pPlanet[1].z5 + 1);
  v19 = *(_DWORD *)(a1 + 0x4F3C);
  if ( v19 )
  {
    if ( v19 == 1 )
    {
      v20 = *(_DWORD *)(a1 + 0x4F44);
      *(_DWORD *)(a1 + 0x4F40) += *(_DWORD *)(a1 + 0x4F38) & 1;
      *(_BYTE *)(v20 + 0x33) |= 4u;
      if ( *(_DWORD *)(a1 + 0x4F40) == 9 )
      {
        *(_DWORD *)(a1 + 0x4F3C) = 2;
        return v45;
      }
    }
    else if ( v19 == 2 )
    {
      v38 = *v18;
      v39 = v18[1];
      v40 = v18[2];
      v22 = a1 + 0x4F80;
      special1 = (float)V_Gizmos[v49].special1;
      v46 = 0xFFFFFFFF;
      *(float *)&dword_9A238 = *(float *)&dword_9A238 + 0.2;
      for ( j = 0; j + 2 < *(__int16 *)(a1 + 0x5034); ++j )
      {
        v24 = *(char *)(*(_DWORD *)(a1 + 8 + 4 * j + 0x4F44) + 0x34);
        v42 = &v34;
        memset(&v30, 0, sizeof(v30));
        v30.x = *(float *)(v22 + 0xC * v24) - v38;
        v30.y = *(float *)(v22 + 0xC * v24 + 4) - v39;
        v30.z = *(float *)(v22 + 0xC * v24 + 8) - v40;
        v34 = v30;
        v25 = sqrt(v30.y * v30.y + v30.x * v30.x + v30.z * v30.z) * 0.03125 + 0.2;
        v48 = v25;
        if ( v25 < special1 )
        {
          v46 = 0;
        }
        else
        {
          v48 = special1;
        }
        v23 = 0xC * v24;
        v28 = v48 * 32.0;
        Q_Vector3D_SetLength_sub_53054(&v34, v28);
        v44 = &v35;
        v31 = v38 + v34.x;
        v35 = v31;
        v32 = v39 + v34.y;
        v36 = v32;
        v33 = v40 + v34.z;
        v37 = v33;
        *(float *)(v23 + v22) = v31;
        *(float *)(v23 + v22 + 4) = v36;
        *(float *)(v23 + v22 + 8) = v37;
      }
      if ( *(float *)&dword_9A238 >= (double)special1 || v46 == 0xFFFFFFFF )
      {
        *(_DWORD *)(a1 + 0x4F3C) = 3;
        return v45;
      }
    }
    else
    {
      v26 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
      *(_DWORD *)(a1 + 0x4F40) = v26;
      if ( v26 == 0x12 )
      {
        return 0xFFFFFFFF;
      }
    }
  }
  else
  {
    sub_12618(*(_DWORD *)(a1 + 0x4F48));
    if ( sub_12480((float *)(a1 + 0x4F8C), v18, 10.0) == 0xFFFFFFFF )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 8u;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
    }
  }
  return v45;
}
// 9A238: using guessed type int dword_9A238;
// 14B18: using guessed type P_Ship var_224[107];

//----- (00015078) --------------------------------------------------------
unsigned int __fastcall sub_15078(T_Wnd04BM *a1)
{
  P_Wnd19BC pWnd19BC; // edi
  int v3; // esi
  BYTE type; // ah
  T_Target *p_target; // edi
  P_TargetObject v6; // edx
  char v7; // bl
  P_Type21 v8; // eax

  pWnd19BC = a1->pWnd19BC;
  type = pWnd19BC->target.type;
  p_target = &pWnd19BC->target;
  if ( type != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x283);
  }
  v3 = 0;
  v6.pPlanet = (P_Planet)p_target->pObject;
  v7 = **(_BYTE **)((char *)&v6.pPlanet->Unknown_62 + 1);
  if ( !a1->Unknown_4F38[0] )
  {
    a1->Unknown_5034 = 1;
    v8 = sub_12AE4(a1, v6);
    a1->Unknown_4F44 = v8;
    v8->Unknown_33 |= 4u;
    a1->Unknown_4F38[1] = 0;
    a1->Unknown_4F38[2] = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, a1->gvSfx[v7].sfx1);
  }
  if ( a1->Unknown_4F38[1] )
  {
    *(float *)((char *)a1->Unknown_4F44 + 0xB) = *(float *)((char *)a1->Unknown_4F44 + 0xB) + -0.039999999;
    if ( *(float *)((char *)a1->Unknown_4F44 + 0xB) < 0.04 )
    {
      return 0xFFFFFFFF;
    }
  }
  else
  {
    a1->Unknown_4F38[2] += (a1->Unknown_4F38[0] & 3) == 0;
    if ( a1->Unknown_4F38[2] == 9 )
    {
      a1->Unknown_4F38[1] = 1;
    }
  }
  return v3;
}

//----- (00015164) --------------------------------------------------------
unsigned int __fastcall sub_15164(int a1)
{
  int v2; // ecx
  unsigned int v3; // edi
  P_TargetObject v4; // ebx
  P_Type21 v5; // eax
  _BYTE *v6; // eax
  int v7; // ebp
  int v8; // edx

  v2 = *(_DWORD *)(a1 + 0xAB);
  if ( *(_BYTE *)(v2 + 0xAB) != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x2B5);
  }
  v3 = 0;
  v4.pPlanet = *(P_Planet *)(v2 + 0xAC);
  if ( !*(_DWORD *)(a1 + 0x4F38) )
  {
    *(_WORD *)(a1 + 0x5034) = 2;
    v5 = sub_12AE4((P_Wnd04BM)a1, v4);
    *(_DWORD *)(a1 + 0x4F44) = v5;
    v5->Unknown_33 |= 4u;
    v6 = (_BYTE *)(*(_DWORD *)(a1 + 0x1D2A) + 0x35);
    *(_DWORD *)(a1 + 0x4F48) = v6;
    *v6 = 0xFF;
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    *(_DWORD *)(a1 + 0x4F40) = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 0x1CEE));
  }
  v7 = *(_DWORD *)(a1 + 0x4F3C);
  if ( v7 )
  {
    if ( v7 == 1 )
    {
      if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618(*(_DWORD *)(a1 + 0x4F48)) == 0xFFFFFFFF )
      {
        v3 = 0xFFFFFFFF;
      }
      *(_DWORD *)(*(_DWORD *)(a1 + 0x4F48) + 0xB) = 0x40A00000;
    }
  }
  else
  {
    v8 = (*(_DWORD *)(a1 + 0x4F38) & 1) + *(_DWORD *)(a1 + 0x4F40);
    *(_DWORD *)(a1 + 0x4F40) = v8;
    if ( v8 == 9 )
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 8u;
      **(_BYTE **)(a1 + 0x4F48) = 7;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x33) |= 0x10u;
      *(_BYTE *)(*(_DWORD *)(a1 + 0x4F48) + 0x34) = 1;
      *(float *)(a1 + 0x4F8C) = *(float *)((char *)&v4.pPlanet[1].z5 + 1);
      *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)&v4.pPlanet[1].name[3];
      *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)&v4.pPlanet[1].name[7];
      sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F48), *(_WORD *)(a1 + 0x1BB2), 0);
      *(_DWORD *)(*(_DWORD *)(a1 + 0x4F48) + 0xB) = 0x40A00000;
      *(_DWORD *)(a1 + 0x4F3C) = 1;
      return 0;
    }
  }
  return v3;
}

//----- (000152E4) --------------------------------------------------------
unsigned int __fastcall sub_152E4(int a1, int a2, int a3, int a4)
{
  int v5; // esi
  char v6; // ah
  int v7; // esi
  int v8; // ebx
  _BYTE *v9; // eax
  int v10; // edx
  int ShipsAtLocation_sub_1D794; // eax
  int v12; // esi
  int v13; // kr04_4
  int v14; // kr00_4
  int v15; // ebp
  int v16; // edx
  int v17; // ebx
  int v18; // ebx
  _BYTE *v19; // eax
  int v21; // eax
  unsigned __int16 v22; // si
  char v23; // al
  int v24; // eax
  void *v25[107]; // [esp+0h] [ebp-1DCh] BYREF
  T_Gizmo *v26; // [esp+1ACh] [ebp-30h]
  int v27; // [esp+1B0h] [ebp-2Ch]
  int v28; // [esp+1B4h] [ebp-28h]
  int v29; // [esp+1B8h] [ebp-24h]
  int v30; // [esp+1BCh] [ebp-20h]
  char v31; // [esp+1C0h] [ebp-1Ch]

  v5 = *(_DWORD *)(a1 + 0xAB);
  v6 = *(_BYTE *)(v5 + 0xAB);
  v7 = v5 + 0xAB;
  if ( v6 != 3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batfxa.cpp", 0x2FA);
  }
  v27 = 0;
  v28 = *(_DWORD *)(v7 + 1);
  v8 = *(_DWORD *)(a1 + 0x4F38);
  v31 = 0x26;
  v26 = &V_Gizmos[0x26];
  if ( !v8 )
  {
    *(_WORD *)(a1 + 0x5034) = 1;
    v9 = *(_BYTE **)(a1 + 0x1D2A);
    *(_DWORD *)(a1 + 0x4F44) = v9;
    *v9 = 0xFF;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x33) |= 0x12u;
    v10 = v28 + 0x9E;
    *(_BYTE *)(*(_DWORD *)(a1 + 0x4F44) + 0x34) = 0;
    *(_DWORD *)(a1 + 0x4F80) = *(_DWORD *)v10;
    *(_DWORD *)(a1 + 0x4F84) = *(_DWORD *)(v10 + 4);
    *(float *)(a1 + 0x4F88) = *(float *)(v10 + 8);
    *(_DWORD *)(a1 + 0x4F3C) = 0;
    Q_StartSample_sub_4FB90(&V_SoundSystem, *(_WORD *)(a1 + 0x1C66));
  }
  if ( **(_BYTE **)(a1 + 0x4F44) == 0xFF )
  {
    ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(*(P_Location *)(v28 + 0x59), (P_Ship *)v25);
    v12 = (unsigned __int8)*(_DWORD *)(a1 + 0x4F3C);
    if ( v12 < ShipsAtLocation_sub_1D794 )
    {
      v14 = 4 * v12;
      v15 = *(__int16 *)(v28 + 0x56);
      v29 = 4 * ShipsAtLocation_sub_1D794;
      v13 = 0;
      while ( 1 )
      {
        v16 = *(int *)((char *)&v25[v13] + v14);
        v17 = *(__int16 *)(v16 + 0x56);
        if ( *(_BYTE *)(v16 + 0x58) == 4 && v15 != v17 && V_Game.races[v15].treaties[v17] == 2 )
        {
          break;
        }
        ++v13;
        if ( v14 + 4 * v13 >= 4 * ShipsAtLocation_sub_1D794 )
        {
          goto LABEL_15;
        }
      }
      *(_WORD *)(a1 + 0x5034) = 2;
      v18 = *(int *)((char *)&v25[v13] + v14);
      *(_DWORD *)(a1 + 0x4F8C) = *(_DWORD *)(v18 + 0x9E);
      *(_DWORD *)(a1 + 0x4F90) = *(_DWORD *)(v18 + 0xA2);
      *(_DWORD *)(a1 + 0x4F94) = *(_DWORD *)(v18 + 0xA6);
      **(_BYTE **)(a1 + 0x4F44) = 7;
      *(_DWORD *)(a1 + 0x4F48) = sub_12AE4((P_Wnd04BM)a1, *(P_TargetObject *)((char *)&v25[v13] + v14));
      sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F44), *(_WORD *)(a1 + 4 * v31 + 0x1A92), 0);
      *(_DWORD *)(a1 + 0x4F3C) = v12 + v13 + 1;
    }
LABEL_15:
    if ( **(_BYTE **)(a1 + 0x4F44) == 0xFF )
    {
      v27 = 0xFFFFFFFF;
    }
  }
  v19 = *(_BYTE **)(a1 + 0x4F44);
  if ( *v19 == 0xFF )
  {
    return 0xFFFFFFFF;
  }
  if ( (*(_BYTE *)(a1 + 0x4F3D) & 1) != 0 )
  {
    if ( (*(_BYTE *)(a1 + 0x4F38) & 3) == 0 && sub_12618((int)v19) == 0xFFFFFFFF )
    {
      **(_BYTE **)(a1 + 0x4F44) = 0xFF;
      *(_DWORD *)(a1 + 0x4F3C) = (unsigned __int8)*(_DWORD *)(a1 + 0x4F3C);
      return v27;
    }
  }
  else
  {
    sub_12618((int)v19);
    if ( sub_12480((float *)(a1 + 0x4F80), (float *)(a1 + 0x4F8C), 50.0) == 0xFFFFFFFF )
    {
      v21 = *(_DWORD *)(a1 + 0x4F48);
      LOWORD(v30) = 1;
      v22 = 4;
      v23 = Q_Ship_ApplyDamage_sub_4B7A0(*(P_Ship *)(v21 + 1), 0, v26->special1, *(_WORD *)(v28 + 0x56));
      if ( (v23 & 4) != 0 )
      {
        v24 = *(_DWORD *)(a1 + 0x4F48);
        LOWORD(v30) = 5;
        v22 = 5;
        *(_BYTE *)(v24 + 0x33) |= 8u;
      }
      else if ( (v23 & 2) != 0 )
      {
        v22 = *(_WORD *)(a1 + 4 * v31 + 0x1A94);
        LOWORD(v30) = *(_WORD *)(a1 + 4 * v31 + 0x1BD0);
      }
      sub_1826C((P_Wnd04BM)a1, *(_DWORD *)(a1 + 0x4F44), v22, 0);
      Q_StartSample_sub_4FB90(&V_SoundSystem, v30);
      *(_BYTE *)(a1 + 0x4F3D) |= 1u;
    }
  }
  return v27;
}
// 152E4: using guessed type P_Ship var_1DC[107];

//----- (00015630) --------------------------------------------------------
void __fastcall sub_15630(P_Wnd04BM a1, int a2)
{
  int v3; // eax
  void *ShapeTable_sub_1B084; // eax
  LONG v5; // [esp-20h] [ebp-30h]
  LONG v6; // [esp-1Ch] [ebp-2Ch]
  LONG v7; // [esp-18h] [ebp-28h]
  LONG v8; // [esp-8h] [ebp-18h]

  v3 = a1->Unknown_4F38[2];
  if ( v3 > 9 )
  {
    v3 = 0x12 - v3;
  }
  if ( v3 >= 0 )
  {
    if ( v3 > 9 )
    {
      v3 = 9;
    }
  }
  else
  {
    v3 = 0;
  }
  VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[v3 + 0xB]);
  v8 = *(_DWORD *)(a2 + 0xF);
  v7 = *(__int16 *)(a2 + 0x29);
  v6 = *(__int16 *)(a2 + 0x27);
  v5 = *(_DWORD *)(a2 + 7);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a2 + 5));
  VFX_shape_transform(&a1->a.a1.pane, ShapeTable_sub_1B084, v5, v6, v7, V_BigBuffer, 0, v8, v8, 1);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (000156C0) --------------------------------------------------------
void __fastcall sub_156C0(int a1, int a2, unsigned __int16 shpNum)
{
  void *ShapeTable_sub_1B084; // ebp
  RECT rect; // [esp+0h] [ebp-24h] BYREF
  int v6; // [esp+10h] [ebp-14h]

  v6 = a2;
  *(_DWORD *)(a1 + 0xB) = 0x3F800000;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v6);
  if ( shpNum >= VFX_shape_count(ShapeTable_sub_1B084) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x38);
  }
  VFX_shape_visible_rectangle(ShapeTable_sub_1B084, shpNum, 0, 0, 0, &rect);
  if ( rect.x0 > 1000000 || rect.x0 < -1000000 )
  {
    memset(&rect, 0, sizeof(rect));
  }
  *(_WORD *)(a1 + 0x13) = rect.x0;
  *(_WORD *)(a1 + 0x15) = rect.y0;
  *(_WORD *)(a1 + 0x17) = rect.x1;
  *(_WORD *)(a1 + 0x19) = rect.y1;
  *(_WORD *)(a1 + 5) = v6;
  *(_DWORD *)(a1 + 7) = shpNum;
}

//----- (0001577C) --------------------------------------------------------
void __fastcall __spoils<> sub_1577C(T_Wnd04BMt3 *a1)
{
  sub_15788(a1);
}

//----- (00015788) --------------------------------------------------------
void __fastcall __spoils<> sub_15788(T_Wnd04BMt3 *result)
{
  result->num = 0;
}

//----- (00015794) --------------------------------------------------------
int __fastcall sub_15794(int result, int a2)
{
  int v2; // ebx

  v2 = *(_DWORD *)(result + 0x800);
  if ( v2 < 0x200 )
  {
    if ( a2 )
    {
      *(_DWORD *)(result + 4 * v2) = a2;
      ++*(_DWORD *)(result + 0x800);
    }
  }
  return result;
}

//----- (000157B4) --------------------------------------------------------
int __fastcall sub_157B4(const void *a1, const void *a2)
{
  int v2; // edx
  float v4; // [esp+0h] [ebp-8h]
  float v5; // [esp+4h] [ebp-4h]

  v5 = *(float *)(*(_DWORD *)a1 + 0x2F);
  v4 = *(float *)(*(_DWORD *)a2 + 0x2F);
  v2 = 0;
  if ( v5 > (double)v4 )
  {
    return 0xFFFFFFFF;
  }
  if ( v5 < (double)v4 )
  {
    return 1;
  }
  return v2;
}

//----- (000157EC) --------------------------------------------------------
void __fastcall sub_157EC(P_Wnd04BMt3 a1)
{
  qsort(a1, a1->num, 4u, sub_157B4);
}

//----- (00015808) --------------------------------------------------------
char *__fastcall sub_15808(int a1, int a2, int a3)
{
  int v3; // edi
  char **v4; // esi
  char *v5; // ecx
  float v7; // [esp+Ch] [ebp-24h]
  float v8; // [esp+10h] [ebp-20h]
  float v9; // [esp+18h] [ebp-18h]
  float v10; // [esp+1Ch] [ebp-14h]
  float v11; // [esp+20h] [ebp-10h]

  v3 = *(_DWORD *)(a1 + 0x800) - 1;
  v4 = (char **)(a1 + 4 * v3);
  while ( (v3 & 0x8000u) == 0 )
  {
    if ( !v4 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x9E);
    }
    v5 = *v4;
    if ( **v4 >= 9 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0xA2);
    }
    if ( *v5 == 5 )
    {
      if ( (*(__int16 *)(v5 + 0x27) - a2) * (*(__int16 *)(v5 + 0x27) - a2) + (*(__int16 *)(v5 + 0x29) - a3) * (*(__int16 *)(v5 + 0x29) - a3) < 0x50 )
      {
        return *v4;
      }
    }
    else if ( *v5 != 4 )
    {
      v8 = (double)*(unsigned int *)(v5 + 0xF) * 0.000015258789;
      v7 = (float)*(__int16 *)(v5 + 0x27);
      v9 = (float)a2;
      if ( (double)*(__int16 *)(v5 + 0x13) * v8 + v7 <= v9 )
      {
        v11 = (float)*(__int16 *)(v5 + 0x29);
        v10 = (float)a3;
        if ( (double)*(__int16 *)(v5 + 0x15) * v8 + v11 <= v10
          && (double)*(__int16 *)(v5 + 0x17) * v8 + v7 >= v9
          && (double)*(__int16 *)(v5 + 0x19) * v8 + v11 >= v10 )
        {
          return *v4;
        }
      }
    }
    LOWORD(v3) = v3 - 1;
    v4 += 0xFFFFFFFF;
  }
  return 0;
}

//----- (00015948) --------------------------------------------------------
int __fastcall sub_15948(P_Wnd04BMt3 a1, P_Wnd04BM a2)
{
  P_Wnd04BMt3 v2; // kr00_4
  PANE *p_pane; // ebp
  int v4; // kr04_4
  unsigned int v5; // eax
  LONG v6; // eax
  UWORD v7; // dx
  int v8; // edi
  __int64 v9; // rax
  double v10; // st7
  void *ShapeTable_sub_1B084; // eax
  int result; // eax
  int v13; // esi
  LONG v14; // [esp-20h] [ebp-88h]
  LONG v15; // [esp-1Ch] [ebp-84h]
  LONG v16; // [esp-18h] [ebp-80h]
  LONG v17; // [esp-8h] [ebp-70h]
  int v18; // [esp-4h] [ebp-6Ch]
  int v20; // [esp+Ch] [ebp-5Ch]
  int v21; // [esp+18h] [ebp-50h]
  float v23; // [esp+20h] [ebp-48h]
  int v24; // [esp+24h] [ebp-44h]
  int v25; // [esp+30h] [ebp-38h]
  __int16 i; // [esp+40h] [ebp-28h]

  v2 = a1;
  p_pane = &a2->a.a1.pane;
  v4 = 0;
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= a1->num )
    {
      break;
    }
    v13 = v2->Unknown_0[v4];
    if ( (*(_BYTE *)v13 != 4 || a2->Unknown_504A) && *(_BYTE *)v13 != 0xFF )
    {
      if ( *(_DWORD *)(v13 + 0x23) && (a2->Unknown_5042 || *(_BYTE *)v13 == 6) && (*(_BYTE *)(v13 + 0x33) & 2) == 0 )
      {
        v5 = 0xFFFFFFFF;
      }
      else
      {
        v5 = 0;
      }
      if ( v5 )
      {
        v6 = 0x72;
        if ( *(_DWORD *)(v13 + 0x1F) )
        {
          v6 = 0x90;
        }
        if ( *(_BYTE *)v13 == 6 && a2->Unknown_B7 == 3 )
        {
          v6 = 0xF3;
        }
        VFX_line_draw(p_pane, *(__int16 *)(v13 + 0x2B), *(__int16 *)(v13 + 0x2D), *(__int16 *)(v13 + 0x27), *(__int16 *)(v13 + 0x29), 0, v6);
      }
      if ( (*(_BYTE *)(v13 + 0x33) & 8) == 0 )
      {
        if ( (*(_BYTE *)(v13 + 0x33) & 4) != 0 )
        {
          sub_139E0(a2, v13);
        }
        else
        {
          v7 = *(_WORD *)(v13 + 5);
          if ( v7 != 0xFFFF )
          {
            if ( *(_BYTE *)v13 == 8 )
            {
              v25 = *(_BYTE *)(v13 + 0x33) & 4;
              v8 = *(_DWORD *)(v13 + 1);
              v24 = v25;
              v9 = *(__int16 *)(v13 + 0x27) - *(__int16 *)(v8 + 0x27);
              v20 = (HIDWORD(v9) ^ v9) - HIDWORD(v9);
              if ( v20 )
              {
                v10 = 2.5 / (double)(2 * v20);
                v25 = (int)((double)v20 * v10 + 0.5);
                v24 = (int)(v10 * (double)v20 + 0.5);
              }
              VFX_line_draw(
                p_pane,
                v25 + *(__int16 *)(v13 + 0x27),
                v24 + *(__int16 *)(v13 + 0x29),
                v25 + *(__int16 *)(v8 + 0x27),
                v24 + *(__int16 *)(v8 + 0x29),
                0,
                0x6A);
              VFX_line_draw(
                p_pane,
                *(__int16 *)(v13 + 0x27) - v25,
                *(__int16 *)(v13 + 0x29) - v24,
                *(__int16 *)(v8 + 0x27) - v25,
                *(__int16 *)(v8 + 0x29) - v24,
                0,
                0x6A);
              VFX_line_draw(
                p_pane,
                *(__int16 *)(v13 + 0x27),
                *(__int16 *)(v13 + 0x29),
                *(__int16 *)(v8 + 0x27),
                *(__int16 *)(v8 + 0x29),
                0,
                0x6D);
            }
            else
            {
              v18 = *(_BYTE *)(v13 + 0x33) & 4;
              v17 = *(_DWORD *)(v13 + 0xF);
              v16 = *(__int16 *)(v13 + 0x29);
              v15 = *(__int16 *)(v13 + 0x27);
              v14 = *(_DWORD *)(v13 + 7);
              ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v7);
              VFX_shape_transform(p_pane, ShapeTable_sub_1B084, v14, v15, v16, V_BigBuffer, v18, v17, v17, v18);
            }
          }
        }
      }
      v23 = (double)*(unsigned int *)(v13 + 0xF) * 0.000015258789;
      if ( *(_BYTE *)v13 == 1 && Q_Planet_HasOrbitalDefense_sub_361B8(*(P_Planet *)(v13 + 1)) == 0xFFFFFFFF )
      {
        v21 = (int)((double)*(__int16 *)(v13 + 0x17) * v23 + 2.0);
        VFX_ellipse_draw(
          p_pane,
          *(__int16 *)(v13 + 0x27),
          *(__int16 *)(v13 + 0x29),
          (__int16)v21,
          (__int16)v21,
          4 * V_Game.races[*(unsigned __int8 *)(*(_DWORD *)(v13 + 1) + 0x57)].Unknown_02 + 0x13);
      }
      if ( (P_Target)v13 == a2->target2 )
      {
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(
          p_pane,
          (__int16)(int)((double)*(__int16 *)(v13 + 0x13) * v23 + (double)*(__int16 *)(v13 + 0x27)),
          (__int16)(int)((double)*(__int16 *)(v13 + 0x15) * v23 + (double)*(__int16 *)(v13 + 0x29)),
          (__int16)(int)((double)*(__int16 *)(v13 + 0x27) + (double)*(__int16 *)(v13 + 0x17) * v23),
          (__int16)(int)(v23 * (double)*(__int16 *)(v13 + 0x19) + (double)*(__int16 *)(v13 + 0x29)),
          0xF3u,
          0);
      }
    }
    ++v4;
  }
  return result;
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00015D20) --------------------------------------------------------
void __fastcall __spoils<> sub_15D20(T_Wnd04BMt1 *a1)
{
  sub_15D2C(a1);
}

//----- (00015D2C) --------------------------------------------------------
void __fastcall __spoils<> sub_15D2C(T_Wnd04BMt1 *result)
{
  result->num = 0;
}

//----- (00015D38) --------------------------------------------------------
int __fastcall sub_15D38(int result, const void *a2)
{
  int v2; // ebx
  int v4; // edx

  v2 = result;
  v4 = *(_DWORD *)(result + 0x1900);
  if ( v4 < 0x40 )
  {
    result = 0x64 * v4;
    qmemcpy((void *)(v2 + 0x64 * v4), a2, 0x64u);
    ++*(_DWORD *)(v2 + 0x1900);
  }
  return result;
}

//----- (00015D74) --------------------------------------------------------
void __fastcall sub_15D74(P_Wnd04BMt1 a1, P_Wnd04BM a2)
{
  int i; // ecx

  for ( i = 0; i < a1->num; ++i )
  {
    sub_15DA4(a1, a2, i);
  }
}

//----- (00015DA4) --------------------------------------------------------
void __fastcall sub_15DA4(P_Wnd04BMt1 a1, P_Wnd04BM a2, unsigned __int16 a3)
{
  SCRNVERTEX *vertices; // edx
  int x; // ecx
  int v6; // eax

  if ( a3 < a1->num )
  {
    vertices = a1->a[a3].vertices;
    x = vertices[4].x;
    if ( x < 0 || x >= 7 )
    {
      v6 = 0;
    }
    else
    {
      v6 = V_Game.races[x].Unknown_02 + 1;
    }
    VFX_translate_polygon(&a2->a.a1.pane, 4, vertices, (char *)a2->Unknown_19BE + 0x100 * v6 + 0x1F00);
  }
}

//----- (00015E1C) --------------------------------------------------------
void __fastcall sub_15E1C(P_Wnd04BMt1 a1, P_Wnd04BM pWnd4BM)
{
  int raceIndex; // eax
  int j; // edi
  int i; // [esp+4h] [ebp-20h]
  int solidColor; // [esp+Ch] [ebp-18h]

  for ( i = 0; i < a1->num; ++i )
  {
    raceIndex = a1->a[i].raceIndex;
    if ( raceIndex < 0 || raceIndex >= 7 )
    {
      solidColor = 0x6D;
    }
    else
    {
      solidColor = 4 * V_Game.races[raceIndex].Unknown_02 + 0x13;
    }
    for ( j = 0; j < 4; ++j )
    {
      VFX_line_draw(
        &pWnd4BM->a.a1.pane,
        a1->a[i].vertices[j].x,
        a1->a[i].vertices[j].y,
        a1->a[i].vertices[j & 3].x,
        a1->a[i].vertices[j & 3].y,
        LD_DRAW,
        solidColor);
    }
  }
}

//----- (00015ED4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd4BMCtor_sub_15ED4(P_Wnd04BM a1)
{
  Q_A2Ctor_sub_2C830(&a1->a);
  _wcpp_2_ctor_array_(a1->vectors1, 100u, &C_Vector3D);
  _wcpp_2_ctor_array_(a1->someFloats, 100u, &C_Type16);
  _wcpp_2_ctor_array_(a1->vectors2, 100u, &C_Vector3D);
  a1->Unknown_1D0A = 0;
  a1->Unknown_1D0E = 0;
  a1->Unknown_1D12[0] = 0;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  a1->targetPosition.x = 0.0;
  sub_1577C(&a1->Unknown_1D36);
  sub_1577C(&a1->Unknown_253A);
  sub_1577C(&a1->Unknown_2D3E);
  sub_15D20(&a1->Unknown_3542);
  sub_1B4F0(&a1->_matrices);
  a1->vector_4EDE.x = 0.0;
  a1->vector_4EDE.y = 0.0;
  a1->vector_4EDE.z = 0.0;
  a1->matrix_4EEA.vector1.x = 0.0;
  a1->matrix_4EEA.vector1.y = 0.0;
  a1->matrix_4EEA.vector1.z = 0.0;
  a1->matrix_4EEA.vector2.x = 0.0;
  a1->matrix_4EEA.vector2.y = 0.0;
  a1->matrix_4EEA.vector2.z = 0.0;
  a1->matrix_4EEA.vector3.x = 0.0;
  a1->matrix_4EEA.vector3.y = 0.0;
  a1->matrix_4EEA.vector3.z = 0.0;
  a1->matrix_4EEA.vector1.y = 0.0;
  a1->matrix_4EEA.vector1.z = 0.0;
  a1->matrix_4EEA.vector1.x = 1.0;
  a1->matrix_4EEA.vector2.x = 0.0;
  a1->matrix_4EEA.vector2.y = 1.0;
  a1->matrix_4EEA.vector2.z = 0.0;
  a1->matrix_4EEA.vector3.x = 0.0;
  a1->matrix_4EEA.vector3.y = 0.0;
  a1->matrix_4EEA.vector3.z = 1.0;
  _wcpp_2_ctor_array_(a1->vectors3, 15u, &C_Vector3D);
  a1->a.pProcs = &Wnd4BM_Procs;
  sub_16120(a1);
}

//----- (0001604C) --------------------------------------------------------
T_Vector3D *__fastcall Q_Wnd4BMDtor_sub_1604C(P_Wnd04BM a1, char a2)
{
  char *v4; // eax
  void *Unknown_19BE; // edx
  T_Wnd04BMt1 *v7; // eax
  T_Vector3D *v8; // eax
  T_Vector3D *v9; // ebx

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd4BM);
    operator delete[](v4);
    return (T_Vector3D *)a1;
  }
  else
  {
    Unknown_19BE = a1->Unknown_19BE;
    a1->a.pProcs = &Wnd4BM_Procs;
    if ( Unknown_19BE )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(Unknown_19BE);
    }
    operator delete[](a1->Unknown_19BE);
    v7 = (T_Wnd04BMt1 *)((char *)sub_1A9C0(a1->vectors3) + 0xFFFFFEC6);
    Q_Ret_sub_1B66C();
    sub_15D2C(v7);
    sub_15788((T_Wnd04BMt3 *)v7);
    sub_15788((T_Wnd04BMt3 *)v7);
    sub_15788((T_Wnd04BMt3 *)v7);
    Q_DestructVectors_sub_1A9E0((P_Vector3D)v7);
    v8 = (T_Vector3D *)((char *)sub_1AA00(&v7[0xFFFFFFFF].a[0x18].vertices[0].y) + 0xFFFFFB50);
    Q_DestructVectors_sub_1A9E0(v8);
    Q_A2Dtor_sub_2C848((P_WndA2)v8, 1);
    v9 = v8;
    if ( (a2 & 2) != 0 )
    {
      operator delete(v8);
    }
    return v9;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00016120) --------------------------------------------------------
int __fastcall sub_16120(P_Wnd04BM a1)
{
  int i; // kr04_4
  FILE *fp; // eax
  FILE *fp_; // ecx
  int v5; // eax
  int j; // kr14_4
  int v8; // edi
  char s[200]; // [esp+0h] [ebp-12Ch] BYREF
  char bufc[60]; // [esp+C8h] [ebp-64h] BYREF
  int bufi1; // [esp+104h] [ebp-28h] BYREF
  int bufi2; // [esp+108h] [ebp-24h] BYREF
  int bufi3; // [esp+10Ch] [ebp-20h] BYREF
  int bufi4; // [esp+110h] [ebp-1Ch] BYREF

  a1->pWnd19BC = 0;
  a1->_t21 = 0;
  a1->Unknown_19BE = 0;
  for ( i = 0; i != 0x64; ++i )
  {
    a1->Unknown_137E[i] = 0;
  }
  a1->targetPosition.x = 0.0;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  a1->target2 = 0;
  a1->target1 = 0;
  a1->Unknown_B7 = 0;
  a1->backgroundColor = 0;
  a1->cursorShape = 2;
  a1->Unknown_BC = 0xFFFF;
  a1->Unknown_4F2F = 0;
  a1->Unknown_4F33 = 0;
  a1->Unknown_503A = 0xFFFFFFFF;
  a1->Unknown_5042 = 0xFFFFFFFF;
  a1->Unknown_5046 = 0xFFFFFFFF;
  a1->Unknown_504A = 0xFFFFFFFF;
  fp = Q_OpenFile_sub_1BB10("batfx.txt", 0);
  fp_ = fp;
  if ( !fp )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x1E4);
  }
  Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, s);
  // // here are the names
  // 81
  sscanf(s, "%d", &bufi1);
  v5 = bufi1;
  a1->batfxNamesNum = bufi1;
  if ( v5 >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x1EA);
  }
  // SHP files
  if ( a1->batfxNamesNum > 0 )
  {
    v8 = 0;
    do
    {
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp_, s);
      sscanf(s, "%s", bufc);
      a1->Unknown_19C6[v8++] = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, bufc, 0xFFFFFFFF);
    }
    while ( v8 < a1->batfxNamesNum );
  }
  // // here are the gizmo vals
  // // shape1 shape2 sfx1 sfx2

  // // sfx #s refer to list in
  // // soundfx.txt
  for ( j = 0; j != 0x4F; ++j )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp_, s);
    sscanf(s, "%d %d %d %d", &bufi1, &bufi2, &bufi3, &bufi4);
    a1->gvShape[j].shape1 = bufi1;
    a1->gvShape[j].shape2 = bufi2;
    a1->gvSfx[j].sfx1 = bufi3;
    a1->gvSfx[j].sfx2 = bufi4;
  }
  return fclose(fp_);
}
// 16120: using guessed type char bufc[60];

//----- (00016348) --------------------------------------------------------
int __fastcall sub_16348(P_Wnd04BM pWnd4BM, unsigned __int16 message, LONG param1, signed int param2)
{
  int result; // eax
  int index; // edx
  char v8; // ah
  int v9; // ebx
  int v10; // edx
  P_Wnd19BC v11; // edx
  T_Wnd04BM *v12; // eax
  P_Wnd19BC v13; // edx
  P_Wnd19BC pWnd19BC; // edx
  LONG x0; // ebx
  signed int y0; // esi
  int v18; // edi
  int v19; // ecx
  char Unknown_B7; // ah
  P_Target target1; // edx
  BYTE type; // bl
  char v23; // al
  LONG v24; // edi
  int v25; // eax
  char Unknown_4F2F; // ah
  char v27; // ch
  char v28; // bl
  char v29; // dl
  char v30; // bl
  int v31; // edx
  char v32; // cl
  int v33; // edx
  int v34; // ecx
  P_Type21 v35; // eax
  int Unknown_27; // edx
  int Unknown_29; // ebx
  P_Target target2; // eax
  P_TargetObject v39; // eax
  P_Target v40; // [esp-4h] [ebp-24h]
  P_Target v41; // [esp-4h] [ebp-24h]
  BYTE v42[5]; // [esp+8h] [ebp-18h]

  if ( message < 0x3Au )
  {
    if ( message >= 6u )
    {
      if ( message <= 6u )
      {
        sub_5A270(&WinMgr, 0, 0, 0);
        sub_567BC(&WinMgr, pWnd4BM->a.a1.index, 8);
        return 0xFFFFFFFF;
      }
      if ( message < 0xDu )
      {
        if ( message <= 7u )
        {
          if ( !WinMgr.wnds[dword_96BAC].pWndA2 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x3B7);
          }
          sub_17260(pWnd4BM);
          sub_56728(&WinMgr, pWnd4BM->a.a1.index, 4, 8, 0, 0);
          return 0xFFFFFFFF;
        }
        if ( message != 8 )
        {
          return Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
        }
        if ( pWnd4BM->Unknown_B7 != 4 )
        {
          x0 = pWnd4BM->a.a1.pane.x0;
          if ( param1 < x0 || param1 > pWnd4BM->a.a1.pane.x1 || (y0 = pWnd4BM->a.a1.pane.y0, param2 < y0) || param2 > pWnd4BM->a.a1.pane.y1 )
          {
            pWnd4BM->target1 = 0;
            pWnd4BM->Unknown_1D0E = 0x49742400;
            sub_18C2C(pWnd4BM, 0);
            return 0;
          }
          if ( !pWnd4BM->Unknown_4F2F )
          {
            v18 = param2 - y0;
            v19 = param1 - x0;
            sub_17204((int)pWnd4BM, param1 - x0, v18);
            if ( !pWnd4BM->target1 )
            {
              Unknown_B7 = pWnd4BM->Unknown_B7;
              if ( Unknown_B7 == 2 )
              {
                sub_16FC0((int)pWnd4BM, v19, v18, v19);
              }
              else if ( Unknown_B7 == 3 )
              {
                sub_171D0((int)pWnd4BM, v19, v18);
              }
            }
            sub_18C2C(pWnd4BM, 0);
            if ( pWnd4BM->Unknown_B7 == 1 )
            {
              target1 = pWnd4BM->target1;
              if ( target1 )
              {
                type = target1->type;
                v23 = 0;
                if ( target1->type == 2 )
                {
                  v23 = 3;
                }
                else if ( type == 3 )
                {
                  v23 = 4;
                }
                else if ( type == 1 )
                {
                  v23 = 2;
                }
                v24 = 0x6B;
                if ( Q_WinMgr_DispatchMessageProc3_sub_56D30(
                       &WinMgr,
                       pWnd4BM->pWnd19BC->a2.a1.index,
                       0x322,
                       v23,
                       (LONG)pWnd4BM->target1->pObject.pPlanet) == 0xFFFFFFFF )
                {
                  v24 = 0xF3;
                }
                VFX_line_draw(
                  &pWnd4BM->a.a1.pane,
                  *(__int16 *)((char *)&pWnd4BM->target2[7].pObject.pStar + 3),
                  SLOWORD(pWnd4BM->target2[8].pObject.pPlanet),
                  *(__int16 *)((char *)&pWnd4BM->target1[7].pObject.pStar + 3),
                  SLOWORD(pWnd4BM->target1[8].pObject.pPlanet),
                  0,
                  v24);
                return 0;
              }
            }
          }
        }
      }
      else
      {
        if ( message > 0xDu )
        {
          if ( message < 0x32u || message > 0x33u && (message < 0x36u || message > 0x37u) )
          {
            return Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
          }
          if ( pWnd4BM->a.a1.Unknown_39 != 0xFFFFFFFF )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x2E5);
          }
          v25 = 0;
          if ( message == 0x32 )
          {
            Unknown_4F2F = pWnd4BM->Unknown_4F2F;
            if ( (Unknown_4F2F & 1) != 0 )
            {
              if ( (Unknown_4F2F & 2) != 0 )
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = Unknown_4F2F & 0xFD;
              }
              else
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = Unknown_4F2F & 0xFE;
                sub_18C2C(pWnd4BM, 0);
              }
            }
            else
            {
              LOBYTE(pWnd4BM->Unknown_4F2F) = Unknown_4F2F & 0xFC | 1;
            }
            v25 = 3;
          }
          if ( message == 0x33 )
          {
            v27 = pWnd4BM->Unknown_4F2F;
            if ( (v27 & 1) != 0 )
            {
              if ( (v27 & 2) != 0 )
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = v27 & 0xFE;
                sub_18C2C(pWnd4BM, 0);
              }
              else
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = v27 | 2;
              }
            }
            else
            {
              LOBYTE(pWnd4BM->Unknown_4F2F) = v27 | 3;
            }
            v25 = 3;
          }
          if ( message == 0x36 )
          {
            v28 = pWnd4BM->Unknown_4F2F;
            if ( (v28 & 4) != 0 )
            {
              if ( (v28 & 8) != 0 )
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = v28 & 0xF7;
              }
              else
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = v28 & 0xFB;
              }
            }
            else
            {
              LOBYTE(pWnd4BM->Unknown_4F2F) = v28 & 0xF3 | 4;
            }
            v25 = 0xC;
          }
          if ( message == 0x37 )
          {
            v29 = pWnd4BM->Unknown_4F2F;
            if ( (v29 & 4) != 0 )
            {
              if ( (v29 & 8) != 0 )
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = v29 & 0xFB;
              }
              else
              {
                LOBYTE(pWnd4BM->Unknown_4F2F) = v29 | 8;
              }
            }
            else
            {
              LOBYTE(pWnd4BM->Unknown_4F2F) = v29 | 0xC;
            }
            v25 = 0xC;
          }
          if ( param1 == 4 )
          {
            sub_56728(&WinMgr, pWnd4BM->a.a1.index, 1, 0x3B, v25, 0);
          }
          return 0xFFFFFFFF;
        }
        if ( pWnd4BM->Unknown_B7 != 4 )
        {
          sub_187EC(pWnd4BM);
          sub_18C2C(pWnd4BM, 0);
          return 0;
        }
      }
      return 0;
    }
    if ( message < 3u )
    {
      if ( !message )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
      }
      if ( message <= 1u )
      {
        pWnd4BM->pWnd19BC = (P_Wnd19BC)Q_FindWnd_sub_56DA8(&WinMgr, "BatControlWnd", 0);
        index = pWnd4BM->a.a1.index;
        sub_56400(&WinMgr, index, 0x3A, 0, 0, 0);
        sub_186B8(pWnd4BM, index, param1);
        Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
        pWnd4BM->Unknown_4F2F = 0;
        return 0;
      }
      else
      {
        if ( pWnd4BM->Unknown_B7 == 4 )
        {
          sub_12238(pWnd4BM->pWnd19BC, 0);
        }
        sub_564C0(&WinMgr, pWnd4BM->a.a1.index, 0xFFFFFFFF);
        sub_185CC(pWnd4BM);
        Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
        return 0;
      }
    }
    if ( message <= 3u )
    {
      if ( (unsigned int)param2 < 0xD )
      {
        if ( param2 != 0xC )
        {
          return 0;
        }
        if ( WinMgr.j > 0.1 )
        {
          WinMgr.j = WinMgr.j * 0.8;
          return 0;
        }
      }
      else if ( (unsigned int)param2 <= 0xD )
      {
        if ( WinMgr.j < 10.0 )
        {
          WinMgr.j = WinMgr.j * 1.25;
          return 0;
        }
      }
      else if ( (unsigned int)param2 >= 0x1C )
      {
        if ( (unsigned int)param2 > 0x1C && param2 != 0x39 )
        {
          return 0;
        }
        if ( pWnd4BM->Unknown_B7 == 4 )
        {
          *(_DWORD *)pWnd4BM->Unknown_5036 = 0xFFFFFFFF;
        }
      }
      return 0;
    }
    if ( message > 4u )
    {
      if ( pWnd4BM->Unknown_B7 == 4 )
      {
        result = 0xFFFFFFFF;
        *(_DWORD *)pWnd4BM->Unknown_5036 = 0xFFFFFFFF;
        return result;
      }
      if ( param1 >= pWnd4BM->a.a1.pane.x0
        && param1 <= pWnd4BM->a.a1.pane.x1
        && param2 >= pWnd4BM->a.a1.pane.y0
        && param2 <= pWnd4BM->a.a1.pane.y1 )
      {
        Q_StartSample_sub_4FB90(&V_SoundSystem, 0);
        if ( pWnd4BM->target1 )
        {
          sub_16D6C(pWnd4BM, param1, param2, 0);
        }
        else if ( pWnd4BM->target2 )
        {
          v41 = pWnd4BM->target1;
          pWnd19BC = pWnd4BM->pWnd19BC;
          pWnd4BM->target2 = 0;
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd19BC->a2.a1.index, 0x320, 0, (LONG)v41);
          pWnd4BM->Unknown_B7 = 0;
        }
        sub_18C2C(pWnd4BM, 0);
        sub_17260(pWnd4BM);
        return 0xFFFFFFFF;
      }
      return 0;
    }
    if ( pWnd4BM->Unknown_B7 == 4 )
    {
      return 0xFFFFFFFF;
    }
    if ( param1 < pWnd4BM->a.a1.pane.x0
      || param1 > pWnd4BM->a.a1.pane.x1
      || param2 < pWnd4BM->a.a1.pane.y0
      || param2 > pWnd4BM->a.a1.pane.y1 )
    {
      return 0;
    }
    Q_StartSample_sub_4FB90(&V_SoundSystem, 0);
    if ( pWnd4BM->target1 )
    {
      sub_16D6C(pWnd4BM, param1, param2, 1);
    }
    else
    {
      v8 = pWnd4BM->Unknown_B7;
      if ( v8 == 2 )
      {
        if ( (unsigned __int16)pWnd4BM->Unknown_BC == 0xFFFF )
        {
          pWnd4BM->Unknown_B7 = 0;
        }
        else
        {
          v9 = param2 - pWnd4BM->a.a1.pane.y0;
          v10 = param1 - pWnd4BM->a.a1.pane.x0;
          pWnd4BM->Unknown_B7 = 3;
          sub_171D0((int)pWnd4BM, v10, v9);
        }
      }
      else
      {
        if ( v8 == 3 )
        {
          v11 = pWnd4BM->pWnd19BC;
          pWnd4BM->Unknown_B7 = 0;
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v11->a2.a1.index, 0x326, 5, (LONG)&pWnd4BM->Unknown_1D0A);
          pWnd4BM->target2 = 0;
          sub_187EC(pWnd4BM);
          v12 = pWnd4BM;
LABEL_43:
          sub_18C2C(v12, 0);
          return 0xFFFFFFFF;
        }
        if ( v8 )
        {
          return 0xFFFFFFFF;
        }
        v40 = pWnd4BM->target1;
        v13 = pWnd4BM->pWnd19BC;
        pWnd4BM->target2 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v13->a2.a1.index, 0x320, 0, (LONG)v40);
      }
    }
    v12 = pWnd4BM;
    goto LABEL_43;
  }
  if ( message <= 0x3Au )
  {
    v30 = pWnd4BM->Unknown_4F2F;
    if ( (v30 & 1) != 0 )
    {
      if ( (v30 & 2) != 0 )
      {
        v31 = 2;
      }
      else
      {
        v31 = -2u;
      }
      sub_17E50(pWnd4BM, v31);
    }
    v32 = pWnd4BM->Unknown_4F2F;
    if ( (v32 & 4) != 0 )
    {
      if ( (v32 & 8) != 0 )
      {
        v33 = 10;
      }
      else
      {
        v33 = -10;
      }
      sub_182B8(pWnd4BM, v33);
    }
    if ( (pWnd4BM->Unknown_4F2F & 5) != 0 )
    {
      goto LABEL_123;
    }
    return 0;
  }
  if ( message < 0x4Cu )
  {
    if ( message >= 0x47u )
    {
      if ( message <= 0x47u )
      {
        pWnd4BM->Unknown_4F2F = 0;
        sub_17F54(pWnd4BM);
        sub_18C2C(pWnd4BM, 0);
        return 0xFFFFFFFF;
      }
      else
      {
        if ( message < 0x4Au )
        {
          return Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
        }
        if ( message <= 0x4Au )
        {
          pWnd4BM->Unknown_503A = ~pWnd4BM->Unknown_503A;
          sub_18C2C(pWnd4BM, 0);
        }
        return 0;
      }
    }
    if ( message <= 0x3Bu )
    {
      pWnd4BM->Unknown_4F2F &= ~param1;
      if ( (param1 & 1) != 0 )
      {
        sub_18C2C(pWnd4BM, 0);
      }
      sub_567BC(&WinMgr, pWnd4BM->a.a1.index, 0x3B);
      return 0xFFFFFFFF;
    }
    if ( message != 0x46 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
    }
    return 0;
  }
  if ( message <= 0x4Cu )
  {
    v34 = ~pWnd4BM->Unknown_5042;
    pWnd4BM->Unknown_5046 = v34;
    pWnd4BM->Unknown_5042 = v34;
    sub_18C2C(pWnd4BM, 0);
    return 0;
  }
  if ( message < 0x52u )
  {
    if ( message < 0x50u )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
    }
    if ( message > 0x50u )
    {
      pWnd4BM->Unknown_B7 = 1;
      return 0;
    }
    if ( param1 >= 1 && V_Game.pCurStar->planetsNum >= param1 )
    {
      V_Game.pCurPlanet = *(P_Planet *)((char *)&V_Game.pCurStar->_lanes[param1 + 5] + 2);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
      return 0;
    }
    return 0;
  }
  if ( message <= 0x52u )
  {
    sub_126F8(pWnd4BM, param1, (int)pWnd4BM);
    return 0;
  }
  if ( message <= 0x53u )
  {
    *(_DWORD *)v42 = *(_DWORD *)&pWnd4BM->pWnd19BC->target.type;
    if ( !v42[0] )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x39A);
    }
    v42[4] = HIBYTE(pWnd4BM->pWnd19BC->target.pObject.pStar);
    v35 = sub_12AE4(pWnd4BM, *(P_TargetObject *)&v42[1]);
    pWnd4BM->target2 = &v35->target;
    Unknown_27 = v35->Unknown_27;
    if ( Unknown_27 < 0
      || (Unknown_29 = v35->Unknown_29, Unknown_29 < 0)
      || Unknown_27 > pWnd4BM->a.a1.pane.x1 - pWnd4BM->a.a1.pane.x0
      || Unknown_29 > pWnd4BM->a.a1.pane.y1 - pWnd4BM->a.a1.pane.y0 )
    {
      sub_17E88(pWnd4BM, pWnd4BM->target2);
    }
    target2 = pWnd4BM->target2;
    if ( target2->type == 2 )
    {
      v39.pPlanet = (P_Planet)target2->pObject;
      if ( *(UWORD *)((char *)&v39.pPlanet->maximumPopulation2 + 1) == V_PlayerRaceIndex
        && *(int *)((char *)&v39.pPlanet[1].starIndex + 1) > 0 )
      {
        pWnd4BM->Unknown_B7 = 2;
      }
    }
LABEL_123:
    sub_18C2C(pWnd4BM, 0);
    return 0;
  }
  if ( message != 0x54 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd4BM->a, message, param1, param2);
  }
  sub_172B0(pWnd4BM);
  return 0;
}
// 96BAC: using guessed type int dword_96BAC;

//----- (00016D6C) --------------------------------------------------------
void __fastcall sub_16D6C(T_Wnd04BM *a1, int a2, int a3, int a4)
{
  unsigned int v5; // ebp
  BYTE type; // bh
  char v7; // al
  LONG v8; // edi
  P_Target target1; // eax
  BYTE v10; // dl
  P_TargetObject v11; // eax
  char Unknown_B7; // ch
  P_Target target2; // ebx
  char v14; // bh
  LONG pPlanet; // eax
  P_Wnd19BC pWnd19BC; // edx
  char v17; // al
  BYTE v18; // ah

  if ( !a1->target1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x3D7);
  }
  v5 = 0;
  if ( !a4 )
  {
    sub_17E88(a1, a1->target1);
    goto LABEL_32;
  }
  if ( a1->Unknown_B7 == 1 )
  {
    type = a1->target1->type;
    v7 = 0;
    switch ( type )
    {
      case 2:
        v7 = 3;
        break;
      case 1:
        v7 = 2;
        break;
      case 3:
        v7 = 4;
        break;
    }
    v8 = v7;
    if ( Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->pWnd19BC->a2.a1.index, 0x322, v7, (LONG)a1->target1->pObject.pPlanet) == 0xFFFFFFFF )
    {
      a1->Unknown_B7 = 0;
      Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->pWnd19BC->a2.a1.index, 0x326, v8, (LONG)a1->target1->pObject.pPlanet);
      a1->target2 = 0;
    }
  }
  else
  {
    target1 = a1->target1;
    v10 = target1->type;
    if ( target1->type != 2 )
    {
      if ( v10 == 1 )
      {
        Unknown_B7 = a1->Unknown_B7;
        if ( Unknown_B7 != 2 && Unknown_B7 != 3 )
        {
          target2 = a1->target2;
          if ( target1 != target2 || Unknown_B7 )
          {
            v5 = 0xFFFFFFFF;
            a1->target2 = a1->target1;
          }
          else
          {
            V_Game.pCurPlanet = target2->pObject.pPlanet;
            a1->target1 = 0;
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
          }
          goto LABEL_32;
        }
        a1->Unknown_B7 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->pWnd19BC->a2.a1.index, 0x326, 2, (LONG)a1->target1->pObject.pPlanet);
      }
      else
      {
        if ( v10 != 3 )
        {
          goto LABEL_32;
        }
        v14 = a1->Unknown_B7;
        pPlanet = (LONG)target1->pObject.pPlanet;
        if ( v14 != 2 && v14 != 3 )
        {
          goto LABEL_32;
        }
        pWnd19BC = a1->pWnd19BC;
        a1->Unknown_B7 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd19BC->a2.a1.index, 0x326, 4, pPlanet);
      }
      sub_187EC(a1);
      sub_18C2C(a1, 0);
      goto LABEL_32;
    }
    if ( !a1->Unknown_B7 )
    {
      a1->target2 = target1;
      v11.pPlanet = (P_Planet)target1->pObject;
      v5 = 0xFFFFFFFF;
      if ( *(UWORD *)((char *)&v11.pPlanet->maximumPopulation2 + 1) == V_PlayerRaceIndex
        && *(int *)((char *)&v11.pPlanet[1].starIndex + 1) > 0 )
      {
        a1->Unknown_B7 = 2;
      }
    }
  }
LABEL_32:
  if ( v5 == 0xFFFFFFFF )
  {
    v17 = 0;
    v18 = a1->target2->type;
    if ( v18 == 2 )
    {
      v17 = 3;
    }
    else if ( v18 == 1 )
    {
      v17 = 2;
    }
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->pWnd19BC->a2.a1.index, 0x320, v17, (LONG)a1->target2->pObject.pPlanet);
  }
  sub_17260(a1);
}

//----- (00016FC0) --------------------------------------------------------
void __fastcall sub_16FC0(int a1, int edx0, int a3, int a4)
{
  int v5; // eax
  double v6; // st7
  float a2; // [esp+0h] [ebp-90h]
  float v8; // [esp+4h] [ebp-8Ch]
  int v9; // [esp+8h] [ebp-88h]
  int v10; // [esp+Ch] [ebp-84h]
  float v11; // [esp+10h] [ebp-80h] BYREF
  float v12; // [esp+14h] [ebp-7Ch]
  float v13; // [esp+18h] [ebp-78h]
  float v14; // [esp+1Ch] [ebp-74h] BYREF
  float v15; // [esp+20h] [ebp-70h]
  float v16; // [esp+24h] [ebp-6Ch]
  float v17; // [esp+28h] [ebp-68h]
  float v18; // [esp+2Ch] [ebp-64h]
  int v19; // [esp+30h] [ebp-60h]
  T_Vector3D result; // [esp+34h] [ebp-5Ch] BYREF
  float v21; // [esp+40h] [ebp-50h]
  float v22; // [esp+44h] [ebp-4Ch]
  float v23; // [esp+48h] [ebp-48h]
  int v24[3]; // [esp+4Ch] [ebp-44h] BYREF
  int v25[3]; // [esp+58h] [ebp-38h] BYREF
  float v26; // [esp+64h] [ebp-2Ch] BYREF
  float v27; // [esp+68h] [ebp-28h]
  float v28; // [esp+6Ch] [ebp-24h]
  int v29; // [esp+70h] [ebp-20h]
  int v30; // [esp+74h] [ebp-1Ch]
  int *v31; // [esp+78h] [ebp-18h]
  float v32; // [esp+7Ch] [ebp-14h]
  int *v33; // [esp+80h] [ebp-10h]
  float *v34; // [esp+84h] [ebp-Ch]
  float v35; // [esp+88h] [ebp-8h]

  v29 = edx0 - *(__int16 *)(a1 + 0x4F22);
  v5 = *(__int16 *)(a1 + 0x4F24);
  result.x = (float)v29;
  v31 = v24;
  v30 = v5 - a3;
  result.y = 0.0;
  result.z = (float)(v5 - a3);
  v32 = *(float *)(a1 + 0x4F16);
  v17 = result.x * v32;
  v18 = 0.0 * v32;
  *(float *)v24 = v17;
  *(float *)&v19 = result.z * v32;
  *(float *)&v24[1] = v18;
  result.x = v17 * 0.00125;
  v24[2] = v19;
  result.y = v18;
  result.z = *(float *)&v19 * 0.0020000001;
  v11 = *(float *)(a1 + 0x4E5E);
  v12 = *(float *)(a1 + 0x4E62);
  v13 = *(float *)(a1 + 0x4E66);
  v12 = 0.0;
  v26 = 0.0;
  v28 = 1.0;
  v27 = 0.0;
  v35 = sub_5309C(&v11, &v26);
  v8 = v12 * v28 - v13 * v27;
  *(float *)&v9 = v13 * v26 - v11 * v28;
  v33 = v25;
  *(float *)v25 = v8;
  v25[1] = v9;
  *(float *)&v10 = v11 * v27 - v12 * v26;
  v25[2] = v10;
  if ( *(float *)&v9 >= 0.0 )
  {
    a2 = -v35;
    Q_RotateVectorY_sub_532AC(&result, a2);
  }
  else
  {
    Q_RotateVectorY_sub_532AC(&result, v35);
  }
  v34 = &v14;
  v21 = 0.0;
  v22 = 0.0;
  v23 = 0.0;
  v21 = result.x + *(float *)(a1 + 0x1D1E);
  v22 = result.y + *(float *)(a1 + 0x1D22);
  v6 = result.z + *(float *)(a1 + 0x1D26);
  v14 = v21;
  v23 = v6;
  v15 = v22;
  v16 = v23;
  *(float *)(a1 + 0x1D0A) = v21;
  *(float *)(a1 + 0x1D0E) = v15;
  *(float *)(a1 + 0x1D12) = v16;
  Q_Vector3D_SnapToGrid_sub_53440((P_Vector3D)(a1 + 0x1D0A));
}

//----- (000171D0) --------------------------------------------------------
void __fastcall sub_171D0(int a1, int a2, int a3)
{
  *(float *)(a1 + 0x1D0E) = (double)(a3 - 0xF0) * *(float *)(a1 + 0x4F16) * 0.00125 + *(float *)(a1 + 0x1D22);
  Q_Vector3D_SnapToGrid_sub_53440((P_Vector3D)(a1 + 0x1D0A));
}

//----- (00017204) --------------------------------------------------------
char *__fastcall sub_17204(int a1, int a2, int a3)
{
  char *result; // eax

  result = sub_15808(a1 + 0x1D36, a2, a3);
  *(_DWORD *)(a1 + 0xAF) = result;
  if ( !result )
  {
    result = sub_15808(a1 + 0x253A, a2, a3);
    *(_DWORD *)(a1 + 0xAF) = result;
  }
  if ( !*(_DWORD *)(a1 + 0xAF) )
  {
    result = sub_15808(a1 + 0x2D3E, a2, a3);
    *(_DWORD *)(a1 + 0xAF) = result;
  }
  return result;
}

//----- (00017260) --------------------------------------------------------
void __fastcall sub_17260(P_Wnd04BM pWnd)
{
  char Unknown_B7; // bl
  int cursorShape; // edx

  if ( WinMgr._wndIndex == pWnd->a.a1.index )
  {
    Unknown_B7 = pWnd->Unknown_B7;
    cursorShape = pWnd->cursorShape;
    if ( Unknown_B7 == 1 )
    {
      cursorShape += 8;
    }
    else if ( Unknown_B7 == 2 || Unknown_B7 == 3 )
    {
      cursorShape += 6;
    }
    if ( pWnd->target1 )
    {
      ++cursorShape;
    }
    sub_5A270(&WinMgr, cursorShape, 0, 0);
  }
}

//----- (000172B0) --------------------------------------------------------
void __fastcall sub_172B0(P_Wnd04BM pWnd04BM)
{
  P_Target target2; // edx
  P_Target pShip; // eax
  char *helptopic; // esi
  char *objectname; // edi
  P_Ship v6; // eax
  P_Target v7; // eax
  P_Planet pPlanet; // eax
  P_Wnd20HW Wnd_sub_56DA8; // ecx
  P_Target target_; // eax
  P_Wnd19BC pWnd19BC; // edx
  char s[176]; // [esp+0h] [ebp-B0h] BYREF

  target2 = pWnd04BM->target2;
  if ( target2 )
  {
    pShip = pWnd04BM->target2;
    helptopic = 0;
    objectname = 0;
    if ( target2->type == ASCEND_TARGET_TYPE_2_SHIP && (v6 = pShip->pObject.pShip, v6->raceIndex == V_PlayerRaceIndex) )
    {
      helptopic = "abanship";
      objectname = v6->name;
    }
    else
    {
      v7 = pWnd04BM->target2;
      if ( v7->type == ASCEND_TARGET_TYPE_1_PLANET )
      {
        pPlanet = v7->pObject.pPlanet;
        if ( V_PlayerRaceIndex == pPlanet->raceIndex )
        {
          helptopic = "abanplan";
          objectname = pPlanet->name;
        }
      }
    }
    if ( helptopic )
    {
      Wnd_sub_56DA8 = (P_Wnd20HW)Q_FindWnd_sub_56DA8(&WinMgr, "HELPWINDOW", 0);
      Q_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, "help.txt", helptopic);
      sprintf(s, *(const char **)&Wnd_sub_56DA8->Unknown_C95[5], objectname);
      strcpy(*(char **)&Wnd_sub_56DA8->Unknown_C95[5], s);
      if ( sub_552F8(&WinMgr, &Wnd_sub_56DA8->a2, 0) )
      {
        target_ = pWnd04BM->target2;
        if ( target_->type == ASCEND_TARGET_TYPE_2_SHIP )
        {
          Q_Ship_RemoveFromTheGame_sub_49940(target_->pObject.pShip);
        }
        else
        {
          Q_Planet_Abandon_sub_37040(target_->pObject.pPlanet);
        }
        pWnd04BM->target2 = 0;
        pWnd19BC = pWnd04BM->pWnd19BC;
        pWnd04BM->Unknown_B7 = 0;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd19BC->a2.a1.index, 0x320, 0, 0);
        sub_187EC(pWnd04BM);
        sub_18C2C(pWnd04BM, 0);
      }
    }
  }
}
// 172B0: using guessed type char s[176];

//----- (000173F4) --------------------------------------------------------
int __fastcall sub_173F4(P_Wnd04BM pWnd04BM)
{
  sub_1B958(&pWnd04BM->_matrices, &pWnd04BM->targetPosition);
  return sub_17430(pWnd04BM);
}

//----- (00017430) --------------------------------------------------------
int __fastcall sub_17430(P_Wnd04BM pWnd04BM)
{
  P_Type21 t21; // esi
  int v3; // kr08_4
  int v4; // eax
  int Unknown_1D32; // ebx
  int v6; // kr10_4
  char Unknown_B7; // dl
  BYTE type; // bh
  float z; // eax
  int v10; // eax
  int v11; // edx
  int v12; // eax
  double v13; // st7
  BYTE v14; // al
  double v15; // st7
  float *p_x; // edx
  float v17; // eax
  int Unknown_23; // eax
  double v19; // st7
  int v20; // eax
  int i; // kr18_4
  int v22[24]; // [esp+14h] [ebp-16Ch] BYREF
  int v23; // [esp+74h] [ebp-10Ch]
  T_Vector3D vectors[4]; // [esp+78h] [ebp-108h] BYREF
  T_Vector3D v25; // [esp+A8h] [ebp-D8h] BYREF
  T_Vector3D v26; // [esp+B4h] [ebp-CCh] BYREF
  float v27; // [esp+C0h] [ebp-C0h]
  float v28; // [esp+C4h] [ebp-BCh]
  float v29; // [esp+C8h] [ebp-B8h]
  T_Vector3D position; // [esp+CCh] [ebp-B4h] BYREF
  T_Vector3D v1; // [esp+D8h] [ebp-A8h] BYREF
  T_Vector3D v32; // [esp+E4h] [ebp-9Ch] BYREF
  T_Vector3D result; // [esp+F0h] [ebp-90h] BYREF
  T_Vector3D v34; // [esp+FCh] [ebp-84h] BYREF
  float v35; // [esp+108h] [ebp-78h] BYREF
  float v36; // [esp+10Ch] [ebp-74h]
  float v37; // [esp+110h] [ebp-70h]
  __int64 v38; // [esp+114h] [ebp-6Ch]
  float v39; // [esp+11Ch] [ebp-64h]
  float *v40; // [esp+120h] [ebp-60h]
  T_Vector3D *v41; // [esp+124h] [ebp-5Ch]
  int v42; // [esp+128h] [ebp-58h]
  T_Vector3D *v43; // [esp+12Ch] [ebp-54h]
  int v44; // [esp+130h] [ebp-50h]
  T_Vector3D *v45; // [esp+134h] [ebp-4Ch]
  T_Wnd04BMt3 *p_Unknown_1D36; // [esp+138h] [ebp-48h]
  T_Vector3D *vectors3; // [esp+13Ch] [ebp-44h]
  T_Wnd04BMt3 *p_Unknown_253A; // [esp+140h] [ebp-40h]
  T_Matrix3x3 *a2; // [esp+144h] [ebp-3Ch]
  T_Wnd04BMt3 *p_Unknown_2D3E; // [esp+148h] [ebp-38h]
  float v51; // [esp+14Ch] [ebp-34h]
  T_Wnd04BMt1 *p_Unknown_3542; // [esp+150h] [ebp-30h]
  float v53; // [esp+154h] [ebp-2Ch]
  T_Vector3D *p_targetPosition; // [esp+158h] [ebp-28h]
  float v55; // [esp+15Ch] [ebp-24h]
  int a6; // [esp+160h] [ebp-20h] BYREF
  __int16 a5[14]; // [esp+164h] [ebp-1Ch] BYREF

  t21 = pWnd04BM->_t21;
  memset(&v1, 0, sizeof(v1));
  memset(&result, 0, sizeof(result));
  memset(&position, 0, sizeof(position));
  _wcpp_2_ctor_array_(vectors, 4u, &C_Vector3D);
  memset(&result, 0, sizeof(result));
  Q_M34xV_sub_53384(&result, &pWnd04BM->_matrices.trs, &v1);
  vectors[0].x = 16.0;
  vectors[0].z = 16.0;
  vectors[1].x = 16.0;
  result = v1;
  vectors[3].z = 16.0;
  vectors[0].y = 0.0;
  vectors[1].y = 0.0;
  vectors[2].y = 0.0;
  vectors[1].z = -16.0;
  vectors[2].x = -16.0;
  vectors[2].z = -16.0;
  vectors[3].x = -16.0;
  vectors[3].y = 0.0;
  v45 = &v25;
  v3 = 0;
  do
  {
    Q_M34xV_sub_53384(&vectors[v3], &pWnd04BM->_matrices.trs, &v1);
    v40 = &v35;
    v27 = v1.x - result.x;
    v35 = v27;
    v28 = v1.y - result.y;
    v36 = v28;
    v29 = v1.z - result.z;
    v37 = v29;
    vectors[v3].x = v27;
    vectors[v3].y = v36;
    v4 = LODWORD(v37);
    vectors[v3++].z = v37;
  }
  while ( &vectors[v3] != v45 );
  Unknown_1D32 = pWnd04BM->Unknown_1D32;
  v51 = pWnd04BM->Unknown_4F2A * 0.5;
  if ( Unknown_1D32 > 0 )
  {
    v44 = 0;
    p_Unknown_1D36 = &pWnd04BM->Unknown_1D36;
    p_Unknown_253A = &pWnd04BM->Unknown_253A;
    p_Unknown_3542 = &pWnd04BM->Unknown_3542;
    p_Unknown_2D3E = &pWnd04BM->Unknown_2D3E;
    a2 = &pWnd04BM->_matrices.matrix_00;
    p_targetPosition = &pWnd04BM->targetPosition;
    vectors3 = pWnd04BM->vectors3;
    v6 = 0;
    do
    {
      if ( t21[v6].target.type != 6
        || ((Unknown_B7 = pWnd04BM->Unknown_B7, Unknown_B7 == 2) || Unknown_B7 == 3)
        && !pWnd04BM->target1
        && pWnd04BM->Unknown_1D0E != 0x49742400 )
      {
        if ( t21[v6].target.type != (BYTE)0xFF )
        {
          type = t21[v6].target.type;
          t21[v6].Unknown_1B = 0xFFFFFFFF;
          if ( type == 4 )
          {
            v1 = *(T_Vector3D *)((char *)&t21[v6].target.pObject.pPlanet->position + 1);
            Q_M33xV_sub_53114(&v1, a2);
            if ( v1.z > 0.0 )
            {
              Q_Project3DTo2D_sub_533D4(&v1, pWnd04BM->_matrices._scaleFactor, pWnd04BM->_xOffset, pWnd04BM->_yOffset, a5, (WORD *)&a6);
              t21[v6].Unknown_27 = a5[0];
              t21[v6].Unknown_29 = a6;
              z = v1.z;
              t21[v6].Unknown_1B = 0;
              t21[v6].Unknown_23 = 0;
              t21[v6].Unknown_2F = z;
              v10 = (int)p_Unknown_2D3E;
              t21[v6].Unknown_F = 0x10000;
              sub_15794(v10, (int)&t21[v6]);
            }
          }
          else
          {
            v12 = t21[v6].Unknown_33 & 0x10;
            v42 = 0xFFFFFFFF;
            if ( v12 )
            {
              position = vectors3[t21[v6].Unknown_34];
            }
            else
            {
              switch ( t21[v6].target.type )
              {
                case ASCEND_TARGET_TYPE_0_STAR:
                  memset(&position, 0, sizeof(position));
                  break;
                case ASCEND_TARGET_TYPE_1_PLANET:
                  position = *(T_Vector3D *)&t21[v6].target.pObject.pShip->totalWeaponDamage;
                  break;
                case ASCEND_TARGET_TYPE_2_SHIP:
                  position = *(T_Vector3D *)((char *)&t21[v6].target.pObject.pPlanet[1].z5 + 1);
                  v42 = *(__int16 *)((char *)&t21[v6].target.pObject.pPlanet->maximumPopulation2 + 1);
                  break;
                case ASCEND_TARGET_TYPE_3_LANE:
                  p_x = &t21[v6].target.pObject.pPlanet->position.x;
                  if ( (t21[v6].Unknown_33 & 1) != 0 )
                  {
                    position.x = p_x[2];
                    position.y = p_x[3];
                    v17 = p_x[4];
                  }
                  else
                  {
                    position.x = p_x[5];
                    position.y = p_x[6];
                    v17 = p_x[7];
                  }
                  position.z = v17;
                  break;
                case ASCEND_TARGET_TYPE_6:
                  position = *(T_Vector3D *)&pWnd04BM->Unknown_1D0A;
                  Q_Vector3D_SnapToGrid_sub_53440(&position);
                  break;
                default:
                  Q_AssertLogBreakExit_sub_261A8(0, "..\\batmode.cpp", 0x53E);
                  break;
              }
            }
            result = position;
            Q_M34xV_sub_53384(&result, &pWnd04BM->_matrices.trs, &v1);
            result.y = pWnd04BM->targetPosition.y;
            v41 = &v26;
            memset(&v32, 0, sizeof(v32));
            v32.x = result.x - p_targetPosition->x;
            v32.y = result.y - p_targetPosition->y;
            v32.z = result.z - p_targetPosition->z;
            v26 = v32;
            result = v32;
            v13 = sqrt(v32.y * v32.y + v32.x * v32.x + v32.z * v32.z);
            t21[v6].Unknown_23 = (v13 >= v51) - 1;
            if ( v1.z > (double)pWnd04BM->_matrices.Unknown_2C && v1.z < (double)pWnd04BM->_matrices.Unknown_30 )
            {
              Q_Project3DTo2D_sub_533D4(&v1, pWnd04BM->_matrices._scaleFactor, pWnd04BM->_xOffset, pWnd04BM->_yOffset, a5, (WORD *)&a6);
              t21[v6].Unknown_27 = a5[0];
              t21[v6].Unknown_29 = a6;
              t21[v6].Unknown_2F = v1.z;
              v14 = t21[v6].target.type;
              t21[v6].Unknown_1B = 0;
              if ( v14 == 7 )
              {
                t21[v6].Unknown_2F = t21[v6].Unknown_2F + -1.0;
              }
              v15 = pWnd04BM->Unknown_4F1A * 16384.0;
              v55 = 131072.0;
              v53 = v15;
              if ( t21[v6].Unknown_2F >= (double)pWnd04BM->_matrices.Unknown_2C )
              {
                v55 = v53 / t21[v6].Unknown_2F;
              }
              if ( v55 >= 16384.0 )
              {
                if ( v55 > 131072.0 )
                {
                  v55 = 131072.0;
                }
              }
              else
              {
                v55 = 16384.0;
              }
              v38 = (__int64)(v55 * *(float *)&t21[v6].Unknown_5[6]);
              t21[v6].Unknown_F = v38;
              Unknown_23 = t21[v6].Unknown_23;
              v39 = pWnd04BM->Unknown_4F16 * 0.125 + pWnd04BM->targetPosition.y;
              if ( Unknown_23 )
              {
                if ( (t21[v6].Unknown_33 & 2) == 0 )
                {
                  result.x = position.x;
                  result.z = position.z;
                  result.y = v39;
                  Q_M34xV_sub_53384(&result, &pWnd04BM->_matrices.trs, &v1);
                  result = v1;
                  Q_Project3DTo2D_sub_533D4(&v1, pWnd04BM->_matrices._scaleFactor, pWnd04BM->_xOffset, pWnd04BM->_yOffset, a5, (WORD *)&a6);
                  t21[v6].Unknown_2B = a5[0];
                  t21[v6].Unknown_2D = a6;
                  for ( i = 0; i != 4; ++i )
                  {
                    v43 = &v34;
                    memset(&v25, 0, sizeof(v25));
                    v25.x = result.x + vectors[i].x;
                    v25.y = result.y + vectors[i].y;
                    v19 = result.z + vectors[i].z;
                    v34 = v25;
                    v25.z = v19;
                    v1 = v25;
                    Q_Project3DTo2D_sub_533D4(
                      &v1,
                      pWnd04BM->_matrices._scaleFactor,
                      pWnd04BM->_xOffset,
                      pWnd04BM->_yOffset,
                      a5,
                      (WORD *)&a6);
                    v22[6 * i] = a5[0];
                    v22[6 * i + 1] = (__int16)a6;
                  }
                  v23 = v42;
                  sub_15D38((int)p_Unknown_3542, v22);
                  if ( t21[v6].target.type == 6 )
                  {
                    pWnd04BM->Unknown_BC = LOWORD(pWnd04BM->Unknown_3542.num) - 1;
                  }
                }
              }
              if ( position.y - v39 > 0.0 )
              {
                v20 = (int)p_Unknown_253A;
                t21[v6].Unknown_1F = 0;
              }
              else
              {
                v20 = (int)p_Unknown_1D36;
                t21[v6].Unknown_1F = 0xFFFFFFFF;
              }
              sub_15794(v20, (int)&t21[v6]);
            }
          }
        }
      }
      v4 = v44 + 1;
      v11 = pWnd04BM->Unknown_1D32;
      v44 = v4;
      ++v6;
    }
    while ( v4 < v11 );
  }
  return v4;
}
// 17430: using guessed type __int16 a5[14];
// 17430: using guessed type _DWORD var_16C[24];

//----- (00017E50) --------------------------------------------------------
void __fastcall sub_17E50(P_Wnd04BM a1, int a2)
{
  float v2; // [esp+0h] [ebp-8h]

  v2 = (double)a2 * WinMgr.j;
  sub_1BAF0(&a1->_matrices, v2);
}

//----- (00017E88) --------------------------------------------------------
void __fastcall sub_17E88(P_Wnd04BM pWnd04BM, P_Target pTarget)
{
  P_Lane pLane; // ecx
  double x; // st7
  T_Vector3D *p_vector1; // ecx

  if ( !pTarget )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x5BD);
  }
  switch ( pTarget->type )
  {
    case ASCEND_TARGET_TYPE_0_STAR:
      pWnd04BM->targetPosition.x = 0.0;
      pWnd04BM->targetPosition.y = 0.0;
      pWnd04BM->targetPosition.z = 0.0;
      break;
    case ASCEND_TARGET_TYPE_1_PLANET:
      pWnd04BM->targetPosition = pTarget->pObject.pPlanet->position;
      break;
    case ASCEND_TARGET_TYPE_2_SHIP:
      pWnd04BM->targetPosition = pTarget->pObject.pShip->position;
      break;
    case ASCEND_TARGET_TYPE_3_LANE:
      pLane = pTarget->pObject.pLane;
      if ( V_Game.pCurStar == pLane->pStar1 )
      {
        x = pLane->vector1.x;
        p_vector1 = &pLane->vector1;
      }
      else
      {
        x = pLane->vector2.x;
        p_vector1 = &pLane->vector2;
      }
      pWnd04BM->targetPosition.x = x;
      pWnd04BM->targetPosition.y = p_vector1->y;
      pWnd04BM->targetPosition.z = p_vector1->z;
      break;
    default:
      JUMPOUT(0x15ED0);
  }
}
// 17EBC: control flows out of bounds to 15ED0

//----- (00017F54) --------------------------------------------------------
void __fastcall sub_17F54(P_Wnd04BM a1)
{
  a1->targetPosition.x = 0.0;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  a1->Unknown_4F16 = a1->Unknown_4F1A;
  a1->_matrices.vector_34 = a1->vector_4EDE;
  a1->_matrices.matrix_00 = (T_Matrix3x3)a1->matrix_4EEA;
  sub_181F0(a1);
}

//----- (00017FF0) --------------------------------------------------------
void __fastcall sub_17FF0(P_Wnd04BM a1)
{
  double v2; // st6
  double v3; // st7
  float a2; // [esp+0h] [ebp-3Ch]
  int x_4; // [esp+Ch] [ebp-30h]
  float x_4a; // [esp+Ch] [ebp-30h]
  double v7; // [esp+10h] [ebp-2Ch]

  a1->targetPosition.x = 0.0;
  LODWORD(a1->Unknown_4F26) = 0x23;
  v2 = (double)SLODWORD(a1->Unknown_4F26) * 0.017453292;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  v7 = *(float *)&a1->Unknown_4F1E;
  v3 = v7 / tan(v2 * 0.5);
  x_4 = a1->_xOffset;
  a1->Unknown_4F16 = v3;
  a1->Unknown_4F1A = v3;
  a2 = (float)SLODWORD(a1->Unknown_4F26);
  sub_1B808(&a1->_matrices, a2, 1.0, 100000.0, x_4);
  a1->vector_4EDE.z = a1->_matrices._scaleFactor;
  HIBYTE(a1->vector_4EDE.z) ^= 0x80u;
  a1->vector_4EDE.y = a1->vector_4EDE.z * 0.33333334;
  x_4a = a1->Unknown_4F16;
  a1->vector_4EDE.x = 0.0;
  Q_Vector3D_SetLength_sub_53054(&a1->vector_4EDE, x_4a);
  a1->_matrices.matrix_00._[0][0] = 1.0;
  a1->_matrices.matrix_00._[0][1] = 0.0;
  a1->_matrices.matrix_00._[0][2] = 0.0;
  a1->_matrices.matrix_00._[1][0] = 0.0;
  a1->_matrices.matrix_00._[1][1] = 1.0;
  a1->_matrices.matrix_00._[1][2] = 0.0;
  a1->_matrices.matrix_00._[2][0] = 0.0;
  a1->_matrices.matrix_00._[2][1] = 0.0;
  a1->_matrices.matrix_00._[2][2] = 1.0;
  a1->matrix_4EEA = (T_Matrix3x3D)a1->_matrices.matrix_00;
  a1->matrix_4EEA.vector3.x = -a1->vector_4EDE.x;
  a1->matrix_4EEA.vector3.y = -a1->vector_4EDE.y;
  a1->matrix_4EEA.vector3.z = -a1->vector_4EDE.z;
  sub_53864(&a1->matrix_4EEA);
  a1->_matrices.matrix_00 = (T_Matrix3x3)a1->matrix_4EEA;
  a1->_matrices.vector_34 = a1->vector_4EDE;
  sub_181F0(a1);
}

//----- (000181F0) --------------------------------------------------------
void __fastcall sub_181F0(P_Wnd04BM a1)
{
  a1->Unknown_4F2A = tan((double)SLODWORD(a1->Unknown_4F26) * 0.017453292 * 0.5);
  a1->Unknown_4F2A = a1->Unknown_4F16 * a1->Unknown_4F2A * 2.0;
  a1->Unknown_4F12 = a1->Unknown_4F1A * 0.5 + a1->Unknown_4F16;
  a1->Unknown_4F0E = a1->Unknown_4F16 - a1->Unknown_4F2A * 0.5;
}

//----- (0001826C) --------------------------------------------------------
void __fastcall sub_1826C(P_Wnd04BM a1, int a2, unsigned __int16 a3, unsigned __int16 a4)
{
  if ( a3 >= a1->batfxNamesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x62B);
  }
  sub_156C0(a2, (unsigned __int16)a1->Unknown_19C6[a3], a4);
}

//----- (000182B8) --------------------------------------------------------
void __fastcall sub_182B8(P_Wnd04BM a1, int a2)
{
  double v3; // st7
  double v4; // st7
  float scaleFactor; // eax
  float v6; // [esp+4h] [ebp-8h]
  float v7; // [esp+4h] [ebp-8h]
  float v8; // [esp+4h] [ebp-8h]

  v3 = (double)a2;
  v6 = v3;
  if ( v3 <= 50.0 )
  {
    if ( v6 < -50.0 )
    {
      v6 = -50.0;
    }
  }
  else
  {
    v6 = 50.0;
  }
  v7 = v6 * 0.0099999998 * WinMgr.j;
  v8 = v7 + 1.0;
  v4 = a1->Unknown_4F16 * v8;
  a1->Unknown_4F16 = v4;
  if ( v4 < a1->_matrices._scaleFactor )
  {
    scaleFactor = a1->_matrices._scaleFactor;
LABEL_9:
    a1->Unknown_4F16 = scaleFactor;
    goto LABEL_10;
  }
  if ( a1->Unknown_4F16 > (double)a1->Unknown_4F1A )
  {
    scaleFactor = a1->Unknown_4F1A;
    goto LABEL_9;
  }
LABEL_10:
  Q_Vector3D_SetLength_sub_53054(&a1->_matrices.vector_34, a1->Unknown_4F16);
  sub_181F0(a1);
}

//----- (00018370) --------------------------------------------------------
unsigned int __fastcall sub_18370(P_Wnd04BM a1)
{
  __int16 v2; // ax
  __int16 y0; // cx
  __int16 v4; // bx
  __int16 y1; // ax
  T_Type21 *v6; // eax
  void *v7; // eax
  char *Unknown_19BE; // kr00_4
  char *v9; // ebp
  int v10; // kr0C_4
  _BYTE v12[256]; // [esp+0h] [ebp-144h] BYREF
  char v13[20]; // [esp+114h] [ebp-30h] BYREF
  _WORD v14[10]; // [esp+12Ch] [ebp-18h] BYREF
  int i; // [esp+140h] [ebp-4h]

  v2 = LOWORD(a1->a.a1.pane.x1) - LOWORD(a1->a.a1.pane.x0);
  y0 = a1->a.a1.pane.y0;
  a1->_xOffset = v2;
  v4 = v2;
  y1 = a1->a.a1.pane.y1;
  a1->_xOffset = v4 >> 1;
  a1->_yOffset = (__int16)(y1 - y0) >> 1;
  a1->targetPosition.x = 0.0;
  a1->targetPosition.y = 0.0;
  a1->targetPosition.z = 0.0;
  if ( a1->_t21 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x65E);
  }
  if ( a1->Unknown_19BE )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x65F);
  }
  a1->Unknown_1D2E = 0x80;
  v6 = (T_Type21 *)operator new[](0x35 * a1->Unknown_1D2E);
  Q_RegisterData_sub_2625C(v6, 1, "BATDISPLAYITEMS");
  a1->_t21 = v6;
  if ( !v6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x669);
  }
  a1->Unknown_19C2 = 0x27;
  v7 = operator new[](a1->Unknown_19C2 << 8);
  Q_RegisterData_sub_2625C(v7, 1, "BATHAZE");
  a1->Unknown_19BE = v7;
  if ( !v7 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x66F);
  }
  Unknown_19BE = (char *)a1->Unknown_19BE;
  Q_CFile_Ctor_sub_1BB78((P_CFile)v12);
  for ( i = 0; i < 0x1F; ++i )
  {
    sprintf(&v13[4], "DATA\\BLACK%.2d.HAZ", i);
    if ( Q_CFile_OpenFile_sub_1BBFC((P_CFile)v12, &v13[4], 0x200, 0) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\batmode.cpp", 0x67B);
    }
    Q_CFile_Load_sub_1BF1C((P_CFile)v12, &Unknown_19BE[0x100 * i]);
  }
  v9 = &Unknown_19BE[0x100 * i];
  if ( Q_CFile_OpenFile_sub_1BBFC((P_CFile)v12, "DATA\\SLANE03.HAZ", 0x200, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\batmode.cpp", 0x680);
  }
  Q_CFile_Load_sub_1BF1C((P_CFile)v12, v9);
  i = 0x41;
  strcpy((char *)v14, "DATA\\RACEA03.HAZ");
  HIBYTE(v14[8]) = aDataRacea03Haz[0x11];
  v14[9] = *(_WORD *)&aDataRacea03Haz[0x12];
  v10 = 0;
  do
  {
    HIBYTE(v14[4]) = i;
    v9 += 0x100;
    if ( Q_CFile_OpenFile_sub_1BBFC((P_CFile)v12, (const char *)v14, 0x200, 0) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x68A);
    }
    Q_CFile_Load_sub_1BF1C((P_CFile)v12, v9);
    ++v10;
  }
  while ( v10 + 0x41 < 0x48 );
  Q_CFile_Dtor_sub_1BBC8((P_CFile)v12);
  return 0xFFFFFFFF;
}

//----- (000185CC) --------------------------------------------------------
void __fastcall sub_185CC(P_Wnd04BM pWnd4BM)
{
  int index; // esi
  int v3; // edi
  T_Type16 *v4; // eax

  index = V_Game.pCurStar->index;
  if ( index >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x697);
  }
  v3 = index;
  pWnd4BM->vectors1[v3] = pWnd4BM->_matrices.vector_34;
  v4 = &pWnd4BM->someFloats[index];
  v4->Unknown_00 = pWnd4BM->_matrices.matrix_00._[0][0];
  v4->Unknown_04 = pWnd4BM->_matrices.matrix_00._[0][1];
  v4->Unknown_08 = pWnd4BM->_matrices.matrix_00._[0][2];
  v4->Unknown_0C = pWnd4BM->_matrices.matrix_00._[1][0];
  v4->Unknown_10 = pWnd4BM->_matrices.matrix_00._[1][1];
  v4->Unknown_14 = pWnd4BM->_matrices.matrix_00._[1][2];
  v4->Unknown_18 = pWnd4BM->_matrices.matrix_00._[2][0];
  v4->Unknown_1C = pWnd4BM->_matrices.matrix_00._[2][1];
  v4->Unknown_20 = pWnd4BM->_matrices.matrix_00._[2][2];
  pWnd4BM->vectors2[v3] = pWnd4BM->targetPosition;
  pWnd4BM->Unknown_4F2F = 0;
  pWnd4BM->Unknown_B7 = 0;
  pWnd4BM->target2 = 0;
}

//----- (000186B8) --------------------------------------------------------
void __fastcall sub_186B8(P_Wnd04BM pWnd4BM, int a2, int a3)
{
  int index; // esi
  T_Type16 *v5; // ebx
  float *p_Unknown_0C; // edi
  double Unknown_04; // st7

  sub_187EC(pWnd4BM);
  index = V_Game.pCurStar->index;
  if ( index >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x6AE);
  }
  if ( pWnd4BM->Unknown_137E[index] )
  {
    pWnd4BM->_matrices.vector_34 = pWnd4BM->vectors1[index];
    v5 = &pWnd4BM->someFloats[index];
    p_Unknown_0C = &v5->Unknown_0C;
    pWnd4BM->_matrices.matrix_00._[0][0] = v5->Unknown_00;
    Unknown_04 = v5->Unknown_04;
    v5 = (T_Type16 *)((char *)v5 + 0x18);
    pWnd4BM->_matrices.matrix_00._[0][1] = Unknown_04;
    pWnd4BM->_matrices.matrix_00._[0][2] = v5[0xFFFFFFFF].Unknown_14;
    pWnd4BM->_matrices.matrix_00._[1][0] = *p_Unknown_0C;
    pWnd4BM->_matrices.matrix_00._[1][1] = p_Unknown_0C[1];
    pWnd4BM->_matrices.matrix_00._[1][2] = p_Unknown_0C[2];
    pWnd4BM->_matrices.matrix_00._[2][0] = v5->Unknown_00;
    pWnd4BM->_matrices.matrix_00._[2][1] = v5->Unknown_04;
    pWnd4BM->_matrices.matrix_00._[2][2] = v5->Unknown_08;
    pWnd4BM->targetPosition = pWnd4BM->vectors2[index];
    pWnd4BM->Unknown_4F16 = sqrt(
                              pWnd4BM->_matrices.vector_34.y * pWnd4BM->_matrices.vector_34.y
                            + pWnd4BM->_matrices.vector_34.x * pWnd4BM->_matrices.vector_34.x
                            + pWnd4BM->_matrices.vector_34.z * pWnd4BM->_matrices.vector_34.z);
    sub_181F0(pWnd4BM);
  }
  else
  {
    sub_17FF0(pWnd4BM);
    pWnd4BM->Unknown_137E[index] = 0xFFFFFFFF;
  }
  sub_18C2C(pWnd4BM, 0);
}

//----- (000187EC) --------------------------------------------------------
int __fastcall sub_187EC(P_Wnd04BM a1)
{
  __int16 i; // si
  int v3; // eax
  P_Type21 t21; // esi
  P_Type21 v5; // kr00_4
  int v6; // kr04_4
  int v7; // esi
  unsigned __int16 *pCurStar; // eax
  int v9; // ebx
  P_Planet v10; // eax
  signed __int16 v11; // cx
  float *v12; // eax
  float z; // eax
  int v14; // ebp
  P_Star v15; // eax
  P_Lane v16; // ebp
  unsigned __int16 v17; // ax
  int v18; // ebp
  int v19; // kr0C_4
  int v20; // eax
  __int16 v21; // bx
  int result; // eax
  int v23; // ecx
  __int16 j; // ax
  __int16 k; // cx
  int v26[107]; // [esp+8h] [ebp-1E4h] BYREF
  float x; // [esp+1B4h] [ebp-38h]
  float y; // [esp+1B8h] [ebp-34h]
  float v29; // [esp+1BCh] [ebp-30h]
  int v30; // [esp+1C0h] [ebp-2Ch]
  int ShipsAtLocation_sub_1D794; // [esp+1C4h] [ebp-28h]
  int v32; // [esp+1C8h] [ebp-24h]
  int v33; // [esp+1CCh] [ebp-20h]
  int v34; // [esp+1D0h] [ebp-1Ch]

  for ( i = 0; i < a1->Unknown_1D2E; ++i )
  {
    v3 = i;
    a1->_t21[v3].Unknown_33 = 0;
  }
  t21 = a1->_t21;
  a1->Unknown_1D32 = 0;
  t21->target.type = 6;
  a1->Unknown_1D12[1] = (int)t21;
  *(_WORD *)t21->Unknown_5 = 0xFFFF;
  v5 = t21 + 1;
  ++a1->Unknown_1D32;
  v6 = 0;
  for ( j = 0; j < 1; ++j )
  {
    v5[v6].target.type = 0xFF;
    ++a1->Unknown_1D32;
    ++v6;
  }
  v7 = (int)&v5[v6];
  *(_BYTE *)v7 = 0;
  pCurStar = (unsigned __int16 *)V_Game.pCurStar;
  *(_DWORD *)(v7 + 1) = V_Game.pCurStar;
  sub_1826C(a1, v7, 1u, *pCurStar);
  ++a1->Unknown_1D32;
  LOWORD(v33) = 0;
  while ( (__int16)v33 < V_Game.pCurStar->planetsNum )
  {
    if ( a1->Unknown_1D32 >= a1->Unknown_1D2E )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x6FC);
    }
    v10 = V_Game.pCurStar->planets[(__int16)v33];
    *(_BYTE *)(v7 + 0x35) = 1;
    *(_DWORD *)(v7 + 0x36) = v10;
    v7 += 0x35;
    v11 = v10->size + 5 * v10->type;
    if ( v11 >= 0x37 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x706);
    }
    sub_1826C(a1, v7, 0, v11);
    v9 = a1->Unknown_1D32 + 1;
    LOWORD(v33) = v33 + 1;
    a1->Unknown_1D32 = v9;
  }
  v12 = *(float **)(v7 + 1);
  *(float *)&a1->Unknown_4F1E = sqrt(v12[1] * v12[1] + *v12 * *v12 + v12[2] * v12[2]);
  LOWORD(v34) = 0;
  while ( 1 )
  {
    v15 = V_Game.pCurStar;
    if ( (__int16)v34 >= V_Game.pCurStar->lanesNum )
    {
      break;
    }
    if ( a1->Unknown_1D32 >= a1->Unknown_1D2E )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x716);
    }
    v16 = V_Game.pCurStar->_lanes[(__int16)v34];
    *(_BYTE *)(v7 + 0x35) = 3;
    *(_DWORD *)(v7 + 0x36) = v16;
    v7 += 0x35;
    v17 = (v16->flags & 1) != 0;
    if ( (v16->flags & 2) != 0 )
    {
      v17 += 2;
    }
    sub_1826C(a1, v7, 2u, v17);
    x = 0.0;
    y = 0.0;
    v29 = 0.0;
    if ( V_Game.pCurStar == v16->pStar1 )
    {
      *(_BYTE *)(v7 + 0x33) |= 1u;
      x = v16->vector1.x;
      y = v16->vector1.y;
      z = v16->vector1.z;
    }
    else
    {
      *(_BYTE *)(v7 + 0x33) &= ~1u;
      x = v16->vector2.x;
      y = v16->vector2.y;
      z = v16->vector2.z;
    }
    v29 = z;
    *(float *)&v30 = sqrt(y * y + x * x + z * z);
    if ( *(float *)&a1->Unknown_4F1E < (double)*(float *)&v30 )
    {
      a1->Unknown_4F1E = v30;
    }
    v14 = a1->Unknown_1D32 + 1;
    LOWORD(v34) = v34 + 1;
    a1->Unknown_1D32 = v14;
  }
  *(float *)&a1->Unknown_4F1E = *(float *)&a1->Unknown_4F1E + 32.0;
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)v15, (P_Ship *)v26);
  for ( k = 0; k < ShipsAtLocation_sub_1D794; ++k )
  {
    v18 = v26[k];
    if ( *(_BYTE *)(v18 + 0x58) == 4 )
    {
      if ( a1->Unknown_1D32 >= a1->Unknown_1D2E )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x750);
      }
      *(_DWORD *)(v7 + 0x36) = v18;
      *(_BYTE *)(v7 + 0x35) = 2;
      sub_156C0(v7 + 0x35, GwshareShpCacheIndexes[*(__int16 *)(v18 + 0x56) + 0xE], *(char *)(v18 + 0xAA));
      v7 += 0x35;
      ++a1->Unknown_1D32;
    }
  }
  if ( V_Game.sectorsNum > 0 )
  {
    LOWORD(v32) = 0;
    v19 = 0;
    do
    {
      if ( a1->Unknown_1D32 >= a1->Unknown_1D2E )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x761);
      }
      v20 = (__int16)v32;
      *(_BYTE *)(v7 + 0x35 * v19 + 0x35) = 4;
      *(_DWORD *)(v7 + 0x35 * v19 + 0x36) = &V_Game.sectors[v20];
      sub_1826C(a1, v7 + 0x35 * v19 + 0x35, 3u, V_Game.sectors[v20].n);
      v21 = v32;
      ++a1->Unknown_1D32;
      LOWORD(v32) = v21 + 1;
      ++v19;
    }
    while ( (__int16)(v21 + 1) < V_Game.sectorsNum );
  }
  for ( result = 0; (__int16)result < a1->Unknown_1D32; ++result )
  {
    v23 = (__int16)result;
    a1->_t21[v23].Unknown_33 &= ~4u;
  }
  return result;
}
// 187EC: using guessed type int var_1E4[107];

//----- (00018C2C) --------------------------------------------------------
void __fastcall sub_18C2C(P_Wnd04BM pWnd04BM, int a2)
{
  T_Wnd04BMt3 *p_Unknown_1D36; // ecx

  p_Unknown_1D36 = &pWnd04BM->Unknown_1D36;
  sub_15788(&pWnd04BM->Unknown_1D36);
  sub_15788(&pWnd04BM->Unknown_253A);
  sub_15788(&pWnd04BM->Unknown_2D3E);
  sub_15D2C(&pWnd04BM->Unknown_3542);
  sub_173F4(pWnd04BM);
  sub_157EC(p_Unknown_1D36);
  sub_157EC(&pWnd04BM->Unknown_253A);
  if ( !a2 )
  {
    pWnd04BM->a.pProcs->proc4_draw((P_Wnd)pWnd04BM, 0);
  }
}

//----- (00018CA8) --------------------------------------------------------
void __fastcall Q_Wnd4BM_Proc4_sub_18CA8(P_Wnd04BM pWnd4BM, int a2)
{
  char Unknown_B7; // ah
  P_Target target1; // eax
  char *sub_1CEA8; // eax
  int v6; // ebx
  int v7; // edx
  P_Ship v8; // edx
  WORD v9; // bx
  int order; // edx
  char *orderText; // ecx
  P_Planet pPlanet; // ebx
  char *v13; // eax
  int raceIndex; // eax
  char *textOwnedBy; // eax
  __int16 color; // dx
  P_Ship pShip_; // ebx
  char *textMovingTo; // esi
  char *textMovingToPlanet; // eax
  char *textStarLane; // kr08_4
  char *textRedLink; // kr10_4
  P_Target v22; // eax
  P_Star pTargetStar; // ebx
  char *textUnknown; // kr18_4
  P_Target pTarget1; // eax
  BYTE order_; // dl
  char *textOut3; // ecx
  WORD v28; // [esp-Ch] [ebp-198h]
  char *name; // [esp-4h] [ebp-190h]
  char *specName; // [esp-4h] [ebp-190h]
  T_Name20 ordersTexts[10]; // [esp+0h] [ebp-18Ch] BYREF
  char textOut2[80]; // [esp+C8h] [ebp-C4h] BYREF
  char outtext[60]; // [esp+118h] [ebp-74h] BYREF
  char textOwnedBySpec[32]; // [esp+154h] [ebp-38h] BYREF
  P_Ship pShip; // [esp+174h] [ebp-18h]

  if ( !a2 )
  {
    pPane = pWnd4BM->a.a1.pane;
  }
  VFX_pane_wipe(&pWnd4BM->a.a1.pane, (unsigned __int8)pWnd4BM->backgroundColor);
  sub_15948(&pWnd4BM->Unknown_2D3E, pWnd4BM);
  sub_19AE8(pWnd4BM);
  sub_15948(&pWnd4BM->Unknown_253A, pWnd4BM);
  if ( pWnd4BM->Unknown_5046 )
  {
    sub_15D74(&pWnd4BM->Unknown_3542, pWnd4BM);
  }
  if ( !pWnd4BM->target1 )
  {
    Unknown_B7 = pWnd4BM->Unknown_B7;
    if ( Unknown_B7 == 2 || Unknown_B7 == 3 )
    {
      sub_15DA4(&pWnd4BM->Unknown_3542, pWnd4BM, pWnd4BM->Unknown_BC);
    }
  }
  if ( pWnd4BM->Unknown_503A && (pWnd4BM->Unknown_4F2F & 1) == 0 )
  {
    sub_1936C(pWnd4BM);
  }
  if ( pWnd4BM->Unknown_5046 )
  {
    sub_15E1C(&pWnd4BM->Unknown_3542, pWnd4BM);
  }
  sub_15948(&pWnd4BM->Unknown_1D36, pWnd4BM);
  Q_WINMGR_CPP_sub_53E38(&pWnd4BM->a.a1.pane, 3, 3, V_PlayerRaceIndex);
  if ( !WinMgr.wnds[dword_96BAC].pWndA2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x7AC);
  }
  target1 = pWnd4BM->target1;
  pShip = 0;
  if ( target1 )
  {
    textUnknown = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(2);// 2: "Unknown"
    strcpy(outtext, textUnknown);
    pTarget1 = pWnd4BM->target1;
    color = 243;
    switch ( pTarget1->type )
    {
      case ASCEND_TARGET_TYPE_0_STAR:
        name = pTarget1->pObject.pStar->name;
        sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(3);// 3: "Sun %s"
        sprintf(outtext, sub_1CEA8, name);
        break;
      case ASCEND_TARGET_TYPE_1_PLANET:
        pPlanet = pTarget1->pObject.pPlanet;
        v13 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(4);   // 4: "Planet %s"
        sprintf(outtext, v13, pPlanet->name);
        raceIndex = pPlanet->raceIndex;
        if ( raceIndex != 0xFF )
        {
          specName = V_SpecNames[V_Game.races[raceIndex]._nameIndex];
          textOwnedBy = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(5);// 5: "\nOwned by %s"
          sprintf(textOwnedBySpec, textOwnedBy, specName);
          strcat(outtext, textOwnedBySpec);
          color = 4 * V_Game.races[pPlanet->raceIndex].Unknown_02 + 0x13;
        }
        break;
      case ASCEND_TARGET_TYPE_2_SHIP:
        pShip = pTarget1->pObject.pShip;
        pShip_ = pShip;
        sprintf(outtext, "%s %s", V_SpecNames[V_Game.races[pShip->raceIndex]._nameIndex], pShip->name);
        if ( pShip_->raceIndex == V_PlayerRaceIndex && pShip_->order )
        {
          textMovingTo = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(6);// 6: "\nMoving to Star Lane"
          textMovingToPlanet = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(7);// 7: "\nMoving to Planet"
          if ( pShip_->order != ASCEND_SO_1_GOSTAR )
          {
            textMovingTo = textMovingToPlanet;
          }
          strcat(outtext, textMovingTo);
        }
        color = 4 * V_Game.races[pShip_->raceIndex].Unknown_02 + 0x13;
        break;
      case ASCEND_TARGET_TYPE_3_LANE:
        textStarLane = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(8);// 8: "Star Lane"
        strcpy(outtext, textStarLane);
        color = 243;
        if ( (pWnd4BM->target1->pObject.pLane->flags & ASCEND_LANE_FLAGS_1_RED_LINK) != 0 )
        {
          textRedLink = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(9);// 9: "Red Link"
          strcpy(outtext, textRedLink);
          color = 243;
        }
        v22 = pWnd4BM->target1;
        if ( ((int)v22[0xA].pObject.pPlanet & 1) != 0 )
        {
          pTargetStar = v22->pObject.pLane->pStar2;
        }
        else
        {
          pTargetStar = v22->pObject.pLane->pStar1;
        }
        if ( ((1 << V_PlayerRaceIndex) & pTargetStar->exploredBits) != 0 )
        {
          strcat(outtext, Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xA));// 10: " to "
          strcat(outtext, pTargetStar->name);
        }
        break;
      default:
        break;
    }
    v28 = color;
    v6 = pWnd4BM->a.a1.pane.y1 - 30;
    v7 = pWnd4BM->a.a1.pane.x1 - 200;
    WinMgr.LargeFont.pane = V_Type6_stru_D8654.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v7, v6, outtext, 0, v28, 0xFF, 0);
  }
  v8 = pShip;
  sub_17260(pWnd4BM);
  if ( v8 )
  {
    v9 = V_NougatLfExists_dword_A0CFC;
    if ( V_NougatLfExists_dword_A0CFC == TRUE )
    {
      sprintf(textOut2, "%s %s", V_SpecNames[V_Game.races[v8->raceIndex]._nameIndex], v8->name);
      WinMgr.SmallFont.pane = V_Type6_stru_D8654.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 250, 10, textOut2, 0, v9, v9, 0);
      sprintf(textOut2, "POWER %d MOVES %d INTEGRITY %d", pShip->availablePower, pShip->availableMoves, pShip->hullIntegrity);
      WinMgr.SmallFont.pane = V_Type6_stru_D8654.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 250, 20, textOut2, 0, 0xFFFF, 0xFFFF, 0);
      qmemcpy(ordersTexts, V_OrdersTexts, sizeof(ordersTexts));
      strcpy(textOut2, "INVALID ORDER");
      order = pShip->order;
      if ( order >= ASCEND_SO_0_NOTHING && pShip->order <= ASCEND_SO_7_GOSPACE )
      {
        orderText = ordersTexts[order];
      }
      else
      {
        orderText = textOut2;
      }
      WinMgr.SmallFont.pane = V_Type6_stru_D8654.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 250, 30, orderText, 0, 0xFFFF, 0xFFFF, 0);
      order_ = pShip->order;
      if ( order_ == ASCEND_SO_1_GOSTAR )
      {
        textOut3 = pShip->_orderTargetObject.pStar->name;
LABEL_46:
        WinMgr.SmallFont.pane = V_Type6_stru_D8654.pane;
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 320, 30, textOut3, 0, 0xFFFF, 0xFFFF, 0);
        goto LABEL_47;
      }
      if ( order_ == ASCEND_SO_2_COLONIZE )
      {
        textOut3 = pShip->_orderTargetObject.pPlanet->name;
        goto LABEL_46;
      }
    }
  }
LABEL_47:
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
}
// 96BAC: using guessed type int dword_96BAC;
// 18CA8: using guessed type char outtext[60];
// 18CA8: using guessed type char textOut2[80];
// 18CA8: using guessed type char textOwnedBySpec[32];

//----- (0001936C) --------------------------------------------------------
void __fastcall sub_1936C(P_Wnd04BM pWnd4BM)
{
  double v2; // st7
  int v3; // edx
  double Unknown_4F2A; // st7
  int v5; // ebp
  T_Vector3D *p_targetPosition; // edi
  double v7; // st7
  double v8; // st7
  T_Matrix3x4 *v9; // edx
  int v10; // ecx
  int v11; // ebx
  T_Vector3D *v12; // edi
  double v13; // st7
  double v14; // st7
  T_Matrix3x4 *v15; // edx
  int v16; // ecx
  int v17; // ebx
  int i; // ebp
  T_Vector3D v19[4]; // [esp+8h] [ebp-110h] BYREF
  T_Vector3D result; // [esp+38h] [ebp-E0h] BYREF
  T_Vector3D v; // [esp+44h] [ebp-D4h] BYREF
  T_Vector3D v22; // [esp+50h] [ebp-C8h] BYREF
  T_Vector3D v23[2]; // [esp+5Ch] [ebp-BCh] BYREF
  T_Vector3D v24; // [esp+74h] [ebp-A4h] BYREF
  T_Vector3D v25; // [esp+80h] [ebp-98h] BYREF
  float v26; // [esp+8Ch] [ebp-8Ch]
  T_Vector3D *v27; // [esp+90h] [ebp-88h]
  T_Vector3D *v28; // [esp+94h] [ebp-84h]
  int v29; // [esp+98h] [ebp-80h]
  float v30; // [esp+9Ch] [ebp-7Ch]
  T_Vector3D *v31; // [esp+A0h] [ebp-78h]
  T_Vector3D *v32; // [esp+A4h] [ebp-74h]
  int v33; // [esp+A8h] [ebp-70h]
  PANE *p_pane; // [esp+ACh] [ebp-6Ch]
  PANE *pane; // [esp+B0h] [ebp-68h]
  int v36; // [esp+B4h] [ebp-64h]
  T_Matrix3x4 *trs; // [esp+B8h] [ebp-60h]
  T_Matrix3x4 *p_trs; // [esp+BCh] [ebp-5Ch]
  LONG parm; // [esp+C0h] [ebp-58h]
  int v40; // [esp+C4h] [ebp-54h]
  float v41; // [esp+C8h] [ebp-50h]
  int v42; // [esp+CCh] [ebp-4Ch]
  int v43; // [esp+D0h] [ebp-48h]
  int v44; // [esp+D4h] [ebp-44h]
  int v45; // [esp+D8h] [ebp-40h]
  float v46; // [esp+DCh] [ebp-3Ch]
  T_Vector3D v47; // [esp+E0h] [ebp-38h]
  float v48; // [esp+ECh] [ebp-2Ch]
  WORD v49; // [esp+F0h] [ebp-28h] BYREF
  WORD outX; // [esp+F4h] [ebp-24h] BYREF
  WORD outY; // [esp+F8h] [ebp-20h] BYREF
  WORD v52[14]; // [esp+FCh] [ebp-1Ch] BYREF

  memset(&v, 0, sizeof(v));
  memset(&v22, 0, sizeof(v22));
  memset(&result, 0, sizeof(result));
  v2 = pWnd4BM->Unknown_4F2A * 0.5;
  v41 = v2;
  v41 = v2 * v41;
  v29 = (int)(pWnd4BM->Unknown_4F2A * 0.03125);
  v42 = v29 + 2;
  v29 = (int)(pWnd4BM->Unknown_4F2A * 0.0062500001);
  v33 = 0x20 * (v42 / 2) + 0x10;
  v3 = (v29 + 2) / 2;
  v36 = 0x68;
  parm = 0x61;
  v43 = 0xA0 * v3 + 0x10;
  if ( v43 > v33 )
  {
    v43 = 0xA0 * v3 - 0x90;
  }
  Unknown_4F2A = pWnd4BM->Unknown_4F2A;
  v44 = 0xFFFFFFFF;
  v40 = 0;
  if ( Unknown_4F2A < 960.0 )
  {
    v40 = 0xFFFFFFFF;
  }
  v5 = 0;
  v47.y = pWnd4BM->Unknown_4F16 * 0.125;
  v48 = (float)v33;
  if ( v42 > 0 )
  {
    p_targetPosition = &pWnd4BM->targetPosition;
    pane = &pWnd4BM->a.a1.pane;
    trs = &pWnd4BM->_matrices.trs;
    do
    {
      if ( (double)v43 == v48 )
      {
        v44 = v5;
      }
      v46 = v41 - v48 * v48;
      if ( v46 > 0.0 )
      {
        v46 = sqrt(v46);
        v.x = v48;
        v.y = v47.y;
        memset(&v23[1], 0, sizeof(T_Vector3D));
        v.z = v46;
        v22.x = v48;
        v26 = -v46;
        v22.y = v47.y;
        v22.z = v26;
        v28 = v23;
        v23[1].x = v48 + p_targetPosition->x;
        v23[1].y = v47.y + pWnd4BM->targetPosition.y;
        v7 = v46 + pWnd4BM->targetPosition.z;
        v23[0] = v23[1];
        v23[1].z = v7;
        v = v23[1];
        memset(&v19[3], 0, sizeof(T_Vector3D));
        v27 = &v24;
        v19[3].x = v48 + p_targetPosition->x;
        v19[3].y = v47.y + pWnd4BM->targetPosition.y;
        v8 = v26 + pWnd4BM->targetPosition.z;
        v24 = v19[3];
        v19[3].z = v8;
        v22 = v19[3];
        Q_M34xV_sub_53384(&v, trs, &result);
        v9 = trs;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->_matrices._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, &outX, &outY);
        Q_M34xV_sub_53384(&v22, v9, &result);
        v10 = v44;
        v11 = 0xFFFFFFFF;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->_matrices._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, v52, &v49);
        if ( v10 < 0 || (v5 - v10) % 5 )
        {
          if ( v40 )
          {
            v11 = v36;
          }
        }
        else
        {
          v11 = parm;
        }
        if ( v11 != 0xFFFFFFFF )
        {
          VFX_line_draw(pane, outX, outY, v52[0], v49, 0, v11);
        }
      }
      ++v5;
      v48 = v48 + -32.0;
    }
    while ( v5 < v42 );
  }
  v47.z = (float)v33;
  v45 = 0xFFFFFFFF;
  if ( v42 > 0 )
  {
    v12 = &pWnd4BM->targetPosition;
    p_pane = &pWnd4BM->a.a1.pane;
    p_trs = &pWnd4BM->_matrices.trs;
    for ( i = 0; i < v42; ++i )
    {
      if ( (double)v43 == v47.z )
      {
        v45 = i;
      }
      v47.x = v41 - v47.z * v47.z;
      if ( v47.x > 0.0 )
      {
        v47.x = sqrt(v47.x);
        v = v47;
        v30 = -v47.x;
        v22.x = v30;
        v22.y = v47.y;
        v22.z = v47.z;
        v31 = &v25;
        memset(&v19[2], 0, sizeof(T_Vector3D));
        v19[2].x = v47.x + v12->x;
        v19[2].y = v47.y + pWnd4BM->targetPosition.y;
        v13 = v47.z + pWnd4BM->targetPosition.z;
        v25 = v19[2];
        v19[2].z = v13;
        v = v19[2];
        memset(&v19[1], 0, sizeof(T_Vector3D));
        v32 = v19;
        v19[1].x = v30 + v12->x;
        v19[1].y = v47.y + pWnd4BM->targetPosition.y;
        v14 = v47.z + pWnd4BM->targetPosition.z;
        v19[0] = v19[1];
        v19[1].z = v14;
        v22 = v19[1];
        Q_M34xV_sub_53384(&v, p_trs, &result);
        v15 = p_trs;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->_matrices._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, &outX, &outY);
        Q_M34xV_sub_53384(&v22, v15, &result);
        v16 = v45;
        v17 = 0xFFFFFFFF;
        Q_Project3DTo2D_sub_533D4(&result, pWnd4BM->_matrices._scaleFactor, pWnd4BM->_xOffset, pWnd4BM->_yOffset, v52, &v49);
        if ( v16 < 0 || (i - v16) % 5 )
        {
          if ( v40 )
          {
            v17 = v36;
          }
        }
        else
        {
          v17 = parm;
        }
        if ( v17 != 0xFFFFFFFF )
        {
          VFX_line_draw(p_pane, outX, outY, v52[0], v49, 0, v17);
        }
      }
      v47.z = v47.z + -32.0;
    }
  }
}

//----- (00019AE8) --------------------------------------------------------
void __fastcall sub_19AE8(P_Wnd04BM a1)
{
  __int16 v1; // ax
  double v2; // st7
  __int16 type; // bx
  int i; // ebp
  float v5[100]; // [esp+8h] [ebp-384h]
  __int16 screenY[100]; // [esp+198h] [ebp-1F4h] BYREF
  __int16 screenX[100]; // [esp+260h] [ebp-12Ch] BYREF
  T_Vector3D v8; // [esp+328h] [ebp-64h] BYREF
  T_Vector3D v9; // [esp+334h] [ebp-58h] BYREF
  T_Vector3D starCoord; // [esp+340h] [ebp-4Ch] BYREF
  T_Vector3D *v11; // [esp+34Ch] [ebp-40h]
  T_Matrix3x3 *a2; // [esp+350h] [ebp-3Ch]
  PANE *pane; // [esp+354h] [ebp-38h]
  T_WndA2 *pWndA2; // [esp+358h] [ebp-34h]
  WORD *a6; // [esp+35Ch] [ebp-30h]
  WORD *a5; // [esp+360h] [ebp-2Ch]
  P_Wnd04BM v17; // [esp+364h] [ebp-28h]
  int v18; // [esp+368h] [ebp-24h]
  int v19; // [esp+36Ch] [ebp-20h]
  __int16 v20; // [esp+370h] [ebp-1Ch]

  v17 = a1;
  memset(&starCoord, 0, sizeof(starCoord));
  pWndA2 = WinMgr.wnds[dword_96BAC].pWndA2;
  if ( !pWndA2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\batmode.cpp", 0x8E7);
  }
  pane = &v17->a.a1.pane;
  a2 = &v17->_matrices.matrix_00;
  a5 = screenX;
  v18 = 0;
  a6 = screenY;
  for ( i = 0; i < V_Game.starsNum; ++i )
  {
    starCoord = V_Game.stars[i].pos;
    v11 = &v9;
    memset(&v8, 0, sizeof(v8));
    v8.x = starCoord.x - V_Game.pCurStar->pos.x;
    v8.y = starCoord.y - V_Game.pCurStar->pos.y;
    v2 = starCoord.z - V_Game.pCurStar->pos.z;
    v9 = v8;
    v8.z = v2;
    starCoord = v8;
    v5[i] = 0.0;
    if ( Q_IsZeroVector_sub_53078(&starCoord) == FALSE )
    {
      Q_M33xV_sub_53114(&starCoord, a2);
      v5[i] = starCoord.z;
      if ( v5[i] > 0.0 )
      {
        Q_Project3DTo2D_sub_533D4(&starCoord, v17->_matrices._scaleFactor, v17->_xOffset, v17->_yOffset, &screenX[i], &screenY[i]);
        type = V_Game.stars[i].type;
        v19 = (int)(sqrt(starCoord.y * starCoord.y + starCoord.x * starCoord.x + starCoord.z * starCoord.z) + -440.0);
        v20 = v19;
        v1 = 3;
        if ( (__int16)v19 <= 220 )
        {
          if ( v20 <= 0 )
          {
            if ( v20 > -220 )
            {
              v1 = 2;
            }
          }
          else
          {
            v1 = 1;
          }
        }
        else
        {
          v1 = 0;
        }
        VFX_shape_draw(pane, (void *)pWndA2[1].a1.magic12345678, v1 + 4 * type, screenX[i], screenY[i]);
      }
    }
  }
}
// 96BAC: using guessed type int dword_96BAC;
// 19AE8: using guessed type WORD screenY[100];
// 19AE8: using guessed type float var_384[100];

//----- (00019E2C) --------------------------------------------------------
void __fastcall sub_19E2C(P_Wnd04BM a1, P_CFile pfi, int read)
{
  T_Vector3D *v4; // edi
  int *v5; // edx
  T_Matrices *v6; // edx
  float *v7; // edx
  float *v8; // edx
  T_Matrices *v9; // edx
  T_Matrices *v10; // edx
  T_Matrix3x3 *v11; // edx
  float *v12; // edx
  float *v13; // edx
  T_Vector3D *v14; // edx
  T_Vector3D v15[100]; // [esp+0h] [ebp-3460h] BYREF
  char v16[3600]; // [esp+4B0h] [ebp-2FB0h] BYREF
  char v17[400]; // [esp+12C0h] [ebp-21A0h] BYREF
  T_Vector3D v18[100]; // [esp+1450h] [ebp-2010h] BYREF
  int v19; // [esp+1900h] [ebp-1B60h]
  int v20; // [esp+1904h] [ebp-1B5Ch]
  int v21; // [esp+1908h] [ebp-1B58h]
  T_Matrices v22; // [esp+190Ch] [ebp-1B54h] BYREF
  float x; // [esp+19A4h] [ebp-1ABCh]
  float y; // [esp+19A8h] [ebp-1AB8h]
  float z; // [esp+19ACh] [ebp-1AB4h]
  T_Vector3D vector1; // [esp+19B0h] [ebp-1AB0h] BYREF
  T_Vector3D v27; // [esp+19BCh] [ebp-1AA4h] BYREF
  T_Vector3D v28; // [esp+19C8h] [ebp-1A98h] BYREF
  float Unknown_4F0E; // [esp+19D4h] [ebp-1A8Ch]
  float Unknown_4F12; // [esp+19D8h] [ebp-1A88h]
  float Unknown_4F16; // [esp+19DCh] [ebp-1A84h]
  float Unknown_4F1A; // [esp+19E0h] [ebp-1A80h]
  int Unknown_4F1E; // [esp+19E4h] [ebp-1A7Ch]
  __int16 xOffset; // [esp+19E8h] [ebp-1A78h]
  __int16 yOffset; // [esp+19EAh] [ebp-1A76h]
  float Unknown_4F26; // [esp+19ECh] [ebp-1A74h]
  float Unknown_4F2A; // [esp+19F0h] [ebp-1A70h]
  int Unknown_503A; // [esp+19F4h] [ebp-1A6Ch]
  int Unknown_503E; // [esp+19F8h] [ebp-1A68h]
  int Unknown_5042; // [esp+19FCh] [ebp-1A64h]
  int Unknown_5046; // [esp+1A00h] [ebp-1A60h]
  int Unknown_504A; // [esp+1A04h] [ebp-1A5Ch]
  T_Vector3D vectors1[100]; // [esp+1A08h] [ebp-1A58h] BYREF
  T_Type16 type16s[100]; // [esp+1EB8h] [ebp-15A8h] BYREF
  char v45[400]; // [esp+2CC8h] [ebp-798h] BYREF
  T_Vector3D vectors2[100]; // [esp+2E58h] [ebp-608h] BYREF
  int v47; // [esp+3308h] [ebp-158h]
  int v48; // [esp+330Ch] [ebp-154h]
  int v49; // [esp+3310h] [ebp-150h]
  T_Matrices v50; // [esp+3314h] [ebp-14Ch] BYREF
  float v51; // [esp+33ACh] [ebp-B4h]
  float v52; // [esp+33B0h] [ebp-B0h]
  float v53; // [esp+33B4h] [ebp-ACh]
  T_Vector3D v54; // [esp+33B8h] [ebp-A8h] BYREF
  T_Vector3D v55; // [esp+33C4h] [ebp-9Ch] BYREF
  T_Vector3D v56; // [esp+33D0h] [ebp-90h] BYREF
  float v57; // [esp+33DCh] [ebp-84h]
  float v58; // [esp+33E0h] [ebp-80h]
  float v59; // [esp+33E4h] [ebp-7Ch]
  float v60; // [esp+33E8h] [ebp-78h]
  int v61; // [esp+33ECh] [ebp-74h]
  __int16 v62; // [esp+33F0h] [ebp-70h]
  __int16 v63; // [esp+33F2h] [ebp-6Eh]
  float v64; // [esp+33F4h] [ebp-6Ch]
  float v65; // [esp+33F8h] [ebp-68h]
  int v66; // [esp+33FCh] [ebp-64h]
  int v67; // [esp+3400h] [ebp-60h]
  int v68; // [esp+3404h] [ebp-5Ch]
  int v69; // [esp+3408h] [ebp-58h]
  int v70; // [esp+340Ch] [ebp-54h]
  P_CFile pfi_; // [esp+3410h] [ebp-50h]
  T_Type16 *someFloats; // [esp+3414h] [ebp-4Ch]
  int *Unknown_137E; // [esp+3418h] [ebp-48h]
  T_Vector3D *v74; // [esp+341Ch] [ebp-44h]
  float *v75; // [esp+3420h] [ebp-40h]
  float *v76; // [esp+3424h] [ebp-3Ch]
  T_Vector3D *p_vector2; // [esp+3428h] [ebp-38h]
  T_Vector3D *p_vector3; // [esp+342Ch] [ebp-34h]
  T_Vector3D *p_vector_34; // [esp+3430h] [ebp-30h]
  float *v80; // [esp+3434h] [ebp-2Ch]
  float *v81; // [esp+3438h] [ebp-28h]
  T_Matrix3x3D *p_matrix_4EEA; // [esp+343Ch] [ebp-24h]
  T_Vector3D *p_vector_4EDE; // [esp+3440h] [ebp-20h]
  T_Matrix3x3 *p_matrix_74; // [esp+3444h] [ebp-1Ch]
  int *p_targetPosition; // [esp+3448h] [ebp-18h]
  T_Matrices *p_matrices; // [esp+344Ch] [ebp-14h]

  pfi_ = pfi;
  p_matrix_4EEA = &a1->matrix_4EEA;
  p_vector_4EDE = &a1->vector_4EDE;
  p_matrices = &a1->_matrices;
  p_targetPosition = (int *)&a1->targetPosition;
  v74 = a1->vectors2;
  Unknown_137E = a1->Unknown_137E;
  v4 = a1->vectors1;
  someFloats = a1->someFloats;
  p_vector3 = &a1->matrix_4EEA.vector3;
  p_vector2 = &a1->matrix_4EEA.vector2;
  p_matrix_74 = &a1->_matrices.matrix_74;
  p_vector_34 = &a1->_matrices.vector_34;
  v80 = a1->_matrices.matrix_00._[2];
  v81 = a1->_matrices.matrix_00._[1];
  v76 = a1->_matrices.matrix_74._[2];
  v75 = a1->_matrices.matrix_74._[1];
  if ( read == TRUE )
  {
    _wcpp_2_ctor_array_(vectors1, 100u, &C_Vector3D);
    _wcpp_2_ctor_array_(type16s, 100u, &C_Type16);
    _wcpp_2_ctor_array_(vectors2, 100u, &C_Vector3D);
    v47 = 0;
    v48 = 0;
    v49 = 0;
    sub_1B4F0(&v50);
    v52 = 0.0;
    v53 = 0.0;
    v51 = 0.0;
    Q_Vector3D_Clear_sub_1ACA0(&v54);
    Q_Vector3D_Clear_sub_1ACA0(&v55);
    Q_Vector3D_Clear_sub_1ACA0(&v56);
    Q_Vector3D_FromInt_sub_1AC70(&v54, 1, 0, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v55, 0, 1, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v56, 0, 0, 1);
    Q_ReadFile_sub_1BF94(pfi_, vectors1, 0x1A08u);
    qmemcpy(v4, vectors1, 0x4B0u);
    qmemcpy(someFloats, type16s, 0xE10u);
    qmemcpy(Unknown_137E, v45, 0x190u);
    v5 = p_targetPosition;
    qmemcpy(v74, vectors2, 0x4B0u);
    *v5 = v47;
    v5[1] = v48;
    v5[2] = v49;
    v6 = p_matrices;
    p_matrices->matrix_00._[0][0] = v50.matrix_00._[0][0];
    v6->matrix_00._[0][1] = v50.matrix_00._[0][1];
    v6->matrix_00._[0][2] = v50.matrix_00._[0][2];
    v7 = v81;
    *v81 = v50.matrix_00._[1][0];
    v7[1] = v50.matrix_00._[1][1];
    v7[2] = v50.matrix_00._[1][2];
    v8 = v80;
    *v80 = v50.matrix_00._[2][0];
    v8[1] = v50.matrix_00._[2][1];
    v8[2] = v50.matrix_00._[2][2];
    v9 = p_matrices;
    p_matrices->Unknown_24 = v50.Unknown_24;
    v9->_scaleFactor = v50._scaleFactor;
    v9->Unknown_2C = v50.Unknown_2C;
    v9->Unknown_30 = v50.Unknown_30;
    *p_vector_34 = v50.vector_34;
    v10 = p_matrices;
    p_matrices->trs = v50.trs;
    v10->Unknown_70 = v50.Unknown_70;
    v11 = p_matrix_74;
    p_matrix_74->_[0][0] = v50.matrix_74._[0][0];
    v11->_[0][1] = v50.matrix_74._[0][1];
    v11->_[0][2] = v50.matrix_74._[0][2];
    v12 = v75;
    *v75 = v50.matrix_74._[1][0];
    v12[1] = v50.matrix_74._[1][1];
    v12[2] = v50.matrix_74._[1][2];
    v13 = v76;
    *v76 = v50.matrix_74._[2][0];
    v13[1] = v50.matrix_74._[2][1];
    v13[2] = v50.matrix_74._[2][2];
    v14 = p_vector_4EDE;
    p_vector_4EDE->x = v51;
    v14->y = v52;
    v14->z = v53;
    p_matrix_4EEA->vector1 = v54;
    *p_vector2 = v55;
    *p_vector3 = v56;
    a1->Unknown_4F0E = v57;
    a1->Unknown_4F12 = v58;
    a1->Unknown_4F16 = v59;
    a1->Unknown_4F1A = v60;
    a1->Unknown_4F1E = v61;
    a1->_xOffset = v62;
    a1->_yOffset = v63;
    a1->Unknown_4F26 = v64;
    a1->Unknown_4F2A = v65;
    a1->Unknown_503A = v66;
    a1->Unknown_503E = v67;
    a1->Unknown_5042 = v68;
    a1->Unknown_5046 = v69;
    a1->Unknown_504A = v70;
    Q_Ret_sub_1B66C();
    Q_DestructVectors_sub_1A9E0(vectors2);
    sub_1AA00(type16s);
    Q_DestructVectors_sub_1A9E0(vectors1);
  }
  else
  {
    _wcpp_2_ctor_array_(v15, 100u, &C_Vector3D);
    _wcpp_2_ctor_array_(v16, 100u, &C_Type16);
    _wcpp_2_ctor_array_(v18, 100u, &C_Vector3D);
    v19 = 0;
    v20 = 0;
    v21 = 0;
    sub_1B4F0(&v22);
    y = 0.0;
    z = 0.0;
    x = 0.0;
    Q_Vector3D_Clear_sub_1ACA0(&vector1);
    Q_Vector3D_Clear_sub_1ACA0(&v27);
    Q_Vector3D_Clear_sub_1ACA0(&v28);
    Q_Vector3D_FromInt_sub_1AC70(&vector1, 1, 0, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v27, 0, 1, 0);
    Q_Vector3D_FromInt_sub_1AC70(&v28, 0, 0, 1);
    qmemcpy(v15, v4, sizeof(v15));
    qmemcpy(v16, someFloats, sizeof(v16));
    qmemcpy(v17, Unknown_137E, sizeof(v17));
    qmemcpy(v18, v74, sizeof(v18));
    v19 = *p_targetPosition;
    v20 = p_targetPosition[1];
    v21 = p_targetPosition[2];
    v22.matrix_00._[0][0] = p_matrices->matrix_00._[0][0];
    v22.matrix_00._[0][1] = p_matrices->matrix_00._[0][1];
    v22.matrix_00._[0][2] = p_matrices->matrix_00._[0][2];
    v22.matrix_00._[1][0] = *v81;
    v22.matrix_00._[1][1] = v81[1];
    v22.matrix_00._[1][2] = v81[2];
    v22.matrix_00._[2][0] = *v80;
    v22.matrix_00._[2][1] = v80[1];
    v22.matrix_00._[2][2] = v80[2];
    v22.Unknown_24 = p_matrices->Unknown_24;
    v22._scaleFactor = p_matrices->_scaleFactor;
    v22.Unknown_2C = p_matrices->Unknown_2C;
    v22.Unknown_30 = p_matrices->Unknown_30;
    v22.vector_34 = *p_vector_34;
    v22.trs = p_matrices->trs;
    v22.Unknown_70 = p_matrices->Unknown_70;
    v22.matrix_74._[0][0] = p_matrix_74->_[0][0];
    v22.matrix_74._[0][1] = p_matrix_74->_[0][1];
    v22.matrix_74._[0][2] = p_matrix_74->_[0][2];
    v22.matrix_74._[1][0] = *v75;
    v22.matrix_74._[1][1] = v75[1];
    v22.matrix_74._[1][2] = v75[2];
    v22.matrix_74._[2][0] = *v76;
    v22.matrix_74._[2][1] = v76[1];
    v22.matrix_74._[2][2] = v76[2];
    x = p_vector_4EDE->x;
    y = p_vector_4EDE->y;
    z = p_vector_4EDE->z;
    vector1 = p_matrix_4EEA->vector1;
    v27 = *p_vector2;
    v28 = *p_vector3;
    Unknown_4F0E = a1->Unknown_4F0E;
    Unknown_4F12 = a1->Unknown_4F12;
    Unknown_4F16 = a1->Unknown_4F16;
    Unknown_4F1A = a1->Unknown_4F1A;
    Unknown_4F1E = a1->Unknown_4F1E;
    xOffset = a1->_xOffset;
    yOffset = a1->_yOffset;
    Unknown_4F26 = a1->Unknown_4F26;
    Unknown_4F2A = a1->Unknown_4F2A;
    Unknown_503A = a1->Unknown_503A;
    Unknown_503E = a1->Unknown_503E;
    Unknown_5042 = a1->Unknown_5042;
    Unknown_5046 = a1->Unknown_5046;
    Unknown_504A = a1->Unknown_504A;
    Q_CFile_DosWrite_sub_1C098(pfi_, v15, 0x1A08u);
    Q_Ret_sub_1B66C();
    Q_DestructVectors_sub_1A9E0(v18);
    sub_1AA00(v16);
    Q_DestructVectors_sub_1A9E0(v15);
  }
}

//----- (0001A9C0) --------------------------------------------------------
void *__fastcall sub_1A9C0(void *result)
{
  _wcpp_2_dtor_array_(result, 0xF, &C_Vector3D);
  return result;
}

//----- (0001A9E0) --------------------------------------------------------
void __fastcall __spoils<edx> Q_DestructVectors_sub_1A9E0(P_Vector3D a1)
{
  _wcpp_2_dtor_array_(a1, 100, &C_Vector3D);
}

//----- (0001AA00) --------------------------------------------------------
void *__fastcall sub_1AA00(void *result)
{
  _wcpp_2_dtor_array_(result, 100, &C_Type16);
  return result;
}

//----- (0001AA20) --------------------------------------------------------
void *__fastcall Q_NC_sub_1AA20(void *result)
{
  _wcpp_2_dtor_array_(result, 4, &C_Vector3D);
  return result;
}

//----- (0001AA40) --------------------------------------------------------
void __fastcall sub_1AA40(P_Type16 a1, P_Type16 a2)
{
  *a1 = *a2;
}

//----- (0001AA90) --------------------------------------------------------
T_Vector3D *__fastcall sub_1AA90(int a1)
{
  T_Vector3D *result; // eax

  Q_Ret_sub_1B66C();
  Q_DestructVectors_sub_1A9E0((P_Vector3D)(a1 + 0x1450));
  result = (T_Vector3D *)((char *)sub_1AA00((void *)(a1 - 0xFA0)) + 0xFFFFFB50);
  Q_DestructVectors_sub_1A9E0(result);
  return result;
}

//----- (0001AAC0) --------------------------------------------------------
_DWORD *__fastcall sub_1AAC0(_DWORD *result)
{
  _wcpp_2_ctor_array_(result, 100u, &C_Vector3D);
  _wcpp_2_ctor_array_(result + 0x12C, 100u, &C_Type16);
  _wcpp_2_ctor_array_(result + 0x514, 100u, &C_Vector3D);
  result[0x640] = 0;
  result[0x641] = 0;
  result[0x642] = 0;
  sub_1B4F0((P_Matrices)(result + 0x643));
  result[0x669] = 0;
  result[0x66A] = 0;
  result[0x66B] = 0;
  result[0x66C] = 0;
  result[0x66D] = 0;
  result[0x66E] = 0;
  result[0x66F] = 0;
  result[0x670] = 0;
  result[0x671] = 0;
  result[0x672] = 0;
  result[0x673] = 0;
  result[0x674] = 0;
  result[0x66D] = 0;
  result[0x66E] = 0;
  result[0x66C] = 0x3F800000;
  result[0x66F] = 0;
  result[0x670] = 0x3F800000;
  result[0x671] = 0;
  result[0x672] = 0;
  result[0x673] = 0;
  result[0x674] = 0x3F800000;
  return result;
}

//----- (0001ABE0) --------------------------------------------------------
void __fastcall __spoils<> sub_1ABE0(P_Type16 a1)
{
  a1->Unknown_00 = 0.0;
  a1->Unknown_04 = 0.0;
  a1->Unknown_08 = 0.0;
  a1->Unknown_0C = 0.0;
  a1->Unknown_10 = 0.0;
  a1->Unknown_14 = 0.0;
  a1->Unknown_18 = 0.0;
  a1->Unknown_1C = 0.0;
  a1->Unknown_20 = 0.0;
  a1->Unknown_04 = 0.0;
  a1->Unknown_08 = 0.0;
  a1->Unknown_00 = 1.0;
  a1->Unknown_0C = 0.0;
  a1->Unknown_10 = 1.0;
  a1->Unknown_14 = 0.0;
  a1->Unknown_18 = 0.0;
  a1->Unknown_1C = 0.0;
  a1->Unknown_20 = 1.0;
}

//----- (0001AC70) --------------------------------------------------------
void __fastcall Q_Vector3D_FromInt_sub_1AC70(P_Vector3D a1, int x, int y, int z)
{
  a1->x = (float)x;
  a1->y = (float)y;
  a1->z = (float)z;
}

//----- (0001ACA0) --------------------------------------------------------
void __fastcall Q_Vector3D_Clear_sub_1ACA0(P_Vector3D a1)
{
  a1->x = 0.0;
  a1->y = 0.0;
  a1->z = 0.0;
}

//----- (0001ACC0) --------------------------------------------------------
void __fastcall __spoils<> Q_Cache_Init_sub_1ACC0(P_Cache a1)
{
  a1->pShapeCache = 0;
  a1->size = 0;
  a1->count = 0;
  a1->activeCount = 0;
  sub_1ACE8(a1);
}

//----- (0001ACE8) --------------------------------------------------------
void __fastcall __spoils<> sub_1ACE8(P_Cache a1)
{
  a1->Unknown_2EEC = 0xFFFFFFFF;
}

//----- (0001ACF4) --------------------------------------------------------
void __fastcall __spoils<> sub_1ACF4(P_Cache a1)
{
  sub_262CC(a1->pShapeCache);
  a1->pShapeCache = 0;
  a1->size = 0;
}

//----- (0001AD1C) --------------------------------------------------------
void __fastcall Q_Cache_RegisterShapeCache_sub_1AD1C(P_Cache a1, int a2)
{
  void *v3; // eax
  int i; // kr04_4
  int size; // [esp+0h] [ebp-4h]

  size = a2 + 3;
  LOBYTE(size) = (a2 + 3) & 0xFC;
  v3 = operator new[](size);
  Q_RegisterData_sub_2625C(v3, 5, "SHAPE CACHE");
  a1->pShapeCache = v3;
  if ( !v3 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x41);
  }
  a1->count = 0;
  a1->activeCount = 0;
  a1->size = size;
  for ( i = 0; i != 0xC8; ++i )
  {
    a1->_pointers[i] = 0;
    a1->names[i][0] = 0;
    a1->sizes[i] = 0;
  }
}

//----- (0001ADAC) --------------------------------------------------------
int __fastcall Q_Cache_AddFile_sub_1ADAC(P_Cache pCache, const char *filename)
{
  unsigned int v4; // kr0C_4
  int index; // edx

  if ( !pCache->pShapeCache )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x53);
  }
  v4 = strlen(filename) + 1;
  if ( (int)(v4 - 1) <= 0 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x59);
  }
  if ( (int)(v4 - 1) >= 50 )
  {
    sub_2620C("Cache filename too long: %s", filename);
    Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0x5B);
  }
  if ( pCache->count >= 200 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x5C);
  }
  for ( index = 0; index < 200; ++index )
  {
    if ( !pCache->names[index][0] )
    {
      strcpy(pCache->names[index], filename);
      ++pCache->count;
      return index;
    }
  }
  return 0xFFFF;
}

//----- (0001AEB0) --------------------------------------------------------
unsigned int __fastcall sub_1AEB0(P_Cache pCache, UWORD index, char *filename)
{
  unsigned int v4; // kr08_4
  int index_; // eax
  unsigned int result; // eax

  if ( !pCache->pShapeCache )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x70);
  }
  v4 = strlen(filename) + 1;
  if ( (int)(v4 - 1) <= 0 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x74);
  }
  if ( (int)(v4 - 1) >= 50 )
  {
    sub_2620C("Cache filename too long: %s", filename);
    Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0x76);
  }
  if ( pCache->count >= 200 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x77);
  }
  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x78);
  }
  index_ = index;
  if ( pCache->names[index_][0] )
  {
    if ( !stricmp(filename, pCache->names[index_]) )
    {
      return 0xFFFFFFFF;
    }
    Q_Cache_RemoveItem_sub_1B000(pCache, index);
  }
  strcpy(pCache->names[index], filename);
  result = 0xFFFFFFFF;
  ++pCache->count;
  return result;
}

//----- (0001B000) --------------------------------------------------------
void __fastcall Q_Cache_RemoveItem_sub_1B000(P_Cache pCache, UWORD index)
{
  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x95);
  }
  if ( !pCache->names[index][0] )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0x96);
  }
  Q_Cache_RemoveEntry_sub_1B354(pCache, index);
  pCache->names[index][0] = 0;
  --pCache->count;
}

//----- (0001B084) --------------------------------------------------------
void *__fastcall Q_Cache_GetShapeTable_sub_1B084(P_Cache pCache, UWORD index)
{
  __int16 v4; // edx^2
  int fileLength; // eax
  int fileLength4; // ecx
  int v7; // ebx
  void *v8; // edx
  int activeCount; // ebx
  int j; // kr0C_4
  int i; // eax
  T_CFile fi; // [esp+0h] [ebp-12Ch] BYREF

  if ( !pCache->Unknown_2EEC )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0xA2);
  }
  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0xA6);
  }
  if ( !pCache->names[index][0] )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cache.cpp", 0xA7);
  }
  if ( pCache->_pointers[index] )
  {
    for ( i = 0; i < pCache->activeCount && index != pCache->usageOrder[i]; ++i )
    {
      ;
    }
    for ( j = 0; ; ++j )
    {
      activeCount = pCache->activeCount;
      if ( i + j >= activeCount )
      {
        break;
      }
      pCache->usageOrder[i + j] = pCache->usageOrder[i + 1 + j];
    }
    *((_WORD *)&pCache->sizes[199] + activeCount + 1) = index;
    return pCache->_pointers[index];
  }
  else
  {
    Q_CFile_Ctor_sub_1BB78(&fi);
    Q_CFile_OpenFile_sub_1BBFC(&fi, pCache->names[index], O_BINARY, 0);
    fileLength = Q_GetFileLength_sub_1BE28(&fi);
    fileLength4 = fileLength + 3;
    LOBYTE(fileLength4) = (fileLength + 3) & 0xFC;
    if ( fileLength4 >= pCache->size )
    {
      v4 = 0;
      sub_2620C("Single item too big for cache: %s, %d", pCache->names[index], fileLength4);
      Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0xB8);
    }
    v7 = index;
    pCache->_pointers[index] = sub_1B2DC(pCache, fileLength4);
    v8 = pCache->_pointers[index];
    pCache->sizes[index] = fileLength4;
    if ( !Q_CFile_Load_sub_1BF1C(&fi, v8) )
    {
      sub_2620C("Cache unable to load file: %s", pCache->names[v7]);
      Q_PrintFailAndExit_sub_261B8(0, "..\\cache.cpp", 0xC0);
    }
    pCache->usageOrder[pCache->activeCount++] = index;
    Q_CFile_Dtor_sub_1BBC8(&fi);
    return pCache->_pointers[index];
  }
}

//----- (0001B270) --------------------------------------------------------
int __fastcall Q_Cache_GetItemIndex_sub_1B270(P_Cache pCache, const char *filename, int addIfNotFound)
{
  T_Name50 *names; // kr00_4
  int i; // ecx
  int index; // [esp+0h] [ebp-14h]

  names = pCache->names;
  index = 0xFFFF;
  for ( i = 0; i < pCache->count; ++i )
  {
    if ( !stricmp(filename, names[i]) )
    {
      index = i;
      break;
    }
  }
  if ( addIfNotFound == TRUE && (unsigned __int16)index == 0xFFFF )
  {
    return Q_Cache_AddFile_sub_1ADAC(pCache, filename);
  }
  return index;
}

//----- (0001B2DC) --------------------------------------------------------
char *__fastcall sub_1B2DC(P_Cache a1, int size)
{
  int v4; // esi
  int i; // kr04_4
  char *result; // eax
  int v7; // esi
  UWORD v8; // dx
  int j; // edi

  v4 = 0;
  for ( i = 0; i != 0xC8; ++i )
  {
    v4 += a1->sizes[i];
  }
  result = (char *)a1->pShapeCache + v4;
  v7 = a1->size - v4;
  for ( j = 0; v7 <= size; result = Q_Cache_RemoveEntry_sub_1B354(a1, v8) )
  {
    if ( j >= a1->count )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0xFF);
    }
    v8 = a1->usageOrder[0];
    v7 += a1->sizes[v8];
    ++j;
  }
  return result;
}

//----- (0001B354) --------------------------------------------------------
// Removes a cache entry at the given index and compacts remaining data
// Returns pointer to the new end of used memory, or NULL if entry was empty
char *__fastcall Q_Cache_RemoveEntry_sub_1B354(P_Cache pCache, UWORD index)
{
  int totalUsedSize; // edx
  int i; // kr04_4
  void *freedPtr; // edx
  _BYTE *offsetPtr; // ebx
  int j; // kr0C_4
  int k; // kr1C_4
  int searchIndex; // eax
  void **entryPtr; // [esp+0h] [ebp-20h]
  char *oldMemEnd; // [esp+4h] [ebp-1Ch]
  char *newMemEnd; // [esp+4h] [ebp-1Ch]

  if ( index >= 200u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cache.cpp", 0x10D);
  }
  if ( !pCache->_pointers[index] )
  {
    return 0;
  }
  // Calculate total used size by summing all entry sizes
  totalUsedSize = 0;
  for ( i = 0; i != 0xC8; ++i )
  {
    totalUsedSize += pCache->sizes[i];
  }
  // Calculate current end of used memory
  oldMemEnd = (char *)pCache->pShapeCache + totalUsedSize;
  // Get references to the entry being removed
  entryPtr = &pCache->_pointers[index];
  freedPtr = *entryPtr;
  offsetPtr = entryPtr[200];
  // Compact memory: move data after our entry up to fill the gap
  qmemcpy(*entryPtr, &offsetPtr[(_DWORD)*entryPtr], oldMemEnd - &offsetPtr[(_DWORD)*entryPtr]);
  *entryPtr = 0;
  entryPtr[200] = 0;
  // Adjust pointers for entries that were after the removed one
  for ( j = 0; j != 0xC8; ++j )
  {
    if ( freedPtr < pCache->_pointers[j] )
    {
      // Shift pointer back by the size of removed entry
      pCache->_pointers[j] = (void *)((char *)pCache->_pointers[j] - offsetPtr);
    }
  }
  newMemEnd = (char *)(oldMemEnd - offsetPtr);
  // Decrement active entry counter
  --pCache->activeCount;
  // Find and remove the index from the usage tracking array
  for ( searchIndex = 0; searchIndex < pCache->activeCount && index != pCache->usageOrder[searchIndex]; ++searchIndex )
  {
    ;
  }
  // Shift remaining entries down to fill the gap
  for ( k = 0; searchIndex + k < pCache->activeCount; ++k )
  {
    pCache->usageOrder[searchIndex + k] = pCache->usageOrder[searchIndex + 1 + k];
  }
  return newMemEnd;
}

//----- (0001B498) --------------------------------------------------------
P_Cache __fastcall sub_1B498(P_Cache pCache)
{
  P_Cache v1; // ecx
  int i; // edx

  v1 = pCache;
  for ( i = 0; i < v1->count; ++i )
  {
    pCache->_pointers[0] = 0;
    pCache->sizes[0] = 0;
    pCache = (P_Cache)((char *)pCache + 4);
  }
  v1->activeCount = 0;
  return pCache;
}

//----- (0001B4D0) --------------------------------------------------------
_DWORD *__fastcall sub_1B4D0(P_Cache pCache)
{
  _DWORD *result; // eax

  result = sub_1B498(pCache);
  pCache->Unknown_2EEC = 0;
  return result;
}

//----- (0001B4F0) --------------------------------------------------------
void __fastcall __spoils<> sub_1B4F0(P_Matrices a1)
{
  a1->matrix_00._[0][0] = 0.0;
  a1->matrix_00._[0][1] = 0.0;
  a1->matrix_00._[0][2] = 0.0;
  a1->matrix_00._[1][0] = 0.0;
  a1->matrix_00._[1][1] = 0.0;
  a1->matrix_00._[1][2] = 0.0;
  a1->matrix_00._[2][0] = 0.0;
  a1->matrix_00._[2][1] = 0.0;
  a1->matrix_00._[2][2] = 0.0;
  a1->matrix_00._[0][1] = 0.0;
  a1->matrix_00._[0][2] = 0.0;
  a1->matrix_00._[0][0] = 1.0;
  a1->matrix_00._[1][0] = 0.0;
  a1->matrix_00._[1][1] = 1.0;
  a1->matrix_00._[1][2] = 0.0;
  a1->matrix_00._[2][0] = 0.0;
  a1->matrix_00._[2][1] = 0.0;
  a1->matrix_00._[2][2] = 1.0;
  a1->vector_34.x = 0.0;
  a1->vector_34.y = 0.0;
  a1->vector_34.z = 0.0;
  a1->trs._[2][2] = 1.0;
  a1->trs._[2][3] = 0.0;
  a1->trs._[1][1] = a1->trs._[2][2];
  a1->trs._[0][0] = a1->trs._[1][1];
  a1->trs._[2][1] = a1->trs._[2][3];
  a1->trs._[2][0] = a1->trs._[2][1];
  a1->trs._[1][3] = a1->trs._[2][0];
  a1->trs._[1][2] = a1->trs._[1][3];
  a1->trs._[1][0] = a1->trs._[1][2];
  a1->trs._[0][3] = a1->trs._[1][0];
  a1->trs._[0][2] = a1->trs._[0][3];
  a1->trs._[0][1] = a1->trs._[0][2];
  a1->matrix_74._[0][0] = 0.0;
  a1->matrix_74._[0][1] = 0.0;
  a1->matrix_74._[0][2] = 0.0;
  a1->matrix_74._[1][0] = 0.0;
  a1->matrix_74._[1][1] = 0.0;
  a1->matrix_74._[1][2] = 0.0;
  a1->matrix_74._[2][1] = 0.0;
  a1->matrix_74._[2][2] = 0.0;
  a1->matrix_74._[2][0] = 0.0;
  a1->matrix_74._[0][0] = 1.0;
  a1->matrix_74._[0][1] = 0.0;
  a1->matrix_74._[0][2] = 0.0;
  a1->matrix_74._[1][0] = 0.0;
  a1->matrix_74._[1][1] = 1.0;
  a1->matrix_74._[1][2] = 0.0;
  a1->matrix_74._[2][0] = 0.0;
  a1->matrix_74._[2][1] = 0.0;
  a1->matrix_74._[2][2] = 1.0;
}

//----- (0001B670) --------------------------------------------------------
_DWORD *__fastcall Q_NC_sub_1B670(_DWORD *a1, int a2, int a3, int a4, int a5, int a6, int a7, int a8)
{
  *a1 = 0;
  a1[1] = 0;
  a1[2] = 0;
  a1[3] = 0;
  a1[4] = 0;
  a1[5] = 0;
  a1[6] = 0;
  a1[7] = 0;
  a1[8] = 0;
  a1[1] = 0;
  a1[2] = 0;
  *a1 = 0x3F800000;
  a1[3] = 0;
  a1[4] = 0x3F800000;
  a1[5] = 0;
  a1[6] = 0;
  a1[7] = 0;
  a1[8] = 0x3F800000;
  a1[0xD] = 0;
  a1[0xE] = 0;
  a1[0xF] = 0;
  a1[0x1A] = 0x3F800000;
  a1[0x1B] = 0;
  a1[0x15] = a1[0x1A];
  a1[0x10] = a1[0x15];
  a1[0x19] = a1[0x1B];
  a1[0x18] = a1[0x19];
  a1[0x17] = a1[0x18];
  a1[0x16] = a1[0x17];
  a1[0x14] = a1[0x16];
  a1[0x13] = a1[0x14];
  a1[0x12] = a1[0x13];
  a1[0x11] = a1[0x12];
  a1[0x1D] = 0;
  a1[0x1E] = 0;
  a1[0x1F] = 0;
  a1[0x20] = 0;
  a1[0x21] = 0;
  a1[0x22] = 0;
  a1[0x24] = 0;
  a1[0x25] = 0;
  a1[0x23] = 0;
  a1[0x1D] = 0x3F800000;
  a1[0x1E] = 0;
  a1[0x1F] = 0;
  a1[0x20] = 0;
  a1[0x21] = 0x3F800000;
  a1[0x22] = 0;
  a1[0x23] = 0;
  a1[0x24] = 0;
  a1[0x25] = 0x3F800000;
  sub_1B808((P_Matrices)a1, *(float *)&a5, *(float *)&a6, *(float *)&a7, a8);
  return a1;
}

//----- (0001B808) --------------------------------------------------------
void __userpurge sub_1B808(P_Matrices a1@<eax>, float a2, float a3, float a4, int a5)
{
  a1->Unknown_24 = a2;
  a1->Unknown_2C = a3;
  a1->Unknown_30 = a4;
  a1->Unknown_70 = 1.0;
  sub_1B834(a1, a5);
}

//----- (0001B834) --------------------------------------------------------
void __fastcall sub_1B834(P_Matrices a1, int a2)
{
  a1->_scaleFactor = (double)a2 / tan(a1->Unknown_24 * 0.017453292 * 0.5);
}

//----- (0001B864) --------------------------------------------------------
void __fastcall __spoils<> sub_1B864(P_Matrices a1)
{
  double v1; // st7
  T_Matrix3x3 matrix_74; // [esp+0h] [ebp-70h] BYREF
  T_Matrix3x3 a; // [esp+24h] [ebp-4Ch] BYREF
  T_Vector3D v4; // [esp+48h] [ebp-28h] BYREF
  T_Vector3D v; // [esp+54h] [ebp-1Ch] BYREF
  T_Vector3D *p_v; // [esp+60h] [ebp-10h]

  p_v = &v;
  memset(&v4, 0, sizeof(v4));
  v4.x = -a1->vector_34.x;
  v4.y = -a1->vector_34.y;
  v1 = -a1->vector_34.z;
  v = v4;
  v4.z = v1;
  matrix_74 = a1->matrix_74;
  a = a1->matrix_00;
  sub_53B08(&a1->trs, &a, &matrix_74, &v);
}

//----- (0001B958) --------------------------------------------------------
void __fastcall __spoils<> sub_1B958(P_Matrices a1, P_Vector3D v)
{
  T_Matrix3x3 m2; // [esp+0h] [ebp-88h] BYREF
  T_Matrix3x3 m1; // [esp+24h] [ebp-64h] BYREF
  T_Vector3D vector4; // [esp+48h] [ebp-40h] BYREF
  T_Vector3D vector3; // [esp+54h] [ebp-34h]
  T_Vector3D vector2; // [esp+60h] [ebp-28h] BYREF
  T_Vector3D vector1; // [esp+6Ch] [ebp-1Ch] BYREF
  P_Vector3D pVector2; // [esp+78h] [ebp-10h]
  P_Vector3D pVector1; // [esp+7Ch] [ebp-Ch]

  pVector2 = &vector4;
  memset(&vector2, 0, sizeof(vector2));
  vector2.x = v->x + a1->vector_34.x;
  vector2.y = v->y + a1->vector_34.y;
  vector2.z = v->z + a1->vector_34.z;
  vector4 = vector2;
  vector3.x = -vector2.x;
  vector3.y = -vector2.y;
  pVector1 = &vector1;
  vector1 = vector3;
  vector3.z = -vector2.z;
  m1 = a1->matrix_74;
  m2 = a1->matrix_00;
  sub_53B08(&a1->trs, &m2, &m1, &vector1);
}

//----- (0001BA90) --------------------------------------------------------
void __fastcall Q_NC_sub_1BA90(float *a1, int a2, int a3, int a4, int a5)
{
  sub_5323C((P_Vector3D)(a1 + 0xD), *(float *)&a5);
  sub_5353C(a1, (int)a1, a3, a4, a5);
}

//----- (0001BAB0) --------------------------------------------------------
void __fastcall Q_NC_sub_1BAB0(int a1, int a2, int a3, int a4, float degrees)
{
  Q_RotateVectorY_sub_532AC((T_Vector3D *)(a1 + 0x34), degrees);
  sub_53564((float *)a1, a1, a3, a4, SLODWORD(degrees));
}

//----- (0001BAF0) --------------------------------------------------------
void __fastcall sub_1BAF0(P_Matrices a1, float a2)
{
  Q_RotateVectorY_sub_532AC(&a1->vector_34, a2);
  sub_535E4(a1, a2);
}

//----- (0001BB10) --------------------------------------------------------
FILE *__fastcall Q_OpenFile_sub_1BB10(const char *aFName, fpos_t *endOffset)
{
  FILE *v2; // eax
  FILE *v3; // edi
  T_CFile v1; // [esp+0h] [ebp-128h] BYREF

  Q_CFile_Ctor_sub_1BB78(&v1);
  Q_CFile_OpenFile_sub_1BBFC(&v1, aFName, O_TEXT, FALSE);
  v2 = fdopen(v1.fh, "r");
  v3 = v2;
  if ( endOffset )
  {
    fgetpos(v2, endOffset);
    *endOffset += Q_GetFileLength_sub_1BE28(&v1);
  }
  v1.fh = 0xFFFFFFFF;
  Q_CFile_Dtor_sub_1BBC8(&v1);
  return v3;
}
// 1BB10: using guessed type T_CFile v1;

//----- (0001BB78) --------------------------------------------------------
void __fastcall __spoils<> Q_CFile_Ctor_sub_1BB78(P_CFile pCFile)
{
  if ( !V_CobFilesLoaded )
  {
    Q_CobFilesLoad_sub_1C3C4(&V_CobFiles);
    V_CobFilesLoaded = TRUE;
  }
  pCFile->fh = 0xFFFFFFFF;
  pCFile->fname[0] = 0;
  pCFile->d = 0;
  pCFile->Unknown_110 = 0;
  pCFile->index = 0xFFFFFFFF;
}
// 9A250: using guessed type int V_CobFilesLoaded;

//----- (0001BBC8) --------------------------------------------------------
void __fastcall __spoils<> Q_CFile_Dtor_sub_1BBC8(P_CFile pCFile)
{
  Q_CFile_Close_sub_1BE00(pCFile);
  if ( pCFile->Unknown_110 == 0xFFFFFFFF && pCFile->d )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(pCFile->d);
  }
  operator delete[](pCFile->d);
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0001BBFC) --------------------------------------------------------
BOOL __fastcall Q_CFile_OpenFile_sub_1BBFC(P_CFile pCFile, const char *filename, int oflags, int preload)
{
  BOOL result; // eax
  int len; // eax
  ULONG v7; // ecx
  void *pData; // eax

  if ( pCFile->fh != 0xFFFFFFFF )
  {
    Q_CFile_Close_sub_1BE00(pCFile);
  }
  pCFile->Unknown_110 = 0;
  strncpy(pCFile->fname, filename, 0x100u);
  pCFile->fname[0xFF] = 0;
  result = Q_CFILE_CPP_OpenFile_sub_1BCBC(pCFile, oflags);
  if ( !result )
  {
    if ( preload == TRUE )
    {
      len = filelength(pCFile->fh);
      v7 = len;
      if ( len > 0 )
      {
        pData = operator new[](len);
        Q_RegisterData_sub_2625C(pData, 1, "CFILE PRELOAD");
        pCFile->d = pData;
        if ( pData )
        {
          if ( !Q_ReadFile_sub_1BF94(pCFile, pData, v7) )
          {
            pCFile->Unknown_110 = 0xFFFFFFFF;
            return 0;
          }
          Q_RemoveWinDataFromWinMgr_sub_2627C(pCFile->d);
          operator delete[](pCFile->d);
          pCFile->d = 0;
        }
      }
    }
    return 0;
  }
  return result;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0001BCA8) --------------------------------------------------------
BOOL __fastcall Q_OpenFile_sub_1BCA8(T_CFile *a1, const char *a2)
{
  return Q_CFile_OpenFile_sub_1BBFC(a1, a2, O_CREAT|O_WRONLY, 0);
}

//----- (0001BCBC) --------------------------------------------------------
BOOL __fastcall Q_CFILE_CPP_OpenFile_sub_1BCBC(P_CFile pCFile, int oflags)
{
  int fh; // eax MAPDST
  int cindex_1; // edi
  int v4; // ecx
  int cindex; // esi
  MACRO_VFX_BOOL found; // [esp+0h] [ebp-20h]
  int oflag; // [esp+4h] [ebp-1Ch]

  oflag = oflags;
  if ( pCFile->fh != 0xFFFFFFFF )
  {
    Q_CFile_Close_sub_1BE00(pCFile);
  }
  if ( (oflags & O_CREAT) != 0 )
  {
    LOWORD(oflag) = oflags | O_BINARY|O_TRUNC;
    fh = open(pCFile->fname, oflag, S_IREADWRITE);
LABEL_19:
    pCFile->fh = fh;
    goto LABEL_20;
  }
  found = FALSE;
  if ( (oflags & (O_RDWR|O_WRONLY)) == 0 && V_CobFiles.totalfiles > 0 )
  {
    cindex_1 = 0;
    cindex = 0;
    v4 = 0;
    while ( 1 )
    {
      if ( v4 == V_CobFiles.nextcobstart[cindex] )
      {
        ++cindex;
        ++cindex_1;
      }
      if ( !stricmp(pCFile->fname, V_CobFiles.fnames[v4]) )
      {
        break;
      }
      if ( ++v4 >= V_CobFiles.totalfiles )
      {
        goto LABEL_17;
      }
    }
    pCFile->index = v4;
    fh = open(V_CobFiles.cobnames[cindex_1], oflags);
    pCFile->fh = fh;
    if ( fh == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cfile.cpp", 0xC4);
    }
    lseek(pCFile->fh, V_CobFiles.foffsets[v4], SEEK_SET);
    found = TRUE;
  }
LABEL_17:
  if ( found == FALSE )
  {
    fh = open(pCFile->fname, oflags);
    goto LABEL_19;
  }
LABEL_20:
  pCFile->d4 = oflag;
  return pCFile->fh == 0xFFFFFFFF;
}

//----- (0001BE00) --------------------------------------------------------
int __fastcall Q_CFile_Close_sub_1BE00(P_CFile a1)
{
  int v3; // ebx

  if ( a1->fh == 0xFFFFFFFF )
  {
    return 0;
  }
  v3 = close(a1->fh);
  if ( !v3 )
  {
    a1->fh = 0xFFFFFFFF;
  }
  return v3;
}

//----- (0001BE28) --------------------------------------------------------
int __fastcall Q_GetFileLength_sub_1BE28(P_CFile a1)
{
  int index; // ecx
  int offset; // esi
  int v4; // kr04_4

  if ( a1->fh == 0xFFFFFFFF )
  {
    return 0xFFFFFFFF;
  }
  index = a1->index;
  if ( index == 0xFFFFFFFF )
  {
    // A separate file
    return filelength(a1->fh);
  }
  offset = V_CobFiles.foffsets[index + 1];
  if ( V_CobFiles.totalcobs > 0 )
  {
    v4 = 0;
    do
    {
      if ( V_CobFiles.nextcobstart[v4] - 1 == a1->index )
      {
        offset = V_CobFiles.coblengths[v4];
      }
      ++v4;
    }
    while ( v4 < V_CobFiles.totalcobs );
  }
  return offset - V_CobFiles.foffsets[index];
}

//----- (0001BEA0) --------------------------------------------------------
int __fastcall Q_GetFilePos_sub_1BEA0(P_CFile a1)
{
  int fpos; // eax
  int v3; // ebx
  int index; // ecx

  fpos = tell(a1->fh);
  v3 = fpos;
  if ( fpos != 0xFFFFFFFF )
  {
    index = a1->index;
    if ( index != 0xFFFFFFFF )
    {
      return fpos - V_CobFiles.foffsets[index];
    }
  }
  return v3;
}

//----- (0001BECC) --------------------------------------------------------
int __fastcall sub_1BECC(int *a1, int offset, int a3)
{
  int v3; // esi
  int v4; // ecx

  if ( a1[0x44] && a3 != 0xFFFFFFFF )
  {
    return offset + a1[0x43];
  }
  v3 = a1[0x42];
  v4 = offset;
  if ( v3 != 0xFFFFFFFF )
  {
    v4 = offset + V_CobFiles.foffsets[v3];
  }
  return lseek(*a1, v4, 0);
}

//----- (0001BF0C) --------------------------------------------------------
int __fastcall Q_SetFilePos_sub_1BF0C(P_CFile a1, int offset)
{
  return lseek(a1->fh, offset, SEEK_CUR);
}

//----- (0001BF1C) --------------------------------------------------------
void *__fastcall Q_CFile_Load_sub_1BF1C(P_CFile pCFile, void *a2)
{
  void *v3; // ecx
  int FileLength_sub_1BE28; // eax
  ULONG v5; // edi
  unsigned int v6; // ebp
  void *result; // eax

  v3 = a2;
  if ( pCFile->fh != 0xFFFFFFFF )
  {
    FileLength_sub_1BE28 = Q_GetFileLength_sub_1BE28(pCFile);
    v5 = FileLength_sub_1BE28;
    if ( FileLength_sub_1BE28 > 0 )
    {
      v6 = 0;
      if ( !a2 )
      {
        result = operator new[](FileLength_sub_1BE28);
        Q_RegisterData_sub_2625C(result, 5, "CFILE LOAD");
        v3 = result;
        if ( !result )
        {
          return result;
        }
        v6 = 0xFFFFFFFF;
      }
      if ( Q_ReadFile_sub_1BF94(pCFile, v3, v5) == v5 )
      {
        return v3;
      }
      if ( v6 == 0xFFFFFFFF )
      {
        Q_RemoveWinDataFromWinMgr_sub_2627C(v3);
      }
      operator delete[](v3);
      _get_errno_ptr();
    }
  }
  return 0;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0001BF94) --------------------------------------------------------
int __fastcall Q_ReadFile_sub_1BF94(P_CFile pfi, void *pBuf, ULONG aReadLen)
{
  int index; // esi
  int pos; // esi
  unsigned int filelength; // eax

  index = pfi->index;
  if ( index != 0xFFFFFFFF )
  {
    pos = tell(pfi->fh) - V_CobFiles.foffsets[index];
    filelength = Q_GetFileLength_sub_1BE28(pfi);
    if ( pos + aReadLen > filelength )
    {
      aReadLen = filelength - pos;
    }
  }
  return read(pfi->fh, pBuf, aReadLen);
}

//----- (0001BFD4) --------------------------------------------------------
unsigned int __fastcall sub_1BFD4(int *a1, void *buf, unsigned int a3, unsigned int a4, int a5)
{
  void *v6; // ebx
  unsigned int v7; // edx
  unsigned int result; // eax
  int v9; // kr04_4
  unsigned int v10; // ebp
  unsigned int v12; // [esp+4h] [ebp-1Ch]
  unsigned int len; // [esp+Ch] [ebp-14h]
  int v15; // [esp+10h] [ebp-10h]

  len = a3 / a4;
  v15 = 0;
  v12 = a4 - 1;
  v10 = 0;
  if ( a4 == 1 )
  {
LABEL_9:
    result = read(*a1, buf, a3 - v15);
    if ( result != 0xFFFFFFFF )
    {
      v15 += result;
      ((void (*)(void))a5)();
      return v15;
    }
  }
  else
  {
    while ( 1 )
    {
      result = read(*a1, buf, len);
      if ( result == 0xFFFFFFFF )
      {
        break;
      }
      v15 += result;
      if ( result < len )
      {
        v9 = 0;
        if ( v10 < a4 )
        {
          do
          {
            ((void (__fastcall *)(unsigned int, unsigned int, _DWORD, unsigned int))a5)(a4, v10 + v9, 0, v10 + v9 + 1);
            ++v9;
          }
          while ( v10 + v9 < a4 );
        }
        return v15;
      }
      v6 = buf;
      v7 = v10++;
      buf = (char *)buf + result;
      ((void (__fastcall *)(unsigned int, unsigned int, void *, unsigned int))a5)(a4, v7, v6, v12);
      if ( v10 >= v12 )
      {
        goto LABEL_9;
      }
    }
  }
  return result;
}

//----- (0001C098) --------------------------------------------------------
unsigned int __fastcall Q_CFile_DosWrite_sub_1C098(P_CFile pCFile, void *buf, unsigned int size)
{
  unsigned int size_; // edi
  unsigned int chunksize; // esi
  int handle; // eax
  unsigned int result; // eax
  unsigned int byteswritten; // [esp+0h] [ebp-20h] BYREF
  P_CFile pcfile_; // [esp+4h] [ebp-1Ch]
  unsigned int v10; // [esp+8h] [ebp-18h]
  unsigned int v11; // [esp+Ch] [ebp-14h]

  pcfile_ = pCFile;
  size_ = size;
  if ( !size )
  {
    return v10;
  }
  while ( 1 )
  {
    chunksize = size_ <= 0xFFF0 ? size_ : 0xFFF0;
    handle = pcfile_->fh;
    v11 = chunksize;
    result = dos_write(handle, buf, chunksize, &byteswritten);
    v10 = result;
    if ( result )
    {
      break;
    }
    if ( chunksize != byteswritten )
    {
      _assert(0, "chunksize==byteswritten", "..\\cfile.cpp", 0x244);
    }
    buf = (char *)buf + v11;
    size_ -= v11;
    if ( !size_ )
    {
      return v10;
    }
  }
  return result;
}

//----- (0001C278) --------------------------------------------------------
void __fastcall Q_CFILE_CPP_IndexOneCob_sub_1C278(P_CobFiles a1, char *CobFileName)
{
  int totalcobs; // ebx
  int fh; // edi MAPDST
  int totalfiles; // edx
  int firstfileindex; // esi
  int filesInCob; // [esp+0h] [ebp-18h] BYREF

  if ( a1->totalcobs >= 5 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cfile.cpp", 0x28C);
  }
  totalcobs = a1->totalcobs;
  if ( totalcobs < 5 )
  {
    strncpy(a1->cobnames[totalcobs], CobFileName, 50u);
    fh = open(CobFileName, O_BINARY);
    if ( fh != 0xFFFFFFFF )
    {
      a1->coblengths[a1->totalcobs] = filelength(fh);
      read(fh, &filesInCob, 4u);
      if ( 500 - a1->totalfiles < filesInCob )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cfile.cpp", 0x2A0);
      }
      totalfiles = a1->totalfiles;
      if ( 500 - totalfiles >= filesInCob )
      {
        read(fh, a1->fnames[totalfiles], 50 * filesInCob);
        read(fh, &a1->foffsets[a1->totalfiles], 4 * filesInCob);
        close(fh);
        firstfileindex = filesInCob + a1->totalfiles;
        a1->nextcobstart[a1->totalcobs] = firstfileindex;
        a1->totalfiles = firstfileindex;
        ++a1->totalcobs;
      }
    }
  }
}

//----- (0001C3C4) --------------------------------------------------------
void __fastcall Q_CobFilesLoad_sub_1C3C4(P_CobFiles a1)
{
  FILE *v2; // ecx
  char v3[100]; // [esp+0h] [ebp-64h] BYREF

  v2 = fopen("cob.cfg", "r");
  if ( v2 )
  {
    while ( fscanf(v2, "%s", v3) != 0xFFFFFFFF )
    {
      Q_CFILE_CPP_IndexOneCob_sub_1C278(a1, v3);
    }
    fclose(v2);
  }
}
// 1C3C4: using guessed type char anonymous_0[100];

//----- (0001C410) --------------------------------------------------------
void Q_AtExitFunc_sub_1C410(void)
{
  Q_StopSystems_sub_26160();
  UVB_sub_7501C();
}

//----- (0001C424) --------------------------------------------------------
int __fastcall main(int argc, char *argv[])
{
  clock_t v3; // edx
  char *sub_1CEA8; // kr00_4
  char *v5; // eax
  int v6; // eax
  int v7; // edx
  char *v8; // eax
  char *v9; // eax
  BOOL v10; // edx
  char *v11; // kr08_4
  int v12; // eax
  char *v13; // eax
  UBYTE *v14; // ebx
  FILE *fp; // eax MAPDST
  char *v17; // kr10_4
  unsigned int v18; // eax
  FILE *v20; // edi
  int i; // esi
  int v22; // kr1C_4
  int result; // eax
  int v24; // [esp-4h] [ebp-574h]
  int v25; // [esp-4h] [ebp-574h]
  T_Palette black_palette; // [esp+0h] [ebp-570h] BYREF
  T_CFile v1Type1; // [esp+300h] [ebp-270h] BYREF
  T_CFile v1; // [esp+418h] [ebp-158h] BYREF
  char tmp; // [esp+530h] [ebp-40h] BYREF
  int stars; // [esp+544h] [ebp-2Ch] BYREF
  __int16 num; // [esp+548h] [ebp-28h] BYREF
  int races; // [esp+54Ch] [ebp-24h] BYREF
  unsigned int seed; // [esp+550h] [ebp-20h] BYREF
  MACRO_VFX_BOOL forceUNIVBE; // [esp+554h] [ebp-1Ch]
  char **__attribute__((__org_arrdim(0,0))) v48; // [esp+558h] [ebp-18h]

  v48 = argv;
  v3 = clock();
  printf("\nAscendancy\nCopyright (c) 1995 The Logic Factory, Inc.\nAll rights reserved\n");
  while ( clock() - v3 < 0xFA )
  {
    ;
  }
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAB);
  strcpy("Thank you for playing Ascendancy.", sub_1CEA8);
  atexit(Q_AtExitFunc_sub_1C410);
  if ( argc > 1 && *v48[1] == 'v' )
  {
    v24 = off_964E0;
    v5 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAC);     // 172: "\n\nAscendancy version %s\n\n"
    printf(v5, v24);
    getch();
  }
  forceUNIVBE = FALSE;
  if ( argc > 1 && *v48[1] == 'u' )
  {
    forceUNIVBE = TRUE;
  }
  v6 = Q_CheckFreeMemory_sub_53DEC();
  v7 = v6;
  if ( argc > 1 && *v48[1] == 'm' )
  {
    v25 = v6;
    v8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAD);     // 173: "\n\nFree memory: %ld\n\n"
    printf(v8, v25);
    getch();
  }
  if ( v7 < 0x300000 )
  {
    v9 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAE);     // 174: "Your computer does not have enough free extended memory to run\n
                                                       // Ascendancy.  You will need an additional %ldK bytes of free extended memory."
    sprintf("Thank you for playing Ascendancy.", v9, (0x300000 - v7) / 0x400 + 1);
    exit(1);
  }
  Q_CFile_Ctor_sub_1BB78(&v1Type1);
  v10 = Q_CFile_OpenFile_sub_1BBFC(&v1Type1, "data\\theme00.raw", O_BINARY, 0);
  Q_CFile_Close_sub_1BE00(&v1Type1);
  if ( v10 )
  {
    v11 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAF);
    strcpy("Thank you for playing Ascendancy.", v11);
    exit(1);
  }
  Q_CFile_Dtor_sub_1BBC8(&v1Type1);
  v12 = sub_53D22(0x101);
  if ( (!v12 || forceUNIVBE == TRUE) && !UVB_sub_75098(v12, 0, 0, O_BINARY, ".\\", 1) )
  {
    v13 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xB0);    // 176: "\n\nAscendancy was unable to find VESA support for your\n
                                                       // video card.  To configure the VESA driver that comes with\n
                                                       // Ascendancy, run the UVCONFIG program in this directory, and\n
                                                       // then try running Ascendancy again.  If this solution does\n
                                                       // not work, you may have to install the VESA driver supplied\n
                                                       // with your video card.  Consult your video card documentation\n
                                                       // for further information."
    printf(v13);
    aThank[0] = 0;
    exit(1);
  }
  if ( !sub_2BD88(&V_Type6_stru_D8654, "DATA", "VESA480.DLL", 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\corn.cpp", 0x9B);
  }
  VFX_area_wipe(0, 0, 639, 479, 0);
  Q_LoadPal_sub_2C158(&V_Type6_stru_D8654, "data\\logo.pal", 0, 256u);
  memset(black_palette, 0, sizeof(black_palette));
  Q_PaletteSet_sub_2C224(&V_Type6_stru_D8654, 0, 256, black_palette);
  Q_CFile_Ctor_sub_1BB78(&v1);
  Q_CFile_OpenFile_sub_1BBFC(&v1, "data\\logo.gif", O_BINARY, 0);
  v14 = &V_BigBuffer[Q_GetFileLength_sub_1BE28(&v1)];
  Q_CFile_Load_sub_1BF1C(&v1, V_BigBuffer);
  VFX_GIF_draw(&V_Type6_stru_D8654.pane, V_BigBuffer, v14);
  VFX_pane_refresh(&V_Type6_stru_D8654.pane, 0, 0, 0x27F, 0x1DF);
  VFX_window_fade(&V_Type6_stru_D8654.window, V_Type6_stru_D8654.palette2, 25);
  if ( Q_StartSoundSystem_sub_4EFB0(&V_SoundSystem, TRUE, FALSE) )
  {
    if ( V_SoundSystem.DIG_installed == TRUE && !Q_LoadMusic_sub_4F65C(&V_SoundSystem, "music.txt") )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xBB);
    }
  }
  else
  {
    Q_SetNoSound_sub_4FF08(&V_SoundSystem);
  }
  fp = fopen("nougat.lf", "r");
  if ( fp )
  {
    V_NougatLfExists_dword_A0CFC = TRUE;
    fclose(fp);
  }
  fp = fopen("flash.pop", "r");
  if ( fp )
  {
    V_FlashPopExists = TRUE;
    fclose(fp);
  }
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xD8);
  }
  if ( Q_WINMGR_CPP_StartTimer_sub_545EC(&WinMgr) != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\corn.cpp", 0xE1);
  }
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xE3);
  }
  if ( !Q_StartMouse_sub_2633C() )
  {
    v17 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xB1);
    strcpy("Thank you for playing Ascendancy.", v17);
    exit(1);
  }
  Q_GSYSTEM_CPP_PreloadMouseShp_sub_2C744(&V_Type6_stru_D8654);
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0xEE);
  }
  v18 = time(0);
  srand(v18);
  sub_1CF14(0);
  fp = fopen("cosmos.txt", "r");
  v20 = fp;
  if ( fp )
  {
    fscanf(fp, "%s %d %s %d %s %d", &tmp, &stars, &tmp, &races, &tmp, &seed);
    i = 0;
    if ( seed != -1u )
    {
      srand(seed);
    }
    sub_1E10C(&V_Game, stars, races, 0);
    sub_1F404(&V_Game);
    v22 = 0;
    while ( fscanf(v20, "%d", &num) != 0xFFFFFFFF && i < races )
    {
      ++i;
      *((_BYTE *)&V_StaticStrings_dword_A0D04 + 0x1EE * v22++ + 0x226F) = num;
    }
    fclose(v20);
  }
  else
  {
    sub_1E10C(&V_Game, 50, 7, 0);
    sub_1F404(&V_Game);
  }
  sub_1EE08((int)&V_Game, 0);
  if ( access("resume.gam", 0) )
  {
    sub_1F038(&V_Game);
  }
  WinMgr.window = (WINDOW *)&V_Type6_stru_D8654;
  sub_575BC(&WinMgr);
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x11F);
  }
  sub_1EEA4(&V_Game);
  Q_SetProc1_sub_574F0(&WinMgr, 0, Q_Proc_sub_1CC94);
  Q_SetProc1_sub_574F0(&WinMgr, 1, Q_Proc_sub_5A320);
  Q_SetProc2_sub_57510(&WinMgr, 1, Q_Proc_sub_22468);
  Q_SetProc1_sub_574F0(&WinMgr, 2, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 3, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 4, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 7, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 8, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 9, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0xA, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0xC, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0xD, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0xE, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0xF, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0x10, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0x12, Q_Proc_sub_5A320);
  Q_SetProc1_sub_574F0(&WinMgr, 0x14, Q_Proc_sub_5A320);
  Q_LoadAscendCfg_sub_59828(&WinMgr);
  VFX_window_fade(&V_Type6_stru_D8654.window, black_palette, 0x32);
  dword_132B60 = 0xFFFFFFFF;
  VFX_area_wipe(0, 0, 0x27F, 0x1DF, 0);
  Q_LoadPal_sub_2C158(&V_Type6_stru_D8654, "DATA\\game.pal", 0, 0x100u);
  Q_PaletteSet_sub_2C224(&V_Type6_stru_D8654, 0, 0x100, black_palette);
  sub_56E9C(&WinMgr, 0, 0xFFFFFFFF);
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x146);
  }
  if ( argc == 4 && sub_59988(&WinMgr, v48[3], 0) != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\corn.cpp", 0x14C);
  }
  MOUSE_show();
  // Main game loop
  while ( Q_GameLoop_dword_96774 == TRUE )
  {
    if ( WinMgr.bbb == 0xFFFFFFFF )
    {
      sub_59B80(&WinMgr);
    }
    else
    {
      Q_ProcessInput_sub_2656C();
    }
    sub_5469C(&WinMgr);
    sub_5508C(&WinMgr);
    if ( WinMgr.bbb )
    {
      sub_59A54(&WinMgr);
    }
  }
  Q_SaveAscendCfg_sub_5989C(&WinMgr);
  Q_SaveGam_sub_54048("resume.gam");
  result = (int)&v1;
  Q_CFile_Dtor_sub_1BBC8(&v1);
  return result;
}
/* Orphan comments:
171: "Thank you for playing Ascendancy."
175: "Please place the Ascendancy CD in your CDROM drive."
177: "Ascendancy could not find a mouse driver.  Please make sure your\n
mouse driver is loaded, and then run Ascendancy again."
*/
// 1CC7C: returning address of temporary local variable '%v1'
// 96774: using guessed type int Q_GameLoop_dword_96774;
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 132B60: using guessed type int dword_132B60;

//----- (0001CC94) --------------------------------------------------------
void Q_Proc_sub_1CC94()
{
  void *v0; // edi
  UBYTE *v1; // esi
  T_CFile v2; // [esp+0h] [ebp-128h] BYREF

  v0 = sub_262B0(0x502Eu, 1u, 1, "GIF SCRATCH");
  Q_CFile_Ctor_sub_1BB78(&v2);
  Q_CFile_OpenFile_sub_1BBFC(&v2, "DATA\\0OPENING.GIF", O_BINARY, 0);
  v1 = (UBYTE *)Q_CFile_Load_sub_1BF1C(&v2, 0);
  if ( !v1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x180);
  }
  Q_CFile_Dtor_sub_1BBC8(&v2);
  if ( v0 )
  {
    VFX_GIF_draw(&V_Type6_stru_D8654.pane, v1, v0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, 0);
  }
  Q_RemoveWinDataFromWinMgr_sub_2627C(v1);
  operator delete(v1);
  sub_262CC(v0);
}
// 1CCF9: conditional instruction was optimized away because esi.4!=0
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0001CD3C) --------------------------------------------------------
int Q_CORN_CPP_StaticTxtLoad_sub_1CD3C()
{
  FILE *fp; // edi
  char *pText; // esi
  char *pLetter; // ecx
  unsigned int v3; // ebp
  char letter; // dl
  int count; // eax
  char v6; // bh
  char line[201]; // [esp+1h] [ebp-E5h] BYREF
  int endOfFile; // [esp+CAh] [ebp-1Ch]

  fp = Q_OpenFile_sub_1BB10("static.txt", 0);
  if ( !fp )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1A0);
  }
  pText = V_StaticStrings_dword_A0D04.buffer;
  V_StaticStrings_dword_A0D04.count = 0;
  endOfFile = 0;
  do
  {
    if ( V_StaticStrings_dword_A0D04.count >= 200 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1AE);
    }
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, &line[1]);
    if ( !stricmp(&line[1], "end\n") )
    {
      endOfFile = 0xFFFFFFFF;
      continue;
    }
    if ( line[1] == '"' )
    {
      pLetter = &line[1];
      v3 = 0;
      V_StaticStrings_dword_A0D04.index[V_StaticStrings_dword_A0D04.count] = pText;
      do
      {
        ++pLetter;
        if ( pText - V_StaticStrings_dword_A0D04.buffer >= 8000 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1C6);
        }
        letter = *pLetter;
        if ( *pLetter == '"' )
        {
          v3 = 0xFFFFFFFF;
          count = V_StaticStrings_dword_A0D04.count;
          *pText++ = 0;
          V_StaticStrings_dword_A0D04.count = count + 1;
        }
        else if ( letter != '\n' )
        {
          if ( letter )
          {
            if ( letter != '\\' )
            {
              *pText++ = letter;
              continue;
            }
            v6 = *++pLetter;
            if ( v6 == 'n' )
            {
              *pText++ = '\n';
              continue;
            }
            if ( v6 )
            {
              *pText++ = v6;
              continue;
            }
          }
          pLetter = line;
          fgets(&line[1], 200, fp);
        }
      }
      while ( !v3 );
    }
  }
  while ( !endOfFile );
  V_StaticStrings_dword_A0D04.loaded = 0xFFFFFFFF;
  return fclose(fp);
}

//----- (0001CEA8) --------------------------------------------------------
char *__fastcall Q_CORN_CPP_StaticTxtRead_sub_1CEA8(int aTextIndex)
{
  if ( !V_StaticStrings_dword_A0D04.loaded )
  {
    Q_CORN_CPP_StaticTxtLoad_sub_1CD3C();
  }
  if ( aTextIndex < 0 || aTextIndex >= V_StaticStrings_dword_A0D04.count )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\corn.cpp", 0x1F3);
  }
  return V_StaticStrings_dword_A0D04.index[aTextIndex];
}

//----- (0001CEF0) --------------------------------------------------------
T_Game *sub_1CEF0()
{
  T_Game *result; // eax

  _wcpp_2_mod_register_(&dword_964E4);
  result = &V_Game;
  Q_GameCtor_sub_1DE64(&V_Game);
  dword_964EC = 1;
  return result;
}
// 964E4: using guessed type _DWORD dword_964E4;
// 964EC: using guessed type int dword_964EC;

//----- (0001CF14) --------------------------------------------------------
void __fastcall sub_1CF14(unsigned __int8 a1)
{
  unsigned __int8 v1; // dh
  char v2; // dl

  if ( a1 == 0xFF )
  {
    v1 = 0;
    v2 = 0xFF;
  }
  else
  {
    v1 = a1;
    v2 = 1 << a1;
  }
  V_PlayerRaceIndex = v1;
  V_RaceIndexMask = v2;
}
// 968DC: using guessed type char V_RaceIndexMask;

//----- (0001CF40) --------------------------------------------------------
void __fastcall Q_StarCtor_sub_1CF40(P_Star pStar)
{
  pStar->pos.x = 0.0;
  pStar->pos.y = 0.0;
  pStar->pos.z = 0.0;
}

//----- (0001CF68) --------------------------------------------------------
T_Lane *__fastcall sub_1CF68(T_Star *a1, T_Star *a2)
{
  int lanesNum; // eax
  int v5; // eax
  T_Lane *v6; // ebx
  T_Lane *v7; // eax
  T_Lane *v8; // edx
  double v9; // st7
  int v11[3]; // [esp+8h] [ebp-A4h] BYREF
  int v12[3]; // [esp+14h] [ebp-98h] BYREF
  float v13; // [esp+20h] [ebp-8Ch]
  float v14; // [esp+24h] [ebp-88h]
  float v15; // [esp+28h] [ebp-84h]
  float v16; // [esp+2Ch] [ebp-80h]
  int v17; // [esp+30h] [ebp-7Ch]
  int v18; // [esp+34h] [ebp-78h]
  float v19; // [esp+38h] [ebp-74h]
  float v20; // [esp+3Ch] [ebp-70h]
  float v21; // [esp+40h] [ebp-6Ch]
  float x; // [esp+44h] [ebp-68h]
  float y; // [esp+48h] [ebp-64h]
  float z; // [esp+4Ch] [ebp-60h]
  float v25; // [esp+50h] [ebp-5Ch]
  float v26; // [esp+54h] [ebp-58h]
  float v27; // [esp+58h] [ebp-54h]
  float v28; // [esp+5Ch] [ebp-50h] BYREF
  float v29; // [esp+60h] [ebp-4Ch]
  float v30; // [esp+64h] [ebp-48h]
  int v31[3]; // [esp+68h] [ebp-44h] BYREF
  float v32; // [esp+74h] [ebp-38h]
  int v33; // [esp+78h] [ebp-34h]
  int v34; // [esp+7Ch] [ebp-30h]
  int *v35; // [esp+80h] [ebp-2Ch]
  int *v36; // [esp+88h] [ebp-24h]
  int *v37; // [esp+8Ch] [ebp-20h]
  float *v38; // [esp+90h] [ebp-1Ch]
  float v39; // [esp+98h] [ebp-14h]

  lanesNum = a1->lanesNum;
  if ( lanesNum < 0 || lanesNum >= 6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7F);
  }
  v5 = a2->lanesNum;
  if ( v5 < 0 || v5 >= 6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x81);
  }
  v6 = 0;
  if ( a1->lanesNum != word_9652E[a1->type] && a2->lanesNum != word_9652E[a2->type] )
  {
    v7 = sub_205A0(&V_Game, a1, a2);
    v8 = v7;
    v6 = v7;
    if ( v7 )
    {
      a1->_lanes[a1->lanesNum++] = v7;
      a2->_lanes[a2->lanesNum++] = v7;
      v19 = 0.0;
      v20 = 0.0;
      v21 = 0.0;
      x = a2->pos.x;
      y = a2->pos.y;
      z = a2->pos.z;
      v13 = 0.0;
      v14 = 0.0;
      v15 = 0.0;
      v35 = v11;
      v13 = x - a1->pos.x;
      v14 = y - a1->pos.y;
      v15 = z - a1->pos.z;
      *(float *)v11 = v13;
      *(float *)&v11[1] = v14;
      *(float *)&v11[2] = v15;
      x = v13;
      y = v14;
      z = v15;
      v9 = sqrt(v14 * v14 + v13 * v13 + v15 * v15);
      v36 = v12;
      v32 = x * (1.0 / v9);
      *(float *)v12 = v32;
      *(float *)&v33 = y * (1.0 / v9);
      v12[1] = v33;
      *(float *)&v34 = 1.0 / v9 * z;
      v12[2] = v34;
      v39 = v9 * 0.0011363636;
      x = v32;
      y = *(float *)&v33;
      v39 = v39 * 1000.0 + 2000.0;
      z = *(float *)&v34;
      v16 = v32 * v39;
      v37 = v31;
      *(float *)&v17 = *(float *)&v33 * v39;
      *(float *)v31 = v16;
      *(float *)&v18 = *(float *)&v34 * v39;
      v31[1] = v17;
      v31[2] = v18;
      v19 = v16;
      v20 = *(float *)&v17;
      v21 = *(float *)&v18;
      v8->vector1.x = v16;
      v8->vector1.y = v20;
      v8->vector1.z = v21;
      v25 = -v19;
      v38 = &v28;
      v26 = -v20;
      v28 = v25;
      v27 = -v21;
      v29 = v26;
      v30 = v27;
      v8->vector2.x = v25;
      v8->vector2.y = v29;
      v8->vector2.z = v30;
    }
  }
  return v6;
}

//----- (0001D234) --------------------------------------------------------
__int16 __fastcall Q_Star_ChangePlanetOwnership_sub_1D234(P_Star pStar, P_Planet pPlanet, WORD newRaceIndex)
{
  int raceIndex; // eax
  WORD planetsNum; // bx
  P_Star homeStar; // ebx
  int racesBits; // edx
  UBYTE buildingPlanetItemIndex; // bh
  P_Ship vpShip; // eax
  __int16 i; // ax
  __int16 planetRaceIndex; // [esp+2h] [ebp-10h]

  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB3);
  }
  if ( newRaceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB4);
  }
  if ( pPlanet->raceIndex == newRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB5);
  }
  if ( pPlanet->raceIndex == 0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB7);
  }
  planetRaceIndex = pPlanet->raceIndex;
  raceIndex = pPlanet->raceIndex;
  if ( raceIndex != 0xFF )
  {
    if ( newRaceIndex == 0xFFFFFFFF )
    {
      pPlanet->raceIndex = 0xFF;
    }
    else
    {
      pPlanet->raceIndex = newRaceIndex;
      pStar->racesBits |= 1 << newRaceIndex;
    }
    planetsNum = pStar->planetsNum;
    pStar->racesBits &= ~(1 << planetRaceIndex);
    i = 0;
    if ( planetsNum > 0 )
    {
      while ( pStar->planets[i]->raceIndex != planetRaceIndex )
      {
        if ( ++i >= pStar->planetsNum )
        {
          goto LABEL_18;
        }
      }
      pStar->racesBits |= 1 << planetRaceIndex;
    }
LABEL_18:
    LOWORD(raceIndex) = planetRaceIndex;
    homeStar = V_Game.races[planetRaceIndex]._homeStar;
    if ( pStar == homeStar )
    {
      racesBits = homeStar->racesBits;
      raceIndex = 1 << planetRaceIndex;
      if ( ((1 << planetRaceIndex) & racesBits) == 0 )
      {
        pStar->racesBits = racesBits & 0x7F;
      }
    }
  }
  buildingPlanetItemIndex = pPlanet->buildingPlanetItemIndex;
  if ( buildingPlanetItemIndex != 0xFF )
  {
    if ( buildingPlanetItemIndex == ASCEND_PI_23_SHIP )
    {
      vpShip = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, pPlanet->_squareIndex);
      if ( planetRaceIndex != vpShip->raceIndex )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xE0);
      }
      Q_Ship_RemoveFromTheGame_sub_49940(vpShip);
    }
    raceIndex = pPlanet->_squareIndex;
    if ( (unsigned __int16)raceIndex != 0xFFFF && pPlanet->buildingPlanetItemIndex != 0x23 )
    {
      pPlanet->pSquares[raceIndex].planetItemIndex = 0xFF;
      raceIndex = pPlanet->_squareIndex;
      pPlanet->pSquares[raceIndex].flags = 0;
    }
    pPlanet->buildingPlanetItemIndex = 0xFF;
    pPlanet->buildingProgress = 0;
    pPlanet->_squareIndex = 0xFFFF;
  }
  return raceIndex;
}

//----- (0001D3E8) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Star_HandleShipArrival_sub_1D3E8(P_Star pStar, P_Ship pShip, int a3)
{
  UBYTE locationType; // ah
  P_Lane pLane; // eax
  int i; // edx
  P_Lane pConnectedLane; // eax
  T_Vector3D arrivalPosition; // [esp+0h] [ebp-1Ch] BYREF
  int v11; // [esp+Ch] [ebp-10h]

  if ( a3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xFD);
  }
  locationType = pShip->locationType;
  // Handle different arrival scenarios
  if ( locationType == ASCEND_LOCATION_TYPE_STARLANE )
  {
    // Calculate arrival position from star lane
    pLane = pShip->pLocation.pLane;
    memset(&arrivalPosition, 0, sizeof(arrivalPosition));
    if ( pStar == pLane->pStar1 )
    {
      arrivalPosition = pLane->vector1;
    }
    else if ( pStar == pLane->pStar2 )
    {
      arrivalPosition = pLane->vector2;
    }
    else
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0x10A);
    }
    // Add random offset near the lane endpoint
    arrivalPosition.y = arrivalPosition.y + -200.0;    // Move away from lane
    arrivalPosition.z = (double)(rand() % 200) + arrivalPosition.z;
    v11 = rand() % 200;
    arrivalPosition.x = (double)v11 + arrivalPosition.x;
    // Position ship and update location
    Q_Ship_SetPositionAndSnapToGrid_sub_496BC(pShip, &arrivalPosition);
    pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
  }
  else if ( locationType != ASCEND_LOCATION_TYPE_SYSTEM )
  {
    goto UPDATE_PRESENCE;
  }
  // Set ship's current star
  pShip->pLocation.pStar = pStar;
UPDATE_PRESENCE:
  // Update exploration and presence flags
  pStar->racePresenceBits |= 1 << LOBYTE(pShip->raceIndex);
  pStar->exploredBits |= 1 << LOBYTE(pShip->raceIndex);
  // Update all connected star lanes
  for ( i = 0; (__int16)i < pStar->lanesNum; ++i )
  {
    pConnectedLane = pStar->_lanes[(__int16)i];
    pConnectedLane->exploredBits |= 1 << LOBYTE(pShip->raceIndex);
    pConnectedLane->pStar1->exploredPathToBits |= 1 << LOBYTE(pShip->raceIndex);
    pConnectedLane->pStar2->exploredPathToBits |= 1 << LOBYTE(pShip->raceIndex);
  }
  return TRUE;
}

//----- (0001D538) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_HandleShipDeparture_sub_1D538(P_Location pLocation, P_Ship pShip)
{
  UBYTE locationType; // ah
  int starIndex; // edx
  int shipsNum; // esi
  MACRO_VFX_BOOL isLastOfRace; // ebp
  __int16 i; // dx
  P_Ship currentShip; // eax
  P_Ship nearbyShips[107]; // [esp+0h] [ebp-1C4h] BYREF
  WORD raceIndex; // [esp+1ACh] [ebp-18h]

  raceIndex = pShip->raceIndex;
  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x139);
  }
  locationType = pShip->locationType;
  // Try to launch the ship from planetary location
  if ( (locationType == ASCEND_LOCATION_TYPE_ORBIT
     || locationType == ASCEND_LOCATION_TYPE_SHIPYARD
     || locationType == ASCEND_LOCATION_TYPE_SHIPDOCK)
    && Q_Planet_LaunchShip_sub_35C38(pShip->pLocation.pPlanet, pShip) == FALSE )
  {
    // Fallback: Move directly to star system if launch fails
    starIndex = pShip->pLocation.pPlanet->starIndex;
    pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
    pShip->pLocation.pStar = &V_Game.stars[starIndex];
  }
  // Verify ship is now in system and at correct location
  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM || pLocation.pPlanet != pShip->pLocation.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x149);
  }
  // Find all ships at this location
  shipsNum = Q_FindShipsAtLocation_sub_1D794(pLocation, nearbyShips);
  if ( shipsNum <= 0 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0x14E);
  }
  // Check if any other ships of same race remain (excluding current ship and shipyard ships
  isLastOfRace = TRUE;
  for ( i = 0; i < shipsNum; ++i )
  {
    currentShip = nearbyShips[i];
    if ( currentShip->raceIndex == raceIndex && currentShip != pShip && currentShip->locationType != ASCEND_LOCATION_TYPE_SHIPYARD )
    {
      isLastOfRace = FALSE;
      break;
    }
  }
  // If this was the last ship of its race, update star system flags
  if ( isLastOfRace == TRUE )
  {
    pLocation.pStar->racePresenceBits &= ~(1 << raceIndex);
  }
  return TRUE;
}

//----- (0001D654) --------------------------------------------------------
void __fastcall sub_1D654(P_Location pLocation, P_Star pStar, P_Lane pLane)
{
  P_Ship pShip; // ecx
  __int16 i; // si
  P_Ship shipsArray[107]; // [esp+0h] [ebp-1C4h] BYREF
  int ShipsAtLocation_sub_1D794; // [esp+1ACh] [ebp-18h]
  P_Lane pLane_; // [esp+1B0h] [ebp-14h]

  pLane_ = pLane;
  if ( !pStar || !pLane )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x16C);
  }
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(pLocation, shipsArray);
  for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
  {
    pShip = shipsArray[i];
    if ( pShip->raceIndex == V_PlayerRaceIndex )
    {
      Q_HandleShipDeparture_sub_1D538(pLocation, pShip);
      pShip->pLocation.pLane = pLane_;
      pShip->locationType = ASCEND_LOCATION_TYPE_STARLANE;
      Q_Star_HandleShipArrival_sub_1D3E8(pStar, pShip, 0);
    }
  }
}
// 1D654: could not find valid save-restore pair for ebx

//----- (0001D734) --------------------------------------------------------
int __fastcall sub_1D734(P_Star pStar, WORD *a2)
{
  int j; // ebx
  WORD raceIndex; // ax
  int i; // edx
  int v6; // ecx
  UBYTE v8; // [esp+0h] [ebp-14h]

  j = 0;
  v8 = pStar->racesBits | pStar->racePresenceBits;
  raceIndex = 0;
  if ( V_Game.racesNum > 0 )
  {
    i = 0;
    do
    {
      if ( (v8 & (unsigned __int8)(1 << raceIndex)) != 0 )
      {
        v6 = i;
        ++j;
        i += 2;
        *(WORD *)((char *)a2 + v6) = raceIndex;
      }
      ++raceIndex;
    }
    while ( raceIndex < V_Game.racesNum );
  }
  return j;
}

//----- (0001D794) --------------------------------------------------------
// Finds all ships at a given location and optionally stores them in an output array
// Returns the number of ships found at the location
int __fastcall Q_FindShipsAtLocation_sub_1D794(P_Location pLocation, P_Ship *outShipsArray)
{
  T_Ship *ships; // eax
  P_Ship *currentOutputPos; // ebx
  int shipsFoundCount; // edi
  int validShipsChecked; // esi
  __int16 i; // dx
  UBYTE locationType; // cl

  ships = V_Game.ships;
  currentOutputPos = outShipsArray;
  shipsFoundCount = 0;
  validShipsChecked = 0;
  for ( i = 0; i < 107 && validShipsChecked < V_Game.shipsNum; ++i )
  {
    if ( ships->raceIndex != 0xFFFFFFFF )
    {
      // Check if ship is at target location either:
      // 1. In orbit/shipyard/dock at same star, or
      // 2. In same star system
      if ( ((locationType = ships->locationType, ++validShipsChecked, locationType == ASCEND_LOCATION_TYPE_ORBIT)
         || locationType == ASCEND_LOCATION_TYPE_SHIPYARD
         || locationType == ASCEND_LOCATION_TYPE_SHIPDOCK)
        && &V_Game.stars[ships->pLocation.pPlanet->starIndex] == pLocation.pStar
        || ships->locationType == ASCEND_LOCATION_TYPE_SYSTEM && pLocation.pStar == ships->pLocation.pStar )
      {
        if ( outShipsArray )
        {
          *currentOutputPos = ships;
        }
        ++currentOutputPos;
        ++shipsFoundCount;
      }
    }
    ++ships;
  }
  return shipsFoundCount;
}

//----- (0001D834) --------------------------------------------------------
unsigned int __fastcall sub_1D834(P_Star pStar, __int16 raceIndex)
{
  T_Ship *ships; // ecx
  __int16 v4; // di
  int raceIndexa; // eax
  __int16 v6; // dx
  WORD v9; // [esp+6h] [ebp-18h]

  ships = V_Game.ships;
  v4 = 0;
  v9 = 0;
  while ( 1 )
  {
    if ( v4 >= 0x6B || v9 >= V_Game.shipsNum )
    {
      return 0;
    }
    raceIndexa = ships->raceIndex;
    if ( raceIndexa != 0xFFFFFFFF )
    {
      ++v9;
      if ( ships->locationType == 5
        && (V_Game.races[raceIndex].treaties[raceIndexa] == 2 || raceIndexa == V_PlayerRaceIndex || raceIndex == ships->raceIndex) )
      {
        v6 = 0;
        if ( pStar->lanesNum > 0 )
        {
          break;
        }
      }
    }
LABEL_2:
    ++v4;
    ++ships;
  }
  while ( ships->pLocation.pPlanet != (P_Planet)pStar->_lanes[v6]
       || (pStar != pStar->_lanes[v6]->pStar1 || (LODWORD(ships->position.y) & 0x7FFFFFFF) != 0)
       && (pStar != pStar->_lanes[v6]->pStar2 || LODWORD(ships->position.y) != 0x3F800000) )
  {
    if ( ++v6 >= pStar->lanesNum )
    {
      goto LABEL_2;
    }
  }
  return 0xFFFFFFFF;
}

//----- (0001D920) --------------------------------------------------------
void __fastcall Q_ReadWriteStar_sub_1D920(P_Star pStar, P_CFile pfi, int read)
{
  int z2; // eax
  T_Star vStar; // [esp+0h] [ebp-70h] BYREF

  if ( read == TRUE )
  {
    Q_StarCtor_sub_1CF40(&vStar);
    Q_ReadFile_sub_1BF94(pfi, &vStar, sizeof(T_Star));
    pStar->type = vStar.type;
    pStar->index = vStar.index;
    pStar->Unknown_6 = vStar.Unknown_6;
    pStar->pos = vStar.pos;
    pStar->racesBits = vStar.racesBits;
    pStar->racePresenceBits = vStar.racePresenceBits;
    pStar->exploredPathToBits = vStar.exploredPathToBits;
    pStar->exploredBits = vStar.exploredBits;
    pStar->Unknown_18 = vStar.Unknown_18;
    *(_DWORD *)pStar->name = *(_DWORD *)vStar.name;
    *(_DWORD *)&pStar->name[4] = *(_DWORD *)&vStar.name[4];
    *(_DWORD *)&pStar->name[8] = *(_DWORD *)&vStar.name[8];
    *(_DWORD *)&pStar->name[0xC] = *(_DWORD *)&vStar.name[0xC];
    qmemcpy(pStar->_lanes, vStar._lanes, sizeof(pStar->_lanes));
    pStar->lanesNum = vStar.lanesNum;
    pStar->planets[0] = vStar.planets[0];
    pStar->planets[1] = vStar.planets[1];
    pStar->planets[2] = vStar.planets[2];
    pStar->planets[3] = vStar.planets[3];
    pStar->planets[4] = vStar.planets[4];
    pStar->planetsNum = vStar.planetsNum;
    z2 = vStar.z2;
    pStar->lanesNum = 0;
    pStar->z2 = z2;
    pStar->planetsNum = 0;
  }
  else
  {
    Q_CFile_DosWrite_sub_1C098(pfi, pStar, 0x60u);
  }
}

//----- (0001DA04) --------------------------------------------------------
int __fastcall sub_1DA04(int a1, int a2)
{
  int result; // eax

  if ( !a2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x21A);
  }
  result = *(__int16 *)(a2 + 4);
  LOWORD(result) = V_Game.starConnections[*(__int16 *)(a1 + 4)][result];
  return result;
}

//----- (0001DA4C) --------------------------------------------------------
int __fastcall sub_1DA4C(T_Star *a1, __int16 a2, int a3, int a4)
{
  int v5; // ebx
  P_Planet *planets; // kr00_4
  P_Star homeStar; // ecx
  int i; // edi
  int j; // eax

  if ( a2 > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x248);
  }
  if ( a4 >= 0x6B )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x249);
  }
  v5 = 0;
  if ( ((1 << a2) & a1->exploredPathToBits) == 0 )
  {
    return 0x2BC;
  }
  planets = a1->planets;
  for ( i = 0; i < a1->planetsNum; ++i )
  {
    if ( planets[i]->raceIndex != a2 )
    {
      v5 += sub_364B4(planets[i], a2);
    }
  }
  for ( j = 0; j < V_Game.racesNum; ++j )
  {
    if ( j != a2 )
    {
      homeStar = V_Game.races[j]._homeStar;
      if ( a1 == homeStar && (homeStar->racesBits & 0x80) != 0 && V_Game.races[a2].treaties[j] == 2 )
      {
        v5 = 3 * v5 + 0xC8;
      }
    }
  }
  if ( !a1->racesBits )
  {
    v5 *= 2;
  }
  if ( v5 < 0 )
  {
    v5 = 0;
  }
  if ( ((1 << a2) & a1->exploredBits) == 0 )
  {
    return 4 * v5 + 0x12C;
  }
  return v5;
}

//----- (0001DB70) --------------------------------------------------------
int __fastcall sub_1DB70(T_Star *a1, __int16 a2, int *a3, int a4)
{
  UBYTE racePresenceBits; // al
  int ShipsAtLocation_sub_1D794; // eax
  int i; // kr04_4
  int v9; // kr08_4
  char *v10; // ecx
  int v11; // ebp
  int v12; // kr10_4
  int v13; // ecx
  P_Planet *planets; // kr14_4
  int v15; // edx
  int v16; // edx
  int v17; // ebx
  T_Planet *v18; // eax
  int j; // ebp
  void *v21[107]; // [esp+0h] [ebp-1D4h] BYREF
  int *v22; // [esp+1ACh] [ebp-28h]
  int v23; // [esp+1B0h] [ebp-24h]
  int v24; // [esp+1B4h] [ebp-20h]
  int v25; // [esp+1B8h] [ebp-1Ch]
  int v26; // [esp+1BCh] [ebp-18h]
  int *v27; // [esp+1C0h] [ebp-14h]
  float v28; // [esp+1C4h] [ebp-10h]

  v27 = a3;
  v26 = a4;
  if ( a2 > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x2BD);
  }
  v23 = 0;
  if ( ((1 << a2) & a1->exploredPathToBits) != 0 && ((1 << a2) & a1->racesBits) != 0 )
  {
    racePresenceBits = a1->racePresenceBits;
    v28 = 0.0;
    if ( racePresenceBits )
    {
      if ( v27 && v26 >= 0 )
      {
        v11 = 0;
        if ( v26 > 0 )
        {
          v22 = v27;
          v12 = 0;
          do
          {
            v13 = v27[v12];
            if ( !v13 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x2F1);
            }
            if ( (*(_BYTE *)(v13 + 0x58) == 4 && a1 == *(T_Star **)(v13 + 0x59)
               || *(_BYTE *)(v13 + 0x58) == 3 && a1->index == *(_WORD *)(*(_DWORD *)(v13 + 0x59) + 0xC))
              && a2 != *(_WORD *)(v13 + 0x56)
              && V_Game.races[a2].treaties[*(__int16 *)(v13 + 0x56)] == 2 )
            {
              v24 = sub_4A988((P_Ship)v27[v12]);
              v28 = (double)v24 + v28;
            }
            ++v11;
            ++v12;
          }
          while ( v11 < v26 );
        }
      }
      else
      {
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)a1, (P_Ship *)v21);
        if ( ShipsAtLocation_sub_1D794 > 0 )
        {
          v25 = 4 * ShipsAtLocation_sub_1D794;
          v9 = ShipsAtLocation_sub_1D794;
          for ( i = 0; i < v9; ++i )
          {
            v10 = (char *)v21[i];
            if ( !v10 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x2D6);
            }
            if ( (v10[0x58] == 4 && a1 == *(T_Star **)(v10 + 0x59)
               || v10[0x58] == 3 && a1->index == *(_WORD *)(*(_DWORD *)(v10 + 0x59) + 0xC))
              && a2 != *((_WORD *)v10 + 0x2B)
              && V_Game.races[a2].treaties[*((__int16 *)v10 + 0x2B)] == 2 )
            {
              v24 = sub_4A988((P_Ship)v21[i]);
              v28 = (double)v24 + v28;
            }
          }
        }
      }
      v28 = v28 * 4.0 * 0.0099999998;
    }
    if ( v28 > 0.0 )
    {
      planets = a1->planets;
      for ( j = 0; j < a1->planetsNum; ++j )
      {
        if ( planets[j]->raceIndex == a2 )
        {
          v15 = v23;
          v16 = Q_Planet_GetTotalValue_sub_363B0(planets[j]) + v15;
          v17 = v16 - 0xA * Q_Planet_CalculateOrbitalDefenseStrength_sub_360D8(planets[j]);
          v18 = planets[j];
          v23 = v16;
          v23 = v17 - 5 * Q_Planet_CalculateSurfaceShieldStrength_sub_36158(v18);
        }
      }
      if ( a1 == V_Game.races[a2]._homeStar )
      {
        v23 += 20000;
      }
      v23 = (int)((double)v23 * v28);
    }
    if ( v23 < 0 )
    {
      v23 = 0;
    }
  }
  return 5 * v23;
}
// 1DB70: using guessed type P_Ship var_1D4[107];

//----- (0001DE64) --------------------------------------------------------
void __fastcall __spoils<> Q_GameCtor_sub_1DE64(P_Game pGame)
{
  _wcpp_2_ctor_array_(pGame->races, 7u, &C_Race);
  _wcpp_2_ctor_array_(pGame->stars, 100u, &C_Star);
  _wcpp_2_ctor_array_(pGame->lanes, 148u, &C_Lane);
  _wcpp_2_ctor_array_(pGame->planets, 500u, &C_Planet);
  _wcpp_2_ctor_array_(pGame->ships, 107u, &C_Ship);
  _wcpp_2_ctor_array_(pGame->sectors, 9u, &C_Sector);
  _wcpp_2_ctor_array_(&pGame->t10, 24u, &C_Type09);
  sub_1E094(pGame);
}

//----- (0001E03C) --------------------------------------------------------
void __fastcall Q_GameDtor_sub_1E03C(P_Game a1)
{
  sub_222C0(&a1->t10);
  sub_222E0(a1->sectors);
  sub_222A0(a1->ships);
  sub_22300(a1->planets);
  sub_22320(a1->lanes);
  sub_22280(a1->stars);
  sub_22260(a1->races);
}

//----- (0001E094) --------------------------------------------------------
void __fastcall sub_1E094(P_Game pGame)
{
  char *sub_1CEA8; // kr00_4
  int v3; // kr08_4

  v3 = 0;
  do
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v3 + 0xB2);
    strcpy(V_StarTypeTexts_D84C4[v3++], sub_1CEA8);
  }
  while ( V_StarTypeTexts_D84C4[v3] != V_StarTypeTexts_D84C4[13] );
  pGame->starsNum = 0;
  pGame->lanesNum = 0;
  pGame->racesNum = 0;
  pGame->shipsNum = 0;
  pGame->atmosphere = 1;
}
/* Orphan comments:
178: "Blue Giant"
*/

//----- (0001E10C) --------------------------------------------------------
void __fastcall sub_1E10C(P_Game pGame, WORD starsNum, WORD racesNum, unsigned __int8 a4)
{
  pGame->z1 = 0;
  V_GridSize = 0x20;
  sub_1E2A0(pGame, starsNum);
  sub_1E150(pGame, 9);
  sub_1EFC0(pGame);
  sub_1E70C(pGame, racesNum, a4);
}
// 96B88: using guessed type int V_GridSize;

//----- (0001E150) --------------------------------------------------------
void __fastcall sub_1E150(P_Game pGame, __int16 sectors)
{
  int v3; // ebx
  T_Vector3D *p_v; // kr08_4
  int angle0; // edi
  P_Game v6; // kr00_4
  int i; // ecx
  float degrees; // [esp+0h] [ebp-44h]
  T_Vector3D vector; // [esp+10h] [ebp-34h] BYREF
  int angle2; // [esp+1Ch] [ebp-28h]
  int angle1; // [esp+20h] [ebp-24h]
  int v12; // [esp+24h] [ebp-20h]
  int v13; // [esp+28h] [ebp-1Ch]
  __int16 sectors_1; // [esp+2Ch] [ebp-18h]

  sectors_1 = sectors;
  if ( sectors > 9 )
  {
    sectors_1 = 9;
  }
  v3 = sectors_1;
  pGame->sectorsNum = 0;
  memset(&vector, 0, sizeof(vector));
  v12 = 360 / v3;
  angle1 = 3 * (360 / v3) / 4;
  p_v = &pGame->sectors[0].v;
  angle0 = 0;
  v6 = pGame;
  angle2 = angle1 / 2;
  for ( i = 0; i < sectors_1; ++i )
  {
    v6->sectors[i].n = i;
    vector.x = 1000.0;
    vector.y = 300.0;
    vector.z = 0.0;
    v13 = angle0 + rand() % angle1 - angle2;
    degrees = (float)v13;
    Q_RotateVectorY_sub_532AC(&vector, degrees);
    v13 = rand() % 600 - 300;
    vector.y = (double)v13 + vector.y;
    *(T_Vector3D *)((char *)p_v + 0xD * i) = vector;
    angle0 += v12;
    ++pGame->sectorsNum;
  }
}

//----- (0001E2A0) --------------------------------------------------------
int __fastcall sub_1E2A0(P_Game a1, __int16 stars)
{
  FILE *v2; // ebp
  __int16 j; // ax
  int v4; // edx
  P_Game v5; // eax
  P_Game v6; // edx
  T_Star *v7; // eax
  int v8; // ecx
  T_Star *v9; // ebp
  __int16 v10; // ax
  int v11; // eax
  int v12; // ebx
  char *v13; // edx
  double v14; // st7
  __int16 v15; // bx
  __int16 v16; // si
  __int16 k; // dx
  __int16 v18; // cx
  P_Game v19; // edx
  __int16 starsNum; // si
  __int16 i; // bx
  char *name; // [esp-4h] [ebp-82Ch]
  T_Name20 names[100]; // [esp+0h] [ebp-828h] BYREF
  float z; // [esp+7D0h] [ebp-58h] BYREF
  T_Vector3D vector; // [esp+7D4h] [ebp-54h]
  fpos_t endOffset; // [esp+7E0h] [ebp-48h]
  float pos; // [esp+7E4h] [ebp-44h]
  T_Vector3D vec1; // [esp+7E8h] [ebp-40h] BYREF
  int end; // [esp+7F4h] [ebp-34h] BYREF
  int v1; // [esp+7F8h] [ebp-30h] BYREF
  T_Star *v32; // [esp+7FCh] [ebp-2Ch]
  int v33; // [esp+800h] [ebp-28h]
  float *v34; // [esp+804h] [ebp-24h]
  FILE *fp; // [esp+808h] [ebp-20h]
  P_Game v36; // [esp+80Ch] [ebp-1Ch]
  int v37; // [esp+810h] [ebp-18h]
  int v38; // [esp+814h] [ebp-14h]
  const char *v39; // [esp+818h] [ebp-10h]
  int v40; // [esp+81Ch] [ebp-Ch]
  float v41; // [esp+820h] [ebp-8h]
  __int16 v42; // [esp+824h] [ebp-4h]

  v36 = a1;
  memset(&vec1, 0, sizeof(vec1));
  v37 = 0;
  fp = Q_OpenFile_sub_1BB10("names.txt", &end);
  v41 = 440.0;
  v2 = fp;
  for ( i = 0; i < 100; ++i )
  {
    fgetpos(fp, &v1);
    if ( end > v1 )
    {
      fscanf(v2, "%s", names[i]);
    }
    else
    {
      sprintf(names[i], "XM%02d", i);
    }
  }
  fclose(fp);
  v40 = 100;
  v36->starsNum = stars;
  v38 = stars / 2;
  for ( j = 0; j < 13; ++j )
  {
    v4 = word_96514[j];
    v37 += v4;
  }
  v5 = v36;
  v36->planetsNum = 0;
  v6 = v36;
  v5->squaresNum = 0;
  v7 = v5->stars;
  v6->day = 0;
  v6->pCurStar = v7;
  v6->pCurPlanet = v6->planets;
  if ( v36->starsNum > 0 )
  {
    v42 = 0;
    v32 = v7;
    v39 = names[v40];
    do
    {
      v8 = v42;
      v9 = &v32[v42];
      v9->racesBits = 0;
      v9->racePresenceBits = 0;
      v9->exploredPathToBits = 0;
      v9->exploredBits = 0;
      v9->lanesNum = 0;
      v9->Unknown_6 = 0xFFFF;
      v10 = v42;
      v9->planetsNum = 0;
      v9->index = v10;
      v11 = rand() % v40;
      v12 = v40;
      name = v9->name;
      v13 = &names[v11][(_DWORD)strcpy(v9->name, names[v11])];
      v39 += 0xFFFFFFEC;
      name = v13;
      strcpy(v13, v39);
      v40 = v12 - 1;
      if ( v8 > v38 )
      {
        v14 = v41 + -75.0;
        v41 = v14;
        if ( v14 < 50.0 )
        {
          v41 = 50.0;
        }
        v38 += (v36->starsNum - v42) / 2;
      }
      v9->type = 0xC;
      v15 = 0;
      v16 = rand() % v37 + 1;
      for ( k = 0; k < 0xD; ++k )
      {
        v15 += word_96514[k];
        if ( v16 <= v15 )
        {
          v9->type = k;
          break;
        }
      }
      v33 = rand() % 1000 - 500;
      vec1.x = (float)v33;
      v33 = rand() % 1000 - 500;
      vec1.y = (float)v33;
      v33 = rand() % 1000 - 500;
      vec1.z = (float)v33;
      Q_Vector3D_Normalize_sub_53000(&vec1);
      v34 = &z;
      vector.z = vec1.x * v41;
      z = vector.z;
      *(float *)&endOffset = vec1.y * v41;
      LODWORD(vector.x) = endOffset;
      pos = v41 * vec1.z;
      vector.y = pos;
      vec1.x = vector.z;
      LODWORD(vec1.y) = endOffset;
      vec1.z = pos;
      v9->pos.x = vector.z;
      v9->pos.y = vec1.y;
      v18 = v42;
      v19 = v36;
      v9->pos.z = vec1.z;
      starsNum = v19->starsNum;
      v42 = v18 + 1;
    }
    while ( (__int16)(v18 + 1) < starsNum );
  }
  return fclose(fp);
}

//----- (0001E70C) --------------------------------------------------------
P_Game __fastcall sub_1E70C(P_Game pGame, WORD racesNum, unsigned __int8 a3)
{
  int v4; // eax
  int v5; // edi
  int v6; // eax
  int starsNum; // eax
  WORD k; // di
  int v9; // eax
  WORD m; // ax
  P_Lane v11; // edx
  P_Star pStar1; // ecx
  P_Star homeStar; // edx
  int v14; // ebx
  T_Star *v15; // edx
  char v16; // bl
  P_Lane v17; // eax
  P_Star v18; // ecx
  P_Star v19; // eax
  WORD Unknown_1C9; // cx
  unsigned __int8 v21; // bl
  UBYTE v22; // dl
  T_Race *v23; // eax
  unsigned int v24; // edi
  __int16 v25; // ax
  int mm; // edx
  int v27; // eax
  int v28; // ecx
  int v29; // edi
  int jj; // edx
  int v31; // eax
  int v32; // ecx
  int v33; // edi
  int kk; // edx
  int v35; // eax
  int v36; // ecx
  int v37; // edi
  BYTE atmosphere; // al
  int v39; // eax
  P_Game result; // eax
  UBYTE ability; // ch
  WORD ii; // dx
  int i1; // kr04_4
  int i2; // ecx
  int v45; // [esp+8h] [ebp-24h]
  WORD v47; // [esp+10h] [ebp-1Ch]
  int v48; // [esp+14h] [ebp-18h]
  WORD i; // [esp+14h] [ebp-18h]
  WORD j; // [esp+14h] [ebp-18h]
  __int16 nn; // [esp+14h] [ebp-18h]
  WORD v52; // [esp+14h] [ebp-18h]
  WORD n; // [esp+18h] [ebp-14h]

  pGame->aa2 = 0xFFFFFFFF;
  pGame->z7 = 0;
  pGame->racesNum = racesNum;
  v45 = 0;
  for ( i = 0; i < pGame->starsNum; ++i )
  {
    v4 = i;
    pGame->stars[v4].racesBits = 0;
    pGame->stars[v4].racePresenceBits = 0;
    pGame->stars[v4].exploredPathToBits = 0;
    pGame->stars[v4].exploredBits = 0;
  }
  for ( j = 0; j < pGame->lanesNum; ++j )
  {
    pGame->lanes[j].exploredBits = 0;
  }
  v5 = 0;
  Q_Research_LoadResTreeTxt_sub_46480(&V_Research, 0);
  while ( 1 )
  {
    LOWORD(v48) = v5;
    v6 = (__int16)v5;
    if ( (__int16)v5 >= 7 )
    {
      break;
    }
    V_Research.current.project[(__int16)v5] = 0xFFFF;
    v5 = v48 + 1;
    word_106FB4[v6] = 0;
  }
  v47 = 0x258;
  starsNum = pGame->starsNum;
  pGame->f = 0;
  if ( starsNum < 0x19 )
  {
    v47 = 0x1C2;
  }
  while ( v47 > pGame->f )
  {
    if ( v45 )
    {
      for ( k = 0; k < pGame->racesNum; ++k )
      {
        v9 = k;
        pGame->races[v9]._homeStar->racesBits = 0;
        pGame->races[v9]._homeStar->exploredBits = 0;
        for ( m = 0; ; ++m )
        {
          homeStar = pGame->races[k]._homeStar;
          if ( m >= homeStar->lanesNum )
          {
            break;
          }
          v11 = homeStar->_lanes[m];
          pStar1 = v11->pStar1;
          v11->exploredBits = 0;
          pStar1->exploredPathToBits = 0;
          v11->pStar2->exploredPathToBits = 0;
        }
      }
    }
    for ( n = 0; n < pGame->racesNum; ++n )
    {
      v14 = pGame->starsNum;
      v15 = &pGame->stars[rand() % v14];
      pGame->races[n]._homeStar = v15;
      if ( v15->racesBits )
      {
        --n;
      }
      else
      {
        v15->racesBits = 0x80;
        v16 = 1 << n;
        pGame->races[n]._homeStar->racesBits |= 1 << n;
        pGame->races[n].index = n;
        pGame->races[n]._homeStar->exploredBits |= 1 << n;
        for ( ii = 0; ; ++ii )
        {
          v19 = pGame->races[n]._homeStar;
          if ( ii >= v19->lanesNum )
          {
            break;
          }
          v17 = v19->_lanes[ii];
          v18 = v17->pStar1;
          v17->exploredBits |= v16;
          v18->exploredPathToBits |= v16;
          v17->pStar2->exploredPathToBits |= v16;
        }
      }
    }
    v5 = v45 + 1;
    sub_220CC(pGame);
    ++v45;
  }
  *(_DWORD *)&Unknown_1C9 = 0;
  if ( pGame->racesNum > 0 )
  {
    do
    {
      if ( Unknown_1C9 )
      {
        do
        {
          v24 = 0;
          v21 = rand() % 0x15;
          v25 = 0;
          if ( Unknown_1C9 > 0 )
          {
            while ( v21 != pGame->races[v25]._nameIndex )
            {
              if ( ++v25 >= Unknown_1C9 )
              {
                goto LABEL_37;
              }
            }
            v24 = 0xFFFFFFFF;
          }
LABEL_37:
          ;
        }
        while ( v24 );
      }
      else
      {
        v21 = a3;
      }
      v22 = Unknown_1C9;
      HIWORD(v5) = (unsigned int)pGame->races >> 0x10;
      v23 = &pGame->races[Unknown_1C9];
      ++*(_DWORD *)&Unknown_1C9;
      sub_3B1FC(v23, v22, v21);
    }
    while ( Unknown_1C9 < pGame->racesNum );
  }
  sub_1EE08((int)pGame, pGame->races[0].Unknown_02);
  atmosphere = pGame->atmosphere;
  if ( atmosphere )
  {
    if ( (unsigned __int8)atmosphere <= 1u )
    {
      for ( jj = 0; (__int16)jj < pGame->racesNum; ++jj )
      {
        v31 = (__int16)jj;
        Unknown_1C9 = pGame->races[v31].Unknown_1C9;
        v32 = *(_DWORD *)&Unknown_1C9 + 0x1E;
        LOWORD(v5) = pGame->races[v31].Unknown_1CB[0];
        pGame->races[v31].Unknown_1C9 = v32;
        v33 = v5 + 0x1E;
        LOWORD(v32) = pGame->races[v31].Unknown_1CB[1];
        pGame->races[v31].Unknown_1CB[0] = v33;
        LOWORD(v33) = pGame->races[v31]._allianceMaxScore;
        pGame->races[v31].Unknown_1CB[1] = v32;
        v33 += 0x1E;
        LOWORD(v32) = pGame->races[v31].Unknown_1D1;
        pGame->races[v31]._allianceMaxScore = v33;
        LOWORD(v33) = pGame->races[v31].Unknown_1D3;
        pGame->races[v31].Unknown_1D1 = v32;
        v5 = v33 + 0x28;
        LOWORD(v32) = pGame->races[v31].Unknown_1D5;
        pGame->races[v31].Unknown_1D3 = v5;
        *(_DWORD *)&Unknown_1C9 = v32 - 0x1E;
        pGame->races[v31].Unknown_1D5 = Unknown_1C9;
      }
    }
    else if ( atmosphere == 2 )
    {
      for ( kk = 0; (__int16)kk < pGame->racesNum; ++kk )
      {
        v35 = (__int16)kk;
        Unknown_1C9 = pGame->races[v35].Unknown_1C9;
        v36 = *(_DWORD *)&Unknown_1C9 + 0x14;
        LOWORD(v5) = pGame->races[v35].Unknown_1CB[0];
        pGame->races[v35].Unknown_1C9 = v36;
        v37 = v5 + 0x14;
        LOWORD(v36) = pGame->races[v35].Unknown_1CB[1];
        pGame->races[v35].Unknown_1CB[0] = v37;
        LOWORD(v37) = pGame->races[v35]._allianceMaxScore;
        pGame->races[v35].Unknown_1CB[1] = v36;
        v37 += 0x14;
        LOWORD(v36) = pGame->races[v35].Unknown_1D1;
        pGame->races[v35]._allianceMaxScore = v37;
        LOWORD(v37) = pGame->races[v35].Unknown_1D3;
        pGame->races[v35].Unknown_1D1 = v36;
        v5 = v37 + 0x1E;
        LOWORD(v36) = pGame->races[v35].Unknown_1D5;
        pGame->races[v35].Unknown_1D3 = v5;
        *(_DWORD *)&Unknown_1C9 = v36 - 0x14;
        pGame->races[v35].Unknown_1D5 = Unknown_1C9;
      }
    }
  }
  else
  {
    for ( mm = 0; (__int16)mm < pGame->racesNum; ++mm )
    {
      v27 = (__int16)mm;
      Unknown_1C9 = pGame->races[v27].Unknown_1C9;
      v28 = *(_DWORD *)&Unknown_1C9 + 0x14;
      LOWORD(v5) = pGame->races[v27].Unknown_1CB[0];
      pGame->races[v27].Unknown_1C9 = v28;
      v29 = v5 + 0x14;
      LOWORD(v28) = pGame->races[v27].Unknown_1CB[1];
      pGame->races[v27].Unknown_1CB[0] = v29;
      LOWORD(v29) = pGame->races[v27]._allianceMaxScore;
      pGame->races[v27].Unknown_1CB[1] = v28;
      v29 += 0x14;
      LOWORD(v28) = pGame->races[v27].Unknown_1D1;
      pGame->races[v27]._allianceMaxScore = v29;
      LOWORD(v29) = pGame->races[v27].Unknown_1D3;
      pGame->races[v27].Unknown_1D1 = v28;
      v5 = v29 + 0x1E;
      LOWORD(v28) = pGame->races[v27].Unknown_1D5;
      pGame->races[v27].Unknown_1D3 = v5;
      *(_DWORD *)&Unknown_1C9 = v28 - 0x14;
      pGame->races[v27].Unknown_1D5 = Unknown_1C9;
    }
  }
  pGame->pCurStar = pGame->races[0]._homeStar;
  pGame->shipsNum = 0;
  for ( nn = 0; ; ++nn )
  {
    result = (P_Game)nn;
    if ( nn >= 0x6B )
    {
      break;
    }
    v39 = nn;
    pGame->ships[v39].raceIndex = 0xFFFF;
    pGame->ships[v39].locationType = 0;
    pGame->ships[v39].pLocation.pPlanet = 0;
  }
  if ( pGame->racesNum > 0 )
  {
    v52 = 0;
    do
    {
      if ( pGame->races[v52].ability == 3 && v52 == V_PlayerRaceIndex )
      {
        result = (P_Game)(V_PlayerRaceIndex ^ v52);
        for ( i1 = 0; (int)result + i1 < pGame->racesNum; ++i1 )
        {
          pGame->races[i1]._homeStar->exploredBits |= 1 << v52;
        }
      }
      else
      {
        ability = pGame->races[v52].ability;
        if ( ability == 0xF )
        {
          for ( result = 0; (int)result < pGame->lanesNum; result = (P_Game)((char *)result + 1) )
          {
            pGame->lanes[(_DWORD)result].exploredBits |= 1 << v52;
          }
        }
        else if ( ability == 4 )
        {
          result = pGame;
          for ( i2 = 0; i2 < pGame->racesNum; ++i2 )
          {
            if ( v52 != i2 )
            {
              pGame->races[v52]._treatiesScore[i2] = pGame->races[v52].Unknown_1D5;
              pGame->races[v52].treaties[i2] = 1;
              pGame->races[i2]._treatiesScore[v52] = pGame->races[i2].Unknown_1D5;
              pGame->races[i2].treaties[v52] = 1;
            }
          }
        }
      }
      ++v52;
    }
    while ( v52 < pGame->racesNum );
  }
  return result;
}
// 1E7E7: variable 'v48' is possibly undefined
// 106FB4: using guessed type __int16 word_106FB4[7];

//----- (0001EE08) --------------------------------------------------------
char __fastcall sub_1EE08(int a1, char a2)
{
  int v2; // esi
  __int16 v3; // cx
  unsigned int v4; // edi
  __int16 v5; // ax
  __int16 v7; // [esp+2h] [ebp-14h]

  v2 = a1;
  *(_BYTE *)(a1 + 8) = a2;
  v3 = 1;
  v4 = 0xFFFFFFFF;
  if ( *(__int16 *)(a1 + 0xD88) > 1 )
  {
    do
    {
LABEL_4:
      while ( v4 )
      {
        v4 = 0;
        v7 = rand() % 7;
        v5 = 0;
        if ( v3 > 0 )
        {
          while ( *(unsigned __int8 *)(0x1EE * v5 + v2 + 8) != v7 )
          {
            if ( ++v5 >= v3 )
            {
              goto LABEL_4;
            }
          }
          v4 = 0xFFFFFFFF;
        }
      }
      LOBYTE(a1) = v7;
      *(_BYTE *)(0x1EE * v3++ + v2 + 8) = v7;
      v4 = 0xFFFFFFFF;
    }
    while ( v3 < *(__int16 *)(v2 + 0xD88) );
  }
  return a1;
}
// 1EE39: variable 'v7' is possibly undefined

//----- (0001EEA4) --------------------------------------------------------
__int16 __fastcall sub_1EEA4(P_Game pGame)
{
  P_Game v1; // ebp
  int v2; // edx
  __int16 nameIndex; // si
  int v4; // esi
  int v5; // ecx
  char s[24]; // [esp+0h] [ebp-38h] BYREF
  int v8; // [esp+18h] [ebp-20h]
  int v9; // [esp+1Ch] [ebp-1Ch]

  v1 = pGame;
  if ( pGame->racesNum > 0 )
  {
    v9 = 0x15;
    v8 = 7;
    v5 = 0;
    do
    {
      v2 = (__int16)v5;
      nameIndex = v1->races[v2]._nameIndex;
      sprintf(s, "DATA\\SMRACE%02d.SHP", v1->races[v2]._nameIndex);
      sub_1AEB0(&WinMgr.cache, v5, s);
      sprintf(s, "DATA\\LGRACE%02d.SHP", nameIndex);
      sub_1AEB0(&WinMgr.cache, v8, s);
      sprintf(s, "DATA\\SMSHIP%02d.SHP", nameIndex);
      sub_1AEB0(&WinMgr.cache, 0xEu, s);
      ++v5;
      sprintf(s, "DATA\\DKSHIP%02d.SHP", nameIndex);
      v4 = v8;
      sub_1AEB0(&WinMgr.cache, v9, s);
      LOWORD(pGame) = v1->racesNum;
      v8 = v4 + 1;
    }
    while ( (__int16)v5 < (__int16)pGame );
  }
  return (__int16)pGame;
}

//----- (0001EFC0) --------------------------------------------------------
void __fastcall sub_1EFC0(P_Game a1)
{
  int i; // eax

  memset(a1->lanes, 0, sizeof(a1->lanes));
  a1->lanesNum = 0;
  sub_1F91C();
  a1->t10.f = 2;
  while ( a1->t10.f > 1 )
  {
    for ( i = 0; (__int16)i < a1->starsNum; ++i )
    {
      a1->stars[(__int16)i].Unknown_6 = 0xFFFF;
    }
    sub_1FB34(a1);
    sub_201D8(a1);
  }
}

//----- (0001F038) --------------------------------------------------------
unsigned int __fastcall sub_1F038(P_Game pGame)
{
  int v2; // edi
  UBYTE *v3; // edx
  int i; // ecx
  T_Lane *lanes; // kr10_4
  unsigned __int8 index; // bl
  int v7; // edx
  unsigned __int8 v8; // bh
  unsigned __int8 v9; // bh
  unsigned __int8 v10; // bh
  unsigned __int8 v11; // al
  UBYTE *v12; // eax
  UBYTE *v13; // edx
  unsigned int result; // eax
  int v15; // kr28_4
  char *v16; // ebp
  int v17; // ebx
  int v18; // edx
  UBYTE v19; // cl
  char *v20; // eax
  int v21; // edx
  int j; // kr04_4
  int k; // ecx
  int m; // ecx
  int v25; // kr1C_4
  char v26[100][10]; // [esp+0h] [ebp-474h]
  char v27[100]; // [esp+3E8h] [ebp-8Ch]
  int v28; // [esp+44Ch] [ebp-28h]
  UBYTE *v29; // [esp+450h] [ebp-24h]
  int v30; // [esp+454h] [ebp-20h]
  int v31; // [esp+458h] [ebp-1Ch]
  int v32; // [esp+45Ch] [ebp-18h]
  unsigned int v33; // [esp+460h] [ebp-14h]
  int v34; // [esp+464h] [ebp-10h]
  unsigned __int8 v35; // [esp+468h] [ebp-Ch]
  unsigned __int8 v36; // [esp+46Ch] [ebp-8h]
  unsigned __int8 v37; // [esp+470h] [ebp-4h]

  if ( pGame->t10.f != 1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5BA);
  }
  v2 = (pGame->starsNum - 1) * pGame->starsNum;
  v29 = V_BigBuffer;
  if ( !V_BigBuffer )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5C2);
  }
  v3 = v29;
  for ( i = 0; i < pGame->starsNum; ++i )
  {
    for ( j = 0; i + 1 + j < pGame->starsNum; ++j )
    {
      v3[2 * j + 1] = i + 1;
      v3[2 * j] = i;
    }
  }
  if ( v3 - v29 != v2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5D1);
  }
  memset(pGame->starConnections, 0xFF, sizeof(pGame->starConnections));
  v32 = v2 >> 1;
  for ( k = 0; k < pGame->starsNum; ++k )
  {
    pGame->starConnections[k][k] = 0;
    v27[k] = 0;
  }
  lanes = pGame->lanes;
  for ( m = 0; m < pGame->lanesNum; ++m )
  {
    index = lanes[m].pStar1->index;
    v37 = lanes[m].pStar2->index;
    v7 = v37;
    pGame->starConnections[index][v37] = 1;
    pGame->starConnections[v7][index] = 1;
    v8 = v27[index];
    v30 = v8;
    v27[index] = v8 + 1;
    v9 = v27[v7];
    v26[index][v30] = v7;
    v30 = v9;
    v10 = v9 + 1;
    v27[v7] = v10;
    v11 = v27[index];
    v26[v7][v30] = index;
    if ( v11 >= 0xAu || v10 >= 0xAu )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x5F3);
    }
  }
  v12 = v29;
  v13 = &v29[2 * v32 - 2];
  if ( v13 >= v29 )
  {
    do
    {
      if ( pGame->starConnections[*v12][v12[1]] == 1 )
      {
        *v12 = *v13;
        v12[1] = v13[1];
        v13 += 0xFFFFFFFE;
        --v32;
      }
      else
      {
        v12 += 2;
      }
    }
    while ( v12 <= v13 );
  }
  result = v32;
  v28 = 2;
  if ( v32 > 0 )
  {
    v15 = v28;
    v31 = 1;
    v25 = 0;
    do
    {
      if ( pGame->starsNum <= v15 + v25 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x610);
      }
      v16 = (char *)v29;
      result = (unsigned int)&v29[2 * v32 - 2];
      v33 = result;
      if ( (unsigned int)v29 <= result )
      {
        v34 = v25 + 1;
        do
        {
          v36 = *v16;
          v35 = v16[1];
          for ( result = 0; (__int16)result < (int)(unsigned __int8)v27[v36]; ++result )
          {
            v17 = v36;
            v18 = v35;
            if ( pGame->starConnections[(unsigned __int8)v26[v36][(__int16)result]][v35] == v34 )
            {
              v19 = v28;
              pGame->starConnections[v36][v35] = v28;
              v20 = (char *)v33;
              pGame->starConnections[v18][v17] = v19;
              *v16 = *v20;
              v16 += 0xFFFFFFFE;
              v21 = v32;
              v16[3] = *(_BYTE *)(v33 + 1);
              result = v33 - 2;
              v32 = v21 - 1;
              v33 -= 2;
              break;
            }
          }
          v16 += 2;
        }
        while ( (unsigned int)v16 <= v33 );
      }
      ++v25;
    }
    while ( v32 > 0 );
  }
  return result;
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (0001F404) --------------------------------------------------------
int __fastcall sub_1F404(P_Game pGame)
{
  T_Star *kr18_4_1; // kr18_4
  T_Planet *planet; // ebp
  char *v3; // kr00_4
  double v4; // st7
  char *v5; // kr2C_4
  int v6; // ebx
  int v7; // edx
  unsigned __int8 v8; // dl
  WORD v9; // ax
  P_Game v10; // ecx
  UWORD v11; // ax
  P_Game v12; // edx
  double v13; // st7
  P_Game v14; // edx
  int v1; // eax
  int v16; // kr14_4
  float angle; // [esp-4h] [ebp-11Ch]
  int v18[21]; // [esp+0h] [ebp-118h] BYREF
  int v19[21]; // [esp+54h] [ebp-C4h] BYREF
  T_Vector3D vector; // [esp+A8h] [ebp-70h]
  float v21[3]; // [esp+B4h] [ebp-64h] BYREF
  T_Vector3D vec1; // [esp+C0h] [ebp-58h] BYREF
  float v23; // [esp+CCh] [ebp-4Ch]
  float *v24; // [esp+D0h] [ebp-48h]
  P_Star v25; // [esp+D4h] [ebp-44h]
  T_Square *squares; // [esp+D8h] [ebp-40h]
  char *v27; // [esp+DCh] [ebp-3Ch]
  int v28; // [esp+E0h] [ebp-38h]
  int v29; // [esp+E4h] [ebp-34h]
  float v30; // [esp+E8h] [ebp-30h]
  int j; // [esp+ECh] [ebp-2Ch]
  T_Star *stars; // [esp+F0h] [ebp-28h]
  int numPlanets; // [esp+F4h] [ebp-24h]
  int v34; // [esp+F8h] [ebp-20h]
  T_Star *v35; // [esp+FCh] [ebp-1Ch]
  int v36; // [esp+100h] [ebp-18h]
  int v37; // [esp+104h] [ebp-14h]
  int v38; // [esp+108h] [ebp-10h]
  char *name; // [esp+10Ch] [ebp-Ch]
  P_Game v40; // [esp+110h] [ebp-8h]
  int i; // [esp+114h] [ebp-4h]

  v40 = pGame;
  stars = pGame->stars;
  kr18_4_1 = pGame->stars;
  squares = pGame->squares;
  planet = pGame->planets;
  v25 = (P_Star)pGame->stars[0].name;
  v3 = pGame->stars[0].name;
  for ( j = 0; ; ++j )
  {
    v1 = v40->starsNum;
    if ( v1 <= j )
    {
      break;
    }
    numPlanets = rand() % 5 + 1;
    if ( numPlanets > 5 )
    {
      numPlanets = 5;
    }
    v38 = 0xFFFFFFFF;
    for ( i = 0; v40->racesNum > i; ++i )
    {
      if ( &kr18_4_1[j] == v40->races[i]._homeStar )
      {
        v38 = i;
        break;
      }
    }
    if ( v38 >= 0 && !numPlanets )
    {
      numPlanets = 1;
    }
    v34 = 0;
    if ( v38 >= 0 )
    {
      v34 = rand() % numPlanets;
    }
    kr18_4_1[j].planetsNum = numPlanets;
    memset(&vec1, 0, sizeof(vec1));
    v4 = (double)word_964FA[kr18_4_1[j].type];
    v36 = 0;
    i = 0;
    v30 = v4;
    v28 = 360 / numPlanets;
    if ( numPlanets > 0 )
    {
      v27 = &v3[0x60 * j];
      v37 = 0;
      v35 = &kr18_4_1[j];
      v29 = (int)v40 + 0x1EE * v38;
      name = planet->name;
      v5 = planet->name;
      v16 = 0;
      do
      {
        kr18_4_1[j].planets[v16] = &planet[v16];
        LOWORD(v6) = rand() % 5;
        LOWORD(v7) = rand() % 0xB;
        if ( v38 >= 0 && v34 == i )
        {
          qmemcpy(v18, dword_96548, sizeof(v18));
          qmemcpy(v19, dword_9659C, sizeof(v19));
          v8 = *(_BYTE *)(v29 + 7);
          v6 = v18[v8];
          v7 = v19[v8];
        }
        planet[v16].totalSquaresNum = 0;
        planet[v16].pSquares = 0;
        v9 = j;
        planet[v16].z7 = 0;
        planet[v16].starIndex = v9;
        v10 = v40;
        planet[v16].Unknown_E = i;
        v11 = Q_Planet_Initialize_sub_33AF0(&planet[v16], v6, v7, &squares[v10->squaresNum]);
        v12 = v40;
        v40->squaresNum += v11;
        if ( v12->squaresNum > 20000 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x67B);
        }
        sprintf(&v5[0x7B * v16], "%s ", v27);
        Q_AppendRomanNum_sub_31E60(&v5[0x7B * v16], i + 1);
        v13 = ((double)word_964F0[v16] + v30) * 2000.0 * 0.011111111;
        v24 = v21;
        v23 = v13;
        vector.x = v23;
        vector.y = 0.0 * v23;
        vector.z = vector.y;
        v21[0] = v23;
        v21[1] = vector.y;
        v21[2] = vector.y;
        vec1.x = v23;
        vec1.y = vector.y;
        vec1.z = vector.y;
        angle = (float)v36;
        Q_RotateVectorY_sub_532AC(&vec1, angle);
        Q_Planet_SetPosition_sub_362C8(&planet[v16], &vec1);
        if ( v38 >= 0 && v34 == i )
        {
          planet[v16].raceIndex = v38;
          planet[v16].word42 = 2;
          Q_Planet_BuildAtOptimalLocation_sub_34AE4(&planet[v16], 5u, 0xFFFFFFFF);
        }
        ++i;
        v36 += v28;
        ++v16;
      }
      while ( i < numPlanets );
    }
    v14 = v40;
    v40->planetsNum += numPlanets;
    if ( v14->planetsNum >= 0x1F4 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x697);
    }
  }
  return v1;
}
// 96548: using guessed type int dword_96548[21];
// 9659C: using guessed type int dword_9659C[21];

//----- (0001F91C) --------------------------------------------------------
int sub_1F91C()
{
  int result; // eax
  T_Star *v1; // edx
  int type; // eax
  int v3; // esi
  WORD starsNum; // ax
  T_Vector3D *p_pos; // ebx
  WORD v6; // dx
  T_Star *v7; // eax
  double v8; // st7
  WORD v9; // dx
  int v10[3]; // [esp+14h] [ebp-48h] BYREF
  float v11; // [esp+20h] [ebp-3Ch]
  float v12; // [esp+24h] [ebp-38h]
  float v13; // [esp+28h] [ebp-34h]
  int *v14; // [esp+2Ch] [ebp-30h]
  T_Star *v15; // [esp+30h] [ebp-2Ch]
  T_Star *stars; // [esp+34h] [ebp-28h]
  int v17; // [esp+38h] [ebp-24h]
  int v18; // [esp+3Ch] [ebp-20h]
  WORD v19; // [esp+40h] [ebp-1Ch]

  memset(V_Game.starConnections, 0, sizeof(V_Game.starConnections));
  for ( result = 0; (__int16)result < V_Game.starsNum; ++result )
  {
    *((_BYTE *)&V_Game.day + 0x64 * (__int16)result + (__int16)result + (_DWORD)&loc_32DDA + 1) = 1;
  }
  if ( V_Game.starsNum > 0 )
  {
    LOWORD(v18) = 0;
    stars = V_Game.stars;
    do
    {
      v1 = &stars[(__int16)v18];
      type = v1->type;
      v15 = v1;
      if ( v1->lanesNum != word_9652E[type] )
      {
        v3 = 0x1388;
        starsNum = V_Game.starsNum;
        v19 = 0xFFFF;
        p_pos = &v15->pos;
        v9 = 0;
        if ( starsNum > 0 )
        {
          do
          {
            if ( !*((_BYTE *)&V_Game.day + 0x64 * (__int16)v18 + v9 + (_DWORD)&loc_32DDA + 1) )
            {
              v7 = &stars[v9];
              if ( v7->lanesNum != word_9652E[v7->type] )
              {
                v14 = v10;
                v11 = 0.0;
                v12 = 0.0;
                v13 = 0.0;
                v11 = p_pos->x - v7->pos.x;
                v12 = p_pos->y - v7->pos.y;
                v13 = p_pos->z - v7->pos.z;
                *(float *)v10 = v11;
                *(float *)&v10[1] = v12;
                *(float *)&v10[2] = v13;
                v8 = sqrt(v12 * v12 + v11 * v11 + v13 * v13);
                v17 = (int)v8;
                if ( v3 > (int)v8 )
                {
                  v3 = (int)v8;
                  v19 = v9;
                }
              }
            }
            ++v9;
          }
          while ( v9 < V_Game.starsNum );
        }
        if ( v19 != 0xFFFFFFFF && !sub_1CF68(v15, &stars[v19]) )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x6D0);
        }
      }
      result = v18 + 1;
      v6 = V_Game.starsNum;
      LOWORD(v18) = result;
    }
    while ( (__int16)result < v6 );
  }
  return result;
}

//----- (0001FB34) --------------------------------------------------------
int __fastcall sub_1FB34(P_Game a1)
{
  WORD i; // bx
  int v3; // eax
  WORD f; // dx
  T_Type09 *v5; // ecx
  float *p_c; // edx
  float *v7; // eax
  double v8; // st7
  double v9; // st7
  double v10; // st7
  __int16 v11; // bx
  WORD b; // ax
  WORD g; // dx
  WORD v14; // cx
  int result; // eax
  int j; // ebx
  float v17; // [esp+0h] [ebp-58h] BYREF
  float v18; // [esp+4h] [ebp-54h]
  float v19; // [esp+8h] [ebp-50h]
  float v20; // [esp+Ch] [ebp-4Ch]
  float v21; // [esp+10h] [ebp-48h]
  float v22; // [esp+14h] [ebp-44h]
  float v23; // [esp+18h] [ebp-40h] BYREF
  float v24; // [esp+1Ch] [ebp-3Ch]
  float v25; // [esp+20h] [ebp-38h]
  float v26; // [esp+24h] [ebp-34h]
  float v27; // [esp+28h] [ebp-30h]
  float v28; // [esp+2Ch] [ebp-2Ch]
  float *v29; // [esp+30h] [ebp-28h]
  float *v30; // [esp+34h] [ebp-24h]
  int v31; // [esp+38h] [ebp-20h]
  __int16 k; // [esp+3Ch] [ebp-1Ch]

  a1->t10.f = 0;
  memset(&a1->t10, 0, 0x26D0u);
  for ( i = 0; i < a1->starsNum; ++i )
  {
    v3 = i;
    if ( a1->stars[v3].Unknown_6 == 0xFFFFFFFF )
    {
      sub_1FD18(a1, (int)&a1->stars[v3]);
      ++a1->t10.f;
    }
  }
  a1->g = 0;
  f = a1->t10.f;
  k = 0;
  if ( f > 0 )
  {
    do
    {
      v5 = &a1->t10.a.a[k];
      p_c = (float *)&v5->c.c;
      for ( j = 0; (__int16)j < v5->b; ++j )
      {
        v7 = (float *)v5->a[(__int16)j];
        v29 = &v17;
        v20 = 0.0;
        v21 = 0.0;
        v22 = 0.0;
        v20 = *p_c + v7[2];
        v21 = *(float *)&v5->c.e + v7[3];
        v8 = *(float *)&v5->c.f + v7[4];
        v17 = v20;
        v22 = v8;
        v18 = v21;
        v19 = v22;
        *p_c = v20;
        *(float *)&v5->c.e = v18;
        *(float *)&v5->c.f = v19;
      }
      v9 = 1.0 / (double)v5->b;
      v30 = &v23;
      v26 = 0.0;
      v27 = 0.0;
      v28 = 0.0;
      v26 = *p_c * v9;
      v27 = *(float *)&v5->c.e * v9;
      v10 = v9 * *(float *)&v5->c.f;
      v23 = v26;
      v28 = v10;
      v24 = v27;
      v25 = v28;
      *p_c = v26;
      *(float *)&v5->c.e = v24;
      v11 = k;
      *(float *)&v5->c.f = v25;
      ++v11;
      b = v5->b;
      g = a1->g;
      k = v11;
      v14 = a1->t10.f;
      a1->g = b + g;
    }
    while ( v11 < v14 );
  }
  v31 = (int)((double)a1->g / (double)a1->t10.f);
  result = v31;
  a1->g = v31;
  return result;
}

//----- (0001FD18) --------------------------------------------------------
void __fastcall sub_1FD18(P_Game a1, int a2)
{
  __int16 v4; // bx
  int v5; // edx
  int v6; // edx

  *(_WORD *)(a2 + 6) = a1->t10.f;
  sub_2016C(a1, a2, a1->t10.f);
  if ( *(__int16 *)(a2 + 0x44) > 0 )
  {
    v4 = 0;
    do
    {
      v5 = **(_DWORD **)(a2 + 4 * v4 + 0x2C);
      if ( *(__int16 *)(v5 + 6) == 0xFFFFFFFF )
      {
        sub_1FD18(a1, v5);
      }
      v6 = *(_DWORD *)(*(_DWORD *)(a2 + 4 * v4 + 0x2C) + 4);
      if ( *(__int16 *)(v6 + 6) == 0xFFFFFFFF )
      {
        sub_1FD18(a1, v6);
      }
      ++v4;
    }
    while ( v4 < *(__int16 *)(a2 + 0x44) );
  }
}

//----- (0001FD90) --------------------------------------------------------
int __fastcall sub_1FD90(int a1, int a2, int a3)
{
  int v6; // eax
  WORD starsNum; // bx
  int v8; // edx

  if ( !a2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x71E);
  }
  v6 = 0;
  if ( V_Game.starsNum > 0 )
  {
    do
    {
      starsNum = V_Game.starsNum;
      v8 = (__int16)v6++;
      *(_BYTE *)(v8 + a2) = 0;
    }
    while ( (__int16)v6 < starsNum );
  }
  return sub_1FDF0(a1, *(_DWORD *)(a1 + 0x1EE * a3 + 0xD), a2, a3);
}

//----- (0001FDF0) --------------------------------------------------------
int __fastcall sub_1FDF0(int a1, int a2, int a3, int a4)
{
  int result; // eax
  int v5; // esi
  _BYTE *v6; // ebp
  WORD v7; // dx
  __int16 j; // bx
  int raceIndex; // eax
  int v11; // [esp+4h] [ebp-24h]
  WORD i; // [esp+14h] [ebp-14h]
  __int16 v15; // [esp+14h] [ebp-14h]
  char v16; // [esp+18h] [ebp-10h]

  v16 = 0;
  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    if ( *(_BYTE *)(0x1EE * a4 + a1 + i + 0x1C6) == 3 )
    {
      v16 |= 1 << i;
    }
  }
  result = a2;
  if ( *(__int16 *)(a2 + 0x44) > 0 )
  {
    v15 = 0;
    v11 = 1 << a4;
    do
    {
      v5 = *(_DWORD *)(a2 + 4 * v15 + 0x2C);
      result = *(__int16 *)(v5 + 0x21);
      if ( result != a4 )
      {
        if ( *(_DWORD *)v5 == a2 )
        {
          v6 = *(_BYTE **)(v5 + 4);
        }
        else
        {
          v6 = *(_BYTE **)v5;
        }
        if ( ((unsigned __int8)v11 & v6[0x17]) != 0 )
        {
          if ( (~v11 & ((unsigned __int8)(v6[0x15] & ~v16) | (unsigned __int8)(~v16 & v6[0x14])) & 0x7F) != 0 )
          {
            result = a3 + *(__int16 *)(a2 + 4);
            ++*(_BYTE *)result;
          }
          else
          {
            v7 = 0;
            for ( j = 0; j < 0x6B; ++j )
            {
              if ( v7 >= V_Game.shipsNum )
              {
                break;
              }
              raceIndex = V_Game.ships[j].raceIndex;
              if ( raceIndex != 0xFFFFFFFF )
              {
                ++v7;
                if ( (P_Planet)v5 == V_Game.ships[j].pLocation.pPlanet
                  && raceIndex != a4
                  && *(_BYTE *)(0x1EE * a4 + a1 + raceIndex + 0x1C6) != 3 )
                {
                  break;
                }
              }
            }
            if ( v7 < V_Game.shipsNum )
            {
              result = a3 + *(__int16 *)(a2 + 4);
              ++*(_BYTE *)result;
            }
            else
            {
              *(_WORD *)(v5 + 0x21) = a4;
              result = sub_1FDF0(a1, (int)v6, a3, a4);
            }
          }
        }
        else
        {
          result = a3 + *(__int16 *)(a2 + 4);
          ++*(_BYTE *)result;
        }
      }
      ++v15;
    }
    while ( v15 < *(__int16 *)(a2 + 0x44) );
  }
  return result;
}

//----- (0001FFE0) --------------------------------------------------------
int __fastcall sub_1FFE0(P_Game a1, int a2)
{
  int result; // eax
  _BYTE *v4; // edi
  WORD v5; // dx
  __int16 j; // bx
  int v7; // esi
  WORD i; // [esp+4h] [ebp-1Ch]
  __int16 v10; // [esp+4h] [ebp-1Ch]
  char v11; // [esp+8h] [ebp-18h]

  v11 = 0;
  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    if ( V_Game.races[V_PlayerRaceIndex].treaties[i] == 3 )
    {
      v11 |= 1 << i;
    }
  }
  result = a2;
  if ( *(__int16 *)(a2 + 0x44) > 0 )
  {
    v10 = 0;
    do
    {
      result = a2 + 4 * v10;
      v7 = *(_DWORD *)(result + 0x2C);
      if ( !*(_WORD *)(v7 + 0x21) )
      {
        v4 = *(_DWORD *)v7 == a2 ? *(_BYTE **)(v7 + 4) : *(_BYTE **)v7;
        result = (unsigned __int8)v4[0x17];
        if ( ((1 << V_PlayerRaceIndex) & result) != 0 )
        {
          result = ((unsigned __int8)(v4[0x15] & ~v11) | (unsigned __int8)(~v11 & v4[0x14])) & 0x7F;
          if ( (~(1 << V_PlayerRaceIndex) & result) == 0 )
          {
            v5 = 0;
            for ( j = 0; ; ++j )
            {
              result = j;
              if ( j >= 0x6B )
              {
                break;
              }
              if ( v5 >= V_Game.shipsNum )
              {
                break;
              }
              result = V_Game.ships[j].raceIndex;
              if ( result != 0xFFFFFFFF )
              {
                ++v5;
                if ( (P_Planet)v7 == V_Game.ships[j].pLocation.pPlanet
                  && result != V_PlayerRaceIndex
                  && V_Game.races[V_PlayerRaceIndex].treaties[result] != 3 )
                {
                  break;
                }
              }
            }
            if ( v5 >= V_Game.shipsNum )
            {
              *(_WORD *)(v7 + 0x21) = 1;
              ++a1->starsControlled;
              result = sub_1FFE0(a1, (int)v4);
            }
          }
        }
      }
      ++v10;
    }
    while ( v10 < *(__int16 *)(a2 + 0x44) );
  }
  return result;
}

//----- (0002016C) --------------------------------------------------------
void __fastcall sub_2016C(P_Game a1, int a2, __int16 a3)
{
  T_Type09 *v3; // ecx

  if ( a3 >= 24 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7BB);
  }
  v3 = &a1->t10.a.a[a3];
  if ( v3->b >= 100 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7BE);
  }
  v3->a[v3->b++] = a2;
}

//----- (000201D8) --------------------------------------------------------
void __fastcall sub_201D8(P_Game a1)
{
  __int16 *v1; // ecx
  __int16 *v2; // esi
  int v3; // eax
  float *v4; // edi
  float *v5; // eax
  float v6; // ebx
  __int16 i; // dx
  T_Type09 *v8; // ebx
  double v9; // st7
  __int16 j; // bx
  int v11; // edx
  double v12; // st7
  int v13; // eax
  T_Lane *v14; // eax
  int v15; // eax
  __int16 v16; // dx
  float v17; // [esp+8h] [ebp-88h]
  int v18; // [esp+Ch] [ebp-84h]
  int v19; // [esp+10h] [ebp-80h]
  float v20; // [esp+14h] [ebp-7Ch]
  int v21; // [esp+18h] [ebp-78h]
  int v22; // [esp+1Ch] [ebp-74h]
  int v23[3]; // [esp+20h] [ebp-70h] BYREF
  int v24[3]; // [esp+2Ch] [ebp-64h] BYREF
  float v25; // [esp+38h] [ebp-58h]
  int v26; // [esp+3Ch] [ebp-54h]
  int v27; // [esp+40h] [ebp-50h]
  int v28; // [esp+44h] [ebp-4Ch]
  int *v29; // [esp+48h] [ebp-48h]
  int *v30; // [esp+4Ch] [ebp-44h]
  T_Type10 *p_t10; // [esp+50h] [ebp-40h]
  int assert; // [esp+54h] [ebp-3Ch]
  int v33; // [esp+58h] [ebp-38h]
  int v34; // [esp+5Ch] [ebp-34h]
  P_Game v35; // [esp+60h] [ebp-30h]
  int v36; // [esp+64h] [ebp-2Ch]
  int v37; // [esp+68h] [ebp-28h]
  int v38; // [esp+6Ch] [ebp-24h]
  __int16 v39; // [esp+70h] [ebp-20h]
  WORD k; // [esp+74h] [ebp-1Ch]

  v35 = a1;
  v25 = 0.0;
  v26 = 0;
  v27 = 0;
  if ( !a1->t10.f )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7DD);
  }
  if ( v35->t10.f != 1 && v35->t10.f > 0 )
  {
    v1 = 0;
    p_t10 = &v35->t10;
    k = 0;
    do
    {
      v2 = (__int16 *)&p_t10->a.a[k];
      v33 = 99999;
      v34 = 99999;
      assert = 0;
      v3 = (unsigned __int16)v2[0xC8];
      v39 = 0;
      v4 = 0;
      v16 = 0;
      if ( (__int16)v3 > 0 )
      {
        do
        {
          v5 = *(float **)&v2[2 * v16];
          LODWORD(v6) = 2 * *(_DWORD *)v5;
          v28 = *(__int16 *)((char *)word_9652E + LODWORD(v6));
          v38 = *((__int16 *)v5 + 0x22);
          v28 -= v38;
          v38 = v39;
          if ( v28 > v39 )
          {
            v4 = v5;
            v39 = *(__int16 *)((char *)word_9652E + LODWORD(v6)) - *((_WORD *)v5 + 0x22);
          }
          ++v16;
        }
        while ( v16 < v2[0xC8] );
      }
      if ( !v4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x7FF);
      }
      for ( i = 0; i < *(__int16 *)((char *)&v35->day + (_DWORD)&loc_32DCD + 4); ++i )
      {
        if ( i != k )
        {
          v8 = &p_t10->a.a[i];
          v30 = v23;
          v17 = v4[2] - *(float *)&v8->c.c;
          *(float *)&v18 = v4[3] - *(float *)&v8->c.e;
          *(float *)&v19 = v4[4] - *(float *)&v8->c.f;
          *(float *)v23 = v17;
          v23[1] = v18;
          v23[2] = v19;
          v25 = v17;
          v26 = v18;
          v27 = v19;
          v9 = sqrt(*(float *)&v18 * *(float *)&v18 + v17 * v17 + *(float *)&v19 * *(float *)&v19);
          v37 = (int)v9;
          if ( (int)v9 < v33 )
          {
            v1 = (__int16 *)v8;
            v33 = (int)v9;
          }
        }
      }
      if ( !v1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x813);
      }
      for ( j = 0; j < v1[0xC8]; ++j )
      {
        v11 = *(_DWORD *)&v1[2 * j];
        if ( !*((_BYTE *)&v35->day + 0x64 * *((__int16 *)v4 + 2) + *(__int16 *)(v11 + 4) + (_DWORD)&loc_32DDA + 1) )
        {
          v29 = v24;
          v20 = v4[2] - *(float *)(v11 + 8);
          *(float *)&v21 = v4[3] - *(float *)(v11 + 0xC);
          *(float *)&v22 = v4[4] - *(float *)(v11 + 0x10);
          *(float *)v24 = v20;
          v24[1] = v21;
          v24[2] = v22;
          v25 = v20;
          v26 = v21;
          v27 = v22;
          v12 = sqrt(*(float *)&v21 * *(float *)&v21 + v20 * v20 + *(float *)&v22 * *(float *)&v22);
          v38 = word_9652E[*(_DWORD *)v11];
          v13 = *(__int16 *)(v11 + 0x44);
          v36 = (int)v12;
          if ( v38 != v13 && v36 < v34 )
          {
            assert = v11;
            v34 = v36;
          }
        }
      }
      if ( !assert )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x82C);
      }
      v14 = sub_1CF68((T_Star *)v4, (T_Star *)assert);
      if ( !v14 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x832);
      }
      v14->flags |= 1u;
      v15 = assert;
      *((_BYTE *)v4 + 0x18) |= 1u;
      *(_BYTE *)(v15 + 0x18) |= 1u;
      ++k;
    }
    while ( k < v35->t10.f );
  }
}

//----- (000205A0) --------------------------------------------------------
T_Lane *__fastcall sub_205A0(P_Game a1, T_Star *a2, T_Star *a3)
{
  int lanesNum; // ebx
  T_Lane *v6; // edx

  if ( !a2 || !a3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x83F);
  }
  lanesNum = a1->lanesNum;
  if ( lanesNum == 0x94 || *((_BYTE *)&a1->day + 0x64 * a2->index + a3->index + (_DWORD)&loc_32DDA + 1) )
  {
    return 0;
  }
  v6 = &a1->lanes[lanesNum];
  v6->exploredBits = 0;
  v6->pStar1 = a2;
  v6->pStar2 = a3;
  ++a1->lanesNum;
  *((_BYTE *)&a1->day + 0x64 * a2->index + a3->index + (_DWORD)&loc_32DDA + 1) = 1;
  *((_BYTE *)&a1->day + 0x64 * a3->index + a2->index + (_DWORD)&loc_32DDA + 1) = 1;
  return v6;
}

//----- (00020684) --------------------------------------------------------
P_Ship __fastcall sub_20684(P_Game pGame, __int16 raceIndex)
{
  T_Ship *ships; // kr00_4
  int v5; // kr04_4
  P_Ship result; // eax
  __int16 i; // dx

  if ( raceIndex < 0 || raceIndex >= pGame->racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x863);
  }
  if ( pGame->shipsNum >= 107 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x864);
  }
  ships = pGame->ships;
  v5 = 0;
  for ( i = 0; i < 107; ++i )
  {
    if ( ships[v5].raceIndex == 0xFFFFFFFF )
    {
      sub_48C5C(&ships[v5], 0);
      ships[v5].raceIndex = raceIndex;
      result = &ships[v5];
      ++pGame->shipsNum;
      return result;
    }
    ++v5;
  }
  Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0x873);
  return 0;
}

//----- (00020720) --------------------------------------------------------
void __fastcall Q_Game_RemoveShip_sub_20720(P_Game pGame, P_Ship pShip)
{
  if ( pShip->raceIndex < 0 || pShip->raceIndex >= pGame->racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x87E);
  }
  if ( !pShip->locationType )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x87F);
  }
  pShip->raceIndex = 0xFFFF;
  pShip->locationType = ASCEND_LOCATION_TYPE_VOID;
  pShip->name[0] = '\0';
  if ( --pGame->shipsNum < 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x887);
  }
}

//----- (000207A0) --------------------------------------------------------
void __fastcall sub_207A0(P_Game a1)
{
  T_Race *v2; // ebp
  P_Game v3; // kr00_4
  BYTE v4; // bl
  int v5; // edx
  int v6; // eax
  BYTE atmosphere; // ch
  double v8; // st6
  int i; // eax
  int j; // eax
  int k; // eax
  int m; // eax
  int n; // edx
  int ii; // eax
  int jj; // edx
  int kk; // eax
  int v17; // [esp+8h] [ebp-24h]
  int v18; // [esp+8h] [ebp-24h]
  int v19; // [esp+8h] [ebp-24h]
  unsigned __int8 v20; // [esp+Ch] [ebp-20h]
  char v21; // [esp+10h] [ebp-1Ch]

  v21 = 0;
  v2 = &a1->races[V_PlayerRaceIndex];
  if ( v2->Unknown_03 == 0xFFFFFFFF )
  {
    v21 = 1;
  }
  if ( !v21 )
  {
    v3 = a1;
    v21 = 2;
    for ( i = 0; i < a1->racesNum; ++i )
    {
      if ( i != V_PlayerRaceIndex && !v3->races[i].Unknown_03 )
      {
        v21 = 0;
        break;
      }
    }
  }
  if ( !v21 )
  {
    v21 = 3;
    for ( j = 0; j < a1->racesNum; ++j )
    {
      if ( (a1->races[j]._homeStar->racesBits & 0x7F) != 1 << V_PlayerRaceIndex )
      {
        v21 = 0;
        break;
      }
    }
  }
  if ( !v21 )
  {
    v20 = 0;
    v21 = 4;
    for ( k = 0; k < a1->racesNum; ++k )
    {
      if ( !a1->races[k].Unknown_03 )
      {
        v20 |= 1 << k;
      }
      if ( k != V_PlayerRaceIndex && !a1->races[k].Unknown_03 && v2->treaties[k] != 3 )
      {
        v21 = 0;
        break;
      }
    }
    if ( v21 == 4 )
    {
      for ( m = 0; m < a1->starsNum; ++m )
      {
        if ( (v20 & a1->stars[m].exploredBits) == 0 )
        {
          v21 = 0;
          break;
        }
      }
    }
  }
  if ( !v21 && 2 * a1->starsNum / 3 + 1 <= a1->starsControlled )
  {
    v21 = 5;
  }
  if ( v21 )
  {
    v17 = 0;
    for ( n = 0; n < V_Research.num; ++n )
    {
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[n].knownToRace) != 0 )
      {
        ++v17;
      }
    }
    for ( ii = 0; ii < a1->planetsNum; ++ii )
    {
      if ( V_PlayerRaceIndex == a1->planets[ii].raceIndex )
      {
        v17 += 2;
      }
    }
    v18 = Q_Race_GetShips_sub_40224(v2, 0, 0) + v17;
    for ( jj = 0; jj < a1->starsNum; ++jj )
    {
      if ( ((1 << V_PlayerRaceIndex) & a1->stars[jj].exploredBits) != 0 )
      {
        ++v18;
      }
    }
    for ( kk = 0; kk < a1->racesNum; ++kk )
    {
      if ( kk != V_PlayerRaceIndex && a1->races[kk].Unknown_03 != 0xFFFFFFFF )
      {
        v4 = v2->treaties[kk];
        if ( v4 == 3 )
        {
          v18 += 15;
        }
        else if ( v4 == 2 )
        {
          v18 -= 10;
        }
      }
    }
    if ( v21 == 4 )
    {
      v18 += 50;
    }
    v5 = 100 - 75 * a1->day / 4000;
    v6 = v5;
    if ( v5 >= 25 )
    {
      if ( v5 > 100 )
      {
        v6 = 100;
      }
    }
    else
    {
      v6 = 25;
    }
    atmosphere = a1->atmosphere;
    v19 = v6 * v18 / 100;
    if ( atmosphere == 1 )
    {
      v8 = (double)v19 * 1.25;
    }
    else
    {
      if ( atmosphere != 2 )
      {
LABEL_71:
        if ( v19 < 0 )
        {
          v19 = 0;
        }
        a1->z7 = v21;
        a1->aa2 = 100 * v19 / 600;
        WinMgr.gameEventsNum = 0;
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 9, 1);
        return;
      }
      v8 = (double)v19 * 1.5;
    }
    v19 = (int)v8;
    goto LABEL_71;
  }
}

//----- (00020B3C) --------------------------------------------------------
T_Star *__fastcall sub_20B3C(P_Game pGame)
{
  T_Star *stars; // esi
  int i; // eax
  int v4; // kr04_4
  int ShipsAtLocation_sub_1D794; // ecx
  __int16 k; // ax
  int v7; // edx
  WORD j; // di
  int v10[107]; // [esp+0h] [ebp-1CCh] BYREF
  unsigned __int8 v11; // [esp+1ACh] [ebp-20h]
  unsigned __int8 v12; // [esp+1B0h] [ebp-1Ch]

  v12 = 1 << V_PlayerRaceIndex;
  stars = pGame->stars;
  v11 = sub_43374(&V_Game.races[V_PlayerRaceIndex], 0xFFFFFFFF);
  if ( !pGame->z1 )
  {
    for ( i = 0; (__int16)i < pGame->starsNum; ++i )
    {
      byte_D8460[(__int16)i] &= ~1u;
    }
  }
  v4 = 0;
  for ( j = 0; j < pGame->starsNum; ++v4 )
  {
    if ( (byte_D8460[j] & 1) == 0 )
    {
      byte_D8460[j] |= 1u;
      if ( (v12 & stars[v4].racePresenceBits) != 0 && (v11 & stars[v4].racePresenceBits) != 0 )
      {
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&stars[v4], (P_Ship *)v10);
        for ( k = 0; k < ShipsAtLocation_sub_1D794; ++k )
        {
          v7 = *(__int16 *)(v10[k] + 0x56);
          if ( (v7 == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[v7] == 2) && *(int *)(v10[k] + 0x88) > 0 )
          {
            ++pGame->z1;
            return stars;
          }
        }
      }
    }
    ++j;
  }
  return 0;
}
// 20B3C: using guessed type int var_1CC[107];

//----- (00020C94) --------------------------------------------------------
void __fastcall sub_20C94(P_Game pGame, int a2, int a3, int a4)
{
  unsigned __int8 v5; // cl
  int v6; // edx
  int v7; // eax
  int v8; // eax
  T_WndA2 *v9; // eax
  char *v10; // kr00_4
  int ShipsAtLocation_sub_1D794; // ebx
  WORD v12; // dx
  __int16 k; // cx
  __int16 *v14; // eax
  int v15; // eax
  char z7; // ch
  int i; // edx
  int j; // edx
  __int16 m; // dx
  int n; // eax
  int v21; // [esp-10h] [ebp-1E8h]
  int v22; // [esp-Ch] [ebp-1E4h]
  int racePresenceBits; // [esp-8h] [ebp-1E0h]
  int v24; // [esp-4h] [ebp-1DCh]
  void *v25[107]; // [esp+0h] [ebp-1D8h] BYREF
  FILE *fp; // [esp+1ACh] [ebp-2Ch]
  char *name; // [esp+1B0h] [ebp-28h]
  char *v28; // [esp+1B4h] [ebp-24h]
  char *v29; // [esp+1B8h] [ebp-20h]
  int v30; // [esp+1BCh] [ebp-1Ch]

  if ( V_FlashPopExists == 0xFFFFFFFF && pGame->day >= 0x1388 )
  {
    v5 = rand() % 0x15;
    v6 = rand() % 5 + 3;
    v7 = rand();
    sub_1E10C(pGame, v7 % 0x4C + 0x19, v6, v5);
    sub_1F038(pGame);
    sub_1F404(pGame);
    sub_1EEA4(pGame);
    v8 = rand();
    sub_1EE08((int)pGame, v8 % 6);
    pGame->day = 0;
    v9 = sub_56E18(&WinMgr, "RACECONTROLS", 1, 0);
    if ( !v9 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0x9B7);
    }
    v9->pProcs->proc4_draw(&v9->a1, 0);
  }
  pGame->z1 = 0;
  memset(byte_D8460, 0, sizeof(byte_D8460));
  sub_21170(pGame);
  sub_21314(pGame);
  Q_Research_DoProgress_sub_466FC(&V_Research);
  for ( i = 0; i < *(__int16 *)((char *)&pGame->day + (_DWORD)&loc_27281 + 2); ++i )
  {
    sub_352E0(&pGame->planets[i]);
  }
  sub_2106C(pGame);
  for ( j = 0; j < pGame->racesNum; ++j )
  {
    if ( j != V_PlayerRaceIndex )
    {
      sub_3B220(&pGame->races[j]);
    }
  }
  sub_3B220(&V_Game.races[V_PlayerRaceIndex]);
  if ( V_NougatLfExists_dword_A0CFC == 0xFFFFFFFF )
  {
    fp = fopen("numships.dbg", "at");
    if ( V_Game.starsNum > 0 )
    {
      v30 = 0;
      name = V_Game.stars[0].name;
      v10 = V_Game.stars[0].name;
      do
      {
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[v30], (P_Ship *)v25);
        v12 = 0;
        if ( V_Game.racesNum > 0 )
        {
          v29 = &v10[0x60 * v30];
          do
          {
            if ( ((1 << v12) & V_Game.stars[v30].racePresenceBits) != 0 )
            {
              for ( k = 0; k < ShipsAtLocation_sub_1D794 && v12 != *((_WORD *)v25[k] + 0x2B); ++k )
              {
                ;
              }
              if ( k >= ShipsAtLocation_sub_1D794 )
              {
                racePresenceBits = V_Game.stars[v30].racePresenceBits;
                ++word_D845C;
                fprintf(fp, "T%04d: %s flags (%d) show R%d ship, but none found.\n", pGame->day + 1, v29, racePresenceBits, v12);
              }
            }
            ++v12;
          }
          while ( v12 < V_Game.racesNum );
        }
        v28 = &v10[0x60 * v30];
        for ( m = 0; m < ShipsAtLocation_sub_1D794; ++m )
        {
          v14 = (__int16 *)v25[m];
          if ( *((_BYTE *)v14 + 0x58) != 1 && ((1 << v14[0x2B]) & V_Game.stars[0].racePresenceBits) == 0 )
          {
            v24 = V_Game.stars[0].racePresenceBits;
            v22 = v14[0x2B];
            v21 = pGame->day + 1;
            ++word_D845C;
            fprintf(fp, "T%04d: R%d ship exists at %s, flags (%d) indicate otherwise.\n", v21, v22, v28, v24);
          }
        }
        ++v30;
      }
      while ( (__int16)v30 < V_Game.starsNum );
    }
    fclose(fp);
  }
  for ( n = 0; (__int16)n < V_Game.lanesNum; ++n )
  {
    *(_WORD *)pGame->lanes[n].Unknown_21 = 0;
  }
  v15 = V_PlayerRaceIndex;
  if ( ((1 << V_PlayerRaceIndex) & V_Game.races[v15]._homeStar->racesBits) != 0 )
  {
    pGame->starsControlled = 1;
    sub_1FFE0(pGame, (int)V_Game.races[v15]._homeStar);
  }
  else
  {
    pGame->starsControlled = 0;
  }
  z7 = pGame->z7;
  ++pGame->day;
  if ( !z7 && V_FlashPopExists == FALSE )
  {
    sub_207A0(pGame);
  }
}
// D845C: using guessed type __int16 word_D845C;
// 20C94: using guessed type P_Ship var_1D8[107];

//----- (0002106C) --------------------------------------------------------
P_Game __fastcall sub_2106C(P_Game result)
{
  P_Game v1; // edi
  WORD i; // si
  int v3; // edx
  WORD v4; // si
  __int16 v5; // bx
  WORD j; // ax
  int Ships_sub_40224; // [esp+0h] [ebp-20h] BYREF
  __int16 v8; // [esp+4h] [ebp-1Ch]

  v1 = result;
  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    v3 = 6 * i;
    Ships_sub_40224 = Q_Race_GetShips_sub_40224(&V_Game.races[i], 0, &Ships_sub_40224);
    *(_WORD *)&v1->Unknown_D8A[v3 + 2] = Ships_sub_40224;
    result = (P_Game)Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[i]);
    *(_WORD *)&v1->Unknown_D8A[v3 + 4] = (_WORD)result;
  }
  if ( V_Game.racesNum > 0 )
  {
    v4 = 0;
    do
    {
      v8 = *(_WORD *)&v1->Unknown_D8A[6 * v4 + 4] + *(_WORD *)&v1->Unknown_D8A[6 * v4 + 2];
      v5 = 0;
      for ( j = 0; j < V_Game.racesNum; ++j )
      {
        if ( v4 != j && *(__int16 *)&v1->Unknown_D8A[6 * j + 2] + *(__int16 *)&v1->Unknown_D8A[6 * j + 4] > v8 )
        {
          ++v5;
        }
      }
      result = (P_Game)(6 * v4);
      *(_WORD *)&result->Unknown_D8A[(_DWORD)v1] = v5;
      ++v4;
    }
    while ( v4 < V_Game.racesNum );
  }
  return result;
}

//----- (00021170) --------------------------------------------------------
void __fastcall sub_21170(P_Game a1)
{
  T_Star *stars; // esi
  unsigned __int8 v3; // al
  int v4; // ecx
  unsigned __int8 v5; // [esp+0h] [ebp-18h]

  v5 = 1 << V_PlayerRaceIndex;
  if ( a1->starsNum > 0 )
  {
    stars = a1->stars;
    v4 = 0;
    do
    {
      v3 = stars[v4].racesBits | stars[v4].racePresenceBits;
      stars[v4].z2 = 0;
      if ( (v3 & v5) == 0 )
      {
        if ( v3 )
        {
          sub_211EC(a1, &stars[v4], 0);
        }
        stars[v4].z2 = 0xFFFFFFFF;
      }
      ++v4;
    }
    while ( (__int16)v4 < a1->starsNum );
  }
}

//----- (000211EC) --------------------------------------------------------
void __fastcall sub_211EC(P_Game pGame, P_Star pStar, int a3)
{
  WORD racesNum; // cx
  int v7; // ebx
  T_Race *races; // ebp
  int v9; // edi
  __int16 v10; // cx
  WORD v11; // ax
  __int16 v12[8]; // [esp+2h] [ebp-2Ch]
  T_Target v13; // [esp+12h] [ebp-1Ch] BYREF
  int v14; // [esp+1Ah] [ebp-14h]

  if ( V_FlashPopExists == 0xFFFFFFFF )
  {
    a3 = V_FlashPopExists;
  }
  racesNum = pGame->racesNum;
  LOWORD(v14) = 0;
  v11 = 0;
  if ( racesNum > 0 )
  {
    do
    {
      if ( a3 || (a3 = 0, v11 != V_PlayerRaceIndex) )
      {
        if ( ((unsigned __int8)(pStar->racePresenceBits | pStar->racesBits) & (unsigned __int8)(1 << v11)) != 0 )
        {
          v7 = (__int16)v14;
          LOWORD(v14) = v14 + 1;
          v12[v7] = v11;
        }
      }
      ++v11;
    }
    while ( v11 < pGame->racesNum );
  }
  if ( (_WORD)v14 )
  {
    races = pGame->races;
    while ( 1 )
    {
      v9 = 0;
      v10 = 0;
      if ( (__int16)v14 > 0 )
      {
        break;
      }
LABEL_15:
      if ( !v9 )
      {
        return;
      }
    }
    while ( 1 )
    {
      v13.type = 0;
      v9 |= sub_406C4(&races[v12[v10]], pStar, &v13);
      if ( !v13.type )
      {
        goto LABEL_14;
      }
      if ( v13.type < 2u )
      {
        break;
      }
      if ( v13.type <= 2u )
      {
        sub_3676C(v13.pObject.pPlanet, 1);
      }
      else
      {
        if ( v13.type != 3 )
        {
          break;
        }
        sub_49B3C(v13.pObject.pShip, 1);
      }
LABEL_14:
      if ( ++v10 >= (__int16)v14 )
      {
        goto LABEL_15;
      }
    }
    Q_AssertLogBreakExit_sub_261A8(0, "..\\cosmos.cpp", 0xAE2);
    goto LABEL_14;
  }
}
// 211EC: using guessed type __int16 var_2C[8];

//----- (00021314) --------------------------------------------------------
void __fastcall sub_21314(P_Game a1)
{
  P_Star pStar; // ecx
  int v3; // edi

  if ( a1->starsNum > 0 )
  {
    pStar = a1->stars;
    v3 = 0;
    do
    {
      if ( pStar[v3].z2 != 0xFFFFFFFF )
      {
        if ( pStar[v3].racesBits | pStar[v3].racePresenceBits )
        {
          sub_211EC(a1, &pStar[v3], 0xFFFFFFFF);
        }
        pStar[v3].z2 = 0xFFFFFFFF;
      }
      ++v3;
    }
    while ( (__int16)v3 < a1->starsNum );
  }
}

//----- (00021374) --------------------------------------------------------
void __fastcall Q_Game_SaveGam_sub_21374(P_Game pGame, P_CFile pfi)
{
  WORD j; // cx
  T_Star *pStar; // esi
  WORD v4; // cx
  T_Planet *planets; // esi
  __int16 kk; // si
  P_Ship vpShips; // edi
  char *v8; // eax
  WORD l; // cx
  T_Race *races; // esi
  WORD m; // cx
  T_Lane *pLanes; // esi
  __int16 i; // ax
  __int16 v14; // di
  __int16 v15; // bx
  T_Sector *sectors; // esi
  __int16 k; // cx
  WORD v18; // cx
  T_Type09 v19; // [esp+0h] [ebp-238h] BYREF
  T_Lane lane; // [esp+1A0h] [ebp-98h] BYREF
  T_SavBlock1Sizes v21; // [esp+1C8h] [ebp-70h] BYREF
  P_Game vpGame; // [esp+1E8h] [ebp-50h]
  int day; // [esp+1ECh] [ebp-4Ch] BYREF
  int index; // [esp+1F0h] [ebp-48h] BYREF
  int v25; // [esp+1F4h] [ebp-44h] BYREF
  int z7; // [esp+1F8h] [ebp-40h] BYREF
  int aa2; // [esp+1FCh] [ebp-3Ch] BYREF
  int v28; // [esp+200h] [ebp-38h] BYREF
  int v29; // [esp+204h] [ebp-34h] BYREF
  int v30; // [esp+208h] [ebp-30h] BYREF
  int starsNum; // [esp+20Ch] [ebp-2Ch] BYREF
  int squaresNum; // [esp+210h] [ebp-28h] BYREF
  int planetsNum; // [esp+214h] [ebp-24h] BYREF
  int shipsNum; // [esp+218h] [ebp-20h] BYREF
  int v35; // [esp+21Ch] [ebp-1Ch] BYREF
  int racesNum; // [esp+220h] [ebp-18h] BYREF
  int lanesNum; // [esp+224h] [ebp-14h] BYREF
  int f; // [esp+228h] [ebp-10h] BYREF
  int sectorsNum; // [esp+22Ch] [ebp-Ch] BYREF
  T_Type10 *p_t10; // [esp+230h] [ebp-8h]
  __int16 v41; // [esp+234h] [ebp-4h]

  vpGame = pGame;
  // Block 1 - Sizes
  v21.sizeResTree = 0x1D72;
  v21.sizeStar = 0x60;
  v21.sizePlanet = 0x7B;
  v21.sizeRace = 0x1EE;
  v21.magic5 = 0x19E;
  v21._sizeSector = 0xD;
  v21.sizeGame = 0x354EF;
  v21.magic4 = 0x27;
  // Block 2
  Q_CFile_DosWrite_sub_1C098(pfi, &v21, 0x20u);
  day = vpGame->day;
  Q_CFile_DosWrite_sub_1C098(pfi, &day, 4u);
  index = vpGame->pCurStar->index;
  Q_CFile_DosWrite_sub_1C098(pfi, &index, 4u);
  v25 = vpGame->pCurPlanet - vpGame->planets;
  Q_CFile_DosWrite_sub_1C098(pfi, &v25, 4u);
  z7 = vpGame->z7;
  Q_CFile_DosWrite_sub_1C098(pfi, &z7, 4u);
  aa2 = vpGame->aa2;
  Q_CFile_DosWrite_sub_1C098(pfi, &aa2, 4u);
  v28 = V_Day1;
  Q_CFile_DosWrite_sub_1C098(pfi, &v28, 4u);
  v29 = V_Day2;
  Q_CFile_DosWrite_sub_1C098(pfi, &v29, 4u);
  v30 = V_Day3;
  Q_CFile_DosWrite_sub_1C098(pfi, &v30, 4u);
  // Block 3 - ResTree
  Q_ReadWriteResTree_sub_46BB0(&V_Research, pfi, FALSE);
  // Block 4 - Stars
  starsNum = vpGame->starsNum;
  Q_CFile_DosWrite_sub_1C098(pfi, &starsNum, 4u);
  j = 0;
  if ( vpGame->starsNum > 0 )
  {
    pStar = vpGame->stars;
    do
    {
      Q_ReadWriteStar_sub_1D920(&pStar[j++], pfi, FALSE);
    }
    while ( j < vpGame->starsNum );
  }
  // Block 5 - Planet squares
  squaresNum = vpGame->squaresNum;
  Q_CFile_DosWrite_sub_1C098(pfi, &squaresNum, 4u);
  Q_CFile_DosWrite_sub_1C098(pfi, vpGame->squares, 4 * vpGame->squaresNum);
  // Block 6 - Planets
  planetsNum = vpGame->planetsNum;
  Q_CFile_DosWrite_sub_1C098(pfi, &planetsNum, 4u);
  v4 = 0;
  if ( vpGame->planetsNum > 0 )
  {
    planets = vpGame->planets;
    do
    {
      Q_Planet_ReadWrite_sub_370B8(&planets[v4++], pfi, FALSE);
    }
    while ( v4 < vpGame->planetsNum );
  }
  // Block 7 - Ships
  kk = 0;
  shipsNum = vpGame->shipsNum;
  vpShips = vpGame->ships;
  Q_CFile_DosWrite_sub_1C098(pfi, &shipsNum, 4u);
  for ( k = 0; k < 0x6B; ++k )
  {
    v8 = (char *)vpGame + 0x162 * k;
    if ( *(__int16 *)(v8 + 0x272DB) != 0xFFFFFFFF )
    {
      if ( !v8[0x272DD] )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB57);
      }
      v35 = k;
      Q_CFile_DosWrite_sub_1C098(pfi, &v35, 4u);
      ++kk;
      Q_ReadWriteShip_sub_4AE8C(&vpShips[k], pfi, FALSE);
    }
  }
  if ( kk != vpGame->shipsNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xB65);
  }
  // Block 8 - Races
  racesNum = vpGame->racesNum;
  Q_CFile_DosWrite_sub_1C098(pfi, &racesNum, 4u);
  l = 0;
  if ( vpGame->racesNum > 0 )
  {
    races = vpGame->races;
    do
    {
      Q_ReadWriteRace_sub_43BDC(&races[l++], pfi, FALSE);
    }
    while ( l < vpGame->racesNum );
  }
  // Block 9 - Lanes
  lanesNum = vpGame->lanesNum;
  Q_CFile_DosWrite_sub_1C098(pfi, &lanesNum, 4u);
  memset(&lane.vector1, 0, 0x18);
  m = 0;
  if ( vpGame->lanesNum > 0 )
  {
    pLanes = vpGame->lanes;
    do
    {
      lane = pLanes[m];
      lane.pStar1 = (P_Star)lane.pStar1->index;
      lane.pStar2 = (P_Star)lane.pStar2->index;
      Q_CFile_DosWrite_sub_1C098(pfi, &lane, 0x27u);
      ++m;
    }
    while ( m < vpGame->lanesNum );
  }
  // Block 10
  Q_CFile_DosWrite_sub_1C098(pfi, vpGame->starConnections, 10000u);
  // Block 11
  f = vpGame->t10.f;
  Q_CFile_DosWrite_sub_1C098(pfi, &f, 4u);
  memset(&v19.c, 0, sizeof(v19.c));
  if ( vpGame->t10.f > 0 )
  {
    v41 = 0;
    p_t10 = &vpGame->t10;
    do
    {
      qmemcpy(&v19, &p_t10->a.a[v41], sizeof(v19));
      *(_DWORD *)&i = 0;
      if ( v19.b > 0 )
      {
        do
        {
          v19.a[i] = *(__int16 *)(v19.a[i] + 4);
          ++*(_DWORD *)&i;
        }
        while ( i < v19.b );
      }
      v14 = v41;
      Q_CFile_DosWrite_sub_1C098(pfi, &v19, 0x19Eu);
      v15 = vpGame->t10.f;
      v41 = v14 + 1;
    }
    while ( (__int16)(v14 + 1) < v15 );
  }
  // Block 12 - Sectors
  sectorsNum = vpGame->sectorsNum;
  Q_CFile_DosWrite_sub_1C098(pfi, &sectorsNum, 4u);
  if ( vpGame->sectorsNum > 0 )
  {
    sectors = vpGame->sectors;
    v18 = 0;
    do
    {
      Q_CFile_DosWrite_sub_1C098(pfi, &sectors[v18++], 0xDu);
    }
    while ( v18 < vpGame->sectorsNum );
  }
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00021AA0) --------------------------------------------------------
void __fastcall Q_Game_LoadGam_sub_21AA0(P_Game pGame, P_CFile pfi)
{
  __int16 v4; // ax
  T_Star *v5; // eax
  T_Square *squares; // ebp
  __int16 v7; // ax
  WORD v8; // cx
  unsigned int v9; // eax
  __int16 i; // ax
  int v11; // edx
  __int16 v12; // ax
  T_Race *v13; // eax
  __int16 v14; // ax
  int laneIndex; // ebp
  T_Lane *v16; // ecx
  T_Star *v17; // ebx
  int pStar2; // eax
  T_Star *v19; // edx
  T_Star *v20; // eax
  int v21; // ebp
  WORD f; // cx
  int k; // eax
  WORD v24; // dx
  __int16 v25; // ax
  T_Sector *v26; // edx
  WORD v27; // cx
  WORD j; // cx
  WORD v29; // cx
  WORD v30; // cx
  _DWORD v31[95]; // [esp+0h] [ebp-1E0h] BYREF
  _WORD v32[5]; // [esp+190h] [ebp-50h]
  int v33; // [esp+19Ah] [ebp-46h]
  T_SavBlock1Sizes v34; // [esp+1A0h] [ebp-40h] BYREF
  int buf; // [esp+1C0h] [ebp-20h] BYREF
  unsigned int v36; // [esp+1C4h] [ebp-1Ch]
  T_Star *stars; // [esp+1C8h] [ebp-18h]
  T_Planet *planets; // [esp+1CCh] [ebp-14h]
  T_Lane *lanes; // [esp+1D0h] [ebp-10h]
  WORD lanesNum; // [esp+1D4h] [ebp-Ch]
  __int16 v41; // [esp+1D8h] [ebp-8h]
  int v42; // [esp+1DCh] [ebp-4h]

  Q_ReadFile_sub_1BF94(pfi, &v34, 0x20u);
  if ( v34.sizeResTree != 0x1D72 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAA);
  }
  if ( v34.sizeStar != 0x60 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAB);
  }
  if ( v34.sizePlanet != 0x7B )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAC);
  }
  if ( v34.sizeRace != 0x1EE )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAD);
  }
  if ( v34.magic4 != 0x27 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAE);
  }
  if ( v34.magic5 != 0x19E )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBAF);
  }
  if ( v34._sizeSector != 0xD )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBB0);
  }
  if ( v34.sizeGame != 0x354EF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\cosmos.cpp", 0xBB1);
  }
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->day = buf;
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->pCurStar = &pGame->stars[buf];
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->pCurPlanet = &pGame->planets[buf];
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->z7 = buf;
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->aa2 = buf;
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  V_Day1 = buf;
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  V_Day2 = buf;
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  V_Day3 = buf;
  Q_ReadWriteResTree_sub_46BB0(&V_Research, pfi, TRUE);
  // Block 4 - Stars
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  v4 = buf;
  pGame->starsNum = buf;
  v27 = 0;
  if ( v4 > 0 )
  {
    do
    {
      v5 = &pGame->stars[v27++];
      Q_ReadWriteStar_sub_1D920(v5, pfi, TRUE);
    }
    while ( v27 < pGame->starsNum );
  }
  // Block 5 - Planet squares
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->squaresNum = buf;
  squares = pGame->squares;
  Q_ReadFile_sub_1BF94(pfi, pGame->squares, 4 * pGame->squaresNum);
  // Block 6 - Planets
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  v7 = buf;
  v8 = 0;
  pGame->planetsNum = buf;
  if ( v7 > 0 )
  {
    planets = pGame->planets;
    do
    {
      v36 = 0x7B * v8;
      Q_Planet_ReadWrite_sub_370B8(&planets[v36 / 0x7B], pfi, TRUE);
      v9 = v36;
      pGame->planets[v36 / 0x7B].pSquares = squares;
      ++v8;
      squares += *(unsigned __int16 *)((char *)&pGame->planets[0].totalSquaresNum + v9);
    }
    while ( v8 < pGame->planetsNum );
  }
  // Block 7 - Ships
  for ( i = 0; i < 107; ++i )
  {
    v11 = i;
    pGame->ships[v11].raceIndex = 0xFFFF;
    pGame->ships[v11].locationType = 0;
  }
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->shipsNum = buf;
  for ( j = 0; j < 107; ++j )
  {
    if ( j < pGame->shipsNum )
    {
      Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
      Q_ReadWriteShip_sub_4AE8C(&pGame->ships[buf], pfi, TRUE);
    }
  }
  // Block 8 - Races
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  v12 = buf;
  pGame->racesNum = buf;
  v29 = 0;
  if ( v12 > 0 )
  {
    do
    {
      v13 = &pGame->races[v29++];
      Q_ReadWriteRace_sub_43BDC(v13, pfi, TRUE);
    }
    while ( v29 < pGame->racesNum );
  }
  // Block 9 - Lanes
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  v14 = buf;
  pGame->lanesNum = buf;
  if ( v14 > 0 )
  {
    lanes = pGame->lanes;
    stars = pGame->stars;
    v41 = 0;
    do
    {
      laneIndex = v41;
      v16 = &lanes[laneIndex];
      Q_ReadFile_sub_1BF94(pfi, &lanes[laneIndex], 0x27u);
      v17 = &stars[(int)pGame->lanes[laneIndex].pStar1];
      pStar2 = (int)pGame->lanes[laneIndex].pStar2;
      v19 = stars;
      pGame->lanes[laneIndex].pStar1 = v17;
      v20 = &v19[pStar2];
      pGame->lanes[laneIndex].pStar2 = v20;
      lanesNum = v17->lanesNum;
      v21 = lanesNum;
      v17->lanesNum = lanesNum + 1;
      v17->_lanes[v21] = v16;
      LOWORD(v19) = v20->lanesNum;
      v20->lanesNum = (_WORD)v19 + 1;
      v20->_lanes[(__int16)v19] = v16;
      LOWORD(v19) = pGame->lanesNum;
      ++v41;
    }
    while ( v41 < (__int16)v19 );
  }
  // Block 10
  Q_ReadFile_sub_1BF94(pfi, pGame->starConnections, 10000u);
  // Block 11
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  pGame->t10.f = buf;
  *(_DWORD *)&v32[3] = 0;
  v33 = 0;
  *(_DWORD *)&v32[1] = 0;
  f = pGame->t10.f;
  v42 = 0;
  if ( f > 0 )
  {
    do
    {
      Q_ReadFile_sub_1BF94(pfi, v31, 0x19Eu);
      for ( k = 0; (__int16)k < v32[0]; ++k )
      {
        v31[(__int16)k] = &pGame->stars[v31[(__int16)k]];
      }
      v24 = pGame->t10.f;
      ++v42;
    }
    while ( (__int16)v42 < v24 );
  }
  // Block 12
  Q_ReadFile_sub_1BF94(pfi, &buf, 4u);
  v25 = buf;
  pGame->sectorsNum = buf;
  v30 = 0;
  if ( v25 > 0 )
  {
    do
    {
      v26 = &pGame->sectors[v30++];
      Q_ReadFile_sub_1BF94(pfi, v26, 0xDu);
    }
    while ( v30 < pGame->sectorsNum );
  }
  sub_1EEA4(pGame);
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (000220CC) --------------------------------------------------------
WORD __fastcall sub_220CC(P_Game pGame)
{
  __int16 v2; // di
  WORD racesNum; // dx
  double v4; // st6
  WORD v5; // bx
  WORD i; // dx
  P_Star homeStar; // ebx
  P_Star v8; // eax
  WORD result; // ax
  WORD f; // tt
  double v11[7]; // [esp+8h] [ebp-84h] BYREF
  T_Vector3D v12; // [esp+40h] [ebp-4Ch] BYREF
  T_Vector3D v13; // [esp+4Ch] [ebp-40h] BYREF
  T_Vector3D v14; // [esp+58h] [ebp-34h] BYREF
  T_Vector3D *v15; // [esp+6Ch] [ebp-20h]
  int v16; // [esp+70h] [ebp-1Ch]

  memset(&v13, 0, sizeof(v13));
  memset(v11, 0, sizeof(v11));
  racesNum = pGame->racesNum;
  pGame->f = 0;
  if ( racesNum > 0 )
  {
    v2 = 0;
    do
    {
      for ( i = 0; i < pGame->racesNum; ++i )
      {
        if ( v2 != i )
        {
          homeStar = pGame->races[i]._homeStar;
          v8 = pGame->races[v2]._homeStar;
          v15 = &v14;
          memset(&v12, 0, sizeof(v12));
          v12.x = v8->pos.x - homeStar->pos.x;
          v12.y = v8->pos.y - homeStar->pos.y;
          v12.z = v8->pos.z - homeStar->pos.z;
          v14 = v12;
          v13 = v12;
          v11[v2] = sqrt(v12.y * v12.y + v12.x * v12.x + v12.z * v12.z) + v11[v2];
        }
      }
      v16 = pGame->racesNum - 1;
      v11[v2] = v11[v2] / (double)v16;
      v4 = (double)pGame->f + v11[v2++];
      v16 = (int)v4;
      v5 = pGame->racesNum;
      pGame->f = (int)v4;
    }
    while ( v2 < v5 );
  }
  f = pGame->f;
  result = f / pGame->racesNum;
  pGame->f = result;
  return result;
}
// 220CC: using guessed type double var_84[7];

//----- (00022260) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22260(void *result)
{
  _wcpp_2_dtor_array_(result, 7, &C_Race);
}

//----- (00022280) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22280(void *a1)
{
  _wcpp_2_dtor_array_(a1, 0x64, &C_Star);
}

//----- (000222A0) --------------------------------------------------------
void __fastcall __spoils<edx> sub_222A0(void *result)
{
  _wcpp_2_dtor_array_(result, 0x6B, &C_Ship);
}

//----- (000222C0) --------------------------------------------------------
void __fastcall __spoils<edx> sub_222C0(void *a1)
{
  _wcpp_2_dtor_array_(a1, 24, &C_Type09);
}

//----- (000222E0) --------------------------------------------------------
void __fastcall __spoils<edx> sub_222E0(void *a1)
{
  _wcpp_2_dtor_array_(a1, 9, &C_Sector);
}

//----- (00022300) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22300(void *result)
{
  _wcpp_2_dtor_array_(result, 0x1F4, &C_Planet);
}

//----- (00022320) --------------------------------------------------------
void __fastcall __spoils<edx> sub_22320(void *result)
{
  _wcpp_2_dtor_array_(result, 148, &C_Lane);
}

//----- (00022360) --------------------------------------------------------
P_Lane __fastcall sub_22360(P_Lane result)
{
  result->vector1.x = 0.0;
  result->vector1.y = 0.0;
  result->vector1.z = 0.0;
  result->vector2.y = 0.0;
  result->vector2.z = 0.0;
  result->vector2.x = 0.0;
  return result;
}

//----- (000223B0) --------------------------------------------------------
void __fastcall __spoils<> Q_SectorCtor_sub_223B0(P_Sector pSector)
{
  pSector->v.y = 0.0;
  pSector->v.z = 0.0;
  pSector->v.x = 0.0;
}

//----- (000223E0) --------------------------------------------------------
void __fastcall __spoils<> sub_223E0(P_Type09 a1)
{
  a1->c.e = 0;
  a1->c.f = 0;
  a1->c.c = 0;
}

//----- (00022400) --------------------------------------------------------
void __fastcall __spoils<> Q_PlanetCtor_sub_22400(P_Planet pPlanet)
{
  pPlanet->position.x = 0.0;
  pPlanet->position.y = 0.0;
  pPlanet->position.z = 0.0;
  pPlanet->totalSquaresNum = 0;
  pPlanet->pSquares = 0;
  pPlanet->z7 = 0;
}

//----- (00022430) --------------------------------------------------------
int __fastcall sub_22430(const void *a1, const void *a2)
{
  int v2; // edx
  float v4; // [esp+0h] [ebp-8h]
  float v5; // [esp+4h] [ebp-4h]

  v5 = *(float *)(*(_DWORD *)a1 + 0xD);
  v4 = *(float *)(*(_DWORD *)a2 + 0xD);
  v2 = 0;
  if ( v5 > (double)v4 )
  {
    return 0xFFFFFFFF;
  }
  if ( v5 < (double)v4 )
  {
    return 1;
  }
  return v2;
}

//----- (00022468) --------------------------------------------------------
void __fastcall Q_Proc_sub_22468()
{
  T_WndA2 *v0; // eax

  v0 = sub_56E18(&WinMgr, "NEXTTURNCONT", 1, 0);
  if ( !v0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x69);
  }
  v0[1].a1.magic12345678 = 0;
}

//----- (000224A4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd2COSWCtor_sub_224A4(P_Wnd2COSW result)
{
  UBYTE v1; // cl

  Q_A2Ctor_sub_2C830(&result->a);
  sub_1B4F0(&result->matrices);
  sub_254A4((int)result->Unknown_172);
  result->a.pProcs = &Wnd2COSW_Procs;
  result->Unknown_AB = 0;
  result->Unknown_AF = 0;
  result->Unknown_B3 = 0;
  result->Unknown_B7 = 0;
  result->Unknown_BB = 0;
  result->Unknown_C0 = 0;
  result->Unknown_C4 = 0xFFFFFFFF;
  result->Unknown_C8 = 0xFFFFFFFF;
  result->Unknown_CC = 0xFFFFFFFF;
  result->Unknown_D0 = 0xFFFFFFFF;
  result->Unknown_D4 = 0;
  result->Unknown_592 = 0;
  result->Unknown_D8 = 0xFF;
  result->cursorShape = 2;
  result->Unknown_58E = 0;
  result->Unknown_58A = 0;
  v1 = V_PlayerRaceIndex;
  result->Unknown_582 = 0;
  result->Unknown_D9 = 1 << v1;
}

//----- (00022588) --------------------------------------------------------
char *__fastcall Q_Wnd2COSWDtor_sub_22588(char *a1, char a2)
{
  char *v4; // eax
  void *v5; // edx

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd2COSW);
    operator delete[](v4);
  }
  else
  {
    v5 = *(void **)(a1 + 0xAB);
    *(_DWORD *)(a1 + 0xA7) = &Wnd2COSW_Procs;
    if ( v5 )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(v5);
    }
    operator delete[](*(void **)(a1 + 0xAB));
    if ( *(_DWORD *)(a1 + 0xAF) )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)(a1 + 0xAF));
    }
    operator delete[](*(void **)(a1 + 0xAF));
    if ( *(_DWORD *)(a1 + 0xB3) )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)(a1 + 0xB3));
    }
    operator delete[](*(void **)(a1 + 0xB3));
    sub_254B0((int)(a1 + 0x172));
    Q_Ret_sub_1B66C();
    Q_A2Dtor_sub_2C848((P_WndA2)a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
  return a1;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00022644) --------------------------------------------------------
unsigned int __fastcall Q_COSWND_CPP_sub_22644(P_Wnd2COSW a1, const char *starShapes, const char *shipShapes)
{
  void *v4; // eax
  void *v5; // eax
  __int16 v6; // ax
  __int16 y0; // cx
  __int16 v8; // bx
  __int16 y1; // ax
  void *v10; // eax
  T_CFile fi; // [esp+0h] [ebp-128h] BYREF

  if ( !starShapes )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x9E);
  }
  if ( !shipShapes )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x9F);
  }
  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( a1->Unknown_AB )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->Unknown_AB);
  }
  operator delete[](a1->Unknown_AB);
  if ( Q_CFile_OpenFile_sub_1BBFC(&fi, starShapes, O_BINARY, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0xAA);
  }
  v4 = Q_CFile_Load_sub_1BF1C(&fi, 0);
  a1->Unknown_AB = v4;
  if ( !v4 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0xAC);
  }
  if ( a1->Unknown_AF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->Unknown_AF);
  }
  operator delete[](a1->Unknown_AF);
  if ( Q_CFile_OpenFile_sub_1BBFC(&fi, shipShapes, O_BINARY, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0xB5);
  }
  v5 = Q_CFile_Load_sub_1BF1C(&fi, 0);
  a1->Unknown_AF = v5;
  if ( !v5 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0xB7);
  }
  v6 = LOWORD(a1->a.a1.pane.x1) - LOWORD(a1->a.a1.pane.x0);
  y0 = a1->a.a1.pane.y0;
  a1->Unknown_576 = v6;
  v8 = v6;
  y1 = a1->a.a1.pane.y1;
  a1->Unknown_576 = v8 >> 1;
  a1->Unknown_578 = (__int16)(y1 - y0) >> 1;
  sub_2280C(a1);
  if ( a1->Unknown_B3 )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->Unknown_B3);
  }
  operator delete[](a1->Unknown_B3);
  v10 = operator new[](0x1D1Fu);
  Q_RegisterData_sub_2625C(v10, 1, "CW DISPLAYITEMS");
  a1->Unknown_B3 = v10;
  if ( !v10 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0xCC);
  }
  a1->Unknown_B7 = 0;
  a1->Unknown_B9 = 0x163;
  Q_CFile_Dtor_sub_1BBC8(&fi);
  return 0xFFFFFFFF;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0002280C) --------------------------------------------------------
LONG *__fastcall sub_2280C(P_Wnd2COSW a1)
{
  LONG *result; // eax

  a1->Unknown_57A = 35.0;
  sub_1B808(&a1->matrices, a1->Unknown_57A, 1.0, 100000.0, a1->Unknown_576);
  a1->matrices.vector_34.x = 0.0;
  a1->matrices.vector_34.y = 0.0;
  a1->matrices.vector_34.z = -1500.0;
  a1->matrices.matrix_74._[0][0] = 1.0;
  a1->matrices.matrix_74._[0][1] = 0.0;
  result = (LONG *)a1->matrices.matrix_74._[1];
  a1->matrices.matrix_74._[0][2] = 0.0;
  a1->matrices.matrix_74._[1][0] = 0.0;
  a1->matrices.matrix_74._[1][1] = 1.0;
  a1->matrices.matrix_74._[1][2] = 0.0;
  a1->matrices.matrix_74._[2][0] = 0.0;
  a1->matrices.matrix_74._[2][1] = 0.0;
  a1->matrices.matrix_74._[2][2] = 1.0;
  return result;
}

//----- (000228A4) --------------------------------------------------------
#error "228A4: function frame is wrong (funcsize=0)"

//----- (00023BF0) --------------------------------------------------------
void __fastcall sub_23BF0(int a1, int a2)
{
  T_WndA2 *v3; // eax
  int v4; // eax
  __int16 i; // si
  char v6; // dl
  int v7; // ebx
  int v8; // edx
  int v9; // ebx
  int v10; // edx
  const char *v11; // ecx
  int *v12; // eax
  int v13; // ebx
  int v14; // edx
  int v15; // ebx
  int v16; // edx
  char s[128]; // [esp+0h] [ebp-F8h] BYREF
  T_Name10 v18[4]; // [esp+80h] [ebp-78h] BYREF
  T_Name12 v19[3]; // [esp+A8h] [ebp-50h] BYREF
  char v20[20]; // [esp+CCh] [ebp-2Ch] BYREF
  int v21; // [esp+E0h] [ebp-18h]

  v21 = a2;
  sub_254F8((int *)(a1 + 0x172), a1);
  if ( WinMgr.state == 3 )
  {
    v3 = sub_56E18(&WinMgr, "NEWGAMEWND", 3, 0);
    if ( !v3 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x414);
    }
    v3->pProcs->proc4_draw(&v3->a1, 1);
  }
  if ( *(_DWORD *)(a1 + 0xD4) == 0xFFFFFFFF )
  {
    sub_23FD4(a1);
  }
  if ( WinMgr.state != 3 )
  {
    Q_WINMGR_CPP_sub_53E38((PANE *)(a1 + 4), 3, 3, V_PlayerRaceIndex);
  }
  if ( *(_DWORD *)(a1 + 0xBB) )
  {
    s[0] = 0;
    v12 = *(int **)(a1 + 0xBB);
    v6 = 1;
    if ( !*((_BYTE *)v12 + 4) )
    {
      v4 = *v12;
      if ( ((unsigned __int8)V_RaceIndexMask & *(_BYTE *)(v4 + 0x17)) != 0 )
      {
        strcpy(s, (const char *)(v4 + 0x1C));
        for ( i = 0; i < 7 && (*(_BYTE *)(**(_DWORD **)(a1 + 0xBB) + 0x14) & (unsigned __int8)(*(_BYTE *)(a1 + 0xD9) & v6)) == 0; ++i )
        {
          v6 *= 2;
        }
      }
      v7 = *(_DWORD *)(a1 + 0x14) - 0x1B;
      v8 = *(_DWORD *)(a1 + 0x10) - 0x82;
      WinMgr.LargeFont.pane = V_Type6_stru_D8654.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v8, v7, s, 0, 0xFFFF, 0xFFFF, 0);
      v9 = *(_DWORD *)(a1 + 0x14) - 0xC;
      v10 = *(_DWORD *)(a1 + 0x10) - 0x82;
      v11 = V_StarTypeTexts_D84C4[***(_DWORD ***)(a1 + 0xBB)];
      WinMgr.SmallFont.pane = V_Type6_stru_D8654.pane;
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, v10, v9, v11, 0, 0xFFFF, 0xFFFF, 0);
    }
  }
  if ( v21 != 0xA )
  {
    stru_D85E4 = *(PANE *)(a1 + 4);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &stru_D85E4);
  if ( V_NougatLfExists_dword_A0CFC == 0xFFFFFFFF && V_NougatLfExists_dword_A0CFC == *(_DWORD *)(a1 + 0x58E) )
  {
    sprintf(s, "STARS CONTROLLED %d", V_Game.starsControlled);
    WinMgr.SmallFont.pane = V_Type6_stru_D8654.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xA, 0x18C, s, 0, 0xFFFF, 0xFF, 0);
    sprintf(s, "PERCENT CONTROLLED %d", 0x64 * V_Game.starsControlled / V_Game.starsNum);
    qmemcpy(v19, V_Atmospheres, sizeof(v19));
    sprintf(s, "%d Biorythym (%s)\n", word_104BE8, v19[V_Game.atmosphere]);
    v13 = *(_DWORD *)(a1 + 0xC) + 0x1E;
    v14 = *(_DWORD *)(a1 + 8) + 5;
    WinMgr.LargeFont.pane = V_Type6_stru_D8654.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v14, v13, s, 0, 0xFFFF, 0xFF, 0);
    LOWORD(v14) = 0;
    s[0] = 0;
    qmemcpy(v18, V_Treaties, sizeof(v18));
    if ( V_Game.racesNum > 0 )
    {
      do
      {
        sprintf(
          v20,
          "R%d %10s %d\n",
          (__int16)v14,
          v18[V_Game.races[V_PlayerRaceIndex].treaties[(__int16)v14]],
          V_Game.races[V_PlayerRaceIndex]._treatiesScore[(__int16)v14]);
        ++v14;
        strcat(s, v20);
      }
      while ( (__int16)v14 < V_Game.racesNum );
    }
    v15 = *(_DWORD *)(a1 + 0xC) + 0x37;
    v16 = *(_DWORD *)(a1 + 8) + 5;
    WinMgr.LargeFont.pane = V_Type6_stru_D8654.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v16, v15, s, 0, 0xFFFF, 0xFF, 0);
  }
}
// 968DC: using guessed type char V_RaceIndexMask;
// 104BE8: using guessed type __int16 word_104BE8;
// 23BF0: using guessed type char s[128];
// 23BF0: using guessed type char var_2C[20];

//----- (00023FD4) --------------------------------------------------------
int __fastcall sub_23FD4(int a1)
{
  int result; // eax
  void *ShapeTable_sub_1B084; // eax
  void *v3; // eax
  int i; // esi
  LONG Unknown_02; // [esp-Ch] [ebp-44h]
  PANE *pane; // [esp+8h] [ebp-30h]
  LONG hotY; // [esp+Ch] [ebp-2Ch]
  LONG hotX; // [esp+10h] [ebp-28h]
  LONG flags; // [esp+14h] [ebp-24h]
  UWORD v11; // [esp+18h] [ebp-20h]
  char v12; // [esp+1Ch] [ebp-1Ch]

  v12 = 1;
  pane = (PANE *)(a1 + 4);
  for ( i = 0; ; ++i )
  {
    result = V_Game.racesNum;
    if ( i >= V_Game.racesNum )
    {
      break;
    }
    hotX = *((__int16 *)&unk_D85C8 + 2 * i);
    hotY = word_D85CA[2 * i];
    if ( (*(unsigned __int8 *)(a1 + 0xD8) & v12) != 0 && (V_Game.races[V_PlayerRaceIndex].treaties[i] || i == V_PlayerRaceIndex) )
    {
      flags = 0;
      v11 = GwshareShpCacheIndexes[i];
      if ( V_Game.races[i].Unknown_03 == 0xFFFFFFFF )
      {
        flags = 1;
        VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[0x16]);
      }
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v11);
      VFX_shape_transform(pane, ShapeTable_sub_1B084, 0, hotX, hotY, V_BigBuffer, 0, 0x10000, 0x10000, flags);
    }
    if ( (*(unsigned __int8 *)(a1 + 0xD8) & v12) != 0 )
    {
      Unknown_02 = V_Game.races[i].Unknown_02;
      v3 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x21]);
      VFX_shape_draw(pane, v3, Unknown_02, hotX, hotY);
    }
    v12 *= 2;
  }
  return result;
}
// D85CA: using guessed type __int16 word_D85CA[13];
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00024154) --------------------------------------------------------
void __fastcall sub_24154(float *a1, int a2, float a3)
{
  float degrees; // [esp+0h] [ebp-8h]

  sub_254B0((int)a1 + 0x172);
  degrees = a3 * WinMgr.j;
  if ( a2 == 0xFFFFFFFF )
  {
    sub_535E4((P_Matrices)((char *)a1 + 0x14E), degrees);
  }
  else
  {
    sub_535B4((P_Matrices)((char *)a1 + 0x14E), degrees);
  }
}

//----- (00024198) --------------------------------------------------------
void __fastcall sub_24198(int a1, int a2, int a3, int a4)
{
  int v5; // [esp-4h] [ebp-10h]

  if ( (*(float *)(a1 + 0x57A) >= 20.0 || a2 >= 0) && (*(float *)(a1 + 0x57A) <= 60.0 || a2 <= 0) )
  {
    v5 = *(__int16 *)(a1 + 0x576);
    *(float *)(a1 + 0x57A) = (double)a2 * WinMgr.j + *(float *)(a1 + 0x57A);
    sub_1B808((P_Matrices)(a1 + 0xDA), *(float *)(a1 + 0x57A), 1.0, 100000.0, v5);
    sub_254B0(a1 + 0x172);
  }
  else
  {
    *(_BYTE *)(a1 + 0xC0) &= ~0x10u;
  }
}

//----- (0002422C) --------------------------------------------------------
void __fastcall sub_2422C(int a1, int edx0, int ebx0, int a4)
{
  int v5; // kr00_4
  int v6; // eax
  size_t *v7; // eax
  _DWORD *v8; // ebp
  double v9; // st7
  size_t *v10; // eax
  int v11; // edx
  int **v12; // ebx
  int *v13; // ebp
  int *v14; // ebx
  int *v15; // ebp
  double v16; // st7
  double v17; // st7
  float z; // eax
  int v19; // ebp
  __int16 v20; // dx
  int v21; // ebp
  int v22; // ebx
  int j; // eax
  double v24; // st7
  unsigned __int8 v25; // al
  int v26[3]; // [esp+8h] [ebp-114h] BYREF
  T_Vector3D result; // [esp+14h] [ebp-108h] BYREF
  int v28[3]; // [esp+20h] [ebp-FCh] BYREF
  float v29; // [esp+2Ch] [ebp-F0h]
  int v30; // [esp+30h] [ebp-ECh]
  int v31; // [esp+34h] [ebp-E8h]
  T_Vector3D v32; // [esp+38h] [ebp-E4h] BYREF
  int v33[3]; // [esp+44h] [ebp-D8h] BYREF
  float v34; // [esp+50h] [ebp-CCh]
  float v35; // [esp+54h] [ebp-C8h]
  float v36; // [esp+58h] [ebp-C4h]
  T_Vector3D v37; // [esp+5Ch] [ebp-C0h]
  int v38[3]; // [esp+68h] [ebp-B4h] BYREF
  float v39; // [esp+74h] [ebp-A8h]
  int v40; // [esp+78h] [ebp-A4h]
  int v41; // [esp+7Ch] [ebp-A0h]
  float v42; // [esp+80h] [ebp-9Ch]
  int v43; // [esp+84h] [ebp-98h]
  int v44; // [esp+88h] [ebp-94h]
  float v45; // [esp+8Ch] [ebp-90h]
  float v46; // [esp+90h] [ebp-8Ch]
  float v47; // [esp+94h] [ebp-88h]
  float v48; // [esp+98h] [ebp-84h]
  int v49; // [esp+9Ch] [ebp-80h]
  int v50; // [esp+A0h] [ebp-7Ch]
  T_Vector3D a3; // [esp+A4h] [ebp-78h] BYREF
  int *v52; // [esp+B0h] [ebp-6Ch]
  int *v53; // [esp+B8h] [ebp-64h]
  int *v54; // [esp+BCh] [ebp-60h]
  float v55; // [esp+C0h] [ebp-5Ch]
  int *v56; // [esp+C4h] [ebp-58h]
  T_Vector3D *p_result; // [esp+C8h] [ebp-54h]
  int i; // [esp+D0h] [ebp-4Ch]
  size_t *v59; // [esp+D4h] [ebp-48h]
  T_Star *v60; // [esp+D8h] [ebp-44h]
  size_t *v61; // [esp+DCh] [ebp-40h]
  int v62; // [esp+E0h] [ebp-3Ch]
  float *a2; // [esp+E4h] [ebp-38h]
  int v64; // [esp+E8h] [ebp-34h]
  int v65; // [esp+ECh] [ebp-30h]
  int v66; // [esp+F0h] [ebp-2Ch]
  int v67; // [esp+F4h] [ebp-28h] BYREF
  int v68; // [esp+F8h] [ebp-24h] BYREF
  int v69; // [esp+FCh] [ebp-20h] BYREF
  __int16 v70[14]; // [esp+100h] [ebp-1Ch] BYREF

  memset(&a3, 0, sizeof(a3));
  memset(&v32, 0, sizeof(v32));
  v5 = *(_DWORD *)(a1 + 0xB3);
  sub_254B0(a1 + 0x172);
  sub_1B864((P_Matrices)(a1 + 0xDA));
  v59 = (size_t *)(a1 + 0x172);
  a2 = (float *)(a1 + 0x11A);
  v6 = v5 - 0x15;
  v61 = v59;
  for ( i = 0; ; ++i )
  {
    v65 = v6;
    if ( *(__int16 *)(a1 + 0xB7) <= i )
    {
      break;
    }
    v25 = *(_BYTE *)(v5 + 0x15 * i + 4);
    if ( v25 )
    {
      if ( v25 <= 1u )
      {
        v8 = *(_DWORD **)(v5 + 0x15 * i);
        Q_M34xV_sub_53384((P_Vector3D)(*v8 + 8), (T_Matrix3x4 *)a2, &a3);
        Q_M34xV_sub_53384((P_Vector3D)(v8[1] + 8), (T_Matrix3x4 *)a2, &v32);
        *(_DWORD *)(v5 + 0x15 * i + 0x11) = 0xFFFFFFFF;
        if ( a3.z > (double)*(float *)(a1 + 0x106)
          && a3.z < (double)*(float *)(a1 + 0x10A)
          && v32.z > (double)*(float *)(a1 + 0x106)
          && v32.z < (double)*(float *)(a1 + 0x10A) )
        {
          Q_Project3DTo2D_sub_533D4(&a3, *(float *)(a1 + 0x102), *(__int16 *)(a1 + 0x576), *(__int16 *)(a1 + 0x578), v70, (WORD *)&v69);
          Q_Project3DTo2D_sub_533D4(
            &v32,
            *(float *)(a1 + 0x102),
            *(__int16 *)(a1 + 0x576),
            *(__int16 *)(a1 + 0x578),
            (WORD *)&v68,
            (WORD *)&v67);
          *(_WORD *)(v5 + 0x15 * i + 5) = v70[0];
          *(_WORD *)(v5 + 0x15 * i + 7) = v69;
          *(_WORD *)(v5 + 0x15 * i + 9) = v68;
          *(_WORD *)(v5 + 0x15 * i + 0xB) = v67;
          v9 = (a3.z + v32.z) * 0.5;
          *(_DWORD *)(v5 + 0x15 * i + 0x11) = 0;
          v10 = v61;
          *(float *)(v5 + 0x15 * i + 0xD) = v9;
          sub_254BC((int)v10, v5 + 0x15 * i);
        }
      }
      else if ( v25 == 2 )
      {
        v11 = *(_DWORD *)(v5 + 0x15 * i);
        if ( *(_BYTE *)(v11 + 0x58) == 5 )
        {
          v12 = *(int ***)(v11 + 0x59);
          v45 = 0.0;
          v46 = 0.0;
          v47 = 0.0;
          v34 = 0.0;
          v35 = 0.0;
          v36 = 0.0;
          if ( (*(_DWORD *)(v11 + 0xA2) & 0x7FFFFFFF) != 0 )
          {
            v15 = *v12;
            v45 = *((float *)*v12 + 2);
            v46 = *((float *)v15 + 3);
            v47 = *((float *)v15 + 4);
            v14 = v12[1];
          }
          else
          {
            v13 = v12[1];
            v45 = *((float *)v13 + 2);
            v46 = *((float *)v13 + 3);
            v47 = *((float *)v13 + 4);
            v14 = *v12;
          }
          v34 = *((float *)v14 + 2);
          v35 = *((float *)v14 + 3);
          v36 = *((float *)v14 + 4);
          v48 = v34 - v45;
          v52 = v26;
          *(float *)&v49 = v35 - v46;
          *(float *)&v50 = v36 - v47;
          *(float *)v26 = v48;
          v26[1] = v49;
          v26[2] = v50;
          v16 = sqrt(*(float *)&v49 * *(float *)&v49 + v48 * v48 + *(float *)&v50 * *(float *)&v50);
          v53 = v33;
          v39 = v34 - v45;
          *(float *)v33 = v39;
          *(float *)&v40 = v35 - v46;
          v33[1] = v40;
          *(float *)&v41 = v36 - v47;
          v33[2] = v41;
          v54 = v38;
          v55 = *(float *)(v11 + 0x9E);
          v42 = v39 * v55;
          *(float *)&v43 = *(float *)&v40 * v55;
          *(float *)&v44 = *(float *)&v41 * v55;
          v17 = 1.0 / v16;
          *(float *)v38 = v42;
          v38[1] = v43;
          v38[2] = v44;
          v29 = v42 * v17;
          v56 = v28;
          *(float *)&v30 = *(float *)&v43 * v17;
          *(float *)v28 = v29;
          v28[1] = v30;
          *(float *)&v31 = v17 * *(float *)&v44;
          v28[2] = v31;
          v37.x = v45 + v29;
          p_result = &result;
          v37.y = v46 + *(float *)&v30;
          result = v37;
          v37.z = v47 + *(float *)&v31;
          Q_M34xV_sub_53384(&result, (T_Matrix3x4 *)a2, &a3);
          *(_DWORD *)(v5 + 0x15 * i + 0x11) = 0xFFFFFFFF;
          if ( a3.z > (double)*(float *)(a1 + 0x106) && a3.z < (double)*(float *)(a1 + 0x10A) )
          {
            Q_Project3DTo2D_sub_533D4(&a3, *(float *)(a1 + 0x102), *(__int16 *)(a1 + 0x576), *(__int16 *)(a1 + 0x578), v70, (WORD *)&v69);
            *(_WORD *)(v5 + 0x15 * i + 5) = v70[0] + 3;
            *(_WORD *)(v5 + 0x15 * i + 7) = v69;
            z = a3.z;
            *(_DWORD *)(v5 + 0x15 * i + 0x11) = 0;
            *(float *)(v5 + 0x15 * i + 0xD) = z;
            sub_254BC((int)v59, v5 + 0x15 * i);
            goto LABEL_29;
          }
        }
        else
        {
          v19 = *(_DWORD *)(v65 + 0x11);
          v64 = v65;
          if ( !v19 )
          {
            if ( *(_BYTE *)(v65 + 4) )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x56E);
            }
            v20 = 4;
            v21 = *(unsigned __int8 *)(v62 + 0x14);
            v22 = *(unsigned __int8 *)(a1 + 0xD8);
            v60 = *(T_Star **)v64;
            v66 = v22;
            for ( j = 0; j < 7; ++j )
            {
              if ( (v66 & v21 & (1 << j)) != 0 )
              {
                v20 += 2;
              }
            }
            if ( v60 == V_Game.pCurStar )
            {
              v20 += 2;
            }
            *(_WORD *)(v5 + 0x15 * i + 5) = v20 + *(_WORD *)(v64 + 5);
            *(_WORD *)(v5 + 0x15 * i + 7) = *(_WORD *)(v64 + 7);
            v24 = *(float *)(v64 + 0xD) + 1.0;
            *(_DWORD *)(v5 + 0x15 * i + 0x11) = 0;
            *(float *)(v5 + 0x15 * i + 0xD) = v24;
          }
        }
        sub_254BC((int)v59, v5 + 0x15 * i);
      }
      else
      {
        Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0x588);
      }
    }
    else
    {
      v62 = *(_DWORD *)(v5 + 0x15 * i);
      Q_M34xV_sub_53384((P_Vector3D)(v62 + 8), (T_Matrix3x4 *)a2, &a3);
      *(_DWORD *)(v5 + 0x15 * i + 0x11) = 0xFFFFFFFF;
      if ( a3.z > (double)*(float *)(a1 + 0x106) && a3.z < (double)*(float *)(a1 + 0x10A) )
      {
        Q_Project3DTo2D_sub_533D4(&a3, *(float *)(a1 + 0x102), *(__int16 *)(a1 + 0x576), *(__int16 *)(a1 + 0x578), v70, (WORD *)&v69);
        *(_WORD *)(v5 + 0x15 * i + 5) = v70[0];
        *(_WORD *)(v5 + 0x15 * i + 7) = v69;
        *(float *)(v5 + 0x15 * i + 0xD) = a3.z;
        v7 = v61;
        *(_DWORD *)(v5 + 0x15 * i + 0x11) = 0;
        sub_254BC((int)v7, v5 + 0x15 * i);
      }
    }
LABEL_29:
    v6 = v65 + 0x15;
  }
  sub_254DC(v61);
}
// 2422C: using guessed type _WORD var_1C[14];

//----- (00024948) --------------------------------------------------------
int __fastcall sub_24948(int result, int a2, int a3)
{
  int v3; // ebp
  int v4; // ebx
  int v5; // edi
  int v6; // edx
  int v7; // eax
  int v8; // edx
  int v9; // ebx
  __int16 v10; // si
  int i; // ebx
  int v12; // eax
  int v13; // edx
  int v14; // edi
  char v15; // dl
  int v16; // eax
  __int16 j; // si
  int v18; // ebx
  int v19; // edx
  int v20; // ebx
  int v21; // edx
  const char *v22; // ecx
  _DWORD v23[5]; // [esp+0h] [ebp-2Ch] BYREF
  int v24; // [esp+14h] [ebp-18h]
  int v25; // [esp+18h] [ebp-14h]

  v3 = result;
  v24 = a2;
  v25 = a3;
  if ( *(_DWORD *)(result + 0xD4) == 0xFFFFFFFF )
  {
    return result;
  }
  v4 = *(_DWORD *)(result + 0xBB);
  if ( v4 )
  {
    v5 = 0x28;
    v6 = *(__int16 *)(v4 + 5) - v24;
    v7 = *(__int16 *)(v4 + 7) - v25;
    if ( *(_BYTE *)(v4 + 4) == 2 )
    {
      v6 += byte_965F8[0];
      v5 = 0x14;
      v7 += SHIBYTE(dword_965FD);
    }
    result = v6 * v6 + v7 * v7;
    if ( result <= v5 )
    {
      return result;
    }
    v8 = *(_DWORD *)(v3 + 0x57E);
    *(_DWORD *)(v3 + 0xBB) = 0;
    sub_5A270(&WinMgr, v8, 0, 0);
    stru_D85E4.x0 = *(_DWORD *)(v3 + 0x10) - 0x82;
    v9 = *(_DWORD *)(v3 + 0xA7);
    stru_D85E4.y0 = *(_DWORD *)(v3 + 0x14) - 0x1B;
    (*(void (__fastcall **)(int, int))(v9 + 0xC))(v3, 0xA);
  }
  v10 = *(_WORD *)(v3 + 0xB7) - 1;
  for ( i = 0x15 * (*(__int16 *)(v3 + 0xB7) - 1) + *(_DWORD *)(v3 + 0xB3); ; i -= 0x15 )
  {
    result = v10;
    if ( v10 < 0 )
    {
      break;
    }
    if ( *(_BYTE *)(i + 4) != 1 )
    {
      v12 = *(__int16 *)(i + 5) - v24;
      v13 = *(__int16 *)(i + 7) - v25;
      v14 = 0x28;
      if ( *(_BYTE *)(i + 4) == 2 )
      {
        v12 += byte_965F8[0];
        v13 += SHIBYTE(dword_965FD);
        v14 = 0x14;
      }
      result = v13 * v13 + v12 * v12;
      if ( result < v14 )
      {
        *(_DWORD *)(v3 + 0xBB) = i;
        break;
      }
    }
    --v10;
  }
  if ( *(_DWORD *)(v3 + 0xBB) )
  {
    sub_5A270(&WinMgr, *(_DWORD *)(v3 + 0x57E) + 1, 0, 0);
    result = *(_DWORD *)(v3 + 0xBB);
    if ( !*(_BYTE *)(result + 4) )
    {
      v23[0] = dword_96654[0];
      v23[1] = dword_96654[1];
      v23[2] = dword_96654[2];
      v23[3] = dword_96654[3];
      v23[4] = dword_96654[4];
      v15 = 1;
      v16 = **(_DWORD **)(v3 + 0xBB);
      if ( ((unsigned __int8)V_RaceIndexMask & *(_BYTE *)(v16 + 0x17)) != 0 )
      {
        strcpy((char *)v23, (const char *)(v16 + 0x1C));
        for ( j = 0; j < 7 && (*(_BYTE *)(**(_DWORD **)(v3 + 0xBB) + 0x14) & (unsigned __int8)(*(_BYTE *)(v3 + 0xD9) & v15)) == 0; ++j )
        {
          v15 *= 2;
        }
      }
      if ( LOBYTE(v23[0]) )
      {
        v18 = *(_DWORD *)(v3 + 0x14) - 0x1B;
        v19 = *(_DWORD *)(v3 + 0x10) - 0x82;
        WinMgr.LargeFont.pane = V_Type6_stru_D8654.pane;
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v19, v18, (const char *)v23, 0, 0xFFFF, 0xFF, 0);
      }
      v20 = *(_DWORD *)(v3 + 0x14) - 0xC;
      v21 = *(_DWORD *)(v3 + 0x10) - 0x82;
      v22 = V_StarTypeTexts_D84C4[***(_DWORD ***)(v3 + 0xBB)];
      WinMgr.SmallFont.pane = V_Type6_stru_D8654.pane;
      return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, v21, v20, v22, 0, 0xFFFF, 0xFF, 0);
    }
  }
  return result;
}
// 965FD: using guessed type int dword_965FD;
// 96654: using guessed type _DWORD dword_96654[5];
// 968DC: using guessed type char V_RaceIndexMask;

//----- (00024BE0) --------------------------------------------------------
void __fastcall sub_24BE0(P_Wnd2COSW a1)
{
  int Unknown_BB; // eax
  T_Star *v3; // eax
  T_WndA2 *v4; // eax
  P_Star v5; // eax
  T_Lane *v6; // ebx
  int v7; // ecx
  int v8; // edx
  int i; // ecx

  Unknown_BB = a1->Unknown_BB;
  if ( !*(_BYTE *)(Unknown_BB + 4) )
  {
    if ( a1->Unknown_582 )
    {
      v5 = *(P_Star *)Unknown_BB;
      if ( ((unsigned __int8)V_RaceIndexMask & v5->exploredPathToBits) != 0 )
      {
        for ( i = 0; i < v5->lanesNum; ++i )
        {
          v6 = v5->_lanes[i];
          if ( v5 == v6->pStar1 && v6->pStar2 == *(P_Star *)a1->Unknown_586 || v6->pStar1 == *(P_Star *)a1->Unknown_586 && v5 == v6->pStar2 )
          {
            v7 = *(_DWORD *)a1->Unknown_586;
            v8 = (int)v5;
            sub_1D654((P_Location)v7, v5, v6);
            a1->Unknown_582 = 0;
            sub_24D30((int)a1, v8, (int)v6, v7);
            sub_2422C((int)a1, v8, (int)v6, v7);
            a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
            return;
          }
        }
      }
    }
    else if ( WinMgr.state == 1 )
    {
      v3 = *(T_Star **)Unknown_BB;
      if ( ((unsigned __int8)V_RaceIndexMask & v3->exploredBits) != 0 )
      {
        V_Game.pCurStar = v3;
        a1->Unknown_BB = 0;
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 1);
      }
    }
    else if ( WinMgr.state == 0xD )
    {
      V_Game.pCurStar = *(P_Star *)Unknown_BB;
      v4 = sub_56E18(&WinMgr, "NEGSCREEN", 0xD, 0);
      if ( !v4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x612);
      }
      sub_32A1C((int)v4);
      a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
    }
  }
}
// 968DC: using guessed type char V_RaceIndexMask;

//----- (00024D30) --------------------------------------------------------
int __fastcall sub_24D30(int a1, int a2, int a3, int a4)
{
  WORD i; // di
  T_Star *v6; // esi
  __int16 v7; // bx
  int ShipsAtLocation_sub_1D794; // esi
  WORD j; // si
  T_Lane *v10; // edi
  WORD v11; // di
  __int16 k; // si
  int result; // eax
  T_Ship *v14; // eax
  int v15[107]; // [esp+0h] [ebp-1D4h] BYREF
  char s[32]; // [esp+1ACh] [ebp-28h] BYREF

  *(_WORD *)(a1 + 0xB7) = 0;
  for ( i = 0; i < V_Game.starsNum; ++i )
  {
    if ( *(_WORD *)(a1 + 0xB7) >= *(_WORD *)(a1 + 0xB9) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x659);
    }
    v6 = &V_Game.stars[i];
    *(_DWORD *)(*(_DWORD *)(a1 + 0xB3) + 0x15 * *(__int16 *)(a1 + 0xB7)) = v6;
    *(_BYTE *)(*(_DWORD *)(a1 + 0xB3) + 0x15 * *(__int16 *)(a1 + 0xB7) + 4) = 0;
    v7 = *(_WORD *)(a1 + 0xB7) + 1;
    *(_WORD *)(a1 + 0xB7) = v7;
    if ( v6->racePresenceBits )
    {
      if ( v7 >= *(__int16 *)(a1 + 0xB9) )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x66B);
      }
      ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[i], (P_Ship *)v15);
      if ( !ShipsAtLocation_sub_1D794 && V_NougatLfExists_dword_A0CFC == 0xFFFFFFFF )
      {
        sprintf(s, "cos%05d.bug", V_Game.day);
        Q_SaveGam_sub_54048(s);
        Q_AssertLogBreakExit_sub_261A8(0, "..\\coswnd.cpp", 0x676);
      }
      if ( ShipsAtLocation_sub_1D794 > 0 )
      {
        *(_DWORD *)(0x15 * *(__int16 *)(a1 + 0xB7) + *(_DWORD *)(a1 + 0xB3)) = v15[0];
        *(_BYTE *)(*(_DWORD *)(a1 + 0xB3) + 0x15 * (__int16)(*(_WORD *)(a1 + 0xB7))++ + 4) = 2;
      }
    }
  }
  for ( j = 0; j < V_Game.lanesNum; ++j )
  {
    v10 = &V_Game.lanes[j];
    if ( ((unsigned __int8)V_RaceIndexMask & v10->exploredBits) != 0 )
    {
      if ( *(_WORD *)(a1 + 0xB7) >= *(_WORD *)(a1 + 0xB9) )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x68B);
      }
      *(_DWORD *)(*(_DWORD *)(a1 + 0xB3) + 0x15 * *(__int16 *)(a1 + 0xB7)) = v10;
      *(_BYTE *)(*(_DWORD *)(a1 + 0xB3) + 0x15 * (__int16)(*(_WORD *)(a1 + 0xB7))++ + 4) = 1;
    }
  }
  v11 = 0;
  for ( k = 0; ; ++k )
  {
    result = k;
    if ( k >= 0x6B || v11 >= V_Game.shipsNum )
    {
      break;
    }
    if ( *(_WORD *)(a1 + 0xB7) >= *(_WORD *)(a1 + 0xB9) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x698);
    }
    v14 = &V_Game.ships[k];
    if ( v14->raceIndex != 0xFFFFFFFF )
    {
      ++v11;
      if ( v14->locationType == 5 )
      {
        *(_DWORD *)(0x15 * *(__int16 *)(a1 + 0xB7) + *(_DWORD *)(a1 + 0xB3)) = v14;
        *(_BYTE *)(0x15 * (__int16)(*(_WORD *)(a1 + 0xB7))++ + *(_DWORD *)(a1 + 0xB3) + 4) = 2;
      }
    }
  }
  return result;
}
// 968DC: using guessed type char V_RaceIndexMask;
// 24D30: using guessed type int var_1D4[107];

//----- (00024FCC) --------------------------------------------------------
void __fastcall sub_24FCC(P_Wnd2COSW a1, P_CFile pfi, int read)
{
  T_Matrices *p_matrices; // ecx
  float *v5; // edi
  float *v6; // ebp
  float *v7; // edx
  T_Matrix3x3 *v8; // edx
  float *v9; // edx
  int v10[7]; // [esp+0h] [ebp-1A4h] BYREF
  char Unknown_D8; // [esp+1Ch] [ebp-188h]
  char Unknown_D9; // [esp+1Dh] [ebp-187h]
  T_Matrices v13; // [esp+1Eh] [ebp-186h] BYREF
  int Unknown_57A; // [esp+B6h] [ebp-EEh]
  int v15[7]; // [esp+C0h] [ebp-E4h] BYREF
  char v16; // [esp+DCh] [ebp-C8h]
  char v17; // [esp+DDh] [ebp-C7h]
  T_Matrices v18; // [esp+DEh] [ebp-C6h] BYREF
  int v19; // [esp+176h] [ebp-2Eh]
  P_CFile pfi_; // [esp+180h] [ebp-24h]
  T_Matrix3x3 *p_matrix_74; // [esp+184h] [ebp-20h]
  float *v22; // [esp+188h] [ebp-1Ch]
  float *v23; // [esp+18Ch] [ebp-18h]
  T_Vector3D *p_vector_34; // [esp+190h] [ebp-14h]

  pfi_ = pfi;
  p_matrices = &a1->matrices;
  p_matrix_74 = &a1->matrices.matrix_74;
  v5 = a1->matrices.matrix_00._[2];
  p_vector_34 = &a1->matrices.vector_34;
  v6 = a1->matrices.matrix_74._[2];
  v23 = a1->matrices.matrix_00._[1];
  v22 = a1->matrices.matrix_74._[1];
  if ( read == TRUE )
  {
    sub_1B4F0(&v18);
    Q_ReadFile_sub_1BF94(pfi_, v15, 0xBEu);
    a1->Unknown_C0 = v15[0];
    a1->Unknown_C4 = v15[1];
    a1->Unknown_58A = v15[2];
    a1->Unknown_C8 = v15[3];
    a1->Unknown_CC = v15[4];
    a1->Unknown_D0 = v15[5];
    a1->Unknown_D4 = v15[6];
    a1->Unknown_D8 = v16;
    a1->Unknown_D9 = v17;
    p_matrices->matrix_00._[0][0] = v18.matrix_00._[0][0];
    p_matrices->matrix_00._[0][1] = v18.matrix_00._[0][1];
    p_matrices->matrix_00._[0][2] = v18.matrix_00._[0][2];
    v7 = v23;
    *v23 = v18.matrix_00._[1][0];
    v7[1] = v18.matrix_00._[1][1];
    v7[2] = v18.matrix_00._[1][2];
    *v5 = v18.matrix_00._[2][0];
    v5[1] = v18.matrix_00._[2][1];
    v5[2] = v18.matrix_00._[2][2];
    p_matrices->Unknown_24 = v18.Unknown_24;
    p_matrices->_scaleFactor = v18._scaleFactor;
    p_matrices->Unknown_2C = v18.Unknown_2C;
    p_matrices->Unknown_30 = v18.Unknown_30;
    *p_vector_34 = v18.vector_34;
    p_matrices->trs = v18.trs;
    p_matrices->Unknown_70 = v18.Unknown_70;
    v8 = p_matrix_74;
    p_matrix_74->_[0][0] = v18.matrix_74._[0][0];
    v8->_[0][1] = v18.matrix_74._[0][1];
    v8->_[0][2] = v18.matrix_74._[0][2];
    v9 = v22;
    *v22 = v18.matrix_74._[1][0];
    v9[1] = v18.matrix_74._[1][1];
    v9[2] = v18.matrix_74._[1][2];
    *v6 = v18.matrix_74._[2][0];
    v6[1] = v18.matrix_74._[2][1];
    v6[2] = v18.matrix_74._[2][2];
    a1->Unknown_57A = (float)v19;
    Q_Ret_sub_1B66C();
  }
  else
  {
    sub_1B4F0(&v13);
    v10[0] = a1->Unknown_C0;
    v10[1] = a1->Unknown_C4;
    v10[2] = a1->Unknown_58A;
    v10[3] = a1->Unknown_C8;
    v10[4] = a1->Unknown_CC;
    v10[5] = a1->Unknown_D0;
    v10[6] = a1->Unknown_D4;
    Unknown_D8 = a1->Unknown_D8;
    Unknown_D9 = a1->Unknown_D9;
    v13.matrix_00._[0][0] = p_matrices->matrix_00._[0][0];
    v13.matrix_00._[0][1] = a1->matrices.matrix_00._[0][1];
    v13.matrix_00._[0][2] = a1->matrices.matrix_00._[0][2];
    v13.matrix_00._[1][0] = *v23;
    v13.matrix_00._[1][1] = v23[1];
    v13.matrix_00._[1][2] = v23[2];
    v13.matrix_00._[2][0] = *v5;
    v13.matrix_00._[2][1] = a1->matrices.matrix_00._[2][1];
    v13.matrix_00._[2][2] = a1->matrices.matrix_00._[2][2];
    v13.Unknown_24 = a1->matrices.Unknown_24;
    v13._scaleFactor = a1->matrices._scaleFactor;
    v13.Unknown_2C = a1->matrices.Unknown_2C;
    v13.Unknown_30 = a1->matrices.Unknown_30;
    v13.vector_34 = *p_vector_34;
    v13.trs = a1->matrices.trs;
    v13.Unknown_70 = a1->matrices.Unknown_70;
    v13.matrix_74._[0][0] = p_matrix_74->_[0][0];
    v13.matrix_74._[0][1] = p_matrix_74->_[0][1];
    v13.matrix_74._[0][2] = p_matrix_74->_[0][2];
    v13.matrix_74._[1][0] = *v22;
    v13.matrix_74._[1][1] = v22[1];
    v13.matrix_74._[1][2] = v22[2];
    v13.matrix_74._[2][0] = *v6;
    v13.matrix_74._[2][1] = a1->matrices.matrix_74._[2][1];
    v13.matrix_74._[2][2] = a1->matrices.matrix_74._[2][2];
    Unknown_57A = (int)a1->Unknown_57A;
    Q_CFile_DosWrite_sub_1C098(pfi_, v10, 0xBEu);
    Q_Ret_sub_1B66C();
  }
}

//----- (000254A4) --------------------------------------------------------
void __fastcall __spoils<> sub_254A4(int a1)
{
  sub_254B0(a1);
}

//----- (000254B0) --------------------------------------------------------
void __fastcall __spoils<> sub_254B0(int result)
{
  *(_DWORD *)(result + 0x400) = 0;
}

//----- (000254BC) --------------------------------------------------------
int __fastcall sub_254BC(int result, int a2)
{
  int v2; // ebx

  v2 = *(_DWORD *)(result + 0x400);
  if ( v2 < 0x100 )
  {
    if ( a2 )
    {
      *(_DWORD *)(result + 4 * v2) = a2;
      ++*(_DWORD *)(result + 0x400);
    }
  }
  return result;
}

//----- (000254DC) --------------------------------------------------------
void __fastcall sub_254DC(size_t *a1)
{
  qsort(a1, a1[0x100], 4u, sub_22430);
}

//----- (000254F8) --------------------------------------------------------
void __fastcall sub_254F8(int *a1, int a2)
{
  int v2; // esi
  unsigned __int8 v3; // al
  LONG v4; // edi
  int j; // kr0C_4
  int v6; // ecx
  T_Star *v7; // ebx
  LONG v8; // eax
  LONG v9; // ebp
  T_Star *v10; // eax
  char v11; // dl
  int v12; // edi
  LONG v13; // ecx
  LONG v14; // [esp-Ch] [ebp-78h]
  LONG v15; // [esp-8h] [ebp-74h]
  LONG v16; // [esp-8h] [ebp-74h]
  PANE *v17; // [esp+0h] [ebp-6Ch]
  int v19; // [esp+Ch] [ebp-60h]
  PANE *v20; // [esp+10h] [ebp-5Ch]
  T_Star *v21; // [esp+14h] [ebp-58h]
  PANE *v22; // [esp+18h] [ebp-54h]
  PANE *v23; // [esp+1Ch] [ebp-50h]
  PANE *v24; // [esp+20h] [ebp-4Ch]
  PANE *v25; // [esp+24h] [ebp-48h]
  int v26; // [esp+28h] [ebp-44h]
  PANE *v27; // [esp+2Ch] [ebp-40h]
  PANE *pane; // [esp+30h] [ebp-3Ch]
  T_Star *v29; // [esp+34h] [ebp-38h]
  int v30; // [esp+38h] [ebp-34h]
  int i; // [esp+40h] [ebp-2Ch]
  __int16 state; // [esp+44h] [ebp-28h]
  __int16 k; // [esp+48h] [ebp-24h]
  unsigned __int8 v35; // [esp+4Ch] [ebp-20h]
  char v36; // [esp+50h] [ebp-1Ch]
  char v37; // [esp+54h] [ebp-18h]

  VFX_pane_wipe((PANE *)(a2 + 4), *(unsigned __int8 *)(a2 + 0xBF));
  v35 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  if ( a1[0x100] > 0 )
  {
    v26 = 0;
    v27 = (PANE *)(a2 + 4);
    v25 = (PANE *)(a2 + 4);
    v24 = (PANE *)(a2 + 4);
    v20 = (PANE *)(a2 + 4);
    pane = (PANE *)(a2 + 4);
    v17 = (PANE *)(a2 + 4);
    v22 = (PANE *)(a2 + 4);
    v23 = (PANE *)(a2 + 4);
    do
    {
      v2 = a1[v26];
      v3 = *(_BYTE *)(v2 + 4);
      v19 = (int)(*(float *)(v2 + 0xD) + -1500.0);
      if ( v3 )
      {
        if ( v3 <= 1u )
        {
          if ( *(_DWORD *)(a2 + 0xC4) || *(_DWORD *)(a2 + 0x58A) )
          {
            v6 = 7;
            v7 = *(T_Star **)v2;
            if ( v19 <= 0xDC )
            {
              if ( v19 <= 0x93 )
              {
                if ( v19 <= 0x49 )
                {
                  if ( v19 <= 0 )
                  {
                    if ( v19 <= (int)0xFFFFFFB7 )
                    {
                      if ( v19 <= (int)0xFFFFFF6D )
                      {
                        if ( v19 > (int)0xFFFFFF24 )
                        {
                          v6 = 6;
                        }
                      }
                      else
                      {
                        v6 = 5;
                      }
                    }
                    else
                    {
                      v6 = 4;
                    }
                  }
                  else
                  {
                    v6 = 3;
                  }
                }
                else
                {
                  v6 = 2;
                }
              }
              else
              {
                v6 = 1;
              }
            }
            else
            {
              v6 = 0;
            }
            if ( *(_DWORD *)(a2 + 0x58A) == 0xFFFFFFFF )
            {
              if ( *(_WORD *)&v7->name[5] )
              {
                v8 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x10 + v6 / 2;
              }
              else
              {
                v8 = v6 + 0x30;
              }
            }
            else
            {
              v8 = v6 + 0x68;
            }
            if ( !*(_DWORD *)(a2 + 0x58A) && (v7->name[7] & 1) != 0 )
            {
              v8 = v6 / 2 + 0x70;
            }
            VFX_line_draw(v22, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7), *(__int16 *)(v2 + 9), *(__int16 *)(v2 + 0xB), 0, v8);
          }
        }
        else if ( v3 == 2 && *(_DWORD *)(a2 + 0xC8) )
        {
          v9 = 3;
          v10 = *(T_Star **)v2;
          if ( v19 <= 0xDC )
          {
            if ( v19 <= 0 )
            {
              if ( v19 > (int)0xFFFFFF24 )
              {
                v9 = 2;
              }
            }
            else
            {
              v9 = 1;
            }
          }
          else
          {
            v9 = 0;
          }
          v11 = BYTE2(v10->planets[4]);
          if ( v11 == 5 )
          {
            if ( ((1 << V_PlayerRaceIndex) & LOBYTE((*(P_Planet *)((char *)&v10->planets[4] + 3))->blackSquaresNum)) != 0
              && ((1 << LOWORD(v10->planets[4])) & *(unsigned __int8 *)(a2 + 0xD8)) != 0 )
            {
              Q_DrawRaceTintedShape_sub_53EB8(
                v23,
                *(void **)(a2 + 0xAF),
                v9,
                *(__int16 *)(v2 + 5),
                *(__int16 *)(v2 + 7),
                (WORD)v10->planets[4]);
            }
          }
          else
          {
            v36 = 1;
            if ( v11 == 4 )
            {
              v29 = *(T_Star **)((char *)&v10->planets[4] + 3);
            }
            else
            {
              v29 = &V_Game.stars[(*(P_Planet *)((char *)&v10->planets[4] + 3))->starIndex];
            }
            if ( !v29 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x822);
            }
            if ( ((1 << V_PlayerRaceIndex) & v29->exploredBits) != 0 )
            {
              v12 = 0;
              for ( i = 0; V_Game.racesNum > i; ++i )
              {
                if ( (*(_BYTE *)(a2 + 0xD8) & (unsigned __int8)(v36 & v29->racePresenceBits)) != 0 )
                {
                  v16 = *(__int16 *)(v2 + 7) + *((char *)&dword_965FD + v12 + 3);
                  v13 = *(__int16 *)(v2 + 5) + byte_965F8[v12++];
                  Q_DrawRaceTintedShape_sub_53EB8(v20, *(void **)(a2 + 0xAF), v9, v13, v16, i);
                }
                v36 *= 2;
              }
            }
          }
        }
      }
      else
      {
        v21 = *(T_Star **)v2;
        v30 = 3;
        if ( v19 <= 0xDC )
        {
          if ( v19 <= 0 )
          {
            if ( v19 > (int)0xFFFFFF24 )
            {
              v30 = 2;
            }
          }
          else
          {
            v30 = 1;
          }
        }
        else
        {
          v30 = 0;
        }
        VFX_shape_draw(v17, *(void **)(a2 + 0xAB), v30 + 4 * v21->type, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7));
        state = WinMgr.state;
        v4 = 4;
        if ( (((1 << V_PlayerRaceIndex) & v21->exploredBits) != 0 || WinMgr.state == 3) && *(_DWORD *)(a2 + 0xCC) && v21->racesBits )
        {
          v37 = 1;
          for ( j = 0; j != 7; ++j )
          {
            if ( (*(_BYTE *)(a2 + 0xD8) & (unsigned __int8)(v21->racesBits & v37)) != 0 )
            {
              v15 = v4;
              v14 = v4;
              v4 += 2;
              VFX_ellipse_draw(
                pane,
                *(__int16 *)(v2 + 5),
                *(__int16 *)(v2 + 7),
                v14,
                v15,
                v30 + (unsigned __int8)(4 * V_Game.races[j].Unknown_02 + 0x13) - 3);
            }
            v37 *= 2;
          }
        }
        if ( v21 == V_Game.pCurStar && WinMgr.state != 3 )
        {
          VFX_ellipse_draw(v24, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7), v4, v4, 0xF3);
        }
        if ( (((1 << V_PlayerRaceIndex) & v21->exploredBits) != 0 || state == 3)
          && (v21->racesBits & 0x80) != 0
          && *(_DWORD *)(a2 + 0xD0) == 0xFFFFFFFF )
        {
          for ( k = 0; k < V_Game.racesNum; ++k )
          {
            if ( v21 == V_Game.races[k]._homeStar )
            {
              break;
            }
          }
          if ( k >= V_Game.racesNum )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\coswnd.cpp", 0x786);
          }
          if ( (*(_BYTE *)(a2 + 0xD8) & (unsigned __int8)(1 << k)) != 0 || WinMgr.state == 3 )
          {
            Q_WINMGR_CPP_sub_53E38(v25, *(__int16 *)(v2 + 5) - 7, *(__int16 *)(v2 + 7) + 3, k);
          }
        }
        if ( ((1 << V_PlayerRaceIndex) & v21->exploredBits) != 0
          && *(_DWORD *)(a2 + 0xCC)
          && ((1 << V_PlayerRaceIndex) & v21->racesBits) == 0 )
        {
          VFX_pixel_write(v27, *(__int16 *)(v2 + 5) - 4, *(__int16 *)(v2 + 7), v35);
          VFX_pixel_write(v27, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7) - 4, v35);
          VFX_pixel_write(v27, *(__int16 *)(v2 + 5) + 4, *(__int16 *)(v2 + 7), v35);
          VFX_pixel_write(v27, *(__int16 *)(v2 + 5), *(__int16 *)(v2 + 7) + 4, v35);
        }
      }
      ++v26;
    }
    while ( v26 < a1[0x100] );
  }
}
// 965FD: using guessed type int dword_965FD;

//----- (00025BF8) --------------------------------------------------------
void __fastcall __spoils<> sub_25BF8(P_WndA2 a1)
{
  Q_A2Ctor_sub_2C830(a1);
  a1->pProcs = (P_Procs)&off_95B9C;
}
// 95B9C: using guessed type int (__fastcall *off_95B9C)(P_WndA2 a1);

//----- (00025C08) --------------------------------------------------------
T_WndA2 *__fastcall sub_25C08(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95B48);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95B9C;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95B9C: using guessed type int (__fastcall *off_95B9C)(P_WndA2 a1);

//----- (00025C4C) --------------------------------------------------------
void __fastcall sub_25C4C(unsigned int a1, int a2)
{
  int v3; // edi
  PANE *v4; // ebp
  __int16 v5; // si

  sub_2CD24(a1, a2);
  v3 = 0x2F;
  if ( V_Game.racesNum > 0 )
  {
    v4 = (PANE *)(a1 + 4);
    v5 = 0;
    do
    {
      if ( v5 == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[v5] )
      {
        Q_WINMGR_CPP_sub_53E38(v4, (__int16)v3, 3, v5);
        v3 += 0x10;
      }
      ++v5;
    }
    while ( v5 < V_Game.racesNum );
  }
}

//----- (00025CB8) --------------------------------------------------------
void __fastcall __spoils<> Q_WndRSWCtor_sub_25CB8(P_WndRSW result)
{
  Q_A2Ctor_sub_2C830(&result->a);
  result->a.pProcs = (P_Procs)&off_95B84;
  result->Unknown_AB = 0;
}
// 95B84: using guessed type int (__fastcall *off_95B84)(P_WndA2 a1);

//----- (00025CD4) --------------------------------------------------------
T_WndA2 *__fastcall Q_WndRSWDtor_sub_25CD4(P_WndRSW a1, char a2)
{
  char *v4; // eax
  P_WndRSW v6; // ebx

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_WndRSW);
    operator delete[](v4);
    return (T_WndA2 *)a1;
  }
  else
  {
    a1->a.pProcs = (P_Procs)&off_95B84;
    Q_A2Dtor_sub_2C848(&a1->a, 1);
    v6 = a1;
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return (T_WndA2 *)v6;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95B84: using guessed type int (__fastcall *off_95B84)(P_WndA2 a1);

//----- (00025D18) --------------------------------------------------------
void __fastcall sub_25D18(int result, LONG a2)
{
  unsigned int v3; // esi
  int v4; // ecx
  UBYTE nameIndex; // al
  __int16 v6; // cx
  WORD i; // ax
  char *sub_1CEA8; // eax
  char *v9; // eax
  WORD v10; // ax
  WINDOW **v11; // esi
  const char *v12; // ecx
  LONG *v13; // esi
  int v14; // ecx
  LONG v15; // ebx
  void *ShapeTable_sub_1B084; // eax
  WORD v17; // [esp-8h] [ebp-68h]
  int v18; // [esp-4h] [ebp-64h]
  char s[52]; // [esp+0h] [ebp-60h] BYREF
  int Unknown_03; // [esp+34h] [ebp-2Ch]
  int v21; // [esp+38h] [ebp-28h]
  char *v22; // [esp+3Ch] [ebp-24h]
  LONG color; // [esp+40h] [ebp-20h]
  int v24; // [esp+44h] [ebp-1Ch]
  BYTE v25; // [esp+48h] [ebp-18h]

  if ( *(_DWORD *)(result + 0x39) )
  {
    v3 = 0xFFFFFFFF;
    v24 = 0;
    color = 0xF2;
    if ( a2 )
    {
      color = a2;
    }
    v4 = *(__int16 *)(result + 0xAB);
    Unknown_03 = V_Game.races[v4].Unknown_03;
    v25 = V_Game.races[V_PlayerRaceIndex].treaties[v4];
    if ( !v25 || Unknown_03 )
    {
      v24 = 0xFFFFFFFF;
    }
    else
    {
      nameIndex = V_Game.races[v4]._nameIndex;
      v21 = 4 * V_Game.races[v4].Unknown_02 + 0x13;
      v22 = V_SpecNames[nameIndex];
    }
    if ( *(_WORD *)(result + 0xAB) == V_PlayerRaceIndex )
    {
      v6 = 0;
      for ( i = 0; i < V_Game.racesNum; ++i )
      {
        if ( i != V_PlayerRaceIndex && V_Game.races[V_PlayerRaceIndex].treaties[i] )
        {
          ++v6;
        }
      }
      v18 = V_Game.racesNum - 1;
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xB);// 11: "%d of %d Species Known"
      sprintf(s, sub_1CEA8, v6, v18);
      v22 = s;
      v24 = 0;
      v21 = 0xF3;
      color = 0xF2;
      v3 = 0;
    }
    if ( Unknown_03 == 0xFFFFFFFF )
    {
      v9 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xC);    // 12: "Extinct"
      sprintf(s, v9);
      v22 = s;
      v21 = 0xF3;
      v24 = 0;
    }
    if ( !v24 )
    {
      if ( v3 == 0xFFFFFFFF )
      {
        VFX_pane_wipe((PANE *)(result + 4), color);
        v17 = color;
        v10 = HIWORD(Unknown_03);
        v11 = (WINDOW **)(result + 4);
      }
      else
      {
        v10 = v21;
        v11 = (WINDOW **)(result + 4);
        v17 = 0xFF;
      }
      v12 = v22;
      WinMgr.LargeFont.pane.window = *v11;
      v13 = (LONG *)(v11 + 1);
      WinMgr.LargeFont.pane.x0 = *v13++;
      WinMgr.LargeFont.pane.y0 = *v13++;
      WinMgr.LargeFont.pane.x1 = *v13;
      WinMgr.LargeFont.pane.y1 = v13[1];
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, v12, 0x43, v10, v17, 0);
    }
    if ( v25 )
    {
      v14 = *(__int16 *)(result + 0xAB);
      if ( v14 != V_PlayerRaceIndex && v24 != 0xFFFFFFFF )
      {
        Q_WINMGR_CPP_sub_53E38((PANE *)(result + 4), 0xE, 3, v14);
        v15 = 0xFFFFFFFF;
        if ( !Unknown_03 )
        {
          if ( v25 == 3 )
          {
            v15 = 9;
          }
          else if ( v25 == 2 )
          {
            v15 = 8;
          }
        }
        if ( v15 != 0xFFFFFFFF )
        {
          ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
          VFX_shape_draw((PANE *)(result + 4), ShapeTable_sub_1B084, v15, 0xE, 3);
        }
      }
    }
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(result + 4));
  }
}

//----- (00025FB4) --------------------------------------------------------
int __fastcall sub_25FB4(int result)
{
  if ( *(_DWORD *)(result + 0x39) )
  {
    return (*(int (**)(void))(*(_DWORD *)(result + 0xA7) + 0xC))();
  }
  return result;
}

//----- (00026000) --------------------------------------------------------
int __fastcall sub_26000(int a1, __int16 a2, __int16 a3, LONG a4)
{
  WORD v5; // ax
  int result; // eax
  LONG v7; // ecx
  LONG v8; // edx
  LONG v9; // ebx
  int v10; // eax
  int v11; // [esp-4h] [ebp-14h]

  switch ( a2 )
  {
    case 1:
      v5 = *(char *)(a1 + 0x25) - 0x31;
      *(_WORD *)(a1 + 0xAB) = v5;
      if ( v5 < V_Game.racesNum )
      {
        goto LABEL_10;
      }
      result = 0;
      break;
    case 2:
      *(_DWORD *)(a1 + 0x39) = 0;
      v7 = *(_DWORD *)(a1 + 0x10);
      v8 = *(_DWORD *)(a1 + 8);
      v11 = *(_DWORD *)(a1 + 0x14);
      v9 = *(_DWORD *)(a1 + 0xC);
      *(_DWORD *)(a1 + 0x35) = 0;
      Q_WinMgr_WipeAndAddDirtyArea_sub_55214(&WinMgr, v8, v9, v7, v11);
      result = 0;
      break;
    case 4:
    case 5:
      v10 = *(__int16 *)(a1 + 0xAB);
      if ( V_Game.races[V_PlayerRaceIndex].treaties[v10] && v10 != V_PlayerRaceIndex && V_Game.races[v10].Unknown_03 != 0xFFFFFFFF )
      {
        byte_968DD = *(_BYTE *)(a1 + 0xAB);
        goto LABEL_10;
      }
      result = 0;
      break;
    case 6:
      goto LABEL_13;
    case 7:
      (*(void (**)(void))(*(_DWORD *)(a1 + 0xA7) + 0x10))();
      result = 0xFFFFFFFF;
      break;
    case 0xB:
      *(_WORD *)(a1 + 0xAB) = a3;
LABEL_13:
      (*(void (**)(void))(*(_DWORD *)(a1 + 0xA7) + 0xC))();
      result = 0xFFFFFFFF;
      break;
    case 0xD:
      (*(void (__fastcall **)(int, _DWORD, __int16, LONG))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0, a3, a4);
      result = Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
      break;
    default:
LABEL_10:
      result = Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
      break;
  }
  return result;
}
// 968DD: using guessed type char byte_968DD;

//----- (00026140) --------------------------------------------------------
void sub_26140()
{
  Q_Ret_sub_1B66C();
}

//----- (00026150) --------------------------------------------------------
char *__fastcall sub_26150(char *result)
{
  sub_1B4F0((P_Matrices)(result + 0x1E));
  return result;
}

//----- (00026160) --------------------------------------------------------
int Q_StopSystems_sub_26160()
{
  Q_StopMouse_sub_2632C();
  Q_StopVideoSystem_sub_2C6CC(&V_Type6_stru_D8654);
  Q_StopSoundSystem_sub_4FE8C(&V_SoundSystem);
  return printf("\n%s\n\n", "Thank you for playing Ascendancy.");
}

//----- (00026194) --------------------------------------------------------
void Q_debugbreak_sub_26194()
{
  __debugbreak();
}

//----- (00026198) --------------------------------------------------------
void __fastcall __noreturn Q_AssertLogBreakExit_sub_26198(int ignore, const char *sourcefile, int line)
{
  if ( !ignore )
  {
    sprintf("Thank you for playing Ascendancy.", "Assert Failed: <%s> Line %d\n\n", sourcefile, line);
    Q_debugbreak_exit_sub_2624C();
  }
  JUMPOUT(0x26195);
}
// 2619A: control flows out of bounds to 26195

//----- (000261A8) --------------------------------------------------------
void __fastcall Q_AssertLogBreakExit_sub_261A8(int ignore, const char *sourcefile, int line)
{
  if ( !ignore )
  {
    sprintf("Thank you for playing Ascendancy.", "Assert Failed: <%s> Line %d\n\n", sourcefile, line);
    Q_debugbreak_exit_sub_2624C();
  }
  JUMPOUT(0x26195);
}
// 261AA: control flows out of bounds to 26195

//----- (000261B8) --------------------------------------------------------
void __fastcall Q_PrintFailAndExit_sub_261B8(int ignore, const char *sourceFile, int line)
{
  char v3[256]; // [esp+0h] [ebp-100h] BYREF

  if ( !ignore )
  {
    strcpy(v3, "Thank you for playing Ascendancy.");
    sprintf("Thank you for playing Ascendancy.", "Assert Failed: <%s> Line %d\n\n%s\n", sourceFile, line, v3);
    Q_debugbreak_exit_sub_2624C();
  }
}

//----- (0002620C) --------------------------------------------------------
int sub_2620C(char *format, ...)
{
  char *v2; // [esp+0h] [ebp-4h] BYREF
  va_list a2; // [esp+14h] [ebp+10h] BYREF

  va_start(a2, format);
  va_copy((va_list)v2, a2);
  return vsprintf("Thank you for playing Ascendancy.", format, &v2);
}

//----- (0002624C) --------------------------------------------------------
void __noreturn Q_debugbreak_exit_sub_2624C()
{
  Q_debugbreak_sub_26194();
  exit(1);
}

//----- (0002625C) --------------------------------------------------------
void __fastcall __spoils<edx,ebx> Q_RegisterData_sub_2625C(void *aData, int a2, char *name)
{
  if ( aData )
  {
    Q_WinMgr_AddWinData_sub_5A094(&WinMgr, aData, a2, name);
  }
}

//----- (0002627C) --------------------------------------------------------
void __fastcall Q_RemoveWinDataFromWinMgr_sub_2627C(void *pdata)
{
  Q_WinMgr_RemoveWinData_sub_5A144(&WinMgr, pdata);
}

//----- (0002628C) --------------------------------------------------------
void *__fastcall Q_Allocate_sub_2628C(size_t a1, int a2, char *a3)
{
  void *result; // eax
  void *v4; // esi

  result = malloc(a1);
  v4 = result;
  if ( result )
  {
    Q_WinMgr_AddWinData_sub_5A094(&WinMgr, result, a2, a3);
    return v4;
  }
  return result;
}

//----- (000262B0) --------------------------------------------------------
void *__fastcall sub_262B0(size_t num, size_t size, int a3, char *name)
{
  void *result; // eax
  void *v5; // esi

  result = calloc(num, size);
  v5 = result;
  if ( result )
  {
    Q_WinMgr_AddWinData_sub_5A094(&WinMgr, result, a3, name);
    return v5;
  }
  return result;
}

//----- (000262CC) --------------------------------------------------------
void __fastcall sub_262CC(void *ptr)
{
  Q_WinMgr_RemoveWinData_sub_5A144(&WinMgr, ptr);
  free(ptr);
}

//----- (000262F0) --------------------------------------------------------
void sub_262F0()
{
  _wcpp_2_mod_register_(&dword_96768);
  sub_26314();
  dword_96770 = 1;
}
// 96768: using guessed type _DWORD dword_96768;
// 96770: using guessed type int dword_96770;

//----- (00026314) --------------------------------------------------------
void sub_26314()
{
  ;
}

//----- (0002631C) --------------------------------------------------------
void sub_2631C()
{
  Q_StopMouse_sub_2632C();
}

//----- (0002632C) --------------------------------------------------------
void Q_StopMouse_sub_2632C()
{
  if ( V_Mouse.initialized )
  {
    MOUSE_shutdown();
  }
  else
  {
    Q_Null_sub_26328();
  }
}

//----- (0002633C) --------------------------------------------------------
int Q_StartMouse_sub_2633C()
{
  V_Mouse.initialized = MOUSE_init(640, 480);
  return (V_Mouse.initialized == 0) - 1;
}

//----- (00026360) --------------------------------------------------------
void __fastcall Q_ProcessKeyboard_sub_26360()
{
  WORD v0; // ax
  bool v1; // zf
  int v2; // eax

  HIBYTE(v0) = 2;
  __asm { int     16h; KEYBOARD - GET SHIFT STATUS }
  V_Keyboard.Flags = v0;
  if ( (v0 & 1) != 0 || (v0 & 2) != 0 )
  {
    V_Keyboard.Shift = 0xFFFFFFFF;
  }
  else
  {
    V_Keyboard.Shift = 0;
  }
  V_Keyboard.Ctrl = ((v0 & 4) == 0) - 1;
  V_Keyboard.Alt = ((v0 & 8) == 0) - 1;
  V_Keyboard.ScrollLock = ((v0 & 0x10) == 0) - 1;
  V_Keyboard.NumLock = ((v0 & 0x20) == 0) - 1;
  V_Keyboard.CapsLock = ((v0 & 0x40) == 0) - 1;
  v2 = ((v0 & 0x80) == 0) - 1;
  v1 = v2 == 0;
  V_Keyboard.Insert = v2;
  BYTE1(v2) = 1;
  __asm { int     16h; KEYBOARD - CHECK BUFFER, DO NOT CLEAR }
  if ( v1 )
  {
    LOWORD(v2) = 0;
  }
  if ( (_WORD)v2 )
  {
    __asm { int     16h; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY }
    V_Keyboard.ASCIIChar = (unsigned __int8)v2;
    V_Keyboard.Pressed = TRUE;
    V_Keyboard.ScanCode = 0;
  }
  else
  {
    V_Keyboard.Pressed = 0;
  }
}
// 2637B: variable 'v0' is possibly undefined

//----- (000264B4) --------------------------------------------------------
void __fastcall Q_ProcessMouse_sub_264B4()
{
  LONG mx; // [esp+0h] [ebp-2Ch] BYREF
  LONG my; // [esp+4h] [ebp-28h] BYREF
  LONG ml; // [esp+8h] [ebp-24h] BYREF
  LONG mr; // [esp+Ch] [ebp-20h] BYREF
  LONG mc; // [esp+10h] [ebp-1Ch] BYREF

  MOUSE_status(&mx, &my, &ml, &mr, &mc);
  if ( mx == V_Mouse.x && my == V_Mouse.y )
  {
    V_Mouse.moved = 0;
  }
  else
  {
    V_Mouse.x = mx;
    V_Mouse.moved = TRUE;
    V_Mouse.y = my;
  }
  if ( ml == V_Mouse.left )
  {
    V_Mouse.leftClicked = 0;
  }
  else
  {
    V_Mouse.left = ml;
    V_Mouse.leftClicked = TRUE;
  }
  if ( mr == V_Mouse.right )
  {
    V_Mouse.rightClicked = 0;
  }
  else
  {
    V_Mouse.right = mr;
    V_Mouse.rightClicked = TRUE;
  }
}

//----- (0002656C) --------------------------------------------------------
int __fastcall Q_ProcessInput_sub_2656C()
{
  V_Mouse.leftClicked = 0;
  V_Mouse.rightClicked = 0;
  V_Mouse.moved = 0;
  V_Keyboard.Pressed = 0;
  Q_ProcessKeyboard_sub_26360();
  if ( V_Mouse.initialized )
  {
    Q_ProcessMouse_sub_264B4();
  }
  return Q_GameLoop_dword_96774;
}
// 96774: using guessed type int Q_GameLoop_dword_96774;

//----- (000265A8) --------------------------------------------------------
void __fastcall sub_265A8(int a1)
{
  unsigned __int16 v1; // dx
  LONG v2; // edx
  LONG v3; // eax
  __int16 v4; // dx
  WORD v5; // dx

  V_Mouse.moved = 0;
  V_Mouse.leftClicked = 0;
  V_Mouse.rightClicked = 0;
  V_Keyboard.Pressed = 0;
  v1 = *(_WORD *)(a1 + 8);
  if ( v1 < 2u )
  {
    if ( v1 == 1 )
    {
      v2 = *(_DWORD *)(a1 + 0xC);
      v3 = *(_DWORD *)(a1 + 0x10);
      V_Mouse.x = v2;
      V_Mouse.y = v3;
      MOUSE_force_move(v2, v3);
      V_Mouse.moved = 0xFFFFFFFF;
    }
  }
  else if ( v1 <= 2u )
  {
    if ( *(_DWORD *)(a1 + 0xC) )
    {
      V_Mouse.right = *(_DWORD *)(a1 + 0x10);
      V_Mouse.rightClicked = 0xFFFFFFFF;
    }
    else
    {
      V_Mouse.left = *(_DWORD *)(a1 + 0x10);
      v4 = *(_WORD *)(a1 + 0xA);
      V_Mouse.leftClicked = 0xFFFFFFFF;
      if ( v4 && V_Mouse.left )
      {
        V_Keyboard.Shift = 0xFFFFFFFF;
      }
      else
      {
        V_Keyboard.Shift = 0;
      }
    }
  }
  else if ( v1 == 3 )
  {
    V_Keyboard.Flags = *(_WORD *)(a1 + 0xA);
    v5 = *(_WORD *)(a1 + 0xC);
    V_Keyboard.ASCIIChar = *(_WORD *)(a1 + 0x10);
    V_Keyboard.ScanCode = v5;
    V_Keyboard.Pressed = 0xFFFFFFFF;
    if ( (V_Keyboard.Flags & 1) != 0 || (V_Keyboard.Flags & 2) != 0 )
    {
      V_Keyboard.Shift = 0xFFFFFFFF;
    }
    else
    {
      V_Keyboard.Shift = 0;
    }
    V_Keyboard.Ctrl = ((V_Keyboard.Flags & 4) == 0) - 1;
    V_Keyboard.Alt = ((V_Keyboard.Flags & 8) == 0) - 1;
    V_Keyboard.ScrollLock = ((V_Keyboard.Flags & 0x10) == 0) - 1;
    V_Keyboard.NumLock = ((V_Keyboard.Flags & 0x20) == 0) - 1;
    V_Keyboard.CapsLock = ((V_Keyboard.Flags & 0x40) == 0) - 1;
    if ( (V_Keyboard.Flags & 0x80) != 0 )
    {
      V_Keyboard.Insert = 0xFFFFFFFF;
    }
    else
    {
      V_Keyboard.Insert = 0;
    }
  }
}

//----- (000267A0) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd23EWCtor_sub_267A0(P_Wnd23EW a1)
{
  Q_A2_sub_2FC50(&a1->a2);
  a1->a2.pProcs = &Wnd23EW_Procs;
  Q_WndEW_sub_26800(a1);
}

//----- (000267BC) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd23EWDtor_sub_267BC(P_Wnd23EW a1, char a2)
{
  char *v2; // eax
  T_WndA2 *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v2 = _wcpp_2_dtor_array_store_(a1, &C_Wnd23EW);
    operator delete[](v2);
  }
  else
  {
    a1->a2.pProcs = &Wnd23EW_Procs;
    v3 = sub_2FC68(&a1->a2, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(v3);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00026800) --------------------------------------------------------
void __fastcall __spoils<> Q_WndEW_sub_26800(P_Wnd23EW result)
{
  result->pGameEvent = 0;
}

//----- (00026874) --------------------------------------------------------
void __fastcall sub_26874(P_Wnd23EW a1, P_GameEvent pGameEvent)
{
  P_GameEvent pGameEvent_; // ebx
  int p1; // edx
  int p2; // esi
  WORD eventId; // kr00_2
  char *v7; // eax
  char *v8; // eax
  unsigned __int8 v9; // bl
  P_GameEvent v10; // ebx
  _WORD *v11; // edx
  int v12; // ebx
  char *v13; // esi
  char *v14; // ebx
  P_GameEvent v15; // eax
  int v16; // esi
  int v17; // edx
  int v18; // eax
  int v19; // eax
  char *v20; // eax
  char *v21; // edx
  P_GameEvent v22; // edi
  int v23; // esi
  int v24; // edi
  int v25; // esi
  _DWORD *v26; // edi
  int v27; // eax
  char *v28; // edx
  __int16 v29; // bx
  char *v30; // eax
  char *v31; // edx
  __int16 v32; // ax
  P_GameEvent v33; // eax
  int v34; // edx
  int v35; // eax
  char *v36; // ebx
  UBYTE v37; // al
  int v38; // ecx
  __int16 ItemIndex_sub_1B270; // ax
  char *v40; // edx
  char *v41; // edx
  char *v42; // edx
  UBYTE v43; // al
  int v44; // [esp-8h] [ebp-298h]
  char *sub_1CEA8; // [esp-4h] [ebp-294h]
  char format[600]; // [esp+0h] [ebp-290h] BYREF
  char s[32]; // [esp+258h] [ebp-38h] BYREF
  int v48; // [esp+27Ch] [ebp-14h]
  char *Unknown_C95; // [esp+280h] [ebp-10h]
  int v50; // [esp+284h] [ebp-Ch]
  int v51; // [esp+288h] [ebp-8h]
  char *Unknown_CB0; // [esp+28Ch] [ebp-4h]

  if ( !pGameEvent )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x48);
  }
  a1->pGameEvent = pGameEvent;
  sprintf(s, "event%02d", pGameEvent->eventId);
  Q_ShowHelpTopic_sub_2FCB0((P_Wnd20HW)a1, "help.txt", s);
  Unknown_C95 = a1->Unknown_C95;
  Unknown_CB0 = a1->Unknown_CB0;
  if ( a1->Unknown_C95[0] != 1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x55);
  }
  if ( *(int *)a1->Unknown_DA3 > 1 && *Unknown_CB0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x57);
  }
  strcpy(format, *(const char **)(Unknown_C95 + 5));
  pGameEvent_ = a1->pGameEvent;
  p1 = pGameEvent_->p1;
  p2 = pGameEvent_->p2;
  eventId = pGameEvent_->eventId;
  v51 = p1 + 0x24;
  v50 = p2 + 0x24;
  v48 = 5 * p1;
  switch ( eventId )
  {
    case ASCEND_EP_00_NEW_DISCOVERY:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex], &V_Research.techs[p1]);
      v7 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = 0x1F;
      *(_WORD *)(v7 + 3) = p1;
      break;
    case ASCEND_EP_01_CONSTRUCTION_COMPLETE:
      v9 = pGameEvent_->p2;
      sprintf(
        *(char **)(Unknown_C95 + 5),
        format,
        V_PlanetItems.item[v9].name,
        v51,
        v51,
        *(unsigned __int16 *)(p1 + 0x42) - *(unsigned __int16 *)(p1 + 0x4C));
      *(_WORD *)(Unknown_CB0 + 1) = 0x1E;
      *(_WORD *)(Unknown_CB0 + 3) = v9;
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = *(_WORD *)(p1 + 0x14) + 5 * *(_WORD *)(p1 + 0x16);
      break;
    case ASCEND_EP_02_WOULD_LIKE_TO_SPEAK:
      v29 = pGameEvent_->p1;
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[v29]._nameIndex]);
      v30 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 3) = 0;
      *(_WORD *)(v30 + 1) = v29;
      break;
    case ASCEND_EP_SHIPARRIVE:
    case ASCEND_EP_FINDRACE:
    case ASCEND_EP_HOSTILESHIP:
    case ASCEND_EP_HOSTILEPLAN:
    case ASCEND_EP_OTHERWAR:
    case ASCEND_EP_20_DISCOVERED_SYSTEM:
      v15 = a1->pGameEvent;
      v16 = v15->p1;
      if ( *(_BYTE *)(v16 + 0x58) != 4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xB3);
      }
      v17 = *(_DWORD *)(v16 + 0x59);
      if ( a1->pGameEvent->eventId == 0x14 )
      {
        if ( *(_WORD *)(v17 + 0x44) == 1 )
        {
          v18 = 0xD;                                   // 13: ""
        }
        else
        {
          v18 = 0xE;                                   // 14: "s"
        }
        sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v18);
        v44 = *(__int16 *)(v17 + 0x44);
        if ( *(_WORD *)(v17 + 0x5A) == 1 )
        {
          v19 = 0xD;                                   // 13: ""
        }
        else
        {
          v19 = 0xE;                                   // 14: "s"
        }
        v20 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v19);
        sprintf(*(char **)(Unknown_C95 + 5), format, v16 + 0x34, v17 + 0x1C, *(__int16 *)(v17 + 0x5A), v20, v44, sub_1CEA8);
      }
      else
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, v16 + 0x34, v17 + 0x1C, V_SpecNames[V_Game.races[v15->p2]._nameIndex]);
      }
      v21 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v21 + 3) = *(char *)(v16 + 0xAA);
      break;
    case ASCEND_EP_RACEFINDUS:
    case ASCEND_EP_BADSHIPENTERS:
      v22 = a1->pGameEvent;
      v23 = v22->p1;
      v24 = v22->p2;
      if ( *(_BYTE *)(v23 + 0x58) != 4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xCD);
      }
      if ( a1->pGameEvent->eventId == 9 )
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[v24]._nameIndex], *(_DWORD *)(v23 + 0x59) + 0x1C);
      }
      else
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, *(_DWORD *)(v23 + 0x59) + 0x1C);
      }
      *(_WORD *)(Unknown_CB0 + 1) = v24 + 0xE;
      *(_WORD *)(Unknown_CB0 + 3) = *(char *)(v23 + 0xAA);
      break;
    case ASCEND_EP_SPECIESEXTINCT:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[p1]._nameIndex]);
      v31 = Unknown_CB0;
      v32 = a1->pGameEvent->p1;
      *(_WORD *)(Unknown_CB0 + 3) = 0;
      *(_WORD *)(v31 + 1) = v32;
      break;
    case ASCEND_EP_SCRAPNEWESTSHIP:
    case ASCEND_EP_SHIPDESTROYED:
      v33 = a1->pGameEvent;
      v34 = v33->p1;
      v35 = v33->p2;
      if ( v35 )
      {
        sprintf(*(char **)(Unknown_C95 + 5), format, v35 + 0x1C);
      }
      v36 = Unknown_CB0;
      v37 = V_PlayerRaceIndex;
      *(_WORD *)(Unknown_CB0 + 3) = v34;
      *(_WORD *)(v36 + 1) = v37 + 0xE;
      break;
    case ASCEND_EP_COLONYINVADED:
      v38 = p1;
      if ( !p1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x114);
      }
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x24, V_SpecNames[V_Game.races[*(unsigned __int8 *)(p1 + 0x57)]._nameIndex]);
      ItemIndex_sub_1B270 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "data\\planets.shp", 0);
      v40 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = ItemIndex_sub_1B270;
      if ( *(unsigned __int16 *)(v40 + 1) == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x118);
      }
      *(_WORD *)(Unknown_CB0 + 3) = 5 * *(_WORD *)(v38 + 0x16) + *(_WORD *)(v38 + 0x14);
      break;
    case ASCEND_EP_15_HAS_FREE_POPULATION:
      sprintf(*(char **)(Unknown_C95 + 5), format, v51);
      *(_WORD *)(Unknown_CB0 + 1) = 0x1D;
      *(_WORD *)(Unknown_CB0 + 3) = 5 * *(_WORD *)(p1 + 0x16) + *(_WORD *)(p1 + 0x14);
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x2C;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = 2;
      break;
    case ASCEND_EP_16_ENTERED_ORBIT:
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x34, v50);
      v14 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v14 + 3) = *(char *)(p1 + 0xAA);
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = *(_WORD *)(p2 + 0x14) + 5 * *(_WORD *)(p2 + 0x16);
      break;
    case ASCEND_EP_17_SHIP_COMPLETE:
    case ASCEND_EP_18_REFIT_COMPLETE:
      v10 = a1->pGameEvent;
      v11 = (_WORD *)v10->p2;
      v12 = v10->p1;
      sprintf(
        *(char **)(Unknown_C95 + 5),
        format,
        v12 + 0x34,
        v11 + 0x12,
        v11 + 0x12,
        (unsigned __int16)v11[0x21] - (unsigned __int16)v11[0x26]);
      v13 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v13 + 3) = *(char *)(v12 + 0xAA);
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = v11[0xA] + 5 * v11[0xB];
      break;
    case ASCEND_EP_19_REMAINING_MOVES:
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x1C);
      break;
    case ASCEND_EP_21_ALL_TECH_FOR_SHIP:
      v41 = Unknown_CB0;
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex]);
      *(_WORD *)(v41 + 3) = 0;
      *(_WORD *)(v41 + 1) = V_PlayerRaceIndex;
      break;
    case ASCEND_EP_22_XENO_COMPLETE:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex], v50, &V_Research.techs[p1]);
      v8 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = 0x1F;
      *(_WORD *)(v8 + 3) = p1;
      *(_WORD *)&a1->Unknown_CB0[0x1C] = 0x1D;
      *(_WORD *)&a1->Unknown_CB0[0x1E] = *(_WORD *)(p2 + 0x14) + 5 * *(_WORD *)(p2 + 0x16);
      break;
    case ASCEND_EP_23_LANE_TRANSMISION:
      v25 = p1;
      if ( *(_BYTE *)(p1 + 0x58) != 5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xE0);
      }
      v26 = *(_DWORD **)(p1 + 0x59);
      if ( !v26 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0xE3);
      }
      v27 = *v26;
      if ( ((1 << V_PlayerRaceIndex) & *(unsigned __int8 *)(*v26 + 0x17)) == 0 )
      {
        v27 = v26[1];
      }
      sprintf(*(char **)(Unknown_C95 + 5), format, p1 + 0x34, v27 + 0x1C);
      v28 = Unknown_CB0;
      *(_WORD *)(Unknown_CB0 + 1) = V_PlayerRaceIndex + 0xE;
      *(_WORD *)(v28 + 3) = *(char *)(v25 + 0xAA);
      break;
    case ASCEND_EP_25_FIRST_LAB:
      sprintf(*(char **)(Unknown_C95 + 5), format, V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex]);
      v42 = Unknown_CB0;
      v43 = V_PlayerRaceIndex;
      *(_WORD *)(Unknown_CB0 + 3) = 0;
      *(_WORD *)(v42 + 1) = v43;
      break;
    default:
      return;
  }
}
// 26D02: conditional instruction was optimized away because bh.1!=4
// 26874: using guessed type char format[600];

//----- (000270F4) --------------------------------------------------------
unsigned int __fastcall sub_270F4(int a1, __int16 a2, LONG a3, LONG a4)
{
  int v5; // ebx

  if ( !a2 || (unsigned __int16)a2 > 1u )
  {
    return sub_2FD68(a1, a2, a3, a4);
  }
  *(_DWORD *)(a1 + 0x35) = 0xFFFFFFFF;
  v5 = *(_DWORD *)(a1 + 0xA7);
  *(_DWORD *)(a1 + 0x39) = 0xFFFFFFFF;
  (*(void (**)(void))(v5 + 0xC))();
  return 0;
}

//----- (0002712C) --------------------------------------------------------
void __fastcall __spoils<> Q_A2_sub_2712C(T_WndA2 *a1)
{
  Q_A2Ctor_sub_2C830(a1);
  a1->pProcs = (P_Procs)&off_95C58;
}
// 95C58: using guessed type int (__fastcall *off_95C58)(P_WndA2 a1);

//----- (0002713C) --------------------------------------------------------
T_WndA2 *__fastcall sub_2713C(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95C18);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95C58;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95C58: using guessed type int (__fastcall *off_95C58)(P_WndA2 a1);

//----- (00027184) --------------------------------------------------------
unsigned int __fastcall sub_27184(T_WndA2 *a1, __int16 a2, LONG a3, LONG a4)
{
  if ( !a2 )
  {
    return Q_WndA2_Proc3_sub_2F424(a1, a2, a3, a4);
  }
  if ( (unsigned __int16)a2 <= 1u )
  {
    sub_4F8CC(&V_SoundSystem, V_Game.races[V_PlayerRaceIndex]._nameIndex + 8, 0);
    return Q_WndA2_Proc3_sub_2F424(a1, a2, a3, a4);
  }
  if ( a2 != 2 )
  {
    return Q_WndA2_Proc3_sub_2F424(a1, a2, a3, a4);
  }
  Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 1, 1);
  return 0xFFFFFFFF;
}

//----- (000271FC) --------------------------------------------------------
__int64 __fastcall sub_271FC(int a1)
{
  int nameIndex; // ecx
  FILE *v2; // ebp
  char v3; // ah
  char *v5; // kr0C_4
  char v6; // al
  void *ShapeTable_sub_1B084; // eax
  UBYTE Unknown_02; // al
  const char *v10; // ecx
  int v11; // esi
  int v13; // esi
  int v14; // esi
  WORD v15; // [esp-Ch] [ebp-630h]
  char v16[1004]; // [esp+0h] [ebp-624h] BYREF
  char s[204]; // [esp+3ECh] [ebp-238h] BYREF
  char v18[204]; // [esp+4B8h] [ebp-16Ch] BYREF
  char s1[60]; // [esp+584h] [ebp-A0h] BYREF
  PANE v20; // [esp+5C0h] [ebp-64h] BYREF
  int v21; // [esp+5D4h] [ebp-50h]
  char *v22; // [esp+5D8h] [ebp-4Ch]
  int v23; // [esp+5DCh] [ebp-48h]
  int v24; // [esp+5E0h] [ebp-44h] BYREF
  int v25; // [esp+5E4h] [ebp-40h]
  int v26; // [esp+5E8h] [ebp-3Ch]
  int v27; // [esp+5ECh] [ebp-38h]
  int v28; // [esp+5F0h] [ebp-34h]
  int v29; // [esp+5F4h] [ebp-30h]
  int v30; // [esp+5F8h] [ebp-2Ch]
  int v31; // [esp+5FCh] [ebp-28h]
  int v32; // [esp+600h] [ebp-24h]
  char *v33; // [esp+604h] [ebp-20h]
  int v34; // [esp+608h] [ebp-1Ch]
  int v35; // [esp+60Ch] [ebp-18h]

  v21 = a1;
  nameIndex = V_Game.races[V_PlayerRaceIndex]._nameIndex;
  v33 = (char *)V_BigBuffer;
  V_BigBuffer[0] = 0;
  v16[0] = 0;
  v2 = Q_OpenFile_sub_1BB10("history.txt", 0);
  if ( !v2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x1C1);
  }
  v26 = 0;
  do
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
    sscanf(s, "%s", s1);
    if ( !stricmp(s1, "SPECNUM") )
    {
      sscanf(s, "%s %d", s1, &v24);
      if ( nameIndex == v24 )
      {
        v26 = 1;
      }
    }
    else if ( !stricmp(s1, "END") )
    {
      sub_2620C("Species %d not found in history file.\n", nameIndex);
      Q_PrintFailAndExit_sub_261B8(0, "..\\eventwnd.cpp", 0x1E8);
    }
  }
  while ( !v26 );
  if ( v26 != 2 )
  {
    v23 = 0;
    v22 = V_SpecNames[nameIndex];
    do
    {
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
      sscanf(s, "%s", s1);
      if ( !stricmp(s1, "SPECNUM") || !stricmp(s1, "END") )
      {
        v26 = 2;
      }
      else if ( !stricmp(s1, "POWER") )
      {
        v28 = 0;
        v31 = 0;
        sprintf(v18, "%s: ", v22);
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
          if ( !strnicmp(s, "ENDPOWER", 8u) )
          {
            v28 = 0xFFFFFFFF;
          }
          else
          {
            v31 += strlen(s);
            if ( v31 >= 0xC4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x238);
            }
            strcat(v18, s);
          }
        }
        while ( !v28 );
      }
      else if ( !stricmp(s1, "INTRO") )
      {
        v34 = 0;
        v30 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
          if ( !strnicmp(s, "ENDINTRO", 8u) )
          {
            v34 = 0xFFFFFFFF;
            v23 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x24D);
            }
            strcat(v16, s);
          }
        }
        while ( !v34 );
      }
      else if ( !stricmp(s1, "PEACE") && v23 == 0xFFFFFFFF && !V_Game.atmosphere )
      {
        v25 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
          if ( !strnicmp(s, "ENDPEACE", 8u) )
          {
            v25 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x25F);
            }
            strcat(v16, s);
          }
        }
        while ( !v25 );
      }
      else if ( !stricmp(s1, "NEUTRAL") && v23 == 0xFFFFFFFF && V_Game.atmosphere == 1 )
      {
        v32 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
          if ( !strnicmp(s, "ENDNEUTRAL", 0xAu) )
          {
            v32 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x271);
            }
            strcat(v16, s);
          }
        }
        while ( !v32 );
      }
      else if ( !stricmp(s1, "HOSTILE") && v23 == 0xFFFFFFFF && V_Game.atmosphere == 2 )
      {
        v27 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
          if ( !strnicmp(s, "ENDHOSTILE", 0xAu) )
          {
            v27 = 0xFFFFFFFF;
          }
          else
          {
            v30 += strlen(s);
            if ( v30 >= 0x3E4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x283);
            }
            strcat(v16, s);
          }
        }
        while ( !v27 );
      }
      else if ( !stricmp(s1, "TEXT") )
      {
        v35 = 0;
        v29 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, s);
          if ( !strnicmp(s, "ENDTEXT", 7u) )
          {
            v35 = 0xFFFFFFFF;
          }
          else
          {
            v29 += strlen(s);
            if ( v29 >= 0xBB4 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x295);
            }
            strcat(v33, s);
          }
        }
        while ( !v35 );
      }
    }
    while ( v26 != 2 );
  }
  fclose(v2);
  v13 = 0;
  if ( v16[0] )
  {
    while ( 1 )
    {
      if ( v13 >= 0x3E5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x2AB);
      }
      v3 = v16[v13];
      if ( v3 == 0xA )
      {
        break;
      }
      if ( v3 == 0x40 )
      {
        v16[v13] = 0xA;
      }
      else if ( v3 == 0x5F )
      {
        break;
      }
LABEL_83:
      if ( !v16[++v13] )
      {
        goto LABEL_84;
      }
    }
    v16[v13] = 0x20;
    goto LABEL_83;
  }
LABEL_84:
  if ( !v33 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x2B7);
  }
  v5 = v33;
  v14 = 0;
  if ( *v33 )
  {
    while ( 1 )
    {
      if ( v14 >= 0xBB5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x2BD);
      }
      v6 = v5[v14];
      if ( v6 == 0xA )
      {
        break;
      }
      if ( v6 == 0x40 )
      {
        v5[v14] = 0xA;
      }
      else if ( v6 == 0x5F )
      {
        break;
      }
LABEL_94:
      if ( !v5[++v14] )
      {
        goto LABEL_95;
      }
    }
    v5[v14] = 0x20;
    goto LABEL_94;
  }
LABEL_95:
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 7]);
  VFX_shape_draw(&V_Type6_stru_D8654.pane, ShapeTable_sub_1B084, 0, 7, 0x2E);
  v20.window = *(WINDOW **)(v21 + 4);
  v20.x1 = 0x278;
  v20.x0 = 7;
  v20.y0 = 0x105;
  v20.y1 = 0x1D1;
  Unknown_02 = V_Game.races[V_PlayerRaceIndex].Unknown_02;
  v10 = v33;
  WinMgr.LargeFont.pane.window = v20.window;
  WinMgr.LargeFont.pane.x0 = 7;
  WinMgr.LargeFont.pane.y0 = v20.y0;
  WinMgr.LargeFont.pane.x1 = v20.x1;
  WinMgr.LargeFont.pane.y1 = v20.y1;
  v11 = v21;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0xA, v10, 0, 4 * Unknown_02 + 0x13, 0xFF, 0x257);
  v20.window = *(WINDOW **)(v11 + 4);
  v20.x1 = 0x278;
  v20.y1 = 0xF5;
  v20.x0 = 0x138;
  v20.y0 = 0x2E;
  WinMgr.LargeFont.pane.window = v20.window;
  WinMgr.LargeFont.pane.x0 = 0x138;
  WinMgr.LargeFont.pane.y0 = v20.y0;
  WinMgr.LargeFont.pane.x1 = v20.x1;
  WinMgr.LargeFont.pane.y1 = v20.y1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0xA, v16, 0, 0xF3, 0xFF, 0x126);
  v20.window = *(WINDOW **)(v21 + 4);
  v20.x0 = 7;
  v20.y0 = 7;
  v20.x1 = 0x278;
  v20.y1 = 0x25;
  Q_WINMGR_CPP_sub_53E38(&v20, 3, 3, V_PlayerRaceIndex);
  v15 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  WinMgr.LargeFont.pane = v20;
  return (unsigned int)Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xA, v18, 2, v15, 0xFF, 0x25A);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 271FC: using guessed type char var_624[1004];
// 271FC: using guessed type char s[204];
// 271FC: using guessed type char var_16C[204];

//----- (00027BF8) --------------------------------------------------------
void __fastcall __spoils<> Q_A2_sub_27BF8(P_WndA2 a1)
{
  Q_A2Ctor_sub_2C830(a1);
  a1->pProcs = (P_Procs)&off_95C40;
}
// 95C40: using guessed type int (__fastcall *off_95C40)(P_WndA2 a1);

//----- (00027C08) --------------------------------------------------------
T_WndA2 *__fastcall sub_27C08(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95C04);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95C40;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95C40: using guessed type int (__fastcall *off_95C40)(P_WndA2 a1);

//----- (00027C50) --------------------------------------------------------
int __fastcall sub_27C50(T_WndA2 *a1, __int16 a2, LONG a3, LONG a4)
{
  __int16 v5; // ax
  char v7[2]; // [esp+0h] [ebp-10h] BYREF
  __int16 v8[7]; // [esp+2h] [ebp-Eh]

  v8[1] = a2;
  if ( a2 != 1 )
  {
    return Q_WndA2_Proc3_sub_2F424(a1, v8[1], a3, a4);
  }
  LOBYTE(v8[0]) = 0;
  v7[1] = 0;
  v7[0] = 0;
  sub_2C2F8(&V_Type6_stru_D8654, v7);
  v5 = 5;
  dword_132B64 = 0;
  dword_132B60 = 0xFFFFFFFF;
  if ( V_Game.z7 == 1 )
  {
    v5 = V_Game.races[V_PlayerRaceIndex]._nameIndex + 8;
  }
  sub_4F8CC(&V_SoundSystem, v5, 0);
  return Q_WndA2_Proc3_sub_2F424(a1, v8[1], a3, a4);
}
// 132B60: using guessed type int dword_132B60;
// 132B64: using guessed type int dword_132B64;

//----- (00027D18) --------------------------------------------------------
void __fastcall sub_27D18(int a1, int a2, int a3, int a4)
{
  LONG v4; // eax
  FILE *v5; // ebp
  LONG v6; // ebx
  LONG v7; // ecx
  char v8; // bh
  char v10; // bl
  int v12; // kr18_4
  char v13; // dh
  void *ShapeTable_sub_1B084; // eax
  UBYTE Unknown_02; // al
  int v17; // ebp
  char *sub_1CEA8; // eax
  const char *v19; // ecx
  void *v20; // eax
  LONG v21; // edi
  LONG v22; // esi
  LONG v23; // ebx
  void *v24; // eax
  int racesNum; // eax
  void *v26; // eax
  __int16 v27; // bp
  void *v28; // eax
  BYTE v29; // dl
  int v30; // esi
  int Ships_sub_40224; // eax
  unsigned int v32; // ebp
  int shipsNum; // eax
  int raceIndex; // eax
  LONG v35; // ebx
  int v36; // ecx
  LONG v37; // ecx
  void *v38; // eax
  int v39; // esi
  int PlanetsNum_sub_402E0; // eax
  unsigned int v41; // ebp
  UBYTE v42; // al
  LONG v43; // ebx
  int v44; // ecx
  int v45; // eax
  LONG y0; // edx
  int v47; // ecx
  void *v48; // eax
  LONG v49; // ebp
  LONG v50; // esi
  void *v51; // eax
  int i; // kr24_4
  LONG hullSize; // [esp-20h] [ebp-378h]
  LONG v54; // [esp-20h] [ebp-378h]
  LONG v55; // [esp-20h] [ebp-378h]
  LONG v56; // [esp-1Ch] [ebp-374h]
  LONG v57; // [esp-18h] [ebp-370h]
  LONG v58; // [esp-18h] [ebp-370h]
  LONG v59; // [esp-Ch] [ebp-364h]
  WORD v60; // [esp-Ch] [ebp-364h]
  WORD v61; // [esp-Ch] [ebp-364h]
  WORD v62; // [esp-4h] [ebp-35Ch]
  char v63[204]; // [esp+0h] [ebp-358h] BYREF
  char v64[204]; // [esp+CCh] [ebp-28Ch] BYREF
  char v65[204]; // [esp+198h] [ebp-1C0h] BYREF
  char s1[60]; // [esp+264h] [ebp-F4h] BYREF
  PANE pane; // [esp+2A0h] [ebp-B8h] BYREF
  char filename[16]; // [esp+2B4h] [ebp-A4h] BYREF
  T_Ship *v69; // [esp+2C4h] [ebp-94h]
  int v70; // [esp+2C8h] [ebp-90h]
  int aa2; // [esp+2CCh] [ebp-8Ch]
  LONG shape_number; // [esp+2D0h] [ebp-88h]
  int assert; // [esp+2D4h] [ebp-84h]
  int v74; // [esp+2D8h] [ebp-80h]
  int v75; // [esp+2DCh] [ebp-7Ch]
  LONG j; // [esp+2E0h] [ebp-78h]
  int v77; // [esp+2E4h] [ebp-74h]
  int v78; // [esp+2E8h] [ebp-70h]
  int v79; // [esp+2ECh] [ebp-6Ch]
  int v80; // [esp+2F0h] [ebp-68h]
  int v81; // [esp+2F4h] [ebp-64h]
  int v82; // [esp+2F8h] [ebp-60h]
  int v83; // [esp+2FCh] [ebp-5Ch]
  int v84; // [esp+300h] [ebp-58h]
  int v85; // [esp+304h] [ebp-54h]
  int v86; // [esp+308h] [ebp-50h]
  int v87; // [esp+30Ch] [ebp-4Ch]
  int v88; // [esp+310h] [ebp-48h]
  T_Planet *v89; // [esp+314h] [ebp-44h]
  int v90; // [esp+318h] [ebp-40h]
  int v91; // [esp+31Ch] [ebp-3Ch]
  PANE *v92; // [esp+320h] [ebp-38h]
  int v93; // [esp+324h] [ebp-34h]
  int v94; // [esp+328h] [ebp-30h]
  LONG hotX; // [esp+32Ch] [ebp-2Ch]
  int v96; // [esp+330h] [ebp-28h]
  int v97; // [esp+334h] [ebp-24h]
  int v98; // [esp+338h] [ebp-20h]
  int v99; // [esp+33Ch] [ebp-1Ch]
  int v100; // [esp+340h] [ebp-18h]

  v70 = a1;
  aa2 = V_Game.aa2;
  v4 = V_Game.aa2 / 0xA - 1;
  shape_number = v4;
  if ( v4 >= 0 )
  {
    if ( v4 > 9 )
    {
      shape_number = 9;
    }
  }
  else
  {
    shape_number = 0;
  }
  V_BigBuffer[0] = 0;
  assert = (int)V_BigBuffer;
  switch ( V_Game.z7 )
  {
    case 1:
      sprintf(filename, "end-xtnc.txt");
      break;
    case 2:
      sprintf(filename, "end-dest.txt");
      break;
    case 3:
      sprintf(filename, "end-capt.txt");
      break;
    case 4:
      sprintf(filename, "end-unit.txt");
      break;
    case 5:
      sprintf(filename, "end-ctrl.txt");
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\eventwnd.cpp", 0x34E);
      break;
  }
  v5 = Q_OpenFile_sub_1BB10(filename, 0);
  if ( !v5 )
  {
    sub_2620C("Couldn't open %s", filename);
    Q_PrintFailAndExit_sub_261B8(0, "..\\eventwnd.cpp", 0x370);
  }
  v63[0] = 0;
  v75 = 0;
  do
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v5, v65);
    sscanf(v65, "%s", s1);
    if ( !stricmp(s1, "END") )
    {
      v75 = 0xFFFFFFFF;
    }
    else if ( !stricmp(s1, "ENDDESC") )
    {
      v83 = 0;
      v84 = 0;
      do
      {
        Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v5, v65);
        if ( !strnicmp(v65, "ENDTEXT", 7u) )
        {
          v83 = 0xFFFFFFFF;
        }
        else
        {
          v84 += strlen(v65);
          if ( v84 >= 0xC4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3A1);
          }
          strcat(v63, v65);
        }
      }
      while ( !v83 );
    }
    else if ( !stricmp(s1, "CONGRAT") )
    {
      v85 = 0;
      v86 = 0;
      do
      {
        Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v5, v65);
        if ( !strnicmp(v65, "ENDTEXT", 7u) )
        {
          v85 = 0xFFFFFFFF;
        }
        else
        {
          v86 += strlen(v65);
          if ( v86 >= 0x3E4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3B3);
          }
          strcat((char *)assert, v65);
        }
      }
      while ( !v85 );
    }
    else if ( !stricmp(s1, "RANKS") )
    {
      v6 = 0;
      if ( shape_number > 0 )
      {
        v7 = shape_number;
        do
        {
          ++v6;
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v5, v65);
        }
        while ( v6 < v7 );
      }
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v5, v65);
      v64[0] = 0;
      strcat(v64, v65);
    }
  }
  while ( v75 != 0xFFFFFFFF );
  fclose(v5);
  j = 0;
  if ( v63[0] )
  {
    while ( 1 )
    {
      if ( j >= 0xC5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3D7);
      }
      v8 = v63[j];
      if ( v8 == 0xA )
      {
        break;
      }
      if ( v8 == 0x40 )
      {
        v63[j] = 0xA;
      }
      else if ( v8 == 0x5F )
      {
        break;
      }
LABEL_49:
      if ( !v63[++j] )
      {
        goto LABEL_50;
      }
    }
    v63[j] = 0x20;
    goto LABEL_49;
  }
LABEL_50:
  j = 0;
  if ( v64[0] )
  {
    while ( 1 )
    {
      if ( j >= 0xC5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3E9);
      }
      v10 = v64[j];
      if ( v10 == 0xA )
      {
        break;
      }
      if ( v10 == 0x40 )
      {
        v64[j] = 0xA;
      }
      else if ( v10 == 0x5F )
      {
        break;
      }
LABEL_58:
      if ( !v64[++j] )
      {
        goto LABEL_59;
      }
    }
    v64[j] = 0x20;
    goto LABEL_58;
  }
LABEL_59:
  if ( !assert )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3F5);
  }
  v12 = assert;
  j = 0;
  if ( *(_BYTE *)assert )
  {
    while ( 1 )
    {
      if ( j >= 0x3E5 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\eventwnd.cpp", 0x3FB);
      }
      v13 = *(_BYTE *)(v12 + j);
      if ( v13 == 0xA )
      {
        break;
      }
      if ( v13 == 0x40 )
      {
        *(_BYTE *)(v12 + j) = 0xA;
      }
      else if ( v13 == 0x5F )
      {
        break;
      }
LABEL_69:
      if ( !*(_BYTE *)(v12 + j++ + 1) )
      {
        goto LABEL_70;
      }
    }
    *(_BYTE *)(v12 + j) = 0x20;
    goto LABEL_69;
  }
LABEL_70:
  pane.window = *(WINDOW **)(v70 + 4);
  pane.x0 = 7;
  pane.y0 = 0xD7;
  pane.x1 = 0x12F;
  pane.y1 = 0x17D;
  if ( V_Game.z7 != 1 )
  {
    v59 = shape_number;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2B]);
    VFX_shape_draw(&pane, ShapeTable_sub_1B084, v59, 0x94, 0x53);
  }
  pane.x1 = 0x12F;
  pane.x0 = 7;
  pane.y0 = 0xD7;
  pane.y1 = 0x107;
  sprintf(v65, "%s", v63);
  Unknown_02 = V_Game.races[V_PlayerRaceIndex].Unknown_02;
  v17 = aa2;
  WinMgr.LargeFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xE, 0, v65, 1, 4 * Unknown_02 + 0x13, 0xFF, 0x118);
  pane.x1 = 0x12F;
  pane.y1 = 0x17D;
  pane.x0 = 7;
  pane.y0 = 0x14D;
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xF); // 15: "Your score is %d%%.\nThis gives you the title of %s"
  sprintf(v65, sub_1CEA8, v17, v64);
  v60 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  WinMgr.LargeFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, v65, 3, v60, 0xFF, 0x118);
  pane.x1 = 0x278;
  pane.x0 = 7;
  pane.y0 = 0x18D;
  pane.y1 = 0x1D1;
  v19 = (const char *)assert;
  v61 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  WinMgr.LargeFont.pane.window = pane.window;
  WinMgr.LargeFont.pane.x0 = 7;
  WinMgr.LargeFont.pane.y0 = pane.y0;
  WinMgr.LargeFont.pane.x1 = pane.x1;
  WinMgr.LargeFont.pane.y1 = pane.y1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 7, 0, v19, 1, v61, 0xFF, 0x25A);
  v20 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 7]);
  v21 = 0x2A;
  VFX_shape_draw(&V_Type6_stru_D8654.pane, v20, 0, 7, 7);
  j = 1;
  v93 = 2;
  v22 = 0x15B;
  Q_WINMGR_CPP_sub_53E38((PANE *)(v70 + 4), 0xA, 0xA, V_PlayerRaceIndex);
  for ( i = 0; ; ++i )
  {
    racesNum = V_Game.racesNum;
    if ( V_Game.racesNum <= i + 1 )
    {
      break;
    }
    if ( i == 3 )
    {
      v22 = 0x15B;
      v21 = 0x85;
    }
    v26 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[i + 1]);
    VFX_shape_transform(&V_Type6_stru_D8654.pane, v26, 0, v22, v21, V_BigBuffer, 0, 0x8000, 0x8000, 0);
    v27 = j;
    v62 = j;
    v28 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
    Q_DrawRaceTintedShape_sub_53EB8(&V_Type6_stru_D8654.pane, v28, 3, v22, v21, v62);
    Q_WINMGR_CPP_sub_53E38(&V_Type6_stru_D8654.pane, v22 - 7, v21 + 0x21, v27);
    v29 = V_Game.races[V_PlayerRaceIndex].treaties[i + 1];
    v23 = 0xFFFFFFFF;
    if ( v29 == 3 )
    {
      v23 = 9;
    }
    else if ( v29 == 2 )
    {
      v23 = 8;
    }
    if ( v23 != 0xFFFFFFFF )
    {
      v24 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
      VFX_shape_draw(&V_Type6_stru_D8654.pane, v24, v23, v22 - 7, v21 + 0x21);
    }
    v22 += 0x3E;
  }
  j = i + 1;
  v77 = 0x278;
  LOWORD(racesNum) = GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE];
  pane.x0 = 0x138;
  v99 = racesNum;
  pane.y0 = 7;
  pane.x1 = 0x278;
  pane.y1 = 0x17D;
  v30 = 7;
  Ships_sub_40224 = Q_Race_GetShips_sub_40224(&V_Game.races[V_PlayerRaceIndex], 0, 0);
  v78 = Ships_sub_40224;
  if ( Ships_sub_40224 < 0x14 )
  {
    v30 = 7 - 7 * (0x14 - Ships_sub_40224) / 0x11;
  }
  if ( v30 >= 0 )
  {
    if ( v30 > 6 )
    {
      v30 = 6;
    }
  }
  else
  {
    v30 = 0;
  }
  v79 = v78 / (v30 + 1);
  v80 = 0;
  v82 = 0x9F;
  v81 = v77 - 0x212;
  if ( v77 - 0x212 < 2 )
  {
    v81 = 2;
  }
  v74 = 0x208;
  v87 = 0x11;
  v32 = 0xFFFFFF00 * v30 + 0x700;
  j = 0;
  while ( 1 )
  {
    shipsNum = V_Game.shipsNum;
    if ( V_Game.shipsNum <= j )
    {
      break;
    }
    raceIndex = V_Game.ships[j].raceIndex;
    v69 = &V_Game.ships[j];
    if ( raceIndex == V_PlayerRaceIndex )
    {
      v35 = 0;
      if ( v80 > v79 && v30 > 0 )
      {
        v32 += 0x100;
        --v30;
      }
      if ( v30 > 0 )
      {
        VFX_shape_lookaside(&(*V_Type6_stru_D8654.hazeTables)[0][v32]);
        v35 = 1;
      }
      v36 = v74 - pane.x0;
      v37 = rand() % v81 + v36;
      hotX = v87 - pane.y0;
      v57 = hotX + rand() % v82;
      hullSize = v69->hullSize;
      v38 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v99);
      VFX_shape_transform(&pane, v38, hullSize, v37, v57, V_BigBuffer, 0, 0x5555, 0x5555, v35);
    }
    ++j;
    ++v80;
  }
  LOWORD(shipsNum) = GwshareShpCacheIndexes[0x1D];
  v100 = shipsNum;
  v96 = 0x1FF;
  v39 = 7;
  PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[V_PlayerRaceIndex]);
  if ( PlanetsNum_sub_402E0 < 0x14 )
  {
    v39 = 7 - 7 * (0x14 - PlanetsNum_sub_402E0) / 0x11;
  }
  if ( v39 >= 0 )
  {
    if ( v39 > 6 )
    {
      v39 = 6;
    }
  }
  else
  {
    v39 = 0;
  }
  v97 = v78 / (v39 + 1);
  v94 = v96 - 0x14C;
  v98 = 0;
  v88 = 0x97;
  if ( v96 - 0x14C < 2 )
  {
    v94 = 2;
  }
  v90 = 0x142;
  v91 = 0xDC;
  v41 = 0xFFFFFF00 * v39 + 0x700;
  j = 0;
  while ( V_Game.planetsNum > j )
  {
    v42 = V_Game.planets[j].raceIndex;
    v89 = &V_Game.planets[j];
    if ( v42 == V_PlayerRaceIndex )
    {
      v43 = 0;
      if ( v98 > v97 && v39 > 0 )
      {
        v41 += 0x100;
        --v39;
      }
      if ( v39 > 0 )
      {
        VFX_shape_lookaside(&(*V_Type6_stru_D8654.hazeTables)[0][v41]);
        v43 = 1;
      }
      v44 = v90 - pane.x0;
      v45 = rand();
      y0 = pane.y0;
      hotX = v45 % v94 + v44;
      v47 = v91;
      v58 = v47 - y0 + rand() % v88;
      v56 = hotX;
      v54 = 5 * v89->type + v89->size;
      v48 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v100);
      VFX_shape_transform(&pane, v48, v54, v56, v58, V_BigBuffer, 0, 0x5555, 0x5555, v43);
    }
    ++j;
    ++v98;
  }
  v49 = 0xCB;
  v50 = 0x213;
  v92 = (PANE *)(v70 + 4);
  for ( j = 0; V_Research.num > j; ++j )
  {
    if ( j && !(j % 6) )
    {
      v50 = 0x213;
      v49 += 0x11;
    }
    if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[j].knownToRace) != 0 )
    {
      v55 = j;
      v51 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);
      VFX_shape_transform(v92, v51, v55, v50, v49, V_BigBuffer, 0, 0x5555, 0x5555, 0);
    }
    v50 += 0x11;
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &V_Type6_stru_D8654.pane);
}
// 28784: conditional instruction was optimized away because %var_60.4==9F
// 289D7: conditional instruction was optimized away because %var_48.4==97
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 27D18: using guessed type char var_358[204];
// 27D18: using guessed type char var_1C0[204];
// 27D18: using guessed type char var_28C[204];

//----- (00028C40) --------------------------------------------------------
void __cdecl callback_fn()
{
  dword_D8650 = 0xFFFFFFFF;
}
// D8650: using guessed type int dword_D8650;

//----- (00028C4C) --------------------------------------------------------
int __fastcall sub_28C4C(__int16 *a1, __int16 *a2)
{
  return *a1 - *a2;
}

//----- (00028C58) --------------------------------------------------------
int __fastcall Q_NC_sub_28C58(int result, __int16 a2)
{
  __int16 v2; // cx

  v2 = *(_WORD *)(result + 6);
  *(_WORD *)(result + 2) += a2;
  *(_WORD *)(result + 6) = a2 + v2;
  return result;
}

//----- (00028C74) --------------------------------------------------------
void __fastcall __spoils<> sub_28C74(P_Type2 a1)
{
  Q_CFile_Ctor_sub_1BB78(&a1->a);
  Q_Font_Init_sub_2B2C0(&a1->font);
  a1->dword198 = 0;
  a1->dword1A8 = 0;
  a1->dword1AC = 0;
  a1->dword1B0 = 0;
  a1->dword1B4 = 0;
  a1->dword19C = 0xFFFFFFFF;
  memset(a1->char118, 0, sizeof(a1->char118));
  a1->dword1E4 = 0;
  a1->dword1E8 = 0;
  a1->dword1EC = 0;
  a1->dword1F0 = 0;
  *(_DWORD *)&a1->word932 = 0;
  memset(a1->char204, 0, sizeof(a1->char204));
  memset(a1->char808, 0, sizeof(a1->char808));
  a1->word804 = 0;
  a1->word806 = 0;
  a1->word908 = 0;
  a1->Unknown_90E[1] = 0;
  a1->Unknown_90E[2] = 0;
  a1->Unknown_90E[3] = 0xFFFFFFFF;
  a1->dword1E0 = 0x12;
  a1->Unknown_90E[4] = 0;
  a1->Unknown_90E[5] = 0xFFFFFFFF;
  a1->dword92E = 0;
}

//----- (00028DA4) --------------------------------------------------------
void __fastcall __spoils<> sub_28DA4(P_Type2 a1)
{
  int i; // ebx
  int j; // ebx

  if ( a1->dword1B0 == 0xFFFFFFFF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C((void *)a1->dword1AC);
  }
  operator delete((void *)a1->dword1AC);
  if ( a1->dword1B4 == 0xFFFFFFFF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C((void *)a1->dword198);
    operator delete((void *)a1->dword198);
    Q_RemoveWinDataFromWinMgr_sub_2627C((void *)a1->dword1A8);
    operator delete((void *)a1->dword1A8);
  }
  for ( i = 0; i < (__int16)a1->word908; ++i )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)&a1->char808[8 * i]);
  }
  operator delete(*(void **)&a1->char808[8 * i]);
  for ( j = 0; j < (__int16)a1->word806; ++j )
  {
    if ( *(_WORD *)&a1->char204[0xC * j + 2] == 0xA )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)&a1->char204[0xC * j + 8]);
      operator delete(*(void **)&a1->char204[0xC * j + 8]);
      *(_DWORD *)&a1->char204[0xC * j + 8] = 0;
    }
  }
  if ( a1->Unknown_90E[1] )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C((void *)a1->Unknown_90E[1]);
  }
  operator delete((void *)a1->Unknown_90E[1]);
  sub_2AD08(a1);
  sub_2B2E0(&a1->font);
  Q_CFile_Dtor_sub_1BBC8(&a1->a);
}
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00028EB4) --------------------------------------------------------
UBYTE *__fastcall sub_28EB4(int a1, const char *a2, int a3, int a4, int a5)
{
  UBYTE *result; // eax
  int v7; // eax
  int v8; // eax
  int v9; // eax

  if ( !a2 )
  {
    return 0;
  }
  sub_2A1DC(a1, "SUBTITLE.TXT");
  if ( Q_CFile_OpenFile_sub_1BBFC((P_CFile)a1, a2, 0x200, 0) )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0xE9);
    return 0;
  }
  if ( Q_ReadFile_sub_1BF94((P_CFile)a1, (void *)(a1 + 0x118), 0x80u) == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0xE3);
    return 0;
  }
  if ( *(unsigned __int16 *)(a1 + 0x11C) != 0xAF12 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0xEF);
    return 0;
  }
  if ( a4 == 0xFFFFFFFF )
  {
    v7 = (0x280 - *(unsigned __int16 *)(a1 + 0x120)) / 2;
  }
  else
  {
    v7 = a4;
  }
  *(_DWORD *)(a1 + 0x1A0) = v7;
  if ( a5 == 0xFFFFFFFF )
  {
    v8 = (0x1E0 - *(unsigned __int16 *)(a1 + 0x122)) / 2;
  }
  else
  {
    v8 = a5;
  }
  *(_DWORD *)(a1 + 0x1BC) = 0x27F;
  *(_DWORD *)(a1 + 0x1C0) = 0x1DF;
  *(_DWORD *)(a1 + 0x1A4) = v8;
  *(_DWORD *)(a1 + 0x1CC) = a1 + 0x1B8;
  if ( a3 )
  {
    *(_DWORD *)(a1 + 0x1B0) = 0;
    *(_DWORD *)(a1 + 0x1AC) = a3;
  }
  else
  {
    result = V_Type6_stru_D8654.window.buffer;
    *(_DWORD *)(a1 + 0x1AC) = V_Type6_stru_D8654.window.buffer;
    if ( !result )
    {
      return result;
    }
    *(_DWORD *)(a1 + 0x1B0) = 0;
  }
  *(_DWORD *)(a1 + 0x1C4) = 0;
  v9 = *(_DWORD *)(a1 + 0x1AC);
  *(_DWORD *)(a1 + 0x1C8) = 0;
  *(_DWORD *)(a1 + 0x1B8) = v9;
  return (UBYTE *)0xFFFFFFFF;
}

//----- (00029038) --------------------------------------------------------
int __fastcall sub_29038(int a1, size_t a2, unsigned int a3, int a4, int a5, int a6)
{
  int v8; // edi
  int v9; // edx
  void *v10; // eax
  int v12; // eax
  size_t v13; // eax
  int v14; // edx
  int v15; // ebp
  int v16; // eax

  v8 = a3;
  *(_WORD *)(a1 + 0x804) = 0;
  *(_WORD *)(a1 + 0x92A) = 0;
  *(_DWORD *)(a1 + 0x942) = 0;
  *(_WORD *)(a1 + 0x92C) = 0;
  if ( a2 < a3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x15E);
  }
  if ( a2 - a4 < a3 )
  {
    v8 = a2 - a4;
  }
  v9 = *(_DWORD *)(a1 + 0x1B4);
  *(_DWORD *)(a1 + 0x19C) = 0xFFFFFFFF;
  if ( v9 == 0xFFFFFFFF )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)(a1 + 0x198));
    operator delete[](*(void **)(a1 + 0x198));
    Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)(a1 + 0x1A8));
    operator delete[](*(void **)(a1 + 0x1A8));
    *(_DWORD *)(a1 + 0x198) = 0;
    *(_DWORD *)(a1 + 0x1A8) = 0;
    *(_DWORD *)(a1 + 0x1B4) = 0;
  }
  if ( a6 )
  {
    *(_DWORD *)(a1 + 0x1E8) = a6;
  }
  if ( *(_DWORD *)(a1 + 0x1E8)
    || (v10 = operator new[](a2), Q_RegisterData_sub_2625C(v10, 1, "FLIC BUFFER"), (*(_DWORD *)(a1 + 0x1E8) = v10) != 0) )
  {
    v12 = *(_DWORD *)(a1 + 0x1E8);
    *(_DWORD *)(a1 + 0x1F4) = a2;
    v13 = a2 + v12;
    v14 = *(_DWORD *)(a1 + 0x168);
    *(_DWORD *)(a1 + 0x1EC) = v13;
    *(_DWORD *)(a1 + 0x1F0) = v13 - a4;
    v15 = *(_DWORD *)(a1 + 0x1F0) - v8;
    *(_DWORD *)(a1 + 0x1FC) = a5;
    *(_DWORD *)(a1 + 0x1E4) = v15;
    sub_1BECC((int *)a1, v14, 0);
    *(_DWORD *)(a1 + 0x200) = ((int)sub_1BFD4((int *)a1, *(void **)(a1 + 0x1E4), v8, 0x40u, (int)sub_2BCF4) >= v8) - 1;
    VFX_area_wipe(0, 0, 639, 479, 0);
    v16 = *(_DWORD *)(a1 + 0x1E4);
    *(_DWORD *)(a1 + 0x198) = v16;
    *(_DWORD *)(a1 + 0x1A8) = v16 + 0x10;
    *(_DWORD *)(a1 + 0x1E4) = *(_DWORD *)(a1 + 0x1E8);
    *(_DWORD *)(a1 + 0x1F8) = *(_DWORD *)(a1 + 0x198) - *(_DWORD *)(a1 + 0x1E4);
    return 0xFFFFFFFF;
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x183);
    return 0;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (000291F8) --------------------------------------------------------
unsigned int __fastcall Q_NC_sub_291F8(int a1)
{
  int v2; // edx
  int v3; // edx
  int v5; // edi
  _DWORD *v6; // edi
  int i; // ebp
  _DWORD *v8; // edx
  unsigned __int16 v9; // ax
  unsigned __int16 *v10; // edx

  v2 = *(_DWORD *)(a1 + 0x19C) + 1;
  *(_DWORD *)(a1 + 0x19C) = v2;
  if ( v2 )
  {
    if ( *(unsigned __int16 *)(a1 + 0x11E) >= *(int *)(a1 + 0x19C) )
    {
      goto LABEL_6;
    }
    v3 = *(_DWORD *)(a1 + 0x16C);
    *(_DWORD *)(a1 + 0x19C) = 1;
  }
  else
  {
    v3 = *(_DWORD *)(a1 + 0x168);
  }
  sub_1BECC((int *)a1, v3, 0);
LABEL_6:
  if ( Q_ReadFile_sub_1BF94((P_CFile)a1, *(void **)(a1 + 0x198), 0x10u) == 0xFFFFFFFF )
  {
    return 0;
  }
  v5 = **(_DWORD **)(a1 + 0x198) - 0x10;
  if ( v5 < 0 || v5 > 0x4B000 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x1DD);
  }
  Q_ReadFile_sub_1BF94((P_CFile)a1, *(void **)(a1 + 0x1A8), **(_DWORD **)(a1 + 0x198) - 0x10);
  if ( *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 4) != 0xF1FA )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x1E0);
  }
  v6 = *(_DWORD **)(a1 + 0x1A8);
  for ( i = 0; i < *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 6); ++i )
  {
    v8 = v6;
    v6 = (_DWORD *)((char *)v6 + *v6);
    v9 = *((_WORD *)v8 + 2);
    v10 = (unsigned __int16 *)v8 + 3;
    if ( v9 < 0xFu )
    {
      if ( v9 < 4u )
      {
        goto LABEL_18;
      }
      if ( v9 <= 4u )
      {
        sub_29C6C(a1, v10);
      }
      else
      {
        if ( v9 != 7 )
        {
LABEL_18:
          Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x221);
        }
        sub_2AD40(v10, *(_DWORD *)(a1 + 0x1A0), *(_DWORD *)(a1 + 0x1A4));
      }
    }
    else if ( v9 <= 0xFu )
    {
      sub_29D54(a1, (unsigned __int8 *)v10);
    }
    else if ( v9 <= 0x10u )
    {
      sub_29F58(a1, v10);
    }
    else if ( v9 != 0x12 )
    {
      goto LABEL_18;
    }
  }
  return 0xFFFFFFFF;
}

//----- (0002936C) --------------------------------------------------------
unsigned int __fastcall Q_NC_sub_2936C(int a1)
{
  int v2; // ebx
  int v4; // esi
  int i; // edi
  unsigned __int16 *v6; // edx
  unsigned __int16 v7; // ax
  unsigned __int16 v8; // ax
  _DWORD *v9; // esi
  _DWORD *v10; // esi
  _BYTE *v11; // edi
  int v12; // edx
  void *v13; // edi
  const void *v14; // esi
  signed int v15; // ecx
  int v16; // ecx
  int v17; // edx
  int v18; // esi
  int v19; // edx
  unsigned int v20; // ebx
  unsigned int v21; // eax

  v2 = ++*(_DWORD *)(a1 + 0x19C);
  if ( *(unsigned __int16 *)(a1 + 0x11E) <= v2 )
  {
    return 0;
  }
  if ( !v2 )
  {
    VFX_area_wipe(0, 0, 0x27F, 0x1DF, *(_DWORD *)(a1 + 0x926));
  }
  if ( *(_DWORD *)(a1 + 0x946) == 0xFFFFFFFF )
  {
    sub_29B24((_DWORD *)a1);
  }
  if ( *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 4) != 0xF1FA )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x246);
  }
  v4 = *(_DWORD *)(a1 + 0x1A8);
  for ( i = 0; i < *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 6); ++i )
  {
    v6 = (unsigned __int16 *)(v4 + 6);
    v7 = *(_WORD *)(v4 + 4);
    v4 += *(_DWORD *)v4;
    if ( v7 < 0xFu )
    {
      if ( v7 < 4u )
      {
        goto LABEL_14;
      }
      if ( v7 <= 4u )
      {
        sub_29C6C(a1, v6);
      }
      else
      {
        if ( v7 != 7 )
        {
LABEL_14:
          Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x26C);
        }
        sub_2AD40(v6, *(_DWORD *)(a1 + 0x1A0), *(_DWORD *)(a1 + 0x1A4));
      }
    }
    else if ( v7 <= 0xFu )
    {
      sub_29D54(a1, (unsigned __int8 *)v6);
    }
    else if ( v7 <= 0x10u )
    {
      sub_29F58(a1, v6);
    }
    else if ( v7 != 0x12 )
    {
      goto LABEL_14;
    }
  }
  v8 = *(_WORD *)(a1 + 0x92A);
  if ( v8 )
  {
    if ( v8 <= 1u )
    {
      sub_2C4C0(&V_Type6_stru_D8654, *(__int16 *)(a1 + 0x932), *(__int16 *)(a1 + 0x934));
    }
    else if ( v8 == 2 )
    {
      sub_2C418(&V_Type6_stru_D8654, *(__int16 *)(a1 + 0x932), *(_WORD *)(a1 + 0x934));
    }
  }
  if ( *(__int16 *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x204) == *(_DWORD *)(a1 + 0x19C) )
  {
    sub_2AA88(a1);
  }
  v9 = *(_DWORD **)(a1 + 0x198);
  *(_DWORD *)(a1 + 0x1F8) += *v9;
  v10 = (_DWORD *)((char *)v9 + *v9);
  v11 = *(_BYTE **)(a1 + 0x1F0);
  *(_DWORD *)(a1 + 0x198) = v10;
  if ( v10 < (_DWORD *)v11 )
  {
    v12 = (char *)(v10 + 4) - v11;
    if ( v12 <= 0 )
    {
      v15 = (char *)v10 + *v10 - v11;
      if ( v15 <= 0 )
      {
        goto LABEL_42;
      }
      if ( v15 >= *(_DWORD *)(a1 + 0x1EC) - (int)v11 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x2D2);
      }
      v14 = *(const void **)(a1 + 0x1E8);
      v13 = *(void **)(a1 + 0x1F0);
    }
    else
    {
      qmemcpy(v11, *(const void **)(a1 + 0x1E8), (char *)(v10 + 4) - v11);
      v13 = v10 + 4;
      v14 = (const void *)(v12 + *(_DWORD *)(a1 + 0x1E8));
      v15 = **(_DWORD **)(a1 + 0x198) - 0x10;
    }
    qmemcpy(v13, v14, v15);
    goto LABEL_42;
  }
  *(_DWORD *)(a1 + 0x198) = (char *)v10 + *(_DWORD *)(a1 + 0x1E8) - v11;
LABEL_42:
  v16 = *(_DWORD *)(a1 + 0x200);
  *(_DWORD *)(a1 + 0x1A8) = *(_DWORD *)(a1 + 0x198) + 0x10;
  if ( !v16 )
  {
    if ( *(_DWORD *)(a1 + 0x1F8) < *(_DWORD *)(a1 + 0x1FC) )
    {
      v17 = *(_DWORD *)(a1 + 0x1F8);
    }
    else
    {
      v17 = *(_DWORD *)(a1 + 0x1FC);
    }
    v18 = v17;
    if ( v17 + *(_DWORD *)(a1 + 0x1E4) - *(_DWORD *)(a1 + 0x1F0) > 0 )
    {
      v18 = *(_DWORD *)(a1 + 0x1F0) - *(_DWORD *)(a1 + 0x1E4);
    }
    if ( Q_ReadFile_sub_1BF94((P_CFile)a1, *(void **)(a1 + 0x1E4), v18) < v18 )
    {
      *(_DWORD *)(a1 + 0x200) = 0xFFFFFFFF;
    }
    v19 = *(_DWORD *)(a1 + 0x1F8);
    v20 = *(_DWORD *)(a1 + 0x1F0);
    *(_DWORD *)(a1 + 0x1E4) += v18;
    v21 = *(_DWORD *)(a1 + 0x1E4);
    *(_DWORD *)(a1 + 0x1F8) = v19 - v18;
    if ( v21 >= v20 )
    {
      *(_DWORD *)(a1 + 0x1E4) = *(_DWORD *)(a1 + 0x1E8);
    }
  }
  if ( (unsigned int)(*(_DWORD *)(a1 + 0x1EC) + **(_DWORD **)(a1 + 0x198) + *(_DWORD *)(a1 + 0x1F8) - *(_DWORD *)(a1 + 0x1F0)) >= *(_DWORD *)(a1 + 0x1F4) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x305);
  }
  return 0xFFFFFFFF;
}

//----- (000296B4) --------------------------------------------------------
unsigned int __fastcall sub_296B4(int a1, int a2, int a3, int a4)
{
  int v5; // edx
  int v7; // eax
  _DWORD *v8; // esi
  int i; // edi
  _DWORD *v10; // edx
  unsigned __int16 v11; // ax
  unsigned __int16 *v12; // edx
  unsigned __int16 v13; // ax
  _DWORD *v14; // esi
  unsigned int v15; // edx
  int v16; // edx
  void *v17; // edi
  const void *v18; // esi
  signed int v19; // ecx
  char *v20; // ecx
  int v21; // esi
  int v22; // edx
  int v23; // esi
  int v24; // edi
  unsigned int v25; // edx
  unsigned int v26; // eax
  int v27; // esi
  int v28; // edx
  int v29; // ecx
  int v30; // ecx
  unsigned int v31; // esi
  unsigned int v32; // eax

  if ( dword_D8650 )
  {
    if ( *(_DWORD *)(a1 + 0x946) == 0xFFFFFFFF )
    {
      sub_29B24((_DWORD *)a1);
    }
    if ( dword_D8650 != 0xFFFFFFFF && *(_DWORD *)(a1 + 0x93A) != 0xFFFFFFFF )
    {
      goto LABEL_54;
    }
    if ( !*(_DWORD *)(a1 + 0x93A) )
    {
      _disable();
      dword_D8650 = 0;
      _enable();
    }
    v5 = *(_DWORD *)(a1 + 0x19C) + 1;
    *(_DWORD *)(a1 + 0x19C) = v5;
    if ( !v5 )
    {
      VFX_area_wipe(0, 0, 639, 479, *(_DWORD *)(a1 + 0x926));
    }
    if ( *(unsigned __int16 *)(a1 + 0x11E) <= *(int *)(a1 + 0x19C) )
    {
      return 0;
    }
    v7 = *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 4);
    ++dword_A0CF8;
    if ( v7 != 0xF1FA )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x32E);
    }
    v8 = *(_DWORD **)(a1 + 0x1A8);
    for ( i = 0; i < *(unsigned __int16 *)(*(_DWORD *)(a1 + 0x198) + 6); ++i )
    {
      v10 = v8;
      v8 = (_DWORD *)((char *)v8 + *v8);
      v11 = *((_WORD *)v10 + 2);
      v12 = (unsigned __int16 *)v10 + 3;
      if ( v11 < 0xFu )
      {
        if ( v11 < 4u )
        {
          goto LABEL_19;
        }
        if ( v11 <= 4u )
        {
          *(_WORD *)(a1 + 0x92C) = 0;
          sub_29C6C(a1, v12);
        }
        else
        {
          if ( v11 != 7 )
          {
LABEL_19:
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x355);
          }
          sub_2AD40(v12, *(_DWORD *)(a1 + 0x1A0), *(_DWORD *)(a1 + 0x1A4));
        }
      }
      else if ( v11 <= 0xFu )
      {
        sub_29D54(a1, (unsigned __int8 *)v12);
      }
      else if ( v11 <= 0x10u )
      {
        sub_29F58(a1, v12);
      }
      else if ( v11 != 0x12 )
      {
        goto LABEL_19;
      }
    }
    v13 = *(_WORD *)(a1 + 0x92A);
    if ( v13 )
    {
      if ( v13 <= 1u )
      {
        sub_2C4C0(&V_Type6_stru_D8654, *(__int16 *)(a1 + 0x932), *(__int16 *)(a1 + 0x934));
      }
      else if ( v13 == 2 )
      {
        sub_2C418(&V_Type6_stru_D8654, *(__int16 *)(a1 + 0x932), *(_WORD *)(a1 + 0x934));
      }
    }
    if ( *(__int16 *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x204) == *(_DWORD *)(a1 + 0x19C) )
    {
      sub_2AA88(a1);
    }
    if ( *(_WORD *)(a1 + 0x92C) )
    {
      Q_FadePalette_sub_2C5E4(&V_Type6_stru_D8654, *(_BYTE *)(a1 + 0x92C) - 1);
      if ( (__int16)++*(_WORD *)(a1 + 0x92C) > 0x40 )
      {
        *(_WORD *)(a1 + 0x92C) = 0;
      }
    }
    if ( *(_DWORD *)(a1 + 0x93A) == 0xFFFFFFFF && *(_DWORD *)(a1 + 0x93E) == *(_DWORD *)(a1 + 0x19C) )
    {
      getch();
      *(_DWORD *)(a1 + 0x93A) = 0;
      *(_DWORD *)(a1 + 0x93E) = 0xFFFFFFFF;
    }
    *(_DWORD *)(a1 + 0x1F8) += **(_DWORD **)(a1 + 0x198);
    v14 = (_DWORD *)(**(_DWORD **)(a1 + 0x198) + *(_DWORD *)(a1 + 0x198));
    v15 = *(_DWORD *)(a1 + 0x1F0);
    *(_DWORD *)(a1 + 0x198) = v14;
    if ( (unsigned int)v14 >= v15 )
    {
      *(_DWORD *)(a1 + 0x198) = (char *)v14 + *(_DWORD *)(a1 + 0x1E8) - v15;
LABEL_53:
      *(_DWORD *)(a1 + 0x1A8) = *(_DWORD *)(a1 + 0x198) + 0x10;
LABEL_54:
      if ( !*(_DWORD *)(a1 + 0x200) )
      {
        if ( *(_DWORD *)(a1 + 0x1F8) < *(_DWORD *)(a1 + 0x1FC) )
        {
          v22 = *(_DWORD *)(a1 + 0x1F8);
        }
        else
        {
          v22 = *(_DWORD *)(a1 + 0x1FC);
        }
        v23 = v22;
        if ( v22 + *(_DWORD *)(a1 + 0x1E4) - *(_DWORD *)(a1 + 0x1F0) > 0 )
        {
          v23 = *(_DWORD *)(a1 + 0x1F0) - *(_DWORD *)(a1 + 0x1E4);
        }
        if ( Q_ReadFile_sub_1BF94((P_CFile)a1, *(void **)(a1 + 0x1E4), v23) < v23 )
        {
          *(_DWORD *)(a1 + 0x200) = 0xFFFFFFFF;
        }
        v24 = *(_DWORD *)(a1 + 0x1F8);
        v25 = *(_DWORD *)(a1 + 0x1F0);
        *(_DWORD *)(a1 + 0x1E4) += v23;
        v26 = *(_DWORD *)(a1 + 0x1E4);
        *(_DWORD *)(a1 + 0x1F8) = v24 - v23;
        if ( v26 >= v25 )
        {
          *(_DWORD *)(a1 + 0x1E4) = *(_DWORD *)(a1 + 0x1E8);
        }
      }
      if ( (unsigned int)(*(_DWORD *)(a1 + 0x1EC) + **(_DWORD **)(a1 + 0x198) + *(_DWORD *)(a1 + 0x1F8) - *(_DWORD *)(a1 + 0x1F0)) >= *(_DWORD *)(a1 + 0x1F4) )
      {
        v27 = *(_DWORD *)(a1 + 0x1F8);
        v28 = *(_DWORD *)(a1 + 0x1F0);
        if ( v27 + *(_DWORD *)(a1 + 0x1E4) - v28 > 0 )
        {
          v27 = v28 - *(_DWORD *)(a1 + 0x1E4);
        }
        if ( Q_ReadFile_sub_1BF94((P_CFile)a1, *(void **)(a1 + 0x1E4), v27) < v27 )
        {
          *(_DWORD *)(a1 + 0x200) = 0xFFFFFFFF;
        }
        v29 = *(_DWORD *)(a1 + 0x1F8);
        *(_DWORD *)(a1 + 0x1E4) += v27;
        v30 = v29 - v27;
        v31 = *(_DWORD *)(a1 + 0x1F0);
        v32 = *(_DWORD *)(a1 + 0x1E4);
        *(_DWORD *)(a1 + 0x1F8) = v30;
        if ( v32 >= v31 )
        {
          *(_DWORD *)(a1 + 0x1E4) = *(_DWORD *)(a1 + 0x1E8);
        }
      }
      return 0xFFFFFFFF;
    }
    v16 = (int)v14 - *(_DWORD *)(a1 + 0x1F0) + 0x10;
    if ( v16 <= 0 )
    {
      v20 = (char *)v14 + *v14;
      v21 = *(_DWORD *)(a1 + 0x1F0);
      v19 = (signed int)&v20[-v21];
      if ( v19 <= 0 )
      {
        goto LABEL_53;
      }
      if ( v19 >= *(_DWORD *)(a1 + 0x1EC) - v21 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x3D0);
      }
      v18 = *(const void **)(a1 + 0x1E8);
      v17 = *(void **)(a1 + 0x1F0);
    }
    else
    {
      qmemcpy(*(void **)(a1 + 0x1F0), *(const void **)(a1 + 0x1E8), (unsigned int)v14 - *(_DWORD *)(a1 + 0x1F0) + 0x10);
      v17 = v14 + 4;
      v18 = (const void *)(v16 + *(_DWORD *)(a1 + 0x1E8));
      v19 = **(_DWORD **)(a1 + 0x198) - 0x10;
    }
    qmemcpy(v17, v18, v19);
    goto LABEL_53;
  }
  return 0xFFFFFFFF;
}
// A0CF8: using guessed type int dword_A0CF8;
// D8650: using guessed type int dword_D8650;

//----- (00029B24) --------------------------------------------------------
void __fastcall sub_29B24(_DWORD *a1)
{
  int v1; // ecx
  signed int v2; // ebx
  int v3; // edi
  int v4; // eax
  LONG v5; // esi
  RGB v6[4]; // [esp+0h] [ebp-18h] BYREF

  v1 = a1[0x7A];
  v2 = a1[0x7D] / 0x27Fu;
  v3 = (a1[0x79] - v1) / v2;
  v4 = (a1[0x66] - v1) / v2;
  v6[0].g = 0;
  v6[0].b = 0;
  v5 = v4;
  v6[0].r = 0xFF;
  VFX_DAC_write(0xFE, v6);
  v6[0].r = 0;
  v6[0].g = 0xFF;
  VFX_DAC_write(0xFF, v6);
  if ( v5 < v3 )
  {
    VFX_area_wipe(0, 450, v5, 479, 254);
    VFX_area_wipe(v5, 450, v3, 479, 255);
    VFX_area_wipe(v3, 450, 639, 479, 254);
  }
  else
  {
    VFX_area_wipe(0, 450, v3, 479, 255);
    VFX_area_wipe(v3, 450, v5, 479, 254);
    VFX_area_wipe(v5, 450, 639, 479, 255);
  }
  VFX_area_wipe(v5, 450, v5, 479, 254);
}

//----- (00029C6C) --------------------------------------------------------
unsigned __int16 __fastcall sub_29C6C(int a1, _WORD *a2)
{
  RGB *v3; // esi
  unsigned __int16 result; // ax
  unsigned __int16 v5; // ax
  UBYTE *p_g; // esi
  unsigned __int8 v7; // dl
  unsigned __int16 i; // di
  int v9; // edx
  UBYTE r; // dh
  UBYTE b; // bh
  unsigned __int16 v12; // [esp+0h] [ebp-24h]
  unsigned __int16 v13; // [esp+4h] [ebp-20h]
  int v14; // [esp+8h] [ebp-1Ch]
  unsigned __int8 v15; // [esp+Ch] [ebp-18h]

  v3 = (RGB *)(a2 + 1);
  result = *a2;
  v12 = *a2;
  HIBYTE(result) = 0;
  if ( *a2 )
  {
    v15 = 0;
    v14 = 0;
    do
    {
      LOBYTE(v5) = v3->r;
      p_g = &v3->g;
      v7 = v5 + v15;
      v5 = (unsigned __int8)v5;
      LOBYTE(v5) = *p_g;
      v3 = (RGB *)(p_g + 1);
      v13 = v5;
      result = v3[0xFFFFFFFF].b;
      v15 = v7;
      if ( !v3[0xFFFFFFFF].b )
      {
        result = 0;
        v13 = 0x100;
      }
      for ( i = 0; i < v13; ++i )
      {
        v9 = *(__int16 *)(a1 + 0x932);
        if ( i < v9 || i >= *(__int16 *)(a1 + 0x934) + v9 )
        {
          r = v3->r;
          v3->g >>= 2;
          b = v3->b;
          v3->r = r >> 2;
          v3->b = b >> 2;
          VFX_DAC_write(v15++, v3++);
        }
        result = v13;
      }
      ++v14;
    }
    while ( (unsigned __int16)v14 < v12 );
  }
  return result;
}

//----- (00029D54) --------------------------------------------------------
int __fastcall sub_29D54(int a1, unsigned __int8 *a2)
{
  int v3; // edx
  int v4; // edx
  unsigned __int16 v5; // ax
  unsigned __int8 *v6; // ebp
  int result; // eax
  int i; // [esp+0h] [ebp-2Ch]
  char *s; // [esp+8h] [ebp-24h]
  char v11[4]; // [esp+Ch] [ebp-20h] BYREF
  int v12; // [esp+10h] [ebp-1Ch]
  signed __int8 v13; // [esp+14h] [ebp-18h]

  s = *(char **)(a1 + 0x1AC);
  for ( i = 0; *(unsigned __int16 *)(a1 + 0x122) > i; ++i )
  {
    v12 = 0;
    ++a2;
    if ( *(_WORD *)(a1 + 0x120) )
    {
      do
      {
        v13 = *a2;
        v6 = a2 + 1;
        if ( v13 >= 0 )
        {
          v3 = *v6;
          a2 = v6 + 1;
          memset(s, v3, v13);
        }
        else
        {
          v13 = -v13;
          v4 = v13;
          qmemcpy(s, v6, v13);
          a2 = &v6[v13];
        }
        LOWORD(v4) = v13;
        s += v13;
        v5 = *(_WORD *)(a1 + 0x120);
        v12 += v4;
      }
      while ( (unsigned __int16)v12 < v5 );
    }
    s += 0x280 - *(unsigned __int16 *)(a1 + 0x120);
  }
  v11[0] = 0;
  v11[1] = 0;
  v11[2] = 0;
  Q_PaletteGet_sub_2C2B0(&V_Type6_stru_D8654, 0, 0x100, 0);
  sub_2C670((int)&V_Type6_stru_D8654, 0, 0x100, v11);
  *(_DWORD *)(a1 + 0x1D0) = 0;
  *(_DWORD *)(a1 + 0x1D4) = 0;
  *(_DWORD *)(a1 + 0x1D8) = *(unsigned __int16 *)(a1 + 0x120) - 1;
  *(_DWORD *)(a1 + 0x1DC) = *(unsigned __int16 *)(a1 + 0x122) - 1;
  VFX_pane_refresh(
    (PANE *)(a1 + 0x1CC),
    *(_DWORD *)(a1 + 0x1A0),
    *(_DWORD *)(a1 + 0x1A4),
    *(_DWORD *)(a1 + 0x1D8) + *(_DWORD *)(a1 + 0x1A0),
    *(_DWORD *)(a1 + 0x1DC) + *(_DWORD *)(a1 + 0x1A4));
  for ( *(_WORD *)(a1 + 0x92C) = 0; *(__int16 *)(a1 + 0x92C) < 0x20; ++*(_WORD *)(a1 + 0x92C) )
  {
    Q_FadePalette_sub_2C5E4(&V_Type6_stru_D8654, *(_BYTE *)(a1 + 0x92C));
  }
  ++*(_WORD *)(a1 + 0x92C);
  return result;
}
// 29DB1: variable 'v4' is possibly undefined

//----- (00029F58) --------------------------------------------------------
void __fastcall sub_29F58(int a1, const void *a2)
{
  LONG v3; // edi
  LONG v4; // [esp-Ch] [ebp-1Ch]
  LONG v5; // [esp-8h] [ebp-18h]
  LONG v6; // [esp-4h] [ebp-14h]

  qmemcpy(*(void **)(a1 + 0x1AC), a2, *(unsigned __int16 *)(a1 + 0x122) * *(unsigned __int16 *)(a1 + 0x120));
  *(_DWORD *)(a1 + 0x1D8) = *(unsigned __int16 *)(a1 + 0x120) - 1;
  *(_DWORD *)(a1 + 0x1DC) = *(unsigned __int16 *)(a1 + 0x122) - 1;
  v6 = *(_DWORD *)(a1 + 0x1DC) + *(_DWORD *)(a1 + 0x1A4);
  v5 = *(_DWORD *)(a1 + 0x1D8) + *(_DWORD *)(a1 + 0x1A0);
  v4 = *(_DWORD *)(a1 + 0x1A4);
  v3 = *(_DWORD *)(a1 + 0x1A0);
  *(_DWORD *)(a1 + 0x1D0) = 0;
  *(_DWORD *)(a1 + 0x1D4) = 0;
  VFX_pane_refresh((PANE *)(a1 + 0x1CC), v3, v4, v5, v6);
}

//----- (00029FF8) --------------------------------------------------------
void __fastcall Q_NC_sub_29FF8(int a1, _WORD *a2)
{
  int v3; // esi
  unsigned __int8 *v4; // edi
  int v6; // eax
  unsigned __int8 v7; // ah
  signed __int8 v8; // al
  int v9; // eax
  int v10; // edx
  __int16 v11; // bx
  int v12; // edx
  int v13; // eax
  int v14; // ebx
  int k; // kr0C_4
  int m; // kr04_4
  PANE *target; // [esp+0h] [ebp-18h]
  __int16 j; // [esp+4h] [ebp-14h]
  __int16 v19; // [esp+4h] [ebp-14h]
  int v20; // [esp+8h] [ebp-10h]
  __int16 v21; // [esp+Ch] [ebp-Ch]
  __int16 i; // [esp+10h] [ebp-8h]
  __int16 v23; // [esp+14h] [ebp-4h]

  v3 = *(_DWORD *)(a1 + 0x1AC);
  v4 = (unsigned __int8 *)(a2 + 1);
  v21 = *a2;
  target = (PANE *)(a1 + 0x1CC);
  for ( i = 0; v21--; v3 = i * *(unsigned __int16 *)(a1 + 0x120) + *(_DWORD *)(a1 + 0x1AC) )
  {
    while ( 1 )
    {
      v23 = *(_WORD *)v4;
      v4 += 2;
      if ( v23 > 0 )
      {
        break;
      }
      if ( (v23 & 0x4000) == 0 )
      {
        printf("Bombing on Frame #%d.\n", *(_DWORD *)(a1 + 0x19C));
        Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x569);
      }
      i -= v23;
      v3 = *(unsigned __int16 *)(a1 + 0x120) * i + *(_DWORD *)(a1 + 0x1AC);
    }
    for ( j = 0; ; j = v20 + v19 )
    {
      v6 = v23--;
      if ( v6 <= 0 )
      {
        break;
      }
      v7 = *v4;
      v8 = v4[1];
      LOWORD(v20) = 2 * v8;
      v3 += *v4;
      v4 += 2;
      v19 = v7 + j;
      if ( (__int16)v20 <= 0 )
      {
        v11 = *(_WORD *)v4;
        v4 += 2;
        for ( k = 0; ; ++k )
        {
          v12 = v8++;
          if ( v12 >= 0 )
          {
            break;
          }
          *(_WORD *)(v3 + 2 * k) = v11;
        }
        LOWORD(v20) = -(__int16)v20;
      }
      else
      {
        v9 = v20;
        for ( m = 0; ; ++m )
        {
          v10 = (__int16)v9--;
          if ( v10 <= 0 )
          {
            break;
          }
          *(_BYTE *)(v3 + m) = v4[m];
        }
      }
      *(_DWORD *)(a1 + 0x1D0) = v19;
      *(_DWORD *)(a1 + 0x1DC) = i;
      *(_DWORD *)(a1 + 0x1D4) = i;
      v13 = *(_DWORD *)(a1 + 0x1A4);
      v14 = *(_DWORD *)(a1 + 0x1DC);
      *(_DWORD *)(a1 + 0x1D8) = (__int16)v20 + v19;
      VFX_pane_refresh(
        target,
        *(_DWORD *)(a1 + 0x1D0) + *(_DWORD *)(a1 + 0x1A0),
        *(_DWORD *)(a1 + 0x1D4) + *(_DWORD *)(a1 + 0x1A4),
        *(_DWORD *)(a1 + 0x1D8) + *(_DWORD *)(a1 + 0x1A0),
        v14 + v13);
    }
    ++i;
  }
}
// 2A0FB: variable 'v20' is possibly undefined

//----- (0002A1DC) --------------------------------------------------------
FILE *__fastcall sub_2A1DC(int a1, const char *a2)
{
  FILE *result; // eax
  FILE *v4; // ebx
  int v5; // esi
  unsigned int v6; // kr0C_4
  char *v7; // eax
  int v9; // esi
  int v10; // ecx
  void *v11; // eax
  int v12; // eax
  __int16 v13; // dx
  FILE *v14; // ecx
  __int16 v15; // si
  FILE *v16; // esi
  __int16 v17; // bx
  FILE *v18; // esi
  __int16 v19; // cx
  void *v20; // eax
  FILE *v21; // edi
  int v22; // ebx
  FILE *v23; // [esp-10h] [ebp-304h]
  T_CFile v24; // [esp+0h] [ebp-2F4h] BYREF
  char v25[256]; // [esp+118h] [ebp-1DCh] BYREF
  char v26[128]; // [esp+218h] [ebp-DCh] BYREF
  char v27[52]; // [esp+298h] [ebp-5Ch] BYREF
  unsigned int v28; // [esp+2CCh] [ebp-28h] BYREF
  FILE *fp; // [esp+2D0h] [ebp-24h]
  int v30; // [esp+2D4h] [ebp-20h]
  int v31; // [esp+2D8h] [ebp-1Ch]
  __int16 v32; // [esp+2DCh] [ebp-18h]

  result = (FILE *)a2;
  if ( a2 )
  {
    result = Q_OpenFile_sub_1BB10(a2, 0);
    fp = result;
    if ( result )
    {
      v32 = 0;
      v30 = 0;
      v31 = a1 + 0x90A;
      while ( 1 )
      {
        v4 = fp;
        fscanf(fp, "%s %d", v27, &v28);
        if ( v28 == 0xFFFFFFFF )
        {
          break;
        }
        v5 = ++v30;
        if ( v28 < 2 )
        {
          if ( v28 )
          {
            fscanf(v4, "%s %s", v27, v26);
            if ( sub_2B360((void **)v31, v26) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x5E3);
            }
            fscanf(fp, "%s %s", v27, v26);
            Q_CFile_Ctor_sub_1BB78(&v24);
            if ( Q_CFile_OpenFile_sub_1BBFC(&v24, v26, 0x200, 0) )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x5EB);
            }
            v20 = Q_CFile_Load_sub_1BF1C(&v24, 0);
            *(_DWORD *)(a1 + 0x92E) = v20;
            if ( !v20 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x5EE);
            }
            v21 = fp;
            fscanf(fp, "%s %d", v27, &v28);
            *(_WORD *)(a1 + 0x932) = v28;
            fscanf(v21, "%s %d", v27, &v28);
            *(_WORD *)(a1 + 0x934) = v28;
            fscanf(v21, "%s %d", v27, &v28);
            v22 = v30 + 6;
            *(_DWORD *)(a1 + 0x926) = v28;
            v30 = v22;
            Q_CFile_Dtor_sub_1BBC8(&v24);
          }
          else
          {
            fscanf(v4, "%s %d", v27, &v28);
            *(_DWORD *)(a1 + 0x916) = v28;
            fscanf(v4, "%s %d", v27, &v28);
            *(_DWORD *)(a1 + 0x91A) = v28;
            fscanf(v4, "%s %d", v27, &v28);
            *(_DWORD *)(a1 + 0x91E) = v28;
            fscanf(v4, "%s %d", v27, &v28);
            v30 = v5 + 5;
            *(_DWORD *)(a1 + 0x922) = v28;
          }
        }
        else if ( v28 <= 2 )
        {
          if ( *(__int16 *)(a1 + 0x806) >= 0x80 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x5FF);
          }
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x206) = 1;
          *(_DWORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x208) = v32;
          fscanf(fp, "%s %s", v27, v25);
          v6 = strlen(v25) + 1;
          v7 = v25;
          if ( v25[0] )
          {
            do
            {
              if ( *v7 == 0x5F )
              {
                *v7 = 0x20;
              }
            }
            while ( *++v7 );
          }
          v9 = sub_2B5BC((int *)v31, v25);
          if ( v9 == 0xFFFFFFFF )
          {
            Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x613);
          }
          v10 = v32;
          *(_DWORD *)(a1 + 8 * v32 + 0x80C) = v9;
          v11 = operator new[]((__int16)(v6 - 1) + 1);
          Q_RegisterData_sub_2625C(v11, 1, "SUBTITLE");
          *(_DWORD *)(a1 + 8 * v10 + 0x808) = v11;
          if ( !v11 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x61B);
          }
          strcpy(*(char **)(a1 + 8 * v32 + 0x808), v25);
          fscanf(fp, "%s %d", v27, &v28);
          v28 -= 0x20;
          if ( (int)v28 <= 0 )
          {
            Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x622);
          }
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x204) = v28;
          v23 = fp;
          ++*(_WORD *)(a1 + 0x806);
          fscanf(v23, "%s %d", v27, &v28);
          v12 = 0xC * *(__int16 *)(a1 + 0x806);
          ++v32;
          *(_WORD *)(v12 + a1 + 0x204) = v28;
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x206) = 2;
          v13 = *(_WORD *)(a1 + 0x806);
          v30 += 4;
          *(_WORD *)(a1 + 0x806) = v13 + 1;
        }
        else if ( v28 < 0xB )
        {
          if ( v28 != 3 )
          {
LABEL_10:
            sprintf("Thank you for playing Ascendancy.", "\n  ** Bad Subtitle Data: %s, %d (line %d)\n\n", v27, v28, v30);
            Q_debugbreak_exit_sub_2624C();
          }
          if ( *(__int16 *)(a1 + 0x806) >= 0x80 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x635);
          }
          v14 = fp;
          fscanf(fp, "%s %d", v27, &v28);
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x204) = v28;
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x206) = 3;
          fscanf(v14, "%s %d", v27, &v28);
          *(_DWORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x208) = v28;
          v15 = *(_WORD *)(a1 + 0x806);
          v30 += 3;
          *(_WORD *)(a1 + 0x806) = v15 + 1;
        }
        else if ( v28 <= 0xB )
        {
          if ( *(__int16 *)(a1 + 0x806) >= 0x80 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x703);
          }
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x206) = 0xB;
          v18 = fp;
          fscanf(fp, "%s %d", v27, &v28);
          *(_DWORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x208) = v28;
          fscanf(v18, "%s %d", v27, &v28);
          *(_DWORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x20C) = v28;
          fscanf(v18, "%s %d", v27, &v28);
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x204) = v28;
          v19 = *(_WORD *)(a1 + 0x806);
          v30 += 4;
          *(_WORD *)(a1 + 0x806) = v19 + 1;
        }
        else
        {
          if ( v28 != 0x10 )
          {
            goto LABEL_10;
          }
          if ( *(__int16 *)(a1 + 0x806) >= 0x80 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\flic.cpp", 0x68A);
          }
          v16 = fp;
          fscanf(fp, "%s %d", v27, &v28);
          *(_DWORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x208) = v28;
          fscanf(v16, "%s %d", v27, &v28);
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x206) = (v28 != 1) + 0x1E;
          fscanf(v16, "%s %d", v27, &v28);
          *(_WORD *)(0xC * *(__int16 *)(a1 + 0x806) + a1 + 0x204) = v28;
          v17 = *(_WORD *)(a1 + 0x806) + 1;
          v30 += 4;
          *(_WORD *)(a1 + 0x806) = v17;
        }
      }
      fclose(v4);
      qsort((void *)(a1 + 0x204), *(__int16 *)(a1 + 0x806), 0xCu, (int (__fastcall *)(const void *, const void *))sub_28C4C);
      return (FILE *)0xFFFFFFFF;
    }
  }
  return result;
}
// 2A1DC: using guessed type char var_5C[52];

//----- (0002AA88) --------------------------------------------------------
void __fastcall sub_2AA88(int a1)
{
  int v2; // ebx
  int v3; // ecx
  int v4; // edi
  ULONG v5; // edx
  HTIMER v6; // eax
  unsigned __int16 v7; // ax
  int v8; // [esp+0h] [ebp-8h]
  T_Font *v9; // [esp+4h] [ebp-4h]

  v8 = a1 + 0x808;
  v9 = (T_Font *)(a1 + 0x90A);
  while ( 1 )
  {
    v2 = *(__int16 *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x204);
    v3 = *(_DWORD *)(a1 + 0x19C);
    if ( v2 != v3 )
    {
      break;
    }
    v7 = *(_WORD *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x206);
    if ( v7 < 3u )
    {
      if ( !v7 )
      {
        goto LABEL_23;
      }
      if ( v7 <= 1u )
      {
        if ( !*(_DWORD *)(a1 + 0x942) )
        {
          v4 = 8 * *(_DWORD *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x208) + v8;
          sub_2C1E0((int)&V_Type6_stru_D8654, *(_WORD *)(a1 + 0x932), *(_WORD *)(a1 + 0x934), *(_DWORD *)(a1 + 0x92E));
          sub_2C670((int)&V_Type6_stru_D8654, *(__int16 *)(a1 + 0x932), *(__int16 *)(a1 + 0x934), 0);
          Q_Font_DrawFormattedText_sub_2B8A8(v9, *(__int16 *)(v4 + 4), *(__int16 *)(v4 + 6), *(const char **)v4, 0x80, 0xFFFF, 0xFFFF, 0);
          *(_WORD *)(a1 + 0x92A) = 1;
        }
        goto LABEL_6;
      }
      if ( *(_DWORD *)(a1 + 0x942) )
      {
        goto LABEL_6;
      }
      *(_WORD *)(a1 + 0x92A) = 2;
      ++*(_WORD *)(a1 + 0x804);
    }
    else if ( v7 <= 3u )
    {
      v5 = *(_DWORD *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x208);
      v6 = *(_DWORD *)(a1 + 0x936);
      *(_DWORD *)(a1 + 0x1E0) = v5;
      if ( v6 == 0xFFFFFFFF )
      {
        goto LABEL_6;
      }
      if ( v5 )
      {
        AIL_set_timer_frequency(v6, v5);
      }
      else
      {
        AIL_stop_timer(v6);
      }
      ++*(_WORD *)(a1 + 0x804);
    }
    else if ( v7 < 0x1Eu )
    {
      if ( v7 != 0xB )
      {
        goto LABEL_23;
      }
      if ( V_SoundSystem.DIG_installed == 0xFFFFFFFF )
      {
        Q_SetVolume_sub_4FF4C(&V_SoundSystem, *(_DWORD *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x20C));
        ++*(_WORD *)(a1 + 0x804);
      }
      else
      {
LABEL_6:
        ++*(_WORD *)(a1 + 0x804);
      }
    }
    else if ( v7 <= 0x1Eu )
    {
      sub_4F8CC(&V_SoundSystem, *(_DWORD *)(a1 + 0xC * *(__int16 *)(a1 + 0x804) + 0x208), v3 ^ v2);
      ++*(_WORD *)(a1 + 0x804);
    }
    else if ( v7 == 0x1F )
    {
      Q_StopSample_sub_4FA1C(&V_SoundSystem);
      ++*(_WORD *)(a1 + 0x804);
    }
    else
    {
LABEL_23:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x80F);
      ++*(_WORD *)(a1 + 0x804);
    }
  }
}

//----- (0002AC84) --------------------------------------------------------
int __fastcall Q_FLIC_CPP_StartTimer_sub_2AC84(int a1, ULONG hertz)
{
  HTIMER v4; // edx
  HTIMER v5; // eax

  *(_DWORD *)(a1 + 0x1E0) = hertz;
  v4 = *(_DWORD *)(a1 + 0x936);
  if ( v4 == 0xFFFFFFFF )
  {
    v5 = AIL_register_timer((AILTIMERCB)callback_fn);
    *(_DWORD *)(a1 + 0x936) = v5;
    if ( v5 == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\flic.cpp", 0x823);
    }
    AIL_set_timer_frequency(*(_DWORD *)(a1 + 0x936), hertz);
    AIL_start_timer(*(_DWORD *)(a1 + 0x936));
  }
  else
  {
    AIL_set_timer_frequency(v4, hertz);
  }
  return (*(_DWORD *)(a1 + 0x936) == 0xFFFFFFFF) - 1;
}

//----- (0002AD08) --------------------------------------------------------
void __fastcall __spoils<> sub_2AD08(P_Type2 a1)
{
  if ( a1->Unknown_90E[3] != 0xFFFFFFFF )
  {
    AIL_stop_timer(a1->Unknown_90E[3]);
    AIL_release_timer_handle(a1->Unknown_90E[3]);
    a1->Unknown_90E[3] = 0xFFFFFFFF;
  }
}

//----- (0002AD40) --------------------------------------------------------
__int16 __cdecl sub_2AD40(unsigned __int16 *a1, int a2, LONG y)
{
  int v4; // ecx
  __int16 *v5; // esi
  __int16 result; // ax
  int v7; // edx
  int v8; // eax
  _BYTE *v9; // esi
  LONG v10; // edx
  char v11; // al
  __int16 *v12; // esi
  int v13; // ecx
  __int16 v14; // ax
  int v15; // edx
  unsigned int v16; // ecx
  __int16 v17; // ax
  UBYTE *v18; // edi
  LONG v19; // edx
  ULONG i; // ecx
  unsigned int j; // ecx
  int v22; // edx
  unsigned int v23; // ecx
  UBYTE *v24; // edi
  ULONG v25; // ecx
  LONG v26; // edx
  int v27; // [esp-2Eh] [ebp-42h]
  int v28; // [esp-2Eh] [ebp-42h]
  LONG v29; // [esp-2Ah] [ebp-3Eh]
  int v30; // [esp-26h] [ebp-3Ah]
  int v31; // [esp-26h] [ebp-3Ah]
  LONG v32; // [esp-22h] [ebp-36h]
  LONG v33; // [esp-22h] [ebp-36h]
  int v34; // [esp-1Eh] [ebp-32h]
  __int16 v35; // [esp-1Eh] [ebp-32h]
  __int16 v36; // [esp-1Ah] [ebp-2Eh]
  ULONG v37; // [esp-1Ah] [ebp-2Eh]
  int v38; // [esp-16h] [ebp-2Ah]
  unsigned int v39; // [esp-16h] [ebp-2Ah]
  __int16 v40; // [esp-12h] [ebp-26h]
  int v41; // [esp-10h] [ebp-24h]
  ULONG v42; // [esp+4h] [ebp-10h] BYREF
  UBYTE *v43; // [esp+8h] [ebp-Ch] BYREF
  ULONG nbytes; // [esp+Ch] [ebp-8h] BYREF
  UBYTE *addr; // [esp+10h] [ebp-4h] BYREF

  v4 = *a1;
  v5 = (__int16 *)(a1 + 1);
  do
  {
    while ( 1 )
    {
      result = *v5++;
      if ( result > 0 )
      {
        break;
      }
      if ( (result & 0x4000) != 0 )
      {
        LOWORD(y) = y - result;
      }
    }
    v7 = a2;
    v41 = v4;
    do
    {
      v40 = result;
      v8 = *(unsigned __int8 *)v5;
      v9 = (char *)v5 + 1;
      v10 = v8 + v7;
      v11 = *v9;
      v12 = (__int16 *)(v9 + 1);
      if ( (v11 & 0x80) != 0 )
      {
        v13 = -v11;
        v14 = *v12;
        v5 = v12 + 1;
        v36 = v14;
        v34 = 2 * v13;
        VFX_line_address(v10, y, &addr, &nbytes);
        v15 = v27;
        v16 = v34;
        v17 = v36;
        v18 = addr;
        if ( v34 > (int)nbytes )
        {
          v37 = v34 - nbytes;
          v19 = nbytes + v27;
          for ( i = nbytes >> 1; i; --i )
          {
            *(_WORD *)v18 = v17;
            v18 += 2;
          }
          v35 = v17;
          VFX_line_address(v19, v29, &addr, &nbytes);
          v15 = v28;
          v17 = v35;
          v16 = v37;
          v18 = addr;
        }
        v7 = v16 + v15;
        for ( j = v16 >> 1; j; --j )
        {
          *(_WORD *)v18 = v17;
          v18 += 2;
        }
      }
      else
      {
        v38 = 2 * v11;
        VFX_line_address(v10, y, &v43, &v42);
        v22 = v30;
        y = v32;
        v23 = v38;
        v24 = v43;
        if ( v38 > (int)v42 )
        {
          v39 = v38 - v42;
          v25 = v42;
          v26 = v42 + v30;
          qmemcpy(v43, v12, v42);
          v12 = (__int16 *)((char *)v12 + v25);
          VFX_line_address(v26, v32, &v43, &v42);
          v22 = v31;
          y = v33;
          v23 = v39;
          v24 = v43;
        }
        v7 = v23 + v22;
        qmemcpy(v24, v12, v23);
        v5 = (__int16 *)((char *)v12 + v23);
      }
      result = v40 - 1;
    }
    while ( v40 != 1 );
    LOWORD(y) = y + 1;
    v4 = v41 - 1;
  }
  while ( v41 != 1 );
  return result;
}
// 2ADAB: variable 'v27' is possibly undefined
// 2ADD3: variable 'v29' is possibly undefined
// 2ADD9: variable 'v28' is possibly undefined
// 2AE00: variable 'v30' is possibly undefined
// 2AE01: variable 'v32' is possibly undefined
// 2AE29: variable 'v31' is possibly undefined
// 2AE2A: variable 'v33' is possibly undefined

//----- (0002AE48) --------------------------------------------------------
int __cdecl Q_NC_sub_2AE48(unsigned __int16 a1)
{
  while ( MEMORY[0x46C] <= a1 )
  {
    ;
  }
  return MEMORY[0x46C];
}
// 2AE48: could not find valid save-restore pair for edi

//----- (0002AE69) --------------------------------------------------------
__int16 Q_NC_sub_2AE69()
{
  __int16 result; // ax

  result = 0x1510;
  __asm { int     23h; DOS - CONTROL "C" EXIT ADDRESS }
  return result;
}

//----- (0002AE80) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd1FLICCtor_sub_2AE80(P_Wnd1FLIC a1)
{
  Q_A2Ctor_sub_2C830(&a1->a);
  sub_28C74(&a1->b);
  a1->a.pProcs = (P_Procs)off_95CB4;
  a1->b.dword936 = 1;
}
// 95CB4: using guessed type int (*off_95CB4[2])();

//----- (0002AEB0) --------------------------------------------------------
P_Wnd1FLIC __fastcall Q_Wnd1FLICDtor_sub_2AEB0(P_Wnd1FLIC a1, char a2)
{
  char *v4; // eax
  P_Wnd1FLIC v6; // ebx

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd1FLIC);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->a.pProcs = (P_Procs)off_95CB4;
    sub_28DA4(&a1->b);
    Q_A2Dtor_sub_2C848(&a1->a, 1);
    v6 = a1;
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return v6;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95CB4: using guessed type int (*off_95CB4[2])();

//----- (0002AF04) --------------------------------------------------------
UBYTE *__fastcall sub_2AF04(int a1, const char *a2)
{
  UBYTE *v2; // ecx

  v2 = sub_28EB4(a1 + 0xAB, a2, (int)WinMgr.window->buffer, 0xFFFFFFFF, 0xFFFFFFFF);
  if ( !v2 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flicwin.cpp", 0x4E);
  }
  return v2;
}

//----- (0002AF3C) --------------------------------------------------------
int __fastcall sub_2AF3C(int a1)
{
  signed int size; // esi
  int v4; // ebx
  unsigned int v5; // ebx

  size = *(__int16 *)(a1 + 0xA01) << 0x14;
  if ( size <= WinMgr.cache.size )
  {
    v4 = *(__int16 *)(a1 + 0xA03);
    if ( v4 == 0xFFFFFFFF )
    {
      size = WinMgr.cache.size;
      v5 = WinMgr.cache.size;
    }
    else
    {
      v5 = v4 << 0x14;
    }
    sub_1B4D0(&WinMgr.cache);
    return sub_29038(a1 + 0xAB, size, v5, *(__int16 *)(a1 + 0xA05) << 0xA, *(__int16 *)(a1 + 0xA07) << 0xA, (int)WinMgr.cache.pShapeCache);
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\flicwin.cpp", 0x67);
    return 0;
  }
}

//----- (0002AFF0) --------------------------------------------------------
int __fastcall sub_2AFF0(int a1, __int16 a2, LONG a3, LONG a4)
{
  __int16 v6; // dx
  __int16 v7; // bx
  int result; // eax
  __int16 i; // cx
  T_Palette blackpal; // [esp+0h] [ebp-31Ch] BYREF
  int v11; // [esp+300h] [ebp-1Ch]
  int v12; // [esp+304h] [ebp-18h]
  int v13; // [esp+308h] [ebp-14h]
  char v14; // [esp+30Ch] [ebp-10h]

  LOWORD(v13) = a2;
  v11 = a1 + 0xAB;
  switch ( a2 )
  {
    case 1:
      v12 = 0;
      *(_DWORD *)(a1 + 0x247) = 0xFFFFFFFF;
      *(_WORD *)(a1 + 0x9F7) = 0;
      *(_DWORD *)(a1 + 0x9F9) = 0;
      *(_DWORD *)(a1 + 0x9FD) = 0;
      MOUSE_hide();
      dword_132B60 = 0;
      if ( sub_2AF3C(a1) )
      {
        Q_StopSample_sub_4FA1C(&V_SoundSystem);
        Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v13, a3, a4);
        sub_56400(&WinMgr, *(_DWORD *)(a1 + 0x41), 0xA, 0, 0, 0);
        Q_FLIC_CPP_StartTimer_sub_2AC84(v11, 0x12u);
      }
      else
      {
        sub_1ACE8(&WinMgr.cache);
        MOUSE_show();
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, *(_WORD *)(a1 + 0x45), *(_DWORD *)(a1 + 0x47), *(_DWORD *)(a1 + 0x4B));
      }
      result = v12;
      break;
    case 2:
      sub_2AD08((P_Type2)(a1 + 0xAB));
      v14 = 129;
      for ( i = 0; i < 0x40; ++i )
      {
        sub_2BD04(&V_Type6_stru_D8654, i, 0);
        Q_SetVolume_sub_4FF4C(&V_SoundSystem, v14);
        v14 -= 2;
      }
      Q_StopSample_sub_4FA1C(&V_SoundSystem);
      sub_1ACE8(&WinMgr.cache);
      memset(blackpal, 0, sizeof(blackpal));
      Q_PaletteSet_sub_2C224(&V_Type6_stru_D8654, 0, 0x100, blackpal);
      VFX_area_wipe(0, 0, 639, 479, 0);
      Q_LoadPal_sub_2C158(&V_Type6_stru_D8654, "DATA\\game.pal", 0, 0x100u);
      Q_PaletteSet_sub_2C224(&V_Type6_stru_D8654, 0, 0x100, blackpal);
      dword_132B60 = 0xFFFFFFFF;
      dword_132B64 = 0;
      MOUSE_show();
      Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v13, a3, a4);
      result = v12;
      break;
    case 3:
    case 4:
    case 5:
      goto LABEL_14;
    case 0xA:
      if ( !sub_296B4(a1 + 0xAB, a1 + 0xAB, a3, a4) )
      {
        v6 = *(_WORD *)(a1 + 0x9F7) + 1;
        v7 = *(_WORD *)(a1 + 0x9F5);
        *(_WORD *)(a1 + 0x9F7) = v6;
        if ( v6 < v7 )
        {
          sub_2AF3C(a1);
        }
      }
      if ( *(_WORD *)(a1 + 0x9F7) >= *(_WORD *)(a1 + 0x9F5) )
      {
LABEL_14:
        sub_564C0(&WinMgr, *(_DWORD *)(a1 + 0x41), 0xA);
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, *(_WORD *)(a1 + 0x45), *(_DWORD *)(a1 + 0x47), *(_DWORD *)(a1 + 0x4B));
      }
      v12 = 0xFFFFFFFF;
      result = 0xFFFFFFFF;
      break;
    default:
      result = Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v13, a3, a4);
      break;
  }
  return result;
}
// 132B60: using guessed type int dword_132B60;
// 132B64: using guessed type int dword_132B64;

//----- (0002B2C0) --------------------------------------------------------
void __fastcall __spoils<> Q_Font_Init_sub_2B2C0(P_Font a1)
{
  a1->pVfxFont = 0;
  a1->pane.window = 0;
  sub_2B2FC(a1, 0);
}

//----- (0002B2E0) --------------------------------------------------------
void __fastcall __spoils<> sub_2B2E0(P_Font a1)
{
  if ( a1->pVfxFont )
  {
    Q_RemoveWinDataFromWinMgr_sub_2627C(a1->pVfxFont);
  }
  operator delete(a1->pVfxFont);
}
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002B2FC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_2B2FC(P_Font pFont, const char *aFName)
{
  void *v4; // eax
  int i; // eax

  pFont->pane.window = (WINDOW *)&V_Type6_stru_D8654;
  if ( aFName )
  {
    return sub_2B360((void **)&pFont->pVfxFont, aFName);
  }
  v4 = operator new[](0x100u);
  Q_RegisterData_sub_2625C(v4, 1, "FONT TRANSLATE");
  pFont->pFontTranslate = (BYTE *)v4;
  if ( !v4 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x5D);
  }
  for ( i = 0; i < 256; ++i )
  {
    pFont->pFontTranslate[i] = i;
  }
  return TRUE;
}

//----- (0002B360) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_2B360(void **data, const char *aFName)
{
  void *v4; // eax
  T_CFile v6; // [esp+0h] [ebp-124h] BYREF

  if ( !aFName )
  {
    return TRUE;
  }
  Q_CFile_Ctor_sub_1BB78(&v6);
  if ( !Q_CFile_OpenFile_sub_1BBFC(&v6, aFName, O_BINARY, 0) )
  {
    if ( *data )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(*data);
    }
    operator delete(*data);
    v4 = Q_CFile_Load_sub_1BF1C(&v6, 0);
    *data = v4;
    if ( v4 )
    {
      Q_CFile_Dtor_sub_1BBC8(&v6);
      return TRUE;
    }
  }
  Q_CFile_Dtor_sub_1BBC8(&v6);
  return FALSE;
}
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002B3E0) --------------------------------------------------------
void __fastcall sub_2B3E0(P_Font pFont, int x1, int y1, int x2, int y2)
{
  pFont->pane.x0 = x1;
  pFont->pane.y0 = y1;
  pFont->pane.x1 = x2;
  pFont->pane.y1 = y2;
}

//----- (0002B3F4) --------------------------------------------------------
// Example:
// "Owned by |%d|%s"
// |XXX| -> color fo %s
int __fastcall Q_Font_ParseTextColor_sub_2B3F4(P_Font pFont, char *input, char *output, int update)
{
  char *pcurr; // esi
  char nextchar; // al
  int processedLength; // ecx
  const char *start; // ebp
  _BYTE *v10; // esi
  char v11; // al
  BYTE v13; // bl
  char v14[4]; // [esp+0h] [ebp-14h] BYREF
  P_Font pFont_; // [esp+4h] [ebp-10h]

  pFont_ = pFont;
  pcurr = input;
  // Find the first '|'
  while ( *pcurr != '|' )
  {
    if ( *pcurr )
    {
      nextchar = *++pcurr;
      if ( *pcurr == '|' )
      {
        break;
      }
      ++pcurr;
      if ( nextchar )
      {
        continue;
      }
    }
    pcurr = 0;
    break;
  }
  processedLength = 0;
  if ( pcurr )
  {
    if ( pcurr != input )
    {
      strncpy(output, input, pcurr - input);
      output[pcurr - input] = 0;
      return pcurr - input;
    }
    start = pcurr + 1;
    v10 = pcurr + 1;
    *output = 0;
    // Find the next '|'
    while ( *v10 != '|' )
    {
      if ( *v10 )
      {
        v11 = *++v10;
        if ( *v10 == '|' )
        {
          break;
        }
        ++v10;
        if ( v11 )
        {
          continue;
        }
      }
      v10 = 0;
      break;
    }
    if ( v10 )
    {
      processedLength = v10 - start + 2;
      if ( v10 == start )
      {
        strcpy(output, "|");
        return v10 - start + 2;
      }
      if ( update == TRUE )
      {
        strncpy(v14, start, 3u);
        v14[3] = 0;
        v13 = atoi(v14);
        pFont_->pFontTranslate[0xF3] = v13;
        return v10 - start + 2;
      }
    }
    else
    {
      return 1;
    }
  }
  else
  {
    strcpy(output, input);
  }
  return processedLength;
}

//----- (0002B4F4) --------------------------------------------------------
int __fastcall Q_Font_GetTextWidth_sub_2B4F4(P_Font pFont, char *text)
{
  int v3; // edi
  int v4; // kr04_4
  int v6; // [esp+0h] [ebp-20h]
  char *parsedText; // [esp+4h] [ebp-1Ch]
  char *text_; // [esp+8h] [ebp-18h]

  if ( !text )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0xD7);
  }
  if ( !pFont->pVfxFont )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0xD8);
  }
  text_ = text;
  v3 = 0;
  parsedText = strdup(text);
  do
  {
    v6 = Q_Font_ParseTextColor_sub_2B3F4(pFont, text_, parsedText, 0);
    v4 = 0;
    if ( *parsedText )
    {
      do
      {
        v3 += VFX_character_width(pFont->pVfxFont, (unsigned __int8)parsedText[v4++]);
      }
      while ( parsedText[v4] );
    }
    text_ += v6;
  }
  while ( v6 > 0 );
  free(parsedText);
  return v3;
}

//----- (0002B594) --------------------------------------------------------
LONG __fastcall Q_Font_GetHeight_sub_2B594(P_Font pFont)
{
  if ( !pFont->pVfxFont )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x104);
  }
  return VFX_font_height(pFont->pVfxFont);
}

//----- (0002B5BC) --------------------------------------------------------
int __fastcall sub_2B5BC(int *a1, char *a2)
{
  LONG Height_sub_2B594; // esi
  int TextWidth_sub_2B4F4; // edx
  int v5; // ecx
  int v6; // ebx

  Height_sub_2B594 = Q_Font_GetHeight_sub_2B594((P_Font)a1);
  TextWidth_sub_2B4F4 = Q_Font_GetTextWidth_sub_2B4F4((P_Font)a1, a2);
  v5 = a1[6] - a1[4] - Height_sub_2B594;
  v6 = a1[5] - a1[3] - TextWidth_sub_2B4F4;
  if ( v5 >= 0 && v6 >= 0 )
  {
    return (v6 >> 1) + (v5 >> 1 << 0x10);
  }
  else
  {
    return 0xFFFFFFFF;
  }
}

//----- (0002B610) --------------------------------------------------------
void __fastcall Q_Font_RenderText_sub_2B610(P_Font pFont, LONG xOffset, LONG yOffset, char *text, char flags, __int16 a6, __int16 a7)
{
  __int16 v8; // cx
  LONG fontHeight; // ebx
  LONG textWidth; // edx
  LONG x1; // edi
  LONG v12; // eax
  LONG x0; // edx
  char *parsedText; // esi
  char *text__; // edi
  int TextWidth_sub_2B4F4; // eax
  PANE pane; // [esp+0h] [ebp-38h] BYREF
  int parsedLen; // [esp+14h] [ebp-24h]
  LONG v19; // [esp+18h] [ebp-20h]
  char *text_; // [esp+1Ch] [ebp-1Ch]
  PANE *p_pane; // [esp+20h] [ebp-18h]
  LONG y; // [esp+24h] [ebp-14h]
  LONG x; // [esp+28h] [ebp-10h]

  v19 = xOffset;
  y = yOffset;
  text_ = text;
  v8 = a6;
  if ( !text_ )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x13B);
  }
  if ( !pFont->pVfxFont )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\font.cpp", 0x13C);
  }
  if ( a7 == 0xFFFFFFFF )
  {
    a7 = pFont->_bgcolor;
  }
  if ( a6 == 0xFFFFFFFF )
  {
    v8 = 0xF3;
  }
  if ( v8 != 0xFFFFFFFE )
  {
    pFont->pFontTranslate[0xF3] = v8;
  }
  fontHeight = Q_Font_GetHeight_sub_2B594(pFont);
  pane.window = pFont->pane.window;
  pane.x0 = pFont->pane.x0;
  pane.y0 = pFont->pane.y0;
  pane.x0 += v19;
  pane.y0 += y;
  textWidth = Q_Font_GetTextWidth_sub_2B4F4(pFont, text_) + pane.x0;
  pane.x1 = textWidth;
  pane.y1 = fontHeight + pane.y0;
  x1 = pFont->pane.x1;
  if ( pane.x0 <= x1 )
  {
    v12 = textWidth;
    x0 = pFont->pane.x0;
    if ( v12 >= x0 && pane.y0 <= pFont->pane.y1 && pane.y1 >= pFont->pane.y0 )
    {
      if ( x0 <= pane.x0 )
      {
        if ( x1 < pane.x1 )
        {
          pane.x1 = pFont->pane.x1;
        }
      }
      else
      {
        pane.x0 = pFont->pane.x0;
      }
      if ( pane.y0 >= pFont->pane.y0 )
      {
        if ( pane.y1 > pFont->pane.y1 )
        {
          pane.y1 = pFont->pane.y1;
        }
      }
      else
      {
        pane.y0 = pFont->pane.y0;
      }
      if ( a7 != 0xFF )
      {
        VFX_pane_wipe(&pane, a7);
      }
      parsedText = strdup(text_);
      x = v19;
      text__ = text_;
      p_pane = &pFont->pane;
      do
      {
        parsedLen = Q_Font_ParseTextColor_sub_2B3F4(pFont, text__, parsedText, TRUE);
        if ( *parsedText )
        {
          VFX_string_draw(p_pane, x, y, pFont->pVfxFont, parsedText, (UBYTE *)pFont->pFontTranslate);
        }
        TextWidth_sub_2B4F4 = Q_Font_GetTextWidth_sub_2B4F4(pFont, parsedText);
        text__ += parsedLen;
        x += TextWidth_sub_2B4F4;
      }
      while ( parsedLen > 0 );
      free(parsedText);
      if ( (flags & 0xC0) == 0 )
      {
        Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
      }
    }
  }
}

//----- (0002B804) --------------------------------------------------------
void __fastcall Q_NC_sub_2B804(LONG *a1, int a2)
{
  LONG v3; // ecx

  Q_WinMgr_WipeAndAddDirtyArea_sub_55214(&WinMgr, a1[3], a1[4], a1[5], a1[6]);
  v3 = a1[6] - a2;
  a1[4] -= a2;
  a1[6] = v3;
}

//----- (0002B838) --------------------------------------------------------
LONG __fastcall Q_NC_sub_2B838(int a1, __int16 a2, __int16 a3)
{
  PANE *v4; // ebp
  int i; // kr04_4
  LONG result; // eax

  v4 = (PANE *)(a1 + 8);
  for ( i = 0; ; ++i )
  {
    result = a3 + a2;
    if ( a2 + i >= result )
    {
      break;
    }
    VFX_character_draw(v4, 1, 1, *(void **)a1, a2 + i, 0);
    VFX_pane_refresh(v4, *(_DWORD *)(a1 + 0xC), *(_DWORD *)(a1 + 0x10), *(_DWORD *)(a1 + 0x14), *(_DWORD *)(a1 + 0x18));
    getch();
  }
  return result;
}

//----- (0002B8A8) --------------------------------------------------------
// Renders formatted text within a specified area, with word wrapping and alignment options
// Returns total height of the rendered text in pixels
int __fastcall Q_Font_DrawFormattedText_sub_2B8A8(
        P_Font pFont,
        int xOffset,
        int yOffset,
        const char *text,
        __int16 flags,
        WORD bgColor,
        WORD wipeColor,
        int maxWidth)
{
  WORD actualWipeColor; // ax
  char *currentLineStart; // ebp
  char *currentPos; // ebx
  char *lastSpacePos; // ecx
  unsigned int endOfText; // edi
  int lineWidth; // eax
  int verticalPos; // eax
  int heightAdjust; // edx
  char *lineText; // ebp
  int lineWidth_; // edx
  int horizontalPos; // edx
  int totalHeight; // [esp+0h] [ebp-40h]
  int currentY; // [esp+4h] [ebp-3Ch]
  char *textCopy; // [esp+Ch] [ebp-34h]
  int lineNum; // [esp+14h] [ebp-2Ch]
  int lineHeight; // [esp+18h] [ebp-28h]
  int lineCount; // [esp+20h] [ebp-20h]
  char tempChar; // [esp+30h] [ebp-10h]

  // Handle pane wiping (background clearing) if specified in flags
  if ( (flags & 0x80) != 0 && wipeColor != 0xFF )
  {
    actualWipeColor = wipeColor;
    if ( wipeColor == -1u )
    {
      actualWipeColor = pFont->_bgcolor;
    }
    VFX_pane_wipe(&pFont->pane, actualWipeColor);
  }
  // Set default background color if none specified
  if ( bgColor == 0xFFFFFFFF )
  {
    LOBYTE(bgColor) = 0xF3;
  }
  pFont->pFontTranslate[0xF3] = bgColor;
  // Calculate maximum width if not specified
  if ( maxWidth < 1 )
  {
    maxWidth = pFont->pane.x1 - pFont->pane.x0;        // Use pane width
  }
  // Create working copy of the text
  textCopy = strdup(text);
  currentLineStart = textCopy;
  currentPos = textCopy;
  lastSpacePos = textCopy;                             // Track last space for word wrapping
  lineCount = 1;                                       // Start with at least one line
  // Word wrapping processing loop
  endOfText = 0;
  do
  {
    if ( !*currentPos )                                // Check for end of string
    {
      endOfText = 0xFFFFFFFF;
    }
    // Temporarily null-terminate to measure line width
    tempChar = *currentPos;
    *currentPos = 0;
    lineWidth = Q_Font_GetTextWidth_sub_2B4F4(pFont, currentLineStart);
    *currentPos = tempChar;
    if ( tempChar == '\n' )                            // Handle explicit newline
    {
      *currentPos = 0;                                 // Terminate current line
      currentLineStart = ++currentPos;                 // Start new line
      ++lineCount;
    }
    else if ( lineWidth <= maxWidth || lastSpacePos <= currentLineStart )
    {
      // Handle word wrapping
      if ( *currentPos == ' ' )
      {
        lastSpacePos = currentPos;                     // Remember last space position
      }
      ++currentPos;
    }
    else
    {
      // Wrap at last space position
      currentLineStart = lastSpacePos + 1;
      *lastSpacePos = 0;                               // Terminate line at space
      currentPos = lastSpacePos + 1;
      ++lineCount;
    }
  }
  while ( !endOfText );
  // Calculate line height and total text height
  lineHeight = Q_Font_GetHeight_sub_2B594(pFont) + 2;  // Font height + padding
  totalHeight = lineCount * lineHeight;
  // Calculate vertical position based on flags
  if ( (flags & 0x10) != 0 )                           // Top alignment
  {
    verticalPos = yOffset - totalHeight;
  }
  else
  {
    heightAdjust = totalHeight + 1;
    if ( (flags & 1) != 0 )                            // Middle vertical alignment
    {
      verticalPos = (pFont->pane.y1 - pFont->pane.y0 - heightAdjust) / 2;
    }
    else
    {
      if ( (flags & 4) != 0 )
      {
        currentY = yOffset - heightAdjust / 2;         // Center relative to yOffset
        goto RENDER_LINES;
      }
      verticalPos = yOffset;                           // Default to top at yOffset
    }
  }
  currentY = verticalPos;
RENDER_LINES:
  // Render each line of text
  lineText = textCopy;
  for ( lineNum = 0; lineNum < lineCount; ++lineNum )
  {
    lineWidth_ = Q_Font_GetTextWidth_sub_2B4F4(pFont, lineText);
    // Calculate horizontal position based on flags
    if ( (flags & 0x20) != 0 )                         // Right alignment
    {
      horizontalPos = xOffset - lineWidth_;
    }
    else if ( (flags & 2) != 0 )                       // Center alignment
    {
      horizontalPos = (pFont->pane.x1 - pFont->pane.x0 - lineWidth_) / 2;
    }
    else if ( (flags & 8) != 0 )                       // Center relative to xOffset
    {
      horizontalPos = xOffset - lineWidth_ / 2;
    }
    else
    {
      horizontalPos = xOffset;                         // Default left alignment
    }
    // Render the current line
    Q_Font_RenderText_sub_2B610(pFont, horizontalPos, currentY, lineText, flags, 0xFFFFFFFE, wipeColor);
    // Move to next line
    lineText += strlen(lineText) + 1;
    currentY += lineHeight;
  }
  // Update pane if wipe was performed
  if ( (flags & 0x80) != 0 )
  {
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pFont->pane);
  }
  // Clean up and return total height
  free(textCopy);
  return lineCount * lineHeight;
}
// 2B8A8: could not find valid save-restore pair for ebx

//----- (0002BB50) --------------------------------------------------------
void sub_2BB50()
{
  _wcpp_2_mod_register_(&dword_96780);
  Q_Type6Ctor_sub_2BD4C(&V_Type6_stru_D8654);
  dword_96788 = 1;
}
// 96780: using guessed type _DWORD dword_96780;
// 96788: using guessed type int dword_96788;

//----- (0002BB74) --------------------------------------------------------
void __fastcall Q_Pane_CopyOrDrawRectangle_sub_2BB74(PANE *pPane, LONG x0, LONG yTop, LONG x1, LONG yBottom, UBYTE color, int copy)
{
  PANE source; // [esp+0h] [ebp-20h] BYREF
  LONG x1_; // [esp+14h] [ebp-Ch]
  LONG yTop_; // [esp+18h] [ebp-8h]
  LONG x0_; // [esp+1Ch] [ebp-4h]

  x0_ = x0;
  yTop_ = yTop;
  x1_ = x1;
  if ( copy == TRUE )
  {
    source.window = pPane->window;
    source.x0 = x0_;
    source.y1 = yBottom;
    source.x1 = x1;
    source.y0 = yTop;
    VFX_pane_copy(&source, 0, 0, pPane, x0_, yTop, color);
  }
  else
  {
    VFX_line_draw(pPane, x0_, yTop, x1, yTop, LD_DRAW, color);// Top
    VFX_line_draw(pPane, x0_, yBottom, x1_, yBottom, LD_DRAW, color);// Bottom
    VFX_line_draw(pPane, x0_, yTop_, x0_, yBottom, LD_DRAW, color);// Left
    VFX_line_draw(pPane, x1_, yTop_, x1_, yBottom, LD_DRAW, color);// Right
  }
}
// 2BB74: could not find valid save-restore pair for ebx

//----- (0002BC40) --------------------------------------------------------
void __fastcall Q_GSYSTEM_CPP_sub_2BC40(PANE *pane, void *shape_table, LONG shape_number, int *hotX, int *hotY)
{
  int v6; // ebx
  int v7; // eax
  int v8; // eax
  RECT r; // [esp+0h] [ebp-18h] BYREF
  LONG v10; // [esp+10h] [ebp-8h]
  void *v11; // [esp+14h] [ebp-4h]

  v11 = shape_table;
  v10 = shape_number;
  if ( !pane )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x40);
  }
  if ( !v11 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x41);
  }
  VFX_shape_visible_rectangle(v11, v10, 0, 0, 0, &r);
  v6 = r.y1 - r.y0;
  v7 = pane->x1 - pane->x0 - (r.x1 - r.x0);
  *hotX = v7;
  if ( v7 )
  {
    *hotX = v7 / 2;
  }
  v8 = pane->y1 - pane->y0 - v6;
  *hotY = v8;
  if ( v8 )
  {
    *hotY = v8 / 2;
  }
  *hotX -= r.x0;
  *hotY -= r.y0;
}

//----- (0002BCF4) --------------------------------------------------------
void __fastcall sub_2BCF4(int a1, unsigned __int8 a2)
{
  sub_2BD04(&V_Type6_stru_D8654, a2, 0);
}

//----- (0002BD04) --------------------------------------------------------
void __fastcall sub_2BD04(P_Type6 a1, char a2, char *a3)
{
  char v4; // dh
  int i; // kr04_4
  char v6; // dl
  char v7; // dl
  char v8; // dl
  char v9; // [esp+0h] [ebp-14h]
  char v10; // [esp+1h] [ebp-13h]
  char v11; // [esp+2h] [ebp-12h]

  if ( !a2 )
  {
    Q_PaletteGet_sub_2C2B0(a1, 0, 0x100, a1->palette1);
  }
  if ( a3 )
  {
    v9 = *a3;
    v10 = a3[1];
    v11 = a3[2];
  }
  else
  {
    v9 = 0;
    v10 = 0;
    v11 = 0;
  }
  v4 = 0x40 - a2;
  if ( (char)(0x40 - a2) < 0 )
  {
    v4 = 0;
  }
  for ( i = 0; i != 0x100; ++i )
  {
    v8 = a1->palette1[i].r - v9;
    if ( v8 >= 0 )
    {
      if ( (char)(v8 - v4) > 0 )
      {
        --a1->palette1[i].r;
      }
    }
    else if ( (char)(v4 + v8) < 0 )
    {
      ++a1->palette1[i].r;
    }
    v6 = a1->palette1[i].g - v10;
    if ( v6 >= 0 )
    {
      if ( (char)(v6 - v4) > 0 )
      {
        --a1->palette1[i].g;
      }
    }
    else if ( (char)(v4 + v6) < 0 )
    {
      ++a1->palette1[i].g;
    }
    v7 = a1->palette1[i].b - v11;
    if ( v7 >= 0 )
    {
      if ( (char)(v7 - v4) > 0 )
      {
        --a1->palette1[i].b;
      }
    }
    else if ( (char)(v4 + v7) < 0 )
    {
      ++a1->palette1[i].b;
    }
  }
  Q_PaletteSet_sub_2C224(a1, 0, 0x100, a1->palette1);
}

//----- (0002BD4C) --------------------------------------------------------
void __fastcall Q_Type6Ctor_sub_2BD4C(P_Type6 a1)
{
  a1->window.buffer = 0;
  a1->pane.window = 0;
  *(_DWORD *)&a1->fname[0xFF] = 0;
  a1->fname[0] = 0;
  a1->hazeTables = 0;
  a1->numTables = 0;
}

//----- (0002BD7C) --------------------------------------------------------
T_Type6 *__fastcall Q_Type6Dtor_sub_2BD7C(T_Type6 *a1)
{
  Q_StopVideoSystem_sub_2C6CC(a1);
  return a1;
}

//----- (0002BD88) --------------------------------------------------------
unsigned int __fastcall sub_2BD88(P_Type6 a1, const char *a2, const char *a3, int a4)
{
  char *v5; // edx
  void *v6; // esi
  unsigned int result; // eax
  UBYTE *buffer; // ecx
  UBYTE *v9; // eax
  int a; // eax
  int b; // eax
  int v12; // eax
  int v13; // eax
  UBYTE *v14; // edi
  char *fname; // [esp-4h] [ebp-234h]
  T_CFile v16; // [esp+0h] [ebp-230h] BYREF
  char v17[256]; // [esp+118h] [ebp-118h] BYREF
  const char *v18; // [esp+218h] [ebp-18h]
  void *drvr; // [esp+21Ch] [ebp-14h]

  v18 = a2;
  fname = a1->fname;
  v5 = strcpy(a1->fname, a2) + 0x30;
  strcat(fname, "\\");
  if ( a3 )
  {
    strcat(fname, a3);
  }
  else
  {
    strcpy(v17, v18);
    a3 = (const char *)0x200;
    strcat(v17, "\\VFXSCAN.DLL");
    Q_CFile_Ctor_sub_1BB78(&v16);
    Q_CFile_OpenFile_sub_1BBFC(&v16, v17, 0x200, 0);
    v6 = Q_CFile_Load_sub_1BF1C(&v16, 0);
    if ( !v6 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x9F);
    }
    Q_CFile_Dtor_sub_1BBC8(&v16);
    drvr = DLL_load(v6, 5u, 0);
    Q_RemoveWinDataFromWinMgr_sub_2627C(v6);
    v5 = (char *)drvr;
    operator delete(v6);
    if ( !v5 )
    {
      return 0;
    }
    a4 = 0;
    strcat(a1->fname, VFX_driver_name(v5));
    free(drvr);
  }
  result = Q_GSYSTEM_CPP_sub_2BFDC(a1, (int)v5, (int)a3, a4);
  if ( result )
  {
    VFX_init_driver();
    buffer = a1->window.buffer;
    *(_DWORD *)&a1->fname[0xFF] = 0xFFFFFFFF;
    if ( buffer )
    {
      sub_262CC(buffer);
    }
    v9 = (UBYTE *)sub_262B0(a1->b * a1->a, 1u, 1, "OFFSCREEN BUFFER");
    a1->window.stencil = 0;
    a1->window.buffer = v9;
    a = a1->a;
    a1->window.shadow = 0;
    a1->window.x_max = a - 1;
    b = a1->b;
    a1->pane.x0 = 0;
    a1->window.y_max = b - 1;
    v12 = a1->a;
    a1->pane.y0 = 0;
    a1->pane.x1 = v12 - 1;
    v13 = a1->b;
    a1->pane.window = &a1->window;
    v14 = a1->window.buffer;
    a1->pane.y1 = v13 - 1;
    if ( !v14 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0xD9);
    }
    return 0xFFFFFFFF;
  }
  return result;
}
// 2BE8B: conditional instruction was optimized away because esi.4!=0
// 76D64: using guessed type void __fastcall operator delete(void *);
// 2BD88: using guessed type char var_118[256];

//----- (0002BFDC) --------------------------------------------------------
unsigned int __fastcall Q_GSYSTEM_CPP_sub_2BFDC(P_Type6 a1, int a2, int a3, int a4)
{
  void *v5; // esi
  void *v6; // edx
  VFX_DESC *VFX; // eax
  T_CFile v9; // [esp-128h] [ebp-12Ch] BYREF

  Q_CFile_Ctor_sub_1BB78(&v9);
  Q_CFile_OpenFile_sub_1BBFC(&v9, a1->fname, O_BINARY, 0);
  v5 = Q_CFile_Load_sub_1BF1C(&v9, 0);
  if ( !v5 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0xEB);
  }
  Q_CFile_Dtor_sub_1BBC8(&v9);
  v6 = DLL_load(v5, DLLMEM_ALLOC|DLLSRC_MEM, 0);
  Q_RemoveWinDataFromWinMgr_sub_2627C(v5);
  operator delete(v5);
  if ( !v6 )
  {
    return 0;
  }
  VFX_register_driver(v6);
  VFX = VFX_describe_driver();
  a1->a = VFX->scrn_width;
  a1->b = VFX->scrn_height;
  return 0xFFFFFFFF;
}
// 2C02A: conditional instruction was optimized away because esi.4!=0
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002C08C) --------------------------------------------------------
void __fastcall Q_AllocateHazeTables_sub_2C08C(P_Type6 a1, unsigned __int16 numTables)
{
  void *v4; // eax

  v4 = operator new[](numTables << 8);
  Q_RegisterData_sub_2625C(v4, 1, "GSYSTEM HAZE TABLES");
  a1->hazeTables = (T_HazeTables *)v4;
  a1->numTables = numTables;
}

//----- (0002C0C0) --------------------------------------------------------
int __fastcall Q_LoadHazeTables_sub_2C0C0(P_Type6 a1, const char *a2, unsigned __int16 num)
{
  void *v4; // edi
  T_CFile v6; // [esp+0h] [ebp-118h] BYREF

  if ( num >= a1->numTables )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x11F);
  }
  Q_CFile_Ctor_sub_1BB78(&v6);
  Q_CFile_OpenFile_sub_1BBFC(&v6, a2, 0x200, 0);
  v4 = Q_CFile_Load_sub_1BF1C(&v6, (*a1->hazeTables)[num]);
  if ( !v4 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\gsystem.cpp", 0x127);
  }
  Q_CFile_Dtor_sub_1BBC8(&v6);
  return (v4 == 0) - 1;
}

//----- (0002C158) --------------------------------------------------------
unsigned int __fastcall Q_LoadPal_sub_2C158(P_Type6 a1, const char *aFName, int a3, unsigned __int16 a4)
{
  T_CFile v8; // [esp+0h] [ebp-124h] BYREF
  unsigned __int16 from[2]; // [esp+118h] [ebp-Ch]

  *(_DWORD *)from = a3;
  Q_CFile_Ctor_sub_1BB78(&v8);
  Q_CFile_OpenFile_sub_1BBFC(&v8, aFName, O_BINARY, 0);
  if ( !Q_CFile_Load_sub_1BF1C(&v8, a1->palette2) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x13C);
  }
  Q_CFile_Dtor_sub_1BBC8(&v8);
  Q_PaletteSet_sub_2C224(a1, from[0], a4, a1->palette2);
  return 0xFFFFFFFF;
}
// 2C1AD: conditional instruction was optimized away because ecx.4!=0

//----- (0002C1E0) --------------------------------------------------------
unsigned int __fastcall sub_2C1E0(int a1, unsigned __int16 a2, unsigned __int16 a3, unsigned int a4)
{
  unsigned int result; // eax
  int v6; // ebx
  unsigned int v7; // esi
  int i; // kr04_4

  result = a4;
  for ( i = 0; i < a3; ++i )
  {
    v6 = 3 * (i + a2);
    v7 = a4 + 3 * i;
    *(_WORD *)(v6 + a1 + 0x433) = *(_WORD *)v7;
    *(_BYTE *)(v6 + a1 + 0x435) = *(_BYTE *)(v7 + 2);
  }
  return result;
}

//----- (0002C224) --------------------------------------------------------
void __fastcall Q_PaletteSet_sub_2C224(P_Type6 a1, unsigned __int16 from, __int16 count, RGB *palette)
{
  int i; // kr04_4

  VFX_wait_vblank_leading();
  for ( i = 0; from + i < (__int16)(from + count); ++i )
  {
    VFX_DAC_write(from + i, &palette[i]);
  }
}

//----- (0002C264) --------------------------------------------------------
void __fastcall Q_NC_sub_2C264(T_Type6 *a1)
{
  Q_PaletteSet_sub_2C224(a1, 0, 256, a1->palette2);
}

//----- (0002C280) --------------------------------------------------------
void __fastcall Q_NC_sub_2C280(P_Type6 a1, signed __int16 a2, __int16 a3)
{
  Q_PaletteSet_sub_2C224(a1, a2, a3, &a1->palette2[a2]);
}

//----- (0002C2B0) --------------------------------------------------------
void __fastcall Q_PaletteGet_sub_2C2B0(P_Type6 a1, unsigned __int16 from, __int16 count, RGB *palette)
{
  RGB *nextrgb; // edi
  int i; // kr04_4

  nextrgb = palette;
  if ( !palette )
  {
    nextrgb = a1->palette2;
  }
  VFX_wait_vblank_leading();
  for ( i = 0; from + i < (__int16)(from + count); ++i )
  {
    VFX_DAC_read(from + i, &nextrgb[i]);
  }
}

//----- (0002C2F8) --------------------------------------------------------
void __fastcall sub_2C2F8(T_Type6 *a1, char *a2)
{
  int i; // ecx
  unsigned int v4; // eax

  for ( i = 0; i < 0x40; ++i )
  {
    sub_2BD04(a1, i, a2);
    v4 = i;
    delay(v4);
  }
}

//----- (0002C418) --------------------------------------------------------
void __fastcall sub_2C418(P_Type6 a1, int a2, __int16 a3)
{
  __int16 v3; // si
  LONG v4; // [esp-8h] [ebp-10h]
  RGB v5; // [esp+0h] [ebp-8h] BYREF
  int v6; // [esp+4h] [ebp-4h]

  v6 = a2;
  v3 = a2;
  VFX_wait_vblank_leading();
  if ( (__int16)(a3 + a2) > (__int16)a2 )
  {
    do
    {
      VFX_DAC_read(v3, &v5);
      if ( v5.r )
      {
        --v5.r;
      }
      if ( v5.r )
      {
        --v5.r;
      }
      if ( v5.g )
      {
        --v5.g;
      }
      if ( v5.g )
      {
        --v5.g;
      }
      if ( v5.b )
      {
        --v5.b;
      }
      if ( v5.b )
      {
        --v5.b;
      }
      v4 = v3++;
      VFX_DAC_write(v4, &v5);
    }
    while ( v3 < (__int16)(a3 + a2) );
  }
}
// 2C418: using guessed type RGB anonymous_0;

//----- (0002C4C0) --------------------------------------------------------
void __fastcall sub_2C4C0(P_Type6 a1, int a2, int a3)
{
  __int16 i; // si
  RGB v5; // [esp+0h] [ebp-1Ch] BYREF
  int v6; // [esp+4h] [ebp-18h]
  int v7; // [esp+8h] [ebp-14h]

  v6 = a2;
  VFX_wait_vblank_leading();
  v7 = a3 + a2;
  for ( i = a2; i < (__int16)v7; ++i )
  {
    VFX_DAC_read(i, &v5);
    if ( v5.r < a1->palette2[i].r )
    {
      ++v5.r;
    }
    if ( v5.r < a1->palette2[i].r )
    {
      ++v5.r;
    }
    if ( v5.g < a1->palette2[i].g )
    {
      ++v5.g;
    }
    if ( v5.g < a1->palette2[i].g )
    {
      ++v5.g;
    }
    if ( v5.b < a1->palette2[i].b )
    {
      ++v5.b;
    }
    if ( v5.b < a1->palette2[i].b )
    {
      ++v5.b;
    }
    VFX_DAC_write(i, &v5);
  }
}

//----- (0002C5C0) --------------------------------------------------------
void __fastcall Q_NC_sub_2C5C0(T_Type6 *a1)
{
  int i; // ebx
  unsigned int v3; // eax

  for ( i = 0; i < 64; ++i )
  {
    Q_FadePalette_sub_2C5E4(a1, i);
    v3 = i;
    delay(v3);
  }
}

//----- (0002C5E4) --------------------------------------------------------
void __fastcall Q_FadePalette_sub_2C5E4(P_Type6 a1, char a2)
{
  char v3; // dh
  RGB *palette1; // kr00_4
  char v5; // dl
  int v6; // kr04_4

  if ( !a2 )
  {
    Q_PaletteGet_sub_2C2B0(a1, 0, 256, a1->palette1);
  }
  v3 = 64 - a2;
  palette1 = a1->palette1;
  v6 = 0;
  do
  {
    v5 = *(&palette1->r + v6) - *(&a1->palette2[0].r + v6);
    if ( v5 >= 0 )
    {
      if ( (char)(v5 - v3) > 0 )
      {
        --*(&palette1->r + v6);
      }
    }
    else if ( (char)(v3 + v5) < 0 )
    {
      ++*(&palette1->r + v6);
    }
    ++v6;
  }
  while ( (RGB *)((char *)palette1 + v6) != a1->palette2 );
  Q_PaletteSet_sub_2C224(a1, 0, 256, a1->palette1);
}

//----- (0002C670) --------------------------------------------------------
void __fastcall sub_2C670(int a1, int a2, int a3, char *a4)
{
  RGB *v4; // edi
  __int16 v5; // si
  char v6[4]; // [esp+0h] [ebp-14h] BYREF
  int v7; // [esp+4h] [ebp-10h]
  int v8; // [esp+8h] [ebp-Ch]

  v8 = a2;
  v4 = (RGB *)a4;
  if ( !a4 )
  {
    v4 = (RGB *)v6;
    v6[1] = 0;
    v6[2] = 0;
    v6[0] = 0;
  }
  v5 = v8;
  v7 = a3 + v8;
  VFX_wait_vblank_leading();
  for ( ; v5 < (__int16)v7; ++v5 )
  {
    VFX_DAC_write(v5, v4);
  }
}

//----- (0002C6CC) --------------------------------------------------------
void __fastcall Q_StopVideoSystem_sub_2C6CC(P_Type6 a1)
{
  UBYTE *buffer; // ebx

  if ( *(_DWORD *)&a1->fname[0xFF] == 0xFFFFFFFF )
  {
    VFX_shutdown_driver();
  }
  buffer = a1->window.buffer;
  *(_DWORD *)&a1->fname[0xFF] = 0;
  if ( buffer )
  {
    sub_262CC(buffer);
    a1->window.buffer = 0;
  }
  if ( a1->window.shadow )
  {
    sub_262CC(a1->window.shadow);
    a1->window.shadow = 0;
  }
  Q_RemoveWinDataFromWinMgr_sub_2627C(a1->hazeTables);
  operator delete[](a1->hazeTables);
  a1->hazeTables = 0;
  a1->numTables = 0;
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (0002C744) --------------------------------------------------------
void __fastcall Q_GSYSTEM_CPP_PreloadMouseShp_sub_2C744(P_Type6 a1)
{
  void *v2; // eax
  T_CFile v3; // [esp-124h] [ebp-128h] BYREF

  if ( V_Mouse.initialized )
  {
    if ( !a1->c )
    {
      Q_CFile_Ctor_sub_1BB78(&v3);
      Q_CFile_OpenFile_sub_1BBFC(&v3, "DATA\\MOUSE.SHP", 0x200, 0);
      v2 = Q_CFile_Load_sub_1BF1C(&v3, 0);
      a1->c = (int)v2;
      if ( !v2 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x2B3);
      }
      a1->d = 0;
      Q_CFile_Dtor_sub_1BBC8(&v3);
    }
    MOUSE_set_pointer((void *)a1->c, a1->d);
  }
}

//----- (0002C7D0) --------------------------------------------------------
void __fastcall Q_GSYSTEM_CPP_sub_2C7D0(T_Type6 *a1, int a2, int a3)
{
  void *c; // ecx

  c = (void *)a3;
  if ( !a3 )
  {
    c = (void *)a1->c;
  }
  if ( !c )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x2C7);
  }
  if ( a2 < 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gsystem.cpp", 0x2C8);
  }
  MOUSE_set_pointer(c, a2);
}
// 2C80C: conditional instruction was optimized away because ecx.4!=0

//----- (0002C830) --------------------------------------------------------
void __fastcall __spoils<> Q_A2Ctor_sub_2C830(P_WndA2 a1)
{
  a1->pProcs = &A2_Procs;
  Q_A1_sub_2C8E4(&a1->a1);
}

//----- (0002C848) --------------------------------------------------------
void __fastcall __spoils<edx> Q_A2Dtor_sub_2C848(P_WndA2 a1, char a2)
{
  char *v3; // eax
  T_ChildWindows *children; // edx
  __int16 i; // ax
  P_Wnd v6; // edx
  int parentIndex; // ebx

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_A2);
    operator delete[](v3);
  }
  else
  {
    children = a1->a1.children;
    a1->pProcs = &A2_Procs;
    if ( children )
    {
      for ( i = 0; i < 20; ++i )
      {
        v6 = (*a1->a1.children)[i];
        if ( v6 )
        {
          v6->parentIndex = 0;
        }
      }
      sub_262CC(a1->a1.children);
    }
    parentIndex = a1->a1.parentIndex;
    if ( parentIndex )
    {
      sub_2CA0C(&WinMgr.wnds[parentIndex].pWndA2->a1, &a1->a1, parentIndex);
    }
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002C8E4) --------------------------------------------------------
void __fastcall __spoils<> Q_A1_sub_2C8E4(P_Wnd a1)
{
  a1->index = 0;
  a1->pane.window = 0;
  a1->Unknown_18 = 0xFFFF;
  a1->Unknown_1A = 0;
  a1->shapeFrame = 0xFFFF;
  a1->name[0] = 0;
  a1->Unknown_35 = 0;
  a1->Unknown_39 = 0;
  a1->_mouseFocus = 0;
  a1->Unknown_59 = 0xFFFF;
  a1->_x = 0xFFFF;
  a1->_y = 0xFFFF;
  a1->framed = 0;
  a1->sendMessage = 0;
  a1->sendParam1 = 0;
  a1->sendParam2 = 0;
  a1->helpIndex[0] = 0;
  a1->parentIndex = 0;
  a1->children = 0;
  a1->childrenNum = 0;
  a1->_t19Num = 0;
  a1->Unknown_A3 = 0xFFFFFFFF;
}

//----- (0002C978) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_2C978(P_Wnd a1)
{
  a1->index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, a1);
}

//----- (0002C990) --------------------------------------------------------
unsigned int __fastcall Q_GWINDOW_CPP_LinkChild_sub_2C990(P_Wnd a1, P_Wnd a2)
{
  T_ChildWindows *children; // eax
  WORD childrenNum; // ax

  if ( !a1->childrenNum )
  {
    if ( a1->children )
    {
      sub_262CC(a1->children);
    }
    children = (T_ChildWindows *)Q_Allocate_sub_2628C(0x50u, 1, "CHILD WINDOWS");
    a1->children = children;
    memset(children, 0, sizeof(T_ChildWindows));
  }
  if ( a1->childrenNum >= 20 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x94);
  }
  childrenNum = a1->childrenNum;
  a1->childrenNum = childrenNum + 1;
  (*a1->children)[childrenNum] = a2;
  return 0xFFFFFFFF;
}

//----- (0002CA0C) --------------------------------------------------------
unsigned int __fastcall sub_2CA0C(P_Wnd a1, P_Wnd a2, int a3)
{
  unsigned int v3; // esi
  __int16 i; // kr00_2

  v3 = 0;
  if ( a1->children )
  {
    for ( i = 0; i < 20; ++i )
    {
      if ( a2 == *(P_Wnd *)a3 )
      {
        *(_DWORD *)a3 = 0;
        v3 = 0xFFFFFFFF;
        --a1->childrenNum;
      }
    }
  }
  return v3;
}

//----- (0002CA58) --------------------------------------------------------
int __fastcall Q_NC_sub_2CA58(int a1)
{
  return (*(int (**)(void))(*(_DWORD *)(a1 + 0xA7) + 4))();
}

//----- (0002CA78) --------------------------------------------------------
P_Wnd __fastcall Q_Wnd_Proc2TranslatePane_sub_2CA78(P_Wnd result, WORD xOffset, WORD yOffset)
{
  LONG y0; // edi
  LONG y1; // ebp
  LONG v5; // esi

  y0 = result->pane.y0;
  y1 = result->pane.y1;
  v5 = xOffset + result->pane.x1;
  result->pane.x0 += xOffset;
  result->pane.x1 = v5;
  result->pane.y0 = yOffset + y0;
  result->pane.y1 = yOffset + y1;
  return result;
}

//----- (0002CD24) --------------------------------------------------------
void __fastcall sub_2CD24(unsigned int a1, int a2)
{
  void *ShapeTable_sub_1B084; // eax
  __int16 v3; // ax
  LONG v4; // [esp-18h] [ebp-1Ch]
  LONG v5; // [esp-14h] [ebp-18h]
  LONG v6; // [esp-Ch] [ebp-10h]

  if ( *(_DWORD *)(a1 + 0x39) )
  {
    if ( (WinMgr._wndIndex == *(_DWORD *)(a1 + 0x41) || a2 == 3) && *(_DWORD *)(a1 + 0x3D) && a2 != 2 )
    {
      (*(void (__fastcall **)(unsigned int, int))(*(_DWORD *)(a1 + 0xA7) + 0x10))(a1, a2);
    }
    else
    {
      if ( *(__int16 *)(a1 + 0x1E) == 0xFFFFFFFF )
      {
        if ( *(_WORD *)(a1 + 0xA1) )
        {
          sub_2D0F4((P_Wnd)a1, 0);
        }
        else
        {
          VFX_pane_wipe((PANE *)(a1 + 4), 0xF2);
          WinMgr.LargeFont.pane = *(PANE *)(a1 + 4);
          v3 = 0;
          if ( *(__int16 *)(a1 + 0x5B) == 0xFFFFFFFF )
          {
            v3 = 2;
          }
          if ( *(__int16 *)(a1 + 0x5D) == 0xFFFFFFFF )
          {
            LOBYTE(v3) = v3 | 1;
          }
          Q_Font_DrawFormattedText_sub_2B8A8(
            &WinMgr.LargeFont,
            *(__int16 *)(a1 + 0x5B),
            *(__int16 *)(a1 + 0x5D),
            (const char *)(a1 + 0x20),
            v3,
            0xFFFF,
            0xFF,
            0);
          if ( *(_DWORD *)(a1 + 0x5F) == 0xFFFFFFFF )
          {
            VFX_line_draw((PANE *)(a1 + 4), 0, 0, *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), 0, 0, 0xF3);
            VFX_line_draw((PANE *)(a1 + 4), 0, 0, 0, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), 0, 0xF3);
            v5 = *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC);
            VFX_line_draw((PANE *)(a1 + 4), *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), v5, 0, v5, 0, 0xF3);
            v4 = *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8);
            VFX_line_draw((PANE *)(a1 + 4), v4, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), v4, 0, 0, 0xF3);
          }
        }
      }
      else
      {
        v6 = *(__int16 *)(a1 + 0x1E);
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
        VFX_shape_draw((PANE *)(a1 + 4), ShapeTable_sub_1B084, v6, 0, 0);
      }
      Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, *(_DWORD *)(a1 + 8), *(_DWORD *)(a1 + 0xC), *(_DWORD *)(a1 + 0x10), *(_DWORD *)(a1 + 0x14));
    }
    if ( *(_WORD *)(a1 + 0x6B) )
    {
      sub_2D218((_DWORD *)a1);
    }
  }
}

//----- (0002CF28) --------------------------------------------------------
void __fastcall Q_Wnd_Proc5_sub_2CF28(P_Wnd pWnd, int a2)
{
  PANE *p_pane; // esi
  void *ShapeTable_sub_1B084; // eax
  __int16 v4; // ax
  LONG v5; // [esp-18h] [ebp-1Ch]
  LONG v6; // [esp-14h] [ebp-18h]
  LONG shapeFrame; // [esp-Ch] [ebp-10h]

  p_pane = &pWnd->pane;
  if ( pWnd->shapeFrame == 0xFFFFFFFF )
  {
    if ( pWnd->_t19Num )
    {
      sub_2D0F4(pWnd, 1);
    }
    else
    {
      VFX_pane_wipe(&pWnd->pane, 0x96);
      WinMgr.LargeFont.pane = pWnd->pane;
      v4 = 0;
      if ( pWnd->_x == 0xFFFFFFFF )
      {
        v4 = 2;
      }
      if ( pWnd->_y == 0xFFFFFFFF )
      {
        LOBYTE(v4) = v4 | 1;
      }
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, pWnd->_x, pWnd->_y, pWnd->name, v4, 0xFFFF, 0xFF, 0);
      if ( pWnd->framed == TRUE )
      {
        VFX_line_draw(&pWnd->pane, 0, 0, pWnd->pane.x1 - pWnd->pane.x0, 0, 0, 0xF3);
        VFX_line_draw(&pWnd->pane, 0, 0, 0, pWnd->pane.y1 - pWnd->pane.y0, 0, 0xF3);
        v6 = pWnd->pane.y1 - pWnd->pane.y0;
        VFX_line_draw(&pWnd->pane, pWnd->pane.x1 - pWnd->pane.x0, v6, 0, v6, 0, 0xF3);
        v5 = pWnd->pane.x1 - pWnd->pane.x0;
        VFX_line_draw(&pWnd->pane, v5, pWnd->pane.y1 - pWnd->pane.y0, v5, 0, 0, 0xF3);
      }
    }
  }
  else
  {
    VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapFocus);
    shapeFrame = pWnd->shapeFrame;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->Unknown_18);
    VFX_shape_translate_draw(p_pane, ShapeTable_sub_1B084, shapeFrame, 0, 0);
  }
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, pWnd->pane.x0, pWnd->pane.y0, pWnd->pane.x1, pWnd->pane.y1);
}

//----- (0002D0F4) --------------------------------------------------------
P_Wnd __fastcall sub_2D0F4(P_Wnd pWnd, int a2)
{
  LONG v2; // eax
  PANE *pPane; // esi
  P_Wnd result; // eax
  T_Type19 *t19; // kr00_4
  char *v6; // eax
  int v7; // ebx
  int v8; // edx
  void *ShapeTable_sub_1B084; // eax
  __int16 v10; // [esp-10h] [ebp-30h]
  LONG shapeNumber; // [esp-Ch] [ebp-2Ch]
  LONG hotX; // [esp-8h] [ebp-28h]
  LONG hotY; // [esp-4h] [ebp-24h]
  int i; // [esp+8h] [ebp-18h]

  v2 = 0xF2;
  if ( a2 )
  {
    v2 = 0x96;
  }
  pPane = &pWnd->pane;
  VFX_pane_wipe(&pWnd->pane, v2);
  result = pWnd;
  t19 = pWnd->_t19;
  for ( i = 0; (__int16)i < pWnd->_t19Num; ++i )
  {
    if ( !&t19[i] )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x1CE);
    }
    if ( t19[i].Unknown_0 )
    {
      if ( t19[i].Unknown_0 == 1 )
      {
        hotY = t19[i].hotY;
        hotX = t19[i].hotX;
        shapeNumber = t19[i]._shapeNumber;
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, t19[i].cacheIndex);
        VFX_shape_draw(pPane, ShapeTable_sub_1B084, shapeNumber, hotX, hotY);
      }
      else
      {
        Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x1DF);
      }
    }
    else
    {
      v6 = sub_2D3D0((char *)t19[i].cacheIndex);
      v7 = t19[i].hotY;
      v8 = t19[i].hotX;
      v10 = t19[i]._shapeNumber;
      WinMgr.LargeFont.pane.window = pPane->window;
      WinMgr.LargeFont.pane.x0 = pWnd->pane.x0;
      WinMgr.LargeFont.pane.y0 = pWnd->pane.y0;
      WinMgr.LargeFont.pane.x1 = pWnd->pane.x1;
      WinMgr.LargeFont.pane.y1 = pWnd->pane.y1;
      result = (P_Wnd)Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, v8, v7, v6, v10, 0xF3, 0xFF, 0);
    }
  }
  return result;
}

//----- (0002D218) --------------------------------------------------------
void __fastcall sub_2D218(_DWORD *a1)
{
  __int16 i; // kr00_2
  int v2; // ecx

  if ( *(_DWORD *)((char *)a1 + 0x67) )
  {
    for ( i = 0; i < 0x14; ++i )
    {
      v2 = *a1;
      if ( *a1 )
      {
        a1 = (_DWORD *)*a1;
        if ( *(_DWORD *)(v2 + 0x39) == 0xFFFFFFFF )
        {
          (*(void (__fastcall **)(_DWORD *, _DWORD))(*(_DWORD *)(v2 + 0xA7) + 0xC))(a1, 0);
        }
      }
    }
  }
}

//----- (0002D258) --------------------------------------------------------
void __fastcall sub_2D258(P_WndA2 a1, __int16 a2)
{
  __int16 i; // si
  P_Wnd v4; // ebx

  if ( a1->a1.children )
  {
    for ( i = 0; i < 0x14; ++i )
    {
      v4 = (*a1->a1.children)[i];
      if ( v4 && (v4->Unknown_35 || a2 == 1) )
      {
        (*(void (**)(void))((*a1->a1.children)[i][1].magic12345678 + 8))();
      }
    }
  }
}

//----- (0002D2CC) --------------------------------------------------------
int Q_GWINDOW_CPP_LoadGwshareTxt_sub_2D2CC()
{
  FILE *v0; // ecx
  int i; // kr04_4
  char filename[52]; // [esp+0h] [ebp-34h] BYREF

  v0 = Q_OpenFile_sub_1BB10("gwshare.txt", 0);
  if ( !v0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x214);
  }
  for ( i = 0; i != 0x2D; ++i )
  {
    fscanf(v0, "%s", filename);
    GwshareShpCacheIndexes[i] = Q_Cache_AddFile_sub_1ADAC(&WinMgr.cache, filename);
  }
  return fclose(v0);
}
// 2D2CC: using guessed type char filename[52];

//----- (0002D334) --------------------------------------------------------
int __fastcall sub_2D334(const char *a1)
{
  unsigned int v1; // kr08_4
  int result; // eax

  if ( !a1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x226);
  }
  v1 = strlen(a1) + 1;
  if ( (int)(v1 - 1 + SHIWORD(dword_100302)) >= 0x400 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x229);
  }
  strcpy(&byte_FFF04[SHIWORD(dword_100302)], a1);
  result = SHIWORD(dword_100302);
  HIWORD(dword_100302) += v1;
  return result;
}
// 2D334: could not find valid save-restore pair for edi
// 100302: using guessed type int dword_100302;

//----- (0002D3D0) --------------------------------------------------------
char *__fastcall sub_2D3D0(char *result)
{
  if ( (int)result >= SHIWORD(dword_100302) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x237);
  }
  return result;
}
// 100302: using guessed type int dword_100302;

//----- (0002D400) --------------------------------------------------------
unsigned int __fastcall sub_2D400(int a1, int a2)
{
  unsigned int result; // eax
  __int16 v4; // cx

  if ( *(__int16 *)(a1 + 0xA1) < 4 )
  {
    v4 = *(_WORD *)(a1 + 0xA1);
    *(_WORD *)(a1 + 0xA1) = v4 + 1;
    result = 0xFFFFFFFF;
    *(_DWORD *)(a1 + 0xD * v4 + 0x6D) = *(_DWORD *)a2;
    *(_DWORD *)(a1 + 0xD * v4 + 0x71) = *(_DWORD *)(a2 + 4);
    *(_DWORD *)(a1 + 0xD * v4 + 0x75) = *(_DWORD *)(a2 + 8);
    *(_BYTE *)(a1 + 0xD * v4 + 0x79) = *(_BYTE *)(a2 + 0xC);
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x241);
    return 0;
  }
  return result;
}

//----- (0002D464) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd25TW_Ctor_sub_2D464(P_Wnd25TW a1)
{
  Q_A2Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = &Wnd25TW_Procs;
  Q_Wnd25TW_Init_sub_2D4C4(a1);
}

//----- (0002D480) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd25TW_Dtor_sub_2D480(P_Wnd25TW a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd25TW);
    operator delete[](v3);
  }
  else
  {
    a1->a2.pProcs = &Wnd25TW_Procs;
    Q_A2Dtor_sub_2C848(&a1->a2, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0002D4C4) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd25TW_Init_sub_2D4C4(P_Wnd25TW result)
{
  result->buttonState = 0;
}

//----- (0002D4D0) --------------------------------------------------------
int __fastcall Q_Wnd25TW_Proc3_sub_2D4D0(P_Wnd25TW pWnd25TW, UWORD message, int param1, int param2)
{
  if ( message < 4u
    || message > 5u
    || param1 < pWnd25TW->a2.a1.pane.x0
    || param1 > pWnd25TW->a2.a1.pane.x1
    || param2 < pWnd25TW->a2.a1.pane.y0
    || param2 > pWnd25TW->a2.a1.pane.y1 )
  {
    return Q_WndA2_Proc3_sub_2F424(&pWnd25TW->a2, message, param1, param2);
  }
  pWnd25TW->buttonState = ~pWnd25TW->buttonState;
  pWnd25TW->a2.pProcs->proc5((P_Wnd)pWnd25TW, 0);
  return Q_WndA2_Proc3_sub_2F424(&pWnd25TW->a2, message, param1, param2);
}

//----- (0002D528) --------------------------------------------------------
void __fastcall Q_Wnd25TW_Proc4_sub_2D528(P_Wnd25TW pWnd, int a2)
{
  PANE *p_pane; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v4; // eax
  LONG v5; // eax
  LONG v6; // [esp-18h] [ebp-1Ch]
  LONG v7; // [esp-14h] [ebp-18h]
  LONG shapeFrame; // [esp-Ch] [ebp-10h]
  LONG v9; // [esp-Ch] [ebp-10h]
  T_HazeTable *hazeTableMapFocus; // [esp-4h] [ebp-8h]

  if ( pWnd->a2.a1.Unknown_39 )
  {
    if ( (WinMgr._wndIndex == pWnd->a2.a1.index || a2 == 3) && pWnd->a2.a1._mouseFocus && a2 != 2 )
    {
      pWnd->a2.pProcs->proc5((P_Wnd)pWnd, a2);
    }
    else
    {
      if ( pWnd->a2.a1.shapeFrame == 0xFFFFFFFF )
      {
        v5 = 0xF2;
        if ( pWnd->buttonState == 0xFFFFFFFF )
        {
          v5 = 0x50;
        }
        VFX_pane_wipe(&pWnd->a2.a1.pane, v5);
        WinMgr.LargeFont.pane = pWnd->a2.a1.pane;
        if ( pWnd->a2.a1._x == 0xFFFFFFFF && pWnd->a2.a1._y == 0xFFFFFFFF )
        {
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, pWnd->a2.a1.name, 3, 0xFFFF, 0xFF, 0);
        }
        else
        {
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, pWnd->a2.a1._x, pWnd->a2.a1._y, pWnd->a2.a1.name, 0, 0xFFFF, 0xFF, 0);
        }
        if ( pWnd->a2.a1.framed == 0xFFFFFFFF )
        {
          VFX_line_draw(&pWnd->a2.a1.pane, 0, 0, pWnd->a2.a1.pane.x1 - pWnd->a2.a1.pane.x0, 0, 0, 0xF3);
          VFX_line_draw(&pWnd->a2.a1.pane, 0, 0, 0, pWnd->a2.a1.pane.y1 - pWnd->a2.a1.pane.y0, 0, 0xF3);
          v7 = pWnd->a2.a1.pane.y1 - pWnd->a2.a1.pane.y0;
          VFX_line_draw(&pWnd->a2.a1.pane, pWnd->a2.a1.pane.x1 - pWnd->a2.a1.pane.x0, v7, 0, v7, 0, 0xF3);
          v6 = pWnd->a2.a1.pane.x1 - pWnd->a2.a1.pane.x0;
          VFX_line_draw(&pWnd->a2.a1.pane, v6, pWnd->a2.a1.pane.y1 - pWnd->a2.a1.pane.y0, v6, 0, 0, 0xF3);
        }
      }
      else
      {
        p_pane = &pWnd->a2.a1.pane;
        if ( pWnd->buttonState == 0xFFFFFFFF )
        {
          hazeTableMapFocus = WinMgr.hazeTableMapFocus;
          (*WinMgr.hazeTableMapFocus)[0xF2] = 0x50;
          VFX_shape_lookaside((UBYTE *)hazeTableMapFocus);
          shapeFrame = pWnd->a2.a1.shapeFrame;
          ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.a1.Unknown_18);
          VFX_shape_translate_draw(p_pane, ShapeTable_sub_1B084, shapeFrame, 0, 0);
          (*WinMgr.hazeTableMapFocus)[0xF2] = 0x96;
        }
        else
        {
          v9 = pWnd->a2.a1.shapeFrame;
          v4 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.a1.Unknown_18);
          VFX_shape_draw(p_pane, v4, v9, 0, 0);
        }
      }
      Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, pWnd->a2.a1.pane.x0, pWnd->a2.a1.pane.y0, pWnd->a2.a1.pane.x1, pWnd->a2.a1.pane.y1);
    }
    if ( pWnd->a2.a1.childrenNum )
    {
      sub_2D218(pWnd);
    }
  }
}

//----- (0002D79C) --------------------------------------------------------
void __fastcall Q_Wnd25TW_Proc5_sub_2D79C(P_Wnd25TW pWnd, int a2)
{
  PANE *p_pane; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v4; // eax
  LONG v5; // eax
  LONG v6; // [esp-18h] [ebp-20h]
  LONG v7; // [esp-14h] [ebp-1Ch]
  LONG shapeFrame; // [esp-Ch] [ebp-14h]
  LONG v9; // [esp-Ch] [ebp-14h]
  T_HazeTable *hazeTableMapFocus; // [esp-4h] [ebp-Ch]
  PANE *pane; // [esp+0h] [ebp-8h]

  if ( pWnd->a2.a1.shapeFrame == 0xFFFFFFFF )
  {
    v5 = 0x96;
    if ( pWnd->buttonState == 0xFFFFFFFF )
    {
      v5 = 0xCA;
    }
    pane = &pWnd->a2.a1.pane;
    VFX_pane_wipe(&pWnd->a2.a1.pane, v5);
    WinMgr.LargeFont.pane = pWnd->a2.a1.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, pWnd->a2.a1.name, 3, 0xFFFF, 0xFF, 0);
    if ( pWnd->a2.a1.framed == 0xFFFFFFFF )
    {
      VFX_line_draw(pane, 0, 0, pWnd->a2.a1.pane.x1 - pWnd->a2.a1.pane.x0, 0, 0, 0xF3);
      VFX_line_draw(pane, 0, 0, 0, pWnd->a2.a1.pane.y1 - pWnd->a2.a1.pane.y0, 0, 0xF3);
      v7 = pWnd->a2.a1.pane.y1 - pWnd->a2.a1.pane.y0;
      VFX_line_draw(pane, pWnd->a2.a1.pane.x1 - pWnd->a2.a1.pane.x0, v7, 0, v7, 0, 0xF3);
      v6 = pWnd->a2.a1.pane.x1 - pWnd->a2.a1.pane.x0;
      VFX_line_draw(pane, v6, pWnd->a2.a1.pane.y1 - pWnd->a2.a1.pane.y0, v6, 0, 0, 0xF3);
    }
  }
  else
  {
    p_pane = &pWnd->a2.a1.pane;
    if ( pWnd->buttonState == 0xFFFFFFFF )
    {
      hazeTableMapFocus = WinMgr.hazeTableMapFocus;
      (*WinMgr.hazeTableMapFocus)[0xF2] = 0xCA;
      VFX_shape_lookaside((UBYTE *)hazeTableMapFocus);
      shapeFrame = pWnd->a2.a1.shapeFrame;
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.a1.Unknown_18);
      VFX_shape_translate_draw(p_pane, ShapeTable_sub_1B084, shapeFrame, 0, 0);
      (*WinMgr.hazeTableMapFocus)[0xF2] = 0x96;
    }
    else
    {
      VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapFocus);
      v9 = pWnd->a2.a1.shapeFrame;
      v4 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pWnd->a2.a1.Unknown_18);
      VFX_shape_translate_draw(p_pane, v4, v9, 0, 0);
    }
  }
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, pWnd->a2.a1.pane.x0, pWnd->a2.a1.pane.y0, pWnd->a2.a1.pane.x1, pWnd->a2.a1.pane.y1);
}

//----- (0002D99C) --------------------------------------------------------
void __fastcall Q_Wnd25TW_Proc6_sub_2D99C(P_Wnd25TW pWnd, P_CFile pfi, BOOL read)
{
  int *p_buttonState; // edx

  p_buttonState = &pWnd->buttonState;
  if ( read == 0xFFFFFFFF )
  {
    Q_ReadFile_sub_1BF94(pfi, p_buttonState, 4u);
  }
  else
  {
    Q_CFile_DosWrite_sub_1C098(pfi, p_buttonState, 4u);
  }
}

//----- (0002D9C4) --------------------------------------------------------
void __fastcall __spoils<> Q_A3_sub_2D9C4(P_TypeA3 a1)
{
  Q_A2Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = (P_Procs)&off_95DF0;
  a1->controls = 0;
  a1->numControls = 0;
  a1->e = 0xFFFF;
  Q_A1_sub_2DA60(&a1->a2.a1);
}
// 95DF0: using guessed type int (__fastcall *off_95DF0)(P_WndA2 a1);

//----- (0002D9FC) --------------------------------------------------------
T_WndA2 *__fastcall sub_2D9FC(T_WndA2 *a1, char a2)
{
  char *v4; // eax
  void *magic12345678; // edx

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95D54);
    operator delete[](v4);
    return a1;
  }
  else
  {
    magic12345678 = (void *)a1[1].a1.magic12345678;
    a1->pProcs = (P_Procs)&off_95DF0;
    if ( magic12345678 )
    {
      sub_262CC(magic12345678);
      a1[1].a1.magic12345678 = 0;
    }
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95DF0: using guessed type int (__fastcall *off_95DF0)(P_WndA2 a1);

//----- (0002DA60) --------------------------------------------------------
void __fastcall __spoils<> Q_A1_sub_2DA60(P_Wnd result)
{
  result->Unknown_59 = 7;
}

//----- (0002DA68) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_2DA68(P_Wnd a1)
{
  a1->index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, a1);
}

//----- (0002DA80) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_2DA80(P_TypeA3 a1, __int16 numControls)
{
  MACRO_VFX_BOOL result; // eax

  if ( numControls <= 0 )
  {
    return 0;
  }
  result = (MACRO_VFX_BOOL)sub_262B0(numControls, 0xEu, 1, "CONTROLS");
  a1->controls = (void *)result;
  if ( result )
  {
    result = TRUE;
    a1->numControls = numControls;
  }
  return result;
}

//----- (0002DAC8) --------------------------------------------------------
unsigned int __fastcall sub_2DAC8(P_TypeA3 a1, __int16 a2, __int16 a3, WORD *a4)
{
  int v5; // eax
  char *v6; // edi
  int i; // eax

  for ( i = 0; i < a1->numControls && a2 != *((_WORD *)a1->controls + 7 * i); ++i )
  {
    ;
  }
  if ( i >= a1->numControls )
  {
    return 0;
  }
  v5 = 0xE * i;
  if ( a4 )
  {
    v6 = (char *)a1->controls + v5;
    qmemcpy(v6, a4, 0xCu);
    qmemcpy(v6 + 0xC, a4 + 6, 2u);
  }
  else
  {
    *(_WORD *)((char *)a1->controls + v5 + 0xA) = a3;
  }
  return 0xFFFFFFFF;
}

//----- (0002DB54) --------------------------------------------------------
int __fastcall sub_2DB54(int result, __int16 a2, __int16 a3)
{
  int v4; // edi
  int v5; // ebp
  int v6; // ecx
  __int16 v7; // dx
  int v8; // edx
  int v9; // ebx

  v4 = *(_DWORD *)(result + 0xC);
  v5 = *(_DWORD *)(result + 0x14);
  v6 = a2 + *(_DWORD *)(result + 0x10);
  *(_DWORD *)(result + 8) += a2;
  *(_DWORD *)(result + 0x10) = v6;
  *(_DWORD *)(result + 0xC) = a3 + v4;
  v7 = *(_WORD *)(result + 0xAF);
  *(_DWORD *)(result + 0x14) = a3 + v5;
  v9 = 0;
  if ( v7 > 0 )
  {
    do
    {
      v8 = 0xE * (__int16)v9;
      *(_WORD *)(*(_DWORD *)(result + 0xAB) + v8 + 2) += a2;
      *(_WORD *)(*(_DWORD *)(result + 0xAB) + v8 + 4) += a2;
      *(_WORD *)(*(_DWORD *)(result + 0xAB) + v8 + 6) += a3;
      *(_WORD *)(*(_DWORD *)(result + 0xAB) + v8 + 8) += a3;
      ++v9;
    }
    while ( (__int16)v9 < *(__int16 *)(result + 0xAF) );
  }
  return result;
}

//----- (0002DBE4) --------------------------------------------------------
int __fastcall sub_2DBE4(int a1, int a2, int a3)
{
  int v4; // ecx
  int v5; // eax
  __int16 *v6; // eax
  int v7; // edx
  __int16 *v8; // eax

  v4 = a2;
  v5 = *(__int16 *)(a1 + 0xB1);
  if ( v5 != 0xFFFFFFFF )
  {
    v6 = (__int16 *)(0xE * v5 + *(_DWORD *)(a1 + 0xAB));
    if ( a2 <= v6[2] && a2 >= v6[1] && a3 <= v6[4] && a3 >= v6[3] )
    {
      LOWORD(a2) = *(_WORD *)(a1 + 0xB1);
      return a2;
    }
  }
  v7 = 0;
  if ( *(__int16 *)(a1 + 0xAF) <= 0 )
  {
    return 0xFFFFFFFF;
  }
  while ( 1 )
  {
    v8 = (__int16 *)(*(_DWORD *)(a1 + 0xAB) + 0xE * (__int16)v7);
    if ( v4 <= v8[2] && v4 >= v8[1] && a3 <= v8[4] && a3 >= v8[3] )
    {
      break;
    }
    if ( (__int16)++v7 >= *(__int16 *)(a1 + 0xAF) )
    {
      return 0xFFFFFFFF;
    }
  }
  return v7;
}

//----- (0002DCA0) --------------------------------------------------------
int __fastcall sub_2DCA0(int result, __int16 a2)
{
  int v2; // ecx
  int v4; // edx

  v2 = result;
  if ( a2 != *(_WORD *)(result + 0xB1) )
  {
    if ( a2 >= *(__int16 *)(result + 0xAF) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x396);
    }
    v4 = *(__int16 *)(result + 0xB1);
    if ( v4 != 0xFFFFFFFF )
    {
      result = 7 * v4;
      *(_BYTE *)(*(_DWORD *)(v2 + 0xAB) + 0xE * v4 + 0xA) &= ~2u;
    }
    if ( a2 != 0xFFFFFFFF )
    {
      result = *(_DWORD *)(v2 + 0xAB) + 0xE * a2;
      if ( (*(_WORD *)(result + 0xA) & 1) != 0 )
      {
        *(_BYTE *)(result + 0xA) |= 2u;
      }
    }
    *(_WORD *)(v2 + 0xB1) = a2;
  }
  return result;
}

//----- (0002DD2C) --------------------------------------------------------
int __fastcall Q_NC_sub_2DD2C(int a1, __int16 a2, __int16 a3)
{
  int v4; // esi
  int result; // eax
  __int16 v6; // di

  v4 = *(_DWORD *)(a1 + 0xAB);
  result = 7 * a3;
  v6 = *(_WORD *)(v4 + 0xE * a2 + 0xC);
  *(_WORD *)(v4 + 0xE * a2 + 0xC) = *(_WORD *)(v4 + 0xE * a3 + 0xC);
  *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0xE * a3 + 0xC) = v6;
  return result;
}

//----- (0002DD70) --------------------------------------------------------
int __fastcall sub_2DD70(int a1)
{
  int result; // eax

  for ( result = 0; (__int16)result < V_Game.racesNum; ++result )
  {
    *(_WORD *)(0xE * (__int16)result + *(_DWORD *)(a1 + 0xAB) + 0xC) = 5 * V_Game.races[(__int16)result].Unknown_02 + 0x14;
  }
  return result;
}

//----- (0002DDB8) --------------------------------------------------------
unsigned int __fastcall sub_2DDB8(int a1, __int16 a2)
{
  int v2; // eax

  if ( a2 >= *(__int16 *)(a1 + 0xAF) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x3CD);
  }
  if ( a2 == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x3CE);
  }
  v2 = 0xE * a2 + *(_DWORD *)(a1 + 0xAB);
  if ( (*(_WORD *)(v2 + 0xA) & 1) == 0 )
  {
    return 0;
  }
  if ( (*(_WORD *)(v2 + 0xA) & 4) != 0 )
  {
    *(_BYTE *)(v2 + 0xA) &= ~4u;
  }
  else
  {
    *(_BYTE *)(v2 + 0xA) |= 4u;
  }
  return 0xFFFFFFFF;
}

//----- (0002DE68) --------------------------------------------------------
int __fastcall sub_2DE68(T_TypeA3 *a1, __int16 a2, LONG a3, LONG a4)
{
  int result; // eax
  __int16 v6; // ax
  __int16 v7; // bx
  int Unknown_59; // edx
  int v9; // edi
  unsigned int v10; // ebx
  __int16 i; // [esp+6h] [ebp-Ch]

  switch ( a2 )
  {
    case 1:
      sub_2DD70((int)a1);
      Q_WndA2_Proc3_sub_2F424(&a1->a2, a2, a3, a4);
      goto LABEL_3;
    case 4:
    case 5:
      if ( a3 < a1->a2.a1.pane.x0 || a3 > a1->a2.a1.pane.x1 || a4 < a1->a2.a1.pane.y0 || a4 > a1->a2.a1.pane.y1 )
      {
LABEL_3:
        result = 0;
      }
      else
      {
        v7 = sub_2DBE4((int)a1, a3, a4);
        if ( v7 != 0xFFFFFFFF )
        {
          Unknown_59 = (__int16)a1->a2.a1.Unknown_59;
          if ( Unknown_59 != 0xFFFFFFFF )
          {
            Q_StartSample_sub_4FB90(&V_SoundSystem, Unknown_59);
          }
          v9 = v7;
          sub_2DCA0((int)a1, v7);
          v10 = sub_2DDB8((int)a1, v7);
          ((void (__fastcall *)(T_TypeA3 *, _DWORD, unsigned int))a1->a2.pProcs->proc4_draw)(a1, 0, v10);
          if ( v10 == 0xFFFFFFFF )
          {
            if ( a1->a2.a1.parentIndex )
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(
                &WinMgr,
                a1->a2.a1.parentIndex,
                a1->a2.a1.sendMessage,
                *((__int16 *)a1->controls + 7 * v9),
                0);
            }
          }
        }
        result = 0xFFFFFFFF;
      }
      break;
    case 6:
      sub_567BC(&WinMgr, a1->a2.a1.index, 0xFFFFFFFF);
      result = 0xFFFFFFFF;
      break;
    case 7:
      sub_56728(&WinMgr, a1->a2.a1.index, 4, 8, 0, 0);
      result = 0xFFFFFFFF;
      break;
    case 8:
      v6 = sub_2DBE4((int)a1, a3, a4);
      if ( v6 != a1->e )
      {
        sub_2DCA0((int)a1, v6);
        ((void (*)(void))a1->a2.pProcs->proc4_draw)();
      }
      result = 0xFFFFFFFF;
      break;
    case 9:
      if ( a3 == 0xFFFFFFFF )
      {
        for ( i = 0; i < a1->numControls; ++i )
        {
          sub_2DAC8(a1, 1 << i, a4, 0);
        }
      }
      else
      {
        sub_2DAC8(a1, a3, a4, 0);
      }
      result = 0xFFFFFFFF;
      break;
    default:
      result = Q_WndA2_Proc3_sub_2F424(&a1->a2, a2, a3, a4);
      break;
  }
  return result;
}

//----- (0002E084) --------------------------------------------------------
void __usercall sub_2E084(int a1@<eax>, __int16 a2@<si>)
{
  void *ShapeTable_sub_1B084; // eax
  __int16 *v4; // ecx
  void *v5; // eax
  LONG v6; // [esp-Ch] [ebp-18h]
  LONG v7; // [esp-Ch] [ebp-18h]
  LONG v8; // [esp-8h] [ebp-14h]
  LONG v9; // [esp-4h] [ebp-10h]
  __int16 i; // [esp+8h] [ebp-4h]

  v6 = *(__int16 *)(a1 + 0x1E);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
  VFX_shape_draw((PANE *)(a1 + 4), ShapeTable_sub_1B084, v6, 0, 0);
  for ( i = 0; i < *(__int16 *)(a1 + 0xAF); ++i )
  {
    v4 = (__int16 *)(0xE * i + *(_DWORD *)(a1 + 0xAB));
    switch ( v4[5] )
    {
      case 0:
        a2 = 4;
        break;
      case 1:
        a2 = 0;
        break;
      case 3:
        a2 = 1;
        break;
      case 5:
        a2 = 2;
        break;
      case 7:
        a2 = 3;
        break;
      default:
        Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x48A);
        break;
    }
    v9 = v4[3] - *(_DWORD *)(a1 + 0xC);
    v8 = v4[1] - *(_DWORD *)(a1 + 8);
    v7 = v4[6] + a2;
    v5 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
    VFX_shape_draw((PANE *)(a1 + 4), v5, v7, v8, v9);
  }
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, *(_DWORD *)(a1 + 8), *(_DWORD *)(a1 + 0xC), *(_DWORD *)(a1 + 0x10), *(_DWORD *)(a1 + 0x14));
}

//----- (0002E1B4) --------------------------------------------------------
int __fastcall sub_2E1B4(int a1, unsigned int count, int a3)
{
  if ( a3 == 0xFFFFFFFF )
  {
    return Q_ReadFile_sub_1BF94((P_CFile)count, *(void **)(a1 + 0xAB), 0xE * *(__int16 *)(a1 + 0xAF));
  }
  else
  {
    return Q_CFile_DosWrite_sub_1C098((P_CFile)count, *(void **)(a1 + 0xAB), 0xE * *(__int16 *)(a1 + 0xAF));
  }
}

//----- (0002E208) --------------------------------------------------------
int __fastcall sub_2E208(_DWORD *a1, const char *a2, int a3, int a4)
{
  WORD v4; // bx

  v4 = 0xF2;
  if ( a4 == 0xFFFFFFFF )
  {
    v4 = 0x96;
  }
  WinMgr.LargeFont.pane = *(PANE *)a1;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, a2, 0, 0xFFFF, v4, 0);
}

//----- (0002E248) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd10LBCtor_sub_2E248(T_Wnd10LB *a1)
{
  Q_A2Ctor_sub_2C830(&a1->a);
  a1->a.pProcs = (P_Procs)&off_95DD8;
  Q_A10_sub_2E2B8(a1);
}
// 95DD8: using guessed type int (__fastcall *off_95DD8)(P_Wnd10LB);

//----- (0002E264) --------------------------------------------------------
T_WndA2 *__fastcall sub_2E264(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &stru_95D40);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95DD8;
    sub_2ED4C((P_Wnd10LB)a1);
    sub_2F2B4((int)a1);
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95DD8: using guessed type int (__fastcall *off_95DD8)(P_Wnd10LB);

//----- (0002E2B8) --------------------------------------------------------
void __fastcall Q_A10_sub_2E2B8(P_Wnd10LB a1)
{
  __int16 Height_sub_2B594; // ax

  Q_A1_sub_2C8E4(&a1->a.a1);
  a1->Unknown_AB = 0;
  a1->Unknown_AF = 0;
  a1->Unknown_B3 = 0;
  a1->Unknown_B7 = 0;
  a1->Unknown_BB = 0;
  a1->Unknown_C4 = 0x31;
  a1->Unknown_C5 = 0xF2;
  a1->Unknown_C6 = 0;
  memset(a1->items, 0, sizeof(a1->items));
  a1->itemCount = 0;
  Height_sub_2B594 = Q_Font_GetHeight_sub_2B594(&WinMgr.LargeFont);
  a1->Unknown_8CB = 0;
  a1->Unknown_8CD = 0;
  a1->Unknown_8CF = 0xFFFF;
  a1->Unknown_8E5 = 0;
  a1->Unknown_8E6 = 0;
  a1->Unknown_8EA = 0;
  a1->Unknown_8EE = 0;
  a1->Unknown_8F2 = 0;
  a1->Unknown_8C9 = Height_sub_2B594 + 3;
  a1->Unknown_8F6 = 0;
  Q_Wnd10LB_SetProc1_sub_2F1C8(a1, sub_2E208);
  a1->a.a1.Unknown_18 = GwshareShpCacheIndexes[0x24];
  sub_2E9CC(a1, 1);
}

//----- (0002E3BC) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_2E3BC(P_Wnd a1)
{
  a1->index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, a1);
}

//----- (0002E3D4) --------------------------------------------------------
int __fastcall sub_2E3D4(T_Wnd10LB *a1, __int16 a2, signed int a3, signed int a4)
{
  P_Procs pProcs; // ebx
  int v8; // eax
  int v9; // edx
  __int16 Unknown_8CD; // ax
  int v11; // eax
  int v12; // edx
  unsigned __int16 v13; // dx
  P_Procs v14; // ebx

  if ( (unsigned __int16)a2 < 8u )
  {
    if ( (unsigned __int16)a2 < 4u )
    {
      if ( a2 == 1 )
      {
        sub_2E9CC(a1, a1->Unknown_C3);
        return Q_WndA2_Proc3_sub_2F424(&a1->a, 1u, a3, a4);
      }
      return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
    }
    if ( (unsigned __int16)a2 > 5u )
    {
      if ( (unsigned __int16)a2 <= 6u )
      {
        sub_567BC(&WinMgr, a1->a.a1.index, 0xFFFFFFFF);
        sub_564C0(&WinMgr, a1->a.a1.index, 0xFFFFFFFF);
        a1->Unknown_8CF = 0xFFFF;
        pProcs = a1->a.pProcs;
        a1->Unknown_8E5 = 0;
        pProcs->proc4_draw(&a1->a.a1, 0);
      }
      else
      {
        sub_56728(&WinMgr, a1->a.a1.index, 4, 8, 0, 0);
        sub_2EDC8((int)a1, V_Mouse.x, V_Mouse.y);
      }
      return 0xFFFFFFFF;
    }
LABEL_11:
    if ( a3 < a1->a.a1.pane.x0 || a3 > a1->a.a1.pane.x1 || a4 < a1->a.a1.pane.y0 || a4 > a1->a.a1.pane.y1 )
    {
      return 0;
    }
    if ( a2 == 0xC && a1->a.a1.helpIndex[0] != 0x30 )
    {
      return Q_WndA2_Proc3_sub_2F424(&a1->a, 0xCu, a3, a4);
    }
    sub_2F090((int)a1, a3, a4, a2);
    return 0xFFFFFFFF;
  }
  if ( (unsigned __int16)a2 <= 8u )
  {
    sub_2EDC8((int)a1, a3, a4);
    return 0xFFFFFFFF;
  }
  if ( (unsigned __int16)a2 < 0x191u )
  {
    if ( a2 != 0xC )
    {
      return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
    }
    goto LABEL_11;
  }
  if ( (unsigned __int16)a2 <= 0x191u )
  {
    v8 = sub_56528((int)&WinMgr, a1->a.a1.index, a2);
    if ( v8 != 0xFFFF )
    {
      v9 = 2 * v8 / 3 - 1;
      if ( v9 < 0 )
      {
        v9 = 0;
      }
      sub_56564((int)&WinMgr, a1->a.a1.index, a2, v9);
    }
    Unknown_8CD = a1->Unknown_8CD;
    if ( Unknown_8CD )
    {
      a1->Unknown_8CD = Unknown_8CD - 1;
      a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
    }
    return 0xFFFFFFFF;
  }
  else
  {
    if ( (unsigned __int16)a2 > 0x192u )
    {
      if ( a2 == 0x193 )
      {
        sub_567BC(&WinMgr, a1->a.a1.index, 0x193);
        sub_564C0(&WinMgr, a1->a.a1.index, 0xFFFFFFFF);
        return 0xFFFFFFFF;
      }
      return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
    }
    v11 = sub_56528((int)&WinMgr, a1->a.a1.index, a2);
    if ( v11 != 0xFFFF )
    {
      v12 = 2 * v11 / 3 - 1;
      if ( v12 < 0 )
      {
        v12 = 0;
      }
      sub_56564((int)&WinMgr, a1->a.a1.index, a2, v12);
    }
    v13 = a1->Unknown_8CD;
    if ( v13 < a1->itemCount - (a1->a.a1.pane.y1 - a1->a.a1.pane.y0) / (unsigned __int16)a1->Unknown_8C9 )
    {
      v14 = a1->a.pProcs;
      a1->Unknown_8CD = v13 + 1;
      v14->proc4_draw(&a1->a.a1, 0);
    }
    return 0xFFFFFFFF;
  }
}

//----- (0002E6C0) --------------------------------------------------------
void __fastcall sub_2E6C0(int a1)
{
  LONG v2; // edi
  __int16 v3; // di
  unsigned int v4; // ebp
  unsigned __int16 v5; // ax
  int v6; // ecx
  _DWORD *v7; // ebx
  int v8[2]; // [esp+0h] [ebp-30h] BYREF
  int v9; // [esp+8h] [ebp-28h]
  int v10; // [esp+Ch] [ebp-24h]
  int v11; // [esp+10h] [ebp-20h]
  LONG x1; // [esp+14h] [ebp-1Ch]
  int v13; // [esp+18h] [ebp-18h]

  VFX_pane_wipe((PANE *)(a1 + 4), *(unsigned __int8 *)(a1 + 0xC5));
  x1 = *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8);
  v2 = *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC);
  VFX_line_draw((PANE *)(a1 + 4), 0, 0, x1, 0, 0, *(unsigned __int8 *)(a1 + 0xC4));
  VFX_line_draw((PANE *)(a1 + 4), 0, 0, 0, v2, 0, *(unsigned __int8 *)(a1 + 0xC4));
  VFX_line_draw((PANE *)(a1 + 4), x1, v2, x1, 0, 0, *(unsigned __int8 *)(a1 + 0xC4));
  VFX_line_draw((PANE *)(a1 + 4), x1, v2, 0, v2, 0, *(unsigned __int8 *)(a1 + 0xC4));
  if ( *(_DWORD *)(a1 + 0xB3) == 0xFFFFFFFF )
  {
    sub_2E868(a1, 0);
  }
  v8[1] = *(_DWORD *)(a1 + 8) + 1;
  v9 = *(_DWORD *)(a1 + 0xC) + 1;
  v8[0] = *(_DWORD *)(a1 + 4);
  v10 = *(_DWORD *)(a1 + 0x10) - 1;
  if ( *(_DWORD *)(a1 + 0xB3) == 0xFFFFFFFF )
  {
    v10 -= *(_DWORD *)(a1 + 0xBF);
  }
  v3 = *(_WORD *)(a1 + 0x8CD);
  v4 = 0;
  v13 = a1 + 0xC7;
  while ( v3 < (int)*(unsigned __int16 *)(a1 + 0x8C7) && !v4 )
  {
    v7 = (_DWORD *)(8 * v3 + v13);
    if ( *(_DWORD *)(a1 + 0x8F6) )
    {
      v5 = (*(int (__fastcall **)(_DWORD, _DWORD))(a1 + 0x8F6))(*v7, v7[1]);
    }
    else
    {
      v5 = *(_WORD *)(a1 + 0x8C9);
    }
    v11 = v9 + v5 - 1;
    v6 = *(_DWORD *)(a1 + 0x14);
    if ( v11 >= v6 )
    {
      v4 = 0xFFFFFFFF;
      v11 = v6 - 1;
    }
    (*(void (__fastcall **)(int *, _DWORD, _DWORD, int))(a1 + 0x8FA))(v8, *v7, v7[1], (v3++ != *(_WORD *)(a1 + 0x8CF)) - 1);
    v9 = v11 + 1;
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 4));
}

//----- (0002E868) --------------------------------------------------------
void __fastcall sub_2E868(int a1, int a2)
{
  int v3; // edi
  int v4; // edx
  int v5; // ebx
  LONG v6; // edi
  int v7; // edx
  void *ShapeTable_sub_1B084; // eax
  void *v9; // eax
  LONG v10; // [esp-Ch] [ebp-34h]
  LONG v11; // [esp-Ch] [ebp-34h]
  LONG v12; // [esp-8h] [ebp-30h]
  LONG v13; // [esp-4h] [ebp-2Ch]
  LONG v14; // [esp-4h] [ebp-2Ch]
  PANE v15; // [esp+0h] [ebp-28h] BYREF
  LONG hotX; // [esp+14h] [ebp-14h]
  PANE *pane; // [esp+18h] [ebp-10h]
  int v18; // [esp+1Ch] [ebp-Ch]
  LONG v19; // [esp+20h] [ebp-8h]
  LONG y1; // [esp+24h] [ebp-4h]

  v18 = a2;
  v3 = *(_DWORD *)(a1 + 0x10);
  v4 = *(_DWORD *)(a1 + 8);
  v5 = *(_DWORD *)(a1 + 0xBF);
  y1 = *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC);
  v6 = v3 - v4 - v5;
  VFX_line_draw((PANE *)(a1 + 4), v6, 0, v6, y1, 0, *(unsigned __int8 *)(a1 + 0xC4));
  v7 = *(_DWORD *)(a1 + 0xC) + (*(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC)) / 2;
  v15.window = *(WINDOW **)(a1 + 4);
  v15.x0 = *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 0xBF) + 1;
  v15.x1 = *(_DWORD *)(a1 + 0x10) - 1;
  v15.y0 = *(_DWORD *)(a1 + 0xC) + 1;
  v15.y1 = *(_DWORD *)(a1 + 0x14) - 1;
  v13 = *(unsigned __int8 *)(a1 + 0xC6);
  v19 = v7;
  VFX_pane_wipe(&v15, v13);
  if ( *(unsigned __int8 *)(a1 + 0x8E5) > 1u )
  {
    if ( *(_BYTE *)(a1 + 0x8E5) == 2 )
    {
      v15.y1 = v19;
    }
    else
    {
      v15.y0 = v19;
    }
    VFX_pane_wipe(&v15, 0x96);
  }
  hotX = v6 + 2;
  v10 = *(__int16 *)(a1 + 0x1E);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
  pane = (PANE *)(a1 + 4);
  VFX_shape_draw((PANE *)(a1 + 4), ShapeTable_sub_1B084, v10, v6 + 2, 2);
  v14 = y1 - *(_DWORD *)(a1 + 0xBF) + 2;
  v12 = hotX;
  v11 = *(__int16 *)(a1 + 0x1E) + 1;
  v9 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
  VFX_shape_draw(pane, v9, v11, v12, v14);
  if ( v18 == 0xFFFFFFFF )
  {
    Q_WinMgr_AddDirtyArea_sub_55274(
      &WinMgr,
      v6 + *(_DWORD *)(a1 + 8),
      *(_DWORD *)(a1 + 0xC),
      *(_DWORD *)(a1 + 0x10),
      *(_DWORD *)(a1 + 0x14));
  }
}

//----- (0002E9CC) --------------------------------------------------------
void __fastcall sub_2E9CC(P_Wnd10LB a1, char a2)
{
  LONG shapeFrame; // eax
  void *ShapeTable_sub_1B084; // eax
  unsigned int v5; // eax
  int v6; // edx
  LONG x0; // eax
  LONG x1; // eax
  int Unknown_B3; // ecx
  LONG v10; // [esp-4h] [ebp-10h]

  if ( a2 == 1 )
  {
    a1->a.a1.shapeFrame = 0;
  }
  else
  {
    a1->a.a1.shapeFrame = 2;
  }
  shapeFrame = a1->a.a1.shapeFrame;
  a1->Unknown_C3 = a2;
  v10 = shapeFrame;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, a1->a.a1.Unknown_18);
  v5 = VFX_shape_resolution(ShapeTable_sub_1B084, v10);
  a1->Unknown_BF = v5;
  a1->window = a1->a.a1.pane.window;
  v6 = HIWORD(v5);
  x0 = a1->a.a1.pane.x0;
  a1->Unknown_BF = v6;
  a1->Unknown_8D5 = x0 + 1;
  x1 = a1->a.a1.pane.x1;
  a1->Unknown_BF = v6 + 3;
  Unknown_B3 = a1->Unknown_B3;
  a1->Unknown_8DD = x1 - 1;
  if ( Unknown_B3 == 0xFFFFFFFF )
  {
    a1->Unknown_8DD -= a1->Unknown_BF;
  }
}

//----- (0002EA8C) --------------------------------------------------------
int __fastcall Q_Wnd10LB_AddItem_sub_2EA8C(P_Wnd10LB pListBox, BYTE *pData, __int16 a3, BOOL bRedraw)
{
  __int16 Unknown_8C9; // di
  int Unknown_8CB; // edx
  int Unknown_BF; // eax
  int Unknown_8DD; // edi
  size_t v10; // kr04_4
  void *v11; // eax
  int Unknown_8EE; // ecx
  int result; // eax
  BYTE v14; // al
  BYTE v15; // al
  int v16; // kr08_4
  BYTE *v18; // [esp+4h] [ebp-10h]

  Unknown_8C9 = a3;
  if ( pListBox->itemCount >= 256u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x62A);
  }
  if ( a3 == 0xFFFFFFFF )
  {
    Unknown_8C9 = pListBox->Unknown_8C9;
  }
  pListBox->Unknown_8CB += Unknown_8C9;
  Unknown_8CB = (unsigned __int16)pListBox->Unknown_8CB;
  if ( (unsigned __int16)Unknown_8CB > pListBox->a.a1.pane.y1 - pListBox->a.a1.pane.y0 - 1 )
  {
    if ( pListBox->Unknown_B7 == 0xFFFFFFFF )
    {
      pListBox->a.a1.pane.y1 = pListBox->a.a1.pane.y0 + Unknown_8CB + 2;
    }
    else if ( !pListBox->Unknown_B3 )
    {
      Unknown_BF = pListBox->Unknown_BF;
      Unknown_8DD = pListBox->Unknown_8DD;
      pListBox->Unknown_B3 = 0xFFFFFFFF;
      pListBox->Unknown_8DD = Unknown_8DD - Unknown_BF;
    }
  }
  if ( pListBox->Unknown_AB == 0xFFFFFFFF )
  {
    v10 = strlen(pData) + 1;
    if ( pListBox->Unknown_8E6 )
    {
      Unknown_8EE = pListBox->Unknown_8EE;
      if ( pListBox->Unknown_8F2 - Unknown_8EE < v10 )
      {
        Q_AssertLogBreakExit_sub_261A8(0, "..\\gwindow.cpp", 0x653);
        return 0xFFFFFFFF;
      }
      v18 = (BYTE *)(pListBox->Unknown_8EA + Unknown_8EE);
      pListBox->Unknown_8EE += v10;
    }
    else
    {
      v11 = operator new[](v10);
      Q_RegisterData_sub_2625C(v11, 1, "LISTBOX STRING");
      v18 = (BYTE *)v11;
      if ( !v11 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x648);
      }
    }
    v16 = 0;
    do
    {
      v14 = pData[2 * v16];
      v18[2 * v16] = v14;
      if ( !v14 )
      {
        break;
      }
      v15 = pData[2 * v16 + 1];
      v18[2 * v16++ + 1] = v15;
    }
    while ( v15 );
    pData = v18;
  }
  pListBox->items[pListBox->itemCount].pData = pData;
  pListBox->items[pListBox->itemCount].value = 0;
  HIWORD(result) = HIWORD(bRedraw);
  ++pListBox->itemCount;
  if ( bRedraw == TRUE )
  {
    pListBox->a.pProcs->proc4_draw(&pListBox->a.a1, 0);
  }
  LOWORD(result) = pListBox->itemCount;
  // Return index of new item
  return result;
}

//----- (0002EC50) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Wnd10LB_SetItemValue_sub_2EC50(P_Wnd10LB a1, unsigned __int16 itemIndex, int value)
{
  MACRO_VFX_BOOL true; // eax

  if ( itemIndex >= 256u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x66B);
  }
  if ( !a1->items[itemIndex].pData )
  {
    return FALSE;
  }
  true = TRUE;
  a1->items[itemIndex].value = value;
  return true;
}

//----- (0002ECA4) --------------------------------------------------------
int __fastcall sub_2ECA4(int a1, unsigned __int16 a2)
{
  if ( a2 >= 0x100u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x679);
  }
  return *(_DWORD *)(a1 + 8 * a2 + 0xCB);
}

//----- (0002ECDC) --------------------------------------------------------
void __fastcall __spoils<> sub_2ECDC(P_Wnd10LB pListBox, unsigned __int16 a2)
{
  if ( (unsigned __int16)pListBox->Unknown_8CB > pListBox->a.a1.pane.y1 - pListBox->a.a1.pane.y0 - 1 && a2 < pListBox->itemCount )
  {
    pListBox->Unknown_8CF = 0xFFFF;
    pListBox->Unknown_8CD = a2;
  }
}

//----- (0002ED14) --------------------------------------------------------
void *__fastcall Q_Wnd10LB_GetItemData_sub_2ED14(P_Wnd10LB pListBox, unsigned __int16 itemIndex)
{
  if ( itemIndex >= 256u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x68D);
  }
  return pListBox->items[itemIndex].pData;
}

//----- (0002ED4C) --------------------------------------------------------
void __fastcall sub_2ED4C(P_Wnd10LB a1)
{
  LONG x1; // eax
  int Unknown_AF; // edx
  int i; // edx

  a1->Unknown_8EE = 0;
  for ( i = 0; i < a1->itemCount; ++i )
  {
    if ( a1->items[i].pData )
    {
      a1->items[i].pData = 0;
    }
  }
  a1->itemCount = 0;
  a1->Unknown_8CB = 0;
  a1->Unknown_8CF = 0xFFFF;
  x1 = a1->a.a1.pane.x1;
  a1->Unknown_8CD = 0;
  Unknown_AF = a1->Unknown_AF;
  a1->Unknown_8DD = x1 - 1;
  if ( !Unknown_AF )
  {
    a1->Unknown_B3 = 0;
  }
}

//----- (0002EDC8) --------------------------------------------------------
void __fastcall sub_2EDC8(int a1, unsigned int a2, unsigned int a3)
{
  unsigned int v5; // eax
  unsigned __int16 v6; // di
  unsigned __int16 v7; // dx
  unsigned int v8; // ebx
  unsigned __int16 v9; // cx
  int v10; // eax
  int v11; // edx
  unsigned int v12; // edx
  unsigned int v13; // eax
  char v14; // al
  int v15; // edx
  int v16; // eax
  LONG v17; // [esp-4h] [ebp-18h]

  if ( *(__int16 *)(a1 + 0x8CF) != 0xFFFFFFFF )
  {
    if ( a3 >= *(_DWORD *)(a1 + 0x8D9) && a3 <= *(_DWORD *)(a1 + 0x8E1) && a2 <= *(_DWORD *)(a1 + 0x8DD) )
    {
      if ( *(_DWORD *)(a1 + 0xBB) == 0xFFFFFFFF )
      {
        VFX_pane_wipe((PANE *)(a1 + 0x8D1), *(unsigned __int8 *)(a1 + 0xC5));
        (*(void (__fastcall **)(int, _DWORD, _DWORD, unsigned int))(a1 + 0x8FA))(
          a1 + 0x8D1,
          *(_DWORD *)(a1 + 8 * *(__int16 *)(a1 + 0x8CF) + 0xC7),
          *(_DWORD *)(a1 + 8 * *(__int16 *)(a1 + 0x8CF) + 0xCB),
          0xFFFFFFFF);
        Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 0x8D1));
      }
      return;
    }
    VFX_pane_wipe((PANE *)(a1 + 0x8D1), *(unsigned __int8 *)(a1 + 0xC5));
    (*(void (__fastcall **)(int, _DWORD, _DWORD, _DWORD))(a1 + 0x8FA))(
      a1 + 0x8D1,
      *(_DWORD *)(a1 + 8 * *(__int16 *)(a1 + 0x8CF) + 0xC7),
      *(_DWORD *)(a1 + 8 * *(__int16 *)(a1 + 0x8CF) + 0xCB),
      0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 0x8D1));
    *(_WORD *)(a1 + 0x8CF) = 0xFFFF;
  }
  v5 = *(_DWORD *)(a1 + 0x10);
  if ( *(_DWORD *)(a1 + 0xB3) == 0xFFFFFFFF )
  {
    v5 -= *(_DWORD *)(a1 + 0xBF);
  }
  if ( v5 <= a2 )
  {
    if ( *(_DWORD *)(a1 + 0xB3) != 0xFFFFFFFF )
    {
      return;
    }
    v12 = *(_DWORD *)(a1 + 0xC) + (*(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC)) / 2;
    v13 = *(unsigned __int8 *)(a1 + 0x8E5);
    if ( v13 > 1 )
    {
      if ( a3 <= v12 )
      {
        if ( v13 == 2 )
        {
          return;
        }
        v15 = *(_DWORD *)(a1 + 0xB3);
        v16 = a1;
        *(_BYTE *)(a1 + 0x8E5) = 2;
      }
      else
      {
        if ( v13 == 3 )
        {
          return;
        }
        v15 = *(_DWORD *)(a1 + 0xB3);
        v16 = a1;
        *(_BYTE *)(a1 + 0x8E5) = 3;
      }
    }
    else
    {
      v14 = (a3 > v12) + 2;
      v15 = *(_DWORD *)(a1 + 0xB3);
      *(_BYTE *)(a1 + 0x8E5) = v14;
      v16 = a1;
    }
    sub_2E868(v16, v15);
  }
  else
  {
    if ( *(unsigned __int8 *)(a1 + 0x8E5) > 1u )
    {
      *(_BYTE *)(a1 + 0x8E5) = 1;
      sub_2E868(a1, 0xFFFFFFFF);
      sub_567BC(&WinMgr, *(_DWORD *)(a1 + 0x41), 0x193);
      sub_564C0(&WinMgr, *(_DWORD *)(a1 + 0x41), 0xFFFFFFFF);
    }
    v6 = *(_WORD *)(a1 + 0x8CD);
    v7 = *(_WORD *)(a1 + 0x8C7);
    v8 = 0;
    *(_DWORD *)(a1 + 0x8D9) = *(_DWORD *)(a1 + 0xC) + 1;
    if ( v6 < v7 )
    {
      while ( !v8 )
      {
        v8 = 0;
        v10 = *(_DWORD *)(a1 + 0x8F6);
        if ( v10 )
        {
          v10 = (*(unsigned __int16 (__fastcall **)(_DWORD, _DWORD, _DWORD))(a1 + 0x8F6))(
                  *(_DWORD *)(a1 + 8 * v6 + 0xC7),
                  *(_DWORD *)(a1 + 8 * v6 + 0xCB),
                  0);
        }
        else
        {
          LOWORD(v10) = *(_WORD *)(a1 + 0x8C9);
        }
        *(_DWORD *)(a1 + 0x8E1) = *(_DWORD *)(a1 + 0x8D9) + v10 - 1;
        v11 = *(_DWORD *)(a1 + 0x14);
        if ( *(_DWORD *)(a1 + 0x8E1) >= v11 )
        {
          v8 = 0xFFFFFFFF;
          *(_DWORD *)(a1 + 0x8E1) = v11 - 1;
        }
        if ( a3 >= *(_DWORD *)(a1 + 0x8D9) && a3 <= *(_DWORD *)(a1 + 0x8E1) )
        {
          v17 = *(unsigned __int8 *)(a1 + 0xC5);
          *(_WORD *)(a1 + 0x8CF) = v6;
          VFX_pane_wipe((PANE *)(a1 + 0x8D1), v17);
          (*(void (__fastcall **)(int, _DWORD, _DWORD, unsigned int))(a1 + 0x8FA))(
            a1 + 0x8D1,
            *(_DWORD *)(a1 + 8 * v6 + 0xC7),
            *(_DWORD *)(a1 + 8 * v6 + 0xCB),
            0xFFFFFFFF);
          Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 0x8D1));
          return;
        }
        ++v6;
        v9 = *(_WORD *)(a1 + 0x8C7);
        *(_DWORD *)(a1 + 0x8D9) = *(_DWORD *)(a1 + 0x8E1) + 1;
        if ( v6 >= v9 )
        {
          return;
        }
      }
    }
  }
}

//----- (0002F090) --------------------------------------------------------
void __fastcall sub_2F090(int a1, unsigned int a2, unsigned int a3, __int16 a4)
{
  LONG v6; // ecx
  int v7; // edx
  int v8; // ebx

  if ( *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 0xBF) <= a2 )
  {
    if ( *(_DWORD *)(a1 + 0xB3) == 0xFFFFFFFF )
    {
      if ( *(_DWORD *)(a1 + 0xC) + (*(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC)) / 2 <= a3 )
      {
        (*(void (__fastcall **)(int, int, _DWORD, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 8))(a1, 0x192, 0, 0);
        sub_56400(&WinMgr, *(_DWORD *)(a1 + 0x41), 0x192, 0, 0, 0x1E);
      }
      else
      {
        (*(void (__fastcall **)(int, int, _DWORD, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 8))(a1, 0x191, 0, 0);
        sub_56400(&WinMgr, *(_DWORD *)(a1 + 0x41), 0x191, 0, 0, 0x1E);
      }
      v8 = 1;
      if ( a4 == 5 )
      {
        v8 = 2;
      }
      sub_56728(&WinMgr, *(_DWORD *)(a1 + 0x41), v8, 0x193, 0, 0);
    }
  }
  else
  {
    v6 = *(__int16 *)(a1 + 0x8CF);
    if ( v6 != 0xFFFFFFFF )
    {
      if ( WinMgr.h )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, *(_DWORD *)(a1 + 0x63), 0x1C02, v6, a4);
      }
      else
      {
        v7 = *(__int16 *)(a1 + 0x59);
        if ( v7 != 0xFFFFFFFF )
        {
          Q_StartSample_sub_4FB90(&V_SoundSystem, v7);
        }
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, *(_DWORD *)(a1 + 0x63), 0x1C01, *(__int16 *)(a1 + 0x8CF), a4);
      }
      sub_2EDC8(a1, a2, a3);
    }
  }
}

//----- (0002F1C8) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd10LB_SetProc1_sub_2F1C8(P_Wnd10LB result, void *a2)
{
  result->proc1 = a2;
}

//----- (0002F1D8) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd10LB_SetCompareProc_sub_2F1D8(P_Wnd10LB result, void *proc)
{
  result->pfnCompareProc = proc;
}

//----- (0002F1E0) --------------------------------------------------------
void __fastcall Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(P_Wnd10LB pListBox)
{
  if ( !pListBox->pfnCompareProc )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x7AB);
  }
  qsort(pListBox->items, pListBox->itemCount, 8u, (int (__fastcall *)(const void *, const void *))pListBox->pfnCompareProc);
}

//----- (0002F228) --------------------------------------------------------
int __fastcall sub_2F228(int a1, size_t a2, int a3)
{
  int result; // eax

  sub_2ED4C((P_Wnd10LB)a1);
  if ( *(_DWORD *)(a1 + 0x8EA) )
  {
    sub_262CC(*(void **)(a1 + 0x8EA));
    *(_DWORD *)(a1 + 0x8EA) = 0;
  }
  if ( a3 )
  {
    *(_DWORD *)(a1 + 0x8EA) = a3;
  }
  else
  {
    *(_DWORD *)(a1 + 0x8EA) = Q_Allocate_sub_2628C(a2, 1, "LISTBOX MEMPOOL");
  }
  if ( *(_DWORD *)(a1 + 0x8EA) )
  {
    *(_DWORD *)(a1 + 0x8E6) = 0xFFFFFFFF;
    *(_DWORD *)(a1 + 0x8EE) = 0;
    result = 0xFFFFFFFF;
    *(_DWORD *)(a1 + 0x8F2) = a2;
  }
  else
  {
    *(_DWORD *)(a1 + 0x8E6) = 0;
    *(_DWORD *)(a1 + 0x8F2) = 0;
    result = 0;
    *(_DWORD *)(a1 + 0x8EE) = 0;
  }
  return result;
}

//----- (0002F2B4) --------------------------------------------------------
void __fastcall sub_2F2B4(int a1)
{
  if ( *(_DWORD *)(a1 + 0x8EA) )
  {
    sub_262CC(*(void **)(a1 + 0x8EA));
    *(_DWORD *)(a1 + 0x8EA) = 0;
  }
  *(_DWORD *)(a1 + 0x8F2) = 0;
  *(_DWORD *)(a1 + 0x8EE) = 0;
  *(_DWORD *)(a1 + 0x8E6) = 0;
}

//----- (0002F2F4) --------------------------------------------------------
void __fastcall __spoils<> Q_WndNT_sub_2F2F4(P_WndNT result)
{
  Q_A2Ctor_sub_2C830(&result->a);
  result->a.pProcs = (P_Procs)&off_95DC0;
}
// 95DC0: using guessed type int (__fastcall *off_95DC0)(P_WndA2 a1);

//----- (0002F30C) --------------------------------------------------------
T_WndA2 *__fastcall sub_2F30C(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95D2C);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95DC0;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95DC0: using guessed type int (__fastcall *off_95DC0)(P_WndA2 a1);

//----- (0002F354) --------------------------------------------------------
void __fastcall sub_2F354(int a1)
{
  void *ShapeTable_sub_1B084; // eax
  LONG v3; // ecx
  LONG v4; // ebx
  void *v5; // eax
  __int16 i; // si
  LONG v7; // [esp-Ch] [ebp-20h]
  WORD v8; // [esp-4h] [ebp-18h]
  char s[12]; // [esp+0h] [ebp-14h] BYREF
  int v10; // [esp+Ch] [ebp-8h]
  int a2; // [esp+10h] [ebp-4h]

  v7 = *(_DWORD *)(a1 + 0xAB) + 0xC;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
  v10 = a1 + 4;
  VFX_shape_draw((PANE *)(a1 + 4), ShapeTable_sub_1B084, v7, 0, 0);
  sprintf(s, "%05d", V_Game.day);
  a2 = v10;
  for ( i = 0; i < 5; ++i )
  {
    v3 = 0x1F * i + 2;
    v8 = V_PlayerRaceIndex;
    v4 = *(_DWORD *)(a1 + 0xAB) + s[i] - 0x30;
    v5 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a2, v5, v4, v3, 0, v8);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)a2);
}
// 2F354: using guessed type char s[12];

//----- (0002F414) --------------------------------------------------------
int __fastcall sub_2F414(int a1)
{
  return (*(int (**)(void))(*(_DWORD *)(a1 + 0xA7) + 0xC))();
}

//----- (0002F420) --------------------------------------------------------
int __fastcall sub_2F420(T_WndA2 *pWndA2, __int16 message, LONG param1, LONG param2)
{
  return Q_WndA2_Proc3_sub_2F424(pWndA2, message, param1, param2);
}

//----- (0002F424) --------------------------------------------------------
int __fastcall Q_WndA2_Proc3_sub_2F424(P_WndA2 pWndA2, UWORD message, int param1, int param2)
{
  P_Procs pProcs; // ebp
  WORD sendMessage; // cx
  LONG sendParam2; // ebx
  int Unknown_59; // edx
  int param1a; // [esp+2h] [ebp-10h]

  if ( message < 7u )
  {
    if ( message < 2u )
    {
      if ( message == 1 )
      {
        pWndA2->a1.Unknown_39 = 0xFFFFFFFF;
        pProcs = pWndA2->pProcs;
        pWndA2->a1.Unknown_35 = 0xFFFFFFFF;
        ((void (*)(void))pProcs->proc4_draw)();
        sub_2D258(pWndA2, 1);
        return 0;
      }
      return 0;
    }
    if ( message <= 2u )
    {
      sub_2D258(pWndA2, message);
      pWndA2->a1.Unknown_39 = 0;
      pWndA2->a1.Unknown_35 = 0;
      if ( pWndA2->a1.index == WinMgr._wndIndex )
      {
        WinMgr._wndIndex = 0xFFFFFFFF;
      }
      sub_567BC(&WinMgr, pWndA2->a1.index, 0xFFFFFFFF);
      sub_564C0(&WinMgr, pWndA2->a1.index, 0xFFFFFFFF);
      return 0;
    }
    else
    {
      if ( message < 4u )
      {
        return 0;
      }
      if ( message <= 5u )
      {
        if ( param1 < pWndA2->a1.pane.x0 || param1 > pWndA2->a1.pane.x1 || param2 < pWndA2->a1.pane.y0 || param2 > pWndA2->a1.pane.y1 )
        {
          return 0;
        }
        sendMessage = pWndA2->a1.sendMessage;
        param1a = pWndA2->a1.sendParam1;
        sendParam2 = pWndA2->a1.sendParam2;
        if ( sendMessage == 0x3E7 )
        {
          sendMessage = message;
        }
        if ( param1a == 0x3E7 )
        {
          param1a = (__int16)message;
        }
        if ( sendParam2 == 0x3E7 )
        {
          sendParam2 = (__int16)message;
        }
        Unknown_59 = (__int16)pWndA2->a1.Unknown_59;
        if ( Unknown_59 != 0xFFFFFFFF )
        {
          Q_StartSample_sub_4FB90(&V_SoundSystem, Unknown_59);
        }
        if ( pWndA2->a1.parentIndex )
        {
          if ( sendMessage == 0x3E6 )
          {
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, param1a, sendParam2, 0);
            return 0xFFFFFFFF;
          }
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWndA2->a1.parentIndex, sendMessage, param1a, sendParam2);
        }
        else
        {
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, sendMessage, param1a, sendParam2);
        }
        return 0xFFFFFFFF;
      }
      else
      {
        if ( pWndA2->a1.Unknown_39 && pWndA2->a1.Unknown_35 && pWndA2->a1._mouseFocus )
        {
          ((void (*)(void))pWndA2->pProcs->proc4_draw)();
        }
        return 0xFFFFFFFF;
      }
    }
  }
  else if ( message <= 7u )
  {
    if ( pWndA2->a1.Unknown_39 && pWndA2->a1.Unknown_35 && pWndA2->a1._mouseFocus )
    {
      ((void (*)(void))pWndA2->pProcs->proc4_draw)();
    }
    return 0xFFFFFFFF;
  }
  else
  {
    if ( message >= 0xEu )
    {
      if ( message <= 0xEu )
      {
        pWndA2->a1.Unknown_35 = 0xFFFFFFFF;
        pWndA2->a1.Unknown_39 = 0xFFFFFFFF;
        return 0;
      }
      if ( message <= 0xFu )
      {
        pWndA2->a1.Unknown_35 = 0;
        return 0;
      }
      if ( message >= 0xC9u )
      {
        if ( message > 0xCAu )
        {
          return 0;
        }
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, (__int16)message, 0);
        return 0xFFFFFFFF;
      }
      return 0;
    }
    if ( message != 0xC )
    {
      return 0;
    }
    if ( param1 < pWndA2->a1.pane.x0 || param1 > pWndA2->a1.pane.x1 || param2 < pWndA2->a1.pane.y0 || param2 > pWndA2->a1.pane.y1 )
    {
      return 0;
    }
    if ( pWndA2->a1.helpIndex[0] != 0x30 )
    {
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)pWndA2->a1.helpIndex, 0);
    }
    return 0xFFFFFFFF;
  }
}

//----- (0002F478) --------------------------------------------------------
int __fastcall sub_2F478(T_WndA2 *a1, __int16 a2, LONG a3, LONG a4)
{
  if ( a2 != 0xD )
  {
    return sub_2F420(a1, a2, a3, a4);
  }
  ((void (*)(void))a1->pProcs->proc4_draw)();
  return 0;
}

//----- (0002F48C) --------------------------------------------------------
T_WndA2 *__fastcall sub_2F48C(T_WndA2 *a1)
{
  Q_A2Ctor_sub_2C830(a1);
  a1->pProcs = (P_Procs)&off_95DA8;
  sub_2F4EC((int)a1);
  return a1;
}
// 95DA8: using guessed type int (__fastcall *off_95DA8)(P_WndA2 a1);

//----- (0002F4A8) --------------------------------------------------------
T_WndA2 *__fastcall sub_2F4A8(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95D18);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95DA8;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95DA8: using guessed type int (__fastcall *off_95DA8)(P_WndA2 a1);

//----- (0002F4EC) --------------------------------------------------------
int __fastcall sub_2F4EC(int result)
{
  *(_DWORD *)(result + 0xAB) = 0;
  *(_WORD *)(result + 0xB1) = 0;
  *(_WORD *)(result + 0xAF) = 0;
  *(_WORD *)(result + 0xB3) = 0;
  *(_WORD *)(result + 0xB7) = 0xF2;
  *(_DWORD *)(result + 0xB9) = &WinMgr.LargeFont;
  *(_DWORD *)(result + 0xBD) = 0xFFFFFFFF;
  *(_WORD *)(result + 0xB5) = (unsigned __int8)byte_96778;
  return result;
}
// 96778: using guessed type char byte_96778;

//----- (0002F540) --------------------------------------------------------
void __fastcall sub_2F540(int a1)
{
  T_Font *v2; // eax
  const char *v3; // ecx
  int v4; // edx
  int v5; // eax
  int TextWidth_sub_2B4F4; // eax
  LONG v7; // [esp-18h] [ebp-30h]
  LONG v8; // [esp-14h] [ebp-2Ch]
  WORD v9; // [esp-Ch] [ebp-24h]
  PANE *a2; // [esp+0h] [ebp-18h]

  a2 = (PANE *)(a1 + 4);
  VFX_pane_wipe((PANE *)(a1 + 4), *(__int16 *)(a1 + 0xB7));
  VFX_line_draw(a2, 0, 0, *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), 0, 0, 0xF3);
  VFX_line_draw(a2, 0, 0, 0, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), 0, 0xF3);
  v8 = *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC);
  VFX_line_draw(a2, *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), v8, 0, v8, 0, 0xF3);
  v7 = *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8);
  VFX_line_draw(a2, v7, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), v7, 0, 0, 0xF3);
  v2 = *(T_Font **)(a1 + 0xB9);
  v9 = *(_WORD *)(a1 + 0xB5);
  v3 = *(const char **)(a1 + 0xAB);
  v2->pane.window = a2->window;
  v2->pane.x0 = a2->x0;
  v2->pane.y0 = a2->y0;
  v2->pane.x1 = a2->x1;
  v2->pane.y1 = a2->y1;
  Q_Font_DrawFormattedText_sub_2B8A8(v2, 2, 4, v3, 0, v9, 0xFF, 0);
  v4 = *(__int16 *)(a1 + 0xB3);
  v5 = *(_DWORD *)(a1 + 0xAB);
  LOBYTE(v3) = *(_BYTE *)(v4 + v5);
  *(_BYTE *)(v4 + v5) = 0;
  TextWidth_sub_2B4F4 = Q_Font_GetTextWidth_sub_2B4F4(*(P_Font *)(a1 + 0xB9), *(char **)(a1 + 0xAB));
  *(_BYTE *)(*(__int16 *)(a1 + 0xB3) + *(_DWORD *)(a1 + 0xAB)) = (_BYTE)v3;
  VFX_line_draw(a2, TextWidth_sub_2B4F4 + 2, 3, TextWidth_sub_2B4F4 + 2, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC) - 3, 0, 0x98);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, a2);
}

//----- (0002F6B0) --------------------------------------------------------
int __fastcall sub_2F6B0(int a1, __int16 a2, char a3, unsigned int a4)
{
  int v6; // ecx
  int v8; // ebx
  __int16 v9; // ax
  int v10; // ebx

  if ( a2 != 3 )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  v6 = *(_DWORD *)(a1 + 0xBD);
  *(_DWORD *)(a1 + 0xBD) = 0;
  if ( a3 >= 0x30 && a3 <= 0x39 || a3 >= 0x41 && a3 <= 0x5A || a3 >= 0x61 && a3 <= 0x7A || a3 == 0x20 || a3 == 0x2D )
  {
    if ( v6 )
    {
      *(_WORD *)(a1 + 0xB3) = 0;
      *(_WORD *)(a1 + 0xB1) = *(_WORD *)(a1 + 0xB3);
      **(_BYTE **)(a1 + 0xAB) = 0;
    }
    if ( *(_WORD *)(a1 + 0xB1) < *(_WORD *)(a1 + 0xAF) && Q_Font_GetTextWidth_sub_2B4F4(&WinMgr.LargeFont, *(char **)(a1 + 0xAB)) < 0x5F )
    {
      sub_2F8F8(a1, *(_WORD *)(a1 + 0xB3), a3, a2);
      ++*(_WORD *)(a1 + 0xB3);
      (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
    }
    return 0xFFFFFFFF;
  }
  if ( a4 < 0x4B )
  {
    if ( a4 >= 0xE )
    {
      if ( a4 > 0xE )
      {
        if ( a4 == 0x1C )
        {
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, 3, 0);
          return 0xFFFFFFFF;
        }
        return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
      }
      if ( *(__int16 *)(a1 + 0xB3) > 0 )
      {
        sub_2F8A4(a1, (__int16)--*(_WORD *)(a1 + 0xB3));
        (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
      }
      return 0xFFFFFFFF;
    }
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  if ( a4 <= 0x4B )
  {
    if ( *(__int16 *)(a1 + 0xB3) > 0 )
    {
      v8 = *(_DWORD *)(a1 + 0xA7);
      --*(_WORD *)(a1 + 0xB3);
      (*(void (__fastcall **)(int, _DWORD))(v8 + 0xC))(a1, 0);
    }
    return 0xFFFFFFFF;
  }
  if ( a4 < 0x4D )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  if ( a4 <= 0x4D )
  {
    v9 = *(_WORD *)(a1 + 0xB3);
    if ( v9 < *(__int16 *)(a1 + 0xB1) )
    {
      v10 = *(_DWORD *)(a1 + 0xA7);
      *(_WORD *)(a1 + 0xB3) = v9 + 1;
      (*(void (__fastcall **)(int, _DWORD))(v10 + 0xC))(a1, 0);
    }
    return 0xFFFFFFFF;
  }
  else
  {
    if ( a4 != 0x53 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
    }
    if ( *(_WORD *)(a1 + 0xB3) < *(_WORD *)(a1 + 0xB1) )
    {
      sub_2F8A4(a1, *(__int16 *)(a1 + 0xB3));
      (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
    }
    return 0xFFFFFFFF;
  }
}

//----- (0002F8A4) --------------------------------------------------------
int __fastcall sub_2F8A4(int a1, int a2)
{
  __int16 v3; // bx
  int result; // eax

  if ( (__int16)a2 >= *(__int16 *)(a1 + 0xAF) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x8F2);
  }
  v3 = *(_WORD *)(a1 + 0xB1);
  result = a2;
  if ( (__int16)a2 < v3 )
  {
    do
    {
      *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + (__int16)result) = *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + (__int16)result + 1);
      ++result;
    }
    while ( (__int16)result < *(__int16 *)(a1 + 0xB1) );
  }
  --*(_WORD *)(a1 + 0xB1);
  return result;
}

//----- (0002F8F8) --------------------------------------------------------
char __usercall sub_2F8F8@<al>(int a1@<eax>, __int16 a2@<dx>, char a3@<bl>, int a4@<edi>)
{
  int i; // eax
  _BYTE *v7; // edx
  char result; // al

  if ( a2 > *(__int16 *)(a1 + 0xB1) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x903);
  }
  if ( *(_WORD *)(a1 + 0xB1) >= *(_WORD *)(a1 + 0xAF) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x904);
  }
  LOWORD(a4) = *(_WORD *)(a1 + 0xB1);
  if ( a2 == (_WORD)a4 )
  {
    *(_BYTE *)((__int16)a4 + *(_DWORD *)(a1 + 0xAB)) = a3;
    *(_BYTE *)((__int16)a4 + *(_DWORD *)(a1 + 0xAB) + 1) = 0;
  }
  else
  {
    for ( i = a4; (__int16)i >= a2; v7[1] = *v7 )
    {
      v7 = (_BYTE *)((__int16)i-- + *(_DWORD *)(a1 + 0xAB));
    }
  }
  result = a3;
  *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + a2) = a3;
  ++*(_WORD *)(a1 + 0xB1);
  return result;
}

//----- (0002F9A4) --------------------------------------------------------
int __fastcall sub_2F9A4(int a1, const char *a2, __int16 a3)
{
  int result; // eax
  unsigned int v5; // kr04_4

  if ( !a2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x91B);
  }
  *(_DWORD *)(a1 + 0xAB) = a2;
  *(_WORD *)(a1 + 0xAF) = a3;
  result = 0;
  v5 = strlen(a2) + 1;
  *(_WORD *)(a1 + 0xB1) = v5 - 1;
  if ( (__int16)(v5 - 1) > a3 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x921);
  }
  *(_WORD *)(a1 + 0xB3) = *(_WORD *)(a1 + 0xB1);
  return result;
}

//----- (0002FA18) --------------------------------------------------------
void __fastcall __spoils<> Q_A3_sub_2FA18(P_TypeA3 a1)
{
  Q_A2Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = (P_Procs)&off_95D90;
  Q_A3_sub_2FA78(a1);
}
// 95D90: using guessed type int (__fastcall *off_95D90)(P_WndA2 a1);

//----- (0002FA34) --------------------------------------------------------
T_WndA2 *__fastcall sub_2FA34(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95D04);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95D90;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95D90: using guessed type int (__fastcall *off_95D90)(P_WndA2 a1);

//----- (0002FA78) --------------------------------------------------------
void __fastcall __spoils<> Q_A3_sub_2FA78(P_TypeA3 result)
{
  result->controls = 0;
  result->numControls = 3;
  result->e = 0xF3;
}

//----- (0002FA98) --------------------------------------------------------
void __fastcall sub_2FA98(int a1)
{
  PANE *v2; // esi
  const char *v3; // ecx
  LONG v4; // [esp-18h] [ebp-2Ch]
  LONG v5; // [esp-14h] [ebp-28h]
  __int16 v6; // [esp-10h] [ebp-24h]
  WORD v7; // [esp-Ch] [ebp-20h]
  int v8; // [esp-4h] [ebp-18h]

  v2 = (PANE *)(a1 + 4);
  VFX_pane_wipe((PANE *)(a1 + 4), 0xF2);
  if ( *(_DWORD *)(a1 + 0x5F) == 0xFFFFFFFF )
  {
    VFX_line_draw(v2, 0, 0, *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), 0, 0, 0xF3);
    VFX_line_draw(v2, 0, 0, 0, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), 0, 0xF3);
    v5 = *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC);
    VFX_line_draw(v2, *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8), v5, 0, v5, 0, 0xF3);
    v4 = *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8);
    VFX_line_draw(v2, v4, *(_DWORD *)(a1 + 0x14) - *(_DWORD *)(a1 + 0xC), v4, 0, 0, 0xF3);
  }
  if ( *(_DWORD *)(a1 + 0xAB) )
  {
    v3 = *(const char **)(a1 + 0xAB);
    v8 = *(_DWORD *)(a1 + 0x10) - *(_DWORD *)(a1 + 8) - 5;
    v7 = *(_WORD *)(a1 + 0xB1);
    v6 = *(_WORD *)(a1 + 0xAF);
    WinMgr.LargeFont.pane = *(PANE *)(a1 + 4);
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, v3, v6, v7, 0xFF, v8);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 4));
}

//----- (0002FBA4) --------------------------------------------------------
void __fastcall sub_2FBA4(int a1, int a2)
{
  int v3; // ecx
  LONG v4; // eax
  LONG v5; // ebx
  void *ShapeTable_sub_1B084; // eax
  WORD v7; // [esp-4h] [ebp-14h]

  v3 = *(_DWORD *)(a1 + 0x41);
  v4 = 0xF2;
  if ( WinMgr._wndIndex == v3 && a2 != 2 || a2 == 3 )
  {
    v4 = 0x96;
  }
  VFX_pane_wipe((PANE *)(a1 + 4), v4);
  if ( *(__int16 *)(a1 + 0x1E) == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\gwindow.cpp", 0x9A0);
  }
  v5 = *(__int16 *)(a1 + 0x1E);
  if ( v5 != 0xFFFFFFFF )
  {
    v7 = V_PlayerRaceIndex;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)(a1 + 4), ShapeTable_sub_1B084, v5, 0, 0, v7);
  }
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 4));
}

//----- (0002FC3C) --------------------------------------------------------
int __fastcall sub_2FC3C(int a1)
{
  return (*(int (**)(void))(*(_DWORD *)(a1 + 0xA7) + 0xC))();
}

//----- (0002FC50) --------------------------------------------------------
void __fastcall __spoils<> Q_A2_sub_2FC50(P_WndA2 a1)
{
  Q_A2Ctor_sub_2C830(a1);
  a1->pProcs = (P_Procs)&off_95E54;
}
// 95E54: using guessed type int (__fastcall *off_95E54)(P_WndA2 a1);

//----- (0002FC68) --------------------------------------------------------
T_WndA2 *__fastcall sub_2FC68(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95E40);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95E54;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95E54: using guessed type int (__fastcall *off_95E54)(P_WndA2 a1);

//----- (0002FCB0) --------------------------------------------------------
void __fastcall Q_ShowHelpTopic_sub_2FCB0(P_Wnd20HW a1, char *helpfile, char *helptopic)
{
  LONG v4; // ebx

  a1->Unknown_DAB = 0;
  a1->Unknown_DA7 = a1->Unknown_DAB;
  strcpy(a1->Unknown_AB, helpfile);
  strcpy(a1->helpTopic, helptopic);
  sub_2FEB8(a1);
  v4 = 0x98;
  if ( !WinMgr.state || WinMgr.state == 1 || WinMgr.state == 7 || WinMgr.state == 8 || WinMgr.state == 0x10 || WinMgr.state == 0x14 )
  {
    v4 = 0x50;
  }
  a1->a2.a1.pane.x0 = v4;
  a1->a2.a1.pane.y0 = 0x78;
  a1->a2.a1.pane.x1 = v4 + 0x14F;
  a1->a2.a1.pane.y1 = 0x177;
}

//----- (0002FD68) --------------------------------------------------------
unsigned int __fastcall sub_2FD68(int a1, __int16 a2, LONG a3, LONG a4)
{
  int v4; // ebx
  int v6; // edx
  int v7; // ebx

  if ( (unsigned __int16)a2 < 6u )
  {
    if ( (unsigned __int16)a2 < 2u )
    {
      if ( a2 == 1 )
      {
        *(_DWORD *)(a1 + 0x35) = 0xFFFFFFFF;
        v4 = *(_DWORD *)(a1 + 0xA7);
        *(_DWORD *)(a1 + 0x39) = 0xFFFFFFFF;
        (*(void (**)(void))(v4 + 0xC))();
        return 0;
      }
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
    }
    if ( (unsigned __int16)a2 > 2u && a2 == 5 )
    {
      goto LABEL_9;
    }
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  if ( (unsigned __int16)a2 <= 7u )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  if ( (unsigned __int16)a2 < 0xDu )
  {
    if ( a2 != 0xC )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
    }
LABEL_9:
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, 0xCA, 0);
    return 0xFFFFFFFF;
  }
  if ( (unsigned __int16)a2 <= 0xDu || (unsigned __int16)a2 < 0x32u || (unsigned __int16)a2 > 0x32u )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  v6 = *(_DWORD *)(a1 + 0xDA7);
  if ( v6 >= *(_DWORD *)(a1 + 0xDAB) )
  {
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, a3, a4);
  }
  else
  {
    v7 = *(_DWORD *)(a1 + 0xA7);
    *(_DWORD *)(a1 + 0xDA7) = v6 + 1;
    (*(void (**)(void))(v7 + 0xC))();
  }
  return 0;
}

//----- (0002FE58) --------------------------------------------------------
void __fastcall Q_HELPWIN_CPP_FgetsLine_sub_2FE58(FILE *fp, char *line)
{
  unsigned int found; // edi
  char first; // ah

  found = 0;
  do
  {
    if ( !fgets(line, 200, fp) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\helpwin.cpp", 0x9E);
    }
    first = *line;
    if ( *line != ' ' && first != '\t' && first != '\n' && first != '\r' && first != '/' && first != '#' )
    {
      found = 0xFFFFFFFF;
    }
  }
  while ( !found );
}

//----- (0002FEB8) --------------------------------------------------------
int __fastcall sub_2FEB8(P_Wnd20HW a1)
{
  P_Wnd20HW v1; // kr04_4
  T_Wnd20HW *v2; // edx
  int v3; // kr08_4
  __int8 *Unknown_DD; // eax
  P_Wnd20HW v5; // edx
  P_Wnd20HW v6; // ecx
  const char *helpTopic; // ecx
  int v8; // edx
  int v9; // edx
  int v10; // eax
  int v11; // edx
  _DWORD *p_magic12345678; // edx
  PANE *p_pane; // ebx
  int v14; // edi
  int v15; // eax
  int v16; // eax
  __int8 *v17; // edx
  int v18; // eax
  int v19; // edx
  _BYTE *v20; // kr0C_4
  int v22; // esi
  int v24; // esi
  int i; // ecx
  char s[204]; // [esp+0h] [ebp-13Ah] BYREF
  char s2[60]; // [esp+CCh] [ebp-6Eh] BYREF
  char s1[60]; // [esp+108h] [ebp-32h] BYREF
  char v29[10]; // [esp+144h] [ebp+Ah] BYREF
  char v30; // [esp+14Eh] [ebp+14h] BYREF
  char v31; // [esp+158h] [ebp+1Eh] BYREF
  char v32; // [esp+162h] [ebp+28h] BYREF
  char v33; // [esp+16Ch] [ebp+32h] BYREF
  FILE *fp; // [esp+178h] [ebp+3Eh]
  __int8 *Unknown_C95; // [esp+17Ch] [ebp+42h]
  LONG v36; // [esp+180h] [ebp+46h] BYREF
  int v37; // [esp+184h] [ebp+4Ah] BYREF
  int v38; // [esp+188h] [ebp+4Eh] BYREF
  int v39; // [esp+18Ch] [ebp+52h] BYREF
  __int8 *v40; // [esp+190h] [ebp+56h]
  int v41; // [esp+194h] [ebp+5Ah]
  int v42; // [esp+198h] [ebp+5Eh]
  int v43; // [esp+19Ch] [ebp+62h]
  int v44; // [esp+1A0h] [ebp+66h]
  int v45; // [esp+1A4h] [ebp+6Ah]
  int v46; // [esp+1A8h] [ebp+6Eh]
  unsigned int v47; // [esp+1ACh] [ebp+72h]
  P_Wnd20HW v48; // [esp+1B0h] [ebp+76h]
  int v49; // [esp+1B4h] [ebp+7Ah]
  int v50; // [esp+1B8h] [ebp+7Eh]

  v48 = a1;
  sub_2D258(&a1->a2, 2);
  v1 = v48;
  v2 = (T_Wnd20HW *)&v48->Unknown_DD[0x31];
  v3 = 0;
  do
  {
    v1->Unknown_C91[v3++].Unknown_00 = 0;
  }
  while ( (P_Wnd20HW)((char *)v1 + 0x1B * v3) != v2 );
  Unknown_DD = v48->Unknown_DD;
  v48->Unknown_DA3 = 0;
  memset(Unknown_DD, 0, 3000u);
  v46 = 0;
  v44 = 0;
  v43 = 0;
  v5 = v48;
  v6 = v48;
  v48->a2.a1.Unknown_18 = GwshareShpCacheIndexes[0x25];
  v5->a2.a1.shapeFrame = 0;
  helpTopic = v6->helpTopic;
  fp = Q_OpenFile_sub_1BB10(v5->Unknown_AB, 0);
  do
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, s);
    sscanf(s, "%s", s1);
    if ( !stricmp(s1, "HELP") )
    {
      sscanf(s, "%s %s", s1, s2);
      if ( !stricmp(helpTopic, s2) )
      {
        v46 = 1;
      }
      else if ( !stricmp("END", s2) )
      {
        sub_2620C("Topic '%s' not found in help file.\n", helpTopic);
        Q_PrintFailAndExit_sub_261B8(0, "..\\helpwin.cpp", 0xE8);
      }
    }
  }
  while ( !v46 );
  v45 = 0xFFFFFFFF;
  v41 = 0xFFFFFFFF;
  Unknown_C95 = v48->Unknown_C95;
  if ( v46 != 2 )
  {
    v40 = v48->Unknown_DD;
    v47 = 4 * v44;
    v42 = 0x258 * v43;
    do
    {
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, s);
      sscanf(s, "%s", s1);
      if ( !stricmp(s1, "HELP") )
      {
        v46 = 2;
      }
      else if ( !stricmp(s1, "POS") )
      {
        v8 = (int)Unknown_C95;
        sscanf(s, "%s %d %d", s1, &v36, &v37);
        *(_WORD *)(v8 + 0x13) = v36;
        *(_WORD *)(v8 + 0x15) = v37;
      }
      else if ( !stricmp(s1, "SHAPE") )
      {
        v9 = v48->Unknown_DA3 + 1;
        v48->Unknown_DA3 = v9;
        if ( v9 >= 0xA )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x124);
        }
        if ( v45 == 0xFFFFFFFF )
        {
          v45 = 0;
        }
        else
        {
          Unknown_C95 += 0x1B;
        }
        v10 = (int)Unknown_C95;
        *Unknown_C95 = 0;
        *(_WORD *)(v10 + 1) = 0;
        *(_WORD *)(v10 + 3) = 0;
        *(_WORD *)(v10 + 0x13) = 0;
        *(_WORD *)(v10 + 0x15) = 0;
        if ( sscanf(s, "%s %d %d %d %d", s1, &v36, &v37, &v38, &v39) == 5 )
        {
          v11 = (int)Unknown_C95;
          *(_WORD *)(Unknown_C95 + 1) = v36;
          *(_WORD *)(v11 + 3) = v37;
          *(_WORD *)(v11 + 0x13) = v38;
          *(_WORD *)(v11 + 0x15) = v39;
        }
      }
      else if ( !stricmp(s1, "BUTTON") )
      {
        if ( v41 == 0xFFFFFFFF )
        {
          v41 = 0;
        }
        else
        {
          v47 += 4;
          ++v44;
        }
        if ( v48->a2.a1.childrenNum <= v44 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x145);
        }
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, (*v48->a2.a1.children)[v47 / 4]->index, 0xE, 0, 0);
      }
      else if ( !stricmp(s1, "TITLE") )
      {
        sscanf(s, "%s %s", s1, (*v48->a2.a1.children)[v47 / 4]->name);
      }
      else if ( !stricmp(s1, "MSG") )
      {
        sscanf(s, "%s %d", s1, &v36);
        (*v48->a2.a1.children)[v47 / 4]->sendParam1 = v36;
      }
      else if ( !stricmp(s1, "PANE") )
      {
        sscanf(s, "%s %d %d %d %d", s1, &v36, &v37, &v38, &v39);
        p_magic12345678 = &(*v48->a2.a1.children)[v47 / 4]->magic12345678;
        p_magic12345678[2] = v36;
        p_magic12345678[3] = v37;
        p_magic12345678[4] = v38;
        p_magic12345678[5] = v39;
      }
      else if ( !stricmp(s1, "BPOS") )
      {
        sscanf(s, "%s %s", s1, v29);
        p_pane = &(*v48->a2.a1.children)[v47 / 4]->pane;
        if ( !stricmp(v29, "BL") )
        {
          p_pane->x0 = v48->a2.a1.pane.x0 + 0xF;
          p_pane->y0 = v48->a2.a1.pane.y1 - 0x32;
          p_pane->x1 = v48->a2.a1.pane.x0 + 0x5A;
          p_pane->y1 = v48->a2.a1.pane.y1 - 0xF;
        }
        else if ( !stricmp(v29, "BR") )
        {
          p_pane->x0 = v48->a2.a1.pane.x1 - 0x5A;
          p_pane->y0 = v48->a2.a1.pane.y1 - 0x32;
          p_pane->x1 = v48->a2.a1.pane.x1 - 0xF;
          p_pane->y1 = v48->a2.a1.pane.y1 - 0xF;
        }
      }
      else if ( !stricmp(s1, "TEXT") )
      {
        v14 = v48->Unknown_DA3 + 1;
        v48->Unknown_DA3 = v14;
        if ( v14 >= 0xA )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x177);
        }
        if ( v43 >= 5 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x178);
        }
        if ( v45 == 0xFFFFFFFF )
        {
          v45 = 0;
        }
        else
        {
          Unknown_C95 += 0x1B;
        }
        v15 = (int)Unknown_C95;
        *Unknown_C95 = 1;
        *(_DWORD *)(v15 + 0xF) = 0;
        v16 = v42;
        v42 += 0x258;
        v17 = &v40[v16];
        v18 = (int)Unknown_C95;
        *(_DWORD *)(Unknown_C95 + 5) = v17;
        *v17 = 0;
        *(_DWORD *)(v18 + 0xB) = &WinMgr.LargeFont;
        *(_WORD *)(v18 + 0x13) = 0;
        *(_WORD *)(v18 + 0x15) = 0;
        *(_WORD *)(v18 + 9) = 0xFFFF;
        ++v43;
        if ( sscanf(s, "%s %d %d %d", s1, &v36, &v37, &v38) == 4 )
        {
          v19 = (int)Unknown_C95;
          *(_WORD *)(Unknown_C95 + 0x13) = v36;
          *(_WORD *)(v19 + 0x15) = v37;
          *(_WORD *)(v19 + 9) = v38;
        }
        v49 = 0;
        v50 = 0;
        do
        {
          Q_HELPWIN_CPP_FgetsLine_sub_2FE58(fp, s);
          if ( !strnicmp(s, "ENDTEXT", 7u) )
          {
            v49 = 0xFFFFFFFF;
          }
          else
          {
            v50 += strlen(s);
            if ( v50 >= 0x254 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x19E);
            }
            strcat(*(char **)(Unknown_C95 + 5), s);
          }
        }
        while ( !v49 );
        if ( !*(_DWORD *)(Unknown_C95 + 5) )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x1A6);
        }
        v20 = *(_BYTE **)(Unknown_C95 + 5);
        v24 = 0;
        if ( *v20 )
        {
          do
          {
            if ( v24 >= 0x255 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\helpwin.cpp", 0x1AC);
            }
            if ( v20[v24] == 0xA )
            {
              v20[v24] = 0x20;
            }
            else if ( v20[v24] == 0x40 )
            {
              v20[v24] = 0xA;
            }
          }
          while ( v20[++v24] );
        }
      }
      else if ( !stricmp(s1, "CENTERPOS") )
      {
        *(_WORD *)(Unknown_C95 + 0x13) = (v48->a2.a1.pane.x1 - v48->a2.a1.pane.x0) / 2;
        *(_WORD *)(Unknown_C95 + 0x15) = (v48->a2.a1.pane.y1 - 0x32 - v48->a2.a1.pane.y0) / 2;
      }
      else if ( !stricmp(s1, "FONT") )
      {
        sscanf(s, "%s %s", s1, v29);
        if ( !stricmp(v29, "LARGE") )
        {
          *(_DWORD *)(Unknown_C95 + 0xB) = &WinMgr.LargeFont;
        }
        else if ( !stricmp(v29, "SMALL") )
        {
          *(_DWORD *)(Unknown_C95 + 0xB) = &WinMgr.SmallFont;
        }
      }
      else if ( !stricmp(s1, "FLAGS") )
      {
        v22 = sscanf(s, "%s %s %s %s %s %s", s1, v29, &v30, &v31, &v32, &v33) - 1;
        for ( i = 0; i < v22; ++i )
        {
          if ( !stricmp(&v29[0xA * i], "TJ_HC") )
          {
            Unknown_C95[0xF] |= 2u;
          }
          else if ( !stricmp(&v29[0xA * i], "TJ_VC") )
          {
            Unknown_C95[0xF] |= 1u;
          }
          else if ( !stricmp(&v29[0xA * i], "TJ_R") )
          {
            Unknown_C95[0xF] |= 0x20u;
          }
          else if ( !stricmp(&v29[0xA * i], "TJ_B") )
          {
            Unknown_C95[0xF] |= 0x10u;
          }
        }
      }
      else if ( !stricmp(s1, "NEWPAGE") )
      {
        *(_DWORD *)(Unknown_C95 + 0x17) = 0xFFFFFFFF;
        ++v48->Unknown_DAB;
      }
    }
    while ( v46 != 2 );
  }
  return fclose(fp);
}
// 2FEB8: using guessed type char s[204];
// 2FEB8: using guessed type char var_78[10];

//----- (00030774) --------------------------------------------------------
void __fastcall sub_30774(int a1)
{
  PANE *v1; // esi
  int v2; // eax
  void *ShapeTable_sub_1B084; // eax
  int v4; // edi
  int v5; // esi
  int v6; // esi
  int v7; // ebx
  int v8; // ecx
  int j; // kr0C_4
  int v10; // kr10_4
  _DWORD *v11; // edi
  _DWORD *v12; // eax
  int v13; // esi
  _DWORD *v14; // edi
  int v15; // edx
  int v16; // ebx
  int v17; // esi
  int v18; // kr24_4
  char *v19; // kr1C_4
  char v20; // ah
  void *v21; // eax
  int v22; // edx
  int v23; // ebx
  int v24; // eax
  const char *v25; // ecx
  T_Font *v26; // eax
  int v27; // edx
  int i; // eax
  int v29; // kr20_4
  __int16 v30; // [esp-Ch] [ebp-A4h]
  LONG v31; // [esp-8h] [ebp-A0h]
  LONG v32; // [esp-8h] [ebp-A0h]
  WORD v33; // [esp-8h] [ebp-A0h]
  LONG v34; // [esp-4h] [ebp-9Ch]
  int v35; // [esp+0h] [ebp-98h]
  int v36[20]; // [esp+4h] [ebp-94h]
  PANE pane; // [esp+54h] [ebp-44h] BYREF
  int v38; // [esp+68h] [ebp-30h]
  int v39; // [esp+6Ch] [ebp-2Ch]
  int v40; // [esp+70h] [ebp-28h]
  int v41; // [esp+74h] [ebp-24h]
  _DWORD *v42; // [esp+78h] [ebp-20h]
  __int16 v43; // [esp+7Ch] [ebp-1Ch]
  WORD v44; // [esp+80h] [ebp-18h]

  v42 = (_DWORD *)a1;
  v1 = (PANE *)(a1 + 4);
  VFX_pane_wipe((PANE *)(a1 + 4), 0xF2);
  v2 = *((unsigned __int16 *)v42 + 0xC);
  if ( (unsigned __int16)v2 != 0xFFFF )
  {
    v31 = *((__int16 *)v42 + 0xF);
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[v2]);
    VFX_shape_draw(v1, ShapeTable_sub_1B084, v31, 0, 0);
  }
  v4 = 0;
  v5 = 0;
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(v42 + 1));
  for ( i = 0; i < *(__int16 *)((char *)v42 + 0x6B); ++i )
  {
    if ( *(_DWORD *)(*(_DWORD *)(4 * i + *(_DWORD *)((char *)v42 + 0x67)) + 0x35) == 0xFFFFFFFF )
    {
      ++v4;
      v36[v5++] = i;
    }
  }
  v6 = v42[2] + 8;
  v7 = v42[2] + 0x147;
  if ( v4 > 0 )
  {
    v8 = v4;
    v39 = 4 * v4;
    v10 = v4;
    for ( j = 0; j < v10; ++j )
    {
      v11 = *(_DWORD **)(*(_DWORD *)((char *)v42 + 0x67) + 4 * v36[j]);
      v12 = v42;
      v11[2] = v6;
      v11[3] = v12[3] + 0xD9;
      v11[5] = v42[3] + 0xF7;
      v13 = (v7 - v6) / v8 + v6;
      v14 = v11 + 1;
      if ( v13 > v7 )
      {
        v13 = v7;
      }
      --v8;
      v14[3] = v13;
      v6 = v13 + 1;
    }
  }
  pane = *(PANE *)(v42 + 1);
  pane.x0 = v42[2] + 0xA;
  pane.y0 = v42[3] + 0xA;
  pane.x1 = v42[2] + 0x145;
  pane.y1 = v42[3] + 0xCF;
  v15 = 0;
  v16 = *(_DWORD *)((char *)v42 + 0xDA7);
  v41 = 0;
  if ( v16 > 0 )
  {
    do
    {
      if ( v41 >= *(_DWORD *)((char *)v42 + 0xDA3) )
      {
        break;
      }
      if ( *(_DWORD *)((char *)v42 + 0x1B * v41 + 0xCAC) == 0xFFFFFFFF )
      {
        ++v15;
      }
      v17 = *(_DWORD *)((char *)v42 + 0xDA7);
      ++v41;
    }
    while ( v15 < v17 );
  }
  v18 = v41;
  v40 = 0;
  v19 = (char *)v42 + 0x1B * v41 + 0xC95;
  v29 = 0;
  if ( v41 < *(_DWORD *)((char *)v42 + 0xDA3) )
  {
    do
    {
      if ( v40 == 0xFFFFFFFF )
      {
        break;
      }
      v40 = *(_DWORD *)&v19[0x1B * v29 + 0x17];
      v20 = v19[0x1B * v29];
      if ( v20 )
      {
        if ( v20 == 1 )
        {
          v22 = 0;
          if ( (v19[0x1B * v29 + 0xF] & 2) == 0 )
          {
            v22 = pane.x1 - pane.x0 - *(__int16 *)&v19[0x1B * v29 + 0x13];
          }
          v35 = v22;
          v23 = *(__int16 *)&v19[0x1B * v29 + 0x15];
          v24 = *(__int16 *)&v19[0x1B * v29 + 0x13];
          v25 = *(const char **)&v19[0x1B * v29 + 5];
          v43 = *(_WORD *)&v19[0x1B * v29 + 0xF];
          v44 = *(_WORD *)&v19[0x1B * v29 + 9];
          v38 = v24;
          v26 = *(T_Font **)&v19[0x1B * v29 + 0xB];
          v33 = v44;
          v30 = v43;
          v27 = v38;
          v26->pane = pane;
          Q_Font_DrawFormattedText_sub_2B8A8(v26, v27, v23, v25, v30, v33, 0xFF, v35);
        }
        else if ( v20 != 2 )
        {
          Q_AssertLogBreakExit_sub_261A8(0, "..\\helpwin.cpp", 0x245);
        }
      }
      else
      {
        v35 = *(__int16 *)&v19[0x1B * v29 + 0x15];
        v34 = *(__int16 *)&v19[0x1B * v29 + 0x13];
        v32 = *(unsigned __int16 *)&v19[0x1B * v29 + 3];
        v21 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[*(unsigned __int16 *)&v19[0x1B * v29 + 1]]);
        VFX_shape_draw(&pane, v21, v32, v34, v35);
      }
      ++v29;
    }
    while ( v18 + v29 < *(_DWORD *)((char *)v42 + 0xDA3) );
  }
  sub_2D218(v42);
}
// 30774: using guessed type int var_94[20];

//----- (00030A90) --------------------------------------------------------
int __fastcall sub_30A90(T_Type5 *a1, int edx0, int a3, int a4)
{
  int v5; // edx
  int v6; // eax
  char *sub_1CEA8; // eax
  int result; // eax
  int *v9; // eax
  LONG v10; // edx
  void *ShapeTable_sub_1B084; // eax
  char *v12; // eax
  int v13; // edx
  int v14; // ebx
  int v15; // ecx
  int v16; // esi
  char *v17; // eax
  void *v18; // eax
  void *v19; // eax
  int v20; // eax
  char *v21; // eax
  LONG v22; // ecx
  void *v23; // eax
  WORD v24; // dx
  char *v25; // eax
  LONG v26; // ecx
  void *v27; // eax
  WORD v28; // dx
  int v29; // eax
  char *v30; // eax
  LONG v31; // ecx
  void *v32; // eax
  LONG v33; // esi
  LONG v34; // ebx
  void *v35; // eax
  int *v36; // edi
  LONG v37; // ebx
  void *v38; // eax
  int v39; // ecx
  __int16 i; // di
  __int16 j; // di
  __int16 k; // di
  LONG v43; // [esp-20h] [ebp-B0h]
  int v44; // [esp-8h] [ebp-98h]
  int v45; // [esp-8h] [ebp-98h]
  int v46; // [esp-8h] [ebp-98h]
  int v47; // [esp-8h] [ebp-98h]
  char v48; // [esp-4h] [ebp-94h]
  int v49; // [esp-4h] [ebp-94h]
  char v50; // [esp-4h] [ebp-94h]
  char v51; // [esp-4h] [ebp-94h]
  char v52; // [esp-4h] [ebp-94h]
  char v53; // [esp-4h] [ebp-94h]
  __int16 v54; // [esp-4h] [ebp-94h]
  char s[52]; // [esp+0h] [ebp-90h] BYREF
  int v56; // [esp+34h] [ebp-5Ch]
  int v57; // [esp+38h] [ebp-58h]
  LONG shape_number; // [esp+3Ch] [ebp-54h]
  char *v59; // [esp+40h] [ebp-50h]
  int a2; // [esp+44h] [ebp-4Ch]
  int v61; // [esp+48h] [ebp-48h]
  LONG v62; // [esp+4Ch] [ebp-44h]
  int v63; // [esp+50h] [ebp-40h]
  int v64; // [esp+54h] [ebp-3Ch]
  int v65; // [esp+58h] [ebp-38h]
  int v66; // [esp+5Ch] [ebp-34h]
  int v67; // [esp+60h] [ebp-30h]
  LONG v68; // [esp+64h] [ebp-2Ch]
  LONG v69; // [esp+68h] [ebp-28h]
  LONG hotY; // [esp+6Ch] [ebp-24h]
  int *v71; // [esp+70h] [ebp-20h]
  int v72; // [esp+74h] [ebp-1Ch]
  int v73; // [esp+78h] [ebp-18h]
  __int16 m; // [esp+7Ch] [ebp-14h]
  int v75; // [esp+80h] [ebp-10h]

  v71 = (int *)edx0;
  v61 = 9;
  if ( a4 && (a3 == 1 || *(_DWORD *)(edx0 + 8) != 0xFFFFFFFF) )
  {
    v61 = 0xF3;
  }
  else
  {
    v5 = v71[2];
    if ( v5 != 0xFFFFFFFF )
    {
      v61 = 4 * v71[v5 + 0xA] + 0x13;
    }
  }
  sprintf(s, "%d.", v71[0x1B]);
  a2 = (__int16)v61;
  WinMgr.LargeFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 5, 5, s, 0, v61, 0xFF, 0);
  HIWORD(v6) = HIWORD(v71);
  if ( v71[2] == 0xFFFFFFFF )
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x10);// 16: "<EMPTY>"
    WinMgr.LargeFont.pane = (PANE)*a1;
    return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x1E, 5, sub_1CEA8, 0, a2, 0xFF, 0);
  }
  LOWORD(v6) = GwshareShpCacheIndexes[0x20];
  v75 = v6;
  v9 = &v71[v71[2]];
  v10 = v9[3];
  v72 = v9[0xA];
  shape_number = v10;
  v48 = v72;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v75);
  sub_53F40(a1, ShapeTable_sub_1B084, v10, 0x19, 5, v48);
  WinMgr.LargeFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 5, V_SpecNames[shape_number], 0, a2, 0xFF, 0);
  v49 = *v71;
  v12 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x11);      // 17: "Day %d"
  sprintf(s, v12, v49);
  WinMgr.LargeFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 0x14, s, 0, a2, 0xFF, 0);
  v13 = ((v71[0x1C] & 0xFE00) >> 9) + 0x50;
  v14 = v71[0x1C] & 0x1F;
  v15 = (v71[0x1C] & 0x1E0) >> 5;
  v63 = (*((_WORD *)v71 + 0x39) & 0xF800) >> 0xB;
  v16 = v63;
  v59 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x12);      // 18: "am"
  if ( v16 )
  {
    if ( v16 == 0xC )
    {
      v17 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x13);  // 19: "pm"
    }
    else
    {
      if ( v16 <= 0xC )
      {
        goto LABEL_16;
      }
      v17 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x13);  // 19: "pm"
      v63 = v16 - 0xC;
    }
    v59 = v17;
    goto LABEL_16;
  }
  v63 = 0xC;
LABEL_16:
  v56 = (*((_WORD *)v71 + 0x39) & 0x7E0) >> 5;
  sprintf(s, "%d/%d/%d", v15, v14, v13);
  v57 = (__int16)v61;
  WinMgr.LargeFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 0x32, s, 0, v61, 0xFF, 0);
  sprintf(s, "%d : %.2d %s", v63, v56, v59);
  WinMgr.LargeFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x2D, 0x41, s, 0, v57, 0xFF, 0);
  v43 = shape_number;
  v18 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);
  VFX_shape_transform((PANE *)a1, v18, v43, 0x96, 0x1E, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  v50 = v72;
  v19 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
  sub_53F40(a1, v19, 3, 0x96, 0x1E, v50);
  LOWORD(v20) = GwshareShpCacheIndexes[0x29];
  v73 = v20;
  v62 = 0xC8;
  v21 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x14);      // 20: "Fleet"
  v67 = 0x14;
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xC8, 5, v21, 0, v57, 0xFF, 0);
  for ( i = 0; i < v71[0x18]; ++i )
  {
    v22 = v62;
    v51 = v72;
    v44 = v67;
    v23 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v73);
    sub_53F40(a1, v23, 5, v22, v44, v51);
    v62 += 8;
    if ( i % 9 == 8 )
    {
      v62 = 0xC8;
      v67 += 8;
    }
  }
  v24 = v61;
  v25 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x15);      // 21: "Colonies"
  v68 = 0x118;
  v66 = 0x14;
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x118, 5, v25, 0, v24, 0xFF, 0);
  for ( j = 0; j < v71[0x19]; ++j )
  {
    v26 = v68;
    v52 = v72;
    v45 = v66;
    v27 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v73);
    sub_53F40(a1, v27, 6, v26, v45, v52);
    v68 += 8;
    if ( j % 9 == 8 )
    {
      v68 = 0x118;
      v66 += 8;
    }
  }
  v28 = v61;
  v29 = v71[0x1A] >> 2;
  v69 = 0x168;
  v64 = v29;
  v65 = 0x14;
  v30 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x16);      // 22: "Discoveries"
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x168, 5, v30, 0, v28, 0xFF, 0);
  for ( k = 0; k < v64; ++k )
  {
    v53 = v72;
    v46 = v65;
    v31 = v69;
    v32 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v73);
    sub_53F40(a1, v32, 7, v31, v46, v53);
    v69 += 8;
    if ( k % 9 == 8 )
    {
      v69 = 0x168;
      v65 += 8;
    }
  }
  hotY = 5;
  v33 = 0x1CC;
  for ( m = 0; ; ++m )
  {
    result = m;
    if ( m >= v71[1] )
    {
      break;
    }
    if ( m != v71[2] )
    {
      v36 = &v71[m];
      if ( v36[0x11] )
      {
        v54 = *((_WORD *)v36 + 0x14);
        v47 = hotY;
        v37 = v36[3];
        v38 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v75);
        sub_53F40(a1, v38, v37, v33, v47, v54);
        v39 = v36[0x11];
        v34 = 0xFFFFFFFF;
        if ( v39 == 3 )
        {
          v34 = 9;
        }
        else if ( v39 == 2 )
        {
          v34 = 8;
        }
        if ( v34 != 0xFFFFFFFF )
        {
          v35 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
          VFX_shape_draw((PANE *)a1, v35, v34, v33, hotY);
        }
        v33 += 0x39;
        if ( v33 > 0x258 )
        {
          v33 = 0x1CC;
          hotY += 0x1B;
        }
      }
    }
  }
  return result;
}
// 30E3F: variable 'v20' is possibly undefined
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00031158) --------------------------------------------------------
int __fastcall sub_31158(_DWORD *a1, int a2, int a3, int a4)
{
  WORD v5; // dx
  char s[12]; // [esp+0h] [ebp-20h] BYREF
  int v8; // [esp+Ch] [ebp-14h]
  int v9; // [esp+10h] [ebp-10h]

  v9 = a2;
  v5 = 9;
  if ( a4 )
  {
    v5 = 0xF3;
  }
  sprintf(s, "%d.", *(_DWORD *)(v9 + 0xDC));
  WinMgr.LargeFont.pane = *(PANE *)a1;
  v8 = v5;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 5, 5, s, 0, v5, 0xFF, 0);
  WinMgr.LargeFont.pane = *(PANE *)a1;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x1E, 5, (const char *)(v9 + 0x14), 0, v8, 0xFF, 0x226);
}

//----- (00031200) --------------------------------------------------------
void __fastcall __spoils<> Q_WndLW_sub_31200(P_WndLW result)
{
  Q_A2Ctor_sub_2C830(&result->a);
  result->a.pProcs = (P_Procs)&off_95E88;
  Q_A1_sub_2C8E4(&result->a.a1);
}
// 95E88: using guessed type int (__fastcall *off_95E88)(P_WndA2 a1);

//----- (0003121C) --------------------------------------------------------
T_WndA2 *__fastcall sub_3121C(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95E74);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95E88;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95E88: using guessed type int (__fastcall *off_95E88)(P_WndA2 a1);

//----- (00031268) --------------------------------------------------------
int __fastcall sub_31268(int a1, unsigned __int16 a2, LONG a3, LONG a4)
{
  const char *v6; // ecx
  T_WndA2 *Wnd_sub_56DA8; // eax
  char v8; // bl
  int v9; // eax
  int v10; // ebx
  _DWORD *ItemData_sub_2ED14; // esi
  char v12; // ah
  const char *v13; // ebp
  T_CFile v14; // [esp+0h] [ebp-144h] BYREF
  char fname[20]; // [esp+118h] [ebp-2Ch] BYREF
  int param2; // [esp+138h] [ebp-Ch]
  int v17[2]; // [esp+13Ch] [ebp-8h]

  LOWORD(v17[1]) = a2;
  v17[0] = a3;
  param2 = a4;
  if ( a2 < 3u )
  {
    if ( a2 != 1 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v17[1], v17[0], param2);
    }
    v6 = "savescr";
    if ( WinMgr.state == 2 )
    {
      *(_BYTE *)(a1 + 0xAF) = 1;
    }
    else if ( WinMgr.state == 4 )
    {
      v6 = "loadscr";
      *(_BYTE *)(a1 + 0xAF) = 0;
    }
    else
    {
      v6 = "tutscr";
      *(_BYTE *)(a1 + 0xAF) = 2;
    }
    Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "LOADLIST", 0);
    v8 = *(_BYTE *)(a1 + 0xAF);
    *(_DWORD *)(a1 + 0xAB) = Wnd_sub_56DA8;
    if ( v8 == 2 )
    {
      LOWORD(Wnd_sub_56DA8[0xD].a1.Unknown_1A) = 0x3C;
      Q_Wnd10LB_SetProc1_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), sub_31158);
      sub_317D0(a1);
    }
    else
    {
      LOWORD(Wnd_sub_56DA8[0xD].a1.Unknown_1A) = 0x55;
      Q_Wnd10LB_SetProc1_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), sub_30A90);
      sub_316A8(a1, (int)sub_30A90);
    }
    strcpy((char *)(a1 + 0x4F), v6);
    strcpy((char *)(*(_DWORD *)(a1 + 0xAB) + 0x4F), v6);
    Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, HIWORD(v6), v17[0], param2);
    return 0;
  }
  if ( a2 <= 3u )
  {
    if ( a3 >= 0x31 && a3 <= 0x39 )
    {
      v9 = 9;
      v10 = a3 - 0x30;
      if ( *(_BYTE *)(a1 + 0xAF) == 1 )
      {
        v9 = 0xA;
      }
      if ( v10 < v9 )
      {
        (*(void (**)(void))(*(_DWORD *)(a1 + 0xA7) + 8))();
        return 0xFFFFFFFF;
      }
    }
    return 0;
  }
  if ( a2 != 0x1C01 )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v17[1], v17[0], param2);
  }
  ItemData_sub_2ED14 = Q_Wnd10LB_GetItemData_sub_2ED14(*(P_Wnd10LB *)(a1 + 0xAB), v17[0]);
  sprintf(fname, "%02d.sav", ItemData_sub_2ED14[0x1B]);
  Q_CFile_Ctor_sub_1BB78(&v14);
  v12 = *(_BYTE *)(a1 + 0xAF);
  if ( v12 == 1 )
  {
    Q_SaveGam_sub_54048(fname);
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
  }
  else if ( v12 )
  {
    v13 = (const char *)(0xE0 * a3 + a1 + 0x9C0);
    strcpy(fname, v13);
    strcat(fname, ".tsv");
    Q_LoadGam_sub_53FB0(fname);
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
    srand(0);
    dword_96BBC = LODWORD(WinMgr.j);
    WinMgr.j = 1.0;
    strcpy(fname, v13);
    strcat(fname, ".bin");
    sub_59988(&WinMgr, fname, 0);
  }
  else if ( ItemData_sub_2ED14[2] != 0xFFFFFFFF )
  {
    Q_LoadGam_sub_53FB0(fname);
    WinMgr.Unknown_4758 = 1;
    WinMgr.Unknown_4736[0] = 0;
    WinMgr.Unknown_4756 = 1;
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 1, 0);
  }
  Q_CFile_Dtor_sub_1BBC8(&v14);
  return 0xFFFFFFFF;
}
// 96BBC: using guessed type int dword_96BBC;
// 31268: using guessed type char fname[20];

//----- (0003160C) --------------------------------------------------------
void __fastcall sub_3160C(int a1)
{
  char v2; // ah
  LONG v3; // edx
  char *v4; // eax
  char *sub_1CEA8; // [esp+0h] [ebp-18h]

  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x17);// 23: "Load Game"
  v2 = *(_BYTE *)(a1 + 0xAF);
  v3 = 0x10;
  if ( v2 == 1 )
  {
    v3 = 0x73;
    v4 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x18);     // 24: "Save Game"
  }
  else
  {
    if ( v2 != 2 )
    {
      goto LABEL_6;
    }
    v4 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x19);     // 25: "Play Tutorial"
    v3 = 0;
  }
  sub_1CEA8 = v4;
LABEL_6:
  if ( v3 )
  {
    VFX_pane_wipe((PANE *)(a1 + 4), v3);
  }
  WinMgr.LargeFont.pane = *(PANE *)(a1 + 4);
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 4, sub_1CEA8, 3, 0xFFFF, 0xFF, 0);
  sub_2D218((_DWORD *)a1);
}

//----- (000316A8) --------------------------------------------------------
void __fastcall sub_316A8(int a1, int a2)
{
  int v3; // kr00_4
  unsigned __int16 v4; // dx
  int i; // edi
  T_CFile handle; // [esp+0h] [ebp-158h] BYREF
  char s[32]; // [esp+118h] [ebp-40h] BYREF
  int v8; // [esp+138h] [ebp-20h]
  int v9; // [esp+13Ch] [ebp-1Ch]

  v9 = a1;
  sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xAB));
  Q_CFile_Ctor_sub_1BB78(&handle);
  v3 = a1 + 0xB0;
  for ( i = 0; i < 0x14; ++i )
  {
    v8 = i + 1;
    sprintf(s, "%02d.sav", i + 1);
    if ( access(s, 0) )
    {
      *(_DWORD *)(v3 + 0x74 * i + 8) = 0xFFFFFFFF;
    }
    else
    {
      Q_CFile_OpenFile_sub_1BBFC(&handle, s, 0x200, 0);
      Q_ReadFile_sub_1BF94(&handle, (void *)(v3 + 0x74 * i), 0x74u);
      dos_getftime(handle.fh, (unsigned __int16 *)(v3 + 0x74 * i + 0x70), (unsigned __int16 *)(v3 + 0x74 * i + 0x72));
    }
    *(_DWORD *)(v3 + 0x74 * i + 0x6C) = v8;
    Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(v9 + 0xAB), (BYTE *)(v3 + 0x74 * i), 0xFFFFFFFF, 0);
    v4 = i;
    Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(v9 + 0xAB), v4, *(_BYTE *)(v9 + 0xAF) == 1);
  }
  Q_CFile_Dtor_sub_1BBC8(&handle);
}
// 316A8: using guessed type T_CFile handle;

//----- (000317D0) --------------------------------------------------------
int __fastcall sub_317D0(int a1)
{
  FILE *v1; // ebp
  int v2; // esi
  int v3; // kr00_4
  int v4; // eax
  int v6; // kr04_4
  int v7; // [esp+0h] [ebp-24h] BYREF
  int v8; // [esp+4h] [ebp-20h]
  int v9; // [esp+8h] [ebp-1Ch]

  v8 = a1;
  sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xAB));
  v1 = Q_OpenFile_sub_1BB10("tutindex.txt", 0);
  fscanf(v1, "%d", &v7);
  if ( v7 > 7 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\loadwin.cpp", 0x1EA);
  }
  v9 = 0;
  if ( v7 > 0 )
  {
    v2 = v8 + 0x9C0;
    v3 = v8 + 0x9D4;
    v6 = 0;
    do
    {
      fscanf(v1, "%s", v2 + 0xE0 * v6);
      Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v1, (char *)(v3 + 0xE0 * v6));
      Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(v8 + 0xAB), (BYTE *)(v2 + 0xE0 * v6), 0xFFFFFFFF, 0);
      v4 = v9 + 1;
      *(_DWORD *)(v2 + 0xE0 * v6 + 0xDC) = v9 + 1;
      v9 = v4;
      ++v6;
    }
    while ( v4 < v7 );
  }
  return fclose(v1);
}

//----- (000318A0) --------------------------------------------------------
int __fastcall sub_318A0(unsigned __int16 a1, unsigned __int8 a2)
{
  int v3; // esi
  unsigned int v4; // edx
  int v5; // edi
  _DWORD *v7; // eax
  int v8; // ebx

  LOWORD(v3) = *((_WORD *)dword_10032C + a1);
  if ( (unsigned __int16)v3 == 0xFFFF )
  {
    return 0;
  }
  HIWORD(v3) = 0;
  v4 = dword_100328 + 4 * (unsigned __int16)word_100330;
  v5 = a2;
  v7 = (_DWORD *)(dword_100328 + 4 * v3);
  v8 = (v5 << 0x10) + a1;
  if ( (unsigned int)v7 >= v4 )
  {
    return 0;
  }
  while ( v8 != *v7 )
  {
    if ( (unsigned int)++v7 >= v4 )
    {
      return 0;
    }
  }
  return (unsigned __int16)(((int)v7 - dword_100328) / 4) + 0x102;
}
// 100328: using guessed type int dword_100328;
// 100330: using guessed type __int16 word_100330;

//----- (00031934) --------------------------------------------------------
unsigned __int8 __fastcall sub_31934(int a1)
{
  char v1; // ch
  unsigned __int16 v2; // si
  char v3; // dh
  char v4; // al
  int v5; // edx
  unsigned __int8 result; // al
  char v7; // ch
  int v8; // ebx

  v1 = byte_100335;
  v2 = a1;
  v3 = (a1 << byte_100335) | *(_BYTE *)dword_100324++;
  *(_BYTE *)(dword_100324 - 1) = v3;
  v4 = byte_100334;
  if ( (unsigned __int16)(dword_100324 - dword_100338) == 0x100 )
  {
    *(_BYTE *)dword_100338 = 0xFF;
    dword_100338 = dword_100324++;
  }
  v5 = (int)v2 >> (8 - v1);
  result = v4 - (8 - v1);
  v7 = 0;
  v8 = dword_100324;
  *(_BYTE *)dword_100324 = v5;
  if ( result >= 8u )
  {
    dword_100324 = v8 + 1;
    if ( (unsigned __int16)(v8 + 1 - dword_100338) == 0x100 )
    {
      *(_BYTE *)dword_100338 = 0xFF;
      dword_100338 = dword_100324++;
    }
    if ( result > 8u )
    {
      v7 = result - 8;
      *(_BYTE *)dword_100324 = BYTE1(v5);
    }
  }
  else
  {
    v7 = result;
  }
  byte_100335 = v7;
  return result;
}
// 100324: using guessed type int dword_100324;
// 100334: using guessed type char byte_100334;
// 100335: using guessed type char byte_100335;
// 100338: using guessed type int dword_100338;

//----- (00031A34) --------------------------------------------------------
int __fastcall sub_31A34(unsigned __int16 a1, char a2)
{
  int v2; // ecx
  unsigned __int16 v3; // bx
  _WORD *v4; // edx
  int result; // eax

  v2 = dword_100328;
  v3 = word_100330;
  *(_BYTE *)(dword_100328 + 4 * (unsigned __int16)word_100330 + 2) = a2;
  *(_WORD *)(v2 + 4 * v3) = a1;
  v4 = (char *)dword_10032C + 2 * a1;
  if ( (unsigned __int16)*v4 == 0xFFFF )
  {
    *v4 = word_100330;
  }
  sub_31934(a1);
  result = (unsigned __int16)++word_100330 + 0x102;
  if ( result > (unsigned __int16)word_100332 )
  {
    if ( result <= 0x1000 )
    {
      BYTE1(result) = byte_100334 + 1;
      word_100332 *= 2;
      ++byte_100334;
    }
    else
    {
      sub_31934(0x100);
      result = (int)dword_10032C;
      byte_100334 = 9;
      word_100332 = 0x200;
      word_100330 = 0;
      memset(dword_10032C, 0xFF, 0x2008u);
    }
  }
  return result;
}
// 100328: using guessed type int dword_100328;
// 100330: using guessed type __int16 word_100330;
// 100332: using guessed type __int16 word_100332;
// 100334: using guessed type char byte_100334;

//----- (00031B08) --------------------------------------------------------
int sub_31B08()
{
  int v0; // ebx
  unsigned __int16 v1; // ax
  int v2; // kr04_4
  UBYTE v3; // cl
  int v4; // ebx
  int v5; // eax
  char v6; // dh
  int result; // eax
  _BYTE *v8; // ebx
  int v9; // ebx
  char v10; // bl

  v0 = dword_100324;
  byte_100334 = 9;
  word_100332 = 0x200;
  *(_BYTE *)dword_100324 = 8;
  byte_100335 = 0;
  dword_100338 = v0 + 1;
  dword_100324 = v0 + 2;
  sub_31934(0x100);
  v1 = *V_Window1.buffer;
  v2 = 0;
  do
  {
    v3 = V_Window1.buffer[v2 + 1];
    v4 = v1;
    v1 = sub_318A0(v1, v3);
    if ( !v1 )
    {
      sub_31A34(v4, v3);
      v1 = v3;
    }
    ++v2;
  }
  while ( v2 + 1 < 0x4B000 );
  sub_31934(v1);
  sub_31934(0x101);
  LOWORD(v5) = dword_100324;
  LOWORD(v4) = dword_100338;
  v6 = byte_100335;
  result = v5 - v4;
  if ( byte_100335 )
  {
    *(_BYTE *)dword_100338 = result;
    v8 = (_BYTE *)(dword_100324 + 1);
    dword_100324 = (int)v8;
    *v8 = 0;
    v9 = (int)(v8 + 1);
  }
  else
  {
    v10 = result;
    if ( (unsigned __int16)result == 1 )
    {
      result = dword_100338;
      *(_BYTE *)dword_100338 = byte_100335;
      return result;
    }
    result = dword_100338;
    *(_BYTE *)dword_100338 = v10 - 1;
    v9 = dword_100324 + 1;
    *(_BYTE *)dword_100324 = v6;
  }
  dword_100324 = v9;
  return result;
}
// 31BC0: variable 'v5' is possibly undefined
// 100324: using guessed type int dword_100324;
// 100332: using guessed type __int16 word_100332;
// 100334: using guessed type char byte_100334;
// 100335: using guessed type char byte_100335;
// 100338: using guessed type int dword_100338;

//----- (00031C18) --------------------------------------------------------
int __fastcall sub_31C18(int result, int a2)
{
  RGB *v2; // kr00_4
  int v3; // edi
  _WORD *v4; // ebp
  _BYTE *v5; // ebp
  _BYTE *v6; // kr08_4
  int v7; // ebp
  void *v8; // ecx
  int v9; // esi
  LONG i; // esi
  int j; // esi
  int v12; // [esp-4h] [ebp-30h]
  char s[20]; // [esp+0h] [ebp-2Ch] BYREF
  RGB *triplet; // [esp+14h] [ebp-18h]

  if ( a2 >= (int)&V_CobFiles.fnames[0x17][0x16] )
  {
    V_Window1.buffer = (UBYTE *)result;
    V_Window1.x_max = 0x27F;
    V_Window1.y_max = 0x1DF;
    V_Window1.shadow = 0;
    V_Window1.stencil = 0;
    triplet = (RGB *)(result + 0x4B000);
    VFX_window_read(&V_Window1, 0, 0, 0x27F, 0x1DF);
    dword_100308 = (int)triplet;
    v2 = triplet;
    triplet += 0x100;
    for ( i = 0; i < 0x100; ++i )
    {
      VFX_DAC_read(i, &v2[i]);
    }
    buf = triplet;
    memset(triplet, 0, (size_t)&loc_493DC + 4);
    dword_100328 = (int)triplet + (_DWORD)&loc_493DC + 4;
    word_100330 = 0;
    triplet = (RGB *)((char *)triplet + (_DWORD)&loc_493DC + 4 + 0x4000);
    dword_10032C = triplet;
    dword_100324 = (int)buf;
    memset(triplet, 0xFF, 0x2008u);
    v3 = dword_100324;
    qmemcpy((void *)dword_100324, "GIF87a", 4u);
    qmemcpy((void *)(v3 + 4), "7a", 2u);
    v4 = (_WORD *)(dword_100324 + 6);
    *(_WORD *)(dword_100324 + 6) = 0x280;
    *++v4 = 0x1E0;
    *(_BYTE *)++v4 = 0x87;
    v4 = (_WORD *)((char *)v4 + 1);
    *(_BYTE *)v4 = 0xFF;
    v5 = (char *)v4 + 1;
    *v5 = 0;
    v6 = v5 + 1;
    for ( j = 0; j < 0x300; ++j )
    {
      v5[j + 1] = 0xFF * *(unsigned __int8 *)(j + dword_100308) / 0x3F;
    }
    v6[j] = 0x2C;
    *(_WORD *)&v6[j + 1] = 0;
    *(_WORD *)&v6[j + 3] = 0;
    *(_WORD *)&v6[j + 5] = 0x280;
    *(_WORD *)&v6[j + 7] = 0x1E0;
    v6[j + 9] = 7;
    dword_100324 = (int)&v6[j + 0xA];
    sub_31B08();
    v12 = dword_10033C;
    v7 = dword_100324;
    *(_BYTE *)dword_100324 = 0x3B;
    ++v7;
    v8 = buf;
    dword_100324 = v7;
    sprintf(s, "scr%03d.gif", v12);
    v9 = open(s, 0x262, 0x1C0);
    write(v9, buf, v7 - (_DWORD)v8);
    result = close(v9);
    dword_100324 = 0;
    dword_10032C = 0;
    dword_100328 = 0;
    buf = 0;
    V_Window1.buffer = 0;
    dword_100308 = 0;
    ++dword_10033C;
  }
  return result;
}
// 100308: using guessed type int dword_100308;
// 100324: using guessed type int dword_100324;
// 100328: using guessed type int dword_100328;
// 100330: using guessed type __int16 word_100330;
// 10033C: using guessed type int dword_10033C;

//----- (00031E60) --------------------------------------------------------
void __fastcall Q_AppendRomanNum_sub_31E60(char *a1, int number)
{
  int v3; // kr04_4
  char *v4; // edi

  if ( number < 0 || !a1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\name.cpp", 0x29);
  }
  if ( number > 1000 )
  {
    v4 = a1;
    v3 = 0;
    do
    {
      if ( 0x3E8 * v3 + 1000 >= 4000 )
      {
        break;
      }
      strcat(v4, "M");
      ++v3;
    }
    while ( 0x3E8 * v3 + 1000 < number );
  }
  strcat(a1, V_Romans100[number / 100 % 10]);
  strcat(a1, V_Romans10[number / 10 % 10]);
  strcat(a1, V_Romans1[number % 10]);
}

//----- (00031FB0) --------------------------------------------------------
int __fastcall sub_31FB0(_DWORD *a1, const char *a2, int a3, int a4)
{
  unsigned __int8 v5; // dl
  int v7; // [esp-4h] [ebp-10h]

  v5 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  if ( a4 == 0xFFFFFFFF )
  {
    v5 = 0xF3;
  }
  v7 = a1[3] - a1[1] - 0x10;
  WinMgr.LargeFont.pane = *(PANE *)a1;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 8, 3, a2, 0, v5, 0xFF, v7);
}

//----- (0003201C) --------------------------------------------------------
void __fastcall __spoils<> Q_WndNW_sub_3201C(P_WndNW a1)
{
  Q_A2Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = (P_Procs)&off_95F1C;
  Q_WndNW_sub_3207C(a1);
}
// 95F1C: using guessed type int (__fastcall *off_95F1C)(P_WndA2 a1);

//----- (00032038) --------------------------------------------------------
T_WndA2 *__fastcall sub_32038(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95ED8);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95F1C;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95F1C: using guessed type int (__fastcall *off_95F1C)(P_WndA2 a1);

//----- (0003207C) --------------------------------------------------------
void __fastcall __spoils<> Q_WndNW_sub_3207C(P_WndNW result)
{
  result->b = 0;
  result->c = 0;
  result->d = 0;
  result->f = 0xFFFF;
  result->g = 0xFFFF;
  result->h = 0xFFFF;
}

//----- (000320B8) --------------------------------------------------------
unsigned int __fastcall sub_320B8(int a1, __int16 a2, LONG a3, LONG a4)
{
  int v5; // edi
  T_WndA2 *v6; // eax
  T_WndA2 *v7; // eax
  T_WndA2 *v8; // eax
  char Unknown_1E9; // bl
  int v10; // eax
  T_Race *v11; // eax
  int v12; // edx
  __int16 v13; // ax
  __int16 v14; // ax
  int v16; // edx
  char v17[32]; // [esp+0h] [ebp-44h] BYREF
  char v18[16]; // [esp+20h] [ebp-24h] BYREF
  int v19; // [esp+30h] [ebp-14h]
  int v20; // [esp+34h] [ebp-10h]
  int v21; // [esp+38h] [ebp-Ch]
  int param2; // [esp+3Ch] [ebp-8h]
  __int16 v23; // [esp+40h] [ebp-4h]

  v23 = a2;
  v5 = a3;
  param2 = a4;
  v19 = V_PlayerRaceIndex;
  v21 = (unsigned __int8)byte_968DD;
  if ( (unsigned __int16)a2 < 4u )
  {
    if ( !a2 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    if ( (unsigned __int16)a2 <= 1u )
    {
      if ( !*(_DWORD *)(a1 + 0xAB) )
      {
        a3 = 0xD;
        a4 = 0;
        v6 = sub_56E18(&WinMgr, "PLAYERDIP", 0xD, 0);
        *(_DWORD *)(a1 + 0xAB) = v6;
        if ( !v6 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x7B);
        }
      }
      *(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xAB) = 0;
      *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8C9) = 0x1D;
      Q_Wnd10LB_SetProc1_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), sub_31FB0);
      sub_2E9CC(*(P_Wnd10LB *)(a1 + 0xAB), 0);
      *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + 0xC6) = 0xF2;
      if ( !*(_DWORD *)(a1 + 0xAF) )
      {
        a3 = 0xD;
        a4 = 0;
        v7 = sub_56E18(&WinMgr, "ALIENDIP", 0xD, 0);
        *(_DWORD *)(a1 + 0xAF) = v7;
        if ( !v7 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x88);
        }
      }
      if ( !*(_DWORD *)(a1 + 0xB3) )
      {
        a3 = 0xD;
        a4 = 0;
        v8 = sub_56E18(&WinMgr, "COSMOSWnd", 0xD, 0);
        *(_DWORD *)(a1 + 0xB3) = v8;
        if ( !v8 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x8F);
        }
      }
      sub_32658(a1);
      sub_32E84(a1, 0, a3, a4);
      *(_WORD *)(*(_DWORD *)(a1 + 0xAF) + 0xB1) = 4 * V_Game.races[(unsigned __int8)byte_968DD].Unknown_02 + 0x13;
      memset(byte_101DC4, 0, 0xFu);
      Unknown_1E9 = V_Game.races[v21].Unknown_1E9;
      v10 = v19;
      *(_DWORD *)(a1 + 0xB7) = 0;
      v11 = &V_Game.races[v10];
      if ( Unknown_1E9 == 0xE )
      {
        v14 = sub_44238((int)v11, (unsigned __int8)byte_968DD, v18, *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
        sub_32A48(a1, (int)v18, v14, 0xFFFFFFFF, 0xFFFFFFFF);
        sub_32C14(a1, 0x1D);
      }
      else
      {
        v20 = Unknown_1E9;
        v12 = (__int16)v21;
        *(_DWORD *)(a1 + 0xB7) = 0xFFFFFFFF;
        v13 = sub_44A2C(v11, v12, Unknown_1E9, v17);
        sub_32B44(a1, (int)v17, v13);
        sub_32BDC(a1, v20);
      }
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    if ( a2 != 2 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    sub_2D258((P_WndA2)a1, v23);
    return 0;
  }
  if ( (unsigned __int16)a2 <= 5u )
  {
    if ( a3 >= 0xAE && a3 <= 0x147 && a4 >= 0x145 && a4 <= 0x1D8 )
    {
      Q_StartSample_sub_4FB90(&V_SoundSystem, 0);
      sub_32714(a1, a3, a4);
      return 0xFFFFFFFF;
    }
    return 0;
  }
  if ( (unsigned __int16)a2 < 0xCu )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
  }
  if ( (unsigned __int16)a2 <= 0xCu )
  {
    if ( a3 < 0xAE || a3 > 0x147 || a4 < 0x145 || a4 > 0x1D8 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)"tinyrace", 0);
    return 0xFFFFFFFF;
  }
  else
  {
    if ( a2 != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v23, v5, param2);
    }
    v16 = sub_2ECA4(*(_DWORD *)(a1 + 0xAB), a3);
    sub_32800(a1, v16);
    if ( *(_DWORD *)(a1 + 0xB7) == 0xFFFFFFFF )
    {
      *(_DWORD *)(a1 + 0xB7) = 0;
    }
    return 0xFFFFFFFF;
  }
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032414) --------------------------------------------------------
void __fastcall sub_32414(int a1)
{
  T_WndA2 *Wnd_sub_56DA8; // eax
  __int16 v2; // di
  void *v3; // eax
  WORD v4; // bx
  __int16 v5; // ax
  __int16 v6; // dx
  LONG v7; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v9; // eax
  char *sub_1CEA8; // eax
  LONG v11; // [esp-1Ch] [ebp-50h]
  LONG v12; // [esp-8h] [ebp-3Ch]
  PANE pane; // [esp+0h] [ebp-34h] BYREF
  _DWORD *v14; // [esp+14h] [ebp-20h]
  LONG v15; // [esp+18h] [ebp-1Ch]
  int v16; // [esp+1Ch] [ebp-18h]

  v14 = (_DWORD *)a1;
  pane = V_Type6_stru_D8654.pane;
  if ( *(_WORD *)(a1 + 0xC1) )
  {
    pane.x0 = 0xAE;
    pane.y0 = 0x145;
    pane.x1 = 0x147;
    pane.y1 = 0x1D8;
    VFX_pane_wipe(&pane, 0xF2);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
    Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "INTELSCREEN", 0);
    LOWORD(Wnd_sub_56DA8) = GwshareShpCacheIndexes[0x29];
    v16 = (int)Wnd_sub_56DA8;
    if ( *(__int16 *)((char *)v14 + 0xC1) > 0 )
    {
      v2 = 0;
      do
      {
        v4 = *((_WORD *)&dword_96840 + v2 + 1);
        v5 = word_9682E[v2];
        v6 = word_96838[v2];
        v7 = v5;
        v11 = v5;
        v15 = v6;
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[v4]);
        VFX_shape_transform(&V_Type6_stru_D8654.pane, ShapeTable_sub_1B084, 0, v11, v6, V_BigBuffer, 0, 0x8000, 0x8000, 0);
        v12 = v15;
        if ( v2 == *(_WORD *)((char *)v14 + 0xBF) )
        {
          v9 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v16);
          Q_DrawRaceTintedShape_sub_53EB8(&V_Type6_stru_D8654.pane, v9, 4, v7, v12, v4);
        }
        else
        {
          v3 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v16);
          Q_DrawRaceTintedShape_sub_53EB8(&V_Type6_stru_D8654.pane, v3, 3, v7, v12, v4);
        }
        ++v2;
      }
      while ( v2 < *(__int16 *)((char *)v14 + 0xC1) );
    }
  }
  pane.x0 = 7;
  pane.y0 = 0x145;
  pane.x1 = 0xA5;
  pane.y1 = 0x163;
  VFX_pane_wipe(&pane, 0xF2);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1A);// 26: "Selected System"
  WinMgr.SmallFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 2, 2, sub_1CEA8, 0, 0xFFFF, 0xFF, 0);
  WinMgr.LargeFont.pane = pane;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0xD, V_Game.pCurStar->name, 0, 0xFFFF, 0xFF, 0);
  if ( *(_WORD *)((char *)v14 + 0x6B) )
  {
    sub_2D218(v14);
  }
}
// 9682E: using guessed type __int16 word_9682E[5];
// 96838: using guessed type __int16 word_96838[4];
// 96840: using guessed type int dword_96840;
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00032658) --------------------------------------------------------
void *__fastcall sub_32658(int a1)
{
  void *result; // eax
  WORD v3; // dx
  int v4; // ebx

  *(_WORD *)(a1 + 0xC1) = 0;
  *(_WORD *)(a1 + 0xBF) = 0;
  result = (char *)&dword_96840 + 2;
  memset((char *)&dword_96840 + 2, 0xFFFFFFFF, 0xAu);
  if ( V_Game.racesNum > 0 )
  {
    v3 = 0;
    do
    {
      result = (void *)v3;
      if ( v3 != V_PlayerRaceIndex
        && v3 != (unsigned __int8)byte_968DD
        && V_Game.races[v3].Unknown_03 != 0xFFFFFFFF
        && V_Game.races[V_PlayerRaceIndex].treaties[v3] )
      {
        if ( V_Game.races[(unsigned __int8)byte_968DD].treaties[v3] )
        {
          LOWORD(result) = *(_WORD *)(a1 + 0xC1);
          v4 = (__int16)result;
          result = (char *)result + 1;
          *(_WORD *)(a1 + 0xC1) = (_WORD)result;
          *((_WORD *)&dword_96840 + v4 + 1) = v3;
        }
      }
      ++v3;
    }
    while ( v3 < V_Game.racesNum );
  }
  return result;
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032714) --------------------------------------------------------
int __fastcall sub_32714(int a1, int a2, __int16 a3)
{
  __int16 v5; // dx
  int result; // eax
  __int16 v7; // cx
  __int16 v8; // bx
  int v9; // edx
  __int16 v10; // ax
  char v11[16]; // [esp+0h] [ebp-20h] BYREF
  int v12; // [esp+10h] [ebp-10h]

  v12 = a2;
  v5 = *(_WORD *)(a1 + 0xC1);
  result = 0;
  if ( v5 > 0 )
  {
    do
    {
      v7 = v12 - word_9682E[(__int16)result];
      v8 = a3 - word_96838[(__int16)result];
      if ( v7 < 0x16 && v7 > (int)0xFFFFFFEA && v8 < 0x16 && v8 > (int)0xFFFFFFEA )
      {
        break;
      }
      ++result;
    }
    while ( (__int16)result < *(__int16 *)(a1 + 0xC1) );
  }
  if ( (__int16)result < *(__int16 *)(a1 + 0xC1) && (_WORD)result != *(_WORD *)(a1 + 0xBF) )
  {
    v9 = *(_DWORD *)(a1 + 0xB7);
    *(_WORD *)(a1 + 0xBF) = result;
    if ( !v9 )
    {
      v10 = sub_44238(
              (int)&V_Game.races[V_PlayerRaceIndex],
              (unsigned __int8)byte_968DD,
              v11,
              *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
      sub_32A48(a1, (int)v11, v10, 0, 0xFFFFFFFF);
    }
    return (*(int (**)(void))(*(_DWORD *)(a1 + 0xA7) + 0xC))();
  }
  return result;
}
// 9682E: using guessed type __int16 word_9682E[5];
// 96838: using guessed type __int16 word_96838[4];
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032800) --------------------------------------------------------
void __fastcall sub_32800(int a1, int a2)
{
  int v3; // ebx
  T_Race *v4; // edi
  __int16 v5; // ax
  char v6; // bl
  char v7; // cl
  __int16 v8; // ax
  char v9[16]; // [esp+0h] [ebp-30h] BYREF
  char v10[16]; // [esp+10h] [ebp-20h] BYREF
  int pCurStar; // [esp+20h] [ebp-10h]
  int v12; // [esp+24h] [ebp-Ch]
  int v13; // [esp+28h] [ebp-8h]
  P_Race v14; // [esp+2Ch] [ebp-4h]

  v13 = V_PlayerRaceIndex;
  v3 = (unsigned __int8)byte_968DD;
  v14 = &V_Game.races[V_PlayerRaceIndex];
  v4 = &V_Game.races[v3];
  if ( *(_DWORD *)(a1 + 0xB7) != 0xFFFFFFFF )
  {
    v6 = a2;
    if ( (_BYTE)a2 == 0xE )
    {
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
      return;
    }
    pCurStar = 0;
    byte_101DC4[a2] = 1;
    if ( (unsigned __int8)a2 < 9u )
    {
      if ( (_BYTE)a2 != 7 )
      {
        goto LABEL_14;
      }
    }
    else if ( (unsigned __int8)a2 > 0xBu )
    {
      if ( (_BYTE)a2 == 0xC )
      {
        pCurStar = (int)V_Game.pCurStar;
      }
      goto LABEL_14;
    }
    pCurStar = *((__int16 *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1);
LABEL_14:
    v12 = (char)a2;
    v7 = sub_44BCC(v4, (__int16 *)V_PlayerRaceIndex, a2, pCurStar, 0);
    sub_32C14(a1, v7);
    sub_450B0(v14, (unsigned __int8)byte_968DD, v6, v7, pCurStar, 0);
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, *(_DWORD *)(*(_DWORD *)(a1 + 0xB3) + 0x41), 0xD, 0, 0);
    v8 = sub_44238((int)v14, (unsigned __int8)byte_968DD, v10, *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
    sub_32A48(a1, (int)v10, v8, 0xFFFFFFFF, 0xFFFFFFFF);
    return;
  }
  if ( (_BYTE)a2 == 1 )
  {
    V_Game.pCurStar = (P_Star)V_Game.races[(unsigned __int8)byte_968DD].Unknown_1EA;
    Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 0);
  }
  else
  {
    sub_450B0(&V_Game.races[v3], v13, v4->Unknown_1E9, a2, v4->Unknown_1EA, 0);
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, *(_DWORD *)(*(_DWORD *)(a1 + 0xB3) + 0x41), 0xD, 0, 0);
    v4->Unknown_1E9 = 0xE;
    v5 = sub_44238((int)v14, (unsigned __int8)byte_968DD, v9, *((_WORD *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1));
    sub_32A48(a1, (int)v9, v5, 0xFFFFFFFF, 0xFFFFFFFF);
    sub_32BDC(a1, 0xE);
  }
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;

//----- (00032A1C) --------------------------------------------------------
__int64 __fastcall sub_32A1C(int a1)
{
  if ( !*(_DWORD *)(a1 + 0xB7) )
  {
    sub_32A48(a1, 0, 0, 0, 0);
  }
  return (unsigned int)(*(int (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
}

//----- (00032A48) --------------------------------------------------------
__int64 __fastcall sub_32A48(int a1, int a2, __int16 a3, int a4, int a5)
{
  T_Wnd10LB *v6; // eax
  __int16 v7; // si
  __int16 Unknown_8CD; // dx
  int v9; // edx
  char *v10; // eax
  unsigned __int16 v11; // ax
  T_Wnd10LB *v13; // [esp+0h] [ebp-18h]
  unsigned __int16 v14; // [esp+8h] [ebp-10h]

  word_103F94 = 0;
  if ( a5 )
  {
    qmemcpy(byte_100340, (const void *)a2, 0xCu);
    qmemcpy(&byte_100340[0xC], (const void *)(a2 + 0xC), 3u);
    word_100350 = a3;
  }
  v6 = *(T_Wnd10LB **)(a1 + 0xAB);
  Unknown_8CD = v6->Unknown_8CD;
  sub_2ED4C(v6);
  v14 = Unknown_8CD;
  if ( word_100350 > 0 )
  {
    v7 = 0;
    do
    {
      v9 = byte_100340[v7];
      if ( !byte_101DC4[v9] )
      {
        v10 = sub_32C48(a1, v9, 0xFFFFFFFF, 0xFFFFFFFF);
        v13 = *(T_Wnd10LB **)(a1 + 0xAB);
        v11 = Q_Wnd10LB_AddItem_sub_2EA8C(v13, v10, 0xFFFFFFFF, 0);
        Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xAB), v11, byte_100340[v7]);
      }
      ++v7;
    }
    while ( v7 < word_100350 );
  }
  if ( !a4 )
  {
    sub_2ECDC(*(P_Wnd10LB *)(a1 + 0xAB), v14);
  }
  return (unsigned int)(*(int (__cdecl **)(T_Wnd10LB *))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xA7) + 0xC))(v13);
}
// 32B38: variable 'v13' is possibly undefined
// 100350: using guessed type __int16 word_100350;
// 103F94: using guessed type __int16 word_103F94;

//----- (00032B44) --------------------------------------------------------
__int64 __fastcall sub_32B44(int a1, int a2, __int16 a3)
{
  T_Wnd10LB *v4; // eax
  char *v5; // eax
  unsigned __int16 v6; // ax
  int i; // edi
  char *v9; // [esp+0h] [ebp-1Ch]

  v4 = *(T_Wnd10LB **)(a1 + 0xAB);
  word_103F94 = 0;
  sub_2ED4C(v4);
  for ( i = 0; (__int16)i < a3; ++i )
  {
    v9 = (char *)((__int16)i + a2);
    v5 = sub_32C48(a1, *v9, 0xFFFFFFFF, 0);
    v6 = Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(a1 + 0xAB), v5, 0xFFFFFFFF, 0);
    Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xAB), v6, *v9);
  }
  return (unsigned int)(*(int (**)(void))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xA7) + 0xC))();
}
// 103F94: using guessed type __int16 word_103F94;

//----- (00032BDC) --------------------------------------------------------
__int64 __fastcall sub_32BDC(int a1, char a2)
{
  *(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xAB) = sub_32C48(a1, a2, 0, 0xFFFFFFFF);
  return (unsigned int)(*(int (**)(void))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xA7) + 0xC))();
}

//----- (00032C14) --------------------------------------------------------
__int64 __fastcall sub_32C14(int a1, char a2)
{
  *(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xAB) = sub_32C48(a1, a2, 0, 0);
  return (unsigned int)(*(int (**)(void))(*(_DWORD *)(*(_DWORD *)(a1 + 0xAF) + 0xA7) + 0xC))();
}

//----- (00032C48) --------------------------------------------------------
char *__fastcall sub_32C48(int a1, char a2, int a3, int a4)
{
  char *v5; // ebx
  char *v6; // ebx
  char *v7; // edx
  char *name; // esi
  char v9; // al
  char *v12; // [esp+4h] [ebp-18h]

  if ( word_103F94 >= 0xF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x27B);
  }
  if ( a3 )
  {
    v12 = (char *)&unk_103454 + 0xB4 * word_103F94 + 0xB4;
  }
  else
  {
    v12 = (char *)&unk_103454;
  }
  if ( a4 )
  {
    if ( a3 )
    {
      v5 = (char *)&unk_100744 + 0x80 * a2;
    }
    else
    {
      v5 = (char *)&unk_101DD4 + 0x80 * a2;
    }
  }
  else
  {
    if ( a3 )
    {
      v6 = (char *)&unk_100EC4;
    }
    else
    {
      v6 = (char *)&unk_102554;
    }
    v5 = &v6[0x80 * a2];
  }
  v7 = v12;
  while ( *v5 )
  {
    name = 0;
    if ( *v5 == 0x25 )
    {
      v9 = v5[1];
      if ( (unsigned __int8)v9 < 0x73u )
      {
        if ( v9 == 0x6D )
        {
          if ( a3 )
          {
            goto LABEL_16;
          }
LABEL_18:
          name = V_SpecNames[V_Game.races[(unsigned __int8)byte_968DD]._nameIndex];
        }
      }
      else
      {
        if ( (unsigned __int8)v9 <= 0x73u )
        {
          if ( a3 )
          {
            name = V_Game.pCurStar->name;
          }
          else
          {
            name = (char *)(V_Game.races[(unsigned __int8)byte_968DD].Unknown_1EA + 0x1C);
          }
          goto LABEL_32;
        }
        if ( (unsigned __int8)v9 <= 0x74u )
        {
          if ( a3 == 0xFFFFFFFF && a4 == 0xFFFFFFFF )
          {
            name = V_SpecNames[V_Game.races[*((__int16 *)&dword_96840 + *(__int16 *)(a1 + 0xBF) + 1)]._nameIndex];
          }
          else
          {
            name = V_SpecNames[V_Game.races[V_Game.races[(unsigned __int8)byte_968DD].Unknown_1EA]._nameIndex];
          }
        }
        else if ( v9 == 0x79 )
        {
          if ( !a3 )
          {
LABEL_16:
            name = V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex];
            goto LABEL_32;
          }
          goto LABEL_18;
        }
      }
    }
LABEL_32:
    if ( name )
    {
      strcpy(v7, name);
      ++v5;
      v7 += strlen(v7);
    }
    else
    {
      *v7++ = *v5;
    }
    ++v5;
  }
  *v7 = 0;
  if ( a3 )
  {
    ++word_103F94;
  }
  return v12;
}
// 96840: using guessed type int dword_96840;
// 968DD: using guessed type char byte_968DD;
// 103F94: using guessed type __int16 word_103F94;

//----- (00032E84) --------------------------------------------------------
int __fastcall sub_32E84(int a1, int a2, int a3, int a4)
{
  FILE *v5; // eax
  FILE *v6; // esi
  int result; // eax
  FILE *v8; // eax
  FILE *v9; // esi
  char s[16]; // [esp+0h] [ebp-34h] BYREF
  char v11[36]; // [esp+10h] [ebp-24h] BYREF

  if ( (unsigned __int8)byte_968DD >= 0x15u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2D6);
  }
  if ( V_PlayerRaceIndex >= 0x15u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2D7);
  }
  sprintf(s, "RACE%02d.DIP", V_Game.races[(unsigned __int8)byte_968DD]._nameIndex);
  strcpy(v11, "PLAYER.DIP");
  if ( *(_WORD *)(a1 + 0xBB) != (unsigned __int8)byte_968DD )
  {
    v5 = Q_OpenFile_sub_1BB10(s, 0);
    v6 = v5;
    if ( !v5 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2E4);
    }
    sub_32FD8(a1, v5, 0);
    fclose(v6);
    *(_WORD *)(a1 + 0xBB) = (unsigned __int8)byte_968DD;
  }
  result = *(__int16 *)(a1 + 0xBD);
  if ( result != V_PlayerRaceIndex )
  {
    v8 = Q_OpenFile_sub_1BB10(v11, 0);
    v9 = v8;
    if ( !v8 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\negwnd.cpp", 0x2EF);
    }
    sub_32FD8(a1, v8, 0xFFFFFFFF);
    fclose(v9);
    result = V_PlayerRaceIndex;
    *(_WORD *)(a1 + 0xBD) = V_PlayerRaceIndex;
  }
  return result;
}
// 32E84: could not find valid save-restore pair for edi
// 968DD: using guessed type char byte_968DD;
// 32E84: using guessed type char var_24[36];

//----- (00032FD8) --------------------------------------------------------
int __fastcall sub_32FD8(int a1, FILE *a2, int a3)
{
  __int16 v3; // si
  char *v4; // eax
  __int16 i; // si
  int result; // eax
  char *v7; // eax
  char v8[220]; // [esp+0h] [ebp-DCh] BYREF

  while ( strncmp(v8, "ACTIONS", 7u) )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  }
  Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  v3 = 0;
  while ( strncmp(v8, "RESPONSES", 9u) )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
    if ( a3 )
    {
      v4 = (char *)&unk_100744 + 0x80 * v3;
    }
    else
    {
      v4 = (char *)&unk_101DD4 + 0x80 * v3;
    }
    ++v3;
    strncpy(v4, v8, 0x7Fu);
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  }
  Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  for ( i = 0; ; ++i )
  {
    result = strncmp(v8, "END DIPLO", 9u);
    if ( !result )
    {
      break;
    }
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
    if ( a3 )
    {
      v7 = (char *)&unk_100EC4 + 0x80 * i;
    }
    else
    {
      v7 = (char *)&unk_102554 + 0x80 * i;
    }
    strncpy(v7, v8, 0x7Fu);
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(a2, v8);
  }
  return result;
}

//----- (000330DC) --------------------------------------------------------
void __fastcall sub_330DC(T_Type5 *a1, unsigned __int8 *a2)
{
  T_WndA2 *Wnd_sub_56DA8; // eax
  int v4; // esi
  const char *v5; // ecx
  void *ShapeTable_sub_1B084; // eax
  void *v7; // eax
  char *sub_1CEA8; // eax
  LONG v9; // ecx
  void *v10; // eax
  WORD v11; // edx^2
  char *v12; // eax
  void *v13; // eax
  int TechsNum_sub_40664; // eax
  char *v15; // eax
  LONG v16; // ecx
  void *v17; // eax
  LONG v18; // esi
  __int16 v19; // di
  LONG v20; // ebx
  void *v21; // eax
  BYTE v22; // cl
  __int16 i; // di
  __int16 j; // di
  __int16 k; // di
  LONG v26; // [esp-8h] [ebp-60h]
  LONG v27; // [esp-8h] [ebp-60h]
  LONG v28; // [esp-8h] [ebp-60h]
  WORD v29; // [esp-4h] [ebp-5Ch]
  WORD v30; // [esp-4h] [ebp-5Ch]
  WORD v31; // [esp-4h] [ebp-5Ch]
  int v32[2]; // [esp+0h] [ebp-58h] BYREF
  int v33; // [esp+8h] [ebp-50h]
  int v34; // [esp+Ch] [ebp-4Ch]
  int v35; // [esp+10h] [ebp-48h]
  unsigned __int8 *v36; // [esp+14h] [ebp-44h]
  int PlanetsNum_sub_402E0; // [esp+18h] [ebp-40h]
  T_Race *v38; // [esp+1Ch] [ebp-3Ch]
  int v39; // [esp+20h] [ebp-38h]
  P_Race v40; // [esp+24h] [ebp-34h]
  LONG v41; // [esp+28h] [ebp-30h]
  int v42; // [esp+2Ch] [ebp-2Ch]
  LONG v43; // [esp+30h] [ebp-28h]
  LONG v44; // [esp+34h] [ebp-24h]
  LONG v45; // [esp+38h] [ebp-20h]
  LONG hotY; // [esp+3Ch] [ebp-1Ch]
  LONG v47; // [esp+40h] [ebp-18h]
  LONG v48; // [esp+44h] [ebp-14h]
  int v49; // [esp+48h] [ebp-10h]

  v36 = a2;
  Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "INTELSCREEN", 0);
  LOWORD(Wnd_sub_56DA8) = GwshareShpCacheIndexes[0x29];
  v49 = (int)Wnd_sub_56DA8;
  v40 = (P_Race)a2;
  v4 = *a2;
  v42 = *a2;
  v35 = 4 * V_Game.races[v4].Unknown_02 + 0x13;
  v32[1] = (__int16)v42;
  Q_WINMGR_CPP_sub_53E38((PANE *)a1, 3, 3, v42);
  v5 = V_SpecNames[V_Game.races[v4]._nameIndex];
  v34 = (__int16)v35;
  WinMgr.LargeFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x14, 5, v5, 0, v35, 0xFF, 0);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[v42]);
  VFX_shape_transform((PANE *)a1, ShapeTable_sub_1B084, 0, 0x96, 0x1E, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  v7 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v49);
  v45 = 0xC8;
  Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v7, 3, 0x96, 0x1E, v42);
  v32[0] = 0;
  Q_Race_GetShips_sub_40224((P_Race)a2, 0, v32);
  v43 = 0x14;
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x14);// 20: "Fleet"
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0xC8, 5, sub_1CEA8, 0, v34, 0xFF, 0);
  for ( i = 0; i < v32[0]; ++i )
  {
    v9 = v45;
    v29 = v42;
    v26 = v43;
    v10 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v10, 5, v9, v26, v29);
    v45 += 8;
    if ( i % 9 == 8 )
    {
      v45 = 0xC8;
      v43 += 8;
    }
  }
  v11 = v35;
  PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(v40);
  v48 = 0x118;
  v41 = 0x14;
  v12 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x15);      // 21: "Colonies"
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x118, 5, v12, 0, v11, 0xFF, 0);
  for ( j = 0; j < PlanetsNum_sub_402E0; ++j )
  {
    v30 = v42;
    v27 = v41;
    v13 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v13, 6, v48, v27, v30);
    v48 += 8;
    if ( j % 9 == 8 )
    {
      v48 = 0x118;
      v41 += 8;
    }
  }
  TechsNum_sub_40664 = Q_Race_GetTechsNum_sub_40664(v40);
  v47 = 0x168;
  v39 = TechsNum_sub_40664 >> 2;
  v44 = 0x14;
  v15 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x16);      // 22: "Discoveries"
  WinMgr.SmallFont.pane = (PANE)*a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x168, 5, v15, 0, v35, 0xFF, 0);
  for ( k = 0; k < v39; ++k )
  {
    v16 = v47;
    v31 = v42;
    v28 = v44;
    v17 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
    Q_DrawRaceTintedShape_sub_53EB8((PANE *)a1, v17, 7, v16, v28, v31);
    v47 += 8;
    if ( k % 9 == 8 )
    {
      v47 = 0x168;
      v44 += 8;
    }
  }
  v18 = 0x1CC;
  v38 = &V_Game.races[V_PlayerRaceIndex];
  hotY = 5;
  if ( V_Game.racesNum > 0 )
  {
    v19 = 0;
    do
    {
      if ( v19 != v42 && v40->treaties[v19] && !V_Game.races[v19].Unknown_03 && (v38->treaties[v19] || v19 == V_PlayerRaceIndex) )
      {
        v33 = v19;
        Q_WINMGR_CPP_sub_53E38((PANE *)a1, v18, hotY, v19);
        v22 = v40->treaties[v33];
        v20 = 0xFFFFFFFF;
        if ( v22 == 3 )
        {
          v20 = 9;
        }
        else if ( v22 == 2 )
        {
          v20 = 8;
        }
        if ( v20 != 0xFFFFFFFF )
        {
          v21 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
          VFX_shape_draw((PANE *)a1, v21, v20, v18, hotY);
        }
        v18 += 0x39;
        if ( v18 > 0x258 )
        {
          v18 = 0x1CC;
          hotY += 0x1B;
        }
      }
      ++v19;
    }
    while ( v19 < V_Game.racesNum );
  }
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00033598) --------------------------------------------------------
void __fastcall __spoils<> Q_WndIW_sub_33598(P_WndIW a1)
{
  Q_A2Ctor_sub_2C830(&a1->a);
  a1->a.pProcs = (P_Procs)&off_95F04;
  Q_WndIW_sub_335F8(a1);
}
// 95F04: using guessed type int (__fastcall *off_95F04)(P_WndA2 a1);

//----- (000335B4) --------------------------------------------------------
T_WndA2 *__fastcall sub_335B4(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95EC4);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95F04;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95F04: using guessed type int (__fastcall *off_95F04)(P_WndA2 a1);

//----- (000335F8) --------------------------------------------------------
void __fastcall __spoils<> Q_WndIW_sub_335F8(P_WndIW result)
{
  result->Unknown = 0;
}

//----- (00033604) --------------------------------------------------------
int __fastcall sub_33604(int a1, __int16 a2, LONG a3, LONG a4)
{
  T_WndA2 *Wnd_sub_56DA8; // eax

  if ( a2 != 1 )
  {
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  if ( !*(_DWORD *)(a1 + 0xAB) )
  {
    Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "INTELLIST", 0);
    *(_DWORD *)(a1 + 0xAB) = Wnd_sub_56DA8;
    LOWORD(Wnd_sub_56DA8[0xD].a1.Unknown_1A) = 0x3C;
    Q_Wnd10LB_SetProc1_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), sub_330DC);
  }
  return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, 1u, a3, a4);
}

//----- (00033674) --------------------------------------------------------
void __fastcall sub_33674(int a1)
{
  PANE *v1; // esi
  char *sub_1CEA8; // eax
  unsigned __int16 v3; // ax
  int i; // esi
  WORD v5; // [esp-Ch] [ebp-60h]
  char *v6; // [esp-4h] [ebp-58h]
  char s[52]; // [esp+0h] [ebp-54h] BYREF
  _DWORD *v8; // [esp+34h] [ebp-20h]
  int v9; // [esp+38h] [ebp-1Ch] BYREF
  int PlanetsNum_sub_402E0; // [esp+3Ch] [ebp-18h]

  v8 = (_DWORD *)a1;
  v1 = (PANE *)(a1 + 4);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 4));
  Q_WINMGR_CPP_sub_53E38(v1, 3, 3, V_PlayerRaceIndex);
  v6 = V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex];
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1B);// 27: "%s Intelligence"
  sprintf(s, sub_1CEA8, v6);
  v5 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  WinMgr.LargeFont.pane.window = v1->window;
  v1 = (PANE *)((char *)v1 + 4);
  WinMgr.LargeFont.pane.x0 = (LONG)v1->window;
  v1 = (PANE *)((char *)v1 + 4);
  WinMgr.LargeFont.pane.y0 = (LONG)v1->window;
  v1 = (PANE *)((char *)v1 + 4);
  WinMgr.LargeFont.pane.x1 = (LONG)v1->window;
  WinMgr.LargeFont.pane.y1 = v1->x0;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 9, s, 2, v5, 0xFF, 0);
  sub_2ED4C(*(P_Wnd10LB *)((char *)v8 + 0xAB));
  for ( i = 0; i < V_Game.racesNum; ++i )
  {
    if ( i == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[i] && !V_Game.races[i].Unknown_03 )
    {
      v9 = 0;
      Q_Race_GetShips_sub_40224(&V_Game.races[i], 0, &v9);
      PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[i]);
      v3 = Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)((char *)v8 + 0xAB), (BYTE *)&V_Game.races[i], 0xFFFFFFFF, 0);
      Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)((char *)v8 + 0xAB), v3, -(PlanetsNum_sub_402E0 + v9));
    }
  }
  Q_Wnd10LB_SetCompareProc_sub_2F1D8(*(P_Wnd10LB *)((char *)v8 + 0xAB), Q_CompareListBoxItems_sub_10A14);
  Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(*(P_Wnd10LB *)((char *)v8 + 0xAB));
  sub_2D218(v8);
}

//----- (00033830) --------------------------------------------------------
void __fastcall __spoils<> Q_WndAW_sub_33830(P_WndAW a1)
{
  Q_A2_sub_2FC50(&a1->a2);
  a1->a2.pProcs = (P_Procs)off_95EEC;
}
// 95EEC: using guessed type int (*off_95EEC[2])();

//----- (00033840) --------------------------------------------------------
T_WndA2 *__fastcall sub_33840(T_WndA2 *a1, char a2)
{
  char *v3; // eax
  T_WndA2 *v5; // eax
  T_WndA2 *v6; // ebx

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95EB0);
    operator delete[](v3);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)off_95EEC;
    v5 = sub_2FC68(a1, 1);
    v6 = v5;
    if ( (a2 & 2) != 0 )
    {
      operator delete(v5);
    }
    return v6;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95EEC: using guessed type int (*off_95EEC[2])();

//----- (00033884) --------------------------------------------------------
void __fastcall Q_ShowHelpTopicAbil_sub_33884(P_Wnd20HW a1, char *a2, int a3, int a4)
{
  char s[24]; // [esp+0h] [ebp-20h] BYREF

  sprintf(s, "abil%02d", (char)V_Game.races[V_PlayerRaceIndex].ability);
  Q_ShowHelpTopic_sub_2FCB0(a1, "help.txt", s);
}

//----- (000338DC) --------------------------------------------------------
unsigned int __fastcall sub_338DC(int a1, __int16 a2, LONG a3, LONG a4)
{
  int v5; // eax
  T_Race *v6; // esi
  int v7; // edx
  int v8; // eax
  char *sub_1CEA8; // eax
  char *v10; // esi
  int v11; // ebx
  char s[100]; // [esp+0h] [ebp-84h] BYREF
  char helptopic[32]; // [esp+64h] [ebp-20h] BYREF

  v5 = V_PlayerRaceIndex;
  v6 = &V_Game.races[v5];
  if ( !a2 )
  {
    return sub_2FD68(a1, a2, a3, a4);
  }
  if ( (unsigned __int16)a2 <= 1u )
  {
    if ( sub_434E4(&V_Game.races[v5], 0) == 0xFFFFFFFF )
    {
      *(_BYTE *)(a1 + 0xCCB) = 2;
    }
    else
    {
      Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, *(_DWORD *)(**(_DWORD **)(a1 + 0x67) + 0x41), 2, 0, 0);
      v7 = (unsigned __int16)word_968E8[(char)v6->ability] - *(_DWORD *)v6->z2;
      if ( v7 == 1 )
      {
        v8 = 0x1C;                                     // 28: ""
      }
      else
      {
        v8 = 0x1D;                                     // 29: "s"
      }
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v8);
      sprintf(s, *(const char **)(a1 + 0xCD0), v7, sub_1CEA8);
      strcpy(*(char **)(a1 + 0xCD0), s);
      v10 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);  // 30: "OK"
      strcpy((char *)(*(_DWORD *)(*(_DWORD *)(a1 + 0x67) + 4) + 0x20), v10);
    }
    *(_DWORD *)(a1 + 0x35) = 0xFFFFFFFF;
    v11 = *(_DWORD *)(a1 + 0xA7);
    *(_DWORD *)(a1 + 0x39) = 0xFFFFFFFF;
    (*(void (__fastcall **)(int, _DWORD))(v11 + 0xC))(a1, 0);
    return 0;
  }
  else
  {
    if ( a2 != 0x32 || a3 != 1 )
    {
      return sub_2FD68(a1, a2, a3, a4);
    }
    sub_434E4(&V_Game.races[v5], 1);
    sprintf(helptopic, "abres%02d", (char)v6->ability);
    Q_ShowHelpTopic_sub_2FCB0((P_Wnd20HW)a1, "help.txt", helptopic);
    (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
    return 0;
  }
}
// 968E8: using guessed type __int16 word_968E8[21];
// 338DC: using guessed type char s[100];

//----- (00033A68) --------------------------------------------------------
void __fastcall sub_33A68(int a1)
{
  void *ShapeTable_sub_1B084; // eax
  void *v3; // eax
  LONG Unknown_02; // [esp-Ch] [ebp-18h]

  sub_30774(a1);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, V_PlayerRaceIndex);
  VFX_shape_draw((PANE *)(a1 + 4), ShapeTable_sub_1B084, 0, 0xFA, 0x41);
  Unknown_02 = V_Game.races[V_PlayerRaceIndex].Unknown_02;
  v3 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, 0x21u);
  VFX_shape_draw((PANE *)(a1 + 4), v3, Unknown_02, 0xFA, 0x41);
}

//----- (00033AF0) --------------------------------------------------------
// Initializes a planet's surface and orbital configuration
// 
// @param pPlanet Pointer to planet object to initialize
// @param planetSize Requested planet size (0-4, clamped to 4)
// @param planetType Requested planet type (0-10, clamped to 10)
// @param pSquaresArray Pre-allocated array for planet squares
// @return Total number of squares allocated for the planet
UWORD __fastcall Q_Planet_Initialize_sub_33AF0(P_Planet pPlanet, UWORD planetSize, UWORD planetType, P_Square pSquaresArray)
{
  int txtLoaded; // ebx
  int i; // eax
  UWORD v7; // bx
  T_PlanetSurface *surface; // ebx
  signed int blackThreshold; // ebp
  int habitableSquares; // ecx
  UBYTE squareColor; // al
  int randVal; // eax
  unsigned __int8 flags; // al
  UWORD surfaceSquaresNum; // bx
  int v15; // eax
  UWORD maximumPopulation; // ax
  int j; // ebx
  int greenThreshold; // [esp+0h] [ebp-10h]
  int blueThreshold; // [esp+4h] [ebp-Ch]
  int redThreshold; // [esp+8h] [ebp-8h]

  if ( pPlanet->pSquares && planetSize != pPlanet->size )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x41);
  }
  txtLoaded = V_PlanetCfg.txtLoaded;
  pPlanet->pSquares = pSquaresArray;
  if ( !txtLoaded )
  {
    Q_PLANET_CPP_LoadPlanItemTxt_sub_33D30();
  }
  if ( planetSize >= 5u )
  {
    pPlanet->size = ASCEND_PLANET_SIZE_ENORMOUS;
  }
  else
  {
    pPlanet->size = planetSize;
  }
  pPlanet->surfaceSquaresNum = 0;
  // Calculate surface squares from configuration
  for ( i = 0; i < 15; ++i )
  {
    v7 = V_PlanetCfg.squares.sizes[pPlanet->size].column[i] + pPlanet->surfaceSquaresNum;
    pPlanet->surfaceSquaresNum = v7;
  }
  if ( v7 > 100u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x52);
  }
  // Set total squares (surface + 10 orbital slots)
  pPlanet->totalSquaresNum = pPlanet->surfaceSquaresNum + 10;
  if ( planetType >= 11u )
  {
    pPlanet->type = ASCEND_PLANET_TYPE_CONGENIAL;
  }
  else
  {
    pPlanet->type = planetType;
  }
  // Initialize square colors based on planet type distribution
  surface = &V_PlanetCfg.surfaces[pPlanet->type];
  blackThreshold = 0x7FFF * (unsigned int)surface->black / 100;
  redThreshold = 0x7FFF * (unsigned int)surface->red / 100 + blackThreshold;
  greenThreshold = 0x7FFF * (unsigned int)surface->green / 100 + redThreshold;
  habitableSquares = 0;
  blueThreshold = 0x7FFF * (unsigned int)surface->blue / 100 + greenThreshold;
  for ( j = 0; j < pPlanet->totalSquaresNum; ++j )
  {
    pPlanet->pSquares[j].planetItemIndex = 0xFF;
    pPlanet->pSquares[j].flags = 0;
    squareColor = ASCEND_SQUARE_COLOR_WHITE;
    if ( j < pPlanet->surfaceSquaresNum )
    {
      randVal = rand();
      if ( randVal >= blackThreshold )
      {
        ++habitableSquares;
        if ( randVal >= redThreshold )
        {
          if ( randVal >= greenThreshold )
          {
            if ( randVal >= blueThreshold )
            {
              squareColor = ASCEND_SQUARE_COLOR_WHITE;
            }
            else
            {
              squareColor = ASCEND_SQUARE_COLOR_BLUE;
            }
          }
          else
          {
            squareColor = ASCEND_SQUARE_COLOR_GREEN;
          }
        }
        else
        {
          squareColor = ASCEND_SQUARE_COLOR_RED;
        }
      }
      else
      {
        squareColor = ASCEND_SQUARE_COLOR_BLACK;
      }
    }
    pPlanet->pSquares[j].color = squareColor;
  }
  pPlanet->flags = 0;
  flags = pPlanet->flags;
  pPlanet->buildingProgress = flags;
  pPlanet->z6 = flags;
  pPlanet->word4C = flags;
  pPlanet->prosperity = flags;
  pPlanet->research = flags;
  pPlanet->industry = flags;
  pPlanet->word42 = flags;
  // Randomly add xeno ruins (1 in 7 chance)
  if ( !(rand() % 7) )
  {
    surfaceSquaresNum = pPlanet->surfaceSquaresNum;
    v15 = rand();
    pPlanet->pSquares[v15 % surfaceSquaresNum].color |= ASCEND_SQUARE_XENO_RUINS;
    pPlanet->flags |= ASCEND_PF_02_HAS_XENO_RUINS;
  }
  pPlanet->_squareIndex = 0xFFFF;
  pPlanet->buildingPlanetItemIndex = 0xFF;
  // Set population capacity based on habitable squares
  maximumPopulation = habitableSquares / 3 + 5;
  pPlanet->maximumPopulation2 = maximumPopulation;
  pPlanet->maximumPopulation = maximumPopulation;
  pPlanet->raceIndex = 0xFF;
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
  pPlanet->Unknown_5E = 0;
  return pPlanet->totalSquaresNum;
}

//----- (00033D30) --------------------------------------------------------
void __fastcall Q_PLANET_CPP_LoadPlanItemTxt_sub_33D30()
{
  FILE *fp; // esi
  MACRO_VFX_BOOL found; // edi
  int v2; // kr0C_4
  int v3; // kr10_4
  int v4; // kr1C_4
  int v5; // kr20_4
  int v6; // kr2C_4
  int v7; // kr30_4
  char *v8; // kr44_4
  int l; // edx
  int v10; // ecx
  int n; // edx
  int len; // kr04_4
  int v13; // kr3C_4
  int i; // edi
  int j; // edi
  int k; // edi
  int m; // kr38_4
  char bufc[196]; // [esp+0h] [ebp-ECh] BYREF
  int bufi; // [esp+C8h] [ebp-24h] BYREF
  unsigned __int16 val2; // [esp+CCh] [ebp-20h] BYREF
  UWORD val3; // [esp+D0h] [ebp-1Ch] BYREF
  BYTE val4; // [esp+D4h] [ebp-18h] BYREF
  BYTE val5; // [esp+D8h] [ebp-14h] BYREF
  UWORD val6; // [esp+DCh] [ebp-10h] BYREF
  UBYTE val7; // [esp+E0h] [ebp-Ch] BYREF
  char *name; // [esp+E8h] [ebp-4h]

  fp = Q_OpenFile_sub_1BB10("planitem.txt", 0);
  if ( fp )
  {
    found = FALSE;
    do
    {
      fgets(bufc, 195, fp);
      if ( bufc[0] == '#' )
      {
        found = TRUE;
      }
    }
    while ( found == FALSE );
    fscanf(fp, "%d", &bufi);
    V_PopGrowthAmount50 = bufi;
    for ( i = 0; i < 11; ++i )
    {
      v2 = i;
      v3 = 0;
      do
      {
        fscanf(fp, "%d", &bufi);
        *(&V_PlanetCfg.surfaces[v2].black + v3++) = bufi;// Actually V_PlanetCfg->surfaces
      }
      while ( v2 * 4 + v3 != 4 * i + 4 );
    }
    for ( j = 0; j < 5; ++j )
    {
      v4 = j;
      v5 = 0;
      do
      {
        fscanf(fp, "%d", &bufi);
        V_PlanetCfg.offsets.sizes[v4].column[v5++] = bufi;
      }
      while ( v4 * 0xF + v5 != 0xF * j + 0xF );
    }
    for ( k = 0; k < 5; ++k )
    {
      v6 = k;
      v7 = 0;
      do
      {
        fscanf(fp, "%d", &bufi);
        V_PlanetCfg.squares.sizes[v6].column[v7++] = bufi;
      }
      while ( v6 * 0xF + v7 != 0xF * k + 0xF );
    }
    fscanf(fp, "%d %d %d", &bufi, &val2, &val3);
    if ( bufi != 39 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0xE1);
    }
    V_PlanetItems.surfaceItemsNum = val2;
    V_PlanetItems.orbitalItemsNum = val3;
    if ( val2 + val3 > 39 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0xE6);
    }
    name = V_PlanetItems.item[0].name;
    v8 = V_PlanetItems.item[0].name;
    for ( m = 0; m != 0x27; ++m )
    {
      fscanf(fp, "%s %d %d %d %d %d %d %d", &v8[0x28 * m], &bufi, &val2, &val3, &val4, &val5, &val6, &val7);
      l = 0;
      len = strlen(&v8[0x28 * m]) + 1;
      v10 = len - 1;
      v13 = m;
      if ( len - 1 > 0 )
      {
        do
        {
          if ( V_PlanetItems.item[v13].name[l] == '^' )
          {
            V_PlanetItems.item[v13].name[l] = ' ';
          }
          ++l;
        }
        while ( l < len - 1 );
      }
      V_PlanetItems.item[m].ind = bufi;
      V_PlanetItems.item[m].flags = 0;
      V_PlanetItems.item[m].res = val2;
      V_PlanetItems.item[m].pros = val3;
      V_PlanetItems.item[m].mpop = val4;
      V_PlanetItems.item[m].upop = val5;
      V_PlanetItems.item[m].cost = val6;
      V_PlanetItems.item[m].resReq = val7;
      for ( n = 0; n < 8; ++n )
      {
        fscanf(fp, "%d", &bufi);
        if ( bufi == 0xFF )
        {
          break;
        }
        LOWORD(v10) = V_PlanetItems.item[m].flags;
        v10 |= 1 << bufi;
        V_PlanetItems.item[m].flags = v10;
      }
    }
    fclose(fp);
  }
  V_PlanetCfg.txtLoaded = TRUE;
}
/* Orphan comments:
 0  0  0  0  4  4  5  0  0  0  0  0  0  0  0 
 0  0  0  4  3  4  5  6  0  0  0  0  0  0  0 
 0  0  3  2  3  3  4  5  7  0  0  0  0  0  0 
 0  2  1  1  2  2  3  4  5  7  0  0  0  0  0 
 1  0  0  0  1  1  2  3  4  5  7  0  0  0  0 
 0  0  0  0  2  3  2  0  0  0  0  0  0  0  0 
 0  0  0  1  3  3  3  1  0  0  0  0  0  0  0 
 0  0  1  4  4  5  4  4  1  0  0  0  0  0  0 
 0  2  5  6  6  7  6  6  5  2  0  0  0  0  0 
 3  6  7  8  8  9  8  8  7  6  3  0  0  0  0 
100  0  0  0
 50  2  2  2
 20  3  5  3
  0  3 20  3
 40 10  2  2
 20 20  2  2
 40  2  2 10
 20  3  3 20
 40 10 10 10
 20 15 15 15
  0 33 34 33
*/
// 9684C: using guessed type int V_PopGrowthAmount50;

//----- (0003407C) --------------------------------------------------------
// Counts available build locations on a planet's surface
// Return Number of valid construction squares (max 100)
int __fastcall Q_Planet_CountAvailableBuildSquares_sub_3407C(P_Planet pPlanet)
{
  int availableSquares; // ebp
  T_Square *pPlanetSquare; // eax
  T_SquareGridCoord SquareGridCoords; // eax
  UWORD row; // si
  UWORD column; // di
  unsigned __int16 bottom; // bx
  int i; // [esp+4h] [ebp-10h]
  unsigned __int16 right; // [esp+8h] [ebp-Ch]
  unsigned __int16 top; // [esp+Ch] [ebp-8h]
  unsigned __int16 left; // [esp+10h] [ebp-4h]

  availableSquares = 0;
  for ( i = 0; pPlanet->totalSquaresNum > i && availableSquares < 100; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i];
    if ( (pPlanetSquare->color & ASCEND_SQUARE_XENO_RUINS) == 0
      && (pPlanetSquare->color || V_Game.races[pPlanet->raceIndex].ability == ASCEND_SA_BUILD_ON_BLACK)
      && pPlanet->pSquares[i].planetItemIndex == 0xFF )
    {
      SquareGridCoords = Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(pPlanet, i);
      row = SquareGridCoords.row;
      column = SquareGridCoords.column;
      left = Q_Planet_GetSquareIndex_sub_35968(pPlanet, SquareGridCoords.column - 1, SquareGridCoords.row);
      right = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column + 1, row);
      top = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row - 1);
      bottom = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row + 1);
      ++availableSquares;
      // Don't count if there is no adjacent buildings
      if ( (left == 0xFFFF || (pPlanet->pSquares[left].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (right == 0xFFFF || (pPlanet->pSquares[right].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (top == 0xFFFF || (pPlanet->pSquares[top].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (bottom == 0xFFFF || (pPlanet->pSquares[bottom].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0) )
      {
        --availableSquares;
      }
    }
  }
  return availableSquares;
}

//----- (0003420C) --------------------------------------------------------
// Counts available black (unusable) surface squares that could be terraformed
// Return Number of terraformable black squares (max 100)
int __fastcall Q_Planet_CountTerraformableSquares_sub_3420C(P_Planet pPlanet)
{
  int v2; // ebp
  int result; // eax
  T_Square *pPlanetSquare; // esi
  __int32 v5; // eax
  T_SquareGridCoord gridCoords; // eax
  UWORD row; // si
  UWORD column; // di
  unsigned __int16 bottom; // bx
  int i; // [esp+0h] [ebp-14h]
  unsigned __int16 top; // [esp+8h] [ebp-Ch]
  unsigned __int16 left; // [esp+Ch] [ebp-8h]
  unsigned __int16 right; // [esp+10h] [ebp-4h]

  v2 = 0;
  for ( i = 0; ; ++i )
  {
    result = pPlanet->totalSquaresNum;
    if ( (unsigned __int16)result <= i || v2 >= 100 )
    {
      break;
    }
    pPlanetSquare = &pPlanet->pSquares[i];
    v5 = pPlanetSquare->color & ASCEND_SQUARE_XENO_RUINS;
    if ( (pPlanetSquare->color & ASCEND_SQUARE_XENO_RUINS) == 0 )
    {
      LOBYTE(v5) = pPlanetSquare->color;
      if ( !v5 && pPlanetSquare->planetItemIndex == 0xFF )
      {
        gridCoords = Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(pPlanet, i);
        row = gridCoords.row;
        column = gridCoords.column;
        left = Q_Planet_GetSquareIndex_sub_35968(pPlanet, gridCoords.column - 1, gridCoords.row);
        right = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column + 1, row);
        top = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row - 1);
        bottom = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row + 1);
        ++v2;
        if ( (left == 0xFFFF || (pPlanet->pSquares[left].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
          && (right == 0xFFFF || (pPlanet->pSquares[right].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
          && (top == 0xFFFF || (pPlanet->pSquares[top].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
          && (bottom == 0xFFFF || (pPlanet->pSquares[bottom].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0) )
        {
          --v2;
        }
      }
    }
  }
  return result;
}

//----- (00034368) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Planet_CanPlaceItem_sub_34368(P_Planet pPlanet, UBYTE planetItemIndex, unsigned __int16 squareIndex)
{
  MACRO_VFX_BOOL canPlaceByItem; // ebp
  MACRO_VFX_BOOL canPlaceBySquare; // edi
  int resReq; // eax
  int color; // eax
  T_Square *v8; // eax
  T_Square *pPlanetSquare; // eax
  T_SquareGridCoord coords; // eax
  UWORD row; // cx
  unsigned __int16 bottom; // bx
  int v14; // [esp+0h] [ebp-20h]
  int column; // [esp+8h] [ebp-18h]
  unsigned __int16 left; // [esp+Ch] [ebp-14h]
  unsigned __int16 top; // [esp+14h] [ebp-Ch]
  unsigned __int16 right; // [esp+18h] [ebp-8h]
  unsigned __int16 v19; // [esp+1Ch] [ebp-4h]

  canPlaceByItem = TRUE;
  canPlaceBySquare = TRUE;
  // Reject if planet is uncolonized and item isn't a colony base
  if ( pPlanet->raceIndex == 0xFF && planetItemIndex != ASCEND_PI_05_COLONY_BASE )
  {
    return FALSE;
  }
  if ( planetItemIndex < (unsigned int)ASCEND_PI_39_END )
  {
    canPlaceByItem = FALSE;
    // Check research requirements
    resReq = V_PlanetItems.item[planetItemIndex].resReq;
    if ( resReq == 0xFF || V_Research.num > resReq && ((1 << pPlanet->raceIndex) & V_Research.techs[resReq].knownToRace) != 0 )
    {
      // Check population requirements
      v19 = pPlanet->word42 - pPlanet->word4C;
      if ( pPlanet->buildingPlanetItemIndex != 0xFF )
      {
        v19 += V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].upop;
      }
      if ( v19 >= V_PlanetItems.item[planetItemIndex].upop )
      {
        canPlaceByItem = TRUE;
      }
      // Special case for ship construction
      if ( canPlaceByItem == TRUE && planetItemIndex == ASCEND_PI_23_SHIP )
      {
        canPlaceByItem = Q_Planet_CanBuildShip_sub_362E0(pPlanet);
      }
    }
    // Colony base exception
    if ( planetItemIndex == ASCEND_PI_05_COLONY_BASE )
    {
      canPlaceByItem = TRUE;
    }
  }
  if ( squareIndex < pPlanet->totalSquaresNum )
  {
    canPlaceBySquare = FALSE;
    // Check if building on black squares is allowed
    if ( planetItemIndex < (unsigned int)ASCEND_PI_39_END
      && ((V_PlanetItems.item[planetItemIndex].flags & ASCEND_PI_FLAG_BUILD_ON_BLACK) != 0
       || V_Game.races[pPlanet->raceIndex].ability == ASCEND_SA_BUILD_ON_BLACK) )
    {
      canPlaceBySquare = TRUE;
    }
    v14 = squareIndex;
    color = pPlanet->pSquares[v14].color;
    if ( pPlanet->pSquares[v14].color
      || planetItemIndex == 0xFF
      || (LOBYTE(color) = planetItemIndex, (V_PlanetItems.item[color].flags & 2) != 0) )
    {
      canPlaceBySquare = TRUE;
    }
    // Verify surface/orbital placement rules
    if ( planetItemIndex != 0xFF
      && planetItemIndex <= (unsigned int)ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER
      && squareIndex < pPlanet->surfaceSquaresNum != planetItemIndex < (int)V_PlanetItems.surfaceItemsNum )
    {
      canPlaceBySquare = FALSE;
    }
    // Check xeno ruins compatibility
    if ( planetItemIndex != 0xFF
      && ((pPlanet->pSquares[squareIndex].color & ASCEND_SQUARE_XENO_RUINS) != 0) != (planetItemIndex == ASCEND_PI_38_XENO_ARCHEOLOGICAL_DIG) )
    {
      canPlaceBySquare = FALSE;
    }
    // Terraforming only on black squares
    if ( planetItemIndex == ASCEND_PI_36_TERRAFORMING )
    {
      v8 = &pPlanet->pSquares[squareIndex];
      if ( v8->color || v8->planetItemIndex != 0xFF )
      {
        canPlaceBySquare = FALSE;
      }
    }
    // Automation special rules
    if ( planetItemIndex == ASCEND_PI_35_AUTOMATION )
    {
      pPlanetSquare = &pPlanet->pSquares[squareIndex];
      if ( (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0
        || pPlanetSquare->planetItemIndex == ASCEND_PI_23_SHIP
        || (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_AUTOMATED) != 0 )
      {
        canPlaceBySquare = FALSE;
      }
    }
    // Check adjacent squares for incomplete construction
    if ( squareIndex < pPlanet->surfaceSquaresNum
      && (pPlanet->pSquares[squareIndex].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0
      && planetItemIndex != ASCEND_PI_05_COLONY_BASE
      && planetItemIndex != ASCEND_PI_35_AUTOMATION )
    {
      coords = Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(pPlanet, squareIndex);
      row = coords.row;
      column = coords.column;
      left = Q_Planet_GetSquareIndex_sub_35968(pPlanet, coords.column - 1, coords.row);
      right = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column + 1, row);
      top = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row - 1);
      bottom = Q_Planet_GetSquareIndex_sub_35968(pPlanet, column, row + 1);
      if ( (left == 0xFFFF || (pPlanet->pSquares[left].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (right == 0xFFFF || (pPlanet->pSquares[right].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (top == 0xFFFF || (pPlanet->pSquares[top].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0)
        && (bottom == 0xFFFF || (pPlanet->pSquares[bottom].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0) )
      {
        canPlaceBySquare = FALSE;
      }
    }
  }
  if ( canPlaceByItem && canPlaceBySquare )
  {
    return TRUE;
  }
  else
  {
    return FALSE;
  }
}

//----- (00034774) --------------------------------------------------------
void __fastcall Q_Planet_StartConstruction_sub_34774(P_Planet pPlanet, UBYTE planetItemIndex, int squareIndex, BOOL _immediate)
{
  unsigned __int8 actionType; // cl
  UWORD squareIndex_; // dx
  unsigned __int8 planetItemIndex_; // bl
  UWORD v8; // si

  if ( squareIndex != 0xFFFF && pPlanet->pSquares[squareIndex].planetItemIndex == 0xFF )
  {
    if ( _immediate == TRUE )
    {
      // ?ACTION_BUILD_NOW Immediate placement
      actionType = 0;
      squareIndex_ = squareIndex;
      planetItemIndex_ = planetItemIndex;
    }
    else
    {
      // ?ACTION_START_CONSTRUCTION Queued construction
      actionType = 2;
      v8 = squareIndex;
      planetItemIndex_ = planetItemIndex;
      squareIndex_ = v8;
    }
    Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, squareIndex_, planetItemIndex_, actionType);
  }
}

//----- (000347CC) --------------------------------------------------------
// Finds the optimal location to build a specific planet item
// Return Index of best square to build on, or 0xFFFF if none found
int __fastcall Q_Planet_FindOptimalBuildLocation_sub_347CC(P_Planet pPlanet, UBYTE planetItemIndex)
{
  UBYTE raceIndex; // cl
  int candidateCount; // ebp
  int knownToRace; // edx
  int ii; // edi
  signed int bestScore; // edi
  int score; // eax
  signed __int8 ind; // bl
  signed __int8 pros; // bl
  signed __int8 res; // bl
  int i; // ecx
  int j; // ecx
  UWORD candidateSquares[100]; // [esp+0h] [ebp-E0h]
  P_Square pSquares; // [esp+C8h] [ebp-18h]
  int v17; // [esp+CCh] [ebp-14h]
  int NO_LOCATION_FOUND; // [esp+D0h] [ebp-10h]
  int bestIndex; // [esp+D4h] [ebp-Ch]
  int v20; // [esp+D8h] [ebp-8h]
  UBYTE planetItemIndex_; // [esp+DCh] [ebp-4h]

  planetItemIndex_ = planetItemIndex;
  NO_LOCATION_FOUND = 0xFFFF;
  raceIndex = pPlanet->raceIndex;
  candidateCount = 0;
  knownToRace = V_Research.techs[V_Research.num - 1].knownToRace;
  v17 = 0;
  if ( ((1 << raceIndex) & knownToRace) != 0 && Q_Race_GetTechsNum_sub_40664(&V_Game.races[raceIndex]) == V_Research.num )
  {
    v17 = 0xFFFFFFFF;
  }
  ii = 0;
  v20 = 0;
  for ( i = 0; i < pPlanet->totalSquaresNum && ii < 100; ++i )
  {
    if ( pPlanet->pSquares[i].planetItemIndex == 0xFF )
    {
      if ( Q_Planet_CanPlaceItem_sub_34368(pPlanet, planetItemIndex_, i) )
      {
        ++candidateCount;
        candidateSquares[ii++] = i;
      }
    }
  }
  if ( candidateCount )
  {
    bestScore = -1u;
    bestIndex = -1u;
    if ( candidateCount > 0 )
    {
      pSquares = pPlanet->pSquares;
      for ( j = 0; j < candidateCount; ++j )
      {
        switch ( pSquares[candidateSquares[j]].color )
        {
          case ASCEND_SQUARE_COLOR_RED:
            score = 0;
            if ( V_PlanetItems.item[planetItemIndex_].ind > 0 )
            {
              ind = V_PlanetItems.item[planetItemIndex_].ind;
              score = 3;
              if ( ind < (char)V_PlanetItems.item[planetItemIndex_].res || ind < (char)V_PlanetItems.item[planetItemIndex_].pros )
              {
                score = 2;
              }
            }
            break;
          case ASCEND_SQUARE_COLOR_GREEN:
            score = 0;
            if ( (char)V_PlanetItems.item[planetItemIndex_].pros > 0 )
            {
              pros = V_PlanetItems.item[planetItemIndex_].pros;
              score = 3;
              if ( pros < V_PlanetItems.item[planetItemIndex_].ind || pros < (char)V_PlanetItems.item[planetItemIndex_].res )
              {
                score = 2;
              }
            }
            break;
          case ASCEND_SQUARE_COLOR_BLUE:
            if ( v17 )
            {
              goto LABEL_24;
            }
            score = 0;
            if ( (char)V_PlanetItems.item[planetItemIndex_].res > 0 )
            {
              res = V_PlanetItems.item[planetItemIndex_].res;
              score = 3;
              if ( res < V_PlanetItems.item[planetItemIndex_].ind || res < (char)V_PlanetItems.item[planetItemIndex_].pros )
              {
                score = 2;
              }
            }
            break;
          default:
LABEL_24:
            score = 1;
            break;
        }
        if ( score > bestScore )
        {
          bestIndex = j;
          bestScore = score;
        }
      }
    }
    if ( bestIndex >= 0 )
    {
      return candidateSquares[bestIndex];
    }
  }
  return NO_LOCATION_FOUND;
}
// 347CC: using guessed type UWORD candidateSquares[100];

//----- (00034A44) --------------------------------------------------------
// Counts available build squares by color
void __fastcall Q_Planet_CountBuildableSquaresByColor_sub_34A44(P_Planet pPlanet, LONG *outBlue, LONG *outRed, LONG *outGreen)
{
  int i; // [esp+0h] [ebp-14h]

  *outBlue = 0;
  *outRed = 0;
  *outGreen = 0;
  for ( i = 0; pPlanet->totalSquaresNum > i; ++i )
  {
    if ( pPlanet->pSquares[i].planetItemIndex == 0xFF && Q_Planet_CanPlaceItem_sub_34368(pPlanet, ASCEND_PI_00_FACTORY, i) )
    {
      switch ( pPlanet->pSquares[i].color )
      {
        case ASCEND_SQUARE_COLOR_RED:
          ++*outRed;
          break;
        case ASCEND_SQUARE_COLOR_GREEN:
          goto LABEL_3;
        case ASCEND_SQUARE_COLOR_BLUE:
          ++*outBlue;
          break;
        default:
          ++*outBlue;
          ++*outRed;
LABEL_3:
          ++*outGreen;
          break;
      }
    }
  }
}

//----- (00034AE4) --------------------------------------------------------
// Finds the optimal location and starts construction of a planet item
// Return Index of square where construction started, or 0xFFFF if no valid location found
int __fastcall Q_Planet_BuildAtOptimalLocation_sub_34AE4(P_Planet pPlanet, UBYTE planetItemIndex, BOOL _immediate)
{
  int squareIndex; // ebx

  squareIndex = Q_Planet_FindOptimalBuildLocation_sub_347CC(pPlanet, planetItemIndex);
  Q_Planet_StartConstruction_sub_34774(pPlanet, planetItemIndex, squareIndex, _immediate);
  return squareIndex;
}

//----- (00034B0C) --------------------------------------------------------
// Handles planet item placement/removal and construction
// actionType Construction action type:
//   0 = Immediate placement
//   1 = ?Remove item
//   2 = Begin construction
//   3 = Complete construction
//   4.. = Just Calc and return FALSE
// Return TRUE on success, FALSE on failure
MACRO_VFX_BOOL __fastcall Q_Planet_HandleItemConstruction_sub_34B0C(
        P_Planet pPlanet,
        UWORD squareIndex,
        unsigned __int8 planetItemIndex,
        unsigned __int8 actionType)
{
  MACRO_VFX_BOOL v5; // ebp
  P_Square pSquare; // edi
  UBYTE planetItemIndex___; // dl
  UBYTE planetItemIndex_; // al
  T_UWordPair squareIndex_; // edx
  T_Ship *pShip; // eax
  T_Square *pPlanetSquare; // eax
  UBYTE v13; // dl
  int v14; // eax
  int v15; // edx
  int range; // [esp+0h] [ebp-30h] BYREF
  int damage; // [esp+4h] [ebp-2Ch] BYREF
  int numUses; // [esp+8h] [ebp-28h] BYREF
  LONG outRange; // [esp+Ch] [ebp-24h] BYREF
  LONG outDamage; // [esp+10h] [ebp-20h] BYREF
  int numUses_; // [esp+14h] [ebp-1Ch] BYREF
  MACRO_VFX_BOOL bOrbitalSquare; // [esp+18h] [ebp-18h]
  T_UWordPair squareIndex__; // [esp+1Ch] [ebp-14h]
  UBYTE planetItemIndex__; // [esp+20h] [ebp-10h]

  squareIndex__ = (T_UWordPair)squareIndex;
  planetItemIndex__ = planetItemIndex;
  v5 = FALSE;
  if ( squareIndex == 0xFFFF && ((V_PlanetItems.item[planetItemIndex].flags & 2) == 0 || actionType != 2) )
  {
    goto CALC_AND_EXIT;
  }
  bOrbitalSquare = (squareIndex__.word0 < pPlanet->surfaceSquaresNum) - 1;
  pSquare = pPlanet->pSquares;
  if ( !actionType )
  {
    // 0 = Immediate placement
    if ( pSquare[squareIndex__.word0].planetItemIndex == 0xFF && planetItemIndex__ < (unsigned int)ASCEND_PI_39_END )
    {
      planetItemIndex___ = planetItemIndex__;
      if ( pPlanet->word42 - pPlanet->word4C >= V_PlanetItems.item[planetItemIndex__].upop
        && planetItemIndex__ >= (int)V_PlanetItems.surfaceItemsNum == bOrbitalSquare )
      {
        pSquare[squareIndex__.word0].planetItemIndex = planetItemIndex__;
        pSquare[squareIndex__.word0].flags = ASCEND_SQUARE_FLAGS_COMPLETE;
        v5 = TRUE;
        if ( (V_PlanetItems.item[planetItemIndex___].flags & ASCEND_PI_FLAG_ATTACK) != 0 )
        {
          Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, planetItemIndex___, &range, &damage, &numUses);
          if ( numUses )
          {
            HIBYTE(pSquare[squareIndex__.word0].flags) = 0;
            pSquare[squareIndex__.word0].flags |= (_WORD)numUses << 8;
            Q_Planet_CalcPoints_sub_34E70(pPlanet);
            return TRUE;
          }
        }
      }
    }
    goto CALC_AND_EXIT;
  }
  if ( actionType > 1u )
  {
    if ( actionType > 3u )
    {
      Q_Planet_CalcPoints_sub_34E70(pPlanet);
      return FALSE;
    }
    // 3 = Complete construction
    if ( actionType == 3
      || (V_PlanetItems.item[planetItemIndex__].flags & 2) != 0
      || Q_Planet_CanPlaceItem_sub_34368(pPlanet, planetItemIndex__, squareIndex__.word0)
      && ((pSquare[squareIndex__.word0].flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0
       || planetItemIndex__ == ASCEND_PI_35_AUTOMATION && (pSquare[squareIndex__.word0].flags & ASCEND_SQUARE_FLAGS_AUTOMATED) == 0) )
    {
      squareIndex_.word0 = pPlanet->_squareIndex;
      if ( squareIndex_.word0 != 0xFFFF )
      {
        squareIndex_.word1 = 0;
        if ( pPlanet->pSquares[*(_DWORD *)&squareIndex_].planetItemIndex == ASCEND_PI_23_SHIP )
        {
          pShip = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, squareIndex_.word0);
          Q_Ship_RemoveFromTheGame_sub_49940(pShip);
        }
        pPlanetSquare = &pPlanet->pSquares[pPlanet->_squareIndex];
        if ( (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) == 0 )
        {
          pPlanetSquare->planetItemIndex = 0xFF;
        }
      }
      v13 = planetItemIndex__;
      v14 = planetItemIndex__;
      pPlanet->_squareIndex = 0xFFFF;
      if ( (V_PlanetItems.item[v14].flags & 2) == 0 )
      {
        pPlanet->_squareIndex = squareIndex__.word0;
        if ( v13 != ASCEND_PI_35_AUTOMATION )
        {
          pSquare[squareIndex__.word0].planetItemIndex = v13;
        }
      }
      v15 = planetItemIndex__;
      pPlanet->buildingPlanetItemIndex = planetItemIndex__;
      if ( (V_PlanetItems.item[v15].flags & ASCEND_PI_FLAG_ATTACK) != 0 )
      {
        Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, v15, &outRange, &outDamage, &numUses_);
        if ( numUses_ )
        {
          HIBYTE(pSquare[squareIndex__.word0].flags) = 0;
          pSquare[squareIndex__.word0].flags |= (_WORD)numUses_ << 8;
        }
      }
      Q_Planet_CalcPoints_sub_34E70(pPlanet);
      return TRUE;
    }
CALC_AND_EXIT:
    Q_Planet_CalcPoints_sub_34E70(pPlanet);
    return v5;
  }
  // 1 = 
  planetItemIndex_ = pSquare[squareIndex__.word0].planetItemIndex;
  if ( planetItemIndex_ == 0xFF
    || V_PlanetItems.item[planetItemIndex_].mpop > pPlanet->maximumPopulation - pPlanet->word42
    && (pSquare[squareIndex__.word0].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    goto CALC_AND_EXIT;
  }
  pSquare[squareIndex__.word0].planetItemIndex = 0xFF;
  pSquare[squareIndex__.word0].flags = 0;
  if ( squareIndex__.word0 == pPlanet->_squareIndex )
  {
    pPlanet->_squareIndex = 0xFFFF;
    pPlanet->buildingPlanetItemIndex = 0xFF;
  }
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
  return TRUE;
}

//----- (00034E70) --------------------------------------------------------
void __fastcall Q_Planet_CalcPoints_sub_34E70(P_Planet pPlanet)
{
  T_Square *pSquare; // esi
  UBYTE planetItemIndex; // dl
  T_PlanetItem *pPlanetItem; // eax
  signed __int8 pros; // dh
  int v6; // edi
  signed __int8 res; // dh
  int v8; // edi
  int SquareWithItem_sub_35930; // eax
  int v10; // eax
  int v11; // eax
  UBYTE buildingPlanetItemIndex; // dl
  int halfIndustry; // eax
  UWORD maximumPopulation; // dx
  UWORD word42; // cx
  int i; // ebp
  BYTE v17; // [esp+0h] [ebp-30h]
  UWORD v18; // [esp+4h] [ebp-2Ch]
  BYTE v19; // [esp+8h] [ebp-28h]
  WORD blackSquaresNum; // [esp+Ch] [ebp-24h]
  WORD orbitalSquaresNum; // [esp+10h] [ebp-20h]
  WORD freeSurfaceSquaresNum; // [esp+14h] [ebp-1Ch]
  int research; // [esp+18h] [ebp-18h]
  int industry; // [esp+1Ch] [ebp-14h]
  int prosperity; // [esp+20h] [ebp-10h]
  int v26; // [esp+20h] [ebp-10h]
  UWORD maximumPopulation2; // [esp+24h] [ebp-Ch]

  industry = 0;
  research = 0;
  prosperity = 0;
  v18 = 0;
  freeSurfaceSquaresNum = 0;
  blackSquaresNum = 0;
  orbitalSquaresNum = 0;
  v17 = 0;
  v19 = 0;
  maximumPopulation2 = pPlanet->maximumPopulation2;
  for ( i = 0; i < pPlanet->totalSquaresNum; ++i )
  {
    pSquare = &pPlanet->pSquares[i];
    planetItemIndex = pSquare->planetItemIndex;
    pPlanetItem = &V_PlanetItems.item[planetItemIndex];
    if ( planetItemIndex == 0xFF )
    {
      if ( i < pPlanet->surfaceSquaresNum )
      {
        if ( (pSquare->color & ASCEND_SQUARE_XENO_RUINS) == 0 )
        {
          ++freeSurfaceSquaresNum;
          if ( !pSquare->color )                       // Black
          {
            ++blackSquaresNum;
          }
        }
      }
      else
      {
        ++orbitalSquaresNum;
      }
    }
    else
    {
      if ( (pSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )// Complete
      {
        if ( pPlanetItem->ind )
        {
          industry += pPlanetItem->ind;
          if ( pSquare->color == ASCEND_SQUARE_COLOR_RED )// Red
          {
            ++industry;
          }
        }
        pros = pPlanetItem->pros;
        if ( pros )
        {
          v6 = pros + prosperity;
          prosperity = v6;
          if ( pPlanet->pSquares[i].color == ASCEND_SQUARE_COLOR_GREEN )
          {
            prosperity = v6 + 1;
          }
        }
        res = pPlanetItem->res;
        if ( res )
        {
          v8 = res + research;
          research = v8;
          if ( pPlanet->pSquares[i].color == ASCEND_SQUARE_COLOR_BLUE )
          {
            research = v8 + 1;
          }
        }
        if ( (pPlanetItem->flags & ASCEND_PI_FLAG_ATTACK) == 0 || planetItemIndex == ASCEND_PI_17_TRACTOR_BEAM )
        {
          if ( (pPlanetItem->flags & ASCEND_PI_FLAG_DEFENSE) != 0 || planetItemIndex == ASCEND_PI_17_TRACTOR_BEAM )
          {
            ++v19;
          }
        }
        else
        {
          ++v17;
        }
        maximumPopulation2 += pPlanetItem->mpop;
      }
      if ( planetItemIndex != ASCEND_PI_23_SHIP
        && (pPlanet->pSquares[i].flags & 2) == 0
        && (V_PlanetItems.item[planetItemIndex].flags & ASCEND_PI_FLAG_MASK6) == 0 )
      {
        v18 += pPlanetItem->upop;
      }
    }
  }
  SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_12_HYPERPOWER_PLANT);
  if ( SquareWithItem_sub_35930 != 0xFFFF && (pPlanet->pSquares[SquareWithItem_sub_35930].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    industry += industry >> 1;
  }
  v10 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_13_FERTILIZATION_PLANT);
  if ( v10 != 0xFFFF && (pPlanet->pSquares[v10].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    prosperity += prosperity >> 1;
  }
  v11 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_14_INTERNET);
  if ( v11 != 0xFFFF && (pPlanet->pSquares[v11].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
  {
    research += research >> 1;
  }
  if ( pPlanet->buildingPlanetItemIndex != 0xFF )
  {
    buildingPlanetItemIndex = pPlanet->buildingPlanetItemIndex;
    halfIndustry = industry >> 2;
    switch ( buildingPlanetItemIndex )
    {
      case ASCEND_PI_33_ENDLESS_PARTY:
        prosperity += halfIndustry;
        break;
      case ASCEND_PI_34_SCIENTIST_TAKEOVER:
        LOWORD(research) = halfIndustry + research;
        break;
      case ASCEND_PI_35_AUTOMATION:
        v18 += V_PlanetItems.item[ASCEND_PI_35_AUTOMATION].upop;
        break;
    }
  }
  if ( industry )
  {
    industry = (int)pow((double)(industry + 1), 0.85);
  }
  if ( prosperity )
  {
    prosperity = (int)pow((double)(prosperity + 1), 0.85);
  }
  v26 = prosperity - pPlanet->word42 / 4;
  if ( v26 < 0 )
  {
    LOWORD(v26) = 0;
  }
  pPlanet->freeSurfaceSquaresNum = freeSurfaceSquaresNum;
  pPlanet->blackSquaresNum = blackSquaresNum;
  pPlanet->freeOrbitalSquaresNum = orbitalSquaresNum;
  pPlanet->industry = industry;
  pPlanet->research = research;
  if ( V_PlayerRaceIndex != pPlanet->raceIndex && V_FlashPopExists == FALSE && V_Game.atmosphere )
  {
    if ( V_Game.atmosphere <= (unsigned int)ASCEND_ATMOSPHERE_NEUTRAL )
    {
      pPlanet->industry = (int)((double)pPlanet->industry * 1.3);
    }
    else if ( V_Game.atmosphere == ASCEND_ATMOSPHERE_HOSTILE )
    {
      pPlanet->industry = (int)((double)pPlanet->industry * 1.3);
      pPlanet->research = (int)(1.3 * (double)pPlanet->research);
    }
  }
  pPlanet->prosperity = v26;
  pPlanet->maximumPopulation = maximumPopulation2;
  pPlanet->word4C = v18;
  pPlanet->byte58 = v17;
  pPlanet->byte59 = v19;
  if ( pPlanet->maximumPopulation > 100u )
  {
    pPlanet->maximumPopulation = 100;
  }
  maximumPopulation = pPlanet->maximumPopulation;
  if ( pPlanet->word42 > maximumPopulation )
  {
    pPlanet->word42 = maximumPopulation;
  }
  word42 = pPlanet->word42;
  if ( pPlanet->word4C > word42 )
  {
    pPlanet->word4C = word42;
  }
}

//----- (000352E0) --------------------------------------------------------
void __fastcall sub_352E0(P_Planet pPlanet)
{
  P_Square pSquares; // kr00_4
  int v3; // kr04_4
  int planetItemIndex; // edx
  UBYTE buildingPlanetItemIndex; // ah
  unsigned int v6; // ebp
  int v7; // eax
  unsigned __int16 squareIndex; // dx
  UBYTE raceIndex; // al
  T_Square *v10; // eax
  P_Ship ShipAtSquare_sub_35A70; // eax
  __int16 v12; // ax
  int v13; // edi
  int v14; // ecx
  UBYTE v15; // bl
  __int16 v16; // di
  UBYTE v17; // al
  int SquareWithItem_sub_35930; // eax
  UWORD maximumPopulation; // di
  int i; // eax
  float x_4; // [esp+4h] [ebp-58h]
  T_Vector3D v1; // [esp+8h] [ebp-54h] BYREF
  T_Vector3D v2; // [esp+14h] [ebp-48h]
  int a3; // [esp+2Ch] [ebp-30h] BYREF
  int a4; // [esp+30h] [ebp-2Ch] BYREF
  LONG length; // [esp+38h] [ebp-24h] BYREF
  float v27; // [esp+3Ch] [ebp-20h]
  int v28; // [esp+40h] [ebp-1Ch]

  pPlanet->Unknown_62 = 0;
  if ( pPlanet->raceIndex != 0xFF )
  {
    pSquares = pPlanet->pSquares;
    v3 = 0;
    LOWORD(v28) = 0;
    while ( (__int16)v28 < (int)pPlanet->totalSquaresNum )
    {
      if ( pSquares[v3].planetItemIndex != 0xFF )
      {
        planetItemIndex = pSquares[v3].planetItemIndex;
        if ( (V_PlanetItems.item[planetItemIndex].flags & 4) != 0 )
        {
          Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, planetItemIndex, &a3, &a4, &length);
          if ( length )
          {
            HIBYTE(pSquares[v3].flags) = 0;
            pSquares[v3].flags |= (_WORD)length << 8;
          }
        }
      }
      LOWORD(v28) = v28 + 1;
      ++v3;
    }
    buildingPlanetItemIndex = pPlanet->buildingPlanetItemIndex;
    v6 = 0;
    if ( buildingPlanetItemIndex != 0xFF )
    {
      v7 = buildingPlanetItemIndex;
      if ( (V_PlanetItems.item[v7].flags & 0x20) == 0 )
      {
        if ( pPlanet->_squareIndex == 0xFFFF && (V_PlanetItems.item[v7].flags & 2) == 0 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x3E9);
        }
        squareIndex = pPlanet->_squareIndex;
        pPlanet->buildingProgress += pPlanet->industry;
        if ( Q_Planet_GetItemCost_sub_3583C(pPlanet, squareIndex, pPlanet->buildingPlanetItemIndex) > pPlanet->buildingProgress )
        {
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_31_ALIEN_HOSPITALITY && !(V_Game.day % 10) )
          {
            v13 = V_PlayerRaceIndex;
            v14 = pPlanet->industry / 10 + 1;
            for ( i = 0; i < V_Game.racesNum; ++i )
            {
              *((_WORD *)&V_StaticStrings_dword_A0D04 + 0xF7 * i + v13 + 0x1210) = v14 + V_Game.races[i]._treatiesScore[v13];
            }
          }
        }
        else
        {
          raceIndex = pPlanet->raceIndex;
          if ( raceIndex == V_PlayerRaceIndex
            && pPlanet->buildingPlanetItemIndex == ASCEND_PI_02_LABORATORY
            && V_Research.current.project[raceIndex] == 0xFFFF
            && !sub_469F0(&V_Research, raceIndex) )
          {
            Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_25_FIRST_LAB, 0, 0);
          }
          if ( V_PlayerRaceIndex == pPlanet->raceIndex
            && WinMgr.state != 0x11
            && pPlanet->buildingPlanetItemIndex != ASCEND_PI_23_SHIP
            && !pPlanet->z7 )
          {
            v6 = 0xFFFFFFFF;
            Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_01_CONSTRUCTION_COMPLETE, (int)pPlanet, pPlanet->buildingPlanetItemIndex);
          }
          v10 = &pPlanet->pSquares[pPlanet->_squareIndex];
          if ( (v10->color & 8) != 0 )
          {
            v10->color &= ~8u;
            pPlanet->pSquares[pPlanet->_squareIndex].planetItemIndex = 0xFF;
            sub_46A94(&V_Research, pPlanet->raceIndex, (int)pPlanet);
          }
          else
          {
            LOBYTE(v10->flags) |= 1u;
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_23_SHIP )
          {
            ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, pPlanet->_squareIndex);
            if ( !ShipAtSquare_sub_35A70 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x415);
            }
            if ( ShipAtSquare_sub_35A70->locationType == ASCEND_LOCATION_TYPE_SHIPYARD )
            {
              pPlanet->word42 -= V_PlanetItems.item[0x17].upop;
            }
            sub_49828(ShipAtSquare_sub_35A70);
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_36_TERRAFORMING )
          {
            pPlanet->pSquares[pPlanet->_squareIndex].flags = 0;
            pPlanet->pSquares[pPlanet->_squareIndex].planetItemIndex = 0xFF;
            pPlanet->pSquares[pPlanet->_squareIndex].color = 1;
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_35_AUTOMATION )
          {
            LOBYTE(pPlanet->pSquares[pPlanet->_squareIndex].flags) |= 2u;
          }
          if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_37_LUSH_GROWTH_BOMB && (pPlanet->flags & ASCEND_PF_01_LUSH_GROWTH_BOMBED) == 0 )
          {
            pPlanet->maximumPopulation2 += 10;
            pPlanet->flags |= ASCEND_PF_01_LUSH_GROWTH_BOMBED;
          }
          if ( (V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].flags & 8) != 0 && pPlanet->_squareIndex >= pPlanet->surfaceSquaresNum )
          {
            v12 = 15;
            if ( pPlanet->buildingPlanetItemIndex == ASCEND_PI_27_ORBITAL_MEGA_SHIELD )
            {
              v12 = 35;
            }
            HIBYTE(pPlanet->pSquares[pPlanet->_squareIndex].flags) = 0;
            pPlanet->pSquares[pPlanet->_squareIndex].flags |= v12 << 8;
          }
          pPlanet->_squareIndex = 0xFFFF;
          pPlanet->buildingPlanetItemIndex = 0xFF;
          pPlanet->buildingProgress = 0;
        }
      }
    }
    if ( pPlanet->word42 < pPlanet->maximumPopulation )
    {
      v15 = V_PlayerRaceIndex;
      v16 = pPlanet->prosperity + pPlanet->z6;
      v17 = pPlanet->raceIndex;
      pPlanet->z6 = v16;
      if ( v17 != v15 && pPlanet->prosperity < 4u )
      {
        pPlanet->z6 = v16 + 1;
      }
      if ( (unsigned __int16)pPlanet->z6 < V_PopGrowthAmount50 )
      {
        goto LABEL_71;
      }
      if ( V_PlayerRaceIndex == pPlanet->raceIndex
        && WinMgr.state != ASCEND_WINMGR_STATE_PLANET_ALLOC
        && pPlanet->word42 == pPlanet->word4C
        && !v6
        && !pPlanet->z7
        && (pPlanet->buildingPlanetItemIndex == 0xFF || (V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].flags & 0x20) != 0) )
      {
        Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_15_HAS_FREE_POPULATION, (int)pPlanet, 0);
      }
      ++pPlanet->word42;
      SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xFu);
      if ( SquareWithItem_sub_35930 != 0xFFFF && (pPlanet->pSquares[SquareWithItem_sub_35930].flags & 1) != 0 )
      {
        ++pPlanet->word42;
      }
      maximumPopulation = pPlanet->maximumPopulation;
      if ( pPlanet->word42 > maximumPopulation )
      {
        pPlanet->word42 = maximumPopulation;
      }
    }
    pPlanet->z6 = 0;
LABEL_71:
    Q_Planet_CalcPoints_sub_34E70(pPlanet);
  }
  v1 = pPlanet->position;
  v27 = sqrt(v1.y * v1.y + v1.x * v1.x + v1.z * v1.z);
  Q_Vector3D_Normalize_sub_53000(&v1);
  x_4 = dbl_91DD9 / (v27 * v27);
  Q_RotateVectorY_sub_532AC(&v1, x_4);
  v2.x = v1.x * v27;
  v2.y = v1.y * v27;
  v2.z = v1.z * v27;
  v1.y = v2.y;
  v1.z = v2.z;
  pPlanet->position.x = v2.x;
  pPlanet->position.y = v1.y;
  pPlanet->position.z = v1.z;
}
// 91DD9: using guessed type double dbl_91DD9;
// 9684C: using guessed type int V_PopGrowthAmount50;

//----- (0003583C) --------------------------------------------------------
UWORD __fastcall Q_Planet_GetItemCost_sub_3583C(P_Planet pPlanet, unsigned __int16 a2, unsigned __int8 planetItemIndex)
{
  UWORD result; // ax
  T_Ship *ShipAtSquare_sub_35A70; // eax

  result = 0xFFFF;
  if ( a2 != 0xFFFF )
  {
    planetItemIndex = pPlanet->pSquares[a2].planetItemIndex;
  }
  if ( planetItemIndex != 0xFF )
  {
    if ( planetItemIndex == 0x17 )                     // Ship
    {
      if ( Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, a2)->locationType == 2 )
      {
        result = pPlanet->Unknown_77;
      }
      else
      {
        ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, a2);
        result = Q_Ship_GetCost_sub_4A18C(ShipAtSquare_sub_35A70);
      }
    }
    else
    {
      result = V_PlanetItems.item[planetItemIndex].cost;
    }
    if ( planetItemIndex == 0x23 && a2 == pPlanet->_squareIndex )// Automation
    {
      result *= 3;
    }
  }
  return result;
}
// 35893: conditional instruction was optimized away because bl.1 is in (<17u|18..FE)

//----- (000358BC) --------------------------------------------------------
int __fastcall Q_Planet_GetDaysToCompleteItem_sub_358BC(P_Planet pPlanet)
{
  UWORD industry; // si
  UWORD buildingProgress; // cx
  UWORD cost; // ax

  industry = pPlanet->industry;
  buildingProgress = pPlanet->buildingProgress;
  cost = Q_Planet_GetItemCost_sub_3583C(pPlanet, pPlanet->_squareIndex, pPlanet->buildingPlanetItemIndex);
  return Q_GetTurnsToComplete_sub_46C20(cost, buildingProgress, industry);
}

//----- (000358F0) --------------------------------------------------------
// Counts the number of non-ColonyBase buildings on a planet's surface
int __fastcall Q_Planet_CountSurfaceBuildings_sub_358F0(P_Planet pPlanet)
{
  UWORD surfaceSquaresNum; // dx
  int count; // ebx
  UWORD i; // ax
  UBYTE planetItemIndex; // cl

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  count = 0;
  i = 0;
  if ( surfaceSquaresNum )
  {
    do
    {
      planetItemIndex = pPlanet->pSquares[i].planetItemIndex;
      if ( planetItemIndex != 0xFF && planetItemIndex != ASCEND_PI_05_COLONY_BASE )
      {
        ++count;
      }
      ++i;
    }
    while ( i < pPlanet->surfaceSquaresNum );
  }
  return count;
}

//----- (00035930) --------------------------------------------------------
UWORD __fastcall Q_Planet_GetSquareWithItem_sub_35930(P_Planet pPlanet, UBYTE planetItemIndex)
{
  UWORD totalSquaresNum; // dx
  UWORD i; // ax

  totalSquaresNum = pPlanet->totalSquaresNum;
  i = 0;
  if ( !totalSquaresNum )
  {
    return 0xFFFF;
  }
  while ( planetItemIndex != pPlanet->pSquares[i].planetItemIndex )
  {
    if ( ++i >= pPlanet->totalSquaresNum )
    {
      return 0xFFFF;
    }
  }
  return i;
}

//----- (00035968) --------------------------------------------------------
// Converts grid (column,row) coordinates back to a linear square index
int __fastcall Q_Planet_GetSquareIndex_sub_35968(P_Planet pPlanet, int column, int row)
{
  int v6; // ebx
  int ii; // edx
  int size; // ecx
  int v9; // eax
  int v10; // esi
  int v11; // eax
  int v12; // eax
  int v14; // [esp+4h] [ebp-4h]

  v6 = 0;
  v14 = 0xFFFF;
  if ( column >= 0 && column < 15 && row >= 0 )
  {
    if ( column > 0 )
    {
      ii = 0;
      size = pPlanet->size;
      v9 = 0xF * size;
      do
      {
        LOWORD(size) = V_PlanetCfg.offsets.sizes[5].column[++v9];
        ++ii;
        v6 += size;
      }
      while ( ii < column );
    }
    v10 = 0xF * pPlanet->size + column;
    v11 = V_PlanetCfg.offsets.sizes[0].column[v10];
    if ( row >= v11 )
    {
      v12 = V_PlanetCfg.squares.sizes[0].column[v10] + v11;
      if ( row < v12 )
      {
        LOWORD(v12) = V_PlanetCfg.offsets.sizes[0].column[v10];
        return row + v6 - v12;
      }
    }
  }
  return v14;
}

//----- (00035A00) --------------------------------------------------------
// Converts a linear surface square index to (row, column) coordinates in planet's grid system
T_SquareGridCoord __fastcall Q_Planet_GetSurfaceSquareGridCoords_sub_35A00(P_Planet pPlanet, unsigned __int16 squareIndex)
{
  T_SquareGridCoord v4; // edi
  int row; // edi
  int column; // ecx
  UWORD surfaceSquaresNum; // si
  unsigned __int16 index; // ax
  int v9; // edx

  v4 = (T_SquareGridCoord)0xFFFFFFFF;
  if ( squareIndex < pPlanet->surfaceSquaresNum )
  {
    row = 0;
    column = 0;
    surfaceSquaresNum = pPlanet->surfaceSquaresNum;
    index = 0;
    if ( surfaceSquaresNum )
    {
      v9 = 0xF * pPlanet->size;
      do
      {
        row = V_PlanetCfg.offsets.sizes[0].column[v9] + squareIndex - index;
        index += V_PlanetCfg.squares.sizes[0].column[v9];
        if ( index > squareIndex )
        {
          break;
        }
        ++v9;
        ++column;
      }
      while ( index < pPlanet->surfaceSquaresNum );
    }
    return (T_SquareGridCoord)((column << 0x10) + row);
  }
  return v4;
}

//----- (00035A70) --------------------------------------------------------
P_Ship __fastcall Q_Planet_GetShipAtSquare_sub_35A70(P_Planet pPlanet, UWORD squareIndex)
{
  unsigned int shipIndex; // ecx

  if ( squareIndex >= pPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x50B);
  }
  shipIndex = ((int)pPlanet->pSquares[squareIndex].flags >> 8) & 0x7F;
  if ( shipIndex >= 107 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x50F);
  }
  if ( V_Game.ships[(unsigned __int16)shipIndex].raceIndex == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x510);
  }
  return &V_Game.ships[(unsigned __int16)shipIndex];
}

//----- (00035B04) --------------------------------------------------------
// Assigns a ship to an orbital square on a planet
void __fastcall Q_Planet_AssignShipToOrbitalSquare_sub_35B04(P_Planet pPlanet, unsigned __int16 squareIndex, P_Ship pShip)
{
  int shipIndex; // edi

  if ( squareIndex >= pPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x519);
  }
  if ( squareIndex < pPlanet->surfaceSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x51A);
  }
  shipIndex = pShip - V_Game.ships;
  if ( (unsigned __int16)shipIndex >= 107u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x51E);
  }
  if ( V_Game.ships[(unsigned __int16)shipIndex].raceIndex == 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x51F);
  }
  // Store ship index in square flags (upper byte) while preserving existing flags (lower byte)
  pPlanet->pSquares[squareIndex].flags = ((_WORD)shipIndex << 8) | (unsigned __int8)pPlanet->pSquares[squareIndex].flags;
}

//----- (00035BB4) --------------------------------------------------------
// Attempts to place a ship in orbit around a planet
// Return TRUE if successfully placed in orbit, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Planet_TryPlaceShipInOrbit_sub_35BB4(P_Planet pPlanet, P_Ship pShip)
{
  int firstOrbitalIndex_; // kr08_4
  int firstOrbitalIndex; // kr00_4
  int i; // kr04_4

  if ( pPlanet->raceIndex == pShip->raceIndex || Q_Planet_HasOrbitalDefense_sub_361B8(pPlanet) == FALSE )
  {
    firstOrbitalIndex_ = pPlanet->surfaceSquaresNum;
    firstOrbitalIndex = (unsigned __int16)firstOrbitalIndex_;
    for ( i = 0; firstOrbitalIndex_ + i < pPlanet->totalSquaresNum; ++i )
    {
      if ( pPlanet->pSquares[i + firstOrbitalIndex].planetItemIndex == 0xFF )
      {
        pShip->locationType = ASCEND_LOCATION_TYPE_ORBIT;
        pShip->pLocation.pPlanet = pPlanet;
        pPlanet->pSquares[i + firstOrbitalIndex].planetItemIndex = ASCEND_PI_23_SHIP;
        pPlanet->pSquares[i + firstOrbitalIndex].flags = ASCEND_SQUARE_FLAGS_COMPLETE;
        Q_Planet_AssignShipToOrbitalSquare_sub_35B04(pPlanet, firstOrbitalIndex_ + i, pShip);
        return TRUE;
      }
    }
  }
  return FALSE;
}

//----- (00035C38) --------------------------------------------------------
// Moves a ship from orbit into star system
// Returns TRUE if successful, FALSE if ship wasn't found on the planet
MACRO_VFX_BOOL __fastcall Q_Planet_LaunchShip_sub_35C38(P_Planet pPlanet, P_Ship pShip)
{
  int surfaceSquaresNum; // ecx
  int v4; // kr00_4
  T_Square *pSquare; // eax
  double z; // st7
  int i; // kr04_4
  T_Vector3D randomOffset; // [esp+0h] [ebp-40h] BYREF
  T_Vector3D shipPosition; // [esp+Ch] [ebp-34h] BYREF
  T_Vector3D shipPosition_; // [esp+18h] [ebp-28h] BYREF
  int v12; // [esp+24h] [ebp-1Ch]
  T_Vector3D *p_shipPosition; // [esp+28h] [ebp-18h]

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  v4 = surfaceSquaresNum;
  for ( i = 0; surfaceSquaresNum + i < pPlanet->totalSquaresNum; ++i )
  {
    pSquare = &pPlanet->pSquares[i + v4];
    if ( pSquare->flags
      && pSquare->planetItemIndex == ASCEND_PI_23_SHIP
      && Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, surfaceSquaresNum) == pShip )
    {
      pPlanet->pSquares[i + v4].planetItemIndex = 0xFF;
      pPlanet->pSquares[i + v4].flags = 0;
      pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
      pShip->pLocation.pStar = &V_Game.stars[pPlanet->starIndex];
      randomOffset.x = (float)(rand() % 1000 - 500);
      randomOffset.y = (float)(rand() % 1000 - 500);
      v12 = rand() % 1000 - 500;
      randomOffset.z = (float)v12;
      Q_Vector3D_SetLength_sub_53054(&randomOffset, 250.0);
      memset(&shipPosition_, 0, sizeof(shipPosition_));
      p_shipPosition = &shipPosition;
      shipPosition_.x = pPlanet->position.x + randomOffset.x;
      shipPosition_.y = pPlanet->position.y + randomOffset.y;
      z = pPlanet->position.z;
      shipPosition = shipPosition_;
      shipPosition_.z = z + randomOffset.z;
      Q_Ship_SetPositionAndSnapToGrid_sub_496BC(pShip, &shipPosition);
      return TRUE;
    }
  }
  return FALSE;
}

//----- (00035DA4) --------------------------------------------------------
// Determines the best available orbital shield type for a planet
// Return Item index of best available shield (MEGA_SHIELD, SHIELD, or 0xFF if none available)
char __fastcall Q_Planet_GetBestAvailableOrbitalShield_sub_35DA4(P_Planet pPlanet)
{
  char NO_SHIELD_AVAILABLE; // bl
  int v2; // ecx

  NO_SHIELD_AVAILABLE = 0xFF;
  if ( V_PlanetItems.item[ASCEND_PI_27_ORBITAL_MEGA_SHIELD].resReq == 0xFF )
  {
    return ASCEND_PI_27_ORBITAL_MEGA_SHIELD;
  }
  v2 = 1 << pPlanet->raceIndex;
  if ( (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_27_ORBITAL_MEGA_SHIELD].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_27_ORBITAL_MEGA_SHIELD;
  }
  if ( V_PlanetItems.item[ASCEND_PI_26_ORBITAL_SHIELD].resReq == 0xFF
    || (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_26_ORBITAL_SHIELD].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_26_ORBITAL_SHIELD;
  }
  return NO_SHIELD_AVAILABLE;
}

//----- (00035E24) --------------------------------------------------------
// Determines the best available orbital defense weapon for a planet based on researched technologies
// Return Item index of best available orbital weapon (LONG_RANGE_WHOPPER, SHORT_RANGE_WHOPPER, MISSILE_BASE, or 0xFF if none available)
char __fastcall Q_Planet_GetBestAvailableOrbitalWeapon_sub_35E24(P_Planet pPlanet)
{
  char NO_WEAPON_AVAILABLE; // dl
  int v2; // ecx

  NO_WEAPON_AVAILABLE = 0xFF;
  if ( V_PlanetItems.item[ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER].resReq == 0xFF )
  {
    return ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER;
  }
  v2 = 1 << pPlanet->raceIndex;
  if ( (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER;
  }
  if ( V_PlanetItems.item[ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER].resReq == 0xFF
    || (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER;
  }
  if ( V_PlanetItems.item[ASCEND_PI_28_ORBITAL_MISSILE_BASE].resReq == 0xFF
    || (v2 & V_Research.techs[V_PlanetItems.item[ASCEND_PI_28_ORBITAL_MISSILE_BASE].resReq].knownToRace) != 0 )
  {
    return ASCEND_PI_28_ORBITAL_MISSILE_BASE;
  }
  return NO_WEAPON_AVAILABLE;
}

//----- (00035ED8) --------------------------------------------------------
// Calculates the maximum orbital defense coverage range for a planet
// Return Maximum defense range in game units, or -1 if no defenses
int __fastcall Q_Planet_GetMaxOrbitalDefenseRange_sub_35ED8(P_Planet pPlanet)
{
  int surfaceSquaresNum; // kr08_4
  int firstOrbitalIndex; // kr00_4
  UBYTE planetItemIndex_; // al
  T_Square *pPlanetSquare; // eax
  UBYTE planetItemIndex; // dl
  int i; // kr04_4
  int range; // [esp+Ch] [ebp-34h] BYREF
  int damage; // [esp+10h] [ebp-30h] BYREF
  LONG numUses; // [esp+14h] [ebp-2Ch] BYREF
  float currentRange; // [esp+18h] [ebp-28h]
  int baseRange; // [esp+1Ch] [ebp-24h]
  int remainingUses; // [esp+20h] [ebp-20h]
  float maxRange; // [esp+24h] [ebp-1Ch]

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  maxRange = -1.0;
  firstOrbitalIndex = surfaceSquaresNum;
  for ( i = 0; surfaceSquaresNum + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i + firstOrbitalIndex];
    planetItemIndex = pPlanetSquare->planetItemIndex;
    currentRange = -1.0;
    if ( planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex_ = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex_ >= (unsigned int)ASCEND_PI_28_ORBITAL_MISSILE_BASE
        && planetItemIndex_ <= (unsigned int)ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER )
      {
        range = 0;
        damage = 0;
        numUses = 1;
        Q_Planet_GetOrbitalWeaponStats_sub_366C8(
          pPlanet,
          pPlanet->pSquares[i + firstOrbitalIndex].planetItemIndex,
          &range,
          &damage,
          &numUses);
        if ( numUses )
        {
          remainingUses = (int)pPlanet->pSquares[i + firstOrbitalIndex].flags >> 8;
        }
        // Calculate effective range if weapon has remaining uses
        if ( remainingUses > 0 )
        {
          baseRange = 32 * range;
          currentRange = (double)(32 * range) * 0.95;
        }
      }
    }
    if ( currentRange > (double)maxRange )
    {
      maxRange = currentRange;
    }
  }
  return (int)maxRange;
}

//----- (00035FE0) --------------------------------------------------------
// Calculates the total shield strength of a planet's orbital defenses
// Return Total shield strength (3 per regular shield, 6 per mega shield)
int __fastcall Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(P_Planet pPlanet)
{
  int firstOrbitalIndex; // kr08_4
  int totalShieldStrength; // eax
  UBYTE planetItemIndex; // dl
  T_Square *pPlanetSquare; // edx
  int i; // kr04_4

  firstOrbitalIndex = pPlanet->surfaceSquaresNum;
  totalShieldStrength = 0;
  for ( i = 0; firstOrbitalIndex + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[(unsigned __int16)firstOrbitalIndex + i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex >= (unsigned int)ASCEND_PI_26_ORBITAL_SHIELD )
      {
        if ( planetItemIndex <= (unsigned int)ASCEND_PI_26_ORBITAL_SHIELD )
        {
          totalShieldStrength += 3;
        }
        else if ( planetItemIndex == ASCEND_PI_27_ORBITAL_MEGA_SHIELD )
        {
          totalShieldStrength += 6;
        }
      }
    }
  }
  return totalShieldStrength;
}

//----- (00036050) --------------------------------------------------------
// Calculates the total weapon strength of a planet's orbital defenses
// Return Total weapon strength (2 per missile base, 4 per short-range whopper, 6 per long-range whopper)
int __fastcall Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(P_Planet pPlanet)
{
  int firstOrbitalIndex; // kr08_4
  int totalWeaponStrength; // eax
  UBYTE planetItemIndex; // dl
  T_Square *pPlanetSquare; // edx
  int i; // kr04_4

  firstOrbitalIndex = pPlanet->surfaceSquaresNum;
  totalWeaponStrength = 0;
  for ( i = 0; firstOrbitalIndex + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[(unsigned __int16)firstOrbitalIndex + i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex < (unsigned int)ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER )
      {
        if ( planetItemIndex == ASCEND_PI_28_ORBITAL_MISSILE_BASE )
        {
          totalWeaponStrength += 2;
        }
      }
      else if ( planetItemIndex <= (unsigned int)ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER )
      {
        totalWeaponStrength += 4;
      }
      else if ( planetItemIndex == ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER )
      {
        totalWeaponStrength += 6;
      }
    }
  }
  return totalWeaponStrength;
}

//----- (000360D8) --------------------------------------------------------
// Calculates the total defensive strength of a planet's orbital installations
// @return Combined defensive score of all orbital installations
int __fastcall Q_Planet_CalculateOrbitalDefenseStrength_sub_360D8(P_Planet pPlanet)
{
  int firstOrbitalIndex; // kr08_4
  int defenseScore; // eax
  T_Square *pPlanetSquare; // edx
  int i; // kr04_4

  firstOrbitalIndex = pPlanet->surfaceSquaresNum;
  defenseScore = 0;
  for ( i = 0; firstOrbitalIndex + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[(unsigned __int16)firstOrbitalIndex + i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      switch ( pPlanetSquare->planetItemIndex )
      {
        case ASCEND_PI_26_ORBITAL_SHIELD:
          ++defenseScore;
          break;
        case ASCEND_PI_27_ORBITAL_MEGA_SHIELD:
        case ASCEND_PI_28_ORBITAL_MISSILE_BASE:
          defenseScore += 2;
          break;
        case ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER:
          defenseScore += 4;
          break;
        case ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER:
          defenseScore += 6;
          break;
        default:
          continue;
      }
    }
  }
  return defenseScore;
}

//----- (00036158) --------------------------------------------------------
// // Calculates the total shield strength of a planet's surface defenses
// // @return Total shield strength (2 per regular shield, 4 per mega shield)
int __fastcall Q_Planet_CalculateSurfaceShieldStrength_sub_36158(P_Planet pPlanet)
{
  int score; // eax
  UBYTE planetItemIndex; // dl
  T_Square *pPlanetSquare; // edx
  int i; // ebx

  score = 0;
  for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex >= (unsigned int)ASCEND_PI_18_SURFACE_SHIELD )
      {
        if ( planetItemIndex <= (unsigned int)ASCEND_PI_18_SURFACE_SHIELD )
        {
          score += 2;
        }
        else if ( planetItemIndex == ASCEND_PI_19_SURFACE_MEGA_SHIELD )
        {
          score += 4;
        }
      }
    }
  }
  return score;
}

//----- (000361B8) --------------------------------------------------------
// Checks if a planet has orbital defenses that prevent enemy ships from orbiting
// Return TRUE if planet has active orbital defenses, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Planet_HasOrbitalDefense_sub_361B8(P_Planet pPlanet)
{
  int surfaceSquaresNum; // ecx
  int false; // edi
  int v4; // kr00_4
  T_Square *pPlanetSquare; // eax
  UBYTE planetItemIndex; // dl
  int i; // kr04_4

  surfaceSquaresNum = pPlanet->surfaceSquaresNum;
  false = FALSE;
  v4 = (unsigned __int16)surfaceSquaresNum;
  for ( i = 0; surfaceSquaresNum + i < pPlanet->totalSquaresNum; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i + v4];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      if ( pPlanetSquare->planetItemIndex == ASCEND_PI_23_SHIP
        && Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, surfaceSquaresNum)->raceIndex == pPlanet->raceIndex )
      {
        return TRUE;
      }
      planetItemIndex = pPlanet->pSquares[i + v4].planetItemIndex;
      if ( planetItemIndex == ASCEND_PI_26_ORBITAL_SHIELD || planetItemIndex == ASCEND_PI_27_ORBITAL_MEGA_SHIELD )
      {
        return TRUE;
      }
    }
  }
  return false;
}

//----- (0003623C) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_3623C(P_Planet pPlanet)
{
  MACRO_VFX_BOOL v2; // ebp
  T_Square *pPlanetSquare; // eax
  UBYTE planetItemIndex; // dh
  int i; // [esp+0h] [ebp-1Ch]

  v2 = 0;
  for ( i = 0; pPlanet->surfaceSquaresNum > i; ++i )
  {
    pPlanetSquare = &pPlanet->pSquares[i];
    if ( pPlanetSquare->planetItemIndex != 0xFF && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      planetItemIndex = pPlanetSquare->planetItemIndex;
      if ( planetItemIndex == ASCEND_PI_02_LABORATORY || planetItemIndex == ASCEND_PI_08_RESEARCH_CAMPUS )
      {
        if ( Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, i, pPlanet->pSquares[i].planetItemIndex, 1u) )
        {
          v2 = TRUE;
        }
      }
    }
  }
  return v2;
}

//----- (000362C8) --------------------------------------------------------
void __fastcall Q_Planet_SetPosition_sub_362C8(P_Planet pPlanet, P_Vector3D newPosition)
{
  pPlanet->position = *newPosition;
  Q_Vector3D_SnapToGrid_sub_53440(&pPlanet->position);
}

//----- (000362E0) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Planet_CanBuildShip_sub_362E0(P_Planet pPlanet)
{
  int false; // ebx
  int shipyardSquareIndex; // eax

  if ( pPlanet->raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x688);
  }
  false = FALSE;
  shipyardSquareIndex = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD);
  if ( shipyardSquareIndex != 0xFFFF
    && (pPlanet->pSquares[shipyardSquareIndex].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0
    && Q_Race_GetMoreAllowedShips_sub_3EFE0(&V_Game.races[pPlanet->raceIndex]) > 0 )
  {
    return TRUE;
  }
  return false;
}

//----- (0003636C) --------------------------------------------------------
int __fastcall Q_Planet_GetSquaresValue_sub_3636C(P_Planet pPlanet, BOOL withBlack)
{
  P_Square pSquares; // kr00_4
  int result; // eax
  int ii; // kr04_4
  __int16 i; // bx

  pSquares = pPlanet->pSquares;
  result = 0;
  ii = 0;
  for ( i = 0; i < (int)pPlanet->surfaceSquaresNum; ++i )
  {
    if ( pSquares[ii].color < (unsigned int)ASCEND_SQUARE_COLOR_RED )
    {
      if ( pSquares[ii].color )                        // White square
      {
        ++result;
      }
      else if ( withBlack )
      {
        ++result;
      }
    }
    else
    {
      result += 2;
    }
    ++ii;
  }
  return result;
}

//----- (000363B0) --------------------------------------------------------
int __fastcall Q_Planet_GetTotalValue_sub_363B0(P_Planet pPlanet)
{
  int squaresValue; // edi
  int itemsValue; // ebx
  int totalValue; // edi
  int i; // eax

  if ( pPlanet->raceIndex > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x6CD);
  }
  squaresValue = (pPlanet->maximumPopulation - pPlanet->word42) / 2
               + pPlanet->word42
               + pPlanet->research
               + pPlanet->prosperity
               + pPlanet->industry
               + (unsigned __int16)Q_Planet_GetSquaresValue_sub_3636C(
                                     pPlanet,
                                     (V_Game.races[pPlanet->raceIndex].ability != ASCEND_SA_BUILD_ON_BLACK) - 1);
  if ( (pPlanet->flags & ASCEND_PF_02_HAS_XENO_RUINS) != 0 )
  {
    squaresValue += 100;
  }
  itemsValue = 0;
  for ( i = 0; i < pPlanet->totalSquaresNum; ++i )
  {
    itemsValue += V_PlanetItems.item[pPlanet->pSquares[i].planetItemIndex].cost;
  }
  totalValue = itemsValue + squaresValue;
  if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD) )
  {
    totalValue += 50;
  }
  if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_24_ORBITAL_DOCKS) )
  {
    totalValue += 50;
  }
  if ( totalValue < 0 )
  {
    return 0;
  }
  return totalValue;
}

//----- (000364B4) --------------------------------------------------------
int __fastcall sub_364B4(P_Planet pPlanet, __int16 a2)
{
  T_Race *v3; // ebx
  int raceIndex; // eax
  int SquaresValue_sub_3636C; // esi
  unsigned int v6; // esi
  int v7; // edi
  int v8; // eax
  int v9; // edi
  int v10; // eax
  int i; // edx
  int j; // kr0C_4
  int v14; // [esp+0h] [ebp-1Ch]
  unsigned int v15; // [esp+4h] [ebp-18h]

  if ( a2 > V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x71A);
  }
  v3 = &V_Game.races[a2];
  raceIndex = pPlanet->raceIndex;
  v14 = 0;
  if ( raceIndex == 0xFF || a2 != raceIndex && v3->treaties[raceIndex] == 2 )
  {
    SquaresValue_sub_3636C = (unsigned __int16)Q_Planet_GetSquaresValue_sub_3636C(pPlanet, (V_Game.races[a2].ability != 2) - 1);
    v14 = SquaresValue_sub_3636C;
    if ( (pPlanet->flags & 2) != 0 )
    {
      v14 = SquaresValue_sub_3636C + 0x28;
    }
    if ( v14 > 0x46 || v3->treaties[pPlanet->raceIndex] == 2 )
    {
      if ( v3->treaties[pPlanet->raceIndex] != 2 )
      {
        goto LABEL_30;
      }
      v6 = 0;
      v7 = (pPlanet->maximumPopulation - pPlanet->word42) / 2
         + pPlanet->word42
         + pPlanet->research
         + pPlanet->prosperity
         + pPlanet->industry;
      v15 = 0;
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xBu) != 0xFFFF )
      {
        v6 = 0xFFFFFFFF;
      }
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x19u) != 0xFFFF )
      {
        v15 = 0xFFFFFFFF;
      }
      v8 = 0;
      if ( !v6 )
      {
        for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
        {
          v8 += V_PlanetItems.item[pPlanet->pSquares[i].planetItemIndex].cost;
        }
      }
      if ( !v15 )
      {
        for ( j = 0; pPlanet->surfaceSquaresNum + j < pPlanet->totalSquaresNum; ++j )
        {
          v8 += V_PlanetItems.item[pPlanet->pSquares[j].planetItemIndex].cost;
        }
      }
      v9 = v8 + v7;
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_22_SHIPYARD) )
      {
        v9 += 50;
      }
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, ASCEND_PI_24_ORBITAL_DOCKS) )
      {
        v9 += 50;
      }
      v10 = 2 * (v9 / 0xA + v14);
    }
    else
    {
      v10 = 0;
    }
    v14 = v10;
  }
LABEL_30:
  if ( v14 < 0 )
  {
    return 0;
  }
  return v14;
}

//----- (000366C8) --------------------------------------------------------
void __fastcall Q_Planet_GetOrbitalWeaponStats_sub_366C8(
        P_Planet pPlanet,
        UBYTE planetItemIndex,
        LONG *outRange,
        LONG *outDamage,
        LONG *outNumUses)
{
  if ( !outRange || !outDamage || !outNumUses )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x785);
  }
  switch ( planetItemIndex )
  {
    case ASCEND_PI_28_ORBITAL_MISSILE_BASE:
      *outRange = 45;
      *outDamage = 7;
      *outNumUses = 1;
      break;
    case ASCEND_PI_29_SHORT_RANGE_ORBITAL_WHOPPER:
      *outRange = 45;
      *outDamage = 7;
      *outNumUses = 3;
      break;
    case ASCEND_PI_30_LONG_RANGE_ORBITAL_WHOPPER:
      *outRange = 90;
      *outDamage = 8;
      *outNumUses = 3;
      break;
    case ASCEND_PI_17_TRACTOR_BEAM:
      *outRange = 200;
      *outDamage = 0;
      *outNumUses = 2;
      break;
  }
}

//----- (0003676C) --------------------------------------------------------
int __fastcall sub_3676C(P_Planet pPlanet, int a2)
{
  UBYTE planetItemIndex; // al
  P_Ship pShip; // edi
  BOOL v5; // eax
  int v6; // eax
  double v7; // st7
  double z; // st7
  T_Type23 *pt23; // eax
  int result; // eax
  T_Vector3D v11; // [esp+8h] [ebp-8Ch]
  T_Vector3D v12; // [esp+14h] [ebp-80h] BYREF
  T_Vector3D v13; // [esp+20h] [ebp-74h] BYREF
  T_Vector3D v14; // [esp+38h] [ebp-5Ch] BYREF
  int numUses; // [esp+58h] [ebp-3Ch] BYREF
  T_Vector3D *v16; // [esp+60h] [ebp-34h]
  LONG range; // [esp+64h] [ebp-30h] BYREF
  int damage; // [esp+68h] [ebp-2Ch] BYREF
  T_Vector3D *v19; // [esp+6Ch] [ebp-28h]
  int v20; // [esp+70h] [ebp-24h]
  float v21; // [esp+74h] [ebp-20h]
  int v22; // [esp+78h] [ebp-1Ch]
  int v23; // [esp+7Ch] [ebp-18h]

  planetItemIndex = pPlanet->t22.pt23->planetItemIndex;
  v20 = 0xFFFFFFFF;
  if ( planetItemIndex == 0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x7AB);
  }
  v23 = 0;
  pShip = pPlanet->t22.pShip;
  damage = 0;
  numUses = 1;
  Q_Planet_GetOrbitalWeaponStats_sub_366C8(pPlanet, pPlanet->t22.pt23->planetItemIndex, &range, &damage, &numUses);
  if ( pShip )
  {
    range = 0;
    if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM || &V_Game.stars[pPlanet->starIndex] != pShip->pLocation.pStar )
    {
      v20 = 0;
    }
  }
  v22 = 1;
  if ( numUses )
  {
    v22 = (int)pPlanet->t22.pt23->Unknown_2 >> 8;
  }
  v5 = v20 && v22;
  v23 |= v5;
  if ( (v23 & 1) != 0 )
  {
    if ( damage )
    {
      v6 = Q_Ship_ApplyDamage_sub_4B7A0(pShip, a2, damage, pPlanet->raceIndex);
      v23 |= v6;
    }
    if ( a2 == 1 )
    {
      if ( pPlanet->t22.pt23->planetItemIndex == ASCEND_PI_17_TRACTOR_BEAM )
      {
        v16 = &v13;
        v11.x = pShip->position.x - pPlanet->position.x;
        v11.y = pShip->position.y - pPlanet->position.y;
        v11.z = pShip->position.z - pPlanet->position.z;
        v13 = v11;
        v7 = sqrt(v11.y * v11.y + v11.x * v11.x + v11.z * v11.z) + -3200.0;
        v21 = v7;
        if ( v7 < 1280.0 )
        {
          v21 = 1280.0;
        }
        Q_Vector3D_SetLength_sub_53054(&v13, v21);
        memset(&v14, 0, sizeof(v14));
        v19 = &v12;
        v14.x = pPlanet->position.x + v13.x;
        v14.y = pPlanet->position.y + v13.y;
        z = pPlanet->position.z;
        v12 = v14;
        v14.z = z + v13.z;
        pShip->position.x = v14.x;
        pShip->position.y = v12.y;
        pShip->position.z = v12.z;
      }
      if ( numUses && v22 > 0 )
      {
        pt23 = pPlanet->t22.pt23;
        --v22;
        HIBYTE(pt23->Unknown_2) = 0;
        pPlanet->t22.pt23->Unknown_2 |= (_WORD)v22 << 8;
      }
    }
  }
  result = v23;
  pPlanet->t22.Unknown_8 = v23;
  return result;
}
// 3680F: conditional instruction was optimized away because %range.4==0

//----- (00036A5C) --------------------------------------------------------
void __fastcall sub_36A5C(P_Planet pPlanet, int a2, WORD raceIndex)
{
  int raceIndex__; // edx
  int v5; // eax
  UWORD totalSquaresNum; // cx
  int v7; // edi
  int v8; // eax
  int v9; // kr04_4
  int v10; // ebx
  int v11; // ecx
  UWORD v12; // di
  int v13; // ebp
  int v14; // eax
  WORD v15; // cx
  int v16; // ebx
  T_Ship *ShipAtSquare_sub_35A70; // eax
  __int16 v18[10]; // [esp+0h] [ebp-30h]
  int v19; // [esp+14h] [ebp-1Ch]
  int squareIndex; // [esp+18h] [ebp-18h]
  WORD raceIndex_; // [esp+1Ch] [ebp-14h]

  v19 = a2;
  raceIndex_ = raceIndex;
  if ( pPlanet->Unknown_62 != 0xFFFFFFFF )
  {
    if ( pPlanet->raceIndex >= V_Game.racesNum && pPlanet->raceIndex != 0xFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x7FE);
    }
    if ( raceIndex_ < 0 || raceIndex_ >= V_Game.racesNum )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x7FF);
    }
    raceIndex__ = pPlanet->raceIndex;
    if ( raceIndex__ != 0xFF )
    {
      v5 = raceIndex__;
      raceIndex__ = raceIndex_;
      Q_Race_DecayRelations_sub_433E0(&V_Game.races[v5], raceIndex_, &V_Game.stars[pPlanet->starIndex]);
    }
    LOWORD(raceIndex__) = pPlanet->surfaceSquaresNum;
    totalSquaresNum = pPlanet->totalSquaresNum;
    v7 = 0;
    squareIndex = 0xFFFF;
    if ( (unsigned __int16)raceIndex__ < totalSquaresNum )
    {
      v8 = 0;
      v9 = 0;
      do
      {
        v10 = (unsigned __int16)raceIndex__;
        if ( pPlanet->pSquares[v10].planetItemIndex != 0xFF )
        {
          v18[v8] = raceIndex__;
          if ( (V_PlanetItems.item[pPlanet->pSquares[v10].planetItemIndex].flags & ASCEND_PI_FLAG_DEFENSE) != 0
            && (_WORD)raceIndex__ != pPlanet->_squareIndex )
          {
            squareIndex = raceIndex__ + v9;
          }
          ++v8;
          ++v7;
        }
        ++v9;
      }
      while ( (unsigned __int16)raceIndex__ < pPlanet->totalSquaresNum );
    }
    if ( v7 )
    {
      v11 = 0xFFFFFFFF;
      if ( (unsigned __int16)squareIndex == 0xFFFF )
      {
        v12 = v18[rand() % v7];
      }
      else
      {
        v12 = squareIndex;
        v13 = (unsigned __int16)squareIndex;
        v14 = ((int)pPlanet->pSquares[v13].flags >> 8) - v19;
        if ( v14 > 0 && (_WORD)squareIndex != pPlanet->_squareIndex )
        {
          HIBYTE(pPlanet->pSquares[v13].flags) = 0;
          pPlanet->pSquares[v13].flags |= (_WORD)v14 << 8;
          v11 = 0;
        }
      }
      if ( pPlanet->pSquares[v12].planetItemIndex == 0x17 )
      {
        v15 = raceIndex_;
        v16 = v19;
        ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, v12);
        v11 = ((Q_Ship_ApplyDamage_sub_4B7A0(ShipAtSquare_sub_35A70, 1, 2 * v16, v15) & 4) == 0) - 1;
      }
      if ( pPlanet->maximumPopulation < pPlanet->word42 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x837);
      }
      if ( V_PlanetItems.item[pPlanet->pSquares[v12].planetItemIndex].mpop )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x838);
      }
      if ( v11 == 0xFFFFFFFF )
      {
        Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, v12, 0xFFu, 1u);
        if ( pPlanet->pSquares[v12].planetItemIndex != 0xFF )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x83D);
        }
        if ( v12 == pPlanet->_squareIndex )
        {
          pPlanet->_squareIndex = 0xFFFF;
          pPlanet->buildingPlanetItemIndex = 0xFF;
          pPlanet->buildingProgress = 0;
        }
      }
      Q_Planet_CalcPoints_sub_34E70(pPlanet);
    }
  }
}
// 36A5C: using guessed type __int16 var_30[10];

//----- (00036CD4) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Planet_TryInvade_sub_36CD4(P_Planet pPlanet, unsigned __int16 squareIndex_1, int *outModulesUse)
{
  P_Ship vpShip; // eax
  int raceIndex; // edx
  T_Ship *vpShip_; // ebp
  unsigned int v7; // eax
  WORD Unknown_1C9; // di
  __int16 i; // ax
  __int16 j; // ax
  T_Square *v11; // edx
  T_Square *v12; // edx
  int ii; // edi
  int v14; // edi
  T_Square *pPlanetSquare; // eax
  T_Square *pPlanetSquare_; // eax
  __int16 k; // bx
  MACRO_VFX_BOOL mastersOfInvasion; // [esp+0h] [ebp-30h]
  int surfaceShields; // [esp+4h] [ebp-2Ch]
  int modulesToUse; // [esp+8h] [ebp-28h]
  MACRO_VFX_BOOL invaded; // [esp+Ch] [ebp-24h]
  int invasionModules; // [esp+10h] [ebp-20h]
  int v24; // [esp+14h] [ebp-1Ch]
  signed __int16 squareIndex; // [esp+18h] [ebp-18h]
  signed __int16 a2; // [esp+1Ch] [ebp-14h]

  if ( squareIndex_1 >= pPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x851);
  }
  if ( pPlanet->pSquares[squareIndex_1].planetItemIndex != 0x17 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x852);
  }
  vpShip = Q_Planet_GetShipAtSquare_sub_35A70(pPlanet, squareIndex_1);
  raceIndex = pPlanet->raceIndex;
  vpShip_ = vpShip;
  if ( raceIndex == 0xFF || raceIndex == vpShip->raceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x856);
  }
  invaded = FALSE;
  mastersOfInvasion = FALSE;
  if ( !V_Game.races[vpShip->raceIndex].ability )
  {
    mastersOfInvasion = TRUE;
  }
  if ( Q_Race_DecayRelations_sub_433E0(&V_Game.races[pPlanet->raceIndex], vpShip->raceIndex, &V_Game.stars[pPlanet->starIndex]) == 0xFFFFFFFF )
  {
    v7 = 0xF7 * pPlanet->raceIndex;
    Unknown_1C9 = V_Game.races[v7 / 0xF7].Unknown_1C9;
    if ( Unknown_1C9 < V_Game.races[0]._treatiesScore[vpShip_->raceIndex + v7] )
    {
      V_Game.races[0]._treatiesScore[vpShip_->raceIndex + v7] = Unknown_1C9 - 0xA;
    }
  }
  invasionModules = 0;
  surfaceShields = 0;
  for ( i = 0; i < vpShip_->hullCellsNum; ++i )
  {
    if ( vpShip_->hullCells[i].gizmoIndex == ASCEND_GIZMO_73_INVASION_MODULE )
    {
      ++invasionModules;
    }
  }
  for ( j = 0; j < (int)pPlanet->surfaceSquaresNum; ++j )
  {
    v12 = &pPlanet->pSquares[j];
    if ( v12->planetItemIndex == ASCEND_PI_18_SURFACE_SHIELD && (v12->flags & 1) != 0 )
    {
      ++surfaceShields;
    }
    else
    {
      v11 = &pPlanet->pSquares[j];
      if ( v11->planetItemIndex == ASCEND_PI_19_SURFACE_MEGA_SHIELD && (v11->flags & 1) != 0 )
      {
        surfaceShields += 2;
      }
    }
  }
  v24 = invasionModules;
  if ( invasionModules > surfaceShields )
  {
    v24 = surfaceShields + 1;
  }
  modulesToUse = v24;
  if ( mastersOfInvasion == TRUE )
  {
    modulesToUse = 1;
  }
  ii = 0;
  *outModulesUse = modulesToUse;
  for ( k = 0; k < vpShip_->hullCellsNum && ii < modulesToUse; ++k )
  {
    if ( vpShip_->hullCells[k].gizmoIndex == ASCEND_GIZMO_73_INVASION_MODULE )
    {
      ++ii;
      Q_Ship_RemoveGizmoFromCell_sub_492F8(vpShip_, k);
    }
  }
  Q_Ship_RecalcStats_sub_496E0(vpShip_);
  v14 = 0;
  for ( a2 = 0; a2 < (int)pPlanet->surfaceSquaresNum && v14 < v24; ++a2 )
  {
    pPlanetSquare = &pPlanet->pSquares[a2];
    if ( pPlanetSquare->planetItemIndex == ASCEND_PI_18_SURFACE_SHIELD && (pPlanetSquare->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      ++v14;
      Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, a2, 0xFFu, 1u);
    }
  }
  for ( squareIndex = 0; squareIndex < (int)pPlanet->surfaceSquaresNum && v14 < v24; ++squareIndex )
  {
    pPlanetSquare_ = &pPlanet->pSquares[squareIndex];
    if ( pPlanetSquare_->planetItemIndex == ASCEND_PI_19_SURFACE_MEGA_SHIELD && (pPlanetSquare_->flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0 )
    {
      v14 += 2;
      if ( v14 <= v24 )
      {
        Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, squareIndex, 0xFFu, 1u);
      }
    }
  }
  if ( invasionModules > surfaceShields || mastersOfInvasion == TRUE )
  {
    if ( pPlanet->raceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_BATTLE )
    {
      Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_COLONYINVADED, (int)pPlanet, 0);
    }
    Q_Star_ChangePlanetOwnership_sub_1D234(&V_Game.stars[pPlanet->starIndex], pPlanet, vpShip_->raceIndex);
    invaded = TRUE;
    pPlanet->dayColonized = V_Game.day;
  }
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
  return invaded;
}

//----- (00037040) --------------------------------------------------------
void __fastcall Q_Planet_Abandon_sub_37040(P_Planet pPlanet)
{
  T_Square *v2; // esi
  int i; // edx

  Q_Star_ChangePlanetOwnership_sub_1D234(&V_Game.stars[pPlanet->starIndex], pPlanet, 0xFFFF);
  for ( i = 0; i < pPlanet->totalSquaresNum; ++i )
  {
    v2 = &pPlanet->pSquares[i];
    if ( v2->planetItemIndex != ASCEND_PI_23_SHIP )
    {
      v2->planetItemIndex = 0xFF;
      pPlanet->pSquares[i].flags = 0;
    }
  }
  pPlanet->word4C = 0;
  pPlanet->word42 = pPlanet->word4C;
  pPlanet->raceIndex = 0xFF;
  Q_Planet_CalcPoints_sub_34E70(pPlanet);
}

//----- (000370B8) --------------------------------------------------------
void __fastcall Q_Planet_ReadWrite_sub_370B8(P_Planet pPlanet, P_CFile pfi, int read)
{
  T_Planet vPlanet; // [esp+0h] [ebp-8Ch] BYREF

  if ( read == TRUE )
  {
    memset(&vPlanet, 0, 0xC);
    vPlanet.pSquares = 0;
    vPlanet.z7 = 0;
    vPlanet.totalSquaresNum = 0;
    Q_ReadFile_sub_1BF94(pfi, &vPlanet, 0x7Bu);
    pPlanet->position.x = vPlanet.position.x;
    pPlanet->position.y = vPlanet.position.y;
    pPlanet->position.z = vPlanet.position.z;
    pPlanet->starIndex = vPlanet.starIndex;
    pPlanet->Unknown_E = vPlanet.Unknown_E;
    pPlanet->pSquares = vPlanet.pSquares;
    pPlanet->size = vPlanet.size;
    pPlanet->type = vPlanet.type;
    pPlanet->surfaceSquaresNum = vPlanet.surfaceSquaresNum;
    pPlanet->totalSquaresNum = vPlanet.totalSquaresNum;
    pPlanet->freeSurfaceSquaresNum = vPlanet.freeSurfaceSquaresNum;
    pPlanet->freeOrbitalSquaresNum = vPlanet.freeOrbitalSquaresNum;
    pPlanet->blackSquaresNum = vPlanet.blackSquaresNum;
    pPlanet->z5 = vPlanet.z5;
    qmemcpy(pPlanet->name, vPlanet.name, 0x1Cu);
    *(_WORD *)&pPlanet->name[0x1C] = *(_WORD *)&vPlanet.name[0x1C];
    pPlanet->word42 = vPlanet.word42;
    pPlanet->industry = vPlanet.industry;
    pPlanet->research = vPlanet.research;
    pPlanet->prosperity = vPlanet.prosperity;
    pPlanet->maximumPopulation = vPlanet.maximumPopulation;
    pPlanet->word4C = vPlanet.word4C;
    pPlanet->z6 = vPlanet.z6;
    pPlanet->buildingProgress = vPlanet.buildingProgress;
    pPlanet->_squareIndex = vPlanet._squareIndex;
    pPlanet->buildingPlanetItemIndex = vPlanet.buildingPlanetItemIndex;
    pPlanet->maximumPopulation2 = vPlanet.maximumPopulation2;
    pPlanet->raceIndex = vPlanet.raceIndex;
    pPlanet->byte58 = vPlanet.byte58;
    pPlanet->byte59 = vPlanet.byte59;
    pPlanet->z7 = vPlanet.z7;
    pPlanet->Unknown_5E = vPlanet.Unknown_5E;
    pPlanet->Unknown_62 = vPlanet.Unknown_62;
    pPlanet->flags = vPlanet.flags;
    pPlanet->dayColonized = vPlanet.dayColonized;
    pPlanet->t22 = vPlanet.t22;
    pPlanet->Unknown_77 = vPlanet.Unknown_77;
    if ( V_Game.starsNum <= pPlanet->starIndex )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x8E4);
    }
    if ( pPlanet->Unknown_E >= 5 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planet.cpp", 0x8E5);
    }
    V_Game.stars[pPlanet->starIndex].planets[pPlanet->Unknown_E] = pPlanet;
    ++V_Game.stars[pPlanet->starIndex].planetsNum;
  }
  else
  {
    Q_CFile_DosWrite_sub_1C098(pfi, pPlanet, 0x7Bu);
  }
}

//----- (000372B0) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd7PW_Ctor_sub_372B0(P_Wnd07PW pWnd7PW)
{
  Q_A2Ctor_sub_2C830(&pWnd7PW->a);
  pWnd7PW->a.pProcs = &Wnd7PW_Procs;
  Q_Wnd7PW_Init_sub_37310(pWnd7PW);
}

//----- (000372CC) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd7PW_Dtor_sub_372CC(P_Wnd07PW a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd7PW);
    operator delete[](v3);
  }
  else
  {
    a1->a.pProcs = &Wnd7PW_Procs;
    Q_A2Dtor_sub_2C848(&a1->a, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00037310) --------------------------------------------------------
void __fastcall Q_Wnd7PW_Init_sub_37310(P_Wnd07PW pWnd7PW)
{
  P_Wnd07PW v1; // kr00_4
  WORD Unknown_AE; // ax
  int i; // ebx
  char filename[64]; // [esp+0h] [ebp-40h] BYREF

  v1 = pWnd7PW;
  pWnd7PW->Unknown_AB = -1;
  pWnd7PW->Unknown_AE = -1;
  Unknown_AE = pWnd7PW->Unknown_AE;
  v1->Unknown_18B = 5;
  v1->Unknown_B0 = Unknown_AE;
  v1->Unknown_AC = Unknown_AE;
  for ( i = 0; i < 11; ++i )
  {
    sprintf(filename, "data\\planal%02d.shp", i);
    v1->planalShpCacheIndex[i] = Q_Cache_AddFile_sub_1ADAC(&WinMgr.cache, filename);
  }
}

//----- (00037380) --------------------------------------------------------
int __fastcall sub_37380(int a1, int a2)
{
  return (__int16)((0x11 * a1 + 0x22 * a2 - 0x29D6) / 0x484) | (((0x11 * a1 - 0x22 * a2 - 0xC9E) / (int)0xFFFFFB7C) << 0x10);
}

//----- (000373E0) --------------------------------------------------------
int __fastcall sub_373E0(int a1, int a2)
{
  int v3; // eax

  if ( a1 > 0xD && a1 < 0x99 && a2 > 0x77 && a2 < 0x1D5 )
  {
    return (a2 - 0x77) / 0x46 + V_Game.pCurPlanet->surfaceSquaresNum + 5 * ((a1 - 0xD) / 0x46);
  }
  v3 = sub_37380(a1, a2);
  return (unsigned __int16)Q_Planet_GetSquareIndex_sub_35968(V_Game.pCurPlanet, v3 >> 0x10, (__int16)v3);
}

//----- (0003745C) --------------------------------------------------------
int __fastcall sub_3745C(T_Type5 *a1, unsigned __int8 *edx0, int a3, int a4)
{
  LONG v5; // eax
  T_Wnd07PW *Wnd_sub_56DA8; // eax
  LONG v7; // ebp
  unsigned __int16 v8; // bx
  void *ShapeTable_sub_1B084; // eax
  void *v10; // eax
  char *name; // ecx
  T_Rect *p_rect; // esi
  LONG v14; // [esp-20h] [ebp-40h]
  LONG v15; // [esp-18h] [ebp-38h]
  int v16; // [esp+0h] [ebp-20h] BYREF
  LONG hotY; // [esp+4h] [ebp-1Ch] BYREF
  LONG shape_number; // [esp+8h] [ebp-18h] BYREF
  UWORD pCacheIndex[2]; // [esp+Ch] [ebp-14h] BYREF
  UBYTE a2; // [esp+10h] [ebp-10h]

  v5 = 0xF2;
  if ( a4 )
  {
    v5 = 0x96;
  }
  VFX_pane_wipe((PANE *)a1, v5);
  a2 = *edx0;
  if ( a2 != 0xFF )
  {
    Wnd_sub_56DA8 = (T_Wnd07PW *)Q_FindWnd_sub_56DA8(&WinMgr, "PLANETALLOC", 0);
    sub_39390(Wnd_sub_56DA8, a2, pCacheIndex, (UWORD *)&shape_number);
    v7 = (LONG)sub_10000;
    if ( a2 == 0x17 )
    {
      v7 = 0x8000;
    }
    v8 = shape_number;
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
    Q_GSYSTEM_CPP_sub_2BC40((PANE *)a1, ShapeTable_sub_1B084, v8, &v16, &hotY);
    v15 = hotY;
    v14 = (unsigned __int16)shape_number;
    v10 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
    VFX_shape_transform((PANE *)a1, v10, v14, 0x28, v15, V_BigBuffer, 0, v7, v7, 0);
  }
  name = V_PlanetItems.item[*edx0].name;
  WinMgr.LargeFont.pane.window = &a1->a->window;
  p_rect = &a1->rect;
  WinMgr.LargeFont.pane.x0 = p_rect->x1;
  p_rect = (T_Rect *)((char *)p_rect + 4);
  WinMgr.LargeFont.pane.y0 = p_rect->x1;
  p_rect = (T_Rect *)((char *)p_rect + 4);
  WinMgr.LargeFont.pane.x1 = p_rect->x1;
  WinMgr.LargeFont.pane.y1 = p_rect->y1;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x50, 0, name, 1, 0xFFFF, 0xFF, 0);
}
// 10000: using guessed type void __noreturn sub_10000();
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00037568) --------------------------------------------------------
int __fastcall Q_Wnd7PW_Proc3_sub_37568(P_Wnd07PW pWnd7PW, UWORD message, int param1, int param2)
{
  T_Wnd10LB *pWnd10LB; // ecx
  P_Wnd14PSW pWnd14PSW; // eax
  P_Wnd14PSW v6; // edi
  char *v7; // ebx
  P_Wnd07PW v9; // eax
  P_Procs v10; // ebx
  int j; // kr10_4
  P_Wnd07PW v12; // eax
  P_Wnd07PW v13; // edx
  int Unknown_35; // edx
  P_Wnd07PW v15; // edx
  int Unknown_AC; // edx
  T_Planet *v17; // eax
  T_Planet *v18; // eax
  T_Planet *pCurPlanet; // eax
  P_Wnd07PW v20; // edx
  UBYTE Unknown_AB; // ch
  unsigned __int8 v22; // dh
  P_Ship v23; // esi
  int GizmoHullCellIndex_sub_4937C; // eax
  T_Star *v25; // edi
  P_Planet v26; // ebx
  char *sub_1CEA8; // eax
  P_Planet v28; // edx
  UBYTE raceIndex; // cl
  int v30; // edi
  int v31; // ecx
  WORD v32; // dx
  int v33; // esi
  int PlanetsNum_sub_402E0; // eax
  char *v35; // ebx
  int v36; // eax
  char *v37; // eax
  P_Wnd20HW v38; // edi
  P_Wnd20HW v39; // edi
  MACRO_VFX_BOOL v40; // eax
  unsigned __int8 v41; // al
  unsigned __int16 Unknown_AE; // bx
  P_Wnd07PW v43; // eax
  int Unknown_B0; // eax
  LONG v45; // ebx
  P_Procs pProcs; // esi
  P_Wnd10LB v47; // eax
  P_Wnd07PW v48; // edi
  P_Wnd07PW v49; // esi
  BYTE *Unknown_B2; // edi
  T_Wnd10LB *v51; // eax
  int v52; // esi
  T_Ship *v53; // ecx
  P_Wnd08SW pWnd8SW; // edi
  T_Ship *ShipAtSquare_sub_35A70; // eax
  char *v56; // [esp-8h] [ebp-120h]
  int v57; // [esp-4h] [ebp-11Ch]
  char v58[200]; // [esp+0h] [ebp-118h] BYREF
  int s[7]; // [esp+C8h] [ebp-50h] BYREF
  _DWORD v60[5]; // [esp+E4h] [ebp-34h]
  int v61; // [esp+F8h] [ebp-20h]
  P_Wnd20HW a1; // [esp+FCh] [ebp-1Ch]
  int param2a; // [esp+100h] [ebp-18h]
  P_Wnd10LB pWnd10LB_; // [esp+104h] [ebp-14h]
  int param1a; // [esp+108h] [ebp-10h]
  int i; // [esp+10Ch] [ebp-Ch]
  P_Wnd07PW pWnd7PW_; // [esp+110h] [ebp-8h]
  UWORD v68; // [esp+114h] [ebp-4h]

  pWnd7PW_ = pWnd7PW;
  v68 = message;
  param1a = param1;
  param2a = param2;
  pWnd10LB = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0);
  pWnd10LB_ = pWnd10LB;
  pWnd14PSW = (P_Wnd14PSW)Q_FindWnd_sub_56DA8(&WinMgr, "PLSQUARE", 0);
  v6 = pWnd14PSW;
  if ( message >= 7u )
  {
    if ( v68 <= 7u )
    {
      sub_56728(&WinMgr, pWnd7PW_->a.a1.index, 4, 8, 0, 0);
      if ( (pWnd7PW_->a.a1._mouseFocus & pWnd7PW_->a.a1.Unknown_35 & pWnd7PW_->a.a1.Unknown_39) == 0xFFFFFFFF )
      {
        pWnd7PW_->a.pProcs->proc5((P_Wnd)pWnd7PW_, 0);
      }
      return 0xFFFFFFFF;
    }
    if ( v68 >= 0x33u )
    {
      if ( message > 0x33u )
      {
        if ( v68 < 0x1C01u )
        {
          if ( v68 != 0x34 )
          {
            return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->a, v68, param1a, param2a);
          }
          v52 = 0xFFFFFFFF;
          if ( param2a )
          {
            pWnd7PW_->Unknown_B0 = pWnd14PSW->squareIndex;
          }
          else
          {
            v53 = sub_40144(&V_Game.races[V_Game.pCurPlanet->raceIndex], V_Game.pCurPlanet);
            if ( !v53 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x2AD);
            }
            v52 = 0;
            Q_Planet_AssignShipToOrbitalSquare_sub_35B04(V_Game.pCurPlanet, param1a, v53);
          }
          pWnd8SW = (P_Wnd08SW)Q_FindWnd_sub_56DA8(&WinMgr, "SHIPDESSCREEN", 0);
          ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, param1a);
          sub_4DA7C(pWnd8SW, ShipAtSquare_sub_35A70, v52, 0);
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 8, 1);
          return 0;
        }
        else
        {
          v7 = (char *)pWnd7PW_ + 5 * param1a;
          if ( v68 <= 0x1C01u )
          {
            v41 = v7[0xB2];
            Unknown_AE = pWnd7PW_->Unknown_AE;
            pWnd7PW_->Unknown_AB = v41;
            if ( Unknown_AE == 0xFFFF )
            {
              if ( v41 != 0xFF && (V_PlanetItems.item[v41].flags & 2) != 0 )
              {
                Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, 0xFFFFu, v41, 2u);
                pWnd7PW_->Unknown_AB = 0xFF;
              }
            }
            else if ( v41 != 0xFF )
            {
              if ( Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, pWnd7PW_->Unknown_AB, Unknown_AE) == 0xFFFFFFFF )
              {
                if ( pWnd7PW_->Unknown_AB == 0x17 )
                {
                  pWnd7PW_->Unknown_B0 = pWnd7PW_->Unknown_AE;
                }
                Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd7PW_->Unknown_AE, pWnd7PW_->Unknown_AB, 2u);
              }
              v43 = pWnd7PW_;
              pWnd7PW_->Unknown_AB = 0xFF;
              v43->Unknown_AC = 0xFFFF;
              pWnd7PW_->Unknown_AE = v43->Unknown_AC;
            }
            Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB_->a.a1.index, 2, 0, 0);
            Unknown_B0 = (unsigned __int16)pWnd7PW_->Unknown_B0;
            if ( (unsigned __int16)Unknown_B0 == 0xFFFF )
            {
              pWnd7PW_->a.pProcs->proc4_draw((P_Wnd)pWnd7PW_, 0);
            }
            else
            {
              pWnd7PW_->a.pProcs->proc3((P_WndA2)pWnd7PW_, 0x34, Unknown_B0, 0);
            }
            return 0;
          }
          else
          {
            if ( v68 != 0x1C02 )
            {
              return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->a, v68, param1a, param2a);
            }
            v45 = (unsigned __int8)v7[0xB2];
            if ( v45 != 0xFF )
            {
              Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, v45, 5);
            }
            return 0xFFFFFFFF;
          }
        }
      }
      if ( V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
      {
        if ( param1a == 1 )
        {
          pWnd7PW_->Unknown_AE = 0xFFFF;
        }
        v47 = pWnd10LB_;
        v48 = pWnd7PW_;
        pWnd10LB_->Unknown_AB = 0;
        v49 = pWnd7PW_;
        v47->Unknown_8C9 = 0x4B;
        v47->Unknown_C6 = 0xF2;
        Q_Wnd10LB_SetProc1_sub_2F1C8(v47, sub_3745C);
        v61 = 0;
        Unknown_B2 = v48->Unknown_B2;
        sub_2ED4C(pWnd10LB_);
        for ( i = 0; i < 0x27; ++i )
        {
          if ( (_BYTE)i != 5 && Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, i, pWnd7PW_->Unknown_AE) )
          {
            v51 = pWnd10LB_;
            v49->Unknown_B2[0] = i;
            *(_DWORD *)&v49->Unknown_B2[1] = 0;
            Q_Wnd10LB_AddItem_sub_2EA8C(v51, Unknown_B2, 0xFFFFFFFF, 0);
            v49 = (P_Wnd07PW)((char *)v49 + 5);
            Unknown_B2 += 5;
            ++v61;
          }
        }
        if ( v61 )
        {
          sub_2D258(&pWnd7PW_->a, 6);
          Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB_->a.a1.index, 1, 0, 0);
        }
      }
LABEL_147:
      pWnd7PW_->a.pProcs->proc4_draw((P_Wnd)pWnd7PW_, 0);
      return 0;
    }
    if ( v68 <= 8u )
    {
      if ( !pWnd10LB->a.a1.Unknown_35 && !pWnd14PSW->a.a1.Unknown_35 )
      {
        v15 = pWnd7PW_;
        pWnd7PW_->Unknown_AC = sub_373E0(param1a, param2a);
        if ( V_Game.pCurPlanet->raceIndex != V_PlayerRaceIndex
          && v15->Unknown_AB != 5
          && (unsigned __int16)pWnd7PW_->Unknown_AC != 0xFFFF
          && (V_Game.pCurPlanet->pSquares[(unsigned __int16)pWnd7PW_->Unknown_AC].planetItemIndex != 0x17
           || Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, pWnd7PW_->Unknown_AC)->raceIndex != V_PlayerRaceIndex) )
        {
          pWnd7PW_->Unknown_AC = 0xFFFF;
        }
        Unknown_AC = (unsigned __int16)pWnd7PW_->Unknown_AC;
        if ( (unsigned __int16)Unknown_AC != 0xFFFF
          && V_Game.pCurPlanet->pSquares[Unknown_AC].planetItemIndex == 0x17
          && Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, Unknown_AC)->raceIndex != V_PlayerRaceIndex )
        {
          pWnd7PW_->Unknown_AC = 0xFFFF;
        }
        goto LABEL_147;
      }
    }
    else
    {
      if ( v68 != 0x32 )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->a, v68, param1a, param2a);
      }
      pWnd7PW_->Unknown_AC = 0xFFFF;
      if ( param1a == 0xA || param1a == 0xB )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.a1.index, 2, 0, 0);
        ((void (*)(void))pWnd7PW_->a.pProcs->proc3)();
        return 0;
      }
      if ( param1a == 0xC )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.a1.index, 2, 0, 0);
        pProcs = pWnd7PW_->a.pProcs;
        pWnd7PW_->Unknown_AB = 5;
        ((void (*)(void))pProcs->proc3)();
        return 0;
      }
      if ( param1a == 4
        || V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex
        || (unsigned __int16)pWnd7PW_->Unknown_AE != 0xFFFF
        && V_Game.pCurPlanet->pSquares[(unsigned __int16)pWnd7PW_->Unknown_AE].planetItemIndex == 0x17
        && Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, pWnd7PW_->Unknown_AE)->raceIndex == V_PlayerRaceIndex )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v6->a.a1.index, 0x32, param1a, (unsigned __int16)pWnd7PW_->Unknown_AE);
        sub_2D258(&pWnd7PW_->a, 6);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v6->a.a1.index, 1, 0, 0);
        pWnd7PW_->a.pProcs->proc4_draw((P_Wnd)pWnd7PW_, 0);
        return 0;
      }
    }
    return 0;
  }
  if ( v68 < 4u )
  {
    if ( !v68 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->a, v68, param1a, param2a);
    }
    if ( message > 1u )
    {
      if ( v68 != 3 )
      {
        return Q_WndA2_Proc3_sub_2F424(&pWnd7PW_->a, v68, param1a, param2a);
      }
      if ( (unsigned int)param2a < 0x17 )
      {
        if ( (unsigned int)param2a < 0x13 )
        {
          if ( param2a == 1 )
          {
            if ( pWnd10LB->a.a1.Unknown_35 )
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB->a.a1.index, 2, 0, 0);
            }
            else if ( pWnd14PSW->a.a1.Unknown_35 )
            {
              Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.a1.index, 2, 0, pWnd10LB->a.a1.Unknown_35);
            }
            else
            {
              Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
            }
          }
        }
        else if ( (unsigned int)param2a <= 0x13 )
        {
          if ( V_NougatLfExists_dword_A0CFC )
          {
            if ( V_Game.pCurPlanet->raceIndex == 0xFF )
            {
              V_Game.pCurPlanet->raceIndex = V_PlayerRaceIndex;
            }
            else
            {
              Q_Star_ChangePlanetOwnership_sub_1D234(&V_Game.stars[V_Game.pCurPlanet->starIndex], V_Game.pCurPlanet, V_PlayerRaceIndex);
            }
          }
        }
        else if ( param2a == 0x14 && V_NougatLfExists_dword_A0CFC )
        {
          pCurPlanet = V_Game.pCurPlanet;
          V_Game.pCurPlanet->word42 += 2;
          Q_Planet_BuildAtOptimalLocation_sub_34AE4(pCurPlanet, 5u, 0xFFFFFFFF);
        }
      }
      else if ( (unsigned int)param2a <= 0x17 )
      {
        if ( V_NougatLfExists_dword_A0CFC )
        {
          v17 = V_Game.pCurPlanet;
          V_Game.pCurPlanet->buildingProgress += 0xC8;
          sub_352E0(v17);
        }
      }
      else if ( (unsigned int)param2a < 0x1F )
      {
        if ( param2a == 0x18 && V_NougatLfExists_dword_A0CFC )
        {
          V_Game.pCurPlanet->word42 = V_Game.pCurPlanet->maximumPopulation;
        }
      }
      else if ( (unsigned int)param2a <= 0x1F )
      {
        pWnd7PW_->Unknown_18B ^= 1u;
      }
      else if ( (unsigned int)param2a >= 0x31 )
      {
        if ( (unsigned int)param2a <= 0x31 )
        {
          if ( V_NougatLfExists_dword_A0CFC )
          {
            sub_352E0(V_Game.pCurPlanet);
          }
        }
        else if ( param2a == 0x32 )
        {
          if ( V_Keyboard.Shift )
          {
            if ( V_NougatLfExists_dword_A0CFC )
            {
              v18 = V_Game.pCurPlanet;
              ++V_Game.pCurPlanet->maximumPopulation2;
              Q_Planet_CalcPoints_sub_34E70(v18);
            }
          }
          else
          {
            V_Game.pCurPlanet->z7 = ~V_Game.pCurPlanet->z7;
          }
        }
      }
      goto LABEL_147;
    }
    v60[0] = off_96850[0];
    v60[1] = off_96850[1];
    v60[2] = off_96850[2];
    v60[3] = off_96850[3];
    v60[4] = off_96850[4];
    for ( j = 0; j != 5; ++j )
    {
      sub_56D70(&WinMgr, (char *)v60[j], v68, param1a, param2a);
    }
    v12 = pWnd7PW_;
    pWnd7PW_->a.a1.Unknown_35 = 0xFFFFFFFF;
    v12->a.a1.Unknown_39 = 0xFFFFFFFF;
    v12->Unknown_AB = 0xFF;
    v12->Unknown_AC = 0xFFFF;
    v13 = pWnd7PW_;
    pWnd7PW_->Unknown_AE = v12->Unknown_AC;
    if ( (unsigned __int16)v13->Unknown_B0 != 0xFFFF )
    {
      sub_394BC(v13);
    }
    pWnd7PW_->a.pProcs->proc4_draw((P_Wnd)pWnd7PW_, 0);
    if ( dword_10467C )
    {
      sub_557D4(&WinMgr, dword_104680, dword_10467C, 0x14);
      dword_10467C = 0;
    }
    return 0;
  }
  if ( message > 4u )
  {
    if ( v68 <= 5u )
    {
      v9 = pWnd7PW_;
      pWnd7PW_->Unknown_AB = 0xFF;
      v10 = v9->a.pProcs;
      v9->Unknown_AE = 0xFFFF;
      ((void (*)(void))v10->proc4_draw)();
      return 0xFFFFFFFF;
    }
    else
    {
      sub_567BC(&WinMgr, pWnd7PW_->a.a1.index, 8);
      if ( (pWnd7PW_->a.a1._mouseFocus & pWnd7PW_->a.a1.Unknown_35 & pWnd7PW_->a.a1.Unknown_39) == 0xFFFFFFFF )
      {
        pWnd7PW_->a.pProcs->proc4_draw((P_Wnd)pWnd7PW_, 0);
      }
      return 0xFFFFFFFF;
    }
  }
  Unknown_35 = pWnd7PW_->a.a1.Unknown_35;
  if ( !Unknown_35 )
  {
    return Unknown_35;
  }
  if ( pWnd10LB->a.a1.Unknown_35 )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd10LB->a.a1.index, 2, 0, 0);
  }
  else if ( pWnd14PSW->a.a1.Unknown_35 )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, pWnd14PSW->a.a1.index, 2, 0, pWnd10LB->a.a1.Unknown_35);
  }
  else
  {
    v20 = pWnd7PW_;
    pWnd7PW_->Unknown_AE = pWnd7PW_->Unknown_AC;
    if ( (unsigned __int16)v20->Unknown_AE == 0xFFFF )
    {
      if ( v20->Unknown_AB != (BYTE)0xFF )
      {
        v20->Unknown_AB = 0xFF;
      }
    }
    else
    {
      if ( (__int16)v20->a.a1.Unknown_59 != 0xFFFFFFFF )
      {
        Q_StartSample_sub_4FB90(&V_SoundSystem, v20->a.a1.Unknown_59);
      }
      Unknown_AB = pWnd7PW_->Unknown_AB;
      if ( Unknown_AB == 0xFF )
      {
        pWnd7PW_->a.pProcs->proc3(&pWnd7PW_->a, 0x32u, 3, 0);
        return 0;
      }
      if ( Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, Unknown_AB, pWnd7PW_->Unknown_AE) )
      {
        v22 = pWnd7PW_->Unknown_AB;
        if ( v22 == 5 )
        {
          v23 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, v6->squareIndex);
          GizmoHullCellIndex_sub_4937C = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v23, ASCEND_GIZMO_71_COLONIZER);
          Q_Ship_RemoveGizmoFromCell_sub_492F8(v23, GizmoHullCellIndex_sub_4937C);
          v25 = &V_Game.stars[V_Game.pCurPlanet->starIndex];
          if ( V_Game.pCurPlanet->raceIndex != 0xFF )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x1C6);
          }
          v26 = V_Game.pCurPlanet;
          sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1F);// 31: "Name Your Colony"
          sub_557D4(&WinMgr, sub_1CEA8, v26->name, 0x14);
          v28 = V_Game.pCurPlanet;
          raceIndex = v23->raceIndex;
          V_Game.pCurPlanet->raceIndex = raceIndex;
          v25->racesBits |= 1 << raceIndex;
          v28->word42 = 2;
          v28->dayColonized = V_Game.day;
          v30 = 0;
          Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd7PW_->Unknown_AE, pWnd7PW_->Unknown_AB, 0);
          v31 = 0xFFFFFFFF;
          memset(s, 0, sizeof(s));
          if ( V_Game.racesNum > 0 )
          {
            v32 = 0;
            do
            {
              v33 = v32;
              if ( !V_Game.races[v33].Unknown_03 )
              {
                PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[v33]);
                s[v32] = PlanetsNum_sub_402E0;
                if ( v30 < PlanetsNum_sub_402E0 && (v32 == V_PlayerRaceIndex || V_Game.races[V_PlayerRaceIndex].treaties[v32]) )
                {
                  v31 = v32;
                  v30 = s[v32];
                }
              }
              ++v32;
            }
            while ( v32 < V_Game.racesNum );
          }
          if ( v31 < 0 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x1E9);
          }
          a1 = (P_Wnd20HW)Q_FindWnd_sub_56DA8(&WinMgr, "HELPWINDOW", 0);
          v35 = "colonize";
          if ( v31 == V_PlayerRaceIndex )
          {
            v35 = "maxcolonize";
          }
          Q_ShowHelpTopic_sub_2FCB0(a1, "help.txt", v35);
          v57 = s[v31];
          v56 = V_SpecNames[V_Game.races[v31]._nameIndex];
          if ( s[V_PlayerRaceIndex] == 1 )
          {
            v36 = 0x20;                                // 32: "y"
          }
          else
          {
            v36 = 0x21;                                // 33: "ies"
          }
          v37 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v36);
          v38 = a1;
          sprintf(
            v58,
            *(const char **)&a1->Unknown_C95[5],
            V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex],
            s[V_PlayerRaceIndex],
            v37,
            v56,
            v57);
          strcpy(*(char **)&v38->Unknown_C95[5], v58);
          *(_WORD *)&a1->Unknown_C91[0].Unknown_04[1] = 0x1D;
          *(_WORD *)&a1->Unknown_C91[0].Unknown_04[3] = V_Game.pCurPlanet->size + 5 * V_Game.pCurPlanet->type;
          v39 = a1;
          sprintf(v58, *(const char **)&a1->Unknown_C91[1].Unknown_04[5], V_Game.pCurPlanet->name);
          strcpy(*(char **)&v39->Unknown_C91[1].Unknown_04[5], v58);
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, 0, 0);
          pWnd7PW_->Unknown_AB = 0xFF;
        }
        else
        {
          v40 = Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd7PW_->Unknown_AE, v22, 2u);
          if ( pWnd7PW_->Unknown_AB == 0x17 && v40 == 0xFFFFFFFF )
          {
            pWnd7PW_->Unknown_B0 = pWnd7PW_->Unknown_AE;
          }
          pWnd7PW_->Unknown_AB = 0xFF;
        }
      }
    }
  }
  ((void (*)(void))pWnd7PW_->a.pProcs->proc3)();
  return 0;
}
// 37B38: conditional instruction was optimized away because ch.1!=FF
// 96850: using guessed type char *off_96850[5];
// 37568: using guessed type int s[7];
// 37568: using guessed type char var_118[200];

//----- (000384B0) --------------------------------------------------------
void __fastcall Q_Wnd7PW_Proc4_sub_384B0(P_Wnd07PW pWnd7PW)
{
  UWORD type; // ax
  void *ShapeTable_sub_1B084; // eax
  void *v4; // eax
  void *v5; // eax
  BYTE Unknown_AB; // ah
  int Unknown_AC; // ebx
  MACRO_VFX_BOOL v8; // eax
  P_Square pSquares; // edx
  LONG v10; // kr18_4
  int v11; // kr08_4
  int v12; // kr20_4
  int v13; // kr30_4
  unsigned __int16 v14; // di
  int v15; // eax
  LONG v16; // ebx
  LONG v17; // ecx
  int v18; // eax
  T_HazeTables *hazeTables; // edx
  T_HazeTables *v20; // eax
  int v21; // eax
  LONG v22; // edx
  LONG v23; // ebx
  int v24; // eax
  int n; // esi
  int v26; // eax
  LONG v27; // edi
  LONG v28; // edx
  int v29; // eax
  unsigned __int16 v30; // di
  void *v31; // esi
  int v32; // esi
  unsigned __int8 v33; // al
  void *v34; // eax
  int v35; // eax
  MACRO_VFX_BOOL v36; // eax
  UBYTE raceIndex; // dl
  int v38; // kr28_4
  int v39; // kr10_4
  LONG v40; // esi
  int v41; // edx
  T_Square *v42; // edx
  unsigned __int16 planetItemIndex; // si
  int v44; // eax
  LONG v45; // esi
  int v46; // ecx
  int v47; // edi
  unsigned __int8 v48; // al
  void *v49; // eax
  BOOL v50; // edi
  void *v51; // eax
  int i; // kr04_4
  int j; // kr0C_4
  int k; // esi
  int m; // esi
  int ii; // kr14_4
  void *v57; // [esp-24h] [ebp-3B8h]
  void *v58; // [esp-24h] [ebp-3B8h]
  LONG v59; // [esp-20h] [ebp-3B4h]
  LONG v60; // [esp-20h] [ebp-3B4h]
  LONG v61; // [esp-20h] [ebp-3B4h]
  LONG v62; // [esp-1Ch] [ebp-3B0h]
  LONG v63; // [esp-1Ch] [ebp-3B0h]
  LONG v64; // [esp-1Ch] [ebp-3B0h]
  LONG v65; // [esp-18h] [ebp-3ACh]
  LONG v66; // [esp-18h] [ebp-3ACh]
  LONG v67; // [esp-18h] [ebp-3ACh]
  LONG shapeFrame; // [esp-Ch] [ebp-3A0h]
  LONG v69; // [esp-Ch] [ebp-3A0h]
  LONG v70; // [esp-8h] [ebp-39Ch]
  LONG y; // [esp-4h] [ebp-398h]
  UBYTE v72[256]; // [esp+0h] [ebp-394h] BYREF
  UBYTE s[256]; // [esp+100h] [ebp-294h] BYREF
  SCRNVERTEX x0; // [esp+200h] [ebp-194h] BYREF
  int v75; // [esp+218h] [ebp-17Ch]
  int v76; // [esp+21Ch] [ebp-178h]
  LONG v77; // [esp+230h] [ebp-164h]
  int v78; // [esp+234h] [ebp-160h]
  int v79; // [esp+248h] [ebp-14Ch]
  int v80; // [esp+24Ch] [ebp-148h]
  SCRNVERTEX x1; // [esp+260h] [ebp-134h] BYREF
  int v82; // [esp+278h] [ebp-11Ch]
  int v83; // [esp+27Ch] [ebp-118h]
  int v84; // [esp+280h] [ebp-114h]
  LONG x; // [esp+290h] [ebp-104h]
  int v86; // [esp+294h] [ebp-100h]
  int v87; // [esp+298h] [ebp-FCh]
  int v88; // [esp+2A8h] [ebp-ECh]
  int v89; // [esp+2ACh] [ebp-E8h]
  int v90; // [esp+2B0h] [ebp-E4h]
  PANE v91; // [esp+2C0h] [ebp-D4h] BYREF
  PANE pane; // [esp+2D4h] [ebp-C0h] BYREF
  PANE v93; // [esp+2E8h] [ebp-ACh] BYREF
  PANE v94; // [esp+2FCh] [ebp-98h] BYREF
  int v95; // [esp+310h] [ebp-84h]
  int v96; // [esp+314h] [ebp-80h]
  int v97; // [esp+318h] [ebp-7Ch]
  int v98; // [esp+31Ch] [ebp-78h]
  int v99; // [esp+320h] [ebp-74h]
  LONG v100; // [esp+324h] [ebp-70h]
  int v101; // [esp+328h] [ebp-6Ch]
  void *shape_table; // [esp+32Ch] [ebp-68h]
  unsigned __int16 a2[2]; // [esp+330h] [ebp-64h]
  int v104; // [esp+334h] [ebp-60h]
  int v105; // [esp+338h] [ebp-5Ch]
  int v106; // [esp+33Ch] [ebp-58h]
  LONG shape_number; // [esp+340h] [ebp-54h]
  int v108; // [esp+344h] [ebp-50h]
  LONG v109; // [esp+348h] [ebp-4Ch]
  P_Square v110; // [esp+34Ch] [ebp-48h]
  int v111; // [esp+350h] [ebp-44h]
  int v112; // [esp+354h] [ebp-40h]
  int v113; // [esp+358h] [ebp-3Ch]
  LONG hotX; // [esp+35Ch] [ebp-38h]
  int v115; // [esp+360h] [ebp-34h]
  int v116; // [esp+364h] [ebp-30h]
  UWORD pCacheIndex[2]; // [esp+368h] [ebp-2Ch] BYREF
  MACRO_VFX_BOOL v118; // [esp+36Ch] [ebp-28h]
  UWORD index[2]; // [esp+370h] [ebp-24h]
  int v120; // [esp+374h] [ebp-20h]
  LONG v121; // [esp+378h] [ebp-1Ch] BYREF
  char v122; // [esp+37Ch] [ebp-18h]

  shape_number = V_Game.pCurPlanet->size;
  type = V_Game.pCurPlanet->type;
  *(_DWORD *)index = GwshareShpCacheIndexes[44];
  *(_DWORD *)&type = type;
  type = pWnd7PW->planalShpCacheIndex[type];
  *(_DWORD *)pCacheIndex = *(_DWORD *)&type;
  if ( pWnd7PW->a.a1.shapeFrame != 0xFFFFFFFF )
  {
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index[0]);
    VFX_shape_draw(&pWnd7PW->a.a1.pane, ShapeTable_sub_1B084, 4, 7, 0x73);
    if ( (pWnd7PW->Unknown_18B & 4) != 0 )
    {
      v4 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
      VFX_shape_draw(&pWnd7PW->a.a1.pane, v4, shape_number, 0x198, 0x128);
    }
    shapeFrame = pWnd7PW->a.a1.shapeFrame;
    v5 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index[0]);
    VFX_shape_draw(&pWnd7PW->a.a1.pane, v5, shapeFrame, 0, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pWnd7PW->a.a1.pane);
  }
  v94 = pWnd7PW->a.a1.pane;
  Unknown_AB = pWnd7PW->Unknown_AB;
  v118 = 0xFFFF;
  if ( Unknown_AB != (BYTE)0xFF )
  {
    v118 = 0xFFFE;
    Unknown_AC = (unsigned __int16)pWnd7PW->Unknown_AC;
    if ( (unsigned __int16)Unknown_AC != 0xFFFF && V_Game.pCurPlanet->pSquares[Unknown_AC].planetItemIndex == 0xFF )
    {
      v8 = Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, pWnd7PW->Unknown_AB, Unknown_AC);
      if ( v8 )
      {
        LOWORD(v8) = pWnd7PW->Unknown_AC;
        v118 = v8;
      }
    }
  }
  pSquares = V_Game.pCurPlanet->pSquares;
  v121 = 0xFFFF;
  v110 = pSquares;
  LOBYTE(pSquares) = V_Game.pCurPlanet->raceIndex;
  *(_DWORD *)a2 = 0;
  if ( (_BYTE)pSquares == V_PlayerRaceIndex || Q_Planet_GetSquareWithItem_sub_35930(V_Game.pCurPlanet, 0xBu) == 0xFFFF )
  {
    v112 = 0x6E;
    v99 = 0x19A;
    v113 = 0xF * shape_number;
    v10 = shape_number;
    for ( i = 0; i != 0xF; ++i )
    {
      v13 = (int)v110;
      v12 = *(_DWORD *)a2;
      v97 = V_PlanetCfg.offsets.sizes[v10].column[i];
      v11 = v97;
      v106 = v99;
      v101 = v10 * 0xF + i;
      v111 = 0x11 * i + 0x6E;
      for ( j = 0; V_PlanetCfg.offsets.sizes[0].column[v101] + V_PlanetCfg.squares.sizes[0].column[v101] > v11 + j; ++j )
      {
        x1.x = 0x22 * (v11 + j) + v106;
        v82 = x1.x + 0x22;
        x = x1.x;
        v88 = x1.x - 0x22;
        x1.y = 0x11 * (v11 + j) + v111;
        v83 = x1.y + 0x11;
        v86 = x1.y + 0x22;
        v89 = x1.y + 0x11;
        v90 = 0x960000;
        v87 = 0x960000;
        v84 = 0x960000;
        x1.c = 0x960000;
        HIWORD(v35) = HIWORD(v110);
        v122 = *(_BYTE *)(v13 + 4 * j + 1);
        LOWORD(v35) = *(unsigned __int8 *)(v13 + 4 * j);
        v120 = v35;
        v95 = dword_96864[0];
        v96 = dword_96864[1];
        v36 = Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, 0xFFu, a2[0]);
        if ( (unsigned __int16)pWnd7PW->Unknown_AC == v12 + j
          && pWnd7PW->Unknown_AB == (BYTE)0xFF
          && v122 == (char)0xFF
          && v36 == 0xFFFFFFFF )
        {
          VFX_flat_polygon(&V_Type6_stru_D8654.pane, 4, &x1);
          goto LABEL_34;
        }
        if ( (pWnd7PW->Unknown_18B & 1) != 0 )
        {
          v14 = 0xC;
          v116 = 0xD;
          if ( !(_WORD)v120 )
          {
            v116 = 7;
            v14 = 0;
          }
          switch ( (unsigned __int16)v120 )
          {
            case 2u:
              v14 = 0x75;
              v116 = 8;
              break;
            case 3u:
              v14 = 0x92;
              v116 = 9;
              break;
            case 4u:
              v14 = 0xFF;
              v116 = 0xA;
              break;
          }
          if ( v36 == 0xFFFFFFFF )
          {
            x0.x = x1.x;
            x0.y = x1.y + 1;
            v75 = v82 - 2;
            v76 = v83;
            v77 = x;
            v78 = v86 - 1;
            v79 = v88 + 2;
            v80 = v89;
            for ( k = 0; k < 4; ++k )
            {
              v15 = 0x18 * *((char *)&v96 + k);
              v16 = *(LONG *)((char *)&x0.y + v15);
              v17 = *(LONG *)((char *)&x0.x + v15);
              v18 = 0x18 * *((char *)&v95 + k);
              VFX_line_draw(&V_Type6_stru_D8654.pane, *(LONG *)((char *)&x0.x + v18), *(LONG *)((char *)&x0.y + v18), v17, v16, 0, v14);
            }
            if ( (_WORD)v116 )
            {
              hazeTables = V_Type6_stru_D8654.hazeTables;
              v20 = (T_HazeTables *)((unsigned __int16)v116 << 8);
LABEL_33:
              VFX_translate_polygon(&V_Type6_stru_D8654.pane, 4, &x0, (char *)v20 + (_DWORD)hazeTables);
            }
          }
          else
          {
            x0.x = x1.x;
            x0.y = x1.y + 0xE;
            v75 = v82 - 0x1C;
            v76 = v83;
            v77 = x;
            v78 = v86 - 0xE;
            v79 = v88 + 0x1C;
            v80 = v89;
            for ( m = 0; m < 4; ++m )
            {
              v21 = 0x18 * *((char *)&v96 + m);
              v22 = *(LONG *)((char *)&x0.y + v21);
              v23 = *(LONG *)((char *)&x0.x + v21);
              v24 = 0x18 * *((char *)&v95 + m);
              VFX_line_draw(&V_Type6_stru_D8654.pane, *(LONG *)((char *)&x0.x + v24), *(LONG *)((char *)&x0.y + v24), v23, v22, 0, v14);
            }
            if ( (_WORD)v116 )
            {
              v20 = V_Type6_stru_D8654.hazeTables;
              hazeTables = (T_HazeTables *)((unsigned __int16)v116 << 8);
              goto LABEL_33;
            }
          }
        }
LABEL_34:
        if ( (unsigned __int16)pWnd7PW->Unknown_AC == v12 + j && pWnd7PW->Unknown_AB == (BYTE)0xFF && v122 == (char)0xFF )
        {
          for ( n = 0; n < 4; ++n )
          {
            v26 = 0x18 * *((char *)&v96 + n);
            v27 = *(LONG *)((char *)&x1.y + v26);
            v28 = *(LONG *)((char *)&x1.x + v26);
            v29 = 0x18 * *((char *)&v95 + n);
            VFX_line_draw(&V_Type6_stru_D8654.pane, *(LONG *)((char *)&x1.x + v29), *(LONG *)((char *)&x1.y + v29), v28, v27, 0, 0x96);
          }
        }
        if ( v122 == (char)0xFF && (v120 & 8) == 0 )
        {
          if ( (unsigned __int16)v118 == v12 + j )
          {
            sub_39390(pWnd7PW, pWnd7PW->Unknown_AB, pCacheIndex, (UWORD *)&v121);
            y = x1.y;
            v70 = x1.x;
            v69 = (unsigned __int16)v121;
            v34 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
            VFX_shape_draw(&V_Type6_stru_D8654.pane, v34, v69, v70, y);
          }
        }
        else
        {
          v30 = a2[0];
          sub_393F4((int)pWnd7PW, a2[0], pCacheIndex, &v121);
          v31 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
          shape_table = v31;
          if ( V_Game.pCurPlanet->_squareIndex == v12 + j )
          {
            VFX_flat_polygon(&V_Type6_stru_D8654.pane, 4, &x1);
            v32 = 0x22 * V_Game.pCurPlanet->buildingProgress;
            v115 = v32 / Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, v30, 0xFFu);
            v33 = 0xF2;
            if ( (unsigned __int16)pWnd7PW->Unknown_AC == v12 + j )
            {
              v33 = 0x96;
            }
            memset(s, v33, sizeof(s));
            VFX_shape_lookaside(s);
            VFX_shape_translate_draw(&V_Type6_stru_D8654.pane, shape_table, (unsigned __int16)v121, x1.x, x1.y);
            pane = V_Type6_stru_D8654.pane;
            pane.y0 = x1.y + 0x22 - v115;
            if ( (unsigned __int16)pWnd7PW->Unknown_AC == v12 + j )
            {
              VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[0x15]);
              VFX_shape_translate_draw(&pane, shape_table, (unsigned __int16)v121, x1.x, x1.y - pane.y0);
            }
            else
            {
              VFX_shape_draw(&pane, shape_table, (unsigned __int16)v121, x1.x, x1.y - pane.y0);
            }
          }
          else if ( (unsigned __int16)pWnd7PW->Unknown_AC == v12 + j )
          {
            VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[0x15]);
            VFX_shape_translate_draw(&V_Type6_stru_D8654.pane, v31, (unsigned __int16)v121, x1.x, x1.y);
          }
          else
          {
            VFX_shape_draw(&V_Type6_stru_D8654.pane, v31, (unsigned __int16)v121, x1.x, x1.y);
          }
        }
      }
      v99 -= 0x22;
    }
  }
  v100 = 0xD;
  raceIndex = V_Game.pCurPlanet->raceIndex;
  v109 = 0x77;
  v104 = 0;
  if ( raceIndex != V_PlayerRaceIndex && Q_Planet_GetSquareWithItem_sub_35930(V_Game.pCurPlanet, 0x19u) != 0xFFFF )
  {
    v104 = 0xFFFFFFFF;
  }
  *(_DWORD *)a2 = V_Game.pCurPlanet->surfaceSquaresNum;
  v38 = *(_DWORD *)a2;
  v98 = 4 * *(_DWORD *)a2;
  v39 = *(_DWORD *)a2;
  hotX = v100 + 0x23;
  for ( ii = 0; V_Game.pCurPlanet->totalSquaresNum > v38 + ii; ++ii )
  {
    v42 = &V_Game.pCurPlanet->pSquares[ii + v39];
    v105 = 0;
    planetItemIndex = v42->planetItemIndex;
    if ( v42->planetItemIndex == 0x17 && Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a2[0])->raceIndex == V_PlayerRaceIndex )
    {
      v105 = 0xFFFFFFFF;
    }
    if ( (unsigned __int16)pWnd7PW->Unknown_AC == v38 + ii )
    {
      HIWORD(v44) = a2[1];
      LOWORD(v44) = planetItemIndex;
      if ( v44 == 0xFF && !v104 && pWnd7PW->Unknown_AB == (BYTE)0xFF )
      {
        v94.x0 = v100;
        v94.y0 = v109;
        v94.x1 = v100 + 0x46;
        v94.y1 = v109 + 0x46;
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(&v94, 1, 1, 0x45, 0x45, 0x96u, 0);
      }
    }
    v108 = planetItemIndex;
    if ( planetItemIndex == 0xFF )
    {
      if ( (unsigned __int16)v118 == v38 + ii )
      {
        v40 = (LONG)sub_10000;
        if ( pWnd7PW->Unknown_AB == 0x17 )
        {
          v40 = 0x8000;
        }
        sub_39390(pWnd7PW, pWnd7PW->Unknown_AB, pCacheIndex, (UWORD *)&v121);
        v65 = v109 + 0x23;
        v62 = hotX;
        v59 = (unsigned __int16)v121;
        v57 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
        VFX_shape_transform(&V_Type6_stru_D8654.pane, v57, v59, v62, v65, V_BigBuffer, 0, v40, v40, 0);
      }
    }
    else
    {
      sub_393F4((int)pWnd7PW, a2[0], pCacheIndex, &v121);
      v91 = pWnd7PW->a.a1.pane;
      v45 = (LONG)sub_10000;
      if ( v108 == 0x17 )
      {
        v45 = 0x8000;
      }
      if ( V_Game.pCurPlanet->_squareIndex == v38 + ii )
      {
        v46 = 0x46 * V_Game.pCurPlanet->buildingProgress;
        v47 = v46 / Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, a2[0], 0xFFu);
        v48 = 0xF2;
        if ( (unsigned __int16)pWnd7PW->Unknown_AC == v38 + ii )
        {
          v48 = 0x96;
        }
        memset(v72, v48, sizeof(v72));
        if ( !v104 || v105 == 0xFFFFFFFF )
        {
          VFX_shape_lookaside(v72);
          v66 = v109 + 0x23;
          v63 = hotX;
          v60 = (unsigned __int16)v121;
          v49 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
          VFX_shape_transform(&V_Type6_stru_D8654.pane, v49, v60, v63, v66, V_BigBuffer, 0, v45, v45, 1);
        }
        v91.y0 = v109 + 0x46 - v47;
      }
      if ( !v104 || v105 == 0xFFFFFFFF )
      {
        v50 = (unsigned __int16)pWnd7PW->Unknown_AC == v38 + ii;
        VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[0x15]);
        v67 = v109 + 0x23 - v91.y0;
        v64 = hotX;
        v61 = (unsigned __int16)v121;
        v58 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
        VFX_shape_transform(&v91, v58, v61, v64, v67, V_BigBuffer, 0, v45, v45, v50);
      }
    }
    v41 = (v38 + ii - V_Game.pCurPlanet->surfaceSquaresNum) % 5;
    v109 += 0x46;
    if ( v41 == 4 )
    {
      v109 = 0x77;
      hotX += 0x46;
      v100 += 0x46;
    }
  }
  if ( Q_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0)->a1.Unknown_35 == 0xFFFFFFFF )
  {
    v93.window = (WINDOW *)&V_Type6_stru_D8654;
    v93.x0 = 0x70;
    v93.y0 = 0x70;
    v93.y1 = 0x1AC;
    v93.x1 = 0x210;
    v51 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index[0]);
    VFX_shape_draw(&v93, v51, 5, 0, 0);
  }
  sub_2D218(pWnd7PW);
}
// 10000: using guessed type void __noreturn sub_10000();
// 96864: using guessed type _DWORD dword_96864[2];
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00039390) --------------------------------------------------------
void __fastcall sub_39390(P_Wnd07PW pWnd7PW, UBYTE a2, UWORD *pCacheIndex, UWORD *a4)
{
  if ( a2 >= 39u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x461);
  }
  *pCacheIndex = GwshareShpCacheIndexes[30];           // data\planitem.shp
  *a4 = 0;
  *a4 = a2;
  if ( a2 == 23 )
  {
    *pCacheIndex = GwshareShpCacheIndexes[V_Game.pCurPlanet->raceIndex + 14];
    *a4 = 0;
  }
}
// 393C3: conditional instruction was optimized away because dl.1<27u

//----- (000393F4) --------------------------------------------------------
__int16 __fastcall sub_393F4(int a1, unsigned __int16 a2, _WORD *a3, _WORD *a4)
{
  P_Planet pCurPlanet; // eax
  T_Square *v6; // eax
  __int16 planetItemIndex; // dx
  __int16 result; // ax
  P_Ship ShipAtSquare_sub_35A70; // esi

  if ( a2 >= V_Game.pCurPlanet->totalSquaresNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x476);
  }
  *a3 = GwshareShpCacheIndexes[0x1E];
  pCurPlanet = V_Game.pCurPlanet;
  *a4 = 0;
  v6 = &pCurPlanet->pSquares[a2];
  planetItemIndex = v6->planetItemIndex;
  if ( (unsigned __int8)planetItemIndex == 0xFF )
  {
    if ( (v6->color & 8) != 0 )
    {
      *a4 = 0x27;
    }
  }
  else
  {
    *a4 = planetItemIndex;
  }
  result = planetItemIndex;
  if ( planetItemIndex == 0x17 )
  {
    ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a2);
    *a3 = GwshareShpCacheIndexes[ShipAtSquare_sub_35A70->raceIndex + 0xE];
    if ( ShipAtSquare_sub_35A70->hullSize < 0 || ShipAtSquare_sub_35A70->hullSize >= 4 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\planwin.cpp", 0x48A);
    }
    result = ShipAtSquare_sub_35A70->hullSize;
    *a4 = result;
  }
  return result;
}

//----- (000394BC) --------------------------------------------------------
void __fastcall sub_394BC(P_Wnd07PW pWnd07PW)
{
  P_Wnd08SW pWnd08SW; // esi
  char *label; // eax
  P_Ship pShip; // edx
  int Unknown_C9; // ebp
  T_Ship *ShipAtSquare_sub_35A70; // eax
  T_Planet *pCurPlanet; // eax
  int v8; // edx
  P_Location pLocation; // eax

  pWnd08SW = (P_Wnd08SW)Q_FindWnd_sub_56DA8(&WinMgr, "SHIPDESSCREEN", 0);
  dword_10467C = pWnd08SW->pShip->name;
  label = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x22);    // 34: "Name Your Ship"
  pShip = pWnd08SW->pShip;
  dword_104680 = label;
  if ( pShip )
  {
    if ( pWnd08SW->Unknown_C9 == TRUE )
    {
      dword_104680 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x23);// 35: "Rename Your Ship?"
      pCurPlanet = V_Game.pCurPlanet;
      LOBYTE(V_Game.pCurPlanet->pSquares[(unsigned __int16)pWnd07PW->Unknown_B0].flags) &= ~1u;
      Q_Planet_HandleItemConstruction_sub_34B0C(pCurPlanet, pWnd07PW->Unknown_B0, ASCEND_PI_23_SHIP, 3u);
      v8 = sub_4EE00(pWnd08SW);
      pLocation.pPlanet = V_Game.pCurPlanet;
      V_Game.pCurPlanet->Unknown_77 = v8;
      pWnd08SW->pShip->locationType = ASCEND_LOCATION_TYPE_SHIPDOCK;
      pWnd08SW->pShip->pLocation = pLocation;
    }
  }
  else
  {
    Unknown_C9 = pWnd08SW->Unknown_C9;
    dword_10467C = 0;
    if ( !Unknown_C9 )
    {
      ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, pWnd07PW->Unknown_B0);
      Q_Ship_RemoveFromTheGame_sub_49940(ShipAtSquare_sub_35A70);
      Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, pWnd07PW->Unknown_B0, 0xFFu, 1u);
    }
  }
  pWnd07PW->Unknown_B0 = 0xFFFF;
}

//----- (000395C4) --------------------------------------------------------
void __fastcall Q_Wnd7PW_Proc6_sub_395C4(P_Wnd07PW pWnd7PW, P_CFile pfi, BOOL read)
{
  char *p_Unknown_18B; // edx

  p_Unknown_18B = &pWnd7PW->Unknown_18B;
  if ( read == TRUE )
  {
    Q_ReadFile_sub_1BF94(pfi, p_Unknown_18B, 1u);
  }
  else
  {
    Q_CFile_DosWrite_sub_1C098(pfi, p_Unknown_18B, 1u);
  }
}

//----- (000395EC) --------------------------------------------------------
void __fastcall __spoils<> Q_A2_sub_395EC(P_WndA2 result)
{
  Q_A2Ctor_sub_2C830(result);
  result->pProcs = (P_Procs)&off_95F6C;
}
// 95F6C: using guessed type int (__fastcall *off_95F6C)(P_WndA2 a1);

//----- (000395FC) --------------------------------------------------------
T_WndA2 *__fastcall sub_395FC(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_95F44);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_95F6C;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 95F6C: using guessed type int (__fastcall *off_95F6C)(P_WndA2 a1);

//----- (00039644) --------------------------------------------------------
int __fastcall sub_39644(T_WndA2 *a1, __int16 a2, LONG a3, LONG a4)
{
  T_WndA2 *v5; // eax
  T_WndA2 *Wnd_sub_56DA8; // [esp+0h] [ebp-10h]

  Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0);
  v5 = Q_FindWnd_sub_56DA8(&WinMgr, "PLSQUARE", 0);
  if ( (Wnd_sub_56DA8->a1.Unknown_35 || v5->a1.Unknown_35) && a2 != 0xF && a2 != 0xE )
  {
    return 0;
  }
  if ( (unsigned __int16)a2 < 6u )
  {
    return Q_WndA2_Proc3_sub_2F424(a1, a2, a3, a4);
  }
  if ( (unsigned __int16)a2 <= 6u )
  {
    a1->pProcs->proc4_draw((P_Wnd)a1, 2);
  }
  else
  {
    if ( a2 != 7 )
    {
      return Q_WndA2_Proc3_sub_2F424(a1, a2, a3, a4);
    }
    a1->pProcs->proc4_draw((P_Wnd)a1, 1);
  }
  return 0;
}

//----- (000396F0) --------------------------------------------------------
void __fastcall sub_396F0(int a1, int edx0)
{
  T_WndA2 *Wnd_sub_56DA8; // esi
  T_WndA2 *v3; // eax
  T_Wnd07PW *v4; // ebp
  int v5; // eax
  LONG v6; // eax
  void *ShapeTable_sub_1B084; // eax
  LONG v8; // eax
  LONG v9; // ebp
  LONG v10; // edi
  int i; // esi
  void *v12; // eax
  LONG v13; // eax
  char *sub_1CEA8; // eax
  unsigned __int16 squareIndex; // bx
  UBYTE Unknown_AB; // cl
  char *v17; // eax
  UBYTE buildingPlanetItemIndex; // ch
  int DaysToCompleteItem_sub_358BC; // esi
  UWORD flags; // ax
  int v21; // eax
  char *v22; // eax
  char *v23; // kr08_4
  LONG v24; // edi
  unsigned __int16 v25; // bx
  PANE *v26; // esi
  void *v27; // eax
  void *v28; // eax
  char *v29; // ecx
  int v30; // ebx
  LONG *p_x0; // esi
  const char *v32; // ecx
  LONG *v33; // esi
  int v34; // edi
  int v35; // ecx
  int v36; // ebp
  int v37; // esi
  LONG v38; // edi
  LONG v39; // ebp
  int j; // esi
  LONG v41; // ecx
  LONG v42; // ebx
  LONG v43; // edx
  LONG v44; // [esp-10h] [ebp-A0h]
  LONG v45; // [esp-Ch] [ebp-9Ch]
  LONG v46; // [esp-8h] [ebp-98h]
  char *v47; // [esp+Ch] [ebp-84h]
  char s[60]; // [esp+10h] [ebp-80h] BYREF
  LONG hotX; // [esp+4Ch] [ebp-44h] BYREF
  LONG hotY; // [esp+50h] [ebp-40h] BYREF
  char *name; // [esp+54h] [ebp-3Ch]
  int v52; // [esp+58h] [ebp-38h]
  int v53; // [esp+5Ch] [ebp-34h]
  int v54; // [esp+60h] [ebp-30h]
  PANE *pane; // [esp+64h] [ebp-2Ch]
  PANE *v56; // [esp+68h] [ebp-28h]
  LONG v57; // [esp+6Ch] [ebp-24h]
  UWORD pCacheIndex[2]; // [esp+70h] [ebp-20h] BYREF
  LONG shape_number; // [esp+74h] [ebp-1Ch] BYREF
  UBYTE a2; // [esp+78h] [ebp-18h]

  v54 = a1;
  v52 = 0;
  if ( edx0 != 2 && (WinMgr._wndIndex == *(_DWORD *)(a1 + 0x41) || edx0 == 1) )
  {
    v52 = 0xFFFFFFFF;
  }
  Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "PLANLIST", 0);
  v3 = Q_FindWnd_sub_56DA8(&WinMgr, "PLSQUARE", 0);
  if ( Wnd_sub_56DA8->a1.Unknown_35 || v3->a1.Unknown_35 )
  {
    v52 = 0;
  }
  v53 = *(_DWORD *)(v54 + 0x47);
  if ( v53 == 4 )
  {
    v53 = 3;
  }
  if ( *(_WORD *)(v54 + 0x45) == 0x33 )
  {
    v53 = 4;
  }
  v4 = (T_Wnd07PW *)Q_FindWnd_sub_56DA8(&WinMgr, "PLANETALLOC", 0);
  *(_DWORD *)pCacheIndex = 0xFFFF;
  shape_number = 0xFFFF;
  VFX_shape_lookaside((*V_Type6_stru_D8654.hazeTables)[0x15]);
  if ( v53 <= 2 )
  {
    VFX_pane_wipe((PANE *)(v54 + 4), 0);
  }
  HIWORD(v5) = HIWORD(v53);
  switch ( v53 )
  {
    case 0:
      LOWORD(v5) = GwshareShpCacheIndexes[0x26];
      *(_DWORD *)pCacheIndex = v5;
      v57 = (int)pow((double)V_Game.pCurPlanet->research, 0.75);
      shape_number = v57;
      if ( (unsigned __int16)v57 > 0x14u )
      {
        shape_number = 0x14;
      }
      goto LABEL_23;
    case 1:
      LOWORD(v5) = GwshareShpCacheIndexes[0x27];
      *(_DWORD *)pCacheIndex = v5;
      v57 = (int)pow((double)V_Game.pCurPlanet->industry, 0.75);
      shape_number = v57;
      if ( (unsigned __int16)v57 > 0x14u )
      {
        shape_number = 0x14;
      }
      goto LABEL_23;
    case 2:
      LOWORD(v5) = GwshareShpCacheIndexes[0x28];
      *(_DWORD *)pCacheIndex = v5;
      HIWORD(v6) = HIWORD(V_Game.pCurPlanet);
      LOWORD(v6) = V_Game.pCurPlanet->prosperity;
      shape_number = v6;
      if ( (unsigned __int16)v6 > 0x14u )
      {
        shape_number = 0x14;
      }
LABEL_23:
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
      VFX_shape_draw((PANE *)(v54 + 4), ShapeTable_sub_1B084, (unsigned __int16)shape_number, 0, 0);
      goto LABEL_61;
    case 3:
      v8 = 0xF2;
      if ( v52 )
      {
        v8 = 0x96;
      }
      v9 = 0;
      v57 = v54 + 4;
      VFX_pane_wipe((PANE *)(v54 + 4), v8);
      v10 = 0;
      shape_number = 1;
      pane = (PANE *)(v54 + 4);
      for ( i = 0; i < V_Game.pCurPlanet->maximumPopulation; ++i )
      {
        if ( i == V_Game.pCurPlanet->word4C )
        {
          ++shape_number;
        }
        if ( i == V_Game.pCurPlanet->word42 )
        {
          ++shape_number;
        }
        v12 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2C]);
        VFX_shape_draw(pane, v12, (unsigned __int16)shape_number, v10, v9);
        v10 += 0xA;
        if ( i % 0xA == 9 )
        {
          v10 = 0;
          v9 += 0xA;
        }
      }
      goto LABEL_61;
    case 4:
      v13 = 0xF2;
      if ( v52 && V_Game.pCurPlanet->raceIndex == V_PlayerRaceIndex )
      {
        v13 = 0x96;
      }
      VFX_pane_wipe((PANE *)(v54 + 4), v13);
      a2 = 0xFF;
      qmemcpy(s, &unk_9686C, sizeof(s));
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x24);// 36: "No Project"
      squareIndex = 0xFFFF;
      Unknown_AB = v4->Unknown_AB;
      name = sub_1CEA8;
      if ( Unknown_AB == 0xFF )
      {
        buildingPlanetItemIndex = V_Game.pCurPlanet->buildingPlanetItemIndex;
        if ( buildingPlanetItemIndex != 0xFF )
        {
          DaysToCompleteItem_sub_358BC = (unsigned __int16)Q_Planet_GetDaysToCompleteItem_sub_358BC(V_Game.pCurPlanet);
          flags = V_PlanetItems.item[buildingPlanetItemIndex].flags;
          a2 = buildingPlanetItemIndex;
          if ( (flags & 0x20) == 0 )
          {
            if ( DaysToCompleteItem_sub_358BC == 0xFFFF )
            {
              v23 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x27);
              strcpy(s, v23);
            }
            else
            {
              if ( DaysToCompleteItem_sub_358BC == 1 )
              {
                v21 = 0x1C;                            // 28: ""
              }
              else
              {
                v21 = 0x1D;                            // 29: "s"
              }
              v47 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v21);
              v22 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x26);// 38: "%d day%s until completion"
              sprintf(s, v22, DaysToCompleteItem_sub_358BC, v47);
            }
          }
          if ( V_Game.pCurPlanet->buildingPlanetItemIndex != 0x23 )
          {
            squareIndex = V_Game.pCurPlanet->_squareIndex;
          }
        }
      }
      else
      {
        v17 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x25);
        a2 = Unknown_AB;
        strcpy(s, v17);
      }
      if ( a2 == 0xFF )
      {
        if ( V_Game.pCurPlanet->word42 != V_Game.pCurPlanet->word4C )
        {
          goto LABEL_60;
        }
        v30 = 0x19;
        v26 = (PANE *)(v54 + 4);
        v29 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x28);// 40: "(No Free Population)"
      }
      else
      {
        if ( squareIndex == 0xFFFF )
        {
          sub_39390(v4, a2, pCacheIndex, (UWORD *)&shape_number);
        }
        else
        {
          sub_393F4((int)v4, squareIndex, pCacheIndex, &shape_number);
        }
        v24 = (LONG)sub_10000;
        if ( a2 == 0x17 )
        {
          v24 = 0x8000;
        }
        v25 = shape_number;
        name = V_PlanetItems.item[a2].name;
        v26 = (PANE *)(v54 + 4);
        v27 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
        Q_GSYSTEM_CPP_sub_2BC40(v26, v27, v25, &hotX, &hotY);
        v46 = hotY;
        v45 = hotX;
        v44 = (unsigned __int16)shape_number;
        v28 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, pCacheIndex[0]);
        VFX_shape_transform(v26, v28, v44, v45, v46, V_BigBuffer, 0, v24, v24, 0);
        v29 = s;
        v30 = 0x50;
      }
      WinMgr.LargeFont.pane.window = v26->window;
      p_x0 = &v26->x0;
      WinMgr.LargeFont.pane.x0 = *p_x0++;
      WinMgr.LargeFont.pane.y0 = *p_x0++;
      WinMgr.LargeFont.pane.x1 = *p_x0;
      WinMgr.LargeFont.pane.y1 = p_x0[1];
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v30, v29, 2, 0xFFFF, 0xFF, 0);
LABEL_60:
      v32 = name;
      WinMgr.LargeFont.pane.window = *(WINDOW **)(v54 + 4);
      v33 = (LONG *)(v54 + 8);
      WinMgr.LargeFont.pane.x0 = *(_DWORD *)(v54 + 8);
      WinMgr.LargeFont.pane.y0 = *++v33;
      WinMgr.LargeFont.pane.x1 = *++v33;
      WinMgr.LargeFont.pane.y1 = v33[1];
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xA, v32, 2, 0xFFFF, 0xFF, 0);
LABEL_61:
      if ( v53 <= 2 && v52 && V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
      {
        v34 = *(_DWORD *)(v54 + 0x10);
        v35 = *(_DWORD *)(v54 + 8);
        v36 = *(_DWORD *)(v54 + 0x14);
        v37 = *(_DWORD *)(v54 + 0xC);
        v56 = (PANE *)(v54 + 4);
        v38 = v34 - v35;
        v39 = v36 - v37;
        for ( j = 0; j < 3; ++j )
        {
          v41 = v38;
          v42 = j;
          v43 = j;
          --v38;
          Q_Pane_CopyOrDrawRectangle_sub_2BB74(v56, v43, v42, v41, v39--, 0x96u, 0);
        }
      }
      Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(v54 + 4));
      return;
    default:
      goto LABEL_61;
  }
}
/* Orphan comments:
37: "Pick a Location"
39: "No Progress"
*/
// 10000: using guessed type void __noreturn sub_10000();
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 396F0: using guessed type char s[60];

//----- (00039D80) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd14PSW_Ctor_sub_39D80(P_Wnd14PSW pWnd14PSW)
{
  Q_A2Ctor_sub_2C830(&pWnd14PSW->a);
  pWnd14PSW->a.pProcs = &Wnd14PSW_Procs;
  Q_ReadPlanetTexts_sub_39DE0();
}

//----- (00039D9C) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd14PSW_Dtor_sub_39D9C(P_Wnd14PSW pWnd14PSW, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(pWnd14PSW, &C_Wnd14PSW);
    operator delete[](v3);
  }
  else
  {
    pWnd14PSW->a.pProcs = &Wnd14PSW_Procs;
    Q_A2Dtor_sub_2C848(&pWnd14PSW->a, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(pWnd14PSW);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00039DE0) --------------------------------------------------------
void __fastcall Q_ReadPlanetTexts_sub_39DE0()
{
  int i; // kr04_4
  int j; // kr0C_4
  int k; // kr14_4

  for ( i = 0; i != 5; ++i )
  {
    PlanetSizeTexts[i] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(i + 41);
  }
  for ( j = 0; j != 0xB; ++j )
  {
    PlanetTypeTexts[j] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(j + 46);
  }
  for ( k = 0; k != 8; ++k )
  {
    PlanetButtonTexts[k] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(k + 57);
  }
}
/* Orphan comments:
41: "Tiny"
46: "Husk"
57: "Cancel"
*/

//----- (00039E3C) --------------------------------------------------------
int __fastcall Q_Wnd14PSW_Proc3_sub_39E3C(P_Wnd14PSW pWnd14PSW, UWORD message, int param1, int param2)
{
  int squareIndex; // eax
  UBYTE planetItemIndex; // cl
  P_WndA2 v7; // eax
  int v8; // esi
  T_Ship *ShipAtSquare_sub_35A70; // eax
  T_Ship *v10; // esi
  int v11; // ebx
  int raceIndex; // edx
  int v13; // edi
  int v14; // ebx
  int SquareWithItem_sub_35930; // edx
  int v16; // edi
  int v17; // ebx
  int v18; // esi
  int v19; // ecx
  int v20; // eax
  int v21; // ecx
  int i; // kr1C_4
  int v23; // kr20_4
  P_Wnd *v24; // eax
  P_Wnd v25; // ecx
  int v26; // edi
  int Unknown_00; // ebx
  int v28; // edx
  int v29; // eax
  WORD v30; // bx
  int index; // edx
  P_WndA2 v32; // edi
  char *sub_1CEA8; // esi
  P_Wnd v34; // edx
  int v35; // ecx
  WORD v36; // bx
  char *v37; // kr0C_4
  int v38; // edi
  P_WndA2 v39; // eax
  T_Ship *v40; // eax
  T_Ship *v41; // eax
  MACRO_VFX_BOOL v42; // esi
  char *v43; // ebx
  T_WndA2 *Wnd_sub_56DA8; // ecx
  int PlanetsNum_sub_402E0; // edi
  int v46; // eax
  int v47; // eax
  char *v48; // eax
  int v49; // [esp-4h] [ebp-144h]
  char *v50; // [esp-4h] [ebp-144h]
  char s[280]; // [esp+0h] [ebp-140h] BYREF
  int param1a; // [esp+118h] [ebp-28h]
  int v53[2]; // [esp+11Ch] [ebp-24h] BYREF
  int param2a; // [esp+124h] [ebp-1Ch]
  int v55; // [esp+128h] [ebp-18h]
  int v56; // [esp+12Ch] [ebp-14h]
  P_WndA2 a1; // [esp+130h] [ebp-10h]
  int v58; // [esp+134h] [ebp-Ch]
  T_Type20 v59; // [esp+138h] [ebp-8h]

  a1 = &pWnd14PSW->a;
  v59.message = message;
  param1a = param1;
  param2a = param2;
  squareIndex = pWnd14PSW->squareIndex;
  planetItemIndex = 0xFF;
  if ( (unsigned __int16)squareIndex != 0xFFFF )
  {
    planetItemIndex = V_Game.pCurPlanet->pSquares[squareIndex].planetItemIndex;
  }
  if ( v59.message < 0x33u )
  {
    if ( v59.message >= 4u )
    {
      if ( v59.message > 5u )
      {
        if ( v59.message >= 7u )
        {
          if ( v59.message <= 7u )
          {
            if ( a1->a1.Unknown_39 && a1->a1.Unknown_35 && a1->a1._mouseFocus )
            {
              a1->pProcs->proc5(&a1->a1, 0);
            }
            return 0xFFFFFFFF;
          }
          else
          {
            if ( v59.message != 0x32 )
            {
              return Q_WndA2_Proc3_sub_2F424(a1, v59.message, param1a, param2a);
            }
            dword_104684 = param1a;
            LOWORD(a1[1].a1.magic12345678) = param2a;
            return 0;
          }
        }
        if ( a1->a1.Unknown_39 && a1->a1.Unknown_35 && a1->a1._mouseFocus )
        {
          a1->pProcs->proc4_draw(&a1->a1, 0);
        }
      }
      return 0xFFFFFFFF;
    }
    if ( !v59.message )
    {
      return Q_WndA2_Proc3_sub_2F424(a1, v59.message, param1a, param2a);
    }
    if ( v59.message <= 1u )
    {
      v7 = a1;
      a1->a1.Unknown_39 = 0xFFFFFFFF;
      v8 = dword_104684;
      v7->a1.Unknown_35 = 0xFFFFFFFF;
      if ( v8 == 3 )
      {
        v55 = 0;
        if ( planetItemIndex == 0xFF )
        {
          v19 = 0;
          while ( (_BYTE)v19 == 5 || Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, v19, a1[1].a1.magic12345678) == FALSE )
          {
            if ( ++v19 >= 0x27 )
            {
              goto LABEL_37;
            }
          }
          v20 = v55 + 1;
          *(_DWORD *)&s[4 * v20 + 0xC4] = 0x36;
          v55 = v20;
        }
        else
        {
          if ( planetItemIndex == 0x17 )
          {
            LOWORD(v7) = a1[1].a1.magic12345678;
            if ( (V_Game.pCurPlanet->pSquares[(_DWORD)v7].flags & 1) != 0 )
            {
              ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a1[1].a1.magic12345678);
              v10 = ShipAtSquare_sub_35A70;
              if ( !ShipAtSquare_sub_35A70 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\psqwin.cpp", 0x79);
              }
              if ( Q_Ship_FindGizmoHullCellIndex_sub_4937C(ShipAtSquare_sub_35A70, 0x47u) != 0xFFFFFFFF
                && V_Game.pCurPlanet->raceIndex == 0xFF )
              {
                v11 = v55 + 1;
                *(_DWORD *)&s[4 * v55 + 0xC8] = 0x34;
                v55 = v11;
              }
              if ( Q_Ship_FindGizmoHullCellIndex_sub_4937C(v10, 0x49u) != 0xFFFFFFFF )
              {
                raceIndex = V_Game.pCurPlanet->raceIndex;
                if ( raceIndex != 0xFF && (_BYTE)raceIndex != V_PlayerRaceIndex )
                {
                  v13 = v55 + 1;
                  *(_DWORD *)&s[4 * v55 + 0xC8] = 0x39;
                  v55 = v13;
                }
              }
              *(_DWORD *)&s[4 * v55 + 0xC8] = 0x37;
              v14 = v55;
              SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(V_Game.pCurPlanet, 0x18u);
              v55 = v14 + 1;
              if ( (unsigned __int16)SquareWithItem_sub_35930 != 0xFFFF
                && (V_Game.pCurPlanet->pSquares[SquareWithItem_sub_35930].flags & 1) != 0
                && V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
              {
                v16 = v55 + 1;
                *(_DWORD *)&s[4 * v55 + 0xC8] = 0x38;
                v55 = v16;
              }
            }
          }
          if ( planetItemIndex != 5 )
          {
            v17 = v55 + 1;
            *(_DWORD *)&s[4 * v55 + 0xC8] = 0x35;
            v55 = v17;
          }
          if ( Q_Planet_CanPlaceItem_sub_34368(V_Game.pCurPlanet, ASCEND_PI_35_AUTOMATION, a1[1].a1.magic12345678) )
          {
            v18 = v55 + 1;
            *(_DWORD *)&s[4 * v55 + 0xC8] = 0x3A;
            v55 = v18;
          }
        }
LABEL_37:
        v59.Unknown_00 = 0xA0;
        v21 = v55 + 1;
        *(_DWORD *)&s[4 * v55 + 0xC8] = 0x33;
        v55 = v21;
        if ( v21 > 0 )
        {
          v56 = v21;
          v58 = 0;
          v53[1] = 4 * v21;
          v23 = v21;
          for ( i = 0; i < v23; ++i )
          {
            v24 = &(*a1->a1.children)[i];
            v25 = *v24;
            strcpy((*v24)->name, *(const char **)&V_PlanetCfg.offsets.sizes[4].column[4 * *(_DWORD *)&s[4 * i + 0xC8] + 8]);
            v26 = v56;
            v25->sendMessage = *(_WORD *)&s[4 * i + 0xC8];
            Unknown_00 = v59.Unknown_00;
            v28 = 0x1DF - v59.Unknown_00;
            v25->pane.x0 = v59.Unknown_00;
            v25->pane.y0 = 0x151;
            v25->pane.y1 = 0x16F;
            v59.Unknown_00 = v28 / v26 + Unknown_00;
            if ( v59.Unknown_00 > 0x1DF )
            {
              v59.Unknown_00 = 0x1DF;
            }
            v29 = v59.Unknown_00;
            v30 = v59.message;
            v49 = param2a;
            v25->pane.x1 = v59.Unknown_00;
            index = v25->index;
            v59.Unknown_00 = v29 + 1;
            Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, index, v30, param1a, v49);
            --v56;
          }
        }
        if ( v55 == 1 )
        {
          v32 = a1;
          sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);// 30: "OK"
          strcpy((*v32->a1.children)[0]->name, sub_1CEA8);
        }
      }
      else
      {
        v34 = (*v7->a1.children)[0];
        v34->pane.x0 = 0xA0;
        v34->pane.y0 = 0x151;
        v35 = param1a;
        v34->pane.x1 = 0x1DF;
        v36 = v59.message;
        v34->pane.y1 = 0x16F;
        v37 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);
        strcpy(v34->name, v37);
        v38 = param2a;
        v34->sendMessage = 0x33;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, v34->index, v36, v35, v38);
      }
      a1->pProcs->proc4_draw((P_Wnd)a1, 0);
      return 0;
    }
    else
    {
      if ( v59.message != 2 )
      {
        return Q_WndA2_Proc3_sub_2F424(a1, v59.message, param1a, param2a);
      }
      sub_2D258(a1, 2);
      v39 = a1;
      a1->a1.Unknown_39 = 0;
      v39->a1.Unknown_35 = 0;
      if ( WinMgr._wndIndex == a1->a1.index )
      {
        WinMgr._wndIndex = 0xFFFFFFFF;
      }
      sub_567BC(&WinMgr, a1->a1.index, 0xFFFFFFFF);
      sub_564C0(&WinMgr, a1->a1.index, 0xFFFFFFFF);
      return 0;
    }
  }
  else
  {
    if ( v59.message <= 0x33u )
    {
LABEL_76:
      Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x32, 0xA, 0);
      return 0;
    }
    if ( v59.message < 0x37u )
    {
      if ( v59.message < 0x35u )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x32, 0xC, 0);
        return 0;
      }
      else if ( v59.message <= 0x35u )
      {
        if ( planetItemIndex == 0x17 )
        {
          v40 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a1[1].a1.magic12345678);
          Q_Ship_RemoveFromTheGame_sub_49940(v40);
        }
        Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, a1[1].a1.magic12345678, 0xFFu, 1u);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x32, 0xA, 0);
        return 0;
      }
      else
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x32, 0xB, 0);
        return 0;
      }
    }
    else
    {
      if ( v59.message <= 0x37u )
      {
        v41 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, a1[1].a1.magic12345678);
        Q_Planet_LaunchShip_sub_35C38(V_Game.pCurPlanet, v41);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x32, 0xA, 0);
        return 0;
      }
      if ( v59.message < 0x39u )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x32, 0xA, 0);
        Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x34, LOWORD(a1[1].a1.magic12345678), 1);
        return 0;
      }
      if ( v59.message > 0x39u )
      {
        if ( v59.message != 0x3A )
        {
          return Q_WndA2_Proc3_sub_2F424(a1, v59.message, param1a, param2a);
        }
        Q_Planet_HandleItemConstruction_sub_34B0C(V_Game.pCurPlanet, a1[1].a1.magic12345678, 0x23u, 2u);
        goto LABEL_76;
      }
      v42 = Q_Planet_TryInvade_sub_36CD4(V_Game.pCurPlanet, a1[1].a1.magic12345678, v53);
      v43 = "invadefailure";
      Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "HELPWINDOW", 0);
      if ( v42 == 0xFFFFFFFF )
      {
        v43 = "invadesuccess";
      }
      PlanetsNum_sub_402E0 = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[V_PlayerRaceIndex]);
      Q_ShowHelpTopic_sub_2FCB0((P_Wnd20HW)Wnd_sub_56DA8, "help.txt", v43);
      if ( PlanetsNum_sub_402E0 == 1 )
      {
        v46 = 0x20;                                    // 32: "y"
      }
      else
      {
        v46 = 0x21;                                    // 33: "ies"
      }
      v50 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v46);
      if ( v53[0] == 1 )
      {
        v47 = 0x1C;                                    // 28: ""
      }
      else
      {
        v47 = 0x1D;                                    // 29: "s"
      }
      v48 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v47);
      sprintf(s, *(const char **)&Wnd_sub_56DA8[0x12].a1._t19[3].Unknown_0, V_Game.pCurPlanet->name, v53[0], v48, PlanetsNum_sub_402E0, v50);
      strcpy(*(char **)&Wnd_sub_56DA8[0x12].a1._t19[3].Unknown_0, s);
      LOWORD(Wnd_sub_56DA8[0x13].a1.magic12345678) = 0x1C;
      HIWORD(Wnd_sub_56DA8[0x13].a1.magic12345678) = 0x49;
      *(_WORD *)((char *)&Wnd_sub_56DA8[0x13].a1.Unknown_1A + 1) = 0x1D;
      *(_WORD *)((char *)&Wnd_sub_56DA8[0x13].a1.Unknown_1A + 3) = V_Game.pCurPlanet->size + 5 * V_Game.pCurPlanet->type;
      Q_WinMgr_DispatchMessageProc3_sub_56D30(&WinMgr, a1->a1.parentIndex, 0x32, 0xA, 0);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, 0, 0);
      return 0;
    }
  }
}
/* Orphan comments:
30: "OK"
30: "OK"
*/
// 104684: using guessed type int dword_104684;

//----- (0003A6BC) --------------------------------------------------------
void __fastcall Q_Wnd14PSW_Proc4_sub_3A6BC(P_Wnd14PSW pWnd14PSW)
{
  PANE *p_pane; // esi
  void *helpShapeTable; // eax
  int v3; // eax
  char *sub_1CEA8; // eax
  int raceIndex; // esi
  int v6; // edx
  int v7; // ebx
  char *v8; // eax
  int v9; // edx
  UBYTE planetItemIndex; // al
  UWORD industry; // cx
  UWORD buildingProgress; // si
  UWORD ItemCost_sub_3583C; // ax
  int v14; // eax
  UWORD word42; // dx
  UWORD maximumPopulation; // bx
  int v17; // eax
  unsigned __int16 v18; // bx
  UBYTE color; // al
  int v20; // ecx
  char *v21; // ebx
  P_Ship ShipAtSquare_sub_35A70; // eax
  char *v23; // eax
  const char *v24; // ebx
  char *v25; // eax
  unsigned __int16 v26; // dx
  UWORD v27; // cx
  UWORD v28; // si
  UWORD v29; // ax
  int v30; // eax
  int v31; // edx
  char *v32; // kr08_4
  int v33; // eax
  char *v34; // eax
  char *v35; // kr10_4
  char *v36; // eax
  char *v37; // kr18_4
  char *v38; // kr20_4
  char *v39; // kr28_4
  char *v40; // eax
  char *v41; // eax
  char *v42; // kr30_4
  char *v43; // eax
  char *v44; // eax
  char *v45; // ecx
  char *v46; // eax
  int v47; // eax
  char *v48; // eax
  T_Tech *v49; // [esp-10h] [ebp-1AAh]
  WORD v50; // [esp-Ch] [ebp-1A6h]
  char *v51; // [esp-Ch] [ebp-1A6h]
  char *v52; // [esp-Ch] [ebp-1A6h]
  char *v53; // [esp-8h] [ebp-1A2h]
  char *v54; // [esp-8h] [ebp-1A2h]
  int v55; // [esp-8h] [ebp-1A2h]
  char *v56; // [esp-8h] [ebp-1A2h]
  int v57; // [esp-8h] [ebp-1A2h]
  char *v58; // [esp-4h] [ebp-19Eh]
  char *v59; // [esp-4h] [ebp-19Eh]
  char *v60; // [esp-4h] [ebp-19Eh]
  char *v61; // [esp-4h] [ebp-19Eh]
  char *v62; // [esp-4h] [ebp-19Eh]
  int v63; // [esp-4h] [ebp-19Eh]
  int v64; // [esp-4h] [ebp-19Eh]
  char *v65; // [esp-4h] [ebp-19Eh]
  char v66[152]; // [esp+0h] [ebp-19Ah] BYREF
  char v67[100]; // [esp+98h] [ebp-102h] BYREF
  char v68[100]; // [esp+FCh] [ebp-9Eh] BYREF
  char s[52]; // [esp+160h] [ebp-3Ah] BYREF
  char v70[52]; // [esp+194h] [ebp-6h] BYREF
  PANE v71; // [esp+1C8h] [ebp+2Eh]
  char v72[20]; // [esp+1DCh] [ebp+42h] BYREF
  char *v73; // [esp+1F0h] [ebp+56h]
  T_Tech *name; // [esp+1F4h] [ebp+5Ah]
  T_Square *v75; // [esp+1F8h] [ebp+5Eh]
  char *format; // [esp+1FCh] [ebp+62h]
  char *v77; // [esp+200h] [ebp+66h]
  char *v78; // [esp+204h] [ebp+6Ah]
  int v79; // [esp+208h] [ebp+6Eh]
  char *v80; // [esp+20Ch] [ebp+72h]
  _DWORD *p_magic12345678; // [esp+210h] [ebp+76h]
  int TurnsToComplete_sub_46C20; // [esp+214h] [ebp+7Ah]
  char *v83; // [esp+218h] [ebp+7Eh]

  p_magic12345678 = &pWnd14PSW->a.a1.magic12345678;
  p_pane = &pWnd14PSW->a.a1.pane;
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pWnd14PSW->a.a1.pane);
  VFX_pane_wipe(p_pane, 0xF2);
  helpShapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x25]);// help.shp
  v79 = 0;
  VFX_shape_draw(p_pane, helpShapeTable, 0, 0, 0);
  v71 = *(PANE *)(p_magic12345678 + 1);
  v71.x0 = p_magic12345678[2] + 0xA;
  v71.y0 = p_magic12345678[3] + 0xA;
  v80 = 0;
  v3 = p_magic12345678[2];
  name = 0;
  v78 = 0;
  v71.x1 = v3 + 0x145;
  format = 0;
  TurnsToComplete_sub_46C20 = 0xFFFF;
  v71.y1 = p_magic12345678[3] + 0xCF;
  WinMgr.LargeFont.pane = v71;
  WinMgr.LargeFont._bgcolor = 0xFF;
  v83 = 0;
  switch ( dword_104684 )
  {
    case 0:
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x41);// 65: "Research"
      v80 = sub_1CEA8;
      LOWORD(sub_1CEA8) = V_Game.pCurPlanet->research;
      raceIndex = V_Game.pCurPlanet->raceIndex;
      v83 = sub_1CEA8;
      v6 = V_Research.current.project[raceIndex];
      if ( v6 != 0xFFFF )
      {
        v79 = 0xFFFFFFFF;
        name = &V_Research.techs[v6];
        v7 = sub_469F0(&V_Research, raceIndex);
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(
                                      V_Research.techs[v6].cost,
                                      (unsigned __int16)word_106FB4[V_Game.pCurPlanet->raceIndex],
                                      v7);
      }
      v78 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x42);  // 66: "be discovered"
      format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x43);// 67: "No progress is being made on %s."
      break;
    case 1:
      v8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x44);   // 68: "Industry"
      v80 = v8;
      LOWORD(v8) = V_Game.pCurPlanet->industry;
      LOWORD(v9) = V_Game.pCurPlanet->_squareIndex;
      v83 = v8;
      planetItemIndex = 0xFF;
      if ( (unsigned __int16)v9 != 0xFFFF )
      {
        HIWORD(v9) = 0;
        planetItemIndex = V_Game.pCurPlanet->pSquares[v9].planetItemIndex;
      }
      if ( planetItemIndex != 0xFF )
      {
        name = (T_Tech *)V_PlanetItems.item[planetItemIndex].name;
        v79 = 0xFFFFFFFF;
        industry = V_Game.pCurPlanet->industry;
        buildingProgress = V_Game.pCurPlanet->buildingProgress;
        ItemCost_sub_3583C = Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, v9, 0xFFu);
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(ItemCost_sub_3583C, buildingProgress, industry);
      }
      v78 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x45);  // 69: "be completed"
      format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x43);// 67: "No progress is being made on %s."
      break;
    case 2:
      v80 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x46);  // 70: "Prosperity"
      HIWORD(v14) = HIWORD(V_Game.pCurPlanet);
      LOWORD(v14) = V_Game.pCurPlanet->prosperity;
      v83 = (char *)v14;
      name = (T_Tech *)Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x47);// 71: "Population"
      v78 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x48);  // 72: "grow"
      word42 = V_Game.pCurPlanet->word42;
      maximumPopulation = V_Game.pCurPlanet->maximumPopulation;
      v79 = 0xFFFFFFFF;
      if ( word42 >= maximumPopulation )
      {
        format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4A);// 74: "%s has no more room to grow."
      }
      else
      {
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(
                                      V_PopGrowthAmount50,
                                      (unsigned __int16)V_Game.pCurPlanet->z6,
                                      V_Game.pCurPlanet->prosperity);
        if ( (unsigned __int16)TurnsToComplete_sub_46C20 == 0xFFFF )
        {
          format = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x49);// 73: "%s is not growing."
        }
      }
      break;
    case 3:
      v17 = *(unsigned __int16 *)((char *)p_magic12345678 + 0xAB);
      if ( (unsigned __int16)v17 != 0xFFFF )
      {
        HIBYTE(v18) = 0;
        v75 = &V_Game.pCurPlanet->pSquares[v17];
        LOBYTE(v18) = v75->planetItemIndex;
        v77 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4B);// 75: "White"
        color = v75->color;
        v73 = 0;
        switch ( color & 7 )
        {
          case ASCEND_SQUARE_COLOR_BLACK:
            v77 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4C);// 76: "Black"
            break;
          case ASCEND_SQUARE_COLOR_RED:
            v77 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4D);// 77: "Red"
            v73 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4E);// 78: "industry"
            break;
          case ASCEND_SQUARE_COLOR_GREEN:
            v77 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x4F);// 79: "Green"
            v73 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x50);// 80: "prosperity"
            break;
          case ASCEND_SQUARE_COLOR_BLUE:
            v77 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x51);// 81: "Blue"
            v73 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x52);// 82: "research"
            break;
          default:
            break;
        }
        if ( *(_WORD *)((char *)p_magic12345678 + 0xAB) >= V_Game.pCurPlanet->surfaceSquaresNum )
        {
          v77 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x53);// 83: "Orbital"
        }
        v20 = v18;
        if ( v18 == 0xFF )
        {
          if ( (v75->color & ASCEND_SQUARE_XENO_RUINS) != 0 && V_PlayerRaceIndex == V_Game.pCurPlanet->raceIndex )
          {
            v35 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x58);
            strcpy(v68, v35);
          }
          else
          {
            v60 = v77;
            v36 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x59);// 89: "%s Square"
            sprintf(v68, v36, v60);
          }
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x14, v68, 2, 0xFFFF, 0xFFFF, 0);
          if ( (v75->color & ASCEND_SQUARE_XENO_RUINS) == 0 )
          {
            if ( *(_WORD *)((char *)p_magic12345678 + 0xAB) < V_Game.pCurPlanet->surfaceSquaresNum )
            {
              if ( (v75->color & 7) == ASCEND_SQUARE_COLOR_WHITE )
              {
                v38 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5B);
                strcpy(v66, v38);
              }
              else if ( (v75->color & 7) != 0 )
              {
                v61 = v73;
                v53 = v77;
                v40 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5D);// 93: "%s squares increase the effectiveness of %s-producing structures."
                sprintf(v66, v40, v53, v61);
              }
              else
              {
                v39 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5C);
                strcpy(v66, v39);
              }
            }
            else
            {
              v37 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5A);
              strcpy(v66, v37);
            }
            Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0xA, 0x50, v66, 2, 0xFFFF, 0xFFFF, 0);
          }
        }
        else
        {
          v21 = V_PlanetItems.item[v18].name;
          strcpy(s, v21);
          if ( v20 == 0x17 )
          {
            ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(V_Game.pCurPlanet, *(_WORD *)((char *)p_magic12345678 + 0xAB));
            sprintf(s, "%s \"%s\"", v21, ShipAtSquare_sub_35A70->name);
          }
          if ( (v75->flags & 2) != 0 )
          {
            v23 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x54);// 84: "Automated "
          }
          else
          {
            v23 = (char *)&unk_920AA;
          }
          v24 = v23;
          qmemcpy(v70, &unk_968A8, 0x32u);
          if ( *(_WORD *)((char *)p_magic12345678 + 0xAB) < V_Game.pCurPlanet->surfaceSquaresNum )
          {
            v58 = v77;
            v25 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x55);// 85: " on %s Square"
            sprintf(v70, v25, v58);
          }
          sprintf(v67, "%s%s%s", v24, s, v70);
          Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xF, v67, 2, 0xFFFF, 0xFFFF, 0);
          v26 = *(_WORD *)((char *)p_magic12345678 + 0xAB);
          if ( !V_Game.pCurPlanet->pSquares[v26].flags )
          {
            v27 = V_Game.pCurPlanet->industry;
            v28 = V_Game.pCurPlanet->buildingProgress;
            v29 = Q_Planet_GetItemCost_sub_3583C(V_Game.pCurPlanet, v26, 0xFFu);
            v30 = Q_GetTurnsToComplete_sub_46C20(v29, v28, v27);
            v31 = v30;
            if ( v30 == 0xFFFF )
            {
              v32 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x56);
              strcpy(v67, v32);
            }
            else
            {
              if ( v30 == 1 )
              {
                v33 = 0x1C;                            // 28: ""
              }
              else
              {
                v33 = 0x1D;                            // 29: "s"
              }
              v59 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v33);
              v34 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x57);// 87: "%d day%s until completion"
              sprintf(v67, v34, v31, v59);
            }
            Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x32, v67, 2, 0xFFFF, 0xFFFF, 0);
          }
        }
      }
      break;
    case 4:
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xF, V_Game.pCurPlanet->name, 2, 0xFFFF, 0xFFFF, 0);
      v62 = PlanetTypeTexts[V_Game.pCurPlanet->type];
      v54 = PlanetSizeTexts[V_Game.pCurPlanet->size];
      v41 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5E);  // 94: "%s %s Planet"
      sprintf(v68, v41, v54, v62);
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x3C, v68, 2, 0xFFFF, 0xFFFF, 0);
      v42 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x5F);
      strcpy(v72, v42);
      if ( V_Game.pCurPlanet->raceIndex != 0xFF )
      {
        strcpy(v72, V_SpecNames[V_Game.races[V_Game.pCurPlanet->raceIndex]._nameIndex]);
      }
      v55 = 4 * V_Game.races[V_Game.pCurPlanet->raceIndex].Unknown_02 + 0x13;
      v43 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x60);  // 96: "Owned by |%d|%s"
      sprintf(v68, v43, v55, v72);
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x5A, v68, 2, 0xFFFF, 0xFFFF, 0);
      v63 = V_Game.pCurPlanet->maximumPopulation;
      v44 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x61);  // 97: "Maximum Population  %d"
      sprintf(v68, v44, v63);
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x78, v68, 2, 0xFFFF, 0xFFFF, 0);
      if ( V_Game.pCurPlanet->raceIndex == V_PlayerRaceIndex && V_Game.pCurPlanet->z7 == 0xFFFFFFFF )
      {
        v50 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
        v45 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x62);// 98: "Self Managed"
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x96, v45, 2, v50, 0xFFFF, 0);
      }
      break;
    default:
      break;
  }
  if ( v80 )
  {
    v64 = (unsigned __int16)v83;
    v56 = v80;
    v51 = V_Game.pCurPlanet->name;
    v46 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x63);    // 99: "%s %s: %d per day"
    sprintf(v68, v46, v51, v56, v64);
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xF, v68, 2, 0xFFFF, 0xFFFF, 0);
    if ( v79 )
    {
      if ( (unsigned __int16)TurnsToComplete_sub_46C20 == 0xFFFF )
      {
        sprintf(v68, format, name);
      }
      else
      {
        if ( (unsigned __int16)TurnsToComplete_sub_46C20 == 1 )
        {
          v47 = 0x1C;                                  // 28: ""
        }
        else
        {
          v47 = 0x1D;                                  // 29: "s"
        }
        v65 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v47);
        v57 = (unsigned __int16)TurnsToComplete_sub_46C20;
        v52 = v78;
        v49 = name;
        v48 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x64);// 100: "%s will %s in %d day%s."
        sprintf(v68, v48, v49, v52, v57, v65);
      }
      Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x50, v68, 2, 0xFFFF, 0xFFFF, 0);
    }
  }
  if ( *(_WORD *)((char *)p_magic12345678 + 0x6B) )
  {
    sub_2D218(p_magic12345678);
  }
}
/* Orphan comments:
86: "No progress"
88: "Xenoarcheological Ruins"
90: "Orbital squares are used for building orbital structures such as 
Shipyards and Ships."
91: "White squares are ordinary habitable surface squares."
92: "Black squares are uninhabitable.  Most structures cannot be built on them."
95: "No One"
*/
// 9684C: using guessed type int V_PopGrowthAmount50;
// 104684: using guessed type int dword_104684;
// 106FB4: using guessed type __int16 word_106FB4[7];
// 3A6BC: using guessed type char s[52];
// 3A6BC: using guessed type char var_184[100];
// 3A6BC: using guessed type char var_120[100];
// 3A6BC: using guessed type char var_21C[152];
// 3A6BC: using guessed type _BYTE var_40[20];

//----- (0003B120) --------------------------------------------------------
void __fastcall Q_RaceCtor_sub_3B120(P_Race pRace)
{
  char *sub_1CEA8; // kr00_4
  int v3; // kr08_4

  v3 = 0;
  do
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v3 + 0x65);
    strcpy(V_SpecNames[v3++], sub_1CEA8);
  }
  while ( V_SpecNames[v3] != V_SpecNames[21] );
  pRace->_nameIndex = 0xFF;
  pRace->index = 0xFF;
  pRace->_homeStar = 0;
  sub_3B188(pRace);
}
/* Orphan comments:
101: "Minions"
*/

//----- (0003B188) --------------------------------------------------------
void __fastcall sub_3B188(P_Race pRace)
{
  P_Race v1; // esi
  P_Race v2; // edx
  T_Race *v3; // ebx

  v1 = pRace;
  pRace->Unknown_1AA = 18;
  pRace->Unknown_1AC = 22;
  pRace->Unknown_1AE = 0;
  pRace->Unknown_19B = 0;
  pRace->Unknown_1D9 = 0;
  pRace->Unknown_1DB = 0;
  pRace->Unknown_1E9 = 14;
  v2 = pRace;
  pRace->Unknown_1EA = 0;
  v3 = (T_Race *)&pRace->z1[3];
  do
  {
    v2->treaties[0] = 0;
    v2 = (P_Race)((char *)v2 + 1);
    pRace->_treatiesScore[0] = 0;
    pRace = (P_Race)((char *)pRace + 2);
  }
  while ( pRace != v3 );
  v1->Unknown_03 = 0;
}

//----- (0003B1FC) --------------------------------------------------------
int __fastcall sub_3B1FC(P_Race a1, UBYTE a2, __int16 a3)
{
  int result; // eax

  sub_3B188(a1);
  a1->index = a2;
  result = a1->_nameIndex;
  if ( result != a3 )
  {
    a1->_nameIndex = a3;
    return Q_RACENEG_CPP_sub_43C80(a1);
  }
  return result;
}

//----- (0003B220) --------------------------------------------------------
char __fastcall sub_3B220(P_Race a1)
{
  P_Race v1; // ebp
  T_Ship *v2; // esi
  int Ships_sub_40224; // eax
  int v4; // ebx
  int v5; // edx
  int v6; // kr04_4
  UBYTE v7; // dl
  T_Race *v8; // ecx
  __int16 i; // di
  int v11[107]; // [esp+0h] [ebp-1CCh] BYREF
  int v12; // [esp+1ACh] [ebp-20h]
  int MoreAllowedShips_sub_3EFE0; // [esp+1B0h] [ebp-1Ch]

  v1 = a1;
  if ( a1->Unknown_03 != 0xFFFFFFFF )
  {
    MoreAllowedShips_sub_3EFE0 = Q_Race_GetMoreAllowedShips_sub_3EFE0(a1);
    if ( MoreAllowedShips_sub_3EFE0 < 0 )
    {
      v12 = Q_Race_GetShips_sub_40224(v1, (P_ShipsList)v11, 0) - 1;
      for ( i = 0; i < -MoreAllowedShips_sub_3EFE0; ++i )
      {
        v2 = (T_Ship *)v11[v12 - i];
        if ( v1->index == V_PlayerRaceIndex )
        {
          Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_SCRAPNEWESTSHIP, v2->hullSize, 0);
        }
        Q_Ship_RemoveFromTheGame_sub_49940(v2);
      }
    }
    Ships_sub_40224 = Q_Race_GetShips_sub_40224(v1, (P_ShipsList)v11, 0);
    sub_3C1C0(v1, (P_Ship *)v11, Ships_sub_40224);
    v4 = Q_Race_GetShips_sub_40224(v1, (P_ShipsList)v11, 0);
    if ( !v4 && !Q_Race_GetPlanetsNum_sub_402E0(v1) )
    {
      v5 = ASCEND_EP_SPECIESEXTINCT;
      LOBYTE(v4) = v1->index;
      v1->Unknown_03 = 0xFFFFFFFF;
LABEL_19:
      LOBYTE(a1) = Q_AddGameEvent_sub_55AEC(&WinMgr, v5, v4, 0);
      return (char)a1;
    }
    if ( v4 > 0 )
    {
      v6 = 0;
      do
      {
        sub_4A6AC((P_Ship)v11[v6++]);
      }
      while ( v6 < 4 * v4 );
    }
    dword_10509C = 0;
    sub_3B5B8(v1);
    sub_405F4(v1);
    LOBYTE(a1) = v1->_homeStar->racesBits & 0x80;
    if ( (_BYTE)a1 )
    {
      v7 = V_PlayerRaceIndex;
      v8 = (T_Race *)(*(_DWORD *)v1->z2 + 1);
      LOBYTE(a1) = v1->index;
      *(_DWORD *)v1->z2 = v8;
      if ( (_BYTE)a1 == v7 )
      {
        if ( v8 )
        {
          a1 = (P_Race)(unsigned __int16)word_968E8[(char)v1->ability];
          if ( a1 == v8 )
          {
            v4 = 0;
            v5 = 0x18;
            goto LABEL_19;
          }
        }
      }
    }
  }
  return (char)a1;
}
// 968E8: using guessed type __int16 word_968E8[21];
// 10509C: using guessed type int dword_10509C;
// 3B220: using guessed type int var_1CC[107];

//----- (0003B38C) --------------------------------------------------------
char __fastcall Q_NC_sub_3B38C(unsigned __int8 *a1)
{
  T_Race *v1; // esi
  int v2; // ecx
  int v3; // ebp
  int v4; // ebp
  __int16 i; // di
  T_Race *v6; // eax
  P_Ship v7; // eax
  P_Ship v8; // eax
  int raceIndex; // ecx
  __int16 k; // di
  _DWORD v12[142]; // [esp+0h] [ebp-5D0h] BYREF
  P_Ship v13[215]; // [esp+250h] [ebp-380h] BYREF
  int Ships_sub_40224; // [esp+5C4h] [ebp-Ch]
  T_Planet *pPlanet; // [esp+5C8h] [ebp-8h]
  __int16 j; // [esp+5CCh] [ebp-4h]

  v1 = (T_Race *)a1;
  LOBYTE(a1) = *a1;
  if ( (_BYTE)a1 == V_PlayerRaceIndex && V_FlashPopExists != 0xFFFFFFFF )
  {
    v2 = 0;
    LOWORD(a1) = 0;
    if ( V_Game.racesNum > 0 )
    {
      v3 = 0;
      do
      {
        if ( (__int16)a1 != v1->index && !v1->treaties[(__int16)a1] )
        {
          ++v2;
          v13[v3 + 0xD6] = (P_Ship)(__int16)a1;
          ++v3;
        }
        LOWORD(a1) = (_WORD)a1 + 1;
      }
      while ( (__int16)a1 < V_Game.racesNum );
    }
    if ( v2 )
    {
      memset(v12, 0, 0x250u);
      v4 = 0;
      for ( i = 0; i < v2; ++i )
      {
        v6 = &V_Game.races[(_DWORD)v13[i + 0xD6]];
        v4 += Q_Race_GetShips_sub_40224(v6, &v13[v4 + 0x6B], 0);
      }
      Ships_sub_40224 = Q_Race_GetShips_sub_40224(v1, v13, 0);
      for ( j = 0; ; ++j )
      {
        LOBYTE(a1) = j;
        if ( j >= Ships_sub_40224 )
        {
          break;
        }
        v7 = v13[j];
        if ( v7->locationType == 5 )
        {
          pPlanet = v7->pLocation.pPlanet;
          if ( !v12[((char *)pPlanet - (char *)V_Game.lanes) / 0x27] )
          {
            v12[((char *)pPlanet - (char *)V_Game.lanes) / 0x27] = 0xFFFFFFFF;
            for ( k = 0; k < v4; ++k )
            {
              v8 = v13[k + 0x6B];
              if ( pPlanet == v8->pLocation.pPlanet )
              {
                raceIndex = v8->raceIndex;
                if ( !v1->treaties[raceIndex] )
                {
                  v1->treaties[raceIndex] = 1;
                  v1->_treatiesScore[raceIndex] = v1->Unknown_1D5;
                  V_Game.races[raceIndex].treaties[v1->index] = 1;
                  V_Game.races[raceIndex]._treatiesScore[v1->index] = V_Game.races[raceIndex].Unknown_1D5;
                  Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_23_LANE_TRANSMISION, (int)v13[j], raceIndex);
                }
              }
            }
          }
        }
      }
    }
  }
  return (char)a1;
}

//----- (0003B56C) --------------------------------------------------------
int __fastcall sub_3B56C(P_Race pRace, P_Location pLocation)
{
  int ShipsAtLocation_sub_1D794; // edi
  __int16 i; // dx
  int result; // eax
  P_Ship v6; // eax
  P_Ship pShip[107]; // [esp+0h] [ebp-1ACh] BYREF

  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(pLocation, pShip);
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= ShipsAtLocation_sub_1D794 )
    {
      break;
    }
    v6 = pShip[i];
    if ( v6 )
    {
      if ( v6->raceIndex == pRace->index )
      {
        Q_Ship_RecalculateTurnResources_sub_4A5B8(v6);
      }
    }
  }
  return result;
}

//----- (0003B5B8) --------------------------------------------------------
void __fastcall sub_3B5B8(T_Race *a1)
{
  int v1; // ebx
  int v2; // edi
  __int16 i; // bx
  WORD v4; // dx
  int v5; // kr04_4
  int v6; // ecx
  int v7; // eax
  int v8; // ecx
  int v9; // eax
  int v10; // ecx
  int v11; // eax
  int v12; // ebp
  int v13; // ecx
  int v14; // eax
  int v15; // ebx
  int v16; // eax
  double v17; // st7
  double v18; // st7
  double v19; // st7
  __int16 j; // si
  P_Ship v21; // ecx
  __int16 v22; // dx
  int v23; // eax
  int v24; // eax
  __int16 v25; // di
  int v26; // edx
  WORD v27; // si
  int v28; // kr0C_4
  int v29; // kr14_4
  int v30; // eax
  int v31; // eax
  int v32; // eax
  P_Planet v33; // kr18_4
  int v34; // kr1C_4
  int v35; // ebp
  int v36; // ecx
  __int16 v37; // si
  int starIndex; // ecx
  __int16 v39; // si
  signed int v40; // ebp
  T_Planet *v41; // ecx
  int v42; // edi
  int v43; // edx
  WORD v44; // bx
  T_Planet *v45; // edx
  WORD k; // bx
  P_Ship pShips[107]; // [esp+0h] [ebp-214h] BYREF
  int v48; // [esp+1ACh] [ebp-68h]
  int v49; // [esp+1B0h] [ebp-64h]
  float v50; // [esp+1B4h] [ebp-60h]
  int Ships_sub_40224; // [esp+1B8h] [ebp-5Ch]
  int v52; // [esp+1BCh] [ebp-58h]
  int v53; // [esp+1C0h] [ebp-54h]
  int v54; // [esp+1C4h] [ebp-50h]
  P_Race pRace; // [esp+1C8h] [ebp-4Ch]
  float v56; // [esp+1CCh] [ebp-48h]
  int v57; // [esp+1D0h] [ebp-44h]
  int v58; // [esp+1D4h] [ebp-40h]
  P_Planet pPlanet; // [esp+1D8h] [ebp-3Ch]
  int v60; // [esp+1DCh] [ebp-38h]
  float v61; // [esp+1E0h] [ebp-34h]
  float v62; // [esp+1E4h] [ebp-30h]
  float v63; // [esp+1E8h] [ebp-2Ch]
  float v64; // [esp+1ECh] [ebp-28h]
  int v65; // [esp+1F0h] [ebp-24h]
  int v66; // [esp+1F4h] [ebp-20h]
  unsigned __int8 v67; // [esp+1F8h] [ebp-1Ch]

  pRace = a1;
  Ships_sub_40224 = Q_Race_GetShips_sub_40224(a1, pShips, 0);
  if ( pRace->index != V_PlayerRaceIndex || V_FlashPopExists == 0xFFFFFFFF )
  {
    sub_3C670(pRace);
    v1 = Ships_sub_40224;
    sub_3C968(pRace);
    sub_44080(pRace);
    sub_3C2E8(pRace, pShips, v1);
  }
  if ( sub_40590(pRace) != 0xFFFFFFFF
    && (V_PlayerRaceIndex != pRace->index || V_FlashPopExists || dword_106FC2 == 0xFFFFFFFF)
    && V_Research.current.project[pRace->index] == 0xFFFF )
  {
    sub_3EA7C(pRace);
  }
  if ( V_PlayerRaceIndex != pRace->index || V_FlashPopExists == 0xFFFFFFFF )
  {
    sub_434E4(pRace, 1);
  }
  v2 = Ships_sub_40224;
  for ( i = 0; i < v2; ++i )
  {
    if ( V_PlayerRaceIndex != pRace->index || V_FlashPopExists == 0xFFFFFFFF )
    {
      sub_3EBDC(pRace, pShips[i]);
    }
  }
  if ( V_PlayerRaceIndex != pRace->index || V_FlashPopExists == 0xFFFFFFFF )
  {
    LOWORD(v66) = Q_Race_GetMoreAllowedShips_sub_3EFE0(pRace);
    if ( (__int16)v66 > 0xA )
    {
      LOWORD(v66) = 0xA;
    }
    if ( (__int16)v66 > 0 )
    {
      v63 = 0.0;
      v61 = 0.0;
      v62 = 0.0;
      v67 = sub_43374(pRace, 0xFFFFFFFF);
      v4 = 0;
      if ( V_Game.starsNum > 0 )
      {
        v5 = 0;
        do
        {
          if ( (V_Game.stars[v5].racesBits & v67) != 0 )
          {
            v10 = *((char *)&dword_104F6D + v4 + 3);
            v11 = dword_104BEC[v4];
            v60 = v11;
            if ( v10 > 1 )
            {
              v60 = v11 >> (v10 - 1);
            }
            v12 = v4;
            v13 = *((char *)&dword_104F09 + v4 + 3);
            v14 = dword_104D7C[v12];
            v15 = dword_104BEC[v12];
            v61 = (double)v60 + v61;
            v16 = v15 + v14;
            v60 = v16;
            if ( v13 > 0 )
            {
              v60 = v16 >> v13;
            }
            v63 = (double)v60 + v63;
          }
          else if ( (V_Game.stars[v5].racePresenceBits & v67) != 0 )
          {
            v6 = *((char *)&dword_104F09 + v4 + 3);
            v7 = dword_104D7C[v4];
            v54 = v7;
            if ( v6 > 0 )
            {
              v54 = v7 >> v6;
            }
            v63 = (double)v54 + v63;
          }
          else
          {
            if ( *((char *)&dword_104FD1 + v4 + 3) <= 0 )
            {
              v62 = (double)dword_104BEC[v4] + v62;
            }
            v8 = *((char *)&dword_104F09 + v4 + 3);
            v9 = dword_104D7C[v4];
            v53 = v9;
            if ( v8 > 0 )
            {
              v53 = v9 >> v8;
            }
            v63 = (double)v53 + v63;
          }
          ++v4;
          ++v5;
        }
        while ( v4 < V_Game.starsNum );
      }
      v62 = v62 * 0.050000001;
      v17 = v61 * 0.6666666666666666;
      v61 = v17;
      v50 = v17 + v63 + v62;
      if ( v50 <= 0.0 )
      {
        v49 = (__int16)v66 / 3;
        v62 = (float)v49;
        v63 = v62;
        v61 = (double)(__int16)v66 - v62 - v62;
      }
      else
      {
        v18 = (double)(__int16)v66;
        v61 = v61 * v18;
        v63 = v63 * v18;
        v62 = v18 * v62;
        v19 = 1.0 / v50;
        v61 = v61 * v19;
        v63 = v63 * v19;
        v62 = v19 * v62;
      }
      for ( j = 0; j < Ships_sub_40224; ++j )
      {
        v21 = pShips[j];
        if ( !v21 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x22A);
        }
        if ( v21->locationType == 1 )
        {
          if ( v21->hasColonizer && v62 > 0.0 )
          {
            v62 = v62 - 1.0;
          }
          else if ( Q_ShipHasGizmo_sub_4A534(pShips[j], 0x49) && v61 > 0.0 )
          {
            v61 = v61 - 1.0;
          }
          else if ( v63 > 0.0 )
          {
            v63 = v63 - 1.0;
          }
        }
      }
      v22 = 0;
      while ( 1 )
      {
        v23 = v22;
        if ( v22 >= 0x64 )
        {
          break;
        }
        ++v22;
        dword_1046E8[v23] = 0;
        dword_104878[v23] = 0;
        dword_104A08[v23] = 0;
      }
      v24 = 0;
      if ( (__int16)v66 > 0 )
      {
        v25 = v66;
        do
        {
          v26 = (__int16)v24++;
          dword_104B98[v26] = 0xFFFFFFFF;
        }
        while ( (__int16)v24 < v25 );
      }
      v27 = 0;
      if ( V_Game.starsNum > 0 )
      {
        v28 = 0;
        do
        {
          if ( ((1 << pRace->index) & V_Game.stars[v28].racesBits) != 0 )
          {
            v29 = 0;
            for ( k = 0; k < V_Game.starsNum; ++v29 )
            {
              if ( ((1 << pRace->index) & V_Game.stars[v29].exploredPathToBits) != 0 )
              {
                v49 = 1 / ((__int16)sub_1DA04((int)&V_Game.stars[v29], (int)&V_Game.stars[v28]) / 0x19 + 1);
                v64 = (float)v49;
                v56 = v64;
                if ( (V_Game.stars[v28].racesBits & v67) != 0 )
                {
                  v32 = *((char *)&dword_104F6D + k + 3);
                  v52 = (int)((double)dword_104BEC[k] * v64);
                  if ( v32 >= 1 )
                  {
                    if ( v32 < 2 )
                    {
                      dword_104A08[v27] += v52 / 2;
                    }
                  }
                  else
                  {
                    dword_104A08[v27] += v52;
                  }
                  if ( *((char *)&dword_104F09 + k + 3) < 1 )
                  {
                    dword_104878[v27] += v52;
                  }
                }
                else if ( (V_Game.stars[v28].racePresenceBits & v67) != 0 )
                {
                  v49 = dword_104BEC[k] + dword_104D7C[k];
                  v30 = *((char *)&dword_104F09 + k + 3);
                  v57 = (int)((double)v49 * v64);
                  if ( v30 < 1 )
                  {
                    dword_104878[v27] += v57;
                  }
                }
                else
                {
                  if ( *((char *)&dword_104FD1 + k + 3) < 1 )
                  {
                    dword_1046E8[v27] = (int)((double)dword_104BEC[k] * v64 * 0.050000001 + (double)dword_1046E8[v27]);
                  }
                  v31 = *((char *)&dword_104F09 + k + 3);
                  v48 = (int)((double)dword_104D7C[k] * v56);
                  if ( v31 < 1 )
                  {
                    dword_104878[v27] += v48;
                  }
                }
              }
              ++k;
            }
          }
          ++v27;
          ++v28;
        }
        while ( v27 < V_Game.starsNum );
      }
      pPlanet = V_Game.planets;
      if ( V_Game.planetsNum > 0 )
      {
        v33 = pPlanet;
        v34 = 0;
        LOWORD(v65) = 0;
        do
        {
          if ( v33[v34].buildingPlanetItemIndex == 0xFF
            && Q_Planet_GetSquareWithItem_sub_35930(&v33[v34], 0x16u) != 0xFFFF
            && v33[v34].raceIndex == pRace->index )
          {
            starIndex = v33[v34].starIndex;
            if ( starIndex >= 0x64 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2A1);
            }
            v58 = (dword_104878[starIndex] + dword_1046E8[starIndex] + dword_104A08[starIndex]) / 0xA;
            v35 = 0;
            v36 = dword_104BC0[0];
            v58 *= v33[v34].industry;
            v37 = 0;
            if ( (__int16)v66 > 0 )
            {
              while ( 1 )
              {
                if ( v37 >= 0xA )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2B1);
                }
                if ( dword_104B98[v37] == 0xFFFFFFFF )
                {
                  break;
                }
                if ( v36 > dword_104BC0[v37] )
                {
                  v35 = v37;
                  v36 = dword_104BC0[v37];
                }
                if ( ++v37 >= (__int16)v66 )
                {
                  goto LABEL_96;
                }
              }
              v35 = v37;
            }
LABEL_96:
            if ( v58 > dword_104BC0[v35] || dword_104B98[v35] == 0xFFFFFFFF )
            {
              dword_104B98[v35] = (__int16)v65;
              dword_104BC0[v35] = v58;
            }
          }
          LOWORD(v65) = v65 + 1;
          ++v34;
        }
        while ( (__int16)v65 < V_Game.planetsNum );
      }
      if ( (__int16)v66 > 0 )
      {
        v39 = 0;
        while ( 1 )
        {
          v40 = dword_104B98[v39];
          if ( v40 <= (int)0xFFFFFFFF || V_Game.planetsNum <= v40 )
          {
            goto LABEL_117;
          }
          v41 = &V_Game.planets[v40];
          if ( !v41 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2D9);
          }
          v42 = v41->starIndex;
          if ( v42 >= 0x64 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x2DD);
          }
          if ( v62 > 0.0 )
          {
            v43 = dword_1046E8[v42];
            if ( v43 > dword_104878[v42] && v43 > dword_104A08[v42] )
            {
              break;
            }
          }
          if ( v63 > 0.0 && dword_104878[v42] > dword_104A08[v42] )
          {
LABEL_116:
            sub_3CB60(pRace, &V_Game.planets[v40], 1u);
            v63 = v63 - 1.0;
            goto LABEL_117;
          }
          if ( v61 <= 0.0 )
          {
            if ( v62 > 0.0 )
            {
              break;
            }
            if ( v63 > 0.0 )
            {
              goto LABEL_116;
            }
          }
          else
          {
            sub_3CB60(pRace, &V_Game.planets[v40], 2u);
            v61 = v61 - 1.0;
          }
LABEL_117:
          if ( ++v39 >= (__int16)v66 )
          {
            goto LABEL_128;
          }
        }
        sub_3CB60(pRace, &V_Game.planets[v40], 0);
        v62 = v62 - 1.0;
        goto LABEL_117;
      }
    }
  }
LABEL_128:
  if ( V_Game.planetsNum > 0 )
  {
    v44 = 0;
    do
    {
      v45 = &V_Game.planets[v44];
      if ( v45->raceIndex == pRace->index
        && (pRace->index != V_PlayerRaceIndex || v45->z7 || V_FlashPopExists)
        && v45->buildingPlanetItemIndex == 0xFF )
      {
        sub_3D8F0((int)pRace, v45);
      }
      ++v44;
    }
    while ( v44 < V_Game.planetsNum );
  }
}
// 1046E8: using guessed type int dword_1046E8[100];
// 104878: using guessed type int dword_104878[100];
// 104A08: using guessed type int dword_104A08[100];
// 104B98: using guessed type int dword_104B98[];
// 104BC0: using guessed type int dword_104BC0[9];
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];
// 104F09: using guessed type int dword_104F09;
// 104F6D: using guessed type int dword_104F6D;
// 104FD1: using guessed type int dword_104FD1;
// 106FC2: using guessed type int dword_106FC2;

//----- (0003C12C) --------------------------------------------------------
// Determines if a ship should be considered for an upgrade
MACRO_VFX_BOOL __fastcall Q_Race_ShouldUpgradeShip_sub_3C12C(P_Race pRace, P_Ship pShip)
{
  int availableCells; // ebp
  int false; // esi
  char bestWeapon; // al
  int bestWeaponDamage; // ebx

  availableCells = pShip->hullCellsNum - pShip->gizmosNum;
  false = FALSE;
  bestWeapon = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_WEAPON, pRace->index);
  if ( bestWeapon <= (char)-1u || bestWeapon >= 0x4C )
  {
    bestWeaponDamage = 0;
  }
  else
  {
    bestWeaponDamage = V_Gizmos[bestWeapon].weaponDamage;
  }
  // 1. If more than 1/3 of hull space is available
  // 2. OR if not a colonizer and doesn't have invasion module AND has potential for better weapons
  // 3. OR if ship is at least rank 1 and has significant upgrade potential (15+)
  if ( 3 * availableCells > pShip->hullCellsNum
    || !pShip->hasColonizer
    && Q_ShipHasGizmo_sub_4A534(pShip, ASCEND_GIZMO_73_INVASION_MODULE) == FALSE
    && bestWeaponDamage > pShip->totalWeaponDamage
    || Q_GetShipRank_sub_4A8CC(pShip) >= 1 && Q_Ship_UpgradePotential_sub_4A1CC(pShip, pRace->index) >= 15 )
  {
    return TRUE;
  }
  return false;
}

//----- (0003C1C0) --------------------------------------------------------
char __fastcall sub_3C1C0(P_Race pRace, P_Ship *shipsArray, int a3)
{
  int moreAllowedShips; // eax
  int raceBitFlag; // ecx
  __int16 v7; // ax
  P_Ship v8; // ecx
  UBYTE locationType; // dl
  BYTE order; // bl
  int i; // edi

  moreAllowedShips = Q_Race_GetMoreAllowedShips_sub_3EFE0(pRace);
  if ( moreAllowedShips < 2 )
  {
    if ( shipsArray )
    {
      if ( a3 > 0 )
      {
        LOBYTE(moreAllowedShips) = pRace->index;
        if ( pRace->index != V_PlayerRaceIndex || V_FlashPopExists == TRUE )
        {
          raceBitFlag = 1 << pRace->index;
          v7 = 0;
          if ( (raceBitFlag & V_Research.techs[ASCEND_TECH_01_INTERPLANETARY_EXPLORATION].knownToRace) != 0 )
          {
            v7 = 1;
            if ( (raceBitFlag & V_Research.techs[ASCEND_TECH_19_ADVANCED_EXPLORATION].knownToRace) != 0 )
            {
              v7 = 2;
              if ( (raceBitFlag & V_Research.techs[ASCEND_TECH_31_LARGE_SCALE_CONSTRUCTION].knownToRace) != 0 )
              {
                v7 = 3;
              }
            }
          }
          if ( !v7 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x365);
          }
          for ( i = 0; i < a3; ++i )
          {
            if ( !&shipsArray[i] )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x36B);
            }
            v8 = shipsArray[i];
            if ( !v8 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x36F);
            }
            locationType = v8->locationType;
            if ( locationType != ASCEND_LOCATION_TYPE_SHIPYARD && locationType != ASCEND_LOCATION_TYPE_SHIPDOCK )
            {
              order = v8->order;
              if ( order != 2 && order != 5 && order != 6 && Q_Race_ShouldUpgradeShip_sub_3C12C(pRace, shipsArray[i]) )
              {
                Q_Ship_RemoveFromTheGame_sub_49940(v8);
              }
            }
            LOBYTE(moreAllowedShips) = a3;
          }
        }
      }
    }
  }
  return moreAllowedShips;
}
// 3C265: conditional instruction was optimized away because ebx.4>=1

//----- (0003C2E8) --------------------------------------------------------
int __fastcall sub_3C2E8(T_Race *a1, P_ShipsList a2, int a3)
{
  int v3; // kr04_4
  int v4; // ebx
  WORD starsNum; // si
  int v6; // esi
  int v7; // eax
  __int16 i; // si
  P_Location v9; // edi
  signed int v10; // ebx
  int pPlanet; // edi
  int result; // eax
  P_Ship v13; // ecx
  UBYTE locationType; // al
  __int16 v17; // [esp+Ch] [ebp-18h]
  char v18; // [esp+10h] [ebp-14h]

  v18 = sub_43374(a1, 0xFFFFFFFF);
  sub_1FD90((int)&V_Game, (int)&dword_105035 + 3, a1->index);
  if ( V_Game.starsNum > 0 )
  {
    v3 = 0;
    v17 = 0;
    do
    {
      v6 = v17;
      dword_104BEC[v6] = sub_1DA4C(&V_Game.stars[v3], a1->index, (int)a2, a3);
      dword_104D7C[v6] = sub_1DB70(&V_Game.stars[v3], a1->index, (int *)a2, a3);
      v7 = *((char *)&dword_105035 + v17 + 3);
      if ( v7 > 0 && (V_Game.stars[v3].racePresenceBits & (unsigned __int8)v18) != 0 )
      {
        dword_104D7C[v17] = 2 * dword_104D7C[v17] + 0x12C + 0x96 * v7;
      }
      v4 = v17;
      starsNum = V_Game.starsNum;
      ++v17;
      *((_BYTE *)&dword_104F09 + v4 + 3) = 0;
      *((_BYTE *)&dword_104F6D + v4 + 3) = 0;
      *((_BYTE *)&dword_104FD1 + v4 + 3) = 0;
      ++v3;
    }
    while ( v17 < starsNum );
  }
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= a3 )
    {
      break;
    }
    v13 = a2[i];
    if ( !v13 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3B3);
    }
    locationType = v13->locationType;
    v10 = 0xFFFFFFFF;
    if ( locationType == 4 )
    {
      pPlanet = (int)v13->pLocation.pPlanet;
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3BB);
      }
LABEL_16:
      v10 = *(__int16 *)(pPlanet + 4);
      goto LABEL_17;
    }
    if ( locationType == 3 )
    {
      v9.pPlanet = (P_Planet)v13->pLocation;
      if ( !v9.pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3C3);
      }
      v10 = *(_DWORD *)((char *)&v9.pPlanet->position.z + 2);
    }
    else if ( locationType == 5 && v13->order == 1 )
    {
      pPlanet = (int)v13->_orderTargetObject.pPlanet;
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x3CC);
      }
      goto LABEL_16;
    }
LABEL_17:
    if ( v10 > (int)0xFFFFFFFF && v10 < V_Game.starsNum )
    {
      if ( v13->hasColonizer )
      {
        ++*((_BYTE *)&dword_104FD1 + v10 + 3);
      }
      else if ( Q_ShipHasGizmo_sub_4A534(v13, 0x49) )
      {
        ++*((_BYTE *)&dword_104F6D + v10 + 3);
      }
      else
      {
        ++*((_BYTE *)&dword_104F09 + v10 + 3);
      }
    }
  }
  return result;
}
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];
// 104F09: using guessed type int dword_104F09;
// 104F6D: using guessed type int dword_104F6D;
// 104FD1: using guessed type int dword_104FD1;
// 105035: using guessed type int dword_105035;

//----- (0003C4EC) --------------------------------------------------------
void __fastcall Q_NC_sub_3C4EC(P_Star pStar, int a2)
{
  __int16 v3; // ax
  int v4; // ebx
  int v5; // eax
  WORD v6; // cx
  int i; // kr04_4
  int v8; // edx
  WORD v9; // bx
  int v10; // kr0C_4
  int v11; // ebx
  __int16 v12; // bx
  int v13; // edx

  if ( a2 )
  {
    *(_WORD *)((char *)&pStar[4].Unknown_18 + 3) = 0;
    if ( ((1 << LOBYTE(pStar->type)) & *(unsigned __int8 *)(*(_DWORD *)((char *)&pStar->Unknown_6 + 1) + 0x14)) != 0 )
    {
      v4 = 0;
      v5 = 0;
      v6 = 0;
      for ( i = 0; v6 < V_Game.starsNum; ++i )
      {
        if ( ((1 << LOBYTE(pStar->type)) & V_Game.stars[i].exploredPathToBits) != 0 )
        {
          v8 = dword_104D7C[v6] + dword_104BEC[v6];
          if ( v6 >= a2 )
          {
            if ( v8 > v5 )
            {
              v4 = v8 + v4 - v5;
              v5 = v4 / a2;
            }
          }
          else
          {
            v4 += v8;
          }
        }
        ++v6;
      }
      v9 = 0;
      if ( V_Game.starsNum > 0 )
      {
        v10 = 0;
        do
        {
          if ( ((1 << LOBYTE(pStar->type)) & V_Game.stars[v10].exploredPathToBits) != 0 && dword_104D7C[v9] + dword_104BEC[v9] >= v5 )
          {
            *(_DWORD *)((char *)&pStar->pos.x + 4 * *(__int16 *)((char *)&pStar[4].Unknown_18 + 3) + 3) = &V_Game.stars[v10];
          }
          ++v9;
          ++v10;
        }
        while ( v9 < V_Game.starsNum );
      }
      if ( !*(_WORD *)((char *)&pStar[4].Unknown_18 + 3) && V_Game.starsNum > 0 )
      {
        v13 = 0;
        do
        {
          v11 = 1 << LOBYTE(pStar->type);
          if ( ((unsigned __int8)v11 & V_Game.stars[v13].racesBits) != 0 && ((unsigned __int8)v11 & V_Game.stars[v13].racePresenceBits) == 0 )
          {
            v12 = *(_WORD *)((char *)&pStar[4].Unknown_18 + 3);
            *(_WORD *)((char *)&pStar[4].Unknown_18 + 3) = v12 + 1;
            *(_DWORD *)((char *)&pStar->pos.x + 4 * v12 + 3) = &V_Game.stars[v13];
          }
          ++v13;
        }
        while ( (__int16)v13 < V_Game.starsNum );
      }
    }
    else
    {
      v3 = *(_WORD *)((char *)&pStar[4].Unknown_18 + 3);
      *(_WORD *)((char *)&pStar[4].Unknown_18 + 3) = v3 + 1;
      *(float *)((char *)&pStar->pos.x + 4 * v3 + 3) = *(float *)((char *)&pStar->Unknown_6 + 1);
    }
  }
}
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];

//----- (0003C670) --------------------------------------------------------
char __fastcall sub_3C670(P_Race a1)
{
  P_Race v1; // ebp
  __int16 v2; // bx
  T_Race *v3; // ecx
  __int16 v4; // si
  int v5; // ecx
  int v6; // eax
  int v7; // edx
  bool v8; // zf
  __int16 v9; // kr02_2
  int v10; // edx
  int index; // ecx
  BYTE v12; // dl
  int i; // edx
  int j; // eax
  int v16; // [esp+0h] [ebp-34h]
  __int16 v17; // [esp+4h] [ebp-30h]
  int v18; // [esp+8h] [ebp-2Ch]
  int v19; // [esp+Ch] [ebp-28h]
  unsigned __int8 v20; // [esp+10h] [ebp-24h]
  unsigned __int8 v21; // [esp+14h] [ebp-20h]
  unsigned __int8 v22; // [esp+18h] [ebp-1Ch]

  v1 = a1;
  if ( V_Game.racesNum > 0 )
  {
    LOWORD(v19) = 0;
    while ( 1 )
    {
      LOBYTE(a1) = v19;
      index = v1->index;
      if ( (__int16)v19 != index && v1->treaties[(__int16)v19] && V_Game.races[(__int16)v19].Unknown_03 != 0xFFFFFFFF )
      {
        break;
      }
LABEL_54:
      LOWORD(v19) = v19 + 1;
      if ( (__int16)v19 >= V_Game.racesNum )
      {
        return (char)a1;
      }
    }
    v12 = v1->treaties[(__int16)v19];
    v2 = 0;
    if ( (unsigned __int8)v12 < 2u )
    {
      v8 = v12 == 1;
    }
    else
    {
      if ( (unsigned __int8)v12 <= 2u )
      {
        v2 = *(_WORD *)&V_Game.Unknown_D8A[6 * (__int16)v19] - *(_WORD *)&V_Game.Unknown_D8A[6 * index];
        if ( v2 >= 0 )
        {
          if ( v2 > 3 )
          {
            v2 = 3;
          }
        }
        else
        {
          v2 = 0;
        }
        goto LABEL_34;
      }
      v8 = v12 == 3;
    }
    if ( v8 )
    {
      if ( v1->treaties[(__int16)v19] == 1 )
      {
        for ( i = 0; i < V_Game.starsNum; ++i )
        {
          if ( ((1 << v1->index) & V_Game.stars[i].racesBits) != 0 && ((1 << v19) & V_Game.stars[i].racePresenceBits) != 0 )
          {
            v16 = unk_96912;
            v17 = *((_WORD *)&unk_96912 + 2);
            v2 += *((_WORD *)&v16 + V_Game.atmosphere);
          }
        }
      }
      v3 = &V_Game.races[(__int16)v19];
      v20 = sub_43374(v3, 0xFFFFFFFF);
      v21 = v20;
      v22 = sub_43374(v3, 0xFFFFFFFF);
      if ( v22 != v20 )
      {
        v4 = 0;
        v18 = 0;
        for ( j = 0; j < V_Game.racesNum; ++j )
        {
          if ( j != (__int16)v19 && j != v1->index )
          {
            if ( ((1 << j) & v21) != 0 )
            {
              v4 += *(_WORD *)&V_Game.Unknown_D8A[6 * j + 2];
            }
            v5 = 1 << j;
            if ( (v22 & (1 << j)) != 0 )
            {
              LOWORD(v5) = *(_WORD *)&V_Game.Unknown_D8A[6 * j + 2];
              v18 += v5;
            }
          }
        }
        if ( v4 <= (__int16)v18 )
        {
          v2 += 3;
        }
        else
        {
          --v2;
        }
        if ( v1->treaties[(__int16)v19] == 1 )
        {
          v6 = *(__int16 *)&V_Game.Unknown_D8A[6 * (__int16)v19];
          v7 = *(__int16 *)&V_Game.Unknown_D8A[6 * v1->index];
          if ( v6 - v7 <= 1 )
          {
            if ( v7 - v6 > 1 )
            {
              v2 += 4;
            }
          }
          else
          {
            v2 -= 2;
          }
        }
      }
    }
LABEL_34:
    LOBYTE(a1) = V_PlayerRaceIndex;
    if ( (__int16)v19 == V_PlayerRaceIndex && V_FlashPopExists == FALSE )
    {
      if ( v2 < 0 )
      {
        LOBYTE(a1) = V_Game.atmosphere;
        if ( V_Game.atmosphere )
        {
          if ( V_Game.atmosphere <= 1u )
          {
            v2 *= 2;
          }
          else if ( V_Game.atmosphere == 2 )
          {
            v2 *= 3;
          }
        }
      }
      else
      {
        LOBYTE(a1) = V_Game.atmosphere;
        if ( V_Game.atmosphere )
        {
          if ( V_Game.atmosphere <= 1u )
          {
            LOWORD(a1) = v2 / 2;
            v2 /= 2;
          }
          else if ( V_Game.atmosphere == 2 )
          {
            LOWORD(a1) = v2 / 3;
            v2 /= 3;
          }
        }
      }
    }
    if ( v2 )
    {
      v9 = v19;
      v1->_treatiesScore[(__int16)v19] += v2;
      v10 = v1->_treatiesScore[v9];
      if ( v10 >= 0x32 )
      {
        if ( v10 > 0x3B6 )
        {
          v1->_treatiesScore[v9] = 0x3B6;
        }
      }
      else
      {
        v1->_treatiesScore[v9] = 0x32;
      }
    }
    goto LABEL_54;
  }
  return (char)a1;
}

//----- (0003C968) --------------------------------------------------------
void __fastcall sub_3C968(P_Race pRace)
{
  double v2; // st7
  float v3; // edx
  double v4; // st7
  WORD v5; // ax
  double Unknown_1DD; // [esp+8h] [ebp-34h]
  double v7; // [esp+8h] [ebp-34h]
  double Unknown_1E5; // [esp+8h] [ebp-34h]
  double Unknown_1E1; // [esp+10h] [ebp-2Ch]
  double v10; // [esp+10h] [ebp-2Ch]
  float Unknown_1D9; // [esp+18h] [ebp-24h]
  float Unknown_1DB; // [esp+1Ch] [ebp-20h]
  float v13; // [esp+20h] [ebp-1Ch]
  float v14; // [esp+24h] [ebp-18h]
  float v15; // [esp+24h] [ebp-18h]
  float v16; // [esp+24h] [ebp-18h]

  if ( V_Game.day % 0xA )
  {
    return;
  }
  v13 = (double)(V_Game.day % pRace->Unknown_1D7) / (double)pRace->Unknown_1D7 * 6.28318530716;
  if ( (LODWORD(v13) & 0x7FFFFFFF) == 0 )
  {
    v13 = 0.0099999998;
  }
  Unknown_1DD = pRace->Unknown_1DD;
  v7 = sin(v13) * Unknown_1DD;
  Unknown_1E1 = pRace->Unknown_1E1;
  v10 = sin(v13 * 0.5) * Unknown_1E1 + v7;
  Unknown_1E5 = pRace->Unknown_1E5;
  v14 = sin(v13 * 2.0) * Unknown_1E5 + v10;
  if ( v14 >= 0.0 )
  {
    v2 = v14 + 0.5;
  }
  else
  {
    v2 = v14 + -0.5;
  }
  v15 = v2;
  Unknown_1D9 = (float)pRace->Unknown_1D9;
  if ( v15 > (double)Unknown_1D9 )
  {
    v3 = (float)pRace->Unknown_1D9;
LABEL_11:
    v15 = v3;
    goto LABEL_12;
  }
  Unknown_1DB = (float)pRace->Unknown_1DB;
  if ( v15 < (double)Unknown_1DB )
  {
    v3 = (float)pRace->Unknown_1DB;
    goto LABEL_11;
  }
LABEL_12:
  if ( pRace->index == V_PlayerRaceIndex )
  {
    word_104BE8 = (int)v15;
  }
  if ( V_Game.atmosphere == 2 )
  {
    v4 = v15 + -6.0;
  }
  else if ( V_Game.atmosphere )
  {
    v4 = v15 + -2.0;
  }
  else
  {
    v4 = v15 + -4.0;
  }
  if ( V_Game.racesNum > 0 )
  {
    v5 = 0;
    do
    {
      if ( pRace->treaties[v5] )
      {
        if ( !V_Game.races[v5].Unknown_03 )
        {
          v16 = v4;
          pRace->_treatiesScore[v5] = (int)((double)pRace->_treatiesScore[v5] + v16);
        }
      }
      ++v5;
    }
    while ( v5 < V_Game.racesNum );
  }
}
// 104BE8: using guessed type __int16 word_104BE8;

//----- (0003CB60) --------------------------------------------------------
int __fastcall sub_3CB60(P_Race pRace, P_Planet pPlanet, unsigned __int8 a3)
{
  T_Ship *v5; // eax
  T_Ship *v6; // ebp
  int squareIndex; // [esp+0h] [ebp-14h]

  if ( pPlanet->industry )
  {
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x16u) == 0xFFFF )
    {
      if ( (V_Game.day > 170 || V_Game.atmosphere == ASCEND_ATMOSPHERE_HOSTILE)
        && ((1 << pRace->index) & V_Research.techs[V_PlanetItems.item[ASCEND_PI_22_SHIPYARD].resReq].knownToRace) != 0 )
      {
        if ( !Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_22_SHIPYARD, 0) )
        {
          return 2;
        }
        return 1;
      }
    }
    else if ( Q_Planet_CanBuildShip_sub_362E0(pPlanet) && (pPlanet->raceIndex != V_PlayerRaceIndex || V_FlashPopExists == TRUE) )
    {
      squareIndex = Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, ASCEND_PI_23_SHIP, 0);
      if ( squareIndex != 0xFFFF )
      {
        v5 = sub_40144(pRace, pPlanet);
        v6 = v5;
        if ( !v5 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x537);
        }
        sub_3F060(pRace, v5, pPlanet, a3);
        Q_Planet_AssignShipToOrbitalSquare_sub_35B04(pPlanet, squareIndex, v6);
        return 1;
      }
    }
  }
  return 0;
}

//----- (0003CC90) --------------------------------------------------------
unsigned int __fastcall Q_NC_sub_3CC90(_BYTE *a1, unsigned __int8 a2)
{
  if ( a2 < 39u && ((1 << *a1) & V_Research.techs[V_PlanetItems.item[a2].resReq].knownToRace) != 0 )
  {
    return 0xFFFFFFFF;
  }
  else
  {
    return 0;
  }
}

//----- (0003CCE4) --------------------------------------------------------
unsigned int __fastcall sub_3CCE4(P_Race pRace, P_Planet pPlanet)
{
  unsigned int v3; // ebp
  int v4; // edi
  int industry; // ebx
  int research; // ebx
  UBYTE planetItemIndex; // al
  UWORD flags; // ax
  P_Square pSquares; // eax
  T_PlanetItem *v10; // ebx
  T_Square *v11; // edi
  int ind; // eax
  int color; // edi
  signed __int8 pros; // al
  int v15; // edi
  P_Square v16; // eax
  signed __int8 res; // ah
  int v18; // edi
  P_Square v19; // eax
  T_Square *v20; // edi
  int resReq; // ebx
  UBYTE v22; // bl
  unsigned __int8 v23; // bh
  int i; // ecx
  int j; // kr0C_4
  _DWORD v27[3]; // [esp+0h] [ebp-F8h]
  int v28; // [esp+Ch] [ebp-ECh]
  int v29; // [esp+10h] [ebp-E8h]
  int v30; // [esp+18h] [ebp-E0h]
  int v31; // [esp+1Ch] [ebp-DCh]
  int v32; // [esp+20h] [ebp-D8h]
  int v33; // [esp+24h] [ebp-D4h]
  int v34; // [esp+28h] [ebp-D0h]
  int v35; // [esp+2Ch] [ebp-CCh]
  int v36; // [esp+30h] [ebp-C8h]
  int v37; // [esp+34h] [ebp-C4h]
  int v38; // [esp+38h] [ebp-C0h]
  int v39; // [esp+3Ch] [ebp-BCh]
  int v40; // [esp+44h] [ebp-B4h]
  int v41; // [esp+48h] [ebp-B0h]
  int v42; // [esp+4Ch] [ebp-ACh]
  int v43; // [esp+50h] [ebp-A8h]
  int v44; // [esp+9Ch] [ebp-5Ch]
  int v45; // [esp+A0h] [ebp-58h]
  int v46; // [esp+A4h] [ebp-54h]
  int v47; // [esp+A8h] [ebp-50h]
  float v48; // [esp+ACh] [ebp-4Ch]
  float v49; // [esp+B0h] [ebp-48h]
  int a3; // [esp+B4h] [ebp-44h]
  float v51; // [esp+B8h] [ebp-40h]
  int v52; // [esp+BCh] [ebp-3Ch]
  float v53; // [esp+C0h] [ebp-38h]
  float v54; // [esp+C4h] [ebp-34h]
  UWORD squareIndex[2]; // [esp+C8h] [ebp-30h]
  int v56; // [esp+CCh] [ebp-2Ch]
  int v57; // [esp+D0h] [ebp-28h]
  int v58; // [esp+D4h] [ebp-24h]
  int v59; // [esp+D8h] [ebp-20h]
  float v60; // [esp+DCh] [ebp-1Ch]
  int a2; // [esp+E0h] [ebp-18h]
  int v62; // [esp+E4h] [ebp-14h]
  int v63; // [esp+E8h] [ebp-10h]
  int v64; // [esp+ECh] [ebp-Ch]
  P_Square v65; // [esp+F0h] [ebp-8h]
  UBYTE v66; // [esp+F4h] [ebp-4h]

  v3 = 0;
  v52 = 0;
  *(_DWORD *)squareIndex = 0xFFFFFFFF;
  v53 = 0.0;
  v51 = 1.0;
  v48 = 1.0;
  v54 = 1.0;
  *(float *)&a3 = 1.0;
  v49 = 1.0;
  v44 = 0;
  v64 = 0;
  v47 = 0;
  v62 = 0;
  a2 = 0;
  v4 = Q_Planet_CalculateSurfaceShieldStrength_sub_36158(pPlanet);
  if ( V_PlanetItems.item[0x13].resReq == 0xFF
    || ((1 << pPlanet->raceIndex) & V_Research.techs[V_PlanetItems.item[0x13].resReq].knownToRace) != 0 )
  {
    a2 = 0xFFFFFFFF;
  }
  if ( V_PlanetItems.item[0x13].resReq == 0xFF
    || ((1 << pPlanet->raceIndex) & V_Research.techs[V_PlanetItems.item[0x13].resReq].knownToRace) != 0 )
  {
    v62 = 0xFFFFFFFF;
  }
  if ( pPlanet->maximumPopulation - pPlanet->word42 > 0 )
  {
    v44 = 0xFFFFFFFF;
  }
  if ( sub_40590(pRace) )
  {
    v52 = 0xFFFFFFFF;
  }
  if ( pPlanet->prosperity < 2u )
  {
    v64 = 0xFFFFFFFF;
    v54 = 2.0;
    v3 = 4;
  }
  if ( pPlanet->freeSurfaceSquaresNum || pPlanet->maximumPopulation - pPlanet->word42 <= 3 || !v62 )
  {
    if ( (unsigned __int16)pPlanet->freeSurfaceSquaresNum > 1u && pPlanet->maximumPopulation - pPlanet->word42 < 2 )
    {
      v3 = 8;
      if ( v44 == 0xFFFFFFFF )
      {
        *(float *)&a3 = 0.0;
      }
    }
  }
  else
  {
    *(float *)&a3 = 0.5;
    v47 = 0xFFFFFFFF;
  }
  if ( v4 < 4 )
  {
    v49 = 2.0;
    if ( !v3 )
    {
      v3 = 0x10;
    }
  }
  if ( v52 )
  {
    v48 = 0.0;
  }
  if ( pPlanet->word42 - pPlanet->word4C <= pPlanet->prosperity || pPlanet->prosperity >= 3u )
  {
    if ( pPlanet->word42 - pPlanet->word4C < pPlanet->prosperity || pPlanet->prosperity > 5u )
    {
      v54 = 0.5;
    }
  }
  else
  {
    v54 = 2.0;
    if ( !v3 )
    {
      v3 = 4;
    }
  }
  industry = pPlanet->industry;
  if ( (unsigned __int16)industry < 0x19u )
  {
    if ( pPlanet->industry )
    {
      v45 = 0x19 / industry;
      v51 = (float)(0x19 / industry);
    }
    else
    {
      v51 = 25.0;
    }
    if ( !v3 )
    {
      v3 = 2;
    }
  }
  if ( !v52 )
  {
    research = pPlanet->research;
    if ( (unsigned __int16)research < 0x19u )
    {
      if ( pPlanet->research )
      {
        v45 = 0x19 / research;
        v51 = (float)(0x19 / research);
      }
      else
      {
        v51 = 25.0;
      }
      if ( !v3 )
      {
        v3 = 1;
      }
    }
  }
  if ( 5 * v4 < 2 * pPlanet->surfaceSquaresNum )
  {
    v49 = 1.5;
    if ( !v3 )
    {
      v3 = 0x10;
    }
  }
  for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
  {
    pSquares = pPlanet->pSquares;
    LOBYTE(pSquares) = pSquares[i].planetItemIndex;
    v58 = 0;
    v57 = 0;
    v59 = 0;
    v56 = 0;
    v46 = 0;
    v10 = &V_PlanetItems.item[(unsigned __int8)pSquares];
    if ( (_BYTE)pSquares != 0xFF
      && (_BYTE)pSquares != 4
      && (_BYTE)pSquares != 6
      && (_BYTE)pSquares != 7
      && (_BYTE)pSquares != 8
      && (_BYTE)pSquares != 0x13
      && (_BYTE)pSquares != 5
      && (_BYTE)pSquares != 0xB
      && (_BYTE)pSquares != 0xC
      && (_BYTE)pSquares != 0xD
      && (_BYTE)pSquares != 0xE
      && (_BYTE)pSquares != 0xF
      && (_BYTE)pSquares != 0x11
      && (_BYTE)pSquares != 0x10
      && ((_BYTE)pSquares != 0x12 || a2 && (v3 == 0x10 || !v3))
      && ((_BYTE)pSquares != 3 || v47)
      && ((_BYTE)pSquares != 0x14 || v44)
      && ((_BYTE)pSquares != 9 && (_BYTE)pSquares != 0xA || v52) )
    {
      v11 = &pPlanet->pSquares[i];
      LOWORD(pSquares) = v11->flags & 1;
      v65 = pSquares;
      HIWORD(ind) = 0;
      if ( (_WORD)v65 )
      {
        if ( v10->ind )
        {
          ind = v10->ind;
          color = v11->color;
          v58 += ind;
          if ( color == 2 )
          {
            ++v58;
          }
        }
        pros = v10->pros;
        if ( pros )
        {
          v15 = pros + v59;
          v16 = pPlanet->pSquares;
          v59 = v15;
          ind = v16[i].color;
          if ( ind == 3 )
          {
            ind = v15 + 1;
            v59 = v15 + 1;
          }
        }
        res = v10->res;
        if ( res )
        {
          v18 = res + v57;
          v19 = pPlanet->pSquares;
          v57 = v18;
          ind = v19[i].color;
          if ( ind == 4 )
          {
            v57 = v18 + 1;
          }
        }
        v20 = &pPlanet->pSquares[i];
        if ( v20->planetItemIndex != 0xFF )
        {
          LOWORD(ind) = v20->flags & 1;
          v65 = (P_Square)ind;
          if ( (_BYTE)ind )
          {
            planetItemIndex = v20->planetItemIndex;
            if ( planetItemIndex >= 0x12u )
            {
              if ( planetItemIndex <= 0x12u )
              {
                v46 += 2;
              }
              else if ( planetItemIndex == 0x13 )
              {
                v46 += 4;
              }
            }
          }
        }
        v56 += v10->mpop;
      }
      v60 = (double)v58 * v51;
      v60 = (double)v57 * v48 + v60;
      v60 = (double)v59 * v54 + v60;
      flags = pPlanet->pSquares[i].flags;
      v60 = (double)v56 * *(float *)&a3 + v60;
      v60 = (double)v46 * v49 + v60;
      if ( (flags & 2) != 0 )
      {
        v60 = v60 + v54;
      }
      if ( *(_DWORD *)squareIndex == 0xFFFFFFFF || v60 < (double)v53 )
      {
        *(_DWORD *)squareIndex = i;
        v53 = v60;
      }
    }
  }
  if ( *(_DWORD *)squareIndex == 0xFFFFFFFF )
  {
    return 0;
  }
  v63 = rand() % 0x64;
  for ( j = 0; j != 0x27; ++j )
  {
    resReq = V_PlanetItems.item[j].resReq;
    if ( resReq == 0xFF || ((1 << pPlanet->raceIndex) & V_Research.techs[resReq].knownToRace) != 0 )
    {
      v27[j] = 0xFFFFFFFF;
    }
    else
    {
      v27[j] = 0;
    }
  }
  v66 = 0xFF;
  v22 = pPlanet->pSquares[*(_DWORD *)squareIndex].planetItemIndex;
  v23 = v22;
  if ( (v22 == 2 || v22 == 9 || v22 == 0xA) && v52 == 0xFFFFFFFF )
  {
    if ( v64 == 0xFFFFFFFF )
    {
      v22 = 1;
    }
    else if ( v63 >= 0x19 )
    {
      v22 = 0;
    }
    else
    {
      v22 = 0x12;
    }
  }
  if ( v3 < 2 )
  {
    if ( !v3 )
    {
      goto LABEL_222;
    }
    if ( !v52 )
    {
      v22 = 2;
      goto LABEL_222;
    }
LABEL_123:
    v22 = 0;
    goto LABEL_222;
  }
  if ( v3 <= 2 )
  {
    goto LABEL_123;
  }
  if ( v3 < 8 )
  {
    v22 = 1;
  }
  else if ( v3 <= 8 )
  {
    v22 = 0x14;
  }
  else
  {
    v22 = 0x12;
  }
LABEL_222:
  if ( v22 < 2u )
  {
    if ( v22 )
    {
      if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xDu) == 0xFFFF && v37 )
      {
        v66 = 0xD;
        goto LABEL_136;
      }
      if ( !v64 && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xFu) == 0xFFFF && v39 )
      {
        v66 = 0xF;
        goto LABEL_136;
      }
      if ( !v64 && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x11u) == 0xFFFF && v40 )
      {
        v66 = 0x11;
        goto LABEL_136;
      }
      if ( !v64 && Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xBu) == 0xFFFF && v35 )
      {
        v66 = 0xB;
        goto LABEL_136;
      }
      if ( v29 && v31 )
      {
        if ( v63 < 0x32 && !v52 )
        {
          v66 = 4;
          goto LABEL_136;
        }
      }
      else
      {
        if ( v29 && !v52 )
        {
          v66 = 4;
          goto LABEL_136;
        }
        if ( !v31 )
        {
          if ( !v33 || v52 )
          {
            if ( v23 != v22 && v27[1] )
            {
              v66 = 1;
            }
          }
          else
          {
            v66 = 9;
          }
          goto LABEL_136;
        }
      }
      v66 = 7;
      goto LABEL_136;
    }
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xCu) == 0xFFFF && v36 )
    {
      v66 = 0xC;
      goto LABEL_136;
    }
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x11u) == 0xFFFF && v40 )
    {
      v66 = 0x11;
      goto LABEL_136;
    }
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xBu) == 0xFFFF && v35 )
    {
      v66 = 0xB;
      goto LABEL_136;
    }
    if ( v29 && v30 )
    {
      if ( v63 < 0x32 && !v52 )
      {
        v66 = 4;
        goto LABEL_136;
      }
    }
    else
    {
      if ( v29 && !v52 )
      {
        v66 = 4;
        goto LABEL_136;
      }
      if ( !v30 )
      {
        if ( !v34 || v52 )
        {
          if ( v23 && v27[0] )
          {
            v66 = 0;
          }
        }
        else
        {
          v66 = 0xA;
        }
        goto LABEL_136;
      }
    }
    v66 = 6;
    goto LABEL_136;
  }
  if ( v22 <= 2u )
  {
    if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xEu) == 0xFFFF && v38 )
    {
      v66 = 0xE;
    }
    else if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x11u) == 0xFFFF && v40 )
    {
      v66 = 0x11;
    }
    else if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0xBu) == 0xFFFF && v35 )
    {
      v66 = 0xB;
    }
    else if ( v32 )
    {
      v66 = 8;
    }
    else if ( v29 )
    {
      v66 = 4;
    }
    else if ( v34 )
    {
      v66 = 0xA;
    }
    else if ( v33 )
    {
      v66 = 9;
    }
    else if ( v23 != v22 && v27[2] )
    {
      v66 = 2;
    }
  }
  else if ( v22 < 0x12u )
  {
    if ( v22 != 3 )
    {
      return 0;
    }
    if ( v29 )
    {
      v66 = 4;
    }
    else if ( v23 != 3 && v28 )
    {
      v66 = 3;
    }
  }
  else if ( v22 <= 0x12u )
  {
    if ( v42 )
    {
      v66 = 0x13;
    }
    else if ( v23 != v22 && v41 )
    {
      v66 = 0x12;
    }
  }
  else
  {
    if ( v22 != 0x14 )
    {
      return 0;
    }
    if ( v29 )
    {
      v66 = 4;
    }
    else if ( v28 )
    {
      v66 = 3;
    }
    else if ( v23 != 0x14 && v43 )
    {
      v66 = 0x14;
    }
  }
LABEL_136:
  if ( v66 < 0x27u && Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, squareIndex[0], v23, 1u) )
  {
    Q_Planet_StartConstruction_sub_34774(pPlanet, v66, *(int *)squareIndex, 0);
    return 0xFFFFFFFF;
  }
  return 0;
}
// 3D3C4: conditional instruction was optimized away because ebp.4==10
// 3D3FB: conditional instruction was optimized away because ebp.4==4

//----- (0003D8F0) --------------------------------------------------------
void __fastcall sub_3D8F0(int a1, P_Planet pPlanet)
{
  int v2; // edi
  int v4; // eax
  T_Planet *v5; // eax
  UBYTE v6; // dl
  int word42; // eax
  int v8; // eax
  int v9; // eax
  int v10; // ebp
  int v11; // eax
  int v12; // ebp
  UBYTE planetItemIndex; // bl
  T_PlanetItem *v14; // ebx
  int upop; // ebx
  int v16; // ebx
  int v17; // ebp
  int v18; // edi
  int v19; // edx
  int resReq; // eax
  UBYTE raceIndex; // cl
  int ind; // ecx
  T_PlanetItem *v23; // eax
  int v24; // ecx
  __int16 v25; // ax
  int v26; // eax
  int v27; // edi
  int v28; // edx
  int v29; // eax
  unsigned __int16 v30; // di
  int i; // kr10_4
  int v32; // ebx
  _BYTE v33[196]; // [esp+6h] [ebp-120h] BYREF
  int v34; // [esp+CAh] [ebp-5Ch] BYREF
  int a2; // [esp+CEh] [ebp-58h] BYREF
  int a4; // [esp+D2h] [ebp-54h] BYREF
  int maximumPopulation; // [esp+D6h] [ebp-50h]
  int v38; // [esp+DAh] [ebp-4Ch]
  T_Race *v39; // [esp+DEh] [ebp-48h]
  int a3; // [esp+E6h] [ebp-40h]
  int v41; // [esp+EAh] [ebp-3Ch]
  unsigned int v42; // [esp+EEh] [ebp-38h]
  int v43; // [esp+F2h] [ebp-34h]
  int v44; // [esp+F6h] [ebp-30h]
  int v45; // [esp+FAh] [ebp-2Ch]
  int v46; // [esp+FEh] [ebp-28h]
  UBYTE *v47; // [esp+102h] [ebp-24h]
  int v48; // [esp+106h] [ebp-20h]
  int v49; // [esp+10Ah] [ebp-1Ch]
  UBYTE v50; // [esp+10Eh] [ebp-18h]

  v39 = (T_Race *)a1;
  v38 = 0;
  v46 = 0;
  Q_Planet_CountBuildableSquaresByColor_sub_34A44(pPlanet, &a2, &v34, &a4);
  if ( sub_40590(v39) == 0xFFFFFFFF )
  {
    v34 += a2;
    a4 += a2;
    a2 = 0;
  }
  v4 = Q_Planet_CountSurfaceBuildings_sub_358F0(pPlanet);
  if ( v4 < 1 )
  {
    if ( v34 > 0 )
    {
LABEL_5:
      v5 = pPlanet;
      v6 = 0;
      goto LABEL_20;
    }
    goto LABEL_18;
  }
  if ( v4 < 2 )
  {
    if ( a4 <= 0 || pPlanet->industry <= 1u )
    {
      goto LABEL_5;
    }
LABEL_18:
    v6 = 1;
    goto LABEL_19;
  }
  if ( v4 >= 3 )
  {
    goto LABEL_21;
  }
  if ( a2 <= 0 || pPlanet->prosperity <= 1u || pPlanet->industry <= 1u )
  {
    if ( v34 > 0 && pPlanet->prosperity > 1u )
    {
      v5 = pPlanet;
      v6 = 0;
      goto LABEL_20;
    }
    goto LABEL_18;
  }
  v6 = 2;
LABEL_19:
  v5 = pPlanet;
LABEL_20:
  if ( Q_Planet_BuildAtOptimalLocation_sub_34AE4(v5, v6, 0xFFFFFFFF) != 0xFFFF )
  {
    return;
  }
LABEL_21:
  if ( !pPlanet->industry )
  {
    return;
  }
  if ( pPlanet->prosperity < 2u )
  {
    word42 = pPlanet->word42;
    if ( pPlanet->maximumPopulation - (unsigned __int16)word42 < 1 && word42 - pPlanet->word4C < 1 )
    {
      v46 = 0xFFFFFFFF;
    }
  }
  v8 = pPlanet->word42;
  if ( pPlanet->maximumPopulation - (unsigned __int16)v8 < 1 && v8 - pPlanet->word4C < 2 )
  {
    v38 = 0xFFFFFFFF;
  }
  v41 = (__int16)sub_3E1CC((int)v39, pPlanet);
  if ( v41 == 1 )
  {
    return;
  }
  v45 = (Q_Planet_CountAvailableBuildSquares_sub_3407C(pPlanet) <= 0) - 1;
  v44 = (Q_Planet_CountTerraformableSquares_sub_3420C(pPlanet) <= 0) - 1;
  v9 = Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, 0x26u, 0xFFFFFFFF);
  v10 = (v9 == 0xFFFF) - 1;
  Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, v9, 0x26u, 1u);
  if ( !pPlanet->freeSurfaceSquaresNum || !v45 && !v44 && !v10 )
  {
    goto LABEL_102;
  }
  if ( v10 == 0xFFFFFFFF )
  {
    sub_3E520((int)v39, pPlanet);
    return;
  }
  if ( v45 != 0xFFFFFFFF )
  {
    if ( ((1 << pPlanet->raceIndex) & V_Research.techs[V_PlanetItems.item[0x24].resReq].knownToRace) != 0 )
    {
      LOWORD(a3) = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, 0x15u);
      a3 = (unsigned __int16)a3;
      if ( (unsigned __int16)a3 == 0xFFFF )
      {
        if ( Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, 0x24u, 0) != 0xFFFF )
        {
          return;
        }
      }
      else
      {
        v30 = a3;
        Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, a3, 0x15u, 1u);
        if ( Q_Planet_CanPlaceItem_sub_34368(pPlanet, 0x24u, v30) )
        {
          Q_Planet_StartConstruction_sub_34774(pPlanet, 0x24u, a3, 0);
          return;
        }
      }
      goto LABEL_102;
    }
    if ( pPlanet->freeSurfaceSquaresNum > (unsigned int)pPlanet->blackSquaresNum
      && v38 != 0xFFFFFFFF
      && Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, 0x15u, 0xFFFFFFFF) != 0xFFFF )
    {
      return;
    }
LABEL_102:
    sub_3CCE4(v39, pPlanet);
    return;
  }
  a3 = 0xFFFFFFFF;
  LOWORD(v11) = pPlanet->word4C;
  v12 = 0;
  if ( (unsigned __int16)v11 < pPlanet->maximumPopulation )
  {
    if ( (unsigned __int16)v11 >= pPlanet->word42 || v41 == 2 )
    {
      return;
    }
  }
  else
  {
    for ( i = 0; i < pPlanet->surfaceSquaresNum; ++i )
    {
      planetItemIndex = pPlanet->pSquares[i].planetItemIndex;
      if ( planetItemIndex != 0xFF && planetItemIndex != 5 )
      {
        v14 = &V_PlanetItems.item[pPlanet->pSquares[i].planetItemIndex];
        if ( !v14->mpop )
        {
          upop = v14->upop;
          if ( upop > v12 )
          {
            v12 = upop;
            a3 = v11;
          }
        }
      }
    }
    if ( a3 == 0xFFFFFFFF )
    {
      Q_debugbreak_sub_26194();
      Q_Planet_Abandon_sub_37040(pPlanet);
      return;
    }
    Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, a3, *(_BYTE *)(v2 + 1), 1u);
    if ( pPlanet->word4C >= pPlanet->word42 )
    {
      return;
    }
  }
  if ( pPlanet->word42 - pPlanet->word4C <= 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x85A);
  }
  if ( v46 || sub_3E520((int)v39, pPlanet) != 0xFFFFFFFF )
  {
    v42 = (__int16)sub_3E800(v39, (unsigned __int16 *)pPlanet);
    if ( v42 == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x870);
    }
    v16 = 0;
    v17 = 0;
    v18 = 0;
    v19 = 0;
    do
    {
      while ( 1 )
      {
        if ( (_BYTE)v16 != 5 && v16 < V_PlanetItems.surfaceItemsNum )
        {
          resReq = V_PlanetItems.item[v18].resReq;
          if ( resReq == 0xFF
            || (raceIndex = pPlanet->raceIndex,
                maximumPopulation = V_Research.techs[resReq].knownToRace,
                ((1 << raceIndex) & maximumPopulation) != 0) )
          {
            maximumPopulation = pPlanet->maximumPopulation;
            if ( V_PlanetItems.item[v18].upop <= maximumPopulation - pPlanet->word4C )
            {
              break;
            }
          }
        }
LABEL_64:
        ++v16;
        ++v18;
        if ( v16 >= 0x27 )
        {
          goto LABEL_77;
        }
      }
      HIWORD(ind) = HIWORD(v42);
      v23 = &V_PlanetItems.item[v18];
      if ( v42 <= 3 )
      {
        switch ( (unsigned int)v23 )
        {
          case 0u:
            ind = v23->ind;
            if ( !v23->ind )
            {
              goto LABEL_64;
            }
            *(_WORD *)&v33[v19 + 1] = v23->ind;
            break;
          case 1u:
            ind = (char)v23->res;
            if ( !v23->res )
            {
              goto LABEL_64;
            }
            *(_WORD *)&v33[v19 + 1] = (char)v23->res;
            break;
          case 2u:
            ind = (char)v23->pros;
            if ( !v23->pros )
            {
              goto LABEL_64;
            }
            *(_WORD *)&v33[v19 + 1] = (char)v23->pros;
            break;
          case 3u:
            ind = v23->mpop;
            if ( !v23->mpop )
            {
              goto LABEL_64;
            }
            *(_WORD *)&v33[v19 + 1] = v23->mpop;
            break;
        }
      }
      LOWORD(ind) = v23->mpop;
      v48 = ind;
      LOWORD(ind) = (char)v23->pros;
      v24 = ind + v48;
      v49 = v24;
      LOWORD(v24) = (char)v23->res;
      ++v17;
      v48 = v24;
      v25 = v23->ind;
      LOWORD(v24) = v24 + v49;
      v33[v19] = v16;
      *(_WORD *)&v33[v19 + 3] = v24 + v25;
      v19 += 5;
      ++v16;
      ++v18;
    }
    while ( v16 < 0x27 );
LABEL_77:
    if ( v17 || sub_3CCE4(v39, pPlanet) != 0xFFFFFFFF )
    {
      v26 = rand();
      v50 = 0xFF;
      v43 = v26 % 0x64;
      if ( v17 > 0 )
      {
        v27 = 0;
        v32 = 0;
        while ( 1 )
        {
          v28 = (unsigned __int8)v33[5 * v32];
          v47 = &v33[5 * v32];
          if ( Q_Planet_GetSquareWithItem_sub_35930(pPlanet, v28) == 0xFFFF )
          {
            break;
          }
          if ( v43 <= 0x41 )
          {
            v29 = *(__int16 *)&v33[5 * v32 + 1];
          }
          else
          {
            v29 = *(__int16 *)&v33[5 * v32 + 3];
          }
          if ( v29 > v27 )
          {
            v27 = v29;
            v50 = *v47;
          }
          if ( ++v32 >= v17 )
          {
            goto LABEL_90;
          }
        }
        if ( V_PlanetItems.item[(unsigned __int8)v33[5 * v32]].cost / (int)pPlanet->industry < 0x46 )
        {
          v50 = v33[5 * v32];
        }
      }
LABEL_90:
      if ( v50 != 0xFF && Q_Planet_BuildAtOptimalLocation_sub_34AE4(pPlanet, v50, 0) == 0xFFFF )
      {
        goto LABEL_102;
      }
    }
  }
}
// 3DBF4: variable 'v2' is possibly undefined

//----- (0003E020) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_3E020(int eax0, P_Planet edx0, unsigned __int8 bl0)
{
  MACRO_VFX_BOOL result; // eax
  int v5; // ebx
  int v6; // eax
  int v7; // edx
  int surfaceSquaresNum; // kr08_4
  signed int v9; // eax
  UBYTE planetItemIndex; // cl
  int i; // kr04_4
  int a3; // [esp+8h] [ebp-18h]
  int a2; // [esp+Ch] [ebp-14h]
  signed int v14; // [esp+10h] [ebp-10h]
  unsigned int v15; // [esp+14h] [ebp-Ch]
  unsigned int v16; // [esp+18h] [ebp-8h]

  if ( bl0 > 0x1Eu || bl0 < 0x16u || bl0 == 0x17 )
  {
    return 0;
  }
  v14 = 0;
  v16 = 0xFFFFFFFF;
  a3 = 0;
  v5 = Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(edx0);
  v15 = 0;
  v6 = Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(edx0);
  v7 = v6;
  if ( bl0 == 0x1A || bl0 == 0x1B )
  {
    v15 = 0xFFFFFFFF;
  }
  else if ( bl0 == 0x1C || bl0 == 0x1D || bl0 == 0x1E )
  {
    a3 = 0xFFFFFFFF;
  }
  a2 = v6 - 3;
  surfaceSquaresNum = edx0->surfaceSquaresNum;
  for ( i = 0; surfaceSquaresNum + i < edx0->totalSquaresNum; ++i )
  {
    planetItemIndex = edx0->pSquares[(unsigned __int16)surfaceSquaresNum + i].planetItemIndex;
    v9 = 0xFFFFFFFF;
    if ( planetItemIndex != 0x1A || bl0 == 0x1A )
    {
      if ( planetItemIndex != 0x1C || bl0 == 0x1C )
      {
        if ( planetItemIndex == 0x1D && bl0 != 0x1D && (!v15 || v7 < v5 - 4) )
        {
          v9 = 4;
          if ( v7 > v5 )
          {
            v9 = 8;
          }
        }
      }
      else if ( !v15 || v7 < v5 - 2 )
      {
        v9 = 2;
        if ( v7 > v5 )
        {
          v9 = 4;
        }
      }
    }
    else if ( !a3 || v5 < a2 )
    {
      v9 = 3;
      if ( v5 > v7 )
      {
        v9 = 6;
      }
    }
    if ( v9 != 0xFFFFFFFF && (v16 == 0xFFFFFFFF || v9 < v14) )
    {
      v16 = surfaceSquaresNum + i;
      v14 = v9;
    }
  }
  if ( v16 == 0xFFFFFFFF )
  {
    return 0;
  }
  result = Q_Planet_HandleItemConstruction_sub_34B0C(edx0, v16, edx0->pSquares[v16].planetItemIndex, 1u);
  if ( result )
  {
    Q_Planet_StartConstruction_sub_34774(edx0, bl0, v16, 0);
    return 0xFFFFFFFF;
  }
  return result;
}

//----- (0003E1CC) --------------------------------------------------------
int __fastcall sub_3E1CC(int eax0, P_Planet a2)
{
  UBYTE v4; // ch
  int research; // ebx
  int v6; // ebp
  int word42; // eax
  int industry; // edx
  int v9; // eax
  int v10; // edx
  int v11; // edx
  unsigned int v13; // [esp+0h] [ebp-14h]
  int v14; // [esp+8h] [ebp-Ch]
  unsigned __int8 BestAvailableOrbitalWeapon_sub_35E24; // [esp+Ch] [ebp-8h]
  unsigned __int8 BestAvailableOrbitalShield_sub_35DA4; // [esp+10h] [ebp-4h]

  v4 = 0xFF;
  v13 = 0;
  research = a2->research;
  if ( sub_40590((P_Race)eax0) )
  {
    research = 0x3E8;
  }
  if ( Q_Planet_CountSurfaceBuildings_sub_358F0(a2) < 5 )
  {
    return 0;
  }
  v14 = Q_Planet_CalculateOrbitalShieldStrength_sub_35FE0(a2);
  v6 = Q_Planet_CalculateOrbitalWeaponStrength_sub_36050(a2);
  BestAvailableOrbitalShield_sub_35DA4 = Q_Planet_GetBestAvailableOrbitalShield_sub_35DA4(a2);
  BestAvailableOrbitalWeapon_sub_35E24 = Q_Planet_GetBestAvailableOrbitalWeapon_sub_35E24(a2);
  if ( (unsigned __int16)a2->freeOrbitalSquaresNum < 2u
    || (word42 = a2->word42, a2->maximumPopulation - (unsigned __int16)word42 < 1) && word42 - a2->word4C < 2
    || a2->prosperity < 2u )
  {
    v13 = 0xFFFFFFFF;
  }
  if ( v14 < 1 && BestAvailableOrbitalShield_sub_35DA4 != 0xFF )
  {
    v4 = BestAvailableOrbitalShield_sub_35DA4;
  }
  if ( v4 == 0xFF && v6 < 1 && BestAvailableOrbitalWeapon_sub_35E24 != 0xFF )
  {
    v4 = BestAvailableOrbitalWeapon_sub_35E24;
  }
  if ( v4 == 0xFF
    && Q_Planet_GetSquareWithItem_sub_35930(a2, 0x16u) == 0xFFFF
    && a2->size > 1u
    && (a2->industry >= 4u || (unsigned __int16)a2->freeSurfaceSquaresNum - (unsigned __int16)a2->blackSquaresNum < 5) )
  {
    if ( (V_Research.techs[V_PlanetItems.item[0x16].resReq].knownToRace & (1 << *(_BYTE *)eax0)) != 0 )
    {
      v4 = 0x16;
    }
  }
  else if ( a2->industry < 4u && Q_Planet_CountAvailableBuildSquares_sub_3407C(a2) > 0 )
  {
    return 0;
  }
  if ( (a2->industry < 0x14u || research < 0x14)
    && Q_Planet_CountAvailableBuildSquares_sub_3407C(a2) > 0
    && (v14 > 0 || BestAvailableOrbitalShield_sub_35DA4 == 0xFF)
    && (v6 > 0 || BestAvailableOrbitalWeapon_sub_35E24 == 0xFF) )
  {
    industry = a2->industry;
    v9 = v6 + v14;
    if ( (unsigned __int16)industry <= research )
    {
      if ( v9 > industry )
      {
        return 0;
      }
    }
    else if ( v9 > research )
    {
      return 0;
    }
  }
  v10 = 0;
  if ( &V_Game.stars[a2->starIndex] == (T_Star *)*(T_Game **)(eax0 + 7) )
  {
    v10 = 6;
  }
  if ( v4 != 0xFF || v6 >= v14 || BestAvailableOrbitalWeapon_sub_35E24 == 0xFF || v6 >= v10 + 6 )
  {
    if ( v4 == 0xFF && BestAvailableOrbitalShield_sub_35DA4 != 0xFF && v10 + 6 > v14 )
    {
      v4 = BestAvailableOrbitalShield_sub_35DA4;
    }
  }
  else
  {
    v4 = BestAvailableOrbitalWeapon_sub_35E24;
  }
  v11 = rand() % 0x64;
  if ( v4 == 0xFF
    && v11 < 0x14
    && Q_Planet_CanPlaceItem_sub_34368(a2, 0x19u, 0xFFFFu)
    && Q_Planet_GetSquareWithItem_sub_35930(a2, 0x19u) == 0xFFFF )
  {
    v4 = 0x19;
  }
  if ( v4 != 0xFF || v6 >= v14 || BestAvailableOrbitalWeapon_sub_35E24 == 0xFF )
  {
    if ( v4 == 0xFF && BestAvailableOrbitalShield_sub_35DA4 != 0xFF )
    {
      v4 = BestAvailableOrbitalShield_sub_35DA4;
    }
  }
  else
  {
    v4 = BestAvailableOrbitalWeapon_sub_35E24;
  }
  if ( v4 != 0xFF )
  {
    if ( !v13 && Q_Planet_BuildAtOptimalLocation_sub_34AE4(a2, v4, 0) != 0xFFFF )
    {
      return 1;
    }
    if ( sub_3E020(eax0, a2, v4) )
    {
      return 1;
    }
    if ( v4 != BestAvailableOrbitalShield_sub_35DA4 || BestAvailableOrbitalWeapon_sub_35E24 == 0xFF )
    {
      if ( v4 == BestAvailableOrbitalWeapon_sub_35E24
        && BestAvailableOrbitalShield_sub_35DA4 != 0xFF
        && sub_3E020(eax0, a2, BestAvailableOrbitalShield_sub_35DA4) )
      {
        return 1;
      }
    }
    else if ( sub_3E020(eax0, a2, BestAvailableOrbitalWeapon_sub_35E24) )
    {
      return 1;
    }
  }
  return 0;
}

//----- (0003E520) --------------------------------------------------------
unsigned int __fastcall sub_3E520(int a1, P_Planet a2)
{
  unsigned int result; // eax
  int v5; // edx
  int word42; // eax
  int v7; // esi
  int surfaceSquaresNum; // edx
  int v9; // eax
  UWORD research; // di
  int v11; // edx
  __int16 i; // di
  UBYTE v13; // si
  int v14; // [esp+0h] [ebp-10h]
  char v15; // [esp+4h] [ebp-Ch]
  UBYTE v16; // [esp+8h] [ebp-8h]
  UBYTE v17; // [esp+Ch] [ebp-4h]

  if ( (a2->flags & 2) != 0 && Q_Planet_BuildAtOptimalLocation_sub_34AE4(a2, 0x26u, 0) != 0xFFFF )
  {
    result = 0xFFFFFFFF;
    a2->flags &= ~2u;
    return result;
  }
  v5 = 3;
  if ( sub_40590((P_Race)a1) == 0xFFFFFFFF )
  {
    v5 = 0;
  }
  if ( a2->industry < 3u )
  {
    return 0;
  }
  if ( a2->research < v5 )
  {
    return 0;
  }
  if ( a2->prosperity < 2u )
  {
    return 0;
  }
  word42 = a2->word42;
  if ( a2->maximumPopulation - (unsigned __int16)word42 < 1 && word42 - a2->word4C < 2 )
  {
    return 0;
  }
  if ( (unsigned __int16)a2->freeSurfaceSquaresNum - (unsigned __int16)a2->blackSquaresNum < 3 )
  {
    return 0;
  }
  v7 = Q_Planet_CalculateSurfaceShieldStrength_sub_36158(a2);
  if ( &V_Game.stars[a2->starIndex] == (T_Star *)*(T_Game **)(a1 + 7) )
  {
    surfaceSquaresNum = a2->surfaceSquaresNum;
  }
  else
  {
    surfaceSquaresNum = 2 * a2->surfaceSquaresNum;
  }
  v9 = surfaceSquaresNum / 5;
  if ( surfaceSquaresNum / 5 < 4 )
  {
    v9 = 4;
  }
  if ( (a2->industry < 0x14u || a2->research < 0x14u) && v7 > 0 )
  {
    research = a2->research;
    v11 = 3 * v7;
    if ( a2->industry <= research )
    {
      if ( v11 <= 2 * a2->industry )
      {
        goto LABEL_25;
      }
    }
    else if ( v11 <= 2 * research )
    {
      goto LABEL_25;
    }
    v9 = v7;
  }
LABEL_25:
  if ( v7 < v9 )
  {
    v16 = 0xFF;
    if ( Q_Planet_CanPlaceItem_sub_34368(a2, 0x13u, 0xFFFFu) )
    {
      v16 = 0x13;
    }
    else if ( Q_Planet_CanPlaceItem_sub_34368(a2, 0x12u, 0xFFFFu) )
    {
      v16 = 0x12;
    }
    if ( v16 != 0xFF && Q_Planet_BuildAtOptimalLocation_sub_34AE4(a2, v16, 0) )
    {
      return 0xFFFFFFFF;
    }
  }
  if ( a2->raceIndex % 2
    && a2->industry > 0x14u
    && rand() % 0x64 < 4
    && Q_Planet_CanPlaceItem_sub_34368(a2, 0xBu, 0xFFFFu)
    && Q_Planet_GetSquareWithItem_sub_35930(a2, 0xBu) == 0xFFFF
    && Q_Planet_BuildAtOptimalLocation_sub_34AE4(a2, 0xBu, 0) )
  {
    return 0xFFFFFFFF;
  }
  v14 = unk_96918;
  v15 = *((_BYTE *)&unk_96918 + 4);
  for ( i = 0; i < 5; ++i )
  {
    v17 = *((_BYTE *)&v14 + i);
    if ( (v17 != 0x25 || (a2->flags & 1) == 0)
      && Q_Planet_CanPlaceItem_sub_34368(a2, v17, 0xFFFFu)
      && (sub_40590((P_Race)a1) == 0xFFFFFFFF || v17 != 0xE) )
    {
      v13 = v17;
      if ( Q_Planet_GetSquareWithItem_sub_35930(a2, v17) == 0xFFFF )
      {
        if ( Q_Planet_BuildAtOptimalLocation_sub_34AE4(a2, v13, 0) )
        {
          return 0xFFFFFFFF;
        }
      }
    }
  }
  return 0;
}

//----- (0003E800) --------------------------------------------------------
int __fastcall sub_3E800(_BYTE *a1, unsigned __int16 *edx0)
{
  int v3; // ebx
  int v4; // eax
  int v5; // eax
  int v7; // eax
  int v8; // eax
  int v9; // ebx
  int v10; // ecx
  LONG v11; // [esp+0h] [ebp-1Ch] BYREF
  int a2; // [esp+4h] [ebp-18h] BYREF
  int v13[5]; // [esp+8h] [ebp-14h] BYREF

  Q_Planet_CountBuildableSquaresByColor_sub_34A44((P_Planet)edx0, &a2, &v11, v13);
  v3 = sub_40590((P_Race)a1);
  if ( v3 == 0xFFFFFFFF )
  {
    v4 = a2;
    a2 = 0;
    v11 += v4;
    v13[0] += v4;
  }
  v5 = edx0[0x21];
  if ( edx0[0x25] - (unsigned __int16)v5 >= 2 || v5 - edx0[0x26] >= 2 )
  {
    if ( edx0[0x22] < 3u && v11 > 0 )
    {
      return 0;
    }
    if ( edx0[0x23] < 3u && a2 > 0 && !v3 )
    {
      return 1;
    }
    if ( edx0[0x24] < 2u && v13[0] > 0 )
    {
      return 2;
    }
    if ( edx0[0x22] < 4u && v11 > 0 )
    {
      return 0;
    }
    if ( edx0[0x24] < 3u && v13[0] > 0 )
    {
      return 2;
    }
    if ( edx0[0x23] < 5u && a2 > 0 && !v3 )
    {
      return 1;
    }
    if ( !edx0[0x24] )
    {
      return 2;
    }
    if ( edx0[0x24] < 2u )
    {
      v7 = edx0[0x21];
      if ( edx0[0x25] - (unsigned __int16)v7 < 1 && v7 - edx0[0x26] < 1 )
      {
        return 2;
      }
    }
    if ( v13[0] > 0 && V_PopGrowthAmount50 / edx0[0x24] > 0xF )
    {
      v8 = edx0[0x21];
      if ( edx0[0x25] - (unsigned __int16)v8 > 3 && v8 - edx0[0x26] != 1 )
      {
        return 2;
      }
    }
    if ( v3 == 0xFFFFFFFF )
    {
      if ( v11 > 0 )
      {
        return 0;
      }
      if ( v13[0] > 0 && edx0[0x24] < 5u )
      {
        return 2;
      }
    }
    else
    {
      HIWORD(v9) = 0;
      LOWORD(v9) = edx0[0x22];
      v10 = edx0[0x23];
      if ( Q_Planet_GetSquareWithItem_sub_35930((P_Planet)edx0, 0xCu) != 0xFFFF )
      {
        v10 += v9 >> 1;
      }
      if ( Q_Planet_GetSquareWithItem_sub_35930((P_Planet)edx0, 0xEu) != 0xFFF )
      {
        v9 += v10 >> 1;
      }
      if ( (v9 > v10 || v11 <= 0) && a2 > 0 )
      {
        return 1;
      }
      if ( v11 > 0 )
      {
        return 0;
      }
      if ( v13[0] > 0 )
      {
        return 2;
      }
    }
  }
  return 3;
}
// 9684C: using guessed type int V_PopGrowthAmount50;
// 3E800: using guessed type int var_14[5];

//----- (0003EA7C) --------------------------------------------------------
__int16 __fastcall sub_3EA7C(_BYTE *a1)
{
  int v2; // eax
  int v3; // edi
  __int16 j; // si
  __int16 k; // ax
  signed __int16 i; // si
  __int16 v8[32]; // [esp+0h] [ebp-90h]
  __int16 v9[24]; // [esp+40h] [ebp-50h] BYREF
  int v10; // [esp+70h] [ebp-20h]
  int v11; // [esp+74h] [ebp-1Ch]

  v10 = 0;
  for ( i = 0; ; ++i )
  {
    LOWORD(v2) = V_Research.num;
    if ( i >= (int)V_Research.num )
    {
      break;
    }
    v3 = (unsigned __int16)v10;
    if ( (unsigned __int16)v10 >= 0x20u )
    {
      break;
    }
    if ( ((1 << *a1) & V_Research.techs[i].knownToRace) == 0 )
    {
      if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, i, (unsigned __int8)*a1) )
      {
        v8[v3] = i;
        v10 = v3 + 1;
      }
    }
  }
  LOWORD(v11) = 0xFFFF;
  if ( (_WORD)v10 )
  {
    qmemcpy(v9, &unk_9691E, 0x2Eu);
    if ( ((1 << *a1) & V_Research.techs[5].knownToRace) != 0 && rand() % 0x64 < 0x2D )
    {
      LOWORD(v11) = 0xFFFE;
    }
    for ( j = 0; j < (int)(unsigned __int16)v10 && (__int16)v11 == 0xFFFFFFFF; ++j )
    {
      for ( k = 0; k < 0x17 && (__int16)v11 == 0xFFFFFFFF; ++k )
      {
        if ( v9[k] == v8[j] )
        {
          LOWORD(v11) = v8[j];
        }
      }
    }
    if ( (v11 & 0x8000u) != 0 )
    {
      LOWORD(v11) = v8[rand() % (unsigned __int16)v10];
    }
    v2 = (unsigned __int8)*a1;
    V_Research.current.project[v2] = v11;
  }
  return v2;
}
// 3EA7C: using guessed type __int16 var_90[32];
// 3EA7C: using guessed type __int16 var_50[24];

//----- (0003EBDC) --------------------------------------------------------
void __fastcall sub_3EBDC(P_Race pRace, P_Ship pShip)
{
  UBYTE locationType; // ah
  P_Star pStar; // esi
  int index; // eax
  int v6; // eax
  int v7; // eax
  P_Planet MostInterestingPlanet_sub_403C0; // eax
  int v9; // eax
  int v10; // ecx
  double v11; // st7
  double v12; // st7
  double v13; // st7
  int racesBits; // eax
  int i; // esi
  P_Star pStar_1; // [esp+4h] [ebp-40h]
  T_Star *v17; // [esp+8h] [ebp-3Ch]
  float v18; // [esp+Ch] [ebp-38h]
  MACRO_VFX_BOOL hasInvasionModule; // [esp+10h] [ebp-34h]
  int racePresenceBits; // [esp+14h] [ebp-30h]
  float v21; // [esp+20h] [ebp-24h]
  float v22; // [esp+20h] [ebp-24h]
  __int16 v23; // [esp+24h] [ebp-20h]
  __int16 v24; // [esp+28h] [ebp-1Ch]
  unsigned __int8 v25; // [esp+2Ch] [ebp-18h]

  locationType = pShip->locationType;
  if ( locationType != ASCEND_LOCATION_TYPE_SHIPYARD
    && locationType != ASCEND_LOCATION_TYPE_SHIPDOCK
    && locationType != ASCEND_LOCATION_TYPE_STARLANE )
  {
    if ( pShip->raceIndex == V_PlayerRaceIndex && V_FlashPopExists == FALSE )
    {
      pShip->order = 0;
      pShip->_orderTargetObject.pPlanet = 0;
      return;
    }
    if ( pShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM && pShip->order == 1 )
    {
      pStar = pShip->pLocation.pStar;
      if ( !pStar )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBBC);
      }
      if ( pShip->hasColonizer )
      {
        index = pStar->index;
        if ( *((char *)&dword_104FD1 + index + 3) > 0 )
        {
          --*((_BYTE *)&dword_104FD1 + index + 3);
        }
      }
      else if ( Q_ShipHasGizmo_sub_4A534(pShip, ASCEND_GIZMO_73_INVASION_MODULE) )
      {
        v6 = pStar->index;
        if ( *((char *)&dword_104F6D + v6 + 3) > 0 )
        {
          --*((_BYTE *)&dword_104F6D + v6 + 3);
        }
      }
      else
      {
        v7 = pStar->index;
        if ( *((char *)&dword_104F09 + v7 + 3) > 0 )
        {
          --*((_BYTE *)&dword_104F09 + v7 + 3);
        }
      }
      pShip->order = 0;
      pShip->_orderTargetObject.pPlanet = 0;
    }
    if ( !pShip->order )
    {
      if ( pShip->locationType == ASCEND_LOCATION_TYPE_ORBIT && Q_Planet_LaunchShip_sub_35C38(pShip->pLocation.pPlanet, pShip) != 0xFFFFFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBE7);
      }
      if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBEB);
      }
      pStar_1 = pShip->pLocation.pStar;
      if ( !pStar_1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xBEF);
      }
      if ( pShip->hasColonizer == 0xFFFFFFFF )
      {
        MostInterestingPlanet_sub_403C0 = Q_Race_GetMostInterestingPlanet_sub_403C0(pRace, pShip->pLocation.pStar);
        if ( MostInterestingPlanet_sub_403C0 )
        {
          pShip->order = 2;
          pShip->_orderTargetObject.pPlanet = MostInterestingPlanet_sub_403C0;
          return;
        }
      }
      if ( pShip->totalStarLaneDrivePotential > 0 || pShip->totalStarLaneHyperdrivePotential > 0 )
      {
        v18 = 0.0;
        v23 = 0;
        v17 = 0;
        hasInvasionModule = Q_ShipHasGizmo_sub_4A534(pShip, ASCEND_GIZMO_73_INVASION_MODULE);
        v25 = sub_43374(pRace, 0xFFFFFFFF);
        for ( i = 0; ; ++i )
        {
          if ( i >= V_Game.starsNum )
          {
            if ( v17 && v17 != pStar_1 && sub_4AA78(pShip, v17) > 0 && v23 != pStar_1->index )
            {
              if ( pShip->hasColonizer )
              {
                ++*((_BYTE *)&dword_104FD1 + v23 + 3);
              }
              else if ( hasInvasionModule )
              {
                ++*((_BYTE *)&dword_104F6D + v23 + 3);
              }
              else
              {
                ++*((_BYTE *)&dword_104F09 + v23 + 3);
              }
            }
            return;
          }
          if ( dword_104BEC[i] > 0 || dword_104D7C[i] > 0 )
          {
            break;
          }
LABEL_56:
          ;
        }
        v24 = sub_4AA78(pShip, &V_Game.stars[i]);
        racesBits = V_Game.stars[i].racesBits;
        racePresenceBits = V_Game.stars[i].racePresenceBits;
        if ( ((racesBits | racePresenceBits) & v25) != 0 )
        {
          if ( pShip->hasColonizer )
          {
            if ( ((unsigned __int8)racesBits & v25) != 0 && (v25 & (unsigned __int8)racePresenceBits) == 0 )
            {
              if ( *((char *)&dword_104FD1 + i + 3) <= 0 )
              {
                v12 = (double)dword_104BEC[i];
                goto LABEL_53;
              }
LABEL_35:
              v21 = 0.0;
              goto LABEL_54;
            }
LABEL_36:
            v21 = 0.0;
            goto LABEL_54;
          }
          if ( hasInvasionModule )
          {
            if ( ((unsigned __int8)racesBits & v25) == 0 )
            {
              goto LABEL_35;
            }
            v9 = *((char *)&dword_104F6D + i + 3);
            v21 = (float)dword_104BEC[i];
            if ( v9 <= 1 )
            {
              goto LABEL_54;
            }
            LOBYTE(v10) = v9 - 1;
          }
          else
          {
            if ( ((unsigned __int8)racesBits & v25) != 0 )
            {
              v11 = (double)(dword_104D7C[i] + dword_104BEC[i]);
            }
            else
            {
              v11 = (double)dword_104D7C[i];
            }
            v21 = v11;
            if ( *((char *)&dword_104F09 + i + 3) <= 0 )
            {
              goto LABEL_54;
            }
            LOBYTE(v10) = *((_BYTE *)&dword_104F09 + i + 3);
          }
        }
        else
        {
          if ( pShip->hasColonizer )
          {
            if ( *((char *)&dword_104FD1 + i + 3) > 0 )
            {
              goto LABEL_36;
            }
            v12 = (double)dword_104BEC[i];
LABEL_53:
            v21 = v12;
            goto LABEL_54;
          }
          if ( hasInvasionModule )
          {
            v21 = *(float *)&pShip->hasColonizer;
            goto LABEL_54;
          }
          v10 = *((char *)&dword_104F09 + i + 3);
          v21 = (float)dword_104D7C[i];
          if ( v10 <= 0 )
          {
LABEL_54:
            v13 = v21 / (double)(v24 / 0x19 + 1);
            if ( v13 > v18 )
            {
              v17 = &V_Game.stars[i];
              v23 = i;
              v22 = v13;
              v18 = v22;
            }
            goto LABEL_56;
          }
        }
        v12 = v21 / (double)(1 << v10);
        goto LABEL_53;
      }
    }
  }
}
// 104BEC: using guessed type int dword_104BEC[100];
// 104D7C: using guessed type int dword_104D7C[99];
// 104F09: using guessed type int dword_104F09;
// 104F6D: using guessed type int dword_104F6D;
// 104FD1: using guessed type int dword_104FD1;

//----- (0003EFE0) --------------------------------------------------------
// Calculates the allowed ships for a race based on systems controled.
// The formula is: (1 + exclusively controlled stars + home star bonus) - current ship count
int __fastcall Q_Race_GetMoreAllowedShips_sub_3EFE0(P_Race pRace)
{
  int allowedShips; // ebx
  int totalRaceShips; // ebp
  int i; // eax

  allowedShips = 1;
  totalRaceShips = Q_Race_GetShips_sub_40224(pRace, 0, 0);
  for ( i = 0; (__int16)i < V_Game.starsNum; ++i )
  {
    if ( V_Game.stars[i].racesBits == 1 << pRace->index )
    {
      // 1 for every exclusively controlled system 
      ++allowedShips;
    }
  }
  return allowedShips - totalRaceShips;
}
/* Orphan comments:
Add 1 if have colonies in home system
*/

//----- (0003F060) --------------------------------------------------------
void __fastcall sub_3F060(P_Race pRace, P_Ship pShip, P_Planet pPlanet, unsigned __int8 a4)
{
  int raceIndexMask; // eax
  __int16 affordableHullSize; // cx
  int cost; // edx
  char gizmoShield; // bl
  char gizmoLane; // bh
  __int16 dayFactor; // [esp+2h] [ebp-24h]
  __int16 wantHullSize; // [esp+6h] [ebp-20h]
  char gizmoGenerator; // [esp+Ah] [ebp-1Ch]
  char gizmoWeapon; // [esp+Eh] [ebp-18h]
  char gizmoDrive; // [esp+12h] [ebp-14h]

  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xCD0);
  }
  wantHullSize = 0;
  raceIndexMask = 1 << pRace->index;
  if ( (raceIndexMask & V_Research.techs[ASCEND_TECH_01_INTERPLANETARY_EXPLORATION].knownToRace) != 0 )
  {
    wantHullSize = 1;
    if ( (raceIndexMask & V_Research.techs[ASCEND_TECH_19_ADVANCED_EXPLORATION].knownToRace) != 0 )
    {
      wantHullSize = 2;
      if ( (raceIndexMask & V_Research.techs[ASCEND_TECH_31_LARGE_SCALE_CONSTRUCTION].knownToRace) != 0 )
      {
        wantHullSize = 3;
      }
    }
  }
  if ( !wantHullSize )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xCE2);
  }
  dayFactor = V_Game.day / 250;
  affordableHullSize = wantHullSize;
  if ( dayFactor >= 1 )
  {
    if ( dayFactor > 8 )
    {
      dayFactor = 8;
    }
  }
  else
  {
    dayFactor = 1;
  }
  while ( affordableHullSize >= 0 )
  {
    Q_Ship_SetSize_sub_49148(pShip, affordableHullSize);
    cost = Q_Ship_GetCost_sub_4A18C(pShip) + pShip->hullCellsNum * dayFactor;
    if ( !pPlanet->industry )
    {
      pPlanet->industry = 1;
    }
    if ( cost / pPlanet->industry + 1 < pRace->Unknown_1B0 )
    {
      break;
    }
    --affordableHullSize;
  }
  if ( affordableHullSize < 0 )
  {
    affordableHullSize = 0;
  }
  Q_Ship_SetSize_sub_49148(pShip, affordableHullSize);
  gizmoWeapon = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_WEAPON, pRace->index);
  gizmoGenerator = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_GENERATOR, pRace->index);
  gizmoDrive = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_DRIVE, pRace->index);
  gizmoShield = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_SHIELD, pRace->index);
  gizmoLane = ASCEND_GIZMO_43_STAR_LANE_DRIVE;
  if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE) )
  {
    gizmoLane = ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE;
  }
  if ( gizmoGenerator == (char)0xFF )
  {
    gizmoGenerator = ASCEND_GIZMO_27_PROTON_SHAVER;
  }
  if ( gizmoDrive == (char)0xFF )
  {
    gizmoDrive = ASCEND_GIZMO_16_TONKLIN_MOTOR;
  }
  if ( gizmoWeapon == (char)0xFF )
  {
    gizmoWeapon = ASCEND_GIZMO_00_MASS_BARRAGE_GUN;
  }
  if ( gizmoShield == (char)0xFF )
  {
    gizmoShield = ASCEND_GIZMO_10_ION_WRAP;
  }
  switch ( affordableHullSize )
  {
    case 0:
      Q_Race_BuildSmallShip_sub_3F324(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    case 1:
      Q_Race_BuildMediumShip_sub_3F3F8(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    case 2:
      Q_Race_BuildLargeShip_sub_3F784(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    case 3:
      Q_Race_BuildEnormousShip_sub_3FBAC(pRace, gizmoGenerator, gizmoDrive, gizmoWeapon, gizmoShield, gizmoLane, pShip, a4);
      break;
    default:
      return;
  }
}
// 3F0F5: conditional instruction was optimized away because %wantHullSize.2 is in (1..3)

//----- (0003F324) --------------------------------------------------------
void __fastcall Q_Race_BuildSmallShip_sub_3F324(P_Race pRace, char a2, char a3, char a4, int a5, char a6, P_Ship pShip, unsigned __int8 a8)
{
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a3, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, 2);
  if ( a8 )
  {
    if ( a8 > 1u && a8 == 2 )
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, 3);
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, 4);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, 3);
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, 4);
    }
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, 3);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_71_COLONIZER, 4);
  }
}

//----- (0003F3F8) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Race_BuildMediumShip_sub_3F3F8(
        P_Race pRace,
        BYTE a2,
        BYTE a3,
        BYTE a4,
        BYTE a5,
        BYTE a6,
        P_Ship pShip,
        unsigned __int8 a8)
{
  int v9; // ecx
  int v10; // edi
  int v11; // ecx
  int v12; // ecx
  MACRO_VFX_BOOL result; // eax
  int v14; // edx
  BYTE v15; // dl
  int v16; // ebx
  int v17; // ebx
  int v18; // ebx
  int v19; // ecx
  int v20; // ecx
  int v21; // ebx
  int v22; // ebx
  int v23; // ecx
  int v24; // edx
  BYTE v25; // dl
  int v26; // ebx
  int v27; // ecx
  int v28; // ebx
  int v29; // ecx
  int v30; // ebx
  int v31; // ecx
  int v32; // edx
  BYTE v33; // dl
  int v34; // ebx
  BYTE v36; // [esp+9h] [ebp-13h]
  void *retaddr; // [esp+1Ch] [ebp+0h]

  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a3, 2);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, 3);
  v9 = 4;
  if ( pShip->totalGeneratorPower < 8 )
  {
    v9 = 5;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 4);
  }
  v10 = v9 + 1;
  if ( !a8 )
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v9);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v10);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v9 + 2);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v9 + 3);
    v12 = v9 + 5;
    result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, v10 + 3);
    if ( v10 + 4 >= 0xA )
    {
      return result;
    }
    while ( 1 )
    {
      v14 = rand() % 0x64;
      if ( v14 > 0x4B )
      {
        break;
      }
      if ( v14 > 0x32 )
      {
        v15 = BYTE1(retaddr);
        goto LABEL_17;
      }
      if ( v14 <= 0x19 )
      {
        v15 = a6;
        goto LABEL_17;
      }
      result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v12++);
LABEL_18:
      if ( v12 >= 0xA )
      {
        return result;
      }
    }
    v15 = v36;
LABEL_17:
    v16 = v12++;
    result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v15, v16);
    goto LABEL_18;
  }
  if ( a8 > 1u && a8 == 2 )
  {
    if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 5) )
    {
      v28 = v9;
      v27 = v9 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v28);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 5, v9);
      v27 = v9 + 1;
    }
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v27);
    v29 = v27 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v29++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v29);
    v30 = v29 + 1;
    v31 = v29 + 2;
    result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v30);
    if ( v31 >= 0xA )
    {
      return result;
    }
    while ( 1 )
    {
      v32 = rand() % 0x64;
      if ( v32 > 0x4B )
      {
        break;
      }
      if ( v32 > 0x32 )
      {
        v33 = BYTE1(retaddr);
        goto LABEL_48;
      }
      if ( v32 <= 0x19 )
      {
        v33 = a6;
        goto LABEL_48;
      }
      result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v31++);
LABEL_49:
      if ( v31 >= 0xA )
      {
        return result;
      }
    }
    v33 = v36;
LABEL_48:
    v34 = v31++;
    result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v33, v34);
    goto LABEL_49;
  }
  if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 5) )
  {
    v17 = v9;
    v11 = v9 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v17);
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 5, v9);
    v11 = v9 + 1;
  }
  v18 = v11;
  v19 = v11 + 1;
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v18);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v19++);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v19);
  v20 = v19 + 1;
  if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 0x24) )
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x24, v20++);
  }
  if ( a6 == 0x2B || V_Game.day > 0x320 || *(__int16 *)&V_Game.Unknown_D8A[6 * pRace->index] >= 3 )
  {
    v21 = v20++;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, v21);
  }
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v20);
  v22 = v20 + 1;
  v23 = v20 + 2;
  result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v22);
  if ( v23 < 0xA )
  {
    while ( 1 )
    {
      v24 = rand() % 0x64;
      if ( v24 > 0x42 )
      {
        break;
      }
      if ( v24 <= 0x21 )
      {
        v25 = a5;
        goto LABEL_33;
      }
      result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v23++);
LABEL_34:
      if ( v23 >= 0xA )
      {
        return result;
      }
    }
    v25 = v36;
LABEL_33:
    v26 = v23++;
    result = Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v25, v26);
    goto LABEL_34;
  }
  return result;
}
// 3F538: variable 'v36' is possibly undefined

//----- (0003F784) --------------------------------------------------------
void __fastcall Q_Race_BuildLargeShip_sub_3F784(
        P_Race pRace,
        BYTE a2,
        BYTE a3,
        BYTE a4,
        BYTE a5,
        BYTE a6,
        P_Ship pShip,
        unsigned __int8 a8)
{
  int v8; // esi
  int v9; // ebp
  int v10; // esi
  int v11; // esi
  int v12; // esi
  int v13; // edx
  int v14; // ebx
  int v15; // ebx
  BYTE v16; // dl
  int v17; // ebx
  int v18; // esi
  int v19; // ebx
  int v20; // esi
  int v21; // esi
  int v22; // ecx
  int v23; // esi
  BYTE v24; // dl
  int v25; // esi
  int v26; // ebx
  int v27; // esi
  int v28; // ebx
  int v29; // esi
  int v30; // edx
  int v31; // ebx
  int v32; // ebx
  BYTE v33; // dl

  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 2);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a3, 3);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, 4);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, 5);
  v8 = 6;
  if ( pShip->totalGeneratorPower < 0x10 )
  {
    v8 = 7;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, 6);
  }
  v9 = v8 + 1;
  if ( a8 )
  {
    if ( a8 <= 1u || a8 != 2 )
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v8);
      v10 = v8 + 1;
      if ( a4 == 7 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 7) )
      {
        v17 = v10;
        v11 = v10 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v17);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 7, v10);
        v11 = v10 + 1;
      }
      if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, 5) )
      {
        v19 = v11;
        v18 = v11 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v19);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 5, v11);
        v18 = v11 + 1;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v18);
      v20 = v18 + 1;
      if ( a6 == ASCEND_GIZMO_43_STAR_LANE_DRIVE )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_43_STAR_LANE_DRIVE, v20++);
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v20);
      v21 = v20 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_57_ACCUTRON) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_57_ACCUTRON, v21++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_36_RECALLER) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_36_RECALLER, v21++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_65_REPLENISHER) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_65_REPLENISHER, v21++);
      }
      v22 = v21 + 2;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_70_PHASE_BOMB, v21);
      v23 = v21 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_35_BRUNSWIK_DISSIPATOR) )
      {
        v24 = 0x23;
      }
      else
      {
        if ( !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_33_MOLECULAR_TIE_DOWN) )
        {
LABEL_40:
          sub_40084(pRace, pShip, v23, a2);
          return;
        }
        v24 = 0x21;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v24, v23);
      v23 = v22;
      goto LABEL_40;
    }
    if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_05_PLASMATRON) )
    {
      v26 = v8;
      v25 = v8 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a4, v26);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 5, v8);
      v25 = v8 + 1;
    }
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v25);
    v27 = v25 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v27++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v27++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, ASCEND_GIZMO_73_INVASION_MODULE, v27++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v27);
    v28 = v27 + 1;
    v29 = v27 + 2;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, v28);
    while ( v29 < 0xF )
    {
      v30 = rand() % 0x64;
      if ( v30 <= 0x4B )
      {
        if ( v30 <= 0x32 )
        {
          if ( v30 <= 0x19 )
          {
            v32 = v29;
            v33 = a6;
          }
          else
          {
            v33 = 0x49;
            v32 = v29;
          }
        }
        else
        {
          v32 = v29;
          v33 = a5;
        }
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v33, v32);
        ++v29;
      }
      else
      {
        v31 = v29++;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, v31);
      }
    }
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v8);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v9);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v8 + 2);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x47, v8 + 3);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, 0x49, v8 + 4);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a5, v8 + 5);
    v12 = v8 + 7;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a6, v9 + 5);
    if ( v9 + 6 < 0xF )
    {
      do
      {
        v13 = rand() % 0x64;
        if ( v13 <= 0x50 )
        {
          if ( v13 <= 0x3C )
          {
            if ( v13 <= 0x28 )
            {
              if ( v13 <= 0x14 )
              {
                v15 = v12;
                v16 = a6;
              }
              else
              {
                v16 = 0x47;
                v15 = v12;
              }
            }
            else
            {
              v16 = 0x49;
              v15 = v12;
            }
          }
          else
          {
            v15 = v12;
            v16 = a5;
          }
          Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, v16, v15);
          ++v12;
        }
        else
        {
          v14 = v12++;
          Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, a2, v14);
        }
      }
      while ( v12 < 0xF );
    }
  }
}

//----- (0003FBAC) --------------------------------------------------------
void __fastcall Q_Race_BuildEnormousShip_sub_3FBAC(
        T_Race *eax0,
        char a2,
        char a3,
        char a4,
        char a5,
        char a6,
        _DWORD *pShip,
        unsigned __int8 a8)
{
  int v8; // esi
  int v9; // ebp
  int v10; // ebx
  int v11; // esi
  int v12; // esi
  int v13; // esi
  int v14; // edx
  int v15; // ebx
  int v16; // ebx
  char v17; // dl
  int v18; // ebx
  int v19; // esi
  int v20; // ebx
  int v21; // esi
  int v22; // ebx
  int v23; // esi
  int v24; // esi
  int v25; // ebp
  int v26; // esi
  int v27; // esi
  BYTE v28; // dl
  int v29; // esi
  int v30; // ebx
  int v31; // esi
  int v32; // ebx
  int v33; // esi
  int v34; // edx
  int v35; // ebx
  int v36; // ebx
  char v37; // dl

  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 0);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 1);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 2);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 3);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a3, 4);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a3, 5);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, 6);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, 7);
  Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a5, 8);
  v8 = 9;
  if ( (int)pShip[6] < 0x18 )
  {
    v8 = 0xA;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, 9);
  }
  if ( a6 == 0x2B )
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x2B, v8++);
  }
  v9 = v8 + 1;
  if ( a8 )
  {
    if ( a8 <= 1u || a8 != 2 )
    {
      v10 = v8;
      v11 = v8 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v10);
      if ( a4 == 7 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 7) )
      {
        v18 = v11;
        v12 = v11 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v18);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 7, v11);
        v12 = v11 + 1;
      }
      if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 5) )
      {
        v20 = v12;
        v19 = v12 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v20);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 5, v12);
        v19 = v12 + 1;
      }
      if ( a4 == 8 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 8) )
      {
        v22 = v19;
        v21 = v19 + 1;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v22);
      }
      else
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 8, v19);
        v21 = v19 + 1;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v21);
      v23 = v21 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v23);
      v24 = v23 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x39) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x39, v24++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x24) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x24, v24++);
      }
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x41) )
      {
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x41, v24++);
      }
      v25 = v24 + 4;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x46, v24);
      v26 = v24 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x46, v26++);
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, v26);
      v27 = v26 + 1;
      if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x23) )
      {
        v28 = 0x23;
      }
      else
      {
        if ( !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 0x21) )
        {
LABEL_44:
          sub_40084(eax0, (P_Ship)pShip, v27, a2);
          return;
        }
        v28 = 0x21;
      }
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, v28, v27);
      v27 = v25;
      goto LABEL_44;
    }
    if ( a4 == 5 || !Q_Ship_GizmoIsResearchedByRace_sub_4A404((P_Ship)pShip, 5) )
    {
      v30 = v8;
      v29 = v8 + 1;
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a4, v30);
    }
    else
    {
      Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 5, v8);
      v29 = v8 + 1;
    }
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v29);
    v31 = v29 + 1;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v31++);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a5, v31);
    v32 = v31 + 1;
    v33 = v31 + 2;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a6, v32);
    while ( v33 < 0x19 )
    {
      v34 = rand() % 0x64;
      if ( v34 <= 0x4B )
      {
        if ( v34 <= 0x32 )
        {
          if ( v34 <= 0x19 )
          {
            v36 = v33;
            v37 = a6;
          }
          else
          {
            v37 = 0x49;
            v36 = v33;
          }
        }
        else
        {
          v36 = v33;
          v37 = a5;
        }
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, v37, v36);
        ++v33;
      }
      else
      {
        v35 = v33++;
        Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, v35);
      }
    }
  }
  else
  {
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v9);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8 + 2);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8 + 3);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x47, v8 + 4);
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, 0x49, v8 + 5);
    v13 = v8 + 7;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a5, v9 + 5);
    if ( v9 + 6 < 0x19 )
    {
      do
      {
        v14 = rand() % 0x64;
        if ( v14 <= 0x50 )
        {
          if ( v14 <= 0x3C )
          {
            if ( v14 <= 0x28 )
            {
              if ( v14 <= 0x14 )
              {
                v16 = v13;
                v17 = a6;
              }
              else
              {
                v17 = 0x47;
                v16 = v13;
              }
            }
            else
            {
              v17 = 0x49;
              v16 = v13;
            }
          }
          else
          {
            v16 = v13;
            v17 = a5;
          }
          Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, v17, v16);
          ++v13;
        }
        else
        {
          v15 = v13++;
          Q_Ship_PutNewGizmoIntoCell_sub_492AC((P_Ship)pShip, a2, v15);
        }
      }
      while ( v13 < 0x19 );
    }
  }
}

//----- (00040084) --------------------------------------------------------
void __fastcall sub_40084(P_Race pRace, P_Ship pShip, int startCell, BYTE restGizmoIndex)
{
  __int16 researched; // cx
  int j; // eax
  int v6; // esi
  int v7; // edi
  BYTE v8; // al
  int v9; // ebx
  __int16 i; // bx
  BYTE rgizmos[28]; // [esp+4h] [ebp-44h]
  BYTE qgizmos[20]; // [esp+20h] [ebp-28h] BYREF
  int k; // [esp+34h] [ebp-14h]
  BYTE restGizmoIndex_; // [esp+38h] [ebp-10h]

  k = startCell;
  restGizmoIndex_ = restGizmoIndex;
  researched = 0;
  qmemcpy(qgizmos, "E?2.-&%\"/74@62&%B=01", sizeof(qgizmos));
  for ( i = 0; i < 20; ++i )
  {
    if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, qgizmos[i]) )
    {
      j = researched++;
      rgizmos[j] = qgizmos[i];
    }
  }
  while ( k < pShip->hullCellsNum && researched )
  {
    v6 = rand() % researched;
    v7 = k + 1;
    --researched;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, rgizmos[v6], k);
    v8 = rgizmos[researched];
    k = v7;
    rgizmos[v6] = v8;
  }
  while ( k < pShip->hullCellsNum )
  {
    v9 = k++;
    Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, restGizmoIndex_, v9);
  }
}

//----- (00040144) --------------------------------------------------------
T_Ship *__fastcall sub_40144(P_Race pRace, P_Planet pPlanet)
{
  T_Ship *vpShip1; // eax
  T_Ship *vpShip2; // ecx
  UWORD industry; // di
  int day; // edx
  unsigned __int16 Cost_sub_4A18C; // [esp+0h] [ebp-14h]

  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF3C);
  }
  if ( Q_Race_GetMoreAllowedShips_sub_3EFE0(pRace) > 0 )
  {
    vpShip1 = sub_20684(&V_Game, pRace->index);
    vpShip2 = vpShip1;
    if ( !vpShip1 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF45);
    }
    Cost_sub_4A18C = Q_Ship_GetCost_sub_4A18C(vpShip1);
    if ( !Cost_sub_4A18C )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF51);
    }
    industry = pPlanet->industry;
    if ( !industry )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0xF54);
    }
    day = V_Game.day;
    vpShip2->locationType = 1;
    vpShip2->pLocation.pPlanet = pPlanet;
    vpShip2->_dayBuilt = day + Cost_sub_4A18C / (int)industry + 1;
    return vpShip2;
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\race.cpp", 0xF40);
    return 0;
  }
}
// 401AC: conditional instruction was optimized away because eax.4!=0

//----- (00040218) --------------------------------------------------------
int __fastcall Q_CompareShipsByDayBuilt_sub_40218(P_Ship *ppShip1, P_Ship *ppShip2)
{
  return (*ppShip1)->_dayBuilt - (*ppShip2)->_dayBuilt;
}

//----- (00040224) --------------------------------------------------------
// Builds ships list
// Returns number of ships
int __fastcall Q_Race_GetShips_sub_40224(P_Race pRace, P_ShipsList pShipsList, int *totalSize)
{
  T_Ship *ships; // eax
  int j; // esi
  __int16 i; // cx
  P_ShipsList vpShipsList; // [esp+4h] [ebp-1Ch]
  int shipsNum; // [esp+8h] [ebp-18h]
  int raceIndex; // [esp+Ch] [ebp-14h]

  vpShipsList = pShipsList;
  ships = V_Game.ships;
  j = 0;
  shipsNum = 0;
  if ( totalSize )
  {
    *totalSize = 0;
  }
  for ( i = 0; i < 107 && j < V_Game.shipsNum; ++i )
  {
    raceIndex = ships->raceIndex;
    if ( raceIndex != 0xFFFFFFFF )
    {
      ++j;
      if ( raceIndex == pRace->index )
      {
        if ( vpShipsList )
        {
          *pShipsList = ships;
        }
        ++pShipsList;
        ++shipsNum;
        if ( totalSize )
        {
          *totalSize += ships->hullSize + 1;
        }
      }
    }
    ++ships;
  }
  if ( vpShipsList )
  {
    qsort(vpShipsList, shipsNum, 4u, (int (__fastcall *)(const void *, const void *))Q_CompareShipsByDayBuilt_sub_40218);
  }
  return shipsNum;
}

//----- (000402E0) --------------------------------------------------------
int __fastcall Q_Race_GetPlanetsNum_sub_402E0(P_Race pRace)
{
  int count; // ebx
  int i; // eax
  int v4; // edx

  count = 0;
  i = 0;
  v4 = 0;
  while ( i < V_Game.planetsNum )
  {
    if ( V_Game.planets[v4].raceIndex == pRace->index )
    {
      ++count;
    }
    ++v4;
    ++i;
  }
  return count;
}

//----- (000403C0) --------------------------------------------------------
P_Planet __fastcall Q_Race_GetMostInterestingPlanet_sub_403C0(P_Race pRace, P_Star pStar)
{
  int withBlack; // ebp
  P_Planet pPlanet; // ebx
  unsigned __int16 squaresValue; // ax
  P_Lane pLane; // ecx
  P_Star pStar1; // ebx
  __int16 v8; // ax
  int racesBits; // ebx
  __int16 v12; // bx
  WORD i; // cx
  P_Planet pPlanet_; // [esp+0h] [ebp-28h]
  unsigned __int16 v15; // [esp+4h] [ebp-24h]
  unsigned __int16 maxValue; // [esp+8h] [ebp-20h]
  __int16 v17; // [esp+Ch] [ebp-1Ch]

  maxValue = 0;
  pPlanet_ = 0;
  v12 = 0;
  if ( V_Game.racesNum > 0 )
  {
    while ( V_Game.races[v12].Unknown_03 == 0xFFFFFFFF
         || v12 == pRace->index
         || pRace->treaties[v12] != ASCEND_TREATY_ALLIANCE
         || ((1 << v12) & pStar->racesBits) == 0 )
    {
      if ( ++v12 >= V_Game.racesNum )
      {
        goto LABEL_9;
      }
    }
    return 0;
  }
LABEL_9:
  withBlack = (pRace->ability != ASCEND_SA_BUILD_ON_BLACK) - 1;
  for ( i = 0; i < pStar->planetsNum; ++i )
  {
    pPlanet = pStar->planets[i];
    if ( pPlanet->raceIndex == 0xFF )
    {
      squaresValue = Q_Planet_GetSquaresValue_sub_3636C(pStar->planets[i], withBlack);
      if ( (pPlanet->flags & ASCEND_PF_02_HAS_XENO_RUINS) != 0 )
      {
        squaresValue += 40;
      }
      if ( squaresValue > maxValue )
      {
        maxValue = squaresValue;
        pPlanet_ = pPlanet;
      }
    }
  }
  v15 = 70;
  if ( pStar->racesBits )
  {
    v8 = 0;
    if ( V_Game.racesNum > 0 )
    {
      while ( 1 )
      {
        if ( pRace->treaties[v8] == ASCEND_TREATY_WAR )
        {
          racesBits = pStar->racesBits;
          if ( ((1 << v8) & racesBits) != 0 && ((1 << pRace->index) & racesBits) == 0 )
          {
            break;
          }
        }
        if ( ++v8 >= V_Game.racesNum )
        {
          goto LABEL_34;
        }
      }
      v15 = 0;
    }
  }
  else
  {
    v15 = 35;
    v17 = 0;
    if ( pStar->lanesNum > 0 )
    {
      while ( 1 )
      {
        pLane = pStar->_lanes[v17];
        if ( !pLane )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x100E);
        }
        pStar1 = pLane->pStar1;
        if ( pStar == pLane->pStar1 )
        {
          pStar1 = pLane->pStar2;
        }
        if ( ((1 << pRace->index) & pStar1->racesBits) != 0 )
        {
          break;
        }
        if ( ++v17 >= pStar->lanesNum )
        {
          goto LABEL_34;
        }
      }
      v15 = 17;
    }
  }
LABEL_34:
  if ( maxValue <= v15 )
  {
    return 0;
  }
  return pPlanet_;
}

//----- (00040590) --------------------------------------------------------
int __fastcall sub_40590(P_Race pRace)
{
  int i; // edx

  if ( !dword_10509C )
  {
    dword_1050A0 = 0xFFFFFFFF;
    for ( i = 0; i < V_Research.num; ++i )
    {
      if ( ((1 << pRace->index) & V_Research.techs[i].knownToRace) == 0 )
      {
        dword_1050A0 = 0;
        break;
      }
    }
    dword_10509C = 0xFFFFFFFF;
  }
  return dword_1050A0;
}
// 10509C: using guessed type int dword_10509C;
// 1050A0: using guessed type int dword_1050A0;

//----- (000405F4) --------------------------------------------------------
unsigned int __fastcall sub_405F4(P_Race pRace)
{
  unsigned int v2; // esi
  WORD v3; // dx
  T_Planet *pPlanet; // eax
  UBYTE raceIndex; // cl

  v2 = 0;
  if ( sub_40590(pRace) && V_Game.planetsNum > 0 )
  {
    v3 = 0;
    do
    {
      pPlanet = &V_Game.planets[v3];
      raceIndex = pPlanet->raceIndex;
      if ( raceIndex == pRace->index && (raceIndex != V_PlayerRaceIndex || pPlanet->z7 || V_FlashPopExists) )
      {
        if ( sub_3623C(pPlanet) )
        {
          v2 = 0xFFFFFFFF;
        }
      }
      ++v3;
    }
    while ( v3 < V_Game.planetsNum );
  }
  return v2;
}

//----- (00040664) --------------------------------------------------------
int __fastcall Q_Race_GetTechsNum_sub_40664(P_Race ppRace)
{
  int v2; // ebx
  int v3; // edx
  int v4; // eax

  v2 = 0;
  v3 = 0;
  v4 = 0;
  while ( v3 < V_Research.num )
  {
    if ( ((1 << ppRace->index) & *(char *)(v4 + 0x1052A2)) != 0 )
    {
      ++v2;
    }
    v4 += 0x4B;
    ++v3;
  }
  return v2;
}

//----- (000406C4) --------------------------------------------------------
int __fastcall sub_406C4(P_Race pRace, P_Star pStar, P_Target pTarget)
{
  UBYTE raceIndex; // cl
  int ShipsAtLocation_sub_1D794; // ebp
  P_Ship v6; // esi
  __int16 v7; // bx
  BYTE order; // dh
  __int16 v9; // ax
  P_Location v10; // ecx
  int v11; // edx
  int v12; // ebx
  char v13; // cl
  P_Star homeStar; // eax
  unsigned int v15; // ebx
  UBYTE racesBits; // ch
  __int16 v17; // si
  P_Ship pShip; // ebx
  int GizmoHullCellIndex_sub_4937C; // eax
  int result; // eax
  unsigned __int8 v21; // al
  unsigned int v22; // ebp
  int v23; // ebx
  P_Location v24; // esi
  __int16 k; // ax
  int v26; // ebx
  P_Ship vpShip; // esi
  __int16 availablePower; // cx
  __int16 m; // bx
  P_Ship v30; // edx
  P_TargetObject v31; // eax
  int v32; // eax
  int v33; // edx
  P_TargetObject v34; // ebx
  UBYTE v35; // al
  signed __int16 industry; // di
  int y_low; // ecx
  int v38; // eax
  P_Target v39; // eax
  int v40; // eax
  P_Target v41; // eax
  UBYTE v42; // dl
  int state; // eax
  P_Target v44; // eax
  P_Target v45; // eax
  T_Planet *vpPlanet; // ecx
  UBYTE locationType; // bl
  T_Planet *pPlanet; // eax
  int v49; // eax
  UBYTE index; // al
  __int16 v51; // cx
  P_Target v52; // eax
  __int16 v53; // bx
  __int16 v54; // ax
  __int16 i; // cx
  __int16 j; // dx
  __int16 v57; // dx
  P_Ship ships[107]; // [esp+0h] [ebp-3CCh] BYREF
  P_Ship ships2[107]; // [esp+1ACh] [ebp-220h] BYREF
  int v60[5]; // [esp+358h] [ebp-74h] BYREF
  __int16 v61[8]; // [esp+36Ch] [ebp-60h] BYREF
  int v62; // [esp+37Ch] [ebp-50h]
  int v63; // [esp+380h] [ebp-4Ch]
  P_Target v64; // [esp+384h] [ebp-48h]
  int v65; // [esp+388h] [ebp-44h]
  int v66; // [esp+38Ch] [ebp-40h]
  int v67; // [esp+390h] [ebp-3Ch]
  P_Location vpLocation; // [esp+394h] [ebp-38h]
  int v69; // [esp+398h] [ebp-34h]
  int v70; // [esp+39Ch] [ebp-30h]
  __int16 v71; // [esp+3A0h] [ebp-2Ch]
  __int16 v72; // [esp+3A4h] [ebp-28h]
  int v73; // [esp+3A8h] [ebp-24h]
  int v74; // [esp+3ACh] [ebp-20h]
  int v75; // [esp+3B0h] [ebp-1Ch]
  int v76; // [esp+3B4h] [ebp-18h]
  unsigned __int8 v77; // [esp+3B8h] [ebp-14h]

  vpLocation.pStar = pStar;
  v64 = pTarget;
  if ( !pTarget )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1081);
  }
  raceIndex = pRace->index;
  v77 = vpLocation.pStar->racesBits | vpLocation.pStar->racePresenceBits;
  if ( ((1 << raceIndex) & v77) == 0 )
  {
    return 0;
  }
  sub_3B56C(pRace, vpLocation);
  LOWORD(v76) = 0;
  LOWORD(v73) = 0;
  LOWORD(v74) = 0;
  LOWORD(v70) = 0;
  v65 = 0;
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(vpLocation, ships);
  for ( i = 0; i < ShipsAtLocation_sub_1D794; ++i )
  {
    v6 = ships[i];
    if ( !v6 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x10AC);
    }
    if ( v6->raceIndex == pRace->index && v6->availablePower > 0 && v6->locationType != ASCEND_LOCATION_TYPE_SHIPYARD )
    {
      v7 = LOWORD(v6->availableMoves) + v70;
      LOWORD(v74) = LOWORD(v6->availablePower) + v74;
      ships2[(__int16)v76] = v6;
      LOWORD(v70) = v7;
      order = v6->order;
      LOWORD(v76) = v76 + 1;
      if ( order )
      {
        v65 = 0xFFFFFFFF;
      }
    }
  }
  v9 = 0;
  if ( SLOWORD(vpLocation.pPlanet->z7) > 0 )
  {
    v10.pPlanet = vpLocation.pPlanet;
    do
    {
      v11 = *((_DWORD *)&v10.pPlanet->research + v9);
      if ( *(_BYTE *)(v11 + 0x57) == pRace->index )
      {
        v12 = (__int16)v73;
        LOWORD(v73) = v73 + 1;
        v60[v12] = v11;
      }
      ++v9;
    }
    while ( v9 < SLOWORD(vpLocation.pPlanet->z7) );
  }
  if ( !(_WORD)v76 && !(_WORD)v73 )
  {
    return 0;
  }
  if ( vpLocation.pPlanet == (P_Planet)pRace->_homeStar
    || !(_WORD)v76
    || V_PlayerRaceIndex == pRace->index
    || ((1 << pRace->index) & V_Research.techs[V_Gizmos[0x24].resReq].knownToRace) == 0 )
  {
    goto LABEL_39;
  }
  v13 = sub_43374(pRace, 0xFFFFFFFF);
  homeStar = pRace->_homeStar;
  v15 = 0;
  racesBits = homeStar->racesBits;
  if ( (racesBits & 0x7F) == 0 )
  {
    v15 = 0xFFFFFFFF;
  }
  if ( !v15 )
  {
    v15 = 0;
    if ( ((unsigned __int8)v13 & (unsigned __int8)(racesBits | homeStar->racePresenceBits)) != 0 )
    {
      v15 = 0xFFFFFFFF;
    }
  }
  if ( v15 && (v17 = 0, (__int16)v76 > 0) )
  {
    while ( 1 )
    {
      pShip = ships2[v17];
      if ( pShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
      {
        if ( pShip->availablePower )
        {
          GizmoHullCellIndex_sub_4937C = Q_Ship_FindGizmoHullCellIndex_sub_4937C(ships2[v17], 0x24u);// Recaller
          if ( GizmoHullCellIndex_sub_4937C != 0xFFFFFFFF )
          {
            pShip->Unknown_62 = 1;
            pShip->pCurHullCell = &pShip->hullCells[GizmoHullCellIndex_sub_4937C];
            pShip->_target.type = 5;
            if ( (sub_49B3C(pShip, 0) & 1) != 0 )
            {
              break;
            }
          }
        }
      }
      if ( ++v17 >= (__int16)v76 )
      {
        goto LABEL_39;
      }
    }
    v64->type = 3;
    v64->pObject.pPlanet = (P_Planet)ships2[v17];
    return 0xFFFFFFFF;
  }
  else
  {
LABEL_39:
    v21 = 1;
    v22 = 0;
    LOWORD(v75) = 0;
    v62 = 0;
    for ( j = 0; j < 7; ++j )
    {
      v66 = v21;
      if ( (v21 & v77) != 0 )
      {
        v23 = (__int16)v75;
        v24.pPlanet = vpLocation.pPlanet;
        v61[v23] = j;
        if ( ((unsigned __int8)v66 & HIBYTE(v24.pPlanet->size)) != 0 )
        {
          LOBYTE(v61[v23]) |= 8u;
        }
        if ( (v21 & vpLocation.pPlanet->size) != 0 )
        {
          LOBYTE(v61[(__int16)v75]) |= 0x10u;
        }
        if ( pRace->treaties[j] == 2 )
        {
          if ( V_PlayerRaceIndex != pRace->index || V_FlashPopExists == 0xFFFFFFFF || (HIBYTE(vpLocation.pPlanet->size) & v21) != 0 )
          {
            v22 = 0xFFFFFFFF;
            LOBYTE(v61[(__int16)v75]) |= 0x20u;
          }
        }
        else if ( pRace->index != V_PlayerRaceIndex
               && j == V_PlayerRaceIndex
               && ((1 << pRace->index) & (unsigned __int8)byte_D8460[SLOWORD(vpLocation.pPlanet->position.y)]) != 0 )
        {
          v22 = 0xFFFFFFFF;
          LOBYTE(v61[(__int16)v75]) |= 0x20u;
        }
        LOWORD(v75) = v75 + 1;
      }
      v21 *= 2;
    }
    if ( (__int16)v75 <= 0 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1133);
    }
    if ( (__int16)v75 == 1 )
    {
      v62 = 0xFFFFFFFF;
    }
    if ( !v62 && !v22 && (pRace->index != V_PlayerRaceIndex || V_FlashPopExists == 0xFFFFFFFF) )
    {
      LOWORD(v69) = 0;
      do
      {
        v71 = v61[(__int16)v69] & 7;
        if ( pRace->treaties[(unsigned __int8)v71] == 3 )
        {
          for ( k = 0; k < (__int16)v75; ++k )
          {
            v26 = v61[k] & 7;
            if ( V_Game.races[v71].treaties[(unsigned __int8)v26] == 2 && pRace->treaties[v26] != 3 )
            {
              v22 = 0xFFFFFFFF;
              LOBYTE(v61[k]) |= 0x20u;
            }
          }
        }
        LOWORD(v69) = v69 + 1;
      }
      while ( (__int16)v69 < (__int16)v75 );
    }
    if ( v22 != 0xFFFFFFFF
      || V_PlayerRaceIndex == pRace->index && V_FlashPopExists != 0xFFFFFFFF && WinMgr.state != 0x10
      || (result = sub_41268(
                     &pRace->index,
                     v75,
                     (__int16)v76,
                     (int)v61,
                     (char *)vpLocation.pPlanet,
                     (int)ships2,
                     v73,
                     (int)v60,
                     (__int16)v74,
                     (__int16)v70,
                     (int)vpLocation.pPlanet,
                     (int)v64),
          result != 0xFFFFFFFF) )
    {
      if ( V_PlayerRaceIndex == pRace->index && !v65 && V_FlashPopExists == FALSE )
      {
        return 0;
      }
      vpShip = 0;
      availablePower = 0;
      for ( m = 0; m < (__int16)v76; ++m )
      {
        if ( !ships2[m]->order && (pRace->index != V_PlayerRaceIndex || V_FlashPopExists == 0xFFFFFFFF) )
        {
          sub_3EBDC(pRace, ships2[m]);
        }
        v30 = ships2[m];
        if ( availablePower < v30->availablePower && v30->order )
        {
          vpShip = ships2[m];
          availablePower = v30->availablePower;
        }
      }
      if ( !vpShip )
      {
        return 0;
      }
      switch ( vpShip->order )
      {
        case 1:
          if ( vpShip->locationType == ASCEND_LOCATION_TYPE_ORBIT )
          {
            Q_Planet_LaunchShip_sub_35C38(vpShip->pLocation.pPlanet, vpShip);
          }
          if ( vpShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1188);
          }
          if ( pRace->index != V_PlayerRaceIndex
            && sub_1D834(vpLocation.pStar, pRace->index) == 0xFFFFFFFF
            && vpShip->hasColonizer != 0xFFFFFFFF
            && Q_ShipHasGizmo_sub_4A534(vpShip, 0x49) == TRUE )// Invasion Module
          {
            return 0;
          }
          v31.pPlanet = (P_Planet)vpShip->_orderTargetObject;
          if ( v31.pPlanet != vpLocation.pPlanet )
          {
            v34.pPlanet = (P_Planet)vpShip->_orderTargetObject;
            v35 = V_Game.starConnections[SLOWORD(vpLocation.pPlanet->position.y)][SLOWORD(v31.pPlanet->position.y)];
            v63 = 0;
            industry = vpLocation.pPlanet->industry;
            v72 = v35;
            v57 = 0;
            if ( industry > 0 )
            {
              while ( 1 )
              {
                v67 = *(_DWORD *)&vpLocation.pPlanet->name[4 * v57 + 8];
                if ( vpLocation.pPlanet == *(P_Planet *)v67 )
                {
                  v38 = 0x64 * *(__int16 *)(*(_DWORD *)(v67 + 4) + 4);
                  y_low = SLOWORD(v34.pPlanet->position.y);
                }
                else
                {
                  y_low = 0x64 * *(__int16 *)(*(_DWORD *)v67 + 4);
                  v38 = SLOWORD(v34.pPlanet->position.y);
                }
                if ( V_Game.starConnections[0][y_low + v38] == v72 - 1 )
                {
                  break;
                }
                if ( ++v57 >= (__int16)vpLocation.pPlanet->industry )
                {
                  goto LABEL_115;
                }
              }
              v63 = 0xFFFFFFFF;
            }
LABEL_115:
            if ( v63 != 0xFFFFFFFF )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x11CC);
            }
            if ( (*(_BYTE *)(v67 + 0x23) & 2) != 0 && sub_4A480(vpShip, 0, (P_TargetObject)v67) )
            {
              v39 = v64;
              v64->type = 3;
              v39->pObject.pPlanet = (P_Planet)vpShip;
            }
            else
            {
              vpShip->Unknown_62 = 0;
              v40 = v67;
              vpShip->pCurHullCell = 0;
              vpShip->_target.pObject.pPlanet = (P_Planet)v40;
              v41 = v64;
              vpShip->_target.type = 2;
              v41->type = 3;
              v41->pObject.pPlanet = (P_Planet)vpShip;
            }
            goto LABEL_121;
          }
          v32 = (int)vpLocation.pPlanet ^ (int)v31.pPlanet;
          v33 = vpShip->raceIndex;
          LOBYTE(v32) = V_PlayerRaceIndex;
          vpShip->order = 0;
          if ( v33 != v32 || V_FlashPopExists == 0xFFFFFFFF )
          {
            sub_3EBDC(pRace, vpShip);
          }
          result = 0xFFFFFFFF;
          break;
        case 2:
          vpPlanet = vpShip->_orderTargetObject.pPlanet;
          if ( !vpShip->hasColonizer )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x123F);
          }
          if ( vpPlanet->raceIndex == 0xFF )
          {
            locationType = vpShip->locationType;
            if ( locationType == 3 )
            {
              pPlanet = vpShip->pLocation.pPlanet;
              if ( vpPlanet == pPlanet )
              {
                v49 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(vpShip, 0x47u);// Colonizer
                if ( v49 == 0xFFFFFFFF )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x125A);
                }
                Q_Ship_RemoveGizmoFromCell_sub_492F8(vpShip, v49);
                index = pRace->index;
                vpPlanet->word42 = 2;
                vpPlanet->raceIndex = index;
                vpPlanet->dayColonized = V_Game.day;
                Q_Planet_BuildAtOptimalLocation_sub_34AE4(vpPlanet, 5u, 0xFFFFFFFF);// Colony Base
                --vpShip->availablePower;
                LOBYTE(vpLocation.pPlanet->size) |= 1 << pRace->index;
                v51 = v74 - 1;
                vpShip->order = 0;
                LOWORD(v74) = v51;
              }
              else
              {
                Q_Planet_LaunchShip_sub_35C38(pPlanet, vpShip);
                if ( vpShip->locationType != 4 )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1252);
                }
              }
            }
            else
            {
              if ( locationType != 4 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x126C);
              }
              vpShip->Unknown_62 = 0;
              vpShip->pCurHullCell = 0;
              vpShip->_target.type = 1;
              v52 = v64;
              vpShip->_target.pObject.pPlanet = vpPlanet;
              v52->type = 3;
              v52->pObject.pPlanet = (P_Planet)vpShip;
            }
          }
          else
          {
            vpShip->order = 0;
          }
          goto LABEL_121;
        case 3:
          if ( vpShip->raceIndex != V_PlayerRaceIndex )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x11F3);
          }
          v42 = vpShip->locationType;
          if ( v42 == 3 )
          {
            if ( vpShip->pLocation.pPlanet != vpShip->_orderTargetObject.pPlanet )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x11F7);
            }
            state = WinMgr.state;
            vpShip->order = 0;
            if ( state != 0x10 )
            {
              Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_16_ENTERED_ORBIT, (int)vpShip, (int)vpShip->_orderTargetObject.pPlanet);
            }
          }
          else if ( v42 == 4 )
          {
            vpShip->Unknown_62 = 0;
            vpShip->pCurHullCell = 0;
            vpShip->_target.pObject.pPlanet = vpShip->_orderTargetObject.pPlanet;
            v44 = v64;
            vpShip->_target.type = 1;
            v44->type = 3;
            v44->pObject.pPlanet = (P_Planet)vpShip;
          }
          else
          {
            vpShip->order = 0;
          }
          goto LABEL_121;
        case 7:
          if ( vpShip->raceIndex != V_PlayerRaceIndex )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x121D);
          }
          if ( vpShip->locationType != 4 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x121E);
          }
          if ( (vpShip->Unknown_84 & 8) != 0 )
          {
            vpShip->order = 0;
          }
          else if ( vpShip->Unknown_62 )
          {
            vpShip->order = 0;
          }
          else
          {
            v45 = v64;
            vpShip->_target.type = 3;
            v45->type = 3;
            v45->pObject.pPlanet = (P_Planet)vpShip;
          }
          goto LABEL_121;
        default:
          v53 = v74;
          v54 = vpShip->availablePower;
          vpShip->availableMoves = 0;
          vpShip->availablePower = 0;
          LOWORD(v74) = v53 - v54;
LABEL_121:
          if ( (__int16)v74 <= 0 )
          {
            return 0;
          }
          return 0xFFFFFFFF;
      }
    }
  }
  return result;
}
// 40BBE: conditional instruction was optimized away because %var_1C.2>=1
// 406C4: using guessed type int var_74[5];

//----- (00041268) --------------------------------------------------------
int __userpurge sub_41268@<eax>(
        unsigned __int8 *eax0@<eax>,
        __int16 a2@<dx>,
        int a3@<ecx>,
        int a4@<ebx>,
        char *a5@<ebp>,
        int a6,
        __int16 a7,
        int a8,
        int a9,
        int a10,
        int a11,
        int a12)
{
  _BYTE *v13; // edx
  int ShipsAtLocation_sub_1D794; // edi
  __int16 j; // ax
  _BYTE *v16; // edx
  int v17; // esi
  char v18; // cl
  char *v19; // edx
  T_Ship *v20; // eax
  int hasColonizer; // edx
  _WORD *v22; // ebx
  T_Ship *v23; // edx
  P_Ship v25; // ecx
  int GizmoHullCellIndex_sub_4937C; // eax
  int v27; // eax
  P_Ship v28; // edx
  P_Ship v29; // edx
  int v30; // esi
  __int16 n; // cx
  int v32; // ebx
  int v33; // esi
  int v34; // eax
  char v35; // bh
  char *v36; // edx
  int v37; // ebp
  float *v38; // ebx
  __int16 ii; // si
  char *v40; // edx
  char v41; // cl
  int v42; // ecx
  double v43; // st7
  double v44; // st7
  int v45; // edx
  __int16 v46; // bx
  __int16 v47; // cx
  int v48; // eax
  int v49; // edx
  T_Planet *v50; // edi
  P_Race v51; // ebp
  signed __int16 mm; // cx
  P_Ship ShipAtSquare_sub_35A70; // esi
  int v54; // eax
  int v55; // ecx
  __int16 nn; // ax
  __int16 v57; // bx
  P_Ship *v58; // eax
  T_Ship *v59; // ecx
  unsigned int v60; // eax
  unsigned int v61; // eax
  int v62; // ebp
  T_Ship *v63; // ecx
  double v64; // st7
  char v65; // cl
  T_Ship *v66; // ebp
  char *v67; // edx
  int v68; // ebx
  T_Ship *v69; // ebp
  _WORD *v70; // ebx
  P_Ship v71; // edi
  int v72; // eax
  int v73; // eax
  P_Ship v74; // edx
  P_Ship v75; // edx
  int *v76; // eax
  int v77; // eax
  int v78; // ecx
  __int16 v79; // ax
  char v80; // dl
  int v81; // esi
  int v82; // eax
  __int16 i4; // bx
  char *v84; // edx
  char v85; // cl
  int v86; // eax
  __int16 i; // ax
  __int16 kk; // bx
  void *v89[107]; // [esp+8h] [ebp-40Ch] BYREF
  char v90; // [esp+1B4h] [ebp-260h]
  P_HullCell v91; // [esp+1B5h] [ebp-25Fh]
  BYTE type; // [esp+1B9h] [ebp-25Bh]
  P_TargetObject v93; // [esp+1BAh] [ebp-25Ah]
  float x; // [esp+1BEh] [ebp-256h]
  float y; // [esp+1C2h] [ebp-252h]
  float z; // [esp+1C6h] [ebp-24Eh]
  float v97; // [esp+1CAh] [ebp-24Ah]
  float v98; // [esp+1CEh] [ebp-246h]
  float v99; // [esp+1D2h] [ebp-242h]
  int v100; // [esp+1D6h] [ebp-23Eh]
  char Unknown_62; // [esp+1DCh] [ebp-238h]
  P_HullCell pCurHullCell; // [esp+1DDh] [ebp-237h]
  T_Target target; // [esp+1E1h] [ebp-233h]
  T_Vector3D v104[2]; // [esp+1E6h] [ebp-22Eh] BYREF
  int Unknown_84; // [esp+1FEh] [ebp-216h]
  int v106[3]; // [esp+204h] [ebp-210h] BYREF
  T_Vector3D v107; // [esp+210h] [ebp-204h] BYREF
  T_Vector3D v108; // [esp+21Ch] [ebp-1F8h]
  T_Vector3D v109; // [esp+228h] [ebp-1ECh]
  T_Vector3D v110; // [esp+234h] [ebp-1E0h] BYREF
  float v111; // [esp+240h] [ebp-1D4h]
  float v112; // [esp+244h] [ebp-1D0h]
  float v113; // [esp+248h] [ebp-1CCh]
  T_Vector3D v114; // [esp+24Ch] [ebp-1C8h] BYREF
  int v115[6]; // [esp+258h] [ebp-1BCh] BYREF
  float v116; // [esp+270h] [ebp-1A4h]
  float v117; // [esp+274h] [ebp-1A0h]
  float v118; // [esp+278h] [ebp-19Ch]
  T_Vector3D v119; // [esp+27Ch] [ebp-198h] BYREF
  T_Vector3D v120[2]; // [esp+288h] [ebp-18Ch] BYREF
  float v121; // [esp+2A0h] [ebp-174h]
  float v122; // [esp+2A4h] [ebp-170h]
  float v123; // [esp+2A8h] [ebp-16Ch]
  T_Vector3D v124; // [esp+2ACh] [ebp-168h] BYREF
  T_Vector3D v125; // [esp+2B8h] [ebp-15Ch] BYREF
  float v126; // [esp+2C4h] [ebp-150h]
  float v127; // [esp+2C8h] [ebp-14Ch]
  float v128; // [esp+2CCh] [ebp-148h]
  T_Vector3D v129; // [esp+2D0h] [ebp-144h] BYREF
  T_Vector3D v130[2]; // [esp+2DCh] [ebp-138h] BYREF
  float v131; // [esp+2F4h] [ebp-120h]
  float v132; // [esp+2F8h] [ebp-11Ch]
  float v133; // [esp+2FCh] [ebp-118h]
  float v134; // [esp+300h] [ebp-114h]
  float v135; // [esp+304h] [ebp-110h]
  float v136; // [esp+308h] [ebp-10Ch]
  T_Vector3D v137; // [esp+30Ch] [ebp-108h] BYREF
  int v138; // [esp+320h] [ebp-F4h]
  int v139; // [esp+324h] [ebp-F0h]
  P_Race v140; // [esp+328h] [ebp-ECh]
  float v141; // [esp+32Ch] [ebp-E8h]
  LONG v142; // [esp+330h] [ebp-E4h] BYREF
  int v143; // [esp+334h] [ebp-E0h]
  P_Ship pShip; // [esp+338h] [ebp-DCh]
  void *v145; // [esp+33Ch] [ebp-D8h]
  int v146; // [esp+340h] [ebp-D4h]
  int *v147; // [esp+344h] [ebp-D0h]
  float v148; // [esp+348h] [ebp-CCh]
  unsigned int v149; // [esp+34Ch] [ebp-C8h]
  T_Ship *v150; // [esp+350h] [ebp-C4h]
  float v151; // [esp+354h] [ebp-C0h]
  float v152; // [esp+358h] [ebp-BCh]
  int *v153; // [esp+35Ch] [ebp-B8h]
  P_Ship v154; // [esp+360h] [ebp-B4h]
  float v155; // [esp+364h] [ebp-B0h]
  T_Vector3D *v156; // [esp+368h] [ebp-ACh]
  float v157; // [esp+36Ch] [ebp-A8h]
  T_Vector3D *v158; // [esp+370h] [ebp-A4h]
  T_Vector3D *v159; // [esp+374h] [ebp-A0h]
  T_Vector3D *v160; // [esp+378h] [ebp-9Ch]
  MACRO_VFX_BOOL v161; // [esp+37Ch] [ebp-98h] BYREF
  MACRO_VFX_BOOL v162; // [esp+380h] [ebp-94h]
  float v163; // [esp+384h] [ebp-90h]
  int a1; // [esp+388h] [ebp-8Ch]
  float v165; // [esp+38Ch] [ebp-88h]
  T_Vector3D *v166; // [esp+390h] [ebp-84h]
  T_Vector3D *v167; // [esp+394h] [ebp-80h]
  float v168; // [esp+398h] [ebp-7Ch]
  int MaxOrbitalDefenseRange_sub_35ED8; // [esp+39Ch] [ebp-78h]
  T_Vector3D *v170; // [esp+3A0h] [ebp-74h]
  void *v171; // [esp+3A4h] [ebp-70h]
  unsigned int v172; // [esp+3A8h] [ebp-6Ch]
  float v173; // [esp+3ACh] [ebp-68h]
  float v174; // [esp+3B0h] [ebp-64h]
  int v175; // [esp+3B4h] [ebp-60h]
  T_Ship *v176; // [esp+3B8h] [ebp-5Ch]
  LONG v177; // [esp+3BCh] [ebp-58h] BYREF
  int v178; // [esp+3C0h] [ebp-54h]
  __int16 i2; // [esp+3C4h] [ebp-50h]
  int v180; // [esp+3C8h] [ebp-4Ch]
  __int16 i1; // [esp+3CCh] [ebp-48h]
  int v182; // [esp+3D0h] [ebp-44h]
  int v183; // [esp+3D4h] [ebp-40h]
  int v184; // [esp+3D8h] [ebp-3Ch]
  int v185; // [esp+3DCh] [ebp-38h]
  __int16 m; // [esp+3E0h] [ebp-34h]
  int v187; // [esp+3E4h] [ebp-30h]
  int v188; // [esp+3E8h] [ebp-2Ch]
  __int16 i3; // [esp+3ECh] [ebp-28h]
  __int16 v190; // [esp+3F0h] [ebp-24h]
  __int16 jj; // [esp+3F4h] [ebp-20h]
  __int16 v192; // [esp+3F8h] [ebp-1Ch]
  __int16 k; // [esp+3FCh] [ebp-18h]
  int v194; // [esp+400h] [ebp-14h]
  unsigned __int8 v195; // [esp+404h] [ebp-10h]

  v140 = (P_Race)eax0;
  v180 = a3;
  Q_Race_CalculateShipsAtLocation_sub_45958((P_Race)eax0, 2, (P_Location)a11, &v142);
  Q_Race_CalculateShipsAtLocation_sub_45958(v140, 3, (P_Location)a11, &v177);
  sub_1DA4C((T_Star *)a11, v140->index, 0, 0xFFFFFFFF);
  sub_1DB70((T_Star *)a11, v140->index, 0, 0xFFFFFFFF);
  v192 = 1;
  if ( ((1 << V_PlayerRaceIndex) & (*(unsigned __int8 *)(a11 + 0x14) | *(unsigned __int8 *)(a11 + 0x15))) == 0 )
  {
    v192 = 1;
  }
  if ( v140->index == V_PlayerRaceIndex && V_FlashPopExists == FALSE )
  {
    v192 = 1;
  }
  v195 = 0;
  for ( i = 0; i < a2; ++i )
  {
    v13 = (_BYTE *)(a4 + 2 * i);
    if ( (*(_WORD *)v13 & 0x20) != 0 )
    {
      v195 |= 1 << (*v13 & 7);
    }
  }
  ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)a11, (P_Ship *)v89);
  v143 = 0;
  for ( j = 0; j < ShipsAtLocation_sub_1D794; ++j )
  {
    v16 = v89[j];
    if ( v16[0x58] == 4 && ((1 << *((_WORD *)v16 + 0x2B)) & v195) != 0 )
    {
      v143 = 0xFFFFFFFF;
      break;
    }
  }
  if ( !v143 && V_PlayerRaceIndex == v140->index && V_FlashPopExists == FALSE )
  {
    return 2;
  }
  if ( (_WORD)v180 )
  {
    v17 = 0;
    pShip = 0;
    v154 = 0;
    if ( v192 == 1 )
    {
      if ( v143 )
      {
        memset(v104, 0, sizeof(v104));
        v145 = 0;
        v146 = 0;
        LOWORD(v183) = 0;
        if ( (__int16)v180 > 0 )
        {
          do
          {
            v18 = *(_BYTE *)(*(_DWORD *)(a6 + 4 * (__int16)v183) + 0x58);
            a1 = *(_DWORD *)(a6 + 4 * (__int16)v183);
            if ( v18 == 4 )
            {
              for ( k = 0; k < ShipsAtLocation_sub_1D794; ++k )
              {
                v149 = 4 * k;
                v150 = (T_Ship *)v89[v149 / 4];
                if ( (v195 & (1 << v150->raceIndex)) != 0 )
                {
                  Unknown_62 = v150->Unknown_62;
                  pCurHullCell = v150->pCurHullCell;
                  target = v150->_target;
                  v104[0] = v150->Unknown_6C;
                  v104[1] = v150->Unknown_78;
                  Unknown_84 = v150->Unknown_84;
                  if ( sub_4A480(v150, 3u, (P_TargetObject)a1) )
                  {
                    sub_49A40(a1, 0xFFFFFFFF);
                    v146 = a1;
                    v145 = v89[v149 / 4];
                  }
                  v19 = (char *)v89[k];
                  v19[0x62] = Unknown_62;
                  *(_DWORD *)(v19 + 0x63) = pCurHullCell;
                  v19[0x67] = target.type;
                  v19 += 0x62;
                  *(_DWORD *)(v19 + 6) = target.pObject.pPlanet;
                  *(T_Vector3D *)(v19 + 0xA) = v104[0];
                  *(T_Vector3D *)(v19 + 0x16) = v104[1];
                  *(_DWORD *)(v19 + 0x22) = Unknown_84;
                }
              }
              if ( v146 != a1 )
              {
                sub_49A40(a1, 0);
              }
            }
            LOWORD(v183) = v183 + 1;
          }
          while ( (__int16)v183 < (__int16)v180 );
        }
        LOWORD(v178) = 0;
        if ( (__int16)v180 > 0 )
        {
          do
          {
            v20 = *(T_Ship **)(a6 + 4 * (__int16)v178);
            hasColonizer = v20->hasColonizer;
            v176 = v20;
            if ( (!hasColonizer || Q_ShipHasGizmo_sub_4A534(v20, 0x49)) && v176->locationType == 4 && v176->availablePower )
            {
              if ( sub_4A564((int)v176) )
              {
                for ( m = 0; m < ShipsAtLocation_sub_1D794; ++m )
                {
                  v22 = v89[m];
                  if ( (v195 & (1 << v22[0x2B])) != 0 )
                  {
                    if ( sub_4A480(v176, 3u, (P_TargetObject)v22) )
                    {
                      v23 = v176;
                      *(_BYTE *)a12 = 3;
                      *(_DWORD *)(a12 + 1) = v23;
                      return 0xFFFFFFFF;
                    }
                    v154 = v176;
                  }
                }
              }
              else
              {
                pShip = v176;
              }
            }
            LOWORD(v178) = v178 + 1;
          }
          while ( (__int16)v178 < (__int16)v180 );
        }
        v25 = v154;
        if ( v154 )
        {
          GizmoHullCellIndex_sub_4937C = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v154, 0x39u);
          if ( GizmoHullCellIndex_sub_4937C != 0xFFFFFFFF && (v25->specialEffects & 4) == 0 && v25->availablePower > 0xC )
          {
            v25->Unknown_62 = 1;
            v25->_target.type = 5;
            v25->pCurHullCell = &v25->hullCells[GizmoHullCellIndex_sub_4937C];
            *(_BYTE *)a12 = 3;
            *(_DWORD *)(a12 + 1) = v25;
            sub_49B3C(v25, 0);
            if ( (v25->Unknown_84 & 1) != 0 )
            {
              return 0xFFFFFFFF;
            }
          }
        }
        if ( pShip )
        {
          v27 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(pShip, 0x41u);
          if ( v27 != 0xFFFFFFFF )
          {
            v28 = pShip;
            if ( pShip->availablePower > 0xD )
            {
              pShip->Unknown_62 = 1;
              v28->_target.type = 5;
              v29 = pShip;
              pShip->pCurHullCell = &pShip->hullCells[v27];
              *(_BYTE *)a12 = 3;
              *(_DWORD *)(a12 + 1) = v29;
              sub_49B3C(pShip, 0);
              if ( (pShip->Unknown_84 & 1) != 0 )
              {
                return 0xFFFFFFFF;
              }
            }
          }
        }
        v175 = v146;
        if ( v146 && sub_43184((int)v140, v146, (int)v145) )
        {
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = v146;
          return 0xFFFFFFFF;
        }
        v30 = 0;
        for ( n = 0; n < (__int16)v180; ++n )
        {
          v32 = *(_DWORD *)(a6 + 4 * n);
          if ( (!*(_DWORD *)(v32 + 0x28) || Q_ShipHasGizmo_sub_4A534(*(P_Ship *)(a6 + 4 * n), 0x49))
            && *(_BYTE *)(v32 + 0x58) == 4
            && *(_DWORD *)(v32 + 0x88) * *(_DWORD *)v32 * *(_DWORD *)(v32 + 0x8C) > v30 )
          {
            v30 = *(_DWORD *)(v32 + 0x88) * *(_DWORD *)v32 * *(_DWORD *)(v32 + 0x8C);
            v175 = v32;
          }
        }
        if ( !v175 )
        {
          return 0;
        }
        if ( !a7 || (v126 = 0.0, v127 = 0.0, v128 = 0.0, LOWORD(v188) = 0, a7 <= 0) )
        {
LABEL_101:
          v37 = 0;
          memset(&v125, 0, sizeof(v125));
          v148 = 99999.0;
          v38 = (float *)(v175 + 0x9E);
          for ( ii = 0; ii < ShipsAtLocation_sub_1D794; ++ii )
          {
            v40 = (char *)v89[ii];
            if ( (v195 & (1 << *((_WORD *)v40 + 0x2B))) != 0 )
            {
              v156 = v120;
              memset(&v129, 0, sizeof(v129));
              v129.x = *(float *)(v40 + 0x9E) - *v38;
              v129.y = *(float *)(v40 + 0xA2) - v38[1];
              v129.z = *(float *)(v40 + 0xA6) - v38[2];
              v120[0] = v129;
              v125 = v129;
              v157 = sqrt(v129.y * v129.y + v129.x * v129.x + v129.z * v129.z);
              v41 = v40[0x58];
              v165 = v157;
              if ( v41 != 4 )
              {
                v165 = v157 + 10000.0;
              }
              if ( v165 < (double)v148 && v165 > 600.0 )
              {
                v37 = (int)v40;
                v148 = v165;
              }
            }
          }
          v42 = v175;
          if ( v175 && v37 )
          {
            v158 = &v110;
            memset(&v130[1], 0, sizeof(T_Vector3D));
            v130[1].x = *v38 - *(float *)(v37 + 0x9E);
            v130[1].y = v38[1] - *(float *)(v37 + 0xA2);
            v43 = v38[2] - *(float *)(v37 + 0xA6);
            v110 = v130[1];
            v130[1].z = v43;
            v131 = 0.0;
            v125 = v130[1];
            v132 = 0.0;
            v133 = 0.0;
            MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0xC8 + 0x64;
            v131 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0xC8 + 0x64;
            v132 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0xC8 + 0x64;
            v133 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            v159 = &v137;
            v108.x = v125.x + v131;
            v108.y = v125.y + v132;
            v108.z = v125.z + v133;
            v137 = v108;
            v125 = v108;
            MaxOrbitalDefenseRange_sub_35ED8 = sub_49B68(v42, 1);
            v168 = (float)MaxOrbitalDefenseRange_sub_35ED8;
            if ( v168 < 0.0 )
            {
              MaxOrbitalDefenseRange_sub_35ED8 = sub_49B68(v37, 1);
              v168 = (double)MaxOrbitalDefenseRange_sub_35ED8 * 1.2;
            }
            if ( v168 >= 0.0 )
            {
              Q_Vector3D_SetLength_sub_53054(&v125, v168);
            }
            v160 = v130;
            memset(&v115[3], 0, 0xC);
            *(float *)&v115[3] = v125.x + *(float *)(v37 + 0x9E);
            *(float *)&v115[4] = v125.y + *(float *)(v37 + 0xA2);
            v44 = v125.z + *(float *)(v37 + 0xA6);
            v130[0] = *(T_Vector3D *)&v115[3];
            *(float *)&v115[5] = v44;
            v125 = *(T_Vector3D *)&v115[3];
            v45 = v175;
            *(_BYTE *)a12 = 3;
            *(_DWORD *)(a12 + 1) = v45;
            *(_BYTE *)(v45 + 0x62) = 0;
            *(_BYTE *)(v45 + 0x67) = 3;
            *(_DWORD *)(v45 + 0x63) = 0;
            *(_DWORD *)(v45 + 0x68) = 0;
            *(T_Vector3D *)(v45 + 0x6C) = v125;
            return 0xFFFFFFFF;
          }
          return 0;
        }
LABEL_79:
        v33 = *(_DWORD *)(a8 + 4 * (__int16)v188);
        for ( jj = 0; ; ++jj )
        {
          if ( jj >= (int)*(unsigned __int16 *)(v33 + 0x1A) )
          {
            LOWORD(v188) = v188 + 1;
            if ( (__int16)v188 >= a7 )
            {
              goto LABEL_101;
            }
            goto LABEL_79;
          }
          v34 = 4 * jj + *(_DWORD *)(v33 + 0x10);
          v35 = *(_BYTE *)(v34 + 1);
          if ( v35 != (char)0xFF
            && (*(_WORD *)(v34 + 2) & 1) != 0
            && (V_PlanetItems.item[*(unsigned __int8 *)(v34 + 1)].flags & 4) != 0
            && (v35 != 0x11 || *(_BYTE *)(v33 + 0x58)) )
          {
            v151 = 99999.0;
            for ( kk = 0; kk < ShipsAtLocation_sub_1D794; ++kk )
            {
              v36 = (char *)v89[kk];
              if ( (v195 & (1 << *((_WORD *)v36 + 0x2B))) != 0 )
              {
                v153 = v106;
                v116 = 0.0;
                v117 = 0.0;
                v118 = 0.0;
                v116 = *(float *)v33 - *(float *)(v36 + 0x9E);
                v117 = *(float *)(v33 + 4) - *(float *)(v36 + 0xA2);
                v118 = *(float *)(v33 + 8) - *(float *)(v36 + 0xA6);
                *(float *)v106 = v116;
                *(float *)&v106[1] = v117;
                *(float *)&v106[2] = v118;
                v126 = v116;
                v127 = v117;
                v128 = v118;
                v155 = sqrt(v117 * v117 + v116 * v116 + v118 * v118);
                v152 = v155;
                if ( v36[0x58] != 4 )
                {
                  v152 = v155 + 10000.0;
                }
                if ( v152 < (double)v151 )
                {
                  a5 = v36;
                  v151 = v152;
                }
              }
            }
            if ( *(_BYTE *)(*(_DWORD *)(v33 + 0x10) + 4 * jj + 1) != 0x11 || v151 >= 1440.0 )
            {
              if ( !a5 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x13E7);
              }
              *(_DWORD *)(v33 + 0x6B) = 4 * jj + *(_DWORD *)(v33 + 0x10);
              *(_DWORD *)(v33 + 0x6F) = a5;
              sub_3676C((P_Planet)v33, 0);
              if ( (*(_BYTE *)(v33 + 0x73) & 1) != 0 )
              {
                break;
              }
            }
          }
        }
        *(_BYTE *)a12 = 2;
        *(_DWORD *)(a12 + 1) = v33;
        return 0xFFFFFFFF;
      }
      else
      {
        v46 = *(_WORD *)(a11 + 0x5A);
        LOWORD(v185) = 0;
        if ( v46 <= 0 )
        {
          return 0;
        }
        while ( 1 )
        {
          v48 = *(_DWORD *)(a11 + 4 * (__int16)v185 + 0x46);
          v49 = *(unsigned __int8 *)(v48 + 0x57);
          if ( v49 != 0xFF
            && (_BYTE)v49 != v140->index
            && (v140->treaties[v49] == 2
             || V_PlayerRaceIndex == *(_BYTE *)(v48 + 0x57)
             && ((1 << v140->index) & (unsigned __int8)byte_D8460[*(__int16 *)(a11 + 4)]) != 0) )
          {
            v50 = *(T_Planet **)(a11 + 4 * (__int16)v185 + 0x46);
            if ( !v48 )
            {
              return 0;
            }
            v51 = v140;
            for ( mm = *(_WORD *)(v48 + 0x18); mm < (int)v50->totalSquaresNum; ++mm )
            {
              if ( v50->pSquares[mm].planetItemIndex == 0x17 && Q_Planet_GetShipAtSquare_sub_35A70(v50, mm)->raceIndex == v51->index )
              {
                ShipAtSquare_sub_35A70 = Q_Planet_GetShipAtSquare_sub_35A70(v50, mm);
                if ( ShipAtSquare_sub_35A70->raceIndex != v51->index )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1468);
                }
                Q_Planet_TryInvade_sub_36CD4(v50, mm, (int *)&v161);
                if ( ShipAtSquare_sub_35A70 != Q_Planet_GetShipAtSquare_sub_35A70(v50, mm) )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x146C);
                }
                v161 = Q_Planet_LaunchShip_sub_35C38(v50, ShipAtSquare_sub_35A70);
                if ( v161 != 0xFFFFFFFF )
                {
                  Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x146E);
                }
                return 0xFFFFFFFF;
              }
            }
            v162 = Q_Planet_HasOrbitalDefense_sub_361B8(v50);
            if ( v162 == FALSE )
            {
              LOWORD(v184) = 0;
              if ( (__int16)v180 > 0 )
              {
                do
                {
                  if ( v17 )
                  {
                    break;
                  }
                  v54 = a6 + 4 * (__int16)v184;
                  v55 = *(_DWORD *)v54;
                  if ( *(_BYTE *)(*(_DWORD *)v54 + 0x58) == 4 )
                  {
                    for ( nn = 0; nn < *(_DWORD *)(v55 + 0x15A); ++nn )
                    {
                      if ( *(_BYTE *)(v55 + 7 * nn + 0xAB) == 0x49 )
                      {
                        v17 = v55;
                        break;
                      }
                    }
                  }
                  LOWORD(v184) = v184 + 1;
                }
                while ( (__int16)v184 < (__int16)v180 );
              }
              if ( v17 )
              {
                *(_BYTE *)a12 = 3;
                *(_DWORD *)(a12 + 1) = v17;
                *(_BYTE *)(v17 + 0x62) = 0;
                *(_DWORD *)(v17 + 0x63) = 0;
                *(_BYTE *)(v17 + 0x67) = 1;
                *(_DWORD *)(v17 + 0x68) = v50;
                return 0xFFFFFFFF;
              }
              v57 = 0;
              if ( (__int16)v180 > 0 )
              {
                while ( 1 )
                {
                  v58 = (P_Ship *)(a6 + 4 * v57);
                  v59 = *v58;
                  if ( !(*v58)->hasColonizer || Q_ShipHasGizmo_sub_4A534(*v58, 0x49) )
                  {
                    v60 = 0;
                    if ( v59->order == 1 && v59->_orderTargetObject.pPlanet == (P_Planet)a11 )
                    {
                      v60 = 0xFFFFFFFF;
                    }
                    if ( v59->locationType == 4 && !v60 && Q_ShipHasGizmo_sub_4A534(v59, 0x46) )
                    {
                      break;
                    }
                  }
                  if ( ++v57 >= (__int16)v180 )
                  {
                    goto LABEL_162;
                  }
                }
                if ( sub_4A480(v59, 1u, (P_TargetObject)v50) )
                {
                  v17 = (int)v59;
                }
              }
LABEL_162:
              if ( v17 )
              {
                *(_BYTE *)a12 = 3;
                *(_DWORD *)(a12 + 1) = v17;
                return 0xFFFFFFFF;
              }
            }
            v61 = 0;
            if ( v50->totalSquaresNum - v50->surfaceSquaresNum > (unsigned __int16)v50->freeOrbitalSquaresNum )
            {
              v61 = 0xFFFFFFFF;
            }
            if ( v162 == 0xFFFFFFFF || v61 == 0xFFFFFFFF )
            {
              break;
            }
          }
          v47 = *(_WORD *)(a11 + 0x5A);
          LOWORD(v185) = v185 + 1;
          if ( (__int16)v185 >= v47 )
          {
            return 0;
          }
        }
        v62 = 0;
        LOWORD(v187) = 0;
        if ( (__int16)v180 > 0 )
        {
          do
          {
            if ( v17 )
            {
              break;
            }
            v63 = *(T_Ship **)(a6 + 4 * (__int16)v187);
            if ( (!v63->hasColonizer || Q_ShipHasGizmo_sub_4A534(*(P_Ship *)(a6 + 4 * (__int16)v187), 0x49))
              && v63->locationType == 4
              && (sub_4A564((int)v63) || Q_ShipHasGizmo_sub_4A534(v63, 0x46)) )
            {
              v62 = (int)v63;
              if ( sub_4A480(v63, 1u, (P_TargetObject)v50) )
              {
                v17 = (int)v63;
              }
            }
            LOWORD(v187) = v187 + 1;
          }
          while ( (__int16)v187 < (__int16)v180 );
        }
        if ( v17 )
        {
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = v17;
          return 0xFFFFFFFF;
        }
        if ( !v62 )
        {
          return v17;
        }
        memset(&v120[1], 0, sizeof(T_Vector3D));
        v166 = &v107;
        v120[1].x = *(float *)(v62 + 0x9E) - v50->position.x;
        v120[1].y = *(float *)(v62 + 0xA2) - v50->position.y;
        v120[1].z = *(float *)(v62 + 0xA6) - v50->position.z;
        v107 = v120[1];
        v111 = 0.0;
        v112 = 0.0;
        v113 = 0.0;
        MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0x64 + 0x14;
        v111 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0x64 + 0x14;
        v112 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        MaxOrbitalDefenseRange_sub_35ED8 = rand() % 0x64 + 0x14;
        v113 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        v167 = &v114;
        v109.x = v107.x + v111;
        v109.y = v107.y + v112;
        v109.z = v107.z + v113;
        v114 = v109;
        v107 = v109;
        MaxOrbitalDefenseRange_sub_35ED8 = sub_49B68(v62, 2);
        v163 = (float)MaxOrbitalDefenseRange_sub_35ED8;
        if ( v163 < 0.0 )
        {
          MaxOrbitalDefenseRange_sub_35ED8 = Q_Planet_GetMaxOrbitalDefenseRange_sub_35ED8(v50);
          v163 = (double)MaxOrbitalDefenseRange_sub_35ED8 * 1.2;
        }
        if ( v163 >= 0.0 )
        {
          Q_Vector3D_SetLength_sub_53054(&v107, v163);
        }
        v170 = &v119;
        memset(&v124, 0, sizeof(v124));
        v124.x = v107.x + v50->position.x;
        v124.y = v107.y + v50->position.y;
        v64 = v107.z + v50->position.z;
        v119 = v124;
        v124.z = v64;
        v107 = v124;
        *(_BYTE *)a12 = 3;
        *(_DWORD *)(a12 + 1) = v62;
        *(_BYTE *)(v62 + 0x62) = 0;
        *(_BYTE *)(v62 + 0x67) = 3;
        *(_DWORD *)(v62 + 0x63) = 0;
        *(_DWORD *)(v62 + 0x68) = 0;
        *(T_Vector3D *)(v62 + 0x6C) = v107;
        return 0xFFFFFFFF;
      }
    }
    else
    {
      x = 0.0;
      y = 0.0;
      z = 0.0;
      v97 = 0.0;
      v98 = 0.0;
      v99 = 0.0;
      LOWORD(v194) = 0;
      if ( (__int16)v180 > 0 )
      {
        do
        {
          if ( v17 )
          {
            break;
          }
          v65 = *(_BYTE *)(*(_DWORD *)(a6 + 4 * (__int16)v194) + 0x58);
          v139 = *(_DWORD *)(a6 + 4 * (__int16)v194);
          if ( v65 == 4 )
          {
            for ( i1 = 0; i1 < ShipsAtLocation_sub_1D794 && !v17; ++i1 )
            {
              v66 = (T_Ship *)v89[i1];
              v172 = 4 * i1;
              if ( (v195 & (1 << v66->raceIndex)) != 0 )
              {
                v90 = v66->Unknown_62;
                v91 = v66->pCurHullCell;
                type = v66->_target.type;
                v93.pPlanet = (P_Planet)v66->_target.pObject;
                x = v66->Unknown_6C.x;
                y = v66->Unknown_6C.y;
                z = v66->Unknown_6C.z;
                v97 = v66->Unknown_78.x;
                v98 = v66->Unknown_78.y;
                v99 = v66->Unknown_78.z;
                v100 = v66->Unknown_84;
                if ( sub_4A480(v66, 3u, (P_TargetObject)v139) )
                {
                  v17 = v139;
                  v171 = v89[v172 / 4];
                }
                v67 = (char *)v89[i1];
                v67[0x62] = v90;
                *(_DWORD *)(v67 + 0x63) = v91;
                v67[0x67] = type;
                v67 += 0x62;
                *(P_TargetObject *)(v67 + 6) = v93;
                *(float *)(v67 + 0xA) = x;
                *(float *)(v67 + 0xE) = y;
                *(float *)(v67 + 0x12) = z;
                *(float *)(v67 + 0x16) = v97;
                *(float *)(v67 + 0x1A) = v98;
                *(float *)(v67 + 0x1E) = v99;
                *(_DWORD *)(v67 + 0x22) = v100;
              }
            }
          }
          LOWORD(v194) = v194 + 1;
        }
        while ( (__int16)v194 < (__int16)v180 );
      }
      if ( v17 )
      {
        v68 = (int)v171;
        sub_49A40(v17, 0xFFFFFFFF);
        if ( sub_43184((int)v140, v17, v68) )
        {
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = v17;
          return 0xFFFFFFFF;
        }
      }
      LOWORD(v182) = 0;
      if ( (__int16)v180 > 0 )
      {
        do
        {
          if ( v17 )
          {
            break;
          }
          v69 = *(T_Ship **)(a6 + 4 * (__int16)v182);
          if ( v69->locationType == 4 && v69->availablePower )
          {
            if ( sub_4A564(*(_DWORD *)(a6 + 4 * (__int16)v182)) )
            {
              for ( i2 = 0; i2 < ShipsAtLocation_sub_1D794; ++i2 )
              {
                v70 = v89[i2];
                if ( (v195 & (1 << v70[0x2B])) != 0 )
                {
                  if ( sub_4A480(v69, 3u, (P_TargetObject)v70) )
                  {
                    *(_BYTE *)a12 = 3;
                    *(_DWORD *)(a12 + 1) = v69;
                    return 0xFFFFFFFF;
                  }
                  v154 = v69;
                }
              }
            }
            else
            {
              pShip = v69;
            }
          }
          LOWORD(v182) = v182 + 1;
        }
        while ( (__int16)v182 < (__int16)v180 );
      }
      v71 = v154;
      if ( v154 )
      {
        v72 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v154, 0x39u);
        if ( v72 != 0xFFFFFFFF && (v71->specialEffects & 4) == 0 && v71->availablePower > 0xC )
        {
          v71->Unknown_62 = 1;
          v71->_target.type = 5;
          v71->pCurHullCell = &v71->hullCells[v72];
          *(_BYTE *)a12 = 3;
          *(_DWORD *)(a12 + 1) = v71;
          sub_49B3C(v71, 0);
          if ( (v71->Unknown_84 & 1) != 0 )
          {
            return 0xFFFFFFFF;
          }
        }
      }
      if ( pShip )
      {
        v73 = Q_Ship_FindGizmoHullCellIndex_sub_4937C(pShip, 0x41u);
        if ( v73 != 0xFFFFFFFF )
        {
          v74 = pShip;
          if ( pShip->availablePower > 0xD )
          {
            pShip->Unknown_62 = 1;
            v74->_target.type = 5;
            pShip->pCurHullCell = &pShip->hullCells[v73];
            v75 = pShip;
            *(_BYTE *)a12 = 3;
            *(_DWORD *)(a12 + 1) = v75;
            sub_49B3C(pShip, 0);
            if ( (pShip->Unknown_84 & 1) != 0 )
            {
              return 0xFFFFFFFF;
            }
          }
        }
      }
      v76 = *(int **)(a11 + 0x2C);
      if ( *v76 == a11 )
      {
        v77 = v76[1];
      }
      else
      {
        v77 = *v76;
      }
      v78 = v77;
      v79 = 0;
      if ( (__int16)v180 > 0 )
      {
        while ( 1 )
        {
          v17 = *(_DWORD *)(a6 + 4 * v79);
          v80 = *(_BYTE *)(v17 + 0x58);
          if ( v80 == 3 )
          {
            break;
          }
          if ( v80 != 4 )
          {
            ++v79;
            v17 = 0;
            if ( v79 < (__int16)v180 )
            {
              continue;
            }
          }
          goto LABEL_240;
        }
        Q_Planet_LaunchShip_sub_35C38(*(P_Planet *)(v17 + 0x59), *(P_Ship *)(a6 + 4 * v79));
        if ( *(_BYTE *)(v17 + 0x58) != 4 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x15E4);
        }
      }
LABEL_240:
      if ( !v17 )
      {
        return v17;
      }
      if ( *(_BYTE *)(v17 + 0x58) != 4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x15EF);
      }
      *(_BYTE *)(v17 + 0x5D) = 1;
      *(_DWORD *)(v17 + 0x5E) = v78;
      return 2;
    }
  }
  else
  {
    if ( !a7 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x15FD);
    }
    if ( !v143 )
    {
      return 0;
    }
    v134 = 0.0;
    v135 = 0.0;
    v136 = 0.0;
    v190 = 0;
    if ( a7 > 0 )
    {
      while ( 2 )
      {
        v81 = *(_DWORD *)(a8 + 4 * v190);
        for ( i3 = 0; i3 < (int)*(unsigned __int16 *)(v81 + 0x1A); ++i3 )
        {
          v82 = 4 * i3 + *(_DWORD *)(v81 + 0x10);
          if ( *(_BYTE *)(v82 + 1) != 0xFF
            && (*(_WORD *)(v82 + 2) & 1) != 0
            && (V_PlanetItems.item[*(unsigned __int8 *)(v82 + 1)].flags & 4) != 0
            && (*(_BYTE *)(v82 + 1) != 0x11 || *(_BYTE *)(v81 + 0x58)) )
          {
            v173 = 99999.0;
            for ( i4 = 0; i4 < ShipsAtLocation_sub_1D794; ++i4 )
            {
              v84 = (char *)v89[i4];
              if ( (v195 & (1 << *((_WORD *)v84 + 0x2B))) != 0 )
              {
                v147 = v115;
                v121 = 0.0;
                v122 = 0.0;
                v123 = 0.0;
                v121 = *(float *)v81 - *(float *)(v84 + 0x9E);
                v122 = *(float *)(v81 + 4) - *(float *)(v84 + 0xA2);
                v123 = *(float *)(v81 + 8) - *(float *)(v84 + 0xA6);
                *(float *)v115 = v121;
                *(float *)&v115[1] = v122;
                *(float *)&v115[2] = v123;
                v134 = v121;
                v135 = v122;
                v136 = v123;
                v141 = sqrt(v122 * v122 + v121 * v121 + v123 * v123);
                v85 = v84[0x58];
                v174 = v141;
                if ( v85 != 4 )
                {
                  v174 = v141 + 10000.0;
                }
                if ( v174 < (double)v173 )
                {
                  v138 = (int)v84;
                  v173 = v174;
                }
              }
            }
            if ( *(_BYTE *)(*(_DWORD *)(v81 + 0x10) + 4 * i3 + 1) != 0x11 || v173 >= 1440.0 )
            {
              if ( !v138 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1633);
              }
              v86 = v138;
              *(_DWORD *)(v81 + 0x6B) = 4 * i3 + *(_DWORD *)(v81 + 0x10);
              *(_DWORD *)(v81 + 0x6F) = v86;
              sub_3676C((P_Planet)v81, 0);
              if ( (*(_BYTE *)(v81 + 0x73) & 1) != 0 )
              {
                *(_BYTE *)a12 = 2;
                *(_DWORD *)(a12 + 1) = v81;
                return 0xFFFFFFFF;
              }
            }
          }
        }
        if ( ++v190 < a7 )
        {
          continue;
        }
        break;
      }
      return 0;
    }
    else
    {
      return 0;
    }
  }
}
// 42437: conditional instruction was optimized away because esi.4==0
// 41268: using guessed type T_Ship *var_40C;

//----- (00043184) --------------------------------------------------------
unsigned int __fastcall sub_43184(int a1, int a2, int a3)
{
  __int16 j; // bx
  int v5; // esi
  __int16 i; // di
  char v8[12]; // [esp+0h] [ebp-2Ch] BYREF
  _DWORD v9[2]; // [esp+Ch] [ebp-20h]
  __int16 v10; // [esp+14h] [ebp-18h]
  int v11; // [esp+18h] [ebp-14h]

  strcpy(v8, "E?2.-&%#!");
  v9[0] = unk_9696C;
  v9[1] = *((_DWORD *)&unk_9696C + 1);
  v10 = *((_WORD *)&unk_9696C + 4);
  if ( Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC((P_Ship)a2) / 2 < *(_DWORD *)(a2 + 0x88) )
  {
    *(_BYTE *)(a2 + 0x62) = 1;
    v11 = a2 + 0xAB;
    for ( i = 0; i < *(_DWORD *)(a2 + 0x15A); ++i )
    {
      if ( V_Gizmos[*(char *)(a2 + 7 * i + 0xAB)].cat == 5 )
      {
        for ( j = 0; j < 0xA; ++j )
        {
          v5 = 7 * i;
          if ( *(_BYTE *)(a2 + v5 + 0xAB) == v8[j] )
          {
            *(_DWORD *)(a2 + 0x63) = v5 + v11;
            *(_BYTE *)(a2 + 0x67) = *((_BYTE *)v9 + j);
            *(_DWORD *)(a2 + 0x68) = a3;
            sub_49B3C((P_Ship)a2, 0);
            if ( (*(_BYTE *)(a2 + 0x84) & 1) != 0 )
            {
              return 0xFFFFFFFF;
            }
          }
        }
      }
    }
  }
  return 0;
}

//----- (00043374) --------------------------------------------------------
char __fastcall sub_43374(P_Race pRace, int a2)
{
  char v3; // ch
  __int16 v4; // bx

  v3 = 0;
  if ( V_Game.racesNum > 0 )
  {
    v4 = 0;
    do
    {
      if ( v4 != pRace->index
        && V_Game.races[v4].Unknown_03 != 0xFFFFFFFF
        && pRace->treaties[v4] == ASCEND_TREATY_WAR
        && (a2 == 0xFFFFFFFF || sub_43B7C(pRace, v4) > a2) )
      {
        v3 |= 1 << v4;
      }
      ++v4;
    }
    while ( v4 < V_Game.racesNum );
  }
  return v3;
}

//----- (000433E0) --------------------------------------------------------
// Decays diplomatic relations between two races in a star system
MACRO_VFX_BOOL __fastcall Q_Race_DecayRelations_sub_433E0(P_Race pRace, WORD raceIndex, P_Star pStar)
{
  WORD v5; // kr02_2
  __int16 relationDecay; // dx
  int v7; // ebx
  WORD v8; // kr00_2
  WORD newRelationScore; // si
  WORD allianceMaxScore; // bx

  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1705);
  }
  if ( !pStar )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\race.cpp", 0x1706);
  }
  v5 = raceIndex;
  // No relation decay if at war
  if ( pRace->treaties[raceIndex] == ASCEND_TREATY_WAR )
  {
    return FALSE;
  }
  // Calculate base decay amount based on game atmosphere
  relationDecay = 10 * (V_Game.atmosphere + 1);
  // Alliances decay faster than normal relations
  if ( pRace->treaties[v5] == ASCEND_TREATY_ALLIANCE )
  {
    relationDecay = 20 * (V_Game.atmosphere + 1);
  }
  v7 = raceIndex;
  v8 = raceIndex;
  // Apply relation decay
  newRelationScore = pRace->_treatiesScore[raceIndex] - relationDecay;
  pRace->_treatiesScore[v8] = newRelationScore;
  // Prevent alliance score from exceeding maximum
  if ( pRace->treaties[v7] == ASCEND_TREATY_ALLIANCE )
  {
    allianceMaxScore = pRace->_allianceMaxScore;
    if ( newRelationScore > allianceMaxScore )
    {
      // Keep score slightly below max to prevent oscillation
      pRace->_treatiesScore[v8] = allianceMaxScore - 10;
    }
  }
  // Mark this star system as having updated diplomatic status
  byte_D8460[pStar->index] |= 1 << pRace->index;
  return TRUE;
}

//----- (000434E4) --------------------------------------------------------
int __fastcall sub_434E4(P_Race pRace, int a2)
{
  int ability; // eax
  int v4; // ebx
  int Ships_sub_40224; // eax
  int i; // kr04_4
  char *v8; // ecx
  int v9; // ebx
  int v10; // eax
  int k; // kr18_4
  int ShipsAtLocation_sub_1D794; // eax
  int n; // kr2C_4
  int v14; // kr30_4
  P_Ship v15; // edx
  int raceIndex; // eax
  T_Star *homeStar; // esi
  int v18; // eax
  int jj; // kr40_4
  P_Ship v20; // edx
  unsigned __int16 v21; // cx
  UWORD word42; // si
  P_Square pSquares; // kr50_4
  P_Location v24; // edx
  T_Star *x_low; // ecx
  int i2; // eax
  int v27; // edx
  __int16 v28; // bx
  UWORD v29; // dx
  int i6; // eax
  char *v31; // kr90_4
  int v32; // ebx
  int v33; // edx
  char v34; // al
  int j; // edx
  int kk; // edx
  int mm; // ebx
  int nn; // esi
  int i3; // edx
  int i4; // edi
  int i5; // edi
  int i7; // edi
  int i8; // eax
  int i9; // edx
  P_Ship v45[107]; // [esp+0h] [ebp-6F8h] BYREF
  P_Ship v46[107]; // [esp+1ACh] [ebp-54Ch] BYREF
  P_Ship v47[107]; // [esp+358h] [ebp-3A0h] BYREF
  P_Ship v48[107]; // [esp+504h] [ebp-1F4h] BYREF
  _DWORD v49[3]; // [esp+6B0h] [ebp-48h]
  int m; // [esp+6BCh] [ebp-3Ch]
  P_Race v51; // [esp+6C0h] [ebp-38h]
  int v52; // [esp+6C4h] [ebp-34h]
  int v53; // [esp+6C8h] [ebp-30h]
  int i1; // [esp+6CCh] [ebp-2Ch]
  T_Planet *v55; // [esp+6D0h] [ebp-28h]
  int v56; // [esp+6D4h] [ebp-24h]
  int ii; // [esp+6D8h] [ebp-20h]
  T_Star *stars; // [esp+6DCh] [ebp-1Ch]
  int v59; // [esp+6E0h] [ebp-18h]

  ability = (char)pRace->ability;
  v52 = 0;
  if ( (unsigned __int16)word_968E8[ability] <= *(int *)pRace->z2 )
  {
    v52 = 0xFFFFFFFF;
    if ( a2 != 1 )
    {
      return v52;
    }
    v4 = 0;
    v34 = pRace->ability - 5;
    v53 = 0;
    switch ( v34 )
    {
      case 0:
        Ships_sub_40224 = Q_Race_GetShips_sub_40224(pRace, v47, 0);
        if ( Ships_sub_40224 > 0 )
        {
          for ( i = 0; i < Ships_sub_40224; ++i )
          {
            v47[i]->hullIntegrity = v47[i]->Unknown_98;
          }
        }
        break;
      case 1:
        for ( j = 0; j < V_Game.racesNum; ++j )
        {
          if ( &V_Game.races[j] != pRace )
          {
            v8 = (char *)&V_Game.races[j] + 2 * pRace->index;
            v9 = V_Game.races[j].Unknown_1CB[1] + 0x14;
            if ( *((__int16 *)v8 + 0xD9) < v9 )
            {
              *((_WORD *)v8 + 0xD9) = v9;
            }
          }
        }
        break;
      case 2:
        v10 = Q_Race_GetShips_sub_40224(pRace, v45, 0);
        if ( v10 > 0 )
        {
          for ( k = 0; k < v10; ++k )
          {
            v45[k]->availablePower *= 2;
          }
        }
        break;
      case 3:
        for ( m = 0; V_Game.starsNum > m; ++m )
        {
          if ( ((1 << pRace->index) & V_Game.stars[m].racesBits) != 0 )
          {
            ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[m], v46);
            if ( ShipsAtLocation_sub_1D794 > 0 )
            {
              v59 = 4 * ShipsAtLocation_sub_1D794;
              v14 = ShipsAtLocation_sub_1D794;
              for ( n = 0; n < v14; ++n )
              {
                v15 = v46[n];
                raceIndex = v15->raceIndex;
                if ( raceIndex != pRace->index && v15->locationType == 4 )
                {
                  homeStar = V_Game.races[raceIndex]._homeStar;
                  Q_HandleShipDeparture_sub_1D538((P_Location)&V_Game.stars[m], v15);
                  Q_Star_HandleShipArrival_sub_1D3E8(homeStar, v46[n], 0);
                }
              }
            }
          }
        }
        break;
      case 4:
        stars = V_Game.stars;
        for ( ii = 0; V_Game.starsNum > ii; ++ii )
        {
          if ( ((1 << pRace->index) & V_Game.stars[ii].racePresenceBits) != 0 )
          {
            v18 = Q_FindShipsAtLocation_sub_1D794((P_Location)&V_Game.stars[ii], v48);
            if ( v18 > 0 )
            {
              for ( jj = 0; jj < v18; ++jj )
              {
                v20 = v48[jj];
                if ( v20->raceIndex != pRace->index )
                {
                  v20->availablePower = 0;
                }
              }
            }
          }
        }
        break;
      case 5:
        v21 = 0xFFFF;
        v55 = 0;
        for ( kk = 0; kk < V_Game.planetsNum; ++kk )
        {
          if ( V_Game.planets[kk].raceIndex == pRace->index && V_Game.planets[kk].type != 0xA )
          {
            word42 = V_Game.planets[kk].word42;
            if ( v21 > word42 )
            {
              v55 = &V_Game.planets[kk];
              v21 = word42;
            }
          }
        }
        if ( v55 )
        {
          pSquares = v55->pSquares;
          for ( mm = 0; mm < v55->surfaceSquaresNum; ++mm )
          {
            if ( !pSquares[mm].color || pSquares[mm].color == 1 )
            {
              v49[0] = unk_96994;
              v49[1] = *((_DWORD *)&unk_96994 + 1);
              v49[2] = *((_DWORD *)&unk_96994 + 2);
              pSquares[mm].color = v49[rand() % 3];
            }
          }
        }
        break;
      case 6:
        for ( nn = 0; nn < V_Game.shipsNum; ++nn )
        {
          if ( V_Game.ships[nn].raceIndex != 0xFFFFFFFF && V_Game.ships[nn].locationType == 5 )
          {
            v24.pPlanet = (P_Planet)V_Game.ships[nn].pLocation;
            x_low = (T_Star *)LODWORD(v24.pPlanet->position.x);
            if ( (LODWORD(V_Game.ships[nn].position.y) & 0x7FFFFFFF) == 0 )
            {
              x_low = (T_Star *)LODWORD(v24.pPlanet->position.y);
            }
            Q_Star_HandleShipArrival_sub_1D3E8(x_low, &V_Game.ships[nn], 0);
          }
        }
        break;
      case 7:
        v56 = 0;
        for ( i1 = 0; V_Research.num > i1; ++i1 )
        {
          v27 = 0;
          for ( i2 = 0; i2 < V_Game.racesNum; ++i2 )
          {
            if ( ((1 << i2) & (char)V_Research.techs[0].next[v56 + 5]) != 0 )
            {
              ++v27;
            }
          }
          if ( v27 >= 2 )
          {
            V_Research.techs[i1].knownToRace |= 1 << pRace->index;
            v28 = i1;
            v29 = V_Research.current.project[pRace->index];
            if ( v29 == i1 )
            {
              V_Research.current.project[pRace->index] = 0xFFFF;
              word_106FB4[pRace->index] = v28 ^ v29;
            }
          }
        }
        break;
      case 8:
        for ( i3 = 0; i3 < V_Game.planetsNum; ++i3 )
        {
          if ( V_Game.planets[i3].raceIndex == pRace->index )
          {
            V_Game.planets[i3].Unknown_62 = 0xFFFFFFFF;
          }
        }
        v53 = *(_DWORD *)pRace->z2 - (unsigned __int16)word_968E8[(char)pRace->ability];
        break;
      case 9:
        for ( i4 = 0; i4 < V_Game.planetsNum; ++i4 )
        {
          if ( V_Game.planets[i4].raceIndex == pRace->index )
          {
            V_Game.planets[i4].maximumPopulation2 += 2;
            Q_Planet_CalcPoints_sub_34E70(&V_Game.planets[i4]);
          }
        }
        break;
      case 0xB:
        for ( i5 = 0; i5 < V_Game.starsNum; ++i5 )
        {
          if ( ((1 << pRace->index) & V_Game.stars[i5].racesBits) != 0 )
          {
            for ( i6 = 0; i6 < V_Game.stars[i5].lanesNum; ++i6 )
            {
              V_Game.stars[i5]._lanes[i6]->flags |= 2u;
            }
          }
        }
        break;
      case 0xC:
        v51 = pRace;
        for ( i7 = 0; i7 < V_Game.racesNum; ++i7 )
        {
          if ( i7 != pRace->index && pRace->treaties[i7] == 2 )
          {
            v31 = (char *)V_Game.races + 2 * i7;
            for ( i8 = 0; i8 < V_Game.racesNum; ++i8 )
            {
              if ( i8 != i7 && i8 != pRace->index && *(_WORD *)&v31[0x1EE * i8 + 0x1B2] > V_Game.races[i8].Unknown_1C9 )
              {
                *(_WORD *)&v31[0x1EE * i8 + 0x1B2] = V_Game.races[i8].Unknown_1C9;
              }
            }
          }
        }
        break;
      case 0xE:
        LOBYTE(v4) = pRace->index;
        v32 = v4;
        v33 = V_Research.current.project[v32];
        if ( (unsigned __int16)v33 != 0xFFFF )
        {
          word_106FB4[v32] = V_Research.techs[v33].cost;
        }
        break;
      case 0xF:
        for ( i9 = 0; i9 < V_Game.planetsNum; ++i9 )
        {
          if ( V_Game.planets[i9].raceIndex == pRace->index && V_Game.planets[i9].buildingPlanetItemIndex != 0xFF )
          {
            V_Game.planets[i9].buildingProgress += 0x64;
          }
        }
        break;
      default:
        break;
    }
    *(_DWORD *)pRace->z2 = v53;
  }
  return v52;
}
// 968E8: using guessed type __int16 word_968E8[21];
// 106FB4: using guessed type __int16 word_106FB4[7];

//----- (00043B7C) --------------------------------------------------------
int __fastcall sub_43B7C(P_Race pRace, __int16 raceIndex)
{
  int v2; // ebx
  int v3; // edx

  v2 = pRace->Unknown_1D1 - pRace->_treatiesScore[raceIndex];
  if ( v2 <= 0 )
  {
    v3 = 100;
  }
  else
  {
    v3 = 100 * v2 / (pRace->Unknown_1D1 - pRace->Unknown_1C9);
  }
  if ( v3 > 100 )
  {
    return 100;
  }
  return v3;
}

//----- (00043BDC) --------------------------------------------------------
void __fastcall Q_ReadWriteRace_sub_43BDC(P_Race pRace, P_CFile fi, int read)
{
  int homeStar; // eax
  T_Race vRace; // [esp+0h] [ebp-1F4h] BYREF
  P_CFile v6; // [esp+1F0h] [ebp-4h]

  v6 = fi;
  Q_RaceCtor_sub_3B120(&vRace);
  if ( read == TRUE )
  {
    Q_ReadFile_sub_1BF94(v6, &vRace, 0x1EEu);
    qmemcpy(pRace, &vRace, 0x1ECu);
    HIWORD(pRace->Unknown_1EA) = HIWORD(vRace.Unknown_1EA);
    homeStar = (int)pRace->_homeStar;
    pRace->Unknown_19B = 0;
    pRace->_homeStar = &V_Game.stars[homeStar];
  }
  else
  {
    qmemcpy(&vRace, pRace, sizeof(vRace));
    vRace._homeStar = (P_Star)vRace._homeStar->index;
    Q_CFile_DosWrite_sub_1C098(v6, &vRace, 0x1EEu);
  }
}

//----- (00043C80) --------------------------------------------------------
int __fastcall Q_RACENEG_CPP_sub_43C80(P_Race a1)
{
  FILE *v2; // ecx
  __int16 v3; // ax
  WORD Unknown_1C9; // dx
  __int16 v5; // ax
  WORD v6; // bx
  __int16 v7; // ax
  WORD v8; // di
  __int16 v9; // ax
  WORD allianceMaxScore; // dx
  __int16 v11; // ax
  WORD Unknown_1D1; // bx
  int nameIndex; // [esp-4h] [ebp-11Ch]
  char v15[204]; // [esp+0h] [ebp-118h] BYREF
  char s[52]; // [esp+CCh] [ebp-4Ch] BYREF
  int v17; // [esp+100h] [ebp-18h] BYREF

  nameIndex = a1->_nameIndex;
  V_Day1 = 0xFFFFFFF6;
  V_Day2 = 0xFFFFFFF6;
  V_Day3 = 0xFFFFFFF6;
  sprintf(s, "RACE%02d.DIP", nameIndex);
  v2 = Q_OpenFile_sub_1BB10(s, 0);
  if ( !v2 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x55);
  }
  v15[0] = 0;
  while ( strncmp(v15, "DIPVALUES", 9u) )
  {
    Q_HELPWIN_CPP_FgetsLine_sub_2FE58(v2, v15);
  }
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1C9 = v17;
  fscanf(v2, "%s %d", v15, &v17);
  v3 = v17;
  Unknown_1C9 = a1->Unknown_1C9;
  a1->Unknown_1CB[0] = v17;
  if ( v3 <= Unknown_1C9 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x64);
  }
  fscanf(v2, "%s %d", v15, &v17);
  v5 = v17;
  v6 = a1->Unknown_1CB[0];
  a1->Unknown_1CB[1] = v17;
  if ( v5 <= v6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x68);
  }
  fscanf(v2, "%s %d", v15, &v17);
  v7 = v17;
  v8 = a1->Unknown_1CB[1];
  a1->_allianceMaxScore = v17;
  if ( v7 <= v8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x6C);
  }
  fscanf(v2, "%s %d", v15, &v17);
  v9 = v17;
  allianceMaxScore = a1->_allianceMaxScore;
  a1->Unknown_1D1 = v17;
  if ( v9 <= allianceMaxScore )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x70);
  }
  fscanf(v2, "%s %d", v15, &v17);
  v11 = v17;
  Unknown_1D1 = a1->Unknown_1D1;
  a1->Unknown_1D3 = v17;
  if ( v11 <= Unknown_1D1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x74);
  }
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1D5 = v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1B0 = v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1D7 = v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1D9 = v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1DB = v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1DD = (float)(__int16)v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1E1 = (float)(__int16)v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1E5 = (float)(__int16)v17;
  fscanf(v2, "%s %d", v15, &v17);
  a1->Unknown_1C7 = v17;
  a1->ability = a1->_nameIndex;
  *(_DWORD *)a1->z2 = 0;
  return fclose(v2);
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00044024) --------------------------------------------------------
unsigned int __fastcall sub_44024(_BYTE *a1, char a2)
{
  int v3; // eax
  int v4; // edi
  T_Star *stars; // edx
  int exploredBits; // ebx
  int v8; // [esp+0h] [ebp-18h]

  v3 = 0;
  v8 = 0;
  v4 = 1 << a2;
  stars = V_Game.stars;
  while ( v3 < V_Game.starsNum )
  {
    exploredBits = stars->exploredBits;
    if ( ((1 << *a1) & exploredBits) != 0 && (v4 & exploredBits) != 0 )
    {
      return 0xFFFFFFFF;
    }
    ++v3;
    ++stars;
  }
  return v8;
}

//----- (00044080) --------------------------------------------------------
T_Race *__fastcall sub_44080(P_Race a1)
{
  P_Race v2; // kr08_4
  P_Race v3; // kr00_4
  char v4; // al
  T_Race *result; // eax
  char v6; // al
  int Unknown_1E9; // ecx
  int index; // ebx
  int i; // edi
  char v10; // [esp+0h] [ebp-2Ch]
  int v11; // [esp+4h] [ebp-28h] BYREF
  int v12[9]; // [esp+8h] [ebp-24h] BYREF

  if ( a1->index == V_PlayerRaceIndex && V_FlashPopExists != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0xCD);
  }
  v12[2] = (int)a1;
  v2 = a1;
  v3 = a1;
  a1->Unknown_1E9 = 0xE;
  v12[1] = (int)V_Game.races;
  for ( i = 0; i < 7; ++i )
  {
    if ( i != a1->index && V_Game.races[i].Unknown_03 != 0xFFFFFFFF )
    {
      if ( (i != V_PlayerRaceIndex || V_FlashPopExists == 0xFFFFFFFF) && !v3->treaties[i] && sub_44024(a1, i) == 0xFFFFFFFF )
      {
        v2->_treatiesScore[i] = a1->Unknown_1D5;
        V_Game.races[i]._treatiesScore[a1->index] = V_Game.races[i].Unknown_1D5;
        V_Game.races[i].treaties[a1->index] = 1;
        v3->treaties[i] = 1;
      }
      if ( v3->treaties[i] )
      {
        v6 = sub_44434(a1, i, &v11);
        if ( v6 != 0xE )
        {
          if ( i != V_PlayerRaceIndex || V_FlashPopExists )
          {
            v10 = v6;
            v4 = sub_44BCC(&V_Game.races[i], (__int16 *)a1->index, v6, v11, v12);
            sub_450B0(a1, i, v10, v4, v11, v12[0]);
          }
          else
          {
            a1->Unknown_1E9 = v6;
            Unknown_1E9 = a1->Unknown_1E9;
            index = a1->index;
            a1->Unknown_1EA = v11;
            Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_02_WOULD_LIKE_TO_SPEAK, index, Unknown_1E9);
          }
        }
      }
    }
    result = &V_Game.races[i + 1];
  }
  return result;
}

//----- (00044238) --------------------------------------------------------
int __fastcall sub_44238(int a1, __int16 a2, _BYTE *a3, __int16 a4)
{
  T_Race *v7; // edi
  int v8; // ecx
  char v9; // kr00_1
  _BYTE *v10; // eax
  int result; // eax
  int v12; // eax
  int v13; // eax
  int v14; // ecx
  int v15; // eax
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // ecx
  int v20; // eax
  _BYTE *v21; // [esp+4h] [ebp-10h]

  *a3 = 0xE;
  v7 = &V_Game.races[a2];
  v8 = 1;
  v9 = *(_BYTE *)(a1 + a2 + 0x1C0);
  v21 = a3 + 2;
  v10 = a3 + 1;
  switch ( v9 )
  {
    case 0:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x126);
      result = 1;
      break;
    case 1:
      *v10 = 2;
      *v21 = 3;
      v8 = 3;
      if ( V_Game.day - V_Day1 >= 5 )
      {
        v8 = 4;
        a3[3] = 4;
      }
      if ( V_Game.day - V_Day2 >= 5 )
      {
        v12 = (__int16)v8++;
        a3[v12] = 5;
      }
      if ( V_Game.day - V_Day3 >= 5 )
      {
        v13 = (__int16)v8++;
        a3[v13] = 6;
      }
      if ( !*(_BYTE *)(a1 + a4 + 0x1C0) || v7->treaties[a4] != 2 )
      {
        goto LABEL_29;
      }
      a3[(__int16)v8] = 7;
      result = v8 + 1;
      break;
    case 2:
      *v10 = 0xD;
      result = 2;
      break;
    case 3:
      *v10 = 8;
      v14 = 2;
      if ( V_Game.day - V_Day1 >= 5 )
      {
        v14 = 3;
        *v21 = 4;
      }
      if ( V_Game.day - V_Day2 >= 5 )
      {
        v15 = (__int16)v14++;
        a3[v15] = 5;
      }
      if ( V_Game.day - V_Day3 >= 5 )
      {
        v16 = (__int16)v14++;
        a3[v16] = 6;
      }
      a3[(__int16)v14] = 0xC;
      v8 = v14 + 1;
      if ( *(_BYTE *)(a1 + a4 + 0x1C0) && v7->treaties[a4] == 2 )
      {
        v17 = (__int16)v8++;
        a3[v17] = 7;
      }
      if ( *(_BYTE *)(a1 + a4 + 0x1C0) && v7->treaties[a4] == 1 )
      {
        v18 = (__int16)v8;
        v19 = v8 + 1;
        a3[v18] = 9;
        v20 = (__int16)v19;
        v8 = v19 + 1;
        a3[v20] = 0xB;
      }
      if ( !*(_BYTE *)(a1 + a4 + 0x1C0) || v7->treaties[a4] != 3 )
      {
        goto LABEL_29;
      }
      a3[(__int16)v8] = 0xA;
      result = v8 + 1;
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x17E);
LABEL_29:
      result = v8;
      break;
  }
  return result;
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00044434) --------------------------------------------------------
char __fastcall sub_44434(P_Race a1, __int16 a2, _DWORD *a3)
{
  char v5; // bh
  BYTE v6; // bl
  __int16 v8; // dx
  __int16 v9; // ax
  __int16 v10; // dx
  int v11; // [esp+0h] [ebp-18h]

  if ( a1->index == V_PlayerRaceIndex && V_FlashPopExists != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x18D);
  }
  v5 = sub_43374(a1, 0xFFFFFFFF);
  v6 = a1->treaties[a2];
  if ( (unsigned __int8)v6 < 2u )
  {
    if ( v6 == 1 )
    {
      if ( V_Game.atmosphere )
      {
        if ( V_Game.atmosphere <= 1u )
        {
          if ( a1->_treatiesScore[a2] < a1->Unknown_1C9 && a2 == V_PlayerRaceIndex )
          {
            return 2;
          }
        }
        else if ( V_Game.atmosphere == 2 )
        {
          if ( a1->_treatiesScore[a2] < a1->Unknown_1CB[0] && a2 == V_PlayerRaceIndex )
          {
            a1->_treatiesScore[a2] = a1->Unknown_1C9 - 1;
            return 2;
          }
          if ( a1->Unknown_1CB[1] > a1->_treatiesScore[a2] && a2 == V_PlayerRaceIndex )
          {
            a1->_treatiesScore[a2] = a1->Unknown_1CB[0] - 1;
          }
          else if ( a1->_allianceMaxScore > a1->_treatiesScore[a2] && a2 == V_PlayerRaceIndex )
          {
            a1->_treatiesScore[a2] = a1->Unknown_1CB[1] - 1;
          }
          else if ( a1->Unknown_1D1 > a1->_treatiesScore[a2] && a2 == V_PlayerRaceIndex )
          {
            a1->_treatiesScore[a2] = a1->_allianceMaxScore - 1;
          }
          else if ( a1->Unknown_1D3 > a1->_treatiesScore[a2] && a2 == V_PlayerRaceIndex )
          {
            a1->_treatiesScore[a2] = a1->Unknown_1D1 - 1;
          }
          else if ( a2 == V_PlayerRaceIndex )
          {
            a1->_treatiesScore[a2] = a1->Unknown_1D3 - 1;
          }
        }
      }
      else if ( a1->_treatiesScore[a2] < a1->Unknown_1C9
             && (!v5 || a2 == V_PlayerRaceIndex)
             && (a2 == V_PlayerRaceIndex || *(__int16 *)&V_Game.Unknown_D8A[6 * a1->index + 4] > 2) )
      {
        return 2;
      }
      if ( a1->Unknown_1D3 < a1->_treatiesScore[a2] )
      {
        return 3;
      }
    }
  }
  else if ( (unsigned __int8)v6 <= 2u )
  {
    if ( a1->_treatiesScore[a2] > a1->Unknown_1CB[1] )
    {
      return 0xD;
    }
  }
  else
  {
    if ( v6 != 3 )
    {
      goto LABEL_51;
    }
    if ( a1->_treatiesScore[a2] < a1->Unknown_1C9 && !v5 )
    {
      if ( a2 == V_PlayerRaceIndex || *(__int16 *)&V_Game.Unknown_D8A[6 * a1->index + 4] > 2 )
      {
        return 2;
      }
      return 8;
    }
    if ( a1->_allianceMaxScore > a1->_treatiesScore[a2] )
    {
      return 8;
    }
  }
LABEL_51:
  if ( V_Game.day % a1->Unknown_1C7 || a2 != V_PlayerRaceIndex || a1->treaties[a2] == 2 )
  {
    return 0xE;
  }
  v11 = rand() % 0x64;
  if ( a2 != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x212);
  }
  if ( a1->treaties[a2] != 3 || v11 >= 0x50 )
  {
LABEL_85:
    if ( a1->Unknown_1C9 <= a1->_treatiesScore[a2] )
    {
      if ( a1->treaties[a2] == 3 )
      {
        v11 += 0xF;
      }
      if ( a1->_treatiesScore[a2] > a1->_allianceMaxScore + 0xA && v11 >= 0x5D && sub_46208(a1, a2) )
      {
        return 6;
      }
      if ( a1->_allianceMaxScore < a1->_treatiesScore[a2] && v11 >= 0x58 && sub_46034(a1, a2) )
      {
        return 5;
      }
      if ( a1->_treatiesScore[a2] > a1->Unknown_1D5 + 0x14 && v11 >= 0x50 && sub_45E64(a1, a2) )
      {
        return 4;
      }
    }
    return 0xE;
  }
  v8 = 0;
  if ( V_Game.racesNum > 0 )
  {
    while ( v8 == a1->index
         || v8 == a2
         || V_Game.races[v8].Unknown_03 == 0xFFFFFFFF
         || a1->treaties[v8] != 2
         || V_Game.races[V_PlayerRaceIndex].treaties[v8] != 3 )
    {
      if ( ++v8 >= V_Game.racesNum )
      {
        goto LABEL_67;
      }
    }
    *a3 = v8;
    return 0xA;
  }
  else
  {
LABEL_67:
    v9 = 0;
    if ( V_Game.racesNum > 0 )
    {
      while ( v9 == a1->index
           || v9 == a2
           || V_Game.races[v9].Unknown_03 == 0xFFFFFFFF
           || a1->treaties[v9] != 3
           || V_Game.races[V_PlayerRaceIndex].treaties[v9] != 2 )
      {
        if ( ++v9 >= V_Game.racesNum )
        {
          goto LABEL_76;
        }
      }
      *a3 = v9;
      return 7;
    }
    else
    {
LABEL_76:
      v10 = 0;
      if ( V_Game.racesNum <= 0 )
      {
        goto LABEL_85;
      }
      while ( v10 == a1->index
           || v10 == a2
           || V_Game.races[v10].Unknown_03 == 0xFFFFFFFF
           || a1->treaties[v10] != 2
           || V_Game.races[V_PlayerRaceIndex].treaties[v10] != 1 )
      {
        if ( ++v10 >= V_Game.racesNum )
        {
          goto LABEL_85;
        }
      }
      *a3 = v10;
      return 9;
    }
  }
}

//----- (00044A2C) --------------------------------------------------------
int __fastcall sub_44A2C(_BYTE *a1, int a2, char a3, _BYTE *a4)
{
  _BYTE *v4; // eax
  int result; // eax

  if ( *a1 != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x263);
  }
  v4 = a4 + 1;
  switch ( a3 )
  {
    case 0:
      *a4 = 0;
      result = 1;
      break;
    case 1:
      *a4 = 1;
      *v4 = 2;
      result = 2;
      break;
    case 2:
      *a4 = 3;
      result = 1;
      break;
    case 3:
      *a4 = 4;
      *v4 = 5;
      result = 2;
      break;
    case 4:
      *a4 = 6;
      *v4 = 7;
      result = 2;
      break;
    case 5:
      *a4 = 8;
      *v4 = 9;
      result = 2;
      break;
    case 6:
      *a4 = 0xA;
      *v4 = 0xB;
      result = 2;
      break;
    case 7:
      *a4 = 0xC;
      *v4 = 0xD;
      result = 2;
      break;
    case 8:
      *a4 = 0xE;
      result = 1;
      break;
    case 9:
      *a4 = 0xF;
      *v4 = 0x10;
      result = 2;
      break;
    case 0xA:
      *a4 = 0x11;
      *v4 = 0x12;
      result = 2;
      break;
    case 0xB:
      *a4 = 0x13;
      *v4 = 0x14;
      result = 2;
      break;
    case 0xC:
      *a4 = 0x15;
      *v4 = 0x16;
      result = 2;
      break;
    case 0xD:
      *a4 = 0x1B;
      *v4 = 0x1C;
      result = 2;
      break;
    case 0xE:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x2CF);
      result = 0xE;
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x2D4);
      JUMPOUT(0x44B91);
  }
  return result;
}
// 44B8C: control flows out of bounds to 44B91

//----- (00044BCC) --------------------------------------------------------
char __fastcall sub_44BCC(T_Race *a1, __int16 *a2, char a3, int a4, int *a5)
{
  WORD v7; // di
  int v8; // ebx
  const char *v9; // edx
  int v10; // [esp+0h] [ebp-1B8h] BYREF

  a1->Unknown_1EA = a4;
  switch ( a3 )
  {
    case 2:
      return 3;
    case 3:
      if ( a1->_treatiesScore[(__int16)a2] <= a1->Unknown_1D1 )
      {
        return 5;
      }
      else
      {
        return 4;
      }
    case 4:
      if ( a1->_treatiesScore[(__int16)a2] > a1->Unknown_1D5 + 0x14 && sub_45E64(a1, (__int16)a2) )
      {
        return 6;
      }
      else
      {
        return 7;
      }
    case 5:
      if ( a1->_allianceMaxScore < a1->_treatiesScore[(__int16)a2] && sub_46034(a1, (__int16)a2) )
      {
        return 8;
      }
      else
      {
        return 9;
      }
    case 6:
      if ( a1->_treatiesScore[(__int16)a2] > a1->_allianceMaxScore + 0xA && sub_46208(a1, (__int16)a2) )
      {
        return 0xA;
      }
      else
      {
        return 0xB;
      }
    case 7:
      if ( a1->treaties[a4] != 2 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x336);
      }
      if ( a1->_treatiesScore[a4] + (__int16)(a1->_treatiesScore[(__int16)a2] - V_Game.races[(__int16)a2].Unknown_1D1) <= a1->Unknown_1CB[1] )
      {
        return 0xD;
      }
      else
      {
        return 0xC;
      }
    case 8:
      return 0xE;
    case 9:
      if ( a1->treaties[(__int16)a2] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x34A);
      }
      if ( a1->treaties[a4] != 1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x34B);
      }
      if ( (__int16)(a1->_treatiesScore[(__int16)a2] - a1->_treatiesScore[a4]) <= a1->Unknown_1D5 )
      {
        return 0x10;
      }
      else
      {
        return 0xF;
      }
    case 0xA:
      if ( a1->treaties[(__int16)a2] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x361);
      }
      if ( a1->treaties[a4] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x362);
      }
      v7 = a1->_treatiesScore[a4];
      if ( (__int16)(a1->_treatiesScore[(__int16)a2] - v7) <= 0
        || (__int16)(a1->_treatiesScore[(__int16)a2] - V_Game.races[(__int16)a2].Unknown_1D1) - (__int16)(v7 - V_Game.races[a4].Unknown_1D1) <= 0 )
      {
        return 0x12;
      }
      else
      {
        return 0x11;
      }
    case 0xB:
      if ( a1->treaties[(__int16)a2] != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x384);
      }
      if ( a1->treaties[a4] != 1 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x385);
      }
      if ( a1->_treatiesScore[a4] - (__int16)(a1->_treatiesScore[(__int16)a2] - V_Game.races[(__int16)a2].Unknown_1D1) >= a1->Unknown_1C9 )
      {
        return 0x14;
      }
      else
      {
        return 0x13;
      }
    case 0xC:
      if ( !a4 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x39D);
      }
      if ( a5 )
      {
        *a5 = a4;
      }
      if ( !Q_Race_CalculateShipsAtLocation_sub_45958(a1, 2, (P_Location)a4, 0) )
      {
        return 0x18;
      }
      if ( (unsigned __int16)sub_45848(&a1->index, a4, (int)&v10, a2) )
      {
        if ( ((1 << a1->index) & *(unsigned __int8 *)(a4 + 0x15)) != 0 )
        {
          return 0x1A;
        }
        else if ( a1->Unknown_1D3 >= a1->_treatiesScore[(__int16)a2] )
        {
          return 0x16;
        }
        else
        {
          return 0x15;
        }
      }
      else if ( ((1 << a1->index) & *(unsigned __int8 *)(a4 + 0x15)) != 0 )
      {
        return 0x19;
      }
      else
      {
        return 0x17;
      }
    case 0xD:
      if ( a1->_treatiesScore[(__int16)a2] < a1->Unknown_1CB[0] )
      {
        return 0x1C;
      }
      else
      {
        return 0x1B;
      }
    case 0xE:
      v8 = 0x3CE;
      v9 = "..\\raceneg.cpp";
      break;
    default:
      v8 = 0x3D3;
      v9 = "..\\raceneg.cpp";
      break;
  }
  Q_AssertLogBreakExit_sub_261A8(0, v9, v8);
  JUMPOUT(0x45065);
}
// 45060: control flows out of bounds to 45065

//----- (000450B0) --------------------------------------------------------
void __fastcall sub_450B0(P_Race a1, __int16 a2, char a3, char a4, int a5, int a6)
{
  T_Race *v7; // edi
  char *v8; // edx
  int index; // eax
  int v10; // edx
  int v11; // eax
  int v12; // edx
  int v13; // eax
  int v14; // edx
  int v15; // eax
  int v16; // eax
  int v17; // edx
  WORD v18; // cx
  int v19; // edx
  int v20; // edx
  __int16 v21; // ax
  _BYTE v22[428]; // [esp+0h] [ebp-1D4h] BYREF
  int Unknown_1D1; // [esp+1ACh] [ebp-28h]
  unsigned int v24; // [esp+1B0h] [ebp-24h]
  int v25; // [esp+1B4h] [ebp-20h]
  int v26; // [esp+1B8h] [ebp-1Ch]
  int v27; // [esp+1BCh] [ebp-18h]
  T_Race *v28; // [esp+1C0h] [ebp-14h]
  __int16 v29; // [esp+1C4h] [ebp-10h]

  v29 = a2;
  v26 = a2;
  v7 = &V_Game.races[a2];
  v25 = (int)v7 + a5;
  v24 = 0x1EE * a5;
  v28 = &V_Game.races[a5];
  v27 = (int)v28 + a2;
  v8 = (char *)v28 + 2 * a2;
  switch ( a3 )
  {
    case 0:
      index = a1->index;
      v10 = v29;
      v7->treaties[index] = 1;
      a1->treaties[v10] = v7->treaties[index];
      a1->_treatiesScore[v29] = a1->Unknown_1D5;
      v7->_treatiesScore[a1->index] = v7->Unknown_1D5;
      return;
    case 1:
      if ( a4 == 1 )
      {
        a1->_treatiesScore[v29] += 0x28;
      }
      return;
    case 2:
      v11 = a1->index;
      v12 = v29;
      v7->treaties[v11] = 2;
      a1->treaties[v12] = v7->treaties[v11];
      v7->_treatiesScore[a1->index] -= 0x28;
      return;
    case 3:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->_treatiesScore[V_PlayerRaceIndex] += 3;
      }
      if ( a4 == 4 )
      {
        v13 = a1->index;
        v14 = v29;
        v7->treaties[v13] = 3;
        a1->treaties[v14] = v7->treaties[v13];
        a1->_treatiesScore[v14] += 0xA;
        v7->_treatiesScore[a1->index] += 0xA;
      }
      else
      {
        a1->_treatiesScore[v29] = a1->Unknown_1D1;
      }
      return;
    case 4:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->_treatiesScore[V_PlayerRaceIndex] += 5;
        V_Day1 = V_Game.day;
      }
      if ( a4 == 6 )
      {
        sub_45F60(a1, v29, 0);
        a1->_treatiesScore[v29] += 0xA;
        v7->_treatiesScore[a1->index] += 5;
      }
      else
      {
        v17 = v29;
        v18 = a1->_treatiesScore[v29] - 2;
        a1->_treatiesScore[v29] = v18;
        if ( a1->treaties[v17] == 3 )
        {
          a1->_treatiesScore[v29] = v18 - 2;
        }
      }
      return;
    case 5:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->_treatiesScore[V_PlayerRaceIndex] += 8;
        V_Day2 = V_Game.day;
      }
      if ( a4 == 8 )
      {
        sub_46130(a1, v29, 0);
        a1->_treatiesScore[v29] += 0xA;
        v7->_treatiesScore[a1->index] += 5;
      }
      else
      {
        v19 = v29;
        a1->_treatiesScore[v29] -= 3;
        if ( a1->treaties[v19] == 3 )
        {
          a1->_treatiesScore[v29] -= 3;
        }
      }
      return;
    case 6:
      if ( V_PlayerRaceIndex == a1->index )
      {
        v7->_treatiesScore[V_PlayerRaceIndex] += 8;
        V_Day3 = V_Game.day;
      }
      if ( a4 == 0xA )
      {
        sub_46304(a1, v29, 0);
        a1->_treatiesScore[v29] += 0xA;
        v7->_treatiesScore[a1->index] += 0xA;
      }
      else
      {
        v20 = v29;
        a1->_treatiesScore[v29] -= 2;
        if ( a1->treaties[v20] == 3 )
        {
          a1->_treatiesScore[v29] -= 2;
        }
      }
      return;
    case 7:
      if ( a4 != 0xC )
      {
        goto LABEL_54;
      }
      a1->_treatiesScore[v26] += 5;
      if ( *((__int16 *)v8 + 0xD9) > V_Game.races[v24 / 0x1EE].Unknown_1CB[0] - 0xA )
      {
        a1->_treatiesScore[v26] += 5;
        *(_BYTE *)(v25 + 0x1C0) = 1;
        *(_BYTE *)(v27 + 0x1C0) = 1;
        v7->_treatiesScore[a5] += 0xA;
        v7->_treatiesScore[a1->index] += 5;
        *((_WORD *)v8 + 0xD9) += 0xA;
        v28->_treatiesScore[a1->index] += 0xF;
      }
      return;
    case 8:
      v16 = a1->index;
      v7->treaties[v16] = 1;
      a1->treaties[v26] = v7->treaties[v16];
      v7->_treatiesScore[a1->index] -= 0x1E;
      return;
    case 9:
      if ( a4 == 0xF )
      {
        a1->_treatiesScore[v26] += 0xA;
        *(_BYTE *)(v25 + 0x1C0) = 2;
        *(_BYTE *)(v27 + 0x1C0) = 2;
        v7->_treatiesScore[a5] -= 0xF;
        v7->_treatiesScore[a1->index] += 0xA;
        *((_WORD *)v8 + 0xD9) -= 0x14;
      }
      goto LABEL_38;
    case 0xA:
      if ( a4 == 0x11 )
      {
        a1->_treatiesScore[v26] += 0xF;
        *(_BYTE *)(v25 + 0x1C0) = 1;
        *(_BYTE *)(v27 + 0x1C0) = 1;
        v7->_treatiesScore[a5] -= 5;
        v7->_treatiesScore[a1->index] -= 5;
        *((_WORD *)v8 + 0xD9) -= 0xA;
LABEL_41:
        a1->_treatiesScore[v26] -= 5;
      }
      else
      {
LABEL_38:
        a1->_treatiesScore[v26] -= 0xA;
      }
      break;
    case 0xB:
      if ( a4 != 0x13 )
      {
        goto LABEL_41;
      }
      a1->_treatiesScore[v26] += 5;
      Unknown_1D1 = V_Game.races[v24 / 0x1EE].Unknown_1D1;
      if ( *((__int16 *)v8 + 0xD9) > Unknown_1D1 - 0xA )
      {
        a1->_treatiesScore[v26] += 5;
        *(_BYTE *)(v25 + 0x1C0) = 3;
        *(_BYTE *)(v27 + 0x1C0) = 3;
        v7->_treatiesScore[a5] += 0xA;
        v7->_treatiesScore[a1->index] += 5;
        *((_WORD *)v8 + 0xD9) += 0xF;
        v28->_treatiesScore[a1->index] += 0xA;
      }
      break;
    case 0xC:
      if ( a4 == 0x15 || a4 == 0x1A )
      {
        if ( v29 != V_PlayerRaceIndex )
        {
          if ( !a5 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x4FA);
          }
          v21 = sub_45848(&v7->index, a5, (int)v22, (__int16 *)v7);
          if ( !v21 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x4FD);
          }
          sub_45A0C(v7, a5, (int)v22, v21);
          a1->_treatiesScore[v29] += 0xA;
        }
      }
      else if ( a4 == 0x16 )
      {
LABEL_54:
        a1->_treatiesScore[v26] -= 5;
      }
      return;
    case 0xD:
      if ( a1->index == V_PlayerRaceIndex )
      {
        v7->_treatiesScore[V_PlayerRaceIndex] += 3;
      }
      if ( a4 == 0x1B )
      {
        v15 = v29;
        v7->treaties[a1->index] = 1;
        a1->treaties[v15] = v7->treaties[a1->index];
      }
      else
      {
        a1->_treatiesScore[v29] -= 0x19;
      }
      return;
    case 0xE:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\raceneg.cpp", 0x515);
      return;
    default:
      return;
  }
}
// 105248: using guessed type int V_Day1;
// 10524C: using guessed type int V_Day2;
// 105250: using guessed type int V_Day3;

//----- (00045848) --------------------------------------------------------
int __usercall sub_45848@<eax>(unsigned __int8 *a1@<eax>, int a2@<edx>, int a3@<ebx>, __int16 *x_low@<edi>)
{
  __int16 i; // si
  int v6; // eax
  int v7; // ebx
  int v8; // ebx
  char v9; // al
  P_Location v10; // ebx
  int v12[107]; // [esp+0h] [ebp-1CCh] BYREF
  int v13; // [esp+1ACh] [ebp-20h]
  int v14; // [esp+1B0h] [ebp-1Ch]
  int v15; // [esp+1B4h] [ebp-18h]
  int Ships_sub_40224; // [esp+1B8h] [ebp-14h]

  v13 = a2;
  v14 = a3;
  LOWORD(v15) = 0;
  Ships_sub_40224 = Q_Race_GetShips_sub_40224((P_Race)a1, (P_ShipsList)v12, 0);
  if ( (__int16)Ships_sub_40224 > 0 )
  {
    for ( i = 0; i < (__int16)Ships_sub_40224; ++i )
    {
      v8 = v12[i];
      v9 = *(_BYTE *)(v8 + 0x58);
      v10.pPlanet = *(P_Planet *)(v8 + 0x59);
      if ( v9 != 1 && v9 != 2 )
      {
        if ( v9 == 3 )
        {
          x_low = (__int16 *)&V_Game.stars[v10.pPlanet->starIndex];
LABEL_8:
          if ( V_Game.starConnections[x_low[2]][*(__int16 *)(v13 + 4)] < 3u )
          {
            v6 = 4 * (__int16)v15;
            v7 = v12[i];
            LOWORD(v15) = v15 + 1;
            *(_DWORD *)(v14 + v6) = v7;
          }
          continue;
        }
        if ( v9 != 4 )
        {
          if ( v9 == 5 )
          {
            x_low = (__int16 *)LODWORD(v10.pPlanet->position.x);
          }
          goto LABEL_8;
        }
        x_low = (__int16 *)v10.pPlanet;
        if ( !Q_Race_CalculateShipsAtLocation_sub_45958((P_Race)a1, 2, v10, 0) )
        {
          goto LABEL_8;
        }
      }
    }
  }
  return v15;
}
// 45848: using guessed type int var_1CC[107];

//----- (00045958) --------------------------------------------------------
// Calculates diplomatic relations and combat strength between a race and ships at a location
// Returns: Number of matching ships
// Outputs: Total combat strength through strengthOut parameter
int __fastcall Q_Race_CalculateShipsAtLocation_sub_45958(P_Race pRace, BYTE treaty, P_Location targetLocation, LONG *strengthOut)
{
  __int16 matchingShipsCount; // di
  LONG totalCombatStrength; // ecx
  P_Ship pShip; // eax
  __int16 i; // bx
  P_Ship shipsAtLocation[107]; // [esp+0h] [ebp-1C4h] BYREF
  int shipsFoundCount; // [esp+1ACh] [ebp-18h]
  LONG *strengthOutput; // [esp+1B0h] [ebp-14h]
  BYTE requiredTreaty; // [esp+1B4h] [ebp-10h]

  requiredTreaty = treaty;
  strengthOutput = strengthOut;
  if ( !targetLocation.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x54E);
  }
  matchingShipsCount = 0;
  totalCombatStrength = 0;
  shipsFoundCount = Q_FindShipsAtLocation_sub_1D794(targetLocation, shipsAtLocation);
  for ( i = 0; i < shipsFoundCount; ++i )
  {
    pShip = shipsAtLocation[i];
    if ( pShip
      && (pShip->raceIndex == pRace->index && requiredTreaty == ASCEND_TREATY_ALLIANCE || pRace->treaties[pShip->raceIndex] == requiredTreaty) )
    {
      ++matchingShipsCount;
      totalCombatStrength += pShip->totalWeaponDamage * pShip->hullIntegrity;
    }
  }
  if ( strengthOutput )
  {
    *strengthOutput = totalCombatStrength;
  }
  return matchingShipsCount;
}

//----- (00045A0C) --------------------------------------------------------
int __fastcall sub_45A0C(_BYTE *a1, int a2, int a3, __int16 a4)
{
  int result; // eax
  int v6; // edx

  if ( *a1 == V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x574);
  }
  for ( result = 0; (__int16)result < a4; *(_DWORD *)(v6 + 0x5E) = a2 )
  {
    *(_BYTE *)(*(_DWORD *)(a3 + 4 * (__int16)result) + 0x5D) = 1;
    v6 = *(_DWORD *)(a3 + 4 * (__int16)result++);
  }
  return result;
}

//----- (00045A54) --------------------------------------------------------
unsigned int __fastcall sub_45A54(P_Race pRace, P_Star pStar, P_Ship pShip)
{
  __int16 v5; // ax
  int v6; // edx
  WORD i; // ax
  int v8; // kr04_4
  __int16 v9; // ax
  int racePresenceBits; // edx
  __int16 eventId; // dx
  UBYTE v12; // cl
  WORD v15; // si
  unsigned int v16; // [esp+0h] [ebp-2Ch]
  unsigned int v17; // [esp+4h] [ebp-28h]
  unsigned int v18; // [esp+8h] [ebp-24h]
  unsigned int v19; // [esp+14h] [ebp-18h]
  int v20; // [esp+18h] [ebp-14h]

  if ( pRace->index != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x58A);
  }
  if ( (byte_D8460[pStar->index] & 1) != 0 )
  {
    return 0;
  }
  v20 = 0;
  v16 = 0;
  v18 = 0;
  v17 = 0;
  v19 = 0;
  v5 = 0;
  if ( V_Game.racesNum > 0 )
  {
    while ( v5 == V_PlayerRaceIndex || pRace->treaties[v5] || ((1 << v5) & (pStar->racesBits | pStar->racePresenceBits)) == 0 )
    {
      if ( ++v5 >= V_Game.racesNum )
      {
        goto LABEL_11;
      }
    }
    v20 = v5;
    pRace->treaties[v5] = 1;
    v16 = 0xFFFFFFFF;
    pRace->_treatiesScore[v5] = pRace->Unknown_1D5;
    v6 = v5;
    V_Game.races[v6].treaties[pRace->index] = 1;
    V_Game.races[0]._treatiesScore[pRace->index + v6 * 0xF7] = V_Game.races[v5].Unknown_1D5;
  }
LABEL_11:
  if ( !v16 )
  {
    for ( i = 0; i < V_Game.racesNum; ++i )
    {
      if ( i != V_PlayerRaceIndex && pRace->treaties[i] == 2 )
      {
        if ( ((1 << i) & pStar->racePresenceBits) != 0 )
        {
          v20 = i;
          v18 = 0xFFFFFFFF;
        }
        if ( !v18 && ((1 << i) & pStar->racesBits) != 0 )
        {
          v17 = 0xFFFFFFFF;
          v20 = i;
        }
      }
    }
  }
  if ( !v16 && !v18 && !v17 && V_Game.racesNum > 0 )
  {
    v8 = 0;
    v15 = 0;
    do
    {
      if ( v15 != V_PlayerRaceIndex )
      {
        v9 = 0;
        if ( V_Game.racesNum > 0 )
        {
          racePresenceBits = pStar->racePresenceBits;
          while ( ((1 << v15) & racePresenceBits) == 0 || ((1 << v9) & racePresenceBits) == 0 || V_Game.races[v8].treaties[v9] != 2 )
          {
            if ( ++v9 >= V_Game.racesNum )
            {
              goto LABEL_34;
            }
          }
          v19 = 0xFFFFFFFF;
        }
      }
LABEL_34:
      ++v15;
      ++v8;
    }
    while ( v15 < V_Game.racesNum );
  }
  if ( v16 == 0xFFFFFFFF )
  {
    eventId = ASCEND_EP_FINDRACE;
  }
  else if ( v18 == 0xFFFFFFFF )
  {
    eventId = ASCEND_EP_HOSTILESHIP;
  }
  else if ( v17 == 0xFFFFFFFF )
  {
    eventId = ASCEND_EP_HOSTILEPLAN;
  }
  else if ( v19 == 0xFFFFFFFF )
  {
    eventId = ASCEND_EP_OTHERWAR;
  }
  else
  {
    v12 = V_PlayerRaceIndex;
    pShip->order = 0;
    pShip->_orderTargetObject.pPlanet = 0;
    if ( ((1 << v12) & pStar->exploredBits) != 0 )
    {
      eventId = ASCEND_EP_SHIPARRIVE;
    }
    else
    {
      eventId = ASCEND_EP_20_DISCOVERED_SYSTEM;
    }
  }
  byte_D8460[pStar->index] |= 1u;
  Q_AddGameEvent_sub_55AEC(&WinMgr, eventId, (int)pShip, v20);
  return 0xFFFFFFFF;
}
// 45D0F: conditional instruction was optimized away because edx.4 is in (3..7|==14)

//----- (00045D50) --------------------------------------------------------
unsigned int __fastcall sub_45D50(P_Race pRace, P_Star pStar, P_Ship pShip)
{
  int racePresenceBits; // ebx
  unsigned int v6; // edx
  BYTE v7; // cl
  WORD raceIndex; // [esp+2h] [ebp-14h]

  if ( pRace->index != V_PlayerRaceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\raceneg.cpp", 0x61C);
  }
  raceIndex = pShip->raceIndex;
  racePresenceBits = pStar->racePresenceBits;
  v6 = 0xFFFFFFFF;
  if ( ((1 << raceIndex) & racePresenceBits) == 0 )
  {
    v7 = pRace->treaties[raceIndex];
    if ( v7 )
    {
      if ( v7 == 2 )
      {
        v6 = 9;
      }
    }
    else
    {
      pRace->treaties[raceIndex] = 1;
      pRace->_treatiesScore[raceIndex] = pRace->Unknown_1D5;
      V_Game.races[raceIndex].treaties[pRace->index] = 1;
      v6 = 8;
      V_Game.races[raceIndex]._treatiesScore[pRace->index] = V_Game.races[raceIndex].Unknown_1D5;
    }
  }
  if ( v6 == 0xFFFFFFFF || (byte_D8460[pStar->index] & 1) != 0 )
  {
    return 0;
  }
  Q_AddGameEvent_sub_55AEC(&WinMgr, (__int16)v6, (int)pShip, raceIndex);
  byte_D8460[pStar->index] |= 1u;
  return 0xFFFFFFFF;
}

//----- (00045E64) --------------------------------------------------------
unsigned int __fastcall sub_45E64(_BYTE *a1, __int16 a2)
{
  unsigned __int8 v2; // al
  int i; // edx
  float v6; // [esp+4h] [ebp-24h]
  __int16 v7; // [esp+8h] [ebp-20h]
  __int16 v8; // [esp+Ch] [ebp-1Ch]
  unsigned __int8 v9; // [esp+14h] [ebp-14h]

  if ( a1[a2 + 0x1C0] == 3 )
  {
    return 0xFFFFFFFF;
  }
  v8 = 0;
  v9 = 1 << *a1;
  v7 = 0;
  v2 = 1 << a2;
  for ( i = 0; (__int16)i < V_Game.lanesNum; ++i )
  {
    if ( (v9 & V_Game.lanes[i].exploredBits) != 0 )
    {
      ++v8;
    }
    if ( (v2 & V_Game.lanes[i].exploredBits) != 0 )
    {
      ++v7;
    }
  }
  if ( v8 >= 5 )
  {
    if ( !v7 )
    {
      v7 = 1;
    }
    v6 = (float)v8;
    if ( v6 / (double)V_Game.lanesNum > 0.9 )
    {
      return 0;
    }
    if ( v6 / (double)v7 > 2.0 )
    {
      return 0;
    }
    return 0xFFFFFFFF;
  }
  return 0;
}

//----- (00045F60) --------------------------------------------------------
void __fastcall sub_45F60(_BYTE *a1, __int16 a2, int a3)
{
  int v5; // ebx
  int v6; // esi
  int v7; // eax
  int v8; // edx
  int v9; // ebp
  __int64 v10; // rtt
  unsigned __int8 v11; // dh
  unsigned __int8 v12; // dl
  int v13; // ecx
  int v14; // kr04_4
  int v16; // [esp+4h] [ebp-14h]

  v5 = 0;
  v6 = 0;
  if ( a1[a2 + 0x1C0] == 3 )
  {
    v7 = rand();
    v8 = v7;
    v9 = 6;
  }
  else
  {
    v7 = rand();
    v8 = v7;
    v9 = 3;
  }
  LODWORD(v10) = v7;
  HIDWORD(v10) = v8 >> 0x1F;
  v16 = v10 % v9 + 1;
  v11 = 1 << *a1;
  v12 = 1 << V_Game.races[a2].index;
  v13 = 0;
  if ( V_Game.lanesNum > 0 )
  {
    v14 = 0;
    do
    {
      if ( a3 || (v11 & V_Game.lanes[v14].exploredBits) == 0 )
      {
        if ( (v12 & V_Game.lanes[v14].exploredBits) != 0 && v5 < v16 && (v11 & V_Game.lanes[v14].exploredBits) == 0 )
        {
          ++v5;
          V_Game.lanes[v14].exploredBits |= v11;
        }
      }
      else if ( v6 < v16 && (v12 & V_Game.lanes[v14].exploredBits) == 0 )
      {
        ++v6;
        V_Game.lanes[v14].exploredBits |= v12;
      }
      ++v13;
      ++v14;
    }
    while ( (__int16)v13 < V_Game.lanesNum );
  }
}

//----- (00046034) --------------------------------------------------------
unsigned int __fastcall sub_46034(_BYTE *a1, __int16 a2)
{
  unsigned __int8 v2; // al
  int i; // edx
  float v6; // [esp+4h] [ebp-24h]
  __int16 v7; // [esp+8h] [ebp-20h]
  __int16 v8; // [esp+Ch] [ebp-1Ch]
  unsigned __int8 v9; // [esp+14h] [ebp-14h]

  if ( a1[a2 + 0x1C0] == 3 )
  {
    return 0xFFFFFFFF;
  }
  v8 = 0;
  v9 = 1 << *a1;
  v7 = 0;
  v2 = 1 << a2;
  for ( i = 0; (__int16)i < V_Game.starsNum; ++i )
  {
    if ( (v9 & V_Game.stars[i].exploredBits) != 0 )
    {
      ++v8;
    }
    if ( (v2 & V_Game.stars[i].exploredBits) != 0 )
    {
      ++v7;
    }
  }
  if ( v8 >= 3 )
  {
    if ( !v7 )
    {
      v7 = 1;
    }
    v6 = (float)v8;
    if ( v6 / (double)V_Game.starsNum > 0.9 )
    {
      return 0;
    }
    if ( v6 / (double)v7 > 1.6 )
    {
      return 0;
    }
    return 0xFFFFFFFF;
  }
  return 0;
}

//----- (00046130) --------------------------------------------------------
void __fastcall sub_46130(_BYTE *a1, __int16 a2, int a3)
{
  int v5; // esi
  int v6; // ebx
  int v7; // eax
  int v8; // edx
  int v9; // ebp
  __int64 v10; // rtt
  unsigned __int8 v11; // dh
  unsigned __int8 v12; // dl
  int v13; // ecx
  int v14; // kr04_4
  int v16; // [esp+4h] [ebp-14h]

  v5 = 0;
  v6 = 0;
  if ( a1[a2 + 0x1C0] == 3 )
  {
    v7 = rand();
    v8 = v7;
    v9 = 4;
  }
  else
  {
    v7 = rand();
    v8 = v7;
    v9 = 2;
  }
  LODWORD(v10) = v7;
  HIDWORD(v10) = v8 >> 0x1F;
  v16 = v10 % v9 + 1;
  v11 = 1 << *a1;
  v12 = 1 << V_Game.races[a2].index;
  v13 = 0;
  if ( V_Game.starsNum > 0 )
  {
    v14 = 0;
    do
    {
      if ( a3 || (v11 & V_Game.stars[v14].exploredBits) == 0 )
      {
        if ( (v12 & V_Game.stars[v14].exploredBits) != 0 && v5 < v16 && (v11 & V_Game.stars[v14].exploredBits) == 0 )
        {
          V_Game.stars[v14].exploredPathToBits |= v11;
          ++v5;
          V_Game.stars[v14].exploredBits |= v11;
        }
      }
      else if ( v6 < v16 && (v12 & V_Game.stars[v14].exploredBits) == 0 )
      {
        V_Game.stars[v14].exploredPathToBits |= v12;
        ++v6;
        V_Game.stars[v14].exploredBits |= v12;
      }
      ++v13;
      ++v14;
    }
    while ( (__int16)v13 < V_Game.starsNum );
  }
}

//----- (00046208) --------------------------------------------------------
unsigned int __fastcall sub_46208(_BYTE *a1, __int16 a2)
{
  unsigned __int8 v2; // al
  int v3; // kr04_4
  __int16 i; // dx
  float v7; // [esp+0h] [ebp-20h]
  __int16 v8; // [esp+8h] [ebp-18h]
  __int16 v9; // [esp+Ch] [ebp-14h]
  unsigned __int8 v10; // [esp+14h] [ebp-Ch]

  if ( a1[a2 + 0x1C0] == 3 )
  {
    return 0xFFFFFFFF;
  }
  v8 = 0;
  v10 = 1 << *a1;
  v9 = 0;
  v2 = 1 << a2;
  v3 = 0;
  for ( i = 0; i < (int)V_Research.num; ++i )
  {
    if ( (v10 & V_Research.techs[v3].knownToRace) != 0 )
    {
      ++v8;
    }
    if ( (v2 & V_Research.techs[v3].knownToRace) != 0 )
    {
      ++v9;
    }
    ++v3;
  }
  if ( v8 >= 5 )
  {
    if ( !v9 )
    {
      v9 = 1;
    }
    v7 = (float)v8;
    if ( v7 / (double)V_Research.num > 0.85 )
    {
      return 0;
    }
    if ( v7 / (double)v9 > 1.7 )
    {
      return 0;
    }
    return 0xFFFFFFFF;
  }
  return 0;
}

//----- (00046304) --------------------------------------------------------
int __fastcall sub_46304(_BYTE *a1, __int16 a2, int a3)
{
  int v4; // ebx
  int v5; // esi
  unsigned __int8 v6; // cl
  __int64 techs; // rax
  int v8; // kr04_4
  int v11; // [esp+Ch] [ebp-2Ch]
  __int16 v12; // [esp+18h] [ebp-20h]
  __int16 index; // [esp+20h] [ebp-18h]
  unsigned __int8 v14; // [esp+24h] [ebp-14h]

  v4 = 0;
  v5 = 0;
  if ( a1[a2 + 0x1C0] == 3 )
  {
    v11 = rand() % 2 + 1;
  }
  else
  {
    v11 = 1;
  }
  v14 = 1 << *a1;
  v6 = 1 << V_Game.races[a2].index;
  v12 = (unsigned __int8)*a1;
  index = V_Game.races[a2].index;
  techs = (unsigned int)V_Research.techs;
  v8 = 0;
  while ( V_Research.num > SWORD2(techs) )
  {
    if ( a3 || (V_Research.techs[v8].knownToRace & v14) == 0 )
    {
      if ( (v6 & V_Research.techs[v8].knownToRace) != 0 && v4 < v11 && (v14 & V_Research.techs[v8].knownToRace) == 0 )
      {
        V_Research.techs[v8].knownToRace |= v14;
        if ( V_Research.current.project[v12] == SWORD2(techs) )
        {
          V_Research.current.project[v12] = 0xFFFF;
        }
        ++v4;
      }
    }
    else if ( v5 < v11 && (V_Research.techs[v8].knownToRace & v6) == 0 )
    {
      V_Research.techs[v8].knownToRace |= v6;
      if ( V_Research.current.project[index] == SWORD2(techs) )
      {
        V_Research.current.project[index] = 0xFFFF;
      }
      ++v5;
    }
    ++WORD2(techs);
    ++v8;
  }
  return techs;
}

//----- (00046470) --------------------------------------------------------
void sub_46470()
{
  Q_Research_LoadResTreeTxt_sub_46480(&V_Research, 0);
}

//----- (00046480) --------------------------------------------------------
void __fastcall __spoils<eax,edx> Q_Research_LoadResTreeTxt_sub_46480(P_Research pResearch, const char *fname)
{
  int i; // kr04_4
  int j; // kr0C_4
  const char *v5; // eax
  FILE *v6; // edx
  int n; // eax
  int v8; // eax
  int v9; // ecx
  int v10; // kr3C_4
  UBYTE v11; // al
  int ii; // edi
  int v13; // ecx
  int jj; // kr34_4
  int k; // edx
  fpos_t v16; // [esp+4h] [ebp-30h] BYREF
  fpos_t pos; // [esp+8h] [ebp-2Ch] BYREF
  unsigned int bufi1; // [esp+Ch] [ebp-28h] BYREF
  int bufi2; // [esp+10h] [ebp-24h] BYREF
  P_Research v20; // [esp+14h] [ebp-20h]
  int m; // [esp+18h] [ebp-1Ch]
  FILE *fp; // [esp+1Ch] [ebp-18h]

  pResearch->b = 0;
  pResearch->allTechForShipReported = 0;
  for ( i = 0; i != 0x64; ++i )
  {
    pResearch->techs[i].Unknown_49 = 0;
    pResearch->techs[i].knownToRace = pResearch->techs[i].Unknown_49;
  }
  if ( !V_ResTreeTxtLoaded )
  {
    for ( j = 0; j != 0x64; ++j )
    {
      pResearch->techs[j].next[0] = 0xFF;
    }
    pResearch->num = 0;
    if ( fname )
    {
      v5 = fname;
    }
    else
    {
      v5 = "restree.txt";
    }
    fp = Q_OpenFile_sub_1BB10(v5, &v16);
    if ( fp )
    {
      fscanf(fp, "%d", &bufi1);
      pResearch->num = bufi1;
      if ( pResearch->num > 100u )
      {
        pResearch->num = 100;
      }
      for ( m = 0; pResearch->num > m; ++m )
      {
        v6 = fp;
        fscanf(fp, "%s", &pResearch->techs[m]);
        fscanf(v6, "%d %d", &bufi1, &bufi2);
        pResearch->techs[m].type = bufi1;
        if ( m > 10 )
        {
          bufi2 *= 2 * m - 20;
        }
        if ( bufi2 > 65000 )
        {
          bufi2 = 65000;
        }
        pResearch->techs[m].cost = bufi2;
        for ( k = 0; k < 5; ++k )
        {
          fscanf(fp, "%d", &bufi1);
          pResearch->techs[m].preq[k] = bufi1;
          if ( bufi1 == 0xFF )
          {
            n = 0;
            goto LABEL_25;
          }
        }
        for ( n = 0; n < 60; ++n )
        {
LABEL_25:
          if ( pResearch->techs[m].name[n] == '^' )
          {
            pResearch->techs[m].name[n] = ' ';
          }
        }
      }
      v20 = pResearch;
      for ( m = 0; pResearch->num > m; ++m )
      {
        for ( ii = 0; ii < 5; ++ii )
        {
          v13 = pResearch->techs[m].preq[ii];
          if ( v13 == 0xFF )
          {
            break;
          }
          v9 = v13;
          v8 = 0;
          while ( 1 )
          {
            v10 = v8;
            if ( pResearch->techs[v9].next[v8] == 0xFF )
            {
              break;
            }
            if ( ++v8 >= 4 )
            {
              goto LABEL_31;
            }
          }
          v11 = m;
          pResearch->techs[v9].next[v10 + 1] = 0xFF;
          pResearch->techs[v9].next[v10] = v11;
LABEL_31:
          ;
        }
      }
      fgetpos(fp, &pos);
      if ( pos >= v16 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\research.cpp", 0x86);
      }
      fclose(fp);
    }
    V_ResTreeTxtLoaded = 0xFFFFFFFF;
  }
  for ( jj = 0; jj != 7; ++jj )
  {
    pResearch->current.project[jj] = -1;
    pResearch->current.progress[jj] = 0;
  }
}
// 105254: using guessed type int V_ResTreeTxtLoaded;

//----- (000466FC) --------------------------------------------------------
int __fastcall Q_Research_DoProgress_sub_466FC(P_Research pResearch)
{
  int v2; // ecx
  int j; // kr0C_4
  int raceIndex; // eax
  int v5; // ebx
  int k; // kr14_4
  int result; // eax
  int v8; // eax
  int v9; // eax
  int v10; // ebx
  char v11; // dl
  int v12; // edx
  int v13; // eax
  UWORD RPs[7]; // [esp+10h] [ebp-34h]
  int v15; // [esp+20h] [ebp-24h]
  int RP; // [esp+24h] [ebp-20h]
  int i; // [esp+28h] [ebp-1Ch]

  for ( i = 0; V_Game.racesNum > i; ++i )
  {
    RPs[i] = 0;
  }
  v2 = 0;
  for ( j = 0; ; ++j )
  {
    i = v2;
    if ( V_Game.planetsNum <= v2 )
    {
      break;
    }
    raceIndex = V_Game.planets[j].raceIndex;
    if ( raceIndex < V_Game.racesNum )
    {
      if ( (_BYTE)raceIndex != V_PlayerRaceIndex && V_Game.atmosphere == ASCEND_ATMOSPHERE_HOSTILE && V_Game.planets[j].research < 0xFu )
      {
        ++RPs[raceIndex];
      }
      RPs[V_Game.planets[j].raceIndex] += V_Game.planets[j].research;
    }
    v2 = i + 1;
  }
  v5 = 0;
  for ( k = 0; ; ++k )
  {
    i = v5;
    result = V_Game.racesNum;
    if ( V_Game.racesNum <= v5 )
    {
      break;
    }
    if ( pResearch->current.project[k] == 0xFFFF )
    {
      pResearch->current.progress[k] = 0;
    }
    else
    {
      v8 = RPs[v5];
      RP = (unsigned __int16)v8;
      if ( (_WORD)v8 )
      {
        v15 = v8 + 1;
        RP = (int)pow((double)(v8 + 1), 0.85);
      }
      v9 = pResearch->current.project[k];
      pResearch->current.progress[k] += RP;
      if ( pResearch->current.progress[k] >= pResearch->techs[v9].cost )
      {
        v10 = pResearch->current.project[k];
        v11 = 1 << i;
        pResearch->techs[(unsigned __int16)v10].knownToRace |= 1 << i;
        pResearch->techs[pResearch->current.project[k]].Unknown_49 |= v11;
        v12 = i;
        pResearch->current.project[k] = 0xFFFF;
        v13 = V_PlayerRaceIndex;
        pResearch->current.progress[k] = 0;
        if ( v13 == v12 )
        {
          Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_00_NEW_DISCOVERY, v10, 0);
          Q_Research_CheckAllTechForShip_sub_468BC(pResearch);
        }
      }
    }
    v5 = i + 1;
  }
  return result;
}

//----- (000468BC) --------------------------------------------------------
void __fastcall Q_Research_CheckAllTechForShip_sub_468BC(P_Research pResearch)
{
  if ( !pResearch->allTechForShipReported && Q_Research_HasAllTechsForShip_sub_46900(pResearch, V_PlayerRaceIndex) == TRUE )
  {
    Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_21_ALL_TECH_FOR_SHIP, 0, 0);
    pResearch->allTechForShipReported = TRUE;
  }
}

//----- (00046900) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Research_HasAllTechsForShip_sub_46900(P_Research pResearch, char raceIndex)
{
  int raceMask; // edx

  raceMask = 1 << raceIndex;
  if ( (raceMask & pResearch->techs[0].knownToRace) != 0
    && (raceMask & pResearch->techs[1].knownToRace) != 0
    && (raceMask & pResearch->techs[2].knownToRace) != 0
    && (raceMask & pResearch->techs[3].knownToRace) != 0 )
  {
    return TRUE;
  }
  else
  {
    return FALSE;
  }
}

//----- (0004694C) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_ResTree_TechIsAvailableToRace_sub_4694C(P_Research pResTree, unsigned __int16 techIndex, __int16 raceIndex)
{
  char raceIndex_; // di
  MACRO_VFX_BOOL v5; // ebp
  int i; // eax

  raceIndex_ = raceIndex;
  if ( raceIndex == 0xFFFFFFFF )
  {
    raceIndex_ = V_PlayerRaceIndex;
  }
  v5 = TRUE;
  if ( ((1 << raceIndex_) & pResTree->techs[techIndex].knownToRace) == 0 )
  {
    for ( i = 0; i < 5; ++i )
    {
      if ( pResTree->techs[techIndex].preq[i] == 0xFF )
      {
        break;
      }
      if ( ((1 << raceIndex_) & pResTree->techs[pResTree->techs[techIndex].preq[i]].knownToRace) == 0 )
      {
        v5 = FALSE;
      }
    }
  }
  return v5;
}

//----- (000469F0) --------------------------------------------------------
int __fastcall sub_469F0(P_Research pResTree, unsigned __int16 raceIndex)
{
  int tmp; // ebx
  int i; // edx
  int research; // [esp+14h] [ebp-10h]

  if ( raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\research.cpp", 0x116);
  }
  research = 0;
  for ( i = 0; i < V_Game.planetsNum; ++i )
  {
    tmp = V_Game.planets[i].raceIndex;
    if ( tmp == raceIndex )
    {
      LOWORD(tmp) = V_Game.planets[i].research;
      research += tmp;
    }
  }
  if ( research )
  {
    return (int)pow((double)(research + 1), 0.85);
  }
  return research;
}

//----- (00046A94) --------------------------------------------------------
__int16 __fastcall sub_46A94(P_Research a1, unsigned __int16 raceIndex, int a3)
{
  P_Research v4; // kr00_4
  unsigned __int16 v5; // dx
  unsigned __int16 v6; // cx
  int v7; // edi
  BYTE v8; // dl
  int i; // eax
  UWORD v11[100]; // [esp+0h] [ebp-E0h]
  int v12; // [esp+C8h] [ebp-18h]
  int v13; // [esp+CCh] [ebp-14h]

  LOWORD(v13) = raceIndex;
  v12 = a3;
  if ( raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\research.cpp", 0x12D);
  }
  v4 = a1;
  v5 = 0;
  for ( i = 0; i < a1->num; ++i )
  {
    if ( i != a1->current.project[(unsigned __int16)v13] && ((1 << v13) & v4->techs[i].knownToRace) == 0 )
    {
      v6 = v5++;
      v11[v6] = i;
    }
  }
  if ( v5 )
  {
    v7 = v11[rand() % v5];
    v8 = (1 << v13) | a1->techs[(unsigned __int16)v7].Unknown_49;
    a1->techs[(unsigned __int16)v7].knownToRace |= 1 << v13;
    a1->techs[(unsigned __int16)v7].Unknown_49 = v8;
    LOWORD(i) = v13;
    if ( (unsigned __int16)v13 == V_PlayerRaceIndex )
    {
      LOWORD(i) = Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_22_XENO_COMPLETE, v7, v12);
    }
  }
  return i;
}

//----- (00046BB0) --------------------------------------------------------
void __fastcall Q_ReadWriteResTree_sub_46BB0(P_Research a1, P_CFile a2, int read)
{
  T_Research v5; // [esp+0h] [ebp-1D80h] BYREF

  if ( read == TRUE )
  {
    Q_Research_LoadResTreeTxt_sub_46480(&v5, 0);
    Q_ReadFile_sub_1BF94(a2, &v5, sizeof(T_Research));
    qmemcpy(a1, &v5, 0x1D70u);
    HIWORD(a1->allTechForShipReported) = HIWORD(v5.allTechForShipReported);
  }
  else
  {
    Q_CFile_DosWrite_sub_1C098(a2, a1, sizeof(T_Research));
  }
}
// 46BE0: CONTAINING_RECORD: too small offset 7536 for struct 'T_Research'

//----- (00046C10) --------------------------------------------------------
void __fastcall __spoils<> Q_ResTreeCtor_sub_46C10(P_Research a1)
{
  Q_Research_LoadResTreeTxt_sub_46480(a1, 0);
}

//----- (00046C20) --------------------------------------------------------
int __fastcall Q_GetTurnsToComplete_sub_46C20(int cost, int done, int production)
{
  int result; // eax

  result = 0xFFFF;
  if ( production > 0 )
  {
    result = (cost - done - 1) / production + 1;
  }
  if ( result < 1 )
  {
    return 1;
  }
  return result;
}

//----- (00046C48) --------------------------------------------------------
void __fastcall __spoils<edx> Q_Wnd9RWDtor_sub_46C48(P_Wnd9RW a1, char a2)
{
  char *v3; // eax

  if ( (a2 & 4) != 0 )
  {
    v3 = _wcpp_2_dtor_array_store_(a1, &C_Wnd9RW);
    operator delete[](v3);
  }
  else
  {
    a1->a.pProcs = &Wnd9RW_Procs;
    Q_DestructVectors_sub_1A9E0(a1->vectors);
    Q_Ret_sub_1B66C();
    Q_A2Dtor_sub_2C848(&a1->a, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00046CAC) --------------------------------------------------------
void __fastcall sub_46CAC(P_Wnd9RW a1)
{
  int j; // kr04_4
  double v3; // st7
  int v4; // ebx
  FILE *fp; // eax
  FILE *fp_; // esi
  T_Vector3D *v7; // kr08_4
  int v8; // eax
  int v9; // esi
  int v10; // eax
  int v11; // edx
  int v12; // edx
  int n; // eax
  int v14; // edx
  int v15; // ebp
  T_Vector3D *v16; // kr28_4
  int v17; // edi
  T_Vector3D *vectors; // kr00_4
  int i; // ebx
  int k; // edi
  int m; // ebx
  int ii; // ecx
  float v23; // [esp-4h] [ebp-124h]
  char v24[100]; // [esp+0h] [ebp-120h] BYREF
  char s[100]; // [esp+64h] [ebp-BCh] BYREF
  int v26; // [esp+C8h] [ebp-58h] BYREF
  int v27; // [esp+CCh] [ebp-54h] BYREF
  int v28; // [esp+D0h] [ebp-50h] BYREF
  int v29; // [esp+D4h] [ebp-4Ch]
  int v30; // [esp+D8h] [ebp-48h]
  int v31; // [esp+DCh] [ebp-44h]
  T_Vector3D *vector; // [esp+E0h] [ebp-40h]
  int v33; // [esp+E4h] [ebp-3Ch]
  int v34; // [esp+E8h] [ebp-38h]
  int v35; // [esp+ECh] [ebp-34h]
  int v36; // [esp+F0h] [ebp-30h]
  int v37; // [esp+F4h] [ebp-2Ch]
  int v38; // [esp+F8h] [ebp-28h]
  int v39; // [esp+FCh] [ebp-24h]
  float degrees; // [esp+100h] [ebp-20h]
  int v41; // [esp+104h] [ebp-1Ch]

  a1->Unknown_9DB = 0xFFFF;
  vectors = a1->vectors;
  v35 = 0;
  j = 0;
  do
  {
    vectors[j].x = 0.0;
    v3 = (double)v35;
    vectors[j].z = 0.0;
    v4 = v35;
    vectors[j].y = v3;
    v35 = v4 + 1;
    ++j;
  }
  while ( v4 + 1 < 0x64 );
  sub_1B808(&a1->matrices, 30.0, 1.0, 100000.0, 0x140);
  a1->matrices.vector_34.x = 0.0;
  a1->matrices.vector_34.y = 0.0;
  a1->matrices.vector_34.z = -150.0;
  fp = Q_OpenFile_sub_1BB10("reswin.txt", 0);
  fp_ = fp;
  if ( fp )
  {
    fscanf(fp, "%d", &v26);
    if ( V_Research.num == v26 )
    {
      v7 = a1->vectors;
      for ( i = 0; i < V_Research.num; ++i )
      {
        fscanf(fp_, "%d %d %d", &v26, &v27, &v28);
        v29 = v27;
        v8 = v28;
        v7[i].x = (float)v26;
        v30 = v8;
        v7[i].y = (float)v29;
        v7[i].z = (float)v30;
      }
    }
    fclose(fp_);
  }
  else
  {
    if ( V_ResTreeTxtLoaded != 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\reswin.cpp", 0x76);
    }
    memset(s, 0xFF, sizeof(s));
    v9 = 0;
    do
    {
      v37 = 0xFFFFFFFF;
      v41 = 0;
      for ( k = 0; k < V_Research.num; ++k )
      {
        if ( (unsigned __int8)s[k] == 0xFF )
        {
          v10 = 0;
          for ( m = 0; m < 5; ++m )
          {
            v11 = V_Research.techs[k].preq[m];
            if ( v11 == 0xFF )
            {
              break;
            }
            v12 = (unsigned __int8)s[v11];
            if ( v12 == 0xFF )
            {
              v37 = 0;
              LOBYTE(v10) = 0xFF;
              break;
            }
            if ( v12 >= v10 )
            {
              v10 = v12 + 1;
              if ( v12 + 1 >= v9 )
              {
                v9 = v12 + 2;
              }
            }
          }
          s[k] = v10;
        }
      }
    }
    while ( !v37 );
    memset(v24, 0, sizeof(v24));
    for ( n = 0; n < V_Research.num; ++n )
    {
      v14 = (unsigned __int8)s[n];
      ++v24[v14];
    }
    if ( v9 > 0 )
    {
      v38 = 0;
      v34 = 0;
      vector = a1->vectors;
      v33 = 0xF0;
      do
      {
        v39 = 4;
        degrees = (float)(0x1E * v38 + 0xF0);
        v15 = (unsigned __int8)v24[v38];
        if ( v38 % 2 && (unsigned __int8)v24[v38] > 2u )
        {
          --v15;
        }
        else if ( (unsigned __int8)v24[v38] > 1u )
        {
          v39 = 0x17;
        }
        v16 = vector;
        v17 = 0;
        v36 = 0x1E * v38;
        for ( ii = 0; ii < V_Research.num; ++ii )
        {
          if ( (unsigned __int8)s[ii] == v38 )
          {
            v31 = 0xF * (v17 & 1) + v36;
            v16[ii].y = (float)v31;
            v16[ii].z = (float)v39;
            v23 = degrees;
            v16[ii].x = 0.0;
            Q_RotateVectorY_sub_532AC(&v16[ii], v23);
            v31 = 0x168 / v15;
            ++v17;
            v39 = 0x17;
            degrees = (double)(0x168 / v15) + degrees;
          }
        }
        ++v38;
      }
      while ( v9 > v38 );
    }
  }
}
// 105254: using guessed type int V_ResTreeTxtLoaded;
// 46CAC: using guessed type char s[100];
// 46CAC: using guessed type char var_120[100];

//----- (00047088) --------------------------------------------------------
int __fastcall sub_47088(P_Wnd9RW a1)
{
  int v2; // ebp
  int v3; // ecx
  char *v4; // edi
  int techIndex; // esi
  char *v6; // eax
  int v7; // edx
  int v8; // eax
  int result; // eax
  int v11; // [esp+4h] [ebp-20h]
  int v12; // [esp+8h] [ebp-1Ch]

  v12 = 0xFFFF;
  v2 = V_Mouse.x - a1->a.a1.pane.x0;
  v3 = V_Research.num - 1;
  v11 = V_Mouse.y - a1->a.a1.pane.y0;
  if ( v3 >= 0 )
  {
    v4 = (char *)a1 + 2 * v3;
    while ( 1 )
    {
      techIndex = *(unsigned __int16 *)(v4 + 0x913);
      if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, techIndex, 0xFFFFFFFF) )
      {
        v6 = (char *)a1 + 2 * techIndex;
        v7 = *(__int16 *)(v6 + 0x5F3);
        if ( v2 > v7 - 0x19 && v2 < v7 + 0x19 )
        {
          v8 = *(__int16 *)(v6 + 0x6BB);
          if ( v8 - 0x19 < v11 && v8 + 0x19 > v11 )
          {
            break;
          }
        }
      }
      --v3;
      v4 += 0xFFFFFFFE;
      if ( v3 < 0 )
      {
        goto LABEL_12;
      }
    }
    v12 = techIndex;
  }
LABEL_12:
  result = v12;
  if ( (_WORD)v12 != a1->Unknown_9DB )
  {
    a1->Unknown_9DB = v12;
    dword_106FD0 = 0xFFFFFFFF;
    dword_106FD4 = 0xFFFFFFFF;
  }
  return result;
}
// 106FD0: using guessed type int dword_106FD0;
// 106FD4: using guessed type int dword_106FD4;

//----- (00047224) --------------------------------------------------------
unsigned int __fastcall sub_47224(P_Wnd9RW a1, UWORD message, int param1, ULONG param2)
{
  char v7; // cl
  char v8; // cl
  int v9; // eax
  UBYTE v10; // cl
  int v11; // eax
  char v12; // cl
  P_Procs v13; // ebx
  P_Procs pProcs; // ebx
  int v15; // eax
  double v16; // st7
  int index; // edx
  int v18; // edx
  __int16 Unknown_9DB; // ax
  int i; // edx
  int j; // edx
  int k; // edx
  float v24; // [esp+10h] [ebp-14h]
  float v25; // [esp+10h] [ebp-14h]
  float v26; // [esp+14h] [ebp-10h]
  int v27; // [esp+14h] [ebp-10h]

  if ( message < 6u )
  {
    if ( message < 2u )
    {
      if ( message != 1 )
      {
        return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
      }
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1E]);
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE]);
      Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);
      dword_106FD8 = 0;
      dword_106FCC = 0xFFFFFFFF;
      dword_106FD0 = 0xFFFFFFFF;
      a1->Unknown_9DB = 0xFFFF;
      Q_WndA2_Proc3_sub_2F424(&a1->a, 1u, param1, param2);
      sub_56400(&WinMgr, a1->a.a1.index, 0x3A, 0, 0, 0);
      return 0;
    }
    if ( message <= 2u )
    {
      v7 = 1 << V_PlayerRaceIndex;
      for ( i = 0; i < V_Research.num; ++i )
      {
        V_Research.techs[i].Unknown_49 &= ~v7;
      }
      Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
      sub_564C0(&WinMgr, a1->a.a1.index, 0xFFFFFFFF);
      return 0;
    }
    if ( message > 3u )
    {
      if ( !a1->a.a1.Unknown_35 )
      {
        return 0;
      }
      sub_47088(a1);
      LOWORD(v18) = a1->Unknown_9DB;
      if ( (unsigned __int16)v18 == 0xFFFF )
      {
        return 0;
      }
      HIWORD(v18) = 0;
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[v18].knownToRace) != 0
        || Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, v18, 0xFFFFFFFF) == FALSE )
      {
        return 0;
      }
      Q_StartSample_sub_4FB90(&V_SoundSystem, 0);
      dword_106FD4 = 0xFFFFFFFF;
      Unknown_9DB = a1->Unknown_9DB;
      dword_106FD0 = 0xFFFFFFFF;
      V_Research.current.project[V_PlayerRaceIndex] = Unknown_9DB;
      return 0;
    }
    if ( param2 < 0x2E )
    {
      if ( param2 < 0xD )
      {
        if ( param2 == 0xC && WinMgr.j > 0.1 )
        {
          WinMgr.j = WinMgr.j * 0.8;
          sub_47088(a1);
          return 0;
        }
        goto LABEL_60;
      }
      if ( param2 <= 0xD )
      {
        if ( WinMgr.j < 10.0 )
        {
          WinMgr.j = WinMgr.j * 1.25;
          sub_47088(a1);
          return 0;
        }
        goto LABEL_60;
      }
      if ( param2 >= 0x20 )
      {
        if ( param2 <= 0x20 )
        {
          if ( V_NougatLfExists_dword_A0CFC == FALSE )
          {
            goto LABEL_60;
          }
          v8 = 1 << V_PlayerRaceIndex;
          for ( j = 0; j < V_Research.num; ++j )
          {
            *((_BYTE *)&V_ResTreeTxtLoaded + 0x4B * j + 0x4E) = v8 | V_Research.techs[j].knownToRace;
          }
        }
        else
        {
          if ( param2 != 0x21 || V_NougatLfExists_dword_A0CFC == FALSE )
          {
            goto LABEL_60;
          }
          v12 = 1 << V_PlayerRaceIndex;
          for ( k = 0; k < V_Research.num; ++k )
          {
            *((_BYTE *)&V_ResTreeTxtLoaded + 0x4B * k + 0x4E) = ~v12 & V_Research.techs[k].knownToRace;
          }
        }
        v9 = V_PlayerRaceIndex;
        V_Research.current.project[V_PlayerRaceIndex] = 0xFFFF;
        word_106FB4[v9] = 0;
        sub_47088(a1);
        return 0;
      }
    }
    else
    {
      if ( param2 > 0x2E )
      {
        if ( param2 < 0x49 )
        {
          if ( param2 < 0x32 )
          {
            goto LABEL_60;
          }
          if ( param2 <= 0x32 )
          {
            dword_106FC2 = ~dword_106FC2;
            Q_Proc_sub_5A320(0x14);
            dword_106FCC = 0xFFFFFFFF;
            dword_106FD4 = 0xFFFFFFFF;
            sub_47088(a1);
            return 0;
          }
          if ( param2 != 0x47 )
          {
            goto LABEL_60;
          }
        }
        else if ( param2 > 0x49 )
        {
          if ( param2 >= 0x4F && (param2 <= 0x4F || param2 == 0x51) )
          {
            pProcs = a1->a.pProcs;
            a1->matrices.vector_34.y = 1000000.0;
            pProcs->proc4_draw(&a1->a.a1, 0);
            sub_47088(a1);
            return 0;
          }
          goto LABEL_60;
        }
        v13 = a1->a.pProcs;
        a1->matrices.vector_34.y = -100.0;
        v13->proc4_draw(&a1->a.a1, 0);
        sub_47088(a1);
        return 0;
      }
      if ( V_NougatLfExists_dword_A0CFC && V_Research.current.project[V_PlayerRaceIndex] != 0xFFFF )
      {
        v10 = V_PlayerRaceIndex;
        v11 = V_Research.current.project[V_PlayerRaceIndex];
        V_Research.techs[v11].knownToRace |= 1 << V_PlayerRaceIndex;
        V_Research.current.project[v10] = 0xFFFF;
        word_106FB4[v10] = 0;
        sub_47088(a1);
        return 0;
      }
    }
LABEL_60:
    sub_47088(a1);
    return 0;
  }
  if ( message <= 6u )
  {
    sub_567BC(&WinMgr, a1->a.a1.index, 8);
    sub_47088(a1);
    if ( (a1->a.a1._mouseFocus & a1->a.a1.Unknown_35 & a1->a.a1.Unknown_39) == 0xFFFFFFFF )
    {
      ((void (*)(void))a1->a.pProcs->proc4_draw)();
    }
    return 0xFFFFFFFF;
  }
  if ( message < 0x32u )
  {
    if ( message <= 7u )
    {
      sub_56728(&WinMgr, a1->a.a1.index, 4, 8, 0, 0);
      sub_47088(a1);
      if ( (a1->a.a1._mouseFocus & a1->a.a1.Unknown_35 & a1->a.a1.Unknown_39) == 0xFFFFFFFF )
      {
        ((void (*)(void))a1->a.pProcs->proc5)();
      }
      return 0xFFFFFFFF;
    }
    if ( message != 8 )
    {
      return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
    }
    goto LABEL_60;
  }
  if ( message <= 0x35u )
  {
    if ( message == 0x32 )
    {
      if ( (dword_106FD8 & 4) != 0 )
      {
        if ( (dword_106FD8 & 8) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xF7;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFB;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 & 0xF3 | 4;
      }
    }
    if ( message == 0x33 )
    {
      if ( (dword_106FD8 & 4) != 0 )
      {
        if ( (dword_106FD8 & 8) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFB;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 | 8;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 | 0xC;
      }
    }
    if ( message == 0x34 )
    {
      if ( (dword_106FD8 & 1) != 0 )
      {
        if ( (dword_106FD8 & 2) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFD;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFE;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 & 0xFC | 1;
      }
    }
    if ( message == 0x35 )
    {
      if ( (dword_106FD8 & 1) != 0 )
      {
        if ( (dword_106FD8 & 2) != 0 )
        {
          LOBYTE(dword_106FD8) = dword_106FD8 & 0xFE;
        }
        else
        {
          LOBYTE(dword_106FD8) = dword_106FD8 | 2;
        }
      }
      else
      {
        LOBYTE(dword_106FD8) = dword_106FD8 | 3;
      }
    }
    if ( param1 != 4 )
    {
      return 0;
    }
    v15 = 4;
    if ( message == 0x34 || message == 0x35 )
    {
      v15 = 1;
    }
    sub_56728(&WinMgr, a1->a.a1.index, 1, 0x38, v15, 0);
    return 0;
  }
  else
  {
    if ( message < 0x38u )
    {
      return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
    }
    if ( message > 0x38u )
    {
      if ( message != 0x3A )
      {
        return Q_WndA2_Proc3_sub_2F424(&a1->a, message, param1, param2);
      }
      if ( (dword_106FD8 & 4) != 0 )
      {
        v26 = 3.0;
        if ( (dword_106FD8 & 8) != 0 )
        {
          v26 = -3.0;
        }
        *(float *)&v27 = v26 * WinMgr.j;
        sub_53564((float *)&a1->matrices.matrix_74, message, param1, 0xFFFFFFFF, v27);
        dword_106FD4 = 0xFFFFFFFF;
      }
      if ( (dword_106FD8 & 1) != 0 )
      {
        v24 = -2.0;
        if ( (dword_106FD8 & 2) != 0 )
        {
          v24 = 2.0;
        }
        v25 = v24 * WinMgr.j;
        v16 = a1->matrices.vector_34.y + v25;
        dword_106FD4 = 0xFFFFFFFF;
        a1->matrices.vector_34.y = v16;
      }
      if ( dword_106FD4 == 0xFFFFFFFF )
      {
        a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
        return 0;
      }
      return 0;
    }
    index = a1->a.a1.index;
    dword_106FD8 &= ~param1;
    sub_567BC(&WinMgr, index, 0xFFFFFFFF);
    return 0;
  }
}
// 105254: using guessed type int V_ResTreeTxtLoaded;
// 106FB4: using guessed type __int16 word_106FB4[7];
// 106FC2: using guessed type int dword_106FC2;
// 106FCC: using guessed type int dword_106FCC;
// 106FD0: using guessed type int dword_106FD0;
// 106FD4: using guessed type int dword_106FD4;
// 106FD8: using guessed type int dword_106FD8;

//----- (00047A64) --------------------------------------------------------
int __fastcall compar(WORD *a1, WORD *a2)
{
  unsigned __int16 v2; // si
  BOOL v3; // edx

  v2 = *a2;
  v3 = *(float *)&dword_106FDC[2 * (unsigned __int16)*a2] > (double)*(float *)&dword_106FDC[2 * (unsigned __int16)*a1];
  if ( *(float *)&dword_106FDC[2 * v2] < (double)*(float *)&dword_106FDC[2 * (unsigned __int16)*a1] )
  {
    return 0xFFFFFFFF;
  }
  return v3;
}

//----- (00047ABC) --------------------------------------------------------
void __fastcall sub_47ABC(P_Wnd9RW pWnd9RW)
{
  PANE *p_pane; // esi
  int v3; // eax
  int v4; // ebx
  P_Wnd9RW v5; // edx
  char v6; // bl
  unsigned __int16 v7; // dx
  int v8; // edx
  int v9; // eax
  int v10; // esi
  int v11; // edi
  int v12; // ecx
  __int16 v13; // ax
  void *ShapeTable_sub_1B084; // eax
  LONG v15; // esi
  UWORD ItemIndex_sub_1B270; // dx
  void *v17; // eax
  char *sub_1CEA8; // eax
  int v19; // esi
  void *v20; // eax
  void *v21; // eax
  LONG v22; // ebx
  UWORD v23; // di
  void *v24; // eax
  int v25; // edi
  int v26; // esi
  int v27; // eax
  int knownToRace; // edx
  int v29; // ebx
  int TurnsToComplete_sub_46C20; // eax
  int v31; // edx
  char *v32; // kr00_4
  int v33; // eax
  char *v34; // eax
  int v35; // esi
  char *v36; // eax
  char *name; // eax
  int v38; // esi
  UWORD v39; // dx
  unsigned __int16 v40; // ax
  LONG v41; // ebp
  void *v42; // eax
  void *v43; // eax
  char *v44; // eax
  int v45; // esi
  int v46; // ebp
  void *v47; // esi
  char *v48; // eax
  unsigned __int16 v49; // di
  __int16 v50; // dx
  char *v51; // eax
  const char *v52; // eax
  UWORD v53; // dx
  void *v54; // eax
  void *v55; // eax
  int v56; // esi
  char *v57; // eax
  char *v58; // eax
  int v59; // kr14_4
  LONG v60; // [esp-20h] [ebp-170h]
  LONG v61; // [esp-1Ch] [ebp-16Ch]
  LONG v62; // [esp-1Ch] [ebp-16Ch]
  LONG v63; // [esp-1Ch] [ebp-16Ch]
  LONG v64; // [esp-18h] [ebp-168h]
  LONG v65; // [esp-18h] [ebp-168h]
  LONG v66; // [esp-18h] [ebp-168h]
  LONG v67; // [esp-Ch] [ebp-15Ch]
  WORD v68; // [esp-Ch] [ebp-15Ch]
  WORD v69; // [esp-Ch] [ebp-15Ch]
  LONG v70; // [esp-Ch] [ebp-15Ch]
  WORD v71; // [esp-Ch] [ebp-15Ch]
  WORD v72; // [esp-Ch] [ebp-15Ch]
  WORD v73; // [esp-Ch] [ebp-15Ch]
  LONG v74; // [esp-8h] [ebp-158h]
  LONG v75; // [esp-8h] [ebp-158h]
  LONG v76; // [esp-8h] [ebp-158h]
  LONG v77; // [esp-8h] [ebp-158h]
  LONG v78; // [esp-8h] [ebp-158h]
  char *v79; // [esp-8h] [ebp-158h]
  UBYTE *v80; // [esp-4h] [ebp-154h]
  LONG v81; // [esp-4h] [ebp-154h]
  LONG v82; // [esp-4h] [ebp-154h]
  LONG v83; // [esp-4h] [ebp-154h]
  char *v84; // [esp-4h] [ebp-154h]
  char *v85; // [esp-4h] [ebp-154h]
  char v86[100]; // [esp+0h] [ebp-150h]
  char s[80]; // [esp+64h] [ebp-ECh] BYREF
  PANE pPane; // [esp+B4h] [ebp-9Ch] BYREF
  PANE v89; // [esp+C8h] [ebp-88h] BYREF
  T_Vector3D vector1; // [esp+DCh] [ebp-74h] BYREF
  LONG hotX; // [esp+E8h] [ebp-68h] BYREF
  LONG hotY; // [esp+ECh] [ebp-64h] BYREF
  float y_; // [esp+F0h] [ebp-60h]
  int v94; // [esp+F4h] [ebp-5Ch]
  int techIndex; // [esp+F8h] [ebp-58h]
  int v96; // [esp+FCh] [ebp-54h]
  int v97; // [esp+100h] [ebp-50h]
  T_Matrix3x4 *pTRS; // [esp+104h] [ebp-4Ch]
  float y; // [esp+108h] [ebp-48h]
  LONG x_scale; // [esp+10Ch] [ebp-44h]
  P_Wnd9RW v101; // [esp+110h] [ebp-40h]
  P_Wnd9RW v102; // [esp+114h] [ebp-3Ch]
  T_Wnd09RW *v103; // [esp+118h] [ebp-38h]
  int v104; // [esp+11Ch] [ebp-34h]
  int v105; // [esp+120h] [ebp-30h]
  int v106; // [esp+124h] [ebp-2Ch]
  LONG v107; // [esp+128h] [ebp-28h]
  int v108; // [esp+12Ch] [ebp-24h]
  PANE *pane; // [esp+130h] [ebp-20h]
  int v110; // [esp+134h] [ebp-1Ch]
  LONG shape_number; // [esp+138h] [ebp-18h]

  pPane = pWnd9RW->a.a1.pane;
  p_pane = &pWnd9RW->a.a1.pane;
  VFX_pane_wipe(&pWnd9RW->a.a1.pane, 0);
  Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, p_pane);
  y = pWnd9RW->vectors[0].y;
  y_ = y;
  for ( techIndex = 0; V_Research.num > techIndex; ++techIndex )
  {
    if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, techIndex, -1u) )
    {
      if ( pWnd9RW->vectors[techIndex].y < (double)y_ )
      {
        y_ = pWnd9RW->vectors[techIndex].y;
      }
      if ( pWnd9RW->vectors[techIndex].y > (double)y )
      {
        y = pWnd9RW->vectors[techIndex].y;
      }
    }
  }
  if ( pWnd9RW->matrices.vector_34.y >= (double)y_ )
  {
    if ( pWnd9RW->matrices.vector_34.y <= (double)y )
    {
      goto LABEL_14;
    }
    v3 = LODWORD(y);
  }
  else
  {
    v3 = LODWORD(y_);
  }
  LODWORD(pWnd9RW->matrices.vector_34.y) = v3;
LABEL_14:
  sub_1B864(&pWnd9RW->matrices);
  techIndex = 0;
  pTRS = &pWnd9RW->matrices.trs;
  v103 = pWnd9RW;
  v101 = pWnd9RW;
  v59 = 0;
  while ( V_Research.num > techIndex )
  {
    memset(&vector1, 0, sizeof(vector1));
    Q_M34xV_sub_53384(&pWnd9RW->vectors[v59], pTRS, &vector1);
    v4 = techIndex;
    *(float *)&pWnd9RW->Unknown_783[2 * v59] = vector1.z;
    v5 = v103;
    Q_Project3DTo2D_sub_533D4(&vector1, pWnd9RW->matrices._scaleFactor, 235, 240, &pWnd9RW->Unknown_5F3[v59], &pWnd9RW->Unknown_6BB[v59]);
    v5->Unknown_913[0] = techIndex;
    techIndex = v4 + 1;
    v103 = (T_Wnd09RW *)((char *)&v5->a.a1.magic12345678 + 2);
    ++v59;
  }
  dword_106FDC = pWnd9RW->Unknown_783;
  qsort(pWnd9RW->Unknown_913, V_Research.num, 2u, (int (__fastcall *)(const void *, const void *))compar);
  techIndex = 0;
  while ( V_Research.num > techIndex )
  {
    v6 = techIndex;
    v7 = pWnd9RW->Unknown_913[techIndex++];
    v86[v7] = v6;
  }
  v110 = V_Research.current.project[V_PlayerRaceIndex];
  pane = &pWnd9RW->a.a1.pane;
  v102 = pWnd9RW;
  for ( techIndex = 0; V_Research.num > techIndex; ++techIndex )
  {
    v107 = (unsigned __int16)pWnd9RW->Unknown_913[techIndex];
    if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, v107, 0xFFFFFFFF) )
    {
      v104 = (int)((*(float *)&pWnd9RW->Unknown_783[2 * v107] + pWnd9RW->matrices.vector_34.z) * 0.25);
      if ( v104 >= (int)0xFFFFFFFD )
      {
        if ( v104 > 3 )
        {
          v104 = 3;
        }
      }
      else
      {
        v104 = 0xFFFFFFFD;
      }
      v80 = (*V_Type6_stru_D8654.hazeTables)[v104 + 4];
      v104 += 3;
      VFX_shape_lookaside(v80);
      v105 = 0;
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[v107].knownToRace) != 0 )
      {
        v105 = 0x14;
      }
      else if ( (unsigned __int16)v110 == v107 )
      {
        v8 = v107 ^ (unsigned __int16)v110;
        LOBYTE(v8) = V_PlayerRaceIndex;
        v9 = 0x12 * (unsigned __int16)word_106FB4[v8] / V_Research.techs[v107].cost + 2;
        v105 = v9;
        if ( v9 >= (int)0xFFFFFFEF )
        {
          if ( v9 > 0x11 )
          {
            v105 = 0x11;
          }
        }
        else
        {
          v105 = 0xFFFFFFEF;
        }
      }
      v10 = 0x4B * v107;
      v106 = (int)pWnd9RW + 2 * v107;
      v11 = 0;
      v108 = (int)pWnd9RW + 4 * v107;
      while ( 1 )
      {
        v12 = V_Research.techs[0].preq[v10];
        if ( v12 == 0xFF )
        {
          break;
        }
        if ( Q_ResTree_TechIsAvailableToRace_sub_4694C(&V_Research, V_Research.techs[0].preq[v10], 0xFFFFFFFF) )
        {
          v96 = (int)(((*(float *)(v108 + 0x783) + *(float *)&pWnd9RW->Unknown_783[2 * v12]) * 0.5 + pWnd9RW->matrices.vector_34.z) * 0.25);
          if ( v96 <= 3 )
          {
            if ( v96 < (int)0xFFFFFFFD )
            {
              v96 = 0xFFFFFFFD;
            }
          }
          else
          {
            v96 = 3;
          }
          v13 = 0x6B - v96;
          if ( v12 == (unsigned __int16)pWnd9RW->Unknown_9DB )
          {
            v13 = 0xF3;
          }
          VFX_line_draw(
            pane,
            *(__int16 *)(v106 + 0x5F3),
            *(__int16 *)(v106 + 0x6BB) - 0x1B,
            pWnd9RW->Unknown_5F3[v12],
            pWnd9RW->Unknown_6BB[v12] + 0x1B,
            0,
            v13);
          ++v11;
          ++v10;
          if ( v11 >= 5 )
          {
            break;
          }
        }
        else
        {
          ++v11;
          ++v10;
          if ( v11 >= 5 )
          {
            break;
          }
        }
      }
      if ( v105 )
      {
        v105 = (v105 << 0x10) / 0x14;
        v74 = v105;
        v67 = v105;
        v64 = pWnd9RW->Unknown_6BB[v107];
        v61 = pWnd9RW->Unknown_5F3[v107];
        v60 = v107;
        ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);
        VFX_shape_transform(pane, ShapeTable_sub_1B084, v60, v61, v64, V_BigBuffer, 0, v67, v74, 1);
      }
      v15 = 1;
      if ( (unsigned __int16)v110 == v107 && ((1 << V_PlayerRaceIndex) & V_Research.techs[v107].knownToRace) == 0 )
      {
        v15 = 0;
      }
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[v107].Unknown_49) != 0 )
      {
        v15 = 3;
      }
      if ( (unsigned __int16)pWnd9RW->Unknown_9DB == v107 )
      {
        v15 = 2;
      }
      ItemIndex_sub_1B270 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "data\\resring.shp", 0xFFFFFFFF);
      v81 = pWnd9RW->Unknown_6BB[v107];
      v75 = pWnd9RW->Unknown_5F3[v107];
      v17 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, ItemIndex_sub_1B270);
      if ( v15 == 2 )
      {
        VFX_shape_draw(pane, v17, 2, v75, v81);
      }
      else
      {
        VFX_shape_translate_draw(pane, v17, v15, v75, v81);
      }
    }
  }
  WinMgr.LargeFont.pane = pWnd9RW->a.a1.pane;
  if ( dword_106FD0 == 0xFFFFFFFF )
  {
    pPane.y1 = 0x1AA;
    pPane.x0 = 0x1E5;
    pPane.y0 = 7;
    pPane.x1 = 0x278;
    VFX_pane_wipe(&pPane, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
    shape_number = 0xFFFF;
    if ( (unsigned __int16)v110 != 0xFFFF )
    {
      shape_number = (unsigned __int16)v110;
    }
    if ( (unsigned __int16)pWnd9RW->Unknown_9DB != 0xFFFF )
    {
      shape_number = (unsigned __int16)pWnd9RW->Unknown_9DB;
    }
    if ( (unsigned __int16)shape_number != 0xFFFF )
    {
      WinMgr.LargeFont.pane = pPane;
      v94 = 0xFFFFFFFF;
      v89 = pPane;
      if ( (_WORD)shape_number == (_WORD)v110 )
      {
        if ( (_WORD)shape_number != pWnd9RW->Unknown_9DB )
        {
          v94 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
        }
        v68 = v94;
        sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7A);// 122: "Current Project:"
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0xA, sub_1CEA8, 2, v68, 0xFFFF, 0x82);
      }
      v19 = (unsigned __int16)shape_number;
      v97 = 0x46;
      v89.y1 = 0x78;
      v20 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);
      Q_GSYSTEM_CPP_sub_2BC40(&v89, v20, (unsigned __int16)v19, &hotX, &hotY);
      v82 = hotY;
      v76 = hotX;
      v21 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1F]);
      VFX_shape_draw(&v89, v21, (unsigned __int16)v19, v76, v82);
      v22 = 1;
      v23 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "data\\resring.shp", 0xFFFFFFFF);
      if ( (_WORD)v19 == (_WORD)v110 && ((1 << V_PlayerRaceIndex) & V_Research.techs[v19].knownToRace) == 0 )
      {
        v22 = 0;
      }
      if ( ((1 << V_PlayerRaceIndex) & V_Research.techs[(unsigned __int16)shape_number].Unknown_49) != 0 )
      {
        v22 = 3;
      }
      if ( (_WORD)shape_number == pWnd9RW->Unknown_9DB )
      {
        v22 = 2;
      }
      v83 = hotY;
      v77 = hotX;
      v24 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v23);
      VFX_shape_draw(&v89, v24, v22, v77, v83);
      v26 = (unsigned __int16)shape_number;
      v97 += 0x19;
      v25 = v97;
      v27 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v97, V_Research.techs[v26].name, 2, v94, 0xFFFF, 0x82);
      knownToRace = V_Research.techs[v26].knownToRace;
      v97 = v25 + v27;
      if ( ((1 << V_PlayerRaceIndex) & knownToRace) == 0 )
      {
        v29 = sub_469F0(&V_Research, V_PlayerRaceIndex);
        TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(
                                      V_Research.techs[v26].cost,
                                      (unsigned __int16)word_106FB4[V_PlayerRaceIndex],
                                      v29);
        v31 = TurnsToComplete_sub_46C20;
        if ( TurnsToComplete_sub_46C20 == 0xFFFF )
        {
          v32 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7B);
          strcpy(s, v32);
        }
        else
        {
          if ( TurnsToComplete_sub_46C20 == 1 )
          {
            v33 = 0x1C;                                // 28: ""
          }
          else
          {
            v33 = 0x1D;                                // 29: "s"
          }
          v84 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v33);
          v34 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7C);// 124: "(%d day%s)"
          sprintf(s, v34, v31, v84);
        }
        Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v97, s, 2, v94, 0xFFFF, 0x82);
      }
      v35 = 0x8E;
      for ( techIndex = 0; techIndex < 0x27; ++techIndex )
      {
        if ( V_PlanetItems.item[techIndex].resReq == (unsigned __int16)shape_number )
        {
          if ( v35 == 0x8E )
          {
            v69 = v94;
            v36 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7D);// 125: "Allows"
            v35 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x8E, v36, 2, v69, 0xFFFF, 0x82) + 0x98;
          }
          name = V_PlanetItems.item[techIndex].name;
          if ( (_BYTE)techIndex == 0x17 )
          {
            name = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7E);// 126: "Ships: Small and Medium Hulls"
          }
          v38 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, name, 2, v94, 0xFFFF, 0x82) + v35;
          x_scale = (LONG)sub_10000;
          v89.y0 = v38 + 1;
          v39 = GwshareShpCacheIndexes[0x1E];
          v89.y1 = v38 + 0x48;
          v40 = techIndex;
          if ( (_BYTE)techIndex == 0x17 )
          {
            x_scale = 0x8000;
            v39 = GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE];
            v40 = 0;
          }
          v41 = v40;
          v42 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v39);
          Q_GSYSTEM_CPP_sub_2BC40(&v89, v42, v41, &hotX, &hotY);
          v78 = x_scale;
          v70 = x_scale;
          v65 = hotY;
          v62 = hotX;
          v43 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v39);
          v35 = v38 + 0x48;
          VFX_shape_transform(&v89, v43, v41, v62, v65, V_BigBuffer, 0, v70, v78, 0);
        }
      }
      for ( techIndex = 0; techIndex < 0x4C; ++techIndex )
      {
        if ( V_Gizmos[techIndex].resReq == (unsigned __int16)shape_number )
        {
          if ( v35 == 0x8E )
          {
            v71 = v94;
            v44 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7D);// 125: "Allows"
            v35 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x8E, v44, 2, v71, 0xFFFF, 0x82) + 0x98;
          }
          v45 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, V_Gizmos[techIndex].name, 2, v94, 0xFFFF, 0x82) + v35;
          v89.y0 = v45 + 1;
          v46 = v45 + 0x48;
          v89.y1 = v45 + 0x48;
          v47 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);
          Q_GSYSTEM_CPP_sub_2BC40(&v89, v47, techIndex, &hotX, &hotY);
          VFX_shape_draw(&v89, v47, techIndex, hotX, hotY);
          v35 = v46;
        }
      }
      if ( (unsigned __int16)shape_number == 0x13 || (unsigned __int16)shape_number == 0x1F )
      {
        if ( v35 == 0x8E )
        {
          v72 = v94;
          v48 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7D);// 125: "Allows"
          v35 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0x8E, v48, 2, v72, 0xFFFF, 0x82) + 0x98;
        }
        v49 = 2;
        v50 = shape_number;
        v51 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x7F);// 127: "Large Ship Hull"
        if ( v50 == 0x1F )
        {
          v49 = 3;
          v51 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x80);// 128: "Gigantic Ship Hull"
        }
        v89.y0 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, v51, 2, v94, 0xFFFF, 0x82) + v35 + 1;
        v53 = GwshareShpCacheIndexes[V_PlayerRaceIndex + 0xE];
        v89.y1 = Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v35, v52, 2, v94, 0xFFFF, 0x82) + v35 + 0x48;
        v54 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v53);
        Q_GSYSTEM_CPP_sub_2BC40(&v89, v54, v49, &hotX, &hotY);
        v66 = hotY;
        v63 = hotX;
        v55 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v53);
        VFX_shape_transform(&v89, v55, v49, v63, v66, V_BigBuffer, 0, 0x8000, 0x8000, 0);
      }
    }
    dword_106FD0 = 0;
  }
  v56 = dword_106FCC;
  if ( dword_106FCC == 0xFFFFFFFF )
  {
    pPane.x0 = 7;
    pPane.x1 = 0x1DC;
    pPane.y1 = 0x25;
    pPane.y0 = 7;
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pPane);
    Q_WINMGR_CPP_sub_53E38(&pPane, 3, 3, V_PlayerRaceIndex);
    v57 = (char *)&unk_92696;
    if ( dword_106FC2 == v56 )
    {
      v57 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x81);  // 129: "(Self Managed)"
    }
    v85 = v57;
    v79 = V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex];
    v58 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x82);    // 130: "%s Knowledge %s"
    sprintf(s, v58, v79, v85);
    v73 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
    WinMgr.LargeFont.pane = pPane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, s, 3, v73, 0xFF, 0);
    dword_106FCC = 0;
  }
  dword_106FD4 = 0;
}
/* Orphan comments:
123: "(No Progress)"
*/
// 10000: using guessed type void __noreturn sub_10000();
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 106FB4: using guessed type __int16 word_106FB4[7];
// 106FC2: using guessed type int dword_106FC2;
// 106FCC: using guessed type int dword_106FCC;
// 106FD0: using guessed type int dword_106FD0;
// 106FD4: using guessed type int dword_106FD4;
// 47ABC: using guessed type char var_150[100];
// 47ABC: using guessed type char s[80];

//----- (00048B14) --------------------------------------------------------
int __fastcall sub_48B14(int a1, unsigned int count, int a3)
{
  void *v5; // edx

  v5 = (void *)(a1 + 0xAB);
  if ( a3 == 0xFFFFFFFF )
  {
    return Q_ReadFile_sub_1BF94((P_CFile)count, v5, 0x98u);
  }
  else
  {
    return Q_CFile_DosWrite_sub_1C098((P_CFile)count, v5, 0x98u);
  }
}

//----- (00048B40) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd9RWCtor_sub_48B40(P_Wnd9RW a1)
{
  Q_A2Ctor_sub_2C830(&a1->a);
  sub_1B4F0(&a1->matrices);
  _wcpp_2_ctor_array_(a1->vectors, 100u, &C_Vector3D);
  a1->a.pProcs = &Wnd9RW_Procs;
  sub_46CAC(a1);
}

//----- (00048B90) --------------------------------------------------------
void __fastcall __spoils<> Q_ShipCtor_sub_48B90(P_Ship pShip)
{
  pShip->Unknown_6C.x = 0.0;
  pShip->Unknown_6C.y = 0.0;
  pShip->Unknown_6C.z = 0.0;
  pShip->Unknown_78.x = 0.0;
  pShip->Unknown_78.y = 0.0;
  pShip->Unknown_78.z = 0.0;
  pShip->position.x = 0.0;
  pShip->position.y = 0.0;
  pShip->position.z = 0.0;
  sub_48C5C(pShip, 0);
}

//----- (00048C5C) --------------------------------------------------------
void __fastcall sub_48C5C(P_Ship pShip, char hullSize)
{
  sub_48EAC(pShip);
  Q_Ship_SetSize_sub_49148(pShip, hullSize);
}

//----- (00048C84) --------------------------------------------------------
void __fastcall Q_Ship_LoadGizmosTxt_sub_48C84(P_Ship pShip)
{
  FILE *fp; // esi
  MACRO_VFX_BOOL found; // ecx
  T_Gizmo *v3; // kr04_4
  int v4; // ebx
  int v5; // kr10_4
  int zero; // eax
  int i; // ebp
  char buf[200]; // [esp+0h] [ebp-104h] BYREF
  BYTE val1; // [esp+C8h] [ebp-3Ch] BYREF
  int val2; // [esp+CCh] [ebp-38h] BYREF
  int val3; // [esp+D0h] [ebp-34h] BYREF
  int val4; // [esp+D4h] [ebp-30h] BYREF
  int val5; // [esp+D8h] [ebp-2Ch] BYREF
  int val6; // [esp+DCh] [ebp-28h] BYREF
  int val7; // [esp+E0h] [ebp-24h] BYREF
  int val8; // [esp+E4h] [ebp-20h] BYREF
  int val9; // [esp+E8h] [ebp-1Ch] BYREF

  fp = Q_OpenFile_sub_1BB10("gizmos.txt", 0);
  if ( fp )
  {
    found = FALSE;
    do
    {
      fgets(buf, 200, fp);
      if ( buf[0] == '#' )
      {
        found = TRUE;
      }
    }
    while ( found == FALSE );
    v3 = V_Gizmos;
    for ( i = 0; i < 76; ++i )
    {
      fscanf(fp, "%s", &v3[i]);
      v4 = 0;
      v3 = (T_Gizmo *)(strlen(v3[i].name) + 1);
      if ( (int)&v3[0xFFFFFFFF].generatorPower + 3 > 0 )
      {
        v5 = 0;
        do
        {
          if ( v3[i].name[v5] == '^' )
          {
            v3[i].name[v5] = ' ';
          }
          ++v4;
          ++v5;
        }
        while ( v4 < (int)&v3[0xFFFFFFFF].generatorPower + 3 );
      }
      fscanf(fp, "%d %d %d %d %d %d %d %d %d", &val1, &val2, &val3, &val4, &val5, &val6, &val7, &val8, &val9);
      v3[i].cat = val1;
      v3[i].power = val2;
      v3[i].range = val3;
      v3[i].level = val4;
      v3[i].numUses = val5;
      v3[i].industry = val6;
      v3[i].special1 = val7;
      v3[i].special2 = val8;
      v3[i].resReq = val9;
      fscanf(fp, "%d", &val9);
      v3[i].flags = 0;
      while ( val9 != 0xFF )
      {
        LOWORD(v4) = v3[i].flags;
        v4 |= 1 << val9;
        v3[i].flags = v4;
        fscanf(fp, "%d", &val9);
      }
      v3[i].generatorPower = 0;
      zero = v3[i].generatorPower;
      v3[i].scannerRangePerTurn = zero;
      v3[i].driveMaxDistance = zero;
      v3[i].Unknown_5A = zero;
      v3[i].shieldStrength = zero;
      v3[i].weaponDamage = zero;
      switch ( v3[i].cat )
      {
        case ASCEND_GIZMO_CAT_WEAPON:
          v3[i].weaponDamage = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_SHIELD:
          v3[i].shieldStrength = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_DRIVE:
          v3[i].driveMaxDistance = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_SCANNER:
          v3[i].scannerRangePerTurn = v3[i].level;
          break;
        case ASCEND_GIZMO_CAT_GENERATOR:
          v3[i].generatorPower = v3[i].power;
          break;
        default:
          continue;
      }
    }
    fclose(fp);
  }
  else
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0xBE);
  }
}
// 48C84: using guessed type char buf[200];

//----- (00048EAC) --------------------------------------------------------
void __fastcall sub_48EAC(P_Ship pShip)
{
  int i; // kr0C_4
  char *sub_1CEA8; // kr00_4
  int j; // ebp
  char v5; // dl
  int v6; // esi
  int v7; // ebx
  char v8; // di
  int v9; // ecx
  char v10; // dl
  int v11; // ebp
  int v12; // esi
  double v13; // st7
  int v14; // ebx
  int v15; // kr14_4
  int m; // [esp+4h] [ebp-38h]
  int k; // [esp+10h] [ebp-2Ch]
  char v18; // [esp+14h] [ebp-28h]
  float v19; // [esp+1Ch] [ebp-20h]
  float v20; // [esp+1Ch] [ebp-20h]
  float v21; // [esp+20h] [ebp-1Ch]

  pShip->gizmosNum = 0;
  pShip->totalWeaponDamage = 0;
  pShip->totalShieldStrength = 0;
  pShip->totalStarLaneDrivePotential = 0;
  pShip->totalDriveMaxDistance = 0;
  pShip->totalScannerRangePerTurn = 0;
  pShip->cloakingLevel = 0;
  pShip->totalGeneratorPower = 0;
  pShip->totalPowerForDrives = 0;
  pShip->Unknown_30 = 0;
  pShip->hasColonizer = 0;
  pShip->Unknown_2C = 0;
  pShip->name[0] = 0;
  pShip->raceIndex = 0xFFFF;
  pShip->locationType = 0;
  pShip->_currentShieldStrength = 0;
  pShip->hullIntegrity = 1;
  pShip->order = 0;
  pShip->_orderTargetObject.pPlanet = 0;
  pShip->availablePower = pShip->_currentShieldStrength;
  pShip->Unknown_98 = pShip->hullIntegrity;
  for ( i = 0; i != 0x19; ++i )
  {
    pShip->hullCells[i].gizmoIndex = 0xFF;
    pShip->hullCells[i]._usesPerTurnLeft = 0;
    pShip->hullCells[i]._active = 0;
  }
  if ( !dword_10701C )
  {
    v15 = 0;                                           // 0: "(depleted)"
    do
    {
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v15 + 0x83);
      strcpy(V_HullNames[v15++], sub_1CEA8);
    }
    while ( V_HullNames[v15] != V_HullNames[4] );
    Q_Ship_LoadGizmosTxt_sub_48C84(pShip);
    word_107018 = 0;
    for ( j = 0; j < 14; ++j )
    {
      v5 = 1;
      v6 = (unsigned __int8)byte_969B8[j];
      v7 = 0;
      if ( byte_969B8[j] )
      {
        v8 = byte_969C8[j];
        do
        {
          if ( ((unsigned __int8)v5 & (unsigned __int8)v8) != 0 )
          {
            ++word_107018;
          }
          ++v7;
          v5 *= 2;
        }
        while ( v7 < v6 );
      }
    }
    for ( k = 0; k < 4; ++k )
    {
      v9 = V_HullCells[k + 1];
      v19 = (float)word_107018;
      v20 = v19 / (double)(v9 - 1);
      v21 = v20;
      for ( m = 0; m < 0xE; ++m )
      {
        if ( v9 <= 0 )
        {
          break;
        }
        v10 = 1;
        v11 = (unsigned __int8)byte_969B8[m];
        v12 = 0;
        if ( byte_969B8[m] )
        {
          v18 = byte_969C8[m];
          do
          {
            if ( ((unsigned __int8)v18 & (unsigned __int8)v10) != 0 )
            {
              v13 = v21 + 1.0;
              v14 = k + 4 * m;
              v21 = v13;
              if ( v13 < v20 )
              {
                if ( v9 == 1 && v20 + -1.0 < v21 )
                {
                  v9 = 0;
                  byte_106FE0[v14] |= v10;
                }
              }
              else
              {
                --v9;
                v21 = v21 - v20;
                byte_106FE0[v14] |= v10;
              }
            }
            ++v12;
            v10 *= 2;
          }
          while ( v12 < v11 );
        }
      }
    }
    dword_10701C = TRUE;
  }
}
// 107018: using guessed type __int16 word_107018;
// 10701C: using guessed type int dword_10701C;

//----- (00049148) --------------------------------------------------------
void __fastcall Q_Ship_SetSize_sub_49148(P_Ship pShip, char hullSize)
{
  int raceIndex; // edx

  pShip->hullSize = hullSize;
  if ( hullSize >= 4 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x131);
  }
  pShip->hullCellsNum = V_HullCells[pShip->hullSize + 1];
  if ( !pShip->name[0] || pShip->raceIndex != V_PlayerRaceIndex )
  {
    strcpy(pShip->name, V_HullNames[pShip->hullSize]);
  }
  raceIndex = pShip->raceIndex;
  pShip->hullIntegrity = 10 * (pShip->hullSize + 1);
  pShip->Unknown_14 = 0;
  if ( V_Game.races[raceIndex].ability == ASCEND_SA_DOUBLE_HULL )
  {
    pShip->hullIntegrity *= 2;
  }
  pShip->Unknown_98 = pShip->hullIntegrity;
}

//----- (000492AC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Ship_PutNewGizmoIntoCell_sub_492AC(P_Ship pShip, BYTE gizmoIndex, int hullCellIndex)
{
  UBYTE gizmoIndexWas; // ch

  if ( hullCellIndex > pShip->hullCellsNum )
  {
    return FALSE;
  }
  gizmoIndexWas = pShip->hullCells[hullCellIndex].gizmoIndex;
  if ( gizmoIndex == gizmoIndexWas )
  {
    return FALSE;
  }
  if ( gizmoIndexWas == 0xFF )
  {
    ++pShip->gizmosNum;
  }
  pShip->hullCells[hullCellIndex].gizmoIndex = gizmoIndex;
  Q_Ship_RecalcStats_sub_496E0(pShip);
  return TRUE;
}

//----- (000492F8) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_Ship_RemoveGizmoFromCell_sub_492F8(P_Ship pShip, int hullCellIndex)
{
  if ( pShip->hullCells[hullCellIndex].gizmoIndex == 0xFF )
  {
    return FALSE;
  }
  --pShip->gizmosNum;
  pShip->hullCells[hullCellIndex].gizmoIndex = 0xFF;
  Q_Ship_RecalcStats_sub_496E0(pShip);
  return TRUE;
}

//----- (00049328) --------------------------------------------------------
unsigned int __fastcall Q_Ship_FindFirstCellWithCat_sub_49328(P_Ship pShip, BYTE category)
{
  P_Ship v2; // esi
  unsigned int NOT_FOUND; // edi
  int v5; // edx

  v2 = pShip;
  NOT_FOUND = 0xFFFFFFFF;
  v5 = 0;
  if ( pShip->hullCellsNum > 0 )
  {
    while ( pShip->hullCells[0].gizmoIndex == 0xFF || category != V_Gizmos[(char)pShip->hullCells[0].gizmoIndex].cat )
    {
      ++v5;
      pShip = (P_Ship)((char *)pShip + 7);
      if ( v5 >= v2->hullCellsNum )
      {
        return NOT_FOUND;
      }
    }
    return v5;
  }
  return NOT_FOUND;
}

//----- (0004937C) --------------------------------------------------------
// Finds the first hull cell index containing a specific gizmo
// Return Index of the hull cell containing the gizmo, or -1 if not found
int __fastcall Q_Ship_FindGizmoHullCellIndex_sub_4937C(P_Ship pShip, UBYTE gizmoIndex)
{
  int GIZMO_NOT_FOUND; // esi
  int hullCellsNum; // edx
  int hullCellIndex; // eax
  P_Ship i; // edx

  GIZMO_NOT_FOUND = -1u;
  hullCellsNum = pShip->hullCellsNum;
  hullCellIndex = 0;
  if ( hullCellsNum > 0 )
  {
    for ( i = pShip; gizmoIndex != i->hullCells[0].gizmoIndex; i = (P_Ship)((char *)i + 7) )
    {
      if ( ++hullCellIndex >= pShip->hullCellsNum )
      {
        return GIZMO_NOT_FOUND;
      }
    }
    return hullCellIndex;
  }
  return GIZMO_NOT_FOUND;
}

//----- (000493BC) --------------------------------------------------------
// Changes a ship's hull size and reorganizes its components
// @return TRUE if successful, FALSE if new hull is too small for current components
MACRO_VFX_BOOL __fastcall Q_Ship_ChangeHullSize_sub_493BC(P_Ship pShip, BYTE newHullSize)
{
  int gizmosNum; // ebx
  MACRO_VFX_BOOL false; // eax
  int newCellIndex; // edi
  UBYTE gizmoIndex; // bl
  int oldCellIndex; // esi

  if ( newHullSize != pShip->hullSize )
  {
    gizmosNum = pShip->gizmosNum;
    false = FALSE;
    // Check if new hull can accommodate current components
    if ( V_HullCells[newHullSize + 1] < gizmosNum )
    {
      return false;
    }
    // Reorganize components if ship has any
    if ( pShip->hullCellsNum > 0 )
    {
      newCellIndex = 0;
      oldCellIndex = 0;
      do
      {
        gizmoIndex = pShip->hullCells[oldCellIndex].gizmoIndex;
        if ( gizmoIndex != 0xFF )
        {
          Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, oldCellIndex);
          Q_Ship_PutNewGizmoIntoCell_sub_492AC(pShip, gizmoIndex, newCellIndex++);
        }
        ++oldCellIndex;
      }
      while ( oldCellIndex < pShip->hullCellsNum );
    }
    Q_Ship_SetSize_sub_49148(pShip, newHullSize);
    strcpy(pShip->name, V_HullNames[pShip->hullSize]);
    Q_Ship_RecalcStats_sub_496E0(pShip);
  }
  return TRUE;
}

//----- (00049494) --------------------------------------------------------
void __fastcall Q_Ship_MoveIntoOrbit_sub_49494(P_Ship pShip, P_Planet pPlanet)
{
  double z; // st7
  int gyroInductor; // eax
  T_Vector3D v5; // [esp+0h] [ebp-3Ch] BYREF
  T_Vector3D v6; // [esp+Ch] [ebp-30h] BYREF
  T_Vector3D randomVector; // [esp+18h] [ebp-24h] BYREF
  int v8; // [esp+24h] [ebp-18h]
  T_Vector3D *v9; // [esp+28h] [ebp-14h]

  if ( Q_Planet_TryPlaceShipInOrbit_sub_35BB4(pPlanet, pShip) )
  {
    gyroInductor = Q_Ship_FindGizmoHullCellIndex_sub_4937C(pShip, ASCEND_GIZMO_67_GYRO_INDUCTOR);
    if ( gyroInductor != 0xFFFFFFFF && pShip->hullCells[gyroInductor]._usesPerTurnLeft )
    {
      // Generate power from Gyro-Inductor
      pShip->availablePower += V_Gizmos[ASCEND_GIZMO_67_GYRO_INDUCTOR].special1;
      --pShip->hullCells[gyroInductor]._usesPerTurnLeft;
    }
    if ( pShip->raceIndex == V_PlayerRaceIndex && pShip->order == ASCEND_SO_3_ORBITPLANET )
    {
      if ( WinMgr.state != ASCEND_WINMGR_STATE_BATTLE )
      {
        Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_16_ENTERED_ORBIT, (int)pShip, (int)pShip->_orderTargetObject.pPlanet);
      }
      pShip->order = ASCEND_SO_0_NOTHING;
      pShip->_orderTargetObject.pPlanet = 0;
    }
  }
  else
  {
    // Fail to orbit. Put in random location near planet.
    pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
    randomVector.x = (float)(rand() % 1000 - 500);
    randomVector.y = (float)(rand() % 1000 - 500);
    v8 = rand() % 1000 - 500;
    randomVector.z = (float)v8;
    Q_Vector3D_SetLength_sub_53054(&randomVector, 250.0);
    memset(&v6, 0, sizeof(v6));
    v9 = &v5;
    v6.x = pPlanet->position.x + randomVector.x;
    v6.y = pPlanet->position.y + randomVector.y;
    z = pPlanet->position.z;
    v5 = v6;
    v6.z = z + randomVector.z;
    Q_Ship_SetPositionAndSnapToGrid_sub_496BC(pShip, &v5);
  }
}

//----- (0004960C) --------------------------------------------------------
// Checks if a ship can travel through a star lane
// @return TRUE if ship can travel through lane, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_Ship_CanTraverseStarLane_sub_4960C(P_Ship pShip, P_Lane pLane)
{
  if ( pShip->totalStarLaneHyperdrivePotential + pShip->totalStarLaneDrivePotential <= 0
    && V_Game.races[pShip->raceIndex].ability != ASCEND_SA_FAST_LANE_TRAVEL
    || (pLane->flags & ASCEND_LANE_FLAGS_2_BLOCKED) != 0 )
  {
    return FALSE;
  }
  else
  {
    return TRUE;
  }
}

//----- (00049648) --------------------------------------------------------
// Initiates star lane travel for a ship
void __fastcall Q_Ship_EnterStarLane_sub_49648(P_Ship pShip, P_Lane pLane)
{
  T_Star *pDepartureStar; // esi

  if ( Q_Ship_CanTraverseStarLane_sub_4960C(pShip, pLane) )
  {
    // Get departure star based on current location
    if ( pShip->locationType == ASCEND_LOCATION_TYPE_ORBIT )
    {
      pDepartureStar = &V_Game.stars[pShip->pLocation.pPlanet->starIndex];
    }
    else
    {
      pDepartureStar = pShip->pLocation.pStar;
    }
    // Handle departure from current location
    Q_HandleShipDeparture_sub_1D538((P_Location)pDepartureStar, pShip);
    // Update ship state for lane travel
    pShip->locationType = ASCEND_LOCATION_TYPE_STARLANE;
    pShip->position.x = 0.0;
    pShip->pLocation.pLane = pLane;
    // Set direction based on which star we're departing from
    if ( pDepartureStar == pLane->pStar1 )
    {
      // Traveling from star1 to star2
      pShip->position.y = 1.0;
    }
    else
    {
      // Traveling from star2 to star1
      pShip->position.y = 0.0;
    }
  }
}

//----- (000496BC) --------------------------------------------------------
void __fastcall Q_Ship_SetPositionAndSnapToGrid_sub_496BC(P_Ship pShip, P_Vector3D newPosition)
{
  pShip->position = *newPosition;
  Q_Vector3D_SnapToGrid_sub_53440(&pShip->position);
}

//----- (000496E0) --------------------------------------------------------
void __fastcall Q_Ship_RecalcStats_sub_496E0(P_Ship pShip)
{
  int Unknown_14; // eax
  int i; // esi
  int hullCellsNum; // edi
  T_Gizmo *pGizmo; // eax
  char gizmoIndex; // al
  int starLaneHyperdriveCount; // [esp+8h] [ebp-20h]
  int starLaneDriveCount; // [esp+Ch] [ebp-1Ch]

  pShip->totalWeaponDamage = 0;
  pShip->totalShieldStrength = 0;
  Unknown_14 = pShip->Unknown_14;
  pShip->totalScannerRangePerTurn = 0;
  pShip->cloakingLevel = 0;
  pShip->totalGeneratorPower = 0;
  pShip->totalPowerForDrives = 0;
  pShip->hasColonizer = 0;
  pShip->Unknown_2C = 0;
  starLaneDriveCount = 0;
  pShip->Unknown_30 = 0;
  starLaneHyperdriveCount = 0;
  hullCellsNum = pShip->hullCellsNum;
  pShip->totalDriveMaxDistance = Unknown_14;
  if ( hullCellsNum > 0 )
  {
    i = 0;
    do
    {
      if ( pShip->hullCells[i].gizmoIndex != 0xFF )
      {
        pGizmo = &V_Gizmos[(char)pShip->hullCells[i].gizmoIndex];
        pShip->totalWeaponDamage += pGizmo->weaponDamage;
        pShip->totalShieldStrength += pGizmo->shieldStrength;
        pShip->totalDriveMaxDistance += pGizmo->driveMaxDistance;
        pShip->totalScannerRangePerTurn += pGizmo->scannerRangePerTurn;
        pShip->totalGeneratorPower += pGizmo->generatorPower;
        if ( pGizmo->cat == ASCEND_GIZMO_CAT_DRIVE )
        {
          pShip->totalPowerForDrives += pGizmo->power;
        }
        gizmoIndex = pShip->hullCells[i].gizmoIndex;
        switch ( gizmoIndex )
        {
          case ASCEND_GIZMO_71_COLONIZER:
            pShip->hasColonizer = TRUE;
            break;
          case ASCEND_GIZMO_43_STAR_LANE_DRIVE:
            ++starLaneDriveCount;
            break;
          case ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE:
            ++starLaneHyperdriveCount;
            break;
          case ASCEND_GIZMO_42_CLOAKER:
            ++pShip->cloakingLevel;
            break;
        }
      }
      ++i;
    }
    while ( i < pShip->hullCellsNum );
  }
  pShip->totalStarLaneDrivePotential = (int)(sqrt((double)starLaneDriveCount) * 10.0);
  pShip->totalStarLaneHyperdrivePotential = (int)(sqrt((double)starLaneHyperdriveCount) * 20.0);
}

//----- (00049828) --------------------------------------------------------
void __fastcall sub_49828(P_Ship pShip)
{
  P_Planet pPlanet; // ecx
  int eventId; // edx
  P_Planet pPlanet_; // eax

  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SHIPYARD && pShip->locationType != ASCEND_LOCATION_TYPE_SHIPDOCK )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x260);
  }
  if ( !pShip->pLocation.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x261);
  }
  pPlanet = pShip->pLocation.pPlanet;
  if ( pShip->raceIndex != pPlanet->raceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x265);
  }
  if ( pShip->locationType == ASCEND_LOCATION_TYPE_SHIPYARD )
  {
    pShip->_dayBuilt = V_Game.day;
    if ( pShip->raceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_PLANET_ALLOC )
    {
      eventId = ASCEND_EP_17_SHIP_COMPLETE;
ADD_GAME_EVENT:
      Q_AddGameEvent_sub_55AEC(&WinMgr, eventId, (int)pShip, (int)pPlanet);
    }
  }
  else if ( pShip->raceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_PLANET_ALLOC )
  {
    eventId = ASCEND_EP_18_REFIT_COMPLETE;
    goto ADD_GAME_EVENT;
  }
  pPlanet_ = pShip->pLocation.pPlanet;
  pShip->locationType = ASCEND_LOCATION_TYPE_ORBIT;
  Q_Star_HandleShipArrival_sub_1D3E8(&V_Game.stars[pPlanet_->starIndex], pShip, 0);
  Q_Ship_SetSize_sub_49148(pShip, pShip->hullSize);
  sub_4A6AC(pShip);
}

//----- (00049940) --------------------------------------------------------
void __fastcall Q_Ship_RemoveFromTheGame_sub_49940(P_Ship pShip)
{
  P_Planet pPlanet; // esi
  int starIndex; // eax
  T_Star *pStar; // eax
  int squareIndex; // eax

  if ( !pShip->locationType )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x288);
  }
  switch ( pShip->locationType )
  {
    case ASCEND_LOCATION_TYPE_SHIPYARD:
    case ASCEND_LOCATION_TYPE_SHIPDOCK:
      pPlanet = pShip->pLocation.pPlanet;
      if ( pPlanet->_squareIndex >= pPlanet->totalSquaresNum )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x297);
      }
      if ( Q_Planet_GetShipAtSquare_sub_35A70(pShip->pLocation.pPlanet, pPlanet->_squareIndex) != pShip )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x29A);
      }
      starIndex = pPlanet->starIndex;
      pShip->locationType = ASCEND_LOCATION_TYPE_SYSTEM;
      pStar = &V_Game.stars[starIndex];
      pShip->pLocation.pStar = pStar;
      Q_HandleShipDeparture_sub_1D538((P_Location)pStar, pShip);
      squareIndex = pPlanet->_squareIndex;
      pPlanet->buildingPlanetItemIndex = 0xFF;
      if ( (unsigned __int16)squareIndex != 0xFFFF )
      {
        pPlanet->pSquares[squareIndex].planetItemIndex = 0xFF;
        pPlanet->_squareIndex = 0xFFFF;
      }
      break;
    case ASCEND_LOCATION_TYPE_ORBIT:
      Q_Planet_LaunchShip_sub_35C38(pShip->pLocation.pPlanet, pShip);
      if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x2B0);
      }
      goto LABEL_12;
    case ASCEND_LOCATION_TYPE_SYSTEM:
LABEL_12:
      Q_HandleShipDeparture_sub_1D538(pShip->pLocation, pShip);
      break;
    default:
      break;
  }
  Q_Game_RemoveShip_sub_20720(&V_Game, pShip);
}

//----- (00049A40) --------------------------------------------------------
void __fastcall sub_49A40(int a1, int a2)
{
  int v3; // kr00_4
  int v4; // kr04_4
  __int16 i; // si

  v3 = a1 + 0xAB;
  v4 = 0;
  for ( i = 0; i < *(_DWORD *)(a1 + 0x15A); ++i )
  {
    if ( *(_BYTE *)(v3 + 7 * v4) != 0xFF && V_Gizmos[*(char *)(v3 + 7 * v4)].cat == 1 && a2 != *(_DWORD *)(v3 + 7 * v4 + 3) )
    {
      sub_49A8C(a1, (char *)(v3 + 7 * v4));
    }
    ++v4;
  }
}

//----- (00049A8C) --------------------------------------------------------
T_Gizmo *__fastcall sub_49A8C(int a1, char *a2)
{
  T_Gizmo *result; // eax
  int v5; // edi
  int v6; // edx
  int power; // ebx

  if ( *a2 == (char)0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x2D3);
  }
  result = &V_Gizmos[*a2];
  if ( (result->flags & 0x20) != 0 )
  {
    if ( *(_DWORD *)(a2 + 3) == 0xFFFFFFFF )
    {
      *(_DWORD *)(a1 + 0x88) += result->power;
      if ( result->cat == 1 )
      {
        result = (T_Gizmo *)result->shieldStrength;
        v5 = *(_DWORD *)(a1 + 0x90) - (_DWORD)result;
        *(_DWORD *)(a1 + 0x90) = v5;
        if ( v5 < 0 )
        {
          *(_DWORD *)(a1 + 0x90) = 0;
        }
      }
      *(_DWORD *)(a2 + 3) = 0;
    }
    else
    {
      v6 = *(_DWORD *)(a1 + 0x88);
      power = result->power;
      if ( v6 >= power )
      {
        *(_DWORD *)(a1 + 0x88) = v6 - power;
        if ( result->cat == 1 )
        {
          result = (T_Gizmo *)result->shieldStrength;
          *(_DWORD *)(a1 + 0x90) += result;
        }
        *(_DWORD *)(a2 + 3) = 0xFFFFFFFF;
      }
    }
  }
  return result;
}

//----- (00049B3C) --------------------------------------------------------
int __fastcall sub_49B3C(P_Ship pShip, int a2)
{
  __int8 Unknown_62; // cl
  int result; // eax

  Unknown_62 = pShip->Unknown_62;
  result = 0;
  if ( Unknown_62 )
  {
    if ( Unknown_62 == 1 )
    {
      result = sub_4A0D0(pShip, a2);
    }
  }
  else
  {
    result = sub_49CC4(pShip, a2);
  }
  pShip->Unknown_84 = result;
  return result;
}

//----- (00049B68) --------------------------------------------------------
int __fastcall sub_49B68(int a1, int a2)
{
  __int16 i; // dx
  bool v5; // zf
  char v6; // al
  float v8; // [esp+8h] [ebp-20h]
  float v9; // [esp+10h] [ebp-18h]

  v9 = -1.0;
  for ( i = 0; i < *(_DWORD *)(a1 + 0x15A); ++i )
  {
    v6 = *(_BYTE *)(a1 + 7 * i + 0xAB);
    v8 = -1.0;
    if ( v6 != (char)0xFF && v6 < 0x4C && (!V_Gizmos[v6].numUses || *(_WORD *)(a1 + 7 * i + 0xAC)) )
    {
      if ( v6 > (char)0xFFFFFFFF && v6 < 9 )
      {
LABEL_35:
        v8 = (double)(0x20 * V_Gizmos[v6].range) * 0.95;
        goto LABEL_25;
      }
      if ( a2 != 1 )
      {
        if ( a2 != 2 || (unsigned __int8)v6 < 0x2Fu )
        {
          goto LABEL_25;
        }
        if ( (unsigned __int8)v6 > 0x2Fu )
        {
          v5 = v6 == 0x46;
          goto LABEL_24;
        }
LABEL_4:
        v8 = (double)(0x20 * V_Gizmos[v6].range) * 0.825;
        goto LABEL_25;
      }
      if ( (unsigned __int8)v6 < 0x30u )
      {
        if ( (unsigned __int8)v6 < 0x25u )
        {
          if ( (unsigned __int8)v6 >= 0x21u && (unsigned __int8)v6 <= 0x23u )
          {
            goto LABEL_35;
          }
        }
        else
        {
          if ( (unsigned __int8)v6 <= 0x26u )
          {
            goto LABEL_35;
          }
          if ( v6 == 0x2F )
          {
            goto LABEL_4;
          }
        }
      }
      else
      {
        if ( (unsigned __int8)v6 <= 0x32u )
        {
          goto LABEL_35;
        }
        if ( (unsigned __int8)v6 < 0x3Du )
        {
          v5 = v6 == 0x36;
LABEL_24:
          if ( v5 )
          {
            goto LABEL_35;
          }
        }
        else
        {
          if ( (unsigned __int8)v6 <= 0x3Du )
          {
            goto LABEL_35;
          }
          if ( (unsigned __int8)v6 >= 0x40u )
          {
            if ( (unsigned __int8)v6 <= 0x40u )
            {
              goto LABEL_35;
            }
            v5 = v6 == 0x42;
            goto LABEL_24;
          }
        }
      }
LABEL_25:
      if ( v8 > (double)v9 )
      {
        v9 = v8;
      }
      continue;
    }
  }
  return (int)v9;
}

//----- (00049CC4) --------------------------------------------------------
int __fastcall sub_49CC4(P_Ship pShip, int a2)
{
  BYTE type; // dh
  int v5; // ebx
  P_Lane pLane; // edx
  double v7; // st7
  double z; // st7
  int v9; // eax
  double v10; // st6
  BYTE targetType; // dl
  T_Vector3D v13; // [esp+8h] [ebp-C0h] BYREF
  T_Vector3D v14; // [esp+14h] [ebp-B4h] BYREF
  int v15[3]; // [esp+20h] [ebp-A8h] BYREF
  T_Vector3D position; // [esp+2Ch] [ebp-9Ch] BYREF
  T_Vector3D v17; // [esp+38h] [ebp-90h]
  T_Vector3D v18; // [esp+44h] [ebp-84h] BYREF
  T_Vector3D v19; // [esp+50h] [ebp-78h] BYREF
  T_Vector3D v20; // [esp+5Ch] [ebp-6Ch] BYREF
  float v21; // [esp+68h] [ebp-60h]
  int v22; // [esp+6Ch] [ebp-5Ch]
  int v23; // [esp+70h] [ebp-58h]
  T_Vector3D v24; // [esp+74h] [ebp-54h]
  T_Vector3D v25; // [esp+80h] [ebp-48h] BYREF
  T_Vector3D *v26; // [esp+8Ch] [ebp-3Ch]
  int *v27; // [esp+90h] [ebp-38h]
  T_Vector3D *v28; // [esp+94h] [ebp-34h]
  T_Vector3D *v29; // [esp+98h] [ebp-30h]
  T_Vector3D *v30; // [esp+9Ch] [ebp-2Ch]
  float v31; // [esp+A4h] [ebp-24h]
  float availableMoves; // [esp+A8h] [ebp-20h]
  int availablePower; // [esp+ACh] [ebp-1Ch]
  float v34; // [esp+B0h] [ebp-18h]

  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x370);
  }
  memset(&position, 0, sizeof(position));
  type = pShip->_target.type;
  v5 = 1;
  switch ( type )
  {
    case 3:
      position = pShip->Unknown_6C;
      break;
    case 1:
      position = pShip->_target.pObject.pPlanet->position;
      break;
    case 2:
      position = pShip->_target.pObject.pLane->vector2;
      pLane = pShip->_target.pObject.pLane;
      if ( pShip->pLocation.pStar == pLane->pStar1 )
      {
        position = pLane->vector1;
      }
      break;
    default:
      v5 = 0;
      break;
  }
  if ( (v5 & 1) != 0 )
  {
    v29 = &v18;
    memset(&v14, 0, sizeof(v14));
    v14.x = position.x - pShip->position.x;
    v14.y = position.y - pShip->position.y;
    v14.z = position.z - pShip->position.z;
    v18 = v14;
    v34 = sqrt(v14.y * v14.y + v14.x * v14.x + v14.z * v14.z) * 0.0062500001;
    availableMoves = (float)pShip->availableMoves;
    v31 = v34;
    if ( v34 > (double)availableMoves )
    {
      v34 = availableMoves;
    }
    availablePower = (int)((double)pShip->totalPowerForDrives * (v34 + 1.0) / (double)pShip->totalDriveMaxDistance);
    if ( availablePower < 1 )
    {
      availablePower = 1;
    }
    if ( availablePower > pShip->availablePower )
    {
      v7 = (double)pShip->availablePower * v34 / (double)availablePower;
      availablePower = pShip->availablePower;
      v34 = v7;
    }
    if ( v34 == v31 )
    {
      LOBYTE(v5) = v5 | 8;
    }
    Q_Vector3D_Normalize_sub_53000(&v18);
    v26 = &v13;
    v24.x = v18.x * v34;
    v24.y = v18.y * v34;
    v24.z = v34 * v18.z;
    v13 = v24;
    v21 = v24.x * 32.0;
    v27 = v15;
    *(float *)&v22 = v24.y * 32.0;
    *(float *)v15 = v21;
    *(float *)&v23 = 32.0 * v24.z;
    v15[1] = v22;
    v15[2] = v23;
    v17.x = v21 * 5.0;
    v28 = &v19;
    v17.y = *(float *)&v22 * 5.0;
    v19 = v17;
    v17.z = 5.0 * *(float *)&v23;
    v18 = v17;
    memset(&v20, 0, sizeof(v20));
    v30 = &v25;
    v20.x = pShip->position.x + v17.x;
    v20.y = pShip->position.y + v17.y;
    z = pShip->position.z;
    v25 = v20;
    v20.z = z + v17.z;
    pShip->Unknown_78.x = v20.x;
    pShip->Unknown_78.y = v25.y;
    pShip->Unknown_78.z = v25.z;
    Q_Vector3D_SnapToGrid_sub_53440(&pShip->Unknown_78);
    if ( a2 == 1 )
    {
      v9 = availablePower;
      pShip->position = pShip->Unknown_78;
      v10 = (double)pShip->availableMoves - v34;
      pShip->availablePower -= v9;
      pShip->availableMoves = (int)v10;
      if ( (v5 & 8) != 0 )
      {
        targetType = pShip->_target.type;
        if ( targetType == 1 )
        {
          Q_Ship_MoveIntoOrbit_sub_49494(pShip, pShip->_target.pObject.pPlanet);
        }
        else if ( targetType == 2 )
        {
          Q_Ship_EnterStarLane_sub_49648(pShip, pShip->_target.pObject.pLane);
        }
      }
    }
  }
  return v5;
}

//----- (0004A0D0) --------------------------------------------------------
int __fastcall sub_4A0D0(P_Ship pShip, int a2)
{
  P_HullCell pCurHullCell; // ecx
  unsigned int v3; // esi
  int v4; // ebx
  BYTE type; // cl

  pCurHullCell = pShip->pCurHullCell;
  v3 = 0xFFFFFFFF;
  v4 = 0;
  if ( V_Gizmos[(char)pCurHullCell->gizmoIndex].numUses )
  {
    if ( pCurHullCell->_usesPerTurnLeft )
    {
      if ( a2 == 1 )
      {
        --pCurHullCell->_usesPerTurnLeft;
      }
    }
    else
    {
      v3 = 0;
    }
  }
  if ( v3 == 0xFFFFFFFF )
  {
    type = pShip->_target.type;
    switch ( type )
    {
      case 0:
        return sub_4B944(pShip, a2);
      case 2:
        return Q_Ship_ActivateLaneGizmo_sub_4CAB8(pShip, a2);
      case 1:
        return Q_Ship_ActivatePlanetGizmo_sub_4C7FC(pShip, a2);
      case 5:
        return Q_Ship_ActivateNoTargetGizmo_sub_4CDF8(pShip, a2);
    }
  }
  return v4;
}

//----- (0004A144) --------------------------------------------------------
int __fastcall Q_Ship_GetGizmosCost_sub_4A144(P_Ship pShip)
{
  int cost; // ebx
  unsigned __int16 i; // ax
  char *v4; // edx

  cost = 0;
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    v4 = (char *)pShip + 7 * i;
    if ( v4[0xAB] != (char)0xFF )
    {
      cost += V_Gizmos[v4[0xAB]].industry;
    }
  }
  return cost;
}

//----- (0004A18C) --------------------------------------------------------
int __fastcall Q_Ship_GetCost_sub_4A18C(P_Ship pShip)
{
  int v1; // edx
  int v3[7]; // [esp+0h] [ebp-1Ch]

  v3[0] = dword_969D8[0];
  v3[1] = dword_969D8[1];
  v3[2] = dword_969D8[2];
  v3[3] = dword_969D8[3];
  v1 = v3[pShip->hullSize];
  return v1 + Q_Ship_GetGizmosCost_sub_4A144(pShip);
}
// 969D8: using guessed type _DWORD dword_969D8[4];
// 4A18C: using guessed type int var_1C[7];

//----- (0004A1CC) --------------------------------------------------------
// Calculates the upgrade potential of a ship by comparing its installed components (gizmos) 
// against the best available components researched by a given race.
// The result is an average score representing how much the ship can be improved.
// Returns
// A normalized score scaled by 10 (0–higher) indicating upgrade potential, where:
// - 0 means no upgrades available.
// - Higher values mean better upgrade opportunities.
int __fastcall Q_Ship_UpgradePotential_sub_4A1CC(P_Ship pShip, WORD raceIndex)
{
  int totalUpgradePotential; // ecx
  int upgradableGizmoCount; // edi
  unsigned __int16 i; // dx
  int bestGizmoLevel; // eax
  int installedGizmoLevel; // ebp
  char bestWeapon; // [esp+6h] [ebp-28h]
  char bestGenerator; // [esp+Ah] [ebp-24h]
  char bestLaneDrive; // [esp+Eh] [ebp-20h]
  char bestShield; // [esp+12h] [ebp-1Ch]
  char bestDrive; // [esp+16h] [ebp-18h]

  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x408);
  }
  bestWeapon = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_WEAPON, raceIndex);
  bestGenerator = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_GENERATOR, raceIndex);
  bestDrive = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_DRIVE, raceIndex);
  totalUpgradePotential = 0;
  bestShield = Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(pShip, ASCEND_GIZMO_CAT_SHIELD, raceIndex);
  bestLaneDrive = ASCEND_GIZMO_43_STAR_LANE_DRIVE;
  upgradableGizmoCount = 0;
  if ( Q_Ship_GizmoIsResearchedByRace_sub_4A404(pShip, ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE) )
  {
    bestLaneDrive = ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE;
  }
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    if ( pShip->hullCells[i].gizmoIndex != 0xFF )
    {
      bestGizmoLevel = 0xFFFFFFFF;
      switch ( V_Gizmos[i].cat )
      {
        case ASCEND_GIZMO_CAT_WEAPON:
          bestGizmoLevel = V_Gizmos[bestWeapon].level;
          break;
        case ASCEND_GIZMO_CAT_SHIELD:
          bestGizmoLevel = V_Gizmos[bestShield].level;
          break;
        case ASCEND_GIZMO_CAT_DRIVE:
          bestGizmoLevel = V_Gizmos[bestDrive].level;
          break;
        case ASCEND_GIZMO_CAT_GENERATOR:
          bestGizmoLevel = V_Gizmos[bestGenerator].level;
          break;
        default:
          break;
      }
      if ( pShip->hullCells[i].gizmoIndex == ASCEND_GIZMO_43_STAR_LANE_DRIVE && bestLaneDrive == ASCEND_GIZMO_44_STAR_LANE_HYPERDRIVE )
      {
        ++upgradableGizmoCount;
        ++totalUpgradePotential;
      }
      else if ( bestGizmoLevel != 0xFFFFFFFF )
      {
        installedGizmoLevel = V_Gizmos[(char)pShip->hullCells[i].gizmoIndex].level;
        ++upgradableGizmoCount;
        if ( bestGizmoLevel > installedGizmoLevel )
        {
          totalUpgradePotential += bestGizmoLevel - installedGizmoLevel;
        }
      }
    }
  }
  if ( upgradableGizmoCount <= 0 )
  {
    // No upgradable gizmos found
    return 0;
  }
  else
  {
    // Return average upgrade potential (scaled by 10 for precision)
    return 10 * totalUpgradePotential / upgradableGizmoCount;
  }
}

//----- (0004A36C) --------------------------------------------------------
char __fastcall Q_Ship_GetHighestLevelKnownGizmo_sub_4A36C(P_Ship pShip, BYTE cat, WORD raceIndex)
{
  char raceIndex_; // di
  __int16 level; // bx
  __int16 i; // ax
  char gizmoIndex; // [esp+4h] [ebp-14h]

  raceIndex_ = raceIndex;
  if ( raceIndex < 0 || raceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x45F);
  }
  level = 0;
  gizmoIndex = 0xFF;
  for ( i = 0; i < 76; ++i )
  {
    if ( V_Gizmos[i].cat == cat && ((1 << raceIndex_) & V_Research.techs[V_Gizmos[i].resReq].knownToRace) != 0 && level <= V_Gizmos[i].level )
    {
      gizmoIndex = i;
      level = V_Gizmos[i].level;
    }
  }
  return gizmoIndex;
}

//----- (0004A404) --------------------------------------------------------
int __fastcall Q_Ship_GizmoIsResearchedByRace_sub_4A404(P_Ship pShip, BYTE gizmoIndex)
{
  if ( V_Game.racesNum <= pShip->raceIndex || pShip->raceIndex < 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x476);
  }
  return (((1 << pShip->raceIndex) & V_Research.techs[V_Gizmos[gizmoIndex].resReq].knownToRace) == 0) - 1;
}

//----- (0004A480) --------------------------------------------------------
P_HullCell __fastcall sub_4A480(P_Ship pShip, unsigned __int16 a2, P_TargetObject a3)
{
  T_HullCell *hullCells; // ecx
  T_HullCell *v6; // edi
  int j; // kr04_4
  __int16 i; // bx

  if ( !pShip->availablePower )
  {
    return 0;
  }
  pShip->Unknown_62 = 1;
  v6 = 0;
  if ( a2 )
  {
    if ( a2 <= 2u )
    {
      pShip->_target.type = 1;
      pShip->_target.pObject = a3;
    }
    else
    {
      if ( a2 != 3 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x4A3);
      }
      pShip->_target.type = 0;
      pShip->_target.pObject = a3;
    }
  }
  else
  {
    pShip->_target.type = 2;
    pShip->_target.pObject = a3;
  }
  hullCells = pShip->hullCells;
  j = 0;
  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    if ( hullCells[j].gizmoIndex != 0xFF
      && (!V_Gizmos[(char)hullCells[j].gizmoIndex].cat || pShip->_target.type == 1 && hullCells[j].gizmoIndex == ASCEND_GIZMO_70_PHASE_BOMB) )
    {
      pShip->pCurHullCell = &hullCells[j];
      if ( (sub_49B3C(pShip, 0) & 1) != 0 )
      {
        return &hullCells[j];
      }
    }
    ++j;
  }
  return v6;
}

//----- (0004A534) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_ShipHasGizmo_sub_4A534(P_Ship pShip, BYTE a2)
{
  __int16 i; // ax

  for ( i = 0; i < pShip->hullCellsNum; ++i )
  {
    if ( a2 == pShip->hullCells[i].gizmoIndex )
    {
      return TRUE;
    }
  }
  return FALSE;
}

//----- (0004A564) --------------------------------------------------------
unsigned int __fastcall sub_4A564(int a1)
{
  __int16 i; // ax

  for ( i = 0; i < *(_DWORD *)(a1 + 0x15A); ++i )
  {
    if ( !V_Gizmos[*(char *)(a1 + 7 * i + 0xAB)].cat && (!V_Gizmos[*(char *)(a1 + 7 * i + 0xAB)].numUses || *(_WORD *)(a1 + 7 * i + 0xAC)) )
    {
      return 0xFFFFFFFF;
    }
  }
  return 0;
}

//----- (0004A5B8) --------------------------------------------------------
// Recalculates ship movement and shield status at start of turn
void __fastcall Q_Ship_RecalculateTurnResources_sub_4A5B8(P_Ship pShip)
{
  int totalDriveMaxDistance; // edx
  T_HullCell *shipHullCells; // ebx
  T_Gizmo *pGizmo; // edx
  int availablePower; // ecx
  int powerUsed; // edi
  int i; // esi

  if ( (pShip->specialEffects & 1) != 0 )
  {
    pShip->availableMoves = 0;
  }
  else
  {
    if ( (pShip->specialEffects & ASCEND_EFFECT_ENGINES_BOOST) != 0 )
    {
      // Apply engine boost
      totalDriveMaxDistance = V_Gizmos[ASCEND_GIZMO_63_TOROIDAL_BLASTER].special1 + pShip->totalDriveMaxDistance;
    }
    else
    {
      totalDriveMaxDistance = pShip->totalDriveMaxDistance;
    }
    pShip->availableMoves = totalDriveMaxDistance;
  }
  pShip->_currentShieldStrength = 0;
  // Process all installed gizmos
  if ( pShip->hullCellsNum > 0 )
  {
    shipHullCells = pShip->hullCells;
    i = 0;
    do
    {
      if ( shipHullCells[i].gizmoIndex != 0xFF )
      {
        pGizmo = &V_Gizmos[(char)shipHullCells[i].gizmoIndex];
        if ( (pGizmo->flags & ASCEND_GZ_TOGGLEABLE) != 0 && shipHullCells[i]._active == TRUE )
        {
          availablePower = pShip->availablePower;
          powerUsed = pGizmo->power;
          if ( availablePower >= powerUsed )
          {
            pShip->availablePower = availablePower - powerUsed;
            if ( pGizmo->cat == ASCEND_GIZMO_CAT_SHIELD )
            {
              pShip->_currentShieldStrength += pGizmo->shieldStrength;
            }
          }
        }
      }
      ++i;
    }
    while ( i < pShip->hullCellsNum );
  }
  if ( (pShip->specialEffects & 8) != 0 )
  {
    pShip->_currentShieldStrength = 0;
  }
}

//----- (0004A6AC) --------------------------------------------------------
void __fastcall sub_4A6AC(P_Ship pShip)
{
  int EffectveGeneratorsPower_sub_4A8FC; // eax
  int hullCellsNum; // ebx
  T_HullCell *hullCells; // eax
  P_Lane pLane; // edx
  P_Star pStar2; // eax
  P_Star pStar1; // ebx
  double v8; // st7
  int v9; // eax
  double v10; // st7
  P_Star pStar; // edi
  T_Race *pRace; // eax
  int v13; // edx
  float v14; // [esp+8h] [ebp-3Ch]
  int v15; // [esp+Ch] [ebp-38h]
  int v16; // [esp+10h] [ebp-34h]
  int v17[5]; // [esp+14h] [ebp-30h] BYREF
  float v18; // [esp+28h] [ebp-1Ch]
  float v19; // [esp+2Ch] [ebp-18h]

  pShip->specialEffects = 0;
  EffectveGeneratorsPower_sub_4A8FC = Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(pShip);
  hullCellsNum = pShip->hullCellsNum;
  pShip->availablePower = EffectveGeneratorsPower_sub_4A8FC;
  if ( hullCellsNum > 0 )
  {
    hullCells = pShip->hullCells;
    v13 = 0;
    do
    {
      if ( hullCells[v13].gizmoIndex != 0xFF )
      {
        hullCells[v13]._usesPerTurnLeft = V_Gizmos[(char)hullCells[v13].gizmoIndex].numUses;
      }
      ++v13;
    }
    while ( v13 < pShip->hullCellsNum );
  }
  if ( pShip->locationType == ASCEND_LOCATION_TYPE_STARLANE )
  {
    pLane = pShip->pLocation.pLane;
    pStar2 = pLane->pStar2;
    pStar1 = pLane->pStar1;
    v17[3] = (int)v17;
    v14 = pStar1->pos.x - pStar2->pos.x;
    *(float *)&v15 = pStar1->pos.y - pStar2->pos.y;
    *(float *)&v16 = pStar1->pos.z - pStar2->pos.z;
    *(float *)v17 = v14;
    v17[1] = v15;
    v17[2] = v16;
    v8 = sqrt(*(float *)&v15 * *(float *)&v15 + v14 * v14 + *(float *)&v16 * *(float *)&v16);
    v9 = pShip->totalStarLaneHyperdrivePotential + pShip->totalStarLaneDrivePotential;
    v18 = v8;
    v17[4] = v9;
    LOBYTE(pStar1) = pLane->flags;
    v19 = (float)v9;
    if ( ((unsigned __int8)pStar1 & 1) != 0 )
    {
      v19 = v19 * 0.33333334;
    }
    if ( V_Game.races[pShip->raceIndex].ability == 0x12 )
    {
      if ( v19 < 1.0 )
      {
        v19 = 1.0;
      }
      v19 = v19 * 2.0;
    }
    v10 = pShip->position.x + v19;
    pShip->position.x = v10;
    if ( v10 > v18 )
    {
      pShip->position.x = v18;
    }
    if ( pShip->position.x == v18 )
    {
      if ( (LODWORD(pShip->position.y) & 0x7FFFFFFF) != 0 )
      {
        pStar = pShip->pLocation.pLane->pStar2;
      }
      else
      {
        pStar = pShip->pLocation.pLane->pStar1;
      }
      pRace = &V_Game.races[V_PlayerRaceIndex];
      if ( pShip->raceIndex == V_PlayerRaceIndex )
      {
        sub_45A54(pRace, pStar, pShip);
      }
      else if ( ((1 << V_PlayerRaceIndex) & (pStar->racesBits | pStar->racePresenceBits)) != 0 )
      {
        sub_45D50(pRace, pStar, pShip);
      }
      Q_Star_HandleShipArrival_sub_1D3E8(pStar, pShip, 0);
      if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x55A);
      }
    }
  }
  Q_Ship_RecalculateTurnResources_sub_4A5B8(pShip);
}

//----- (0004A8CC) --------------------------------------------------------
// Calculates a ship's rank based on how long it has been in service
// Rank increases by 1 every 100 days, with a maximum rank of 10
// Returns rank from 0 to 10
int __fastcall Q_GetShipRank_sub_4A8CC(P_Ship pShip)
{
  int calculatedRank; // eax

  calculatedRank = (V_Game.day - pShip->_dayBuilt) / 100;
  if ( calculatedRank < 0 )
  {
    return 0;
  }
  if ( calculatedRank > 10 )
  {
    return 10;
  }
  return calculatedRank;
}

//----- (0004A8FC) --------------------------------------------------------
// Calculates the effective generator power output for a ship,
// taking into account the ship's rank-based efficiency modifier.
int __fastcall Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(P_Ship pShip)
{
  int totalGeneratorPower; // [esp+4h] [ebp-Ch]
  float efficiencyModifier; // [esp+8h] [ebp-8h]

  totalGeneratorPower = pShip->totalGeneratorPower;
  // Calculate rank-based efficiency modifier (10% bonus per rank, capped at +100%)
  efficiencyModifier = (double)Q_GetShipRank_sub_4A8CC(pShip) * 0.1 + 1.0;
  if ( efficiencyModifier >= 1.0 )
  {
    if ( efficiencyModifier > 2.0 )
    {
      efficiencyModifier = 2.0;
    }
  }
  else
  {
    efficiencyModifier = 1.0;
  }
  return (int)((double)totalGeneratorPower * efficiencyModifier);
}

//----- (0004A988) --------------------------------------------------------
int __fastcall sub_4A988(P_Ship pShip)
{
  int v1; // ebx
  int v2; // esi
  T_Gizmo *v3; // edx

  v1 = 0;
  if ( pShip->hullCellsNum > 0 )
  {
    v2 = 0;
    do
    {
      if ( pShip->hullCells[v2]._usesPerTurnLeft == 1 && pShip->hullCells[v2].gizmoIndex != (UBYTE)-1 )
      {
        v3 = &V_Gizmos[(char)pShip->hullCells[v2].gizmoIndex];
        v1 += v3->industry;
        switch ( v3->cat )
        {
          case ASCEND_GIZMO_CAT_WEAPON:
            v1 += v3->range / 5 + 10 * v3->level;
            break;
          case ASCEND_GIZMO_CAT_SHIELD:
            v1 += 5 * v3->level;
            break;
          case ASCEND_GIZMO_CAT_DRIVE:
            v1 += 2 * v3->level;
            break;
          case ASCEND_GIZMO_CAT_SCANNER:
            v1 += v3->level;
            break;
          case ASCEND_GIZMO_CAT_SPECIAL:
            v1 += v3->range / 5 + 5 * v3->level;
            break;
          default:
            break;
        }
      }
      ++v2;
    }
    while ( v2 < pShip->hullCellsNum );
  }
  return (4 * pShip->hullIntegrity + 10 * Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(pShip) + v1) / 0xA;
}

//----- (0004AA78) --------------------------------------------------------
int __fastcall sub_4AA78(P_Ship pShip, P_Star pStar)
{
  P_Star pStar_; // eax

  if ( !pStar )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x5B6);
  }
  if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x5B7);
  }
  pStar_ = pShip->pLocation.pStar;
  if ( pStar == pStar_ )
  {
    return 0;
  }
  pShip->order = 1;
  pShip->_orderTargetObject.pPlanet = (P_Planet)pStar;
  return V_Game.starConnections[pStar_->index][pStar->index];
}

//----- (0004AAEC) --------------------------------------------------------
int __fastcall sub_4AAEC(int a1, int a2)
{
  int ShipsAtLocation_sub_1D794; // eax
  int v3; // kr04_4
  int v4; // kr08_4
  char *v5; // eax
  int v6; // esi
  double v7; // st7
  char *v8; // edx
  char *v9; // kr0C_4
  T_Ship *v10; // eax
  int v11; // ebx
  int GizmoHullCellIndex_sub_4937C; // eax
  float *v13; // esi
  int v14; // eax
  T_Planet *v15; // ebx
  int SquareWithItem_sub_35930; // eax
  int i; // ecx
  int j; // edi
  void *pShip[107]; // [esp+8h] [ebp-218h] BYREF
  float v21; // [esp+1B4h] [ebp-6Ch]
  float v22; // [esp+1B8h] [ebp-68h]
  float v23; // [esp+1BCh] [ebp-64h]
  float v24; // [esp+1C0h] [ebp-60h]
  float v25; // [esp+1C4h] [ebp-5Ch]
  float v26; // [esp+1C8h] [ebp-58h]
  int v27[3]; // [esp+1CCh] [ebp-54h] BYREF
  int v28[3]; // [esp+1D8h] [ebp-48h] BYREF
  int v29; // [esp+1E4h] [ebp-3Ch]
  int v30; // [esp+1E8h] [ebp-38h]
  int *v31; // [esp+1ECh] [ebp-34h]
  int v32; // [esp+1F0h] [ebp-30h]
  int v33; // [esp+1F4h] [ebp-2Ch]
  int *v34; // [esp+1F8h] [ebp-28h]
  float v35; // [esp+1FCh] [ebp-24h]
  int v36; // [esp+200h] [ebp-20h]
  float *v37; // [esp+204h] [ebp-1Ch]
  float v38; // [esp+208h] [ebp-18h]

  v29 = a1;
  v36 = a2;
  v30 = 0;
  if ( *(_BYTE *)(a1 + 0x58) == 4 )
  {
    ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(*(P_Location *)(a1 + 0x59), (P_Ship *)pShip);
    if ( ShipsAtLocation_sub_1D794 > 0 )
    {
      v32 = 4 * ShipsAtLocation_sub_1D794;
      v4 = ShipsAtLocation_sub_1D794;
      v37 = (float *)(v29 + 0x9E);
      v3 = 0;
      while ( 1 )
      {
        v5 = (char *)pShip[v3];
        if ( *((__int16 *)v5 + 0x2B) == v36 && v5[0x58] == 4 )
        {
          v6 = 0;
          v31 = v27;
          v21 = 0.0;
          v22 = 0.0;
          v23 = 0.0;
          v21 = *v37 - *(float *)(v5 + 0x9E);
          v22 = v37[1] - *(float *)(v5 + 0xA2);
          v23 = v37[2] - *(float *)(v5 + 0xA6);
          *(float *)v27 = v21;
          *(float *)&v27[1] = v22;
          *(float *)&v27[2] = v23;
          v7 = sqrt(v22 * v22 + v21 * v21 + v23 * v23);
          v8 = (char *)pShip[v3];
          v38 = v7;
          v9 = v8 + 0xAB;
          for ( i = 0; ; ++i )
          {
            v10 = (T_Ship *)pShip[v3];
            if ( i >= v10->hullCellsNum )
            {
              break;
            }
            if ( v9[7 * i] != (char)0xFF )
            {
              v11 = v9[7 * i];
              if ( V_Gizmos[v11].cat == 3 )
              {
                v33 = 0x20 * V_Gizmos[v9[7 * i]].range;
                if ( (double)v33 >= v38 )
                {
                  v6 += V_Gizmos[v11].scannerRangePerTurn;
                }
              }
            }
          }
          if ( v6 > 0 && v6 > 2 * *(_DWORD *)(v29 + 0x24) )
          {
            GizmoHullCellIndex_sub_4937C = Q_Ship_FindGizmoHullCellIndex_sub_4937C(v10, 0x29u);
            v30 = 1;
            if ( GizmoHullCellIndex_sub_4937C != 0xFFFFFFFF )
            {
              break;
            }
          }
        }
        if ( ++v3 >= v4 )
        {
          goto LABEL_20;
        }
      }
      v30 = 2;
    }
LABEL_20:
    if ( !v30 )
    {
      v13 = (float *)(v29 + 0x9E);
      for ( j = 0; ; ++j )
      {
        v14 = *(_DWORD *)(v29 + 0x59);
        if ( j >= *(__int16 *)(v14 + 0x5A) )
        {
          break;
        }
        v15 = *(T_Planet **)(4 * j + v14 + 0x46);
        if ( v15->raceIndex == v36 )
        {
          v34 = v28;
          v24 = 0.0;
          v25 = 0.0;
          v26 = 0.0;
          v24 = *v13 - v15->position.x;
          v25 = v13[1] - v15->position.y;
          v26 = v13[2] - v15->position.z;
          *(float *)v28 = v24;
          *(float *)&v28[1] = v25;
          *(float *)&v28[2] = v26;
          v35 = sqrt(v25 * v25 + v24 * v24 + v26 * v26);
          SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(v15, 0x10u);
          if ( SquareWithItem_sub_35930 != 0xFFFF && (v15->pSquares[SquareWithItem_sub_35930].flags & 1) != 0 && v35 < 1600.0 )
          {
            return 1;
          }
        }
      }
    }
  }
  return v30;
}
// 4AAEC: using guessed type P_Ship pShip;

//----- (0004AE8C) --------------------------------------------------------
void __fastcall Q_ReadWriteShip_sub_4AE8C(P_Ship pShip, P_CFile pfi, int read)
{
  UBYTE locationType; // al
  P_Planet pPlanet; // ebp
  P_Lane pLane; // ebp
  T_Ship vShip; // [esp+0h] [ebp-3BCh] BYREF
  T_Ship vShipa; // [esp+164h] [ebp-258h] BYREF
  T_Name15 v9[7]; // [esp+2C8h] [ebp-F4h] BYREF
  T_Name15 v10[7]; // [esp+334h] [ebp-88h] BYREF
  T_HullCell *hullCells; // [esp+3A0h] [ebp-1Ch]
  T_Vector3D *p_position; // [esp+3A4h] [ebp-18h]
  P_CFile vfi; // [esp+3A8h] [ebp-14h]

  vfi = pfi;
  hullCells = pShip->hullCells;
  p_position = &pShip->position;
  if ( read == TRUE )
  {
    Q_ShipCtor_sub_48B90(&vShipa);
    Q_ReadFile_sub_1BF94(vfi, &vShipa, 0x162u);
    pShip->totalWeaponDamage = vShipa.totalWeaponDamage;
    pShip->totalShieldStrength = vShipa.totalShieldStrength;
    pShip->totalStarLaneDrivePotential = vShipa.totalStarLaneDrivePotential;
    pShip->totalStarLaneHyperdrivePotential = vShipa.totalStarLaneHyperdrivePotential;
    pShip->totalDriveMaxDistance = vShipa.totalDriveMaxDistance;
    pShip->Unknown_14 = vShipa.Unknown_14;
    pShip->totalGeneratorPower = vShipa.totalGeneratorPower;
    pShip->totalPowerForDrives = vShipa.totalPowerForDrives;
    pShip->totalScannerRangePerTurn = vShipa.totalScannerRangePerTurn;
    pShip->cloakingLevel = vShipa.cloakingLevel;
    pShip->hasColonizer = vShipa.hasColonizer;
    pShip->Unknown_2C = vShipa.Unknown_2C;
    pShip->Unknown_30 = vShipa.Unknown_30;
    qmemcpy(pShip->name, vShipa.name, sizeof(pShip->name));
    pShip->Unknown_50 = vShipa.Unknown_50;
    pShip->_dayBuilt = vShipa._dayBuilt;
    pShip->raceIndex = vShipa.raceIndex;
    pShip->locationType = vShipa.locationType;
    pShip->pLocation.pPlanet = vShipa.pLocation.pPlanet;
    pShip->order = vShipa.order;
    pShip->_orderTargetObject.pPlanet = vShipa._orderTargetObject.pPlanet;
    pShip->Unknown_62 = vShipa.Unknown_62;
    pShip->pCurHullCell = vShipa.pCurHullCell;
    pShip->_target = vShipa._target;
    pShip->Unknown_6C = vShipa.Unknown_6C;
    pShip->Unknown_78 = vShipa.Unknown_78;
    pShip->Unknown_84 = vShipa.Unknown_84;
    pShip->availablePower = vShipa.availablePower;
    pShip->hullIntegrity = vShipa.hullIntegrity;
    pShip->_currentShieldStrength = vShipa._currentShieldStrength;
    pShip->availableMoves = vShipa.availableMoves;
    pShip->Unknown_98 = vShipa.Unknown_98;
    pShip->specialEffects = vShipa.specialEffects;
    *p_position = vShipa.position;
    pShip->hullSize = vShipa.hullSize;
    _wcpp_2_assign_array_(sub_4B780);
    pShip->hullCellsNum = vShipa.hullCellsNum;
    pShip->gizmosNum = vShipa.gizmosNum;
    switch ( pShip->order )
    {
      case 0:
      case 7:
        pShip->_orderTargetObject.pPlanet = 0;
        break;
      case 1:
        pShip->_orderTargetObject.pPlanet = (P_Planet)&V_Game.stars[(int)pShip->_orderTargetObject.pPlanet];
        break;
      case 2:
      case 3:
        pShip->_orderTargetObject.pPlanet = &V_Game.planets[(int)pShip->_orderTargetObject.pPlanet];
        break;
      case 4:
      case 5:
      case 6:
        Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x642);
        break;
      default:
        Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x647);
        break;
    }
    locationType = pShip->locationType;
    if ( locationType < (unsigned int)ASCEND_LOCATION_TYPE_ORBIT )
    {
      if ( !locationType )
      {
LABEL_16:
        qmemcpy(v10, V_Locations, sizeof(v10));
        sub_2620C("Bad m_LocationType: %s", v10[(char)pShip->locationType]);
        Q_PrintFailAndExit_sub_261B8(0, "..\\ship.cpp", 0x67A);
        return;
      }
    }
    else
    {
      if ( locationType > (unsigned int)ASCEND_LOCATION_TYPE_SYSTEM )
      {
        if ( locationType == ASCEND_LOCATION_TYPE_STARLANE )
        {
          pShip->pLocation.pLane = &V_Game.lanes[(int)pShip->pLocation.pLane];
          return;
        }
        goto LABEL_16;
      }
      if ( locationType == ASCEND_LOCATION_TYPE_SYSTEM )
      {
        pShip->pLocation.pStar = &V_Game.stars[(int)pShip->pLocation.pStar];
        return;
      }
    }
    pShip->pLocation.pPlanet = &V_Game.planets[(int)pShip->pLocation.pPlanet];
    return;
  }
  vShip.totalWeaponDamage = pShip->totalWeaponDamage;
  vShip.totalShieldStrength = pShip->totalShieldStrength;
  vShip.totalStarLaneDrivePotential = pShip->totalStarLaneDrivePotential;
  vShip.totalStarLaneHyperdrivePotential = pShip->totalStarLaneHyperdrivePotential;
  vShip.totalDriveMaxDistance = pShip->totalDriveMaxDistance;
  vShip.Unknown_14 = pShip->Unknown_14;
  vShip.totalGeneratorPower = pShip->totalGeneratorPower;
  vShip.totalPowerForDrives = pShip->totalPowerForDrives;
  vShip.totalScannerRangePerTurn = pShip->totalScannerRangePerTurn;
  vShip.cloakingLevel = pShip->cloakingLevel;
  vShip.hasColonizer = pShip->hasColonizer;
  vShip.Unknown_2C = pShip->Unknown_2C;
  vShip.Unknown_30 = pShip->Unknown_30;
  qmemcpy(vShip.name, pShip->name, 0x6Au);
  vShip.position = *p_position;
  vShip.hullSize = pShip->hullSize;
  _wcpp_2_copy_array_(vShip.hullCells, hullCells, 25, &C_HullCell);
  vShip.hullCellsNum = pShip->hullCellsNum;
  vShip.gizmosNum = pShip->gizmosNum;
  switch ( pShip->order )
  {
    case 0:
    case 7:
      break;
    case 1:
      vShip._orderTargetObject.pPlanet = (P_Planet)SLOWORD(pShip->_orderTargetObject.pPlanet->position.y);
      break;
    case 2:
    case 3:
      vShip._orderTargetObject.pPlanet = (P_Planet)(pShip->_orderTargetObject.pPlanet - V_Game.planets);
      break;
    case 4:
    case 5:
    case 6:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x6A7);
      break;
    default:
      Q_AssertLogBreakExit_sub_261A8(0, "..\\ship.cpp", 0x6AC);
      break;
  }
  switch ( pShip->locationType )
  {
    case ASCEND_LOCATION_TYPE_SHIPYARD:
    case ASCEND_LOCATION_TYPE_SHIPDOCK:
      vShip.pLocation.pPlanet = (P_Planet)(pShip->pLocation.pPlanet - V_Game.planets);
      break;
    case ASCEND_LOCATION_TYPE_ORBIT:
      pPlanet = pShip->pLocation.pPlanet;
      if ( !pPlanet )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x6C0);
      }
      vShip.pLocation.pPlanet = (P_Planet)(pPlanet - V_Game.planets);
      break;
    case ASCEND_LOCATION_TYPE_SYSTEM:
      vShip.pLocation.pStar = (P_Star)pShip->pLocation.pStar->index;
      break;
    case ASCEND_LOCATION_TYPE_STARLANE:
      pLane = pShip->pLocation.pLane;
      if ( !pLane )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ship.cpp", 0x6CF);
      }
      vShip.pLocation.pLane = (P_Lane)(pLane - V_Game.lanes);
      break;
    default:
      qmemcpy(v9, V_Locations, sizeof(v9));
      sub_2620C("Bad m_LocationType: %s", v9[(char)pShip->locationType]);
      Q_PrintFailAndExit_sub_261B8(0, "..\\ship.cpp", 0x6EE);
      break;
  }
  Q_CFile_DosWrite_sub_1C098(vfi, &vShip, 0x162u);
}
// 78B30: using guessed type _DWORD __stdcall _wcpp_2_assign_array_(_DWORD);

//----- (0004B5C0) --------------------------------------------------------
void __fastcall Q_Type17Copy_sub_4B5C0(P_HullCell dst, P_HullCell src)
{
  *dst = *src;
}

//----- (0004B5E0) --------------------------------------------------------
char *__fastcall Q_ShipCopy_sub_4B5E0(P_Ship a1, P_Ship a2)
{
  char *result; // eax

  a1->totalWeaponDamage = a2->totalWeaponDamage;
  a1->totalShieldStrength = a2->totalShieldStrength;
  a1->totalStarLaneDrivePotential = a2->totalStarLaneDrivePotential;
  a1->totalStarLaneHyperdrivePotential = a2->totalStarLaneHyperdrivePotential;
  a1->totalDriveMaxDistance = a2->totalDriveMaxDistance;
  a1->Unknown_14 = a2->Unknown_14;
  a1->totalGeneratorPower = a2->totalGeneratorPower;
  a1->totalPowerForDrives = a2->totalPowerForDrives;
  a1->totalScannerRangePerTurn = a2->totalScannerRangePerTurn;
  a1->cloakingLevel = a2->cloakingLevel;
  a1->hasColonizer = a2->hasColonizer;
  a1->Unknown_2C = a2->Unknown_2C;
  a1->Unknown_30 = a2->Unknown_30;
  qmemcpy(a1->name, a2->name, 0x77u);
  result = (char *)_wcpp_2_copy_array_(a1->hullCells, a2->hullCells, 25, &C_HullCell);
  *(_DWORD *)(result + 0xAF) = a2->hullCellsNum;
  *(_DWORD *)(result + 0x15E) = a2->gizmosNum;
  return result;
}

//----- (0004B780) --------------------------------------------------------
int __fastcall sub_4B780(int result, int a2)
{
  *(_BYTE *)result = *(_BYTE *)a2;
  *(_WORD *)(result + 1) = *(_WORD *)(a2 + 1);
  *(_DWORD *)(result + 3) = *(_DWORD *)(a2 + 3);
  return result;
}

//----- (0004B7A0) --------------------------------------------------------
int __fastcall Q_Ship_ApplyDamage_sub_4B7A0(P_Ship pShip, int a2, int requestedDamage, WORD attackerRaceIndex)
{
  int actualDamage; // edi
  int hullDamage; // ebp
  int currentShieldStrength; // ebx
  UBYTE locationType; // dh
  T_Star *pStar; // ecx
  int newHullStrength; // ebx
  int hullSize; // ebx
  int victimRaceIndex; // edx
  int v15; // [esp+Ch] [ebp-14h]

  if ( attackerRaceIndex < 0 || attackerRaceIndex >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x2F);
  }
  if ( pShip->raceIndex < 0 || V_Game.racesNum <= pShip->raceIndex )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x30);
  }
  v15 = 0;
  actualDamage = requestedDamage;
  hullDamage = 0;
  if ( (pShip->specialEffects & 0x10) != 0 )
  {
    actualDamage = 0;
  }
  currentShieldStrength = pShip->_currentShieldStrength;
  if ( actualDamage > currentShieldStrength )
  {
    actualDamage = pShip->_currentShieldStrength;
    hullDamage = requestedDamage - currentShieldStrength;
    LOBYTE(v15) = 2;
  }
  if ( hullDamage >= pShip->hullIntegrity )
  {
    hullDamage = pShip->hullIntegrity;
    LOBYTE(v15) = v15 | 4;
  }
  if ( a2 == 1 )
  {
    locationType = pShip->locationType;
    pStar = 0;
    if ( locationType == ASCEND_LOCATION_TYPE_SYSTEM )
    {
      pStar = pShip->pLocation.pStar;
    }
    else if ( locationType == ASCEND_LOCATION_TYPE_ORBIT
           || locationType == ASCEND_LOCATION_TYPE_SHIPYARD
           || locationType == ASCEND_LOCATION_TYPE_SHIPDOCK )
    {
      pStar = &V_Game.stars[pShip->pLocation.pPlanet->starIndex];
    }
    if ( !pStar )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x53);
    }
    Q_Race_DecayRelations_sub_433E0(&V_Game.races[pShip->raceIndex], attackerRaceIndex, pStar);
    newHullStrength = pShip->hullIntegrity - hullDamage;
    pShip->_currentShieldStrength -= actualDamage;
    pShip->hullIntegrity = newHullStrength;
    if ( newHullStrength < 1 )
    {
      hullSize = pShip->hullSize;
      victimRaceIndex = pShip->raceIndex;
      Q_Ship_RemoveFromTheGame_sub_49940(pShip);
      if ( victimRaceIndex == V_PlayerRaceIndex && WinMgr.state != ASCEND_WINMGR_STATE_BATTLE )
      {
        Q_AddGameEvent_sub_55AEC(&WinMgr, ASCEND_EP_SHIPDESTROYED, hullSize, (int)pStar);
      }
    }
  }
  return v15;
}

//----- (0004B944) --------------------------------------------------------
int __fastcall sub_4B944(P_Ship pShip, int a2)
{
  P_HullCell pCurHullCell; // eax
  unsigned int v4; // ecx
  T_Gizmo *v5; // edi
  P_TargetObject v6; // esi
  double v7; // st7
  WORD specialEffects; // ax
  BOOL v9; // eax
  int weaponDamage; // ebx
  int v11; // eax
  double v13; // st7
  double v14; // st7
  double v15; // st7
  double v16; // st7
  double z; // st7
  int v18; // eax
  int k; // kr04_4
  int v20; // kr08_4
  P_Ship v21; // ebx
  double v22; // st7
  double v23; // st7
  double v24; // st7
  P_Ship v25; // ebx
  int special1; // eax
  int v27; // esi
  int v28; // eax
  int ShipsAtLocation_sub_1D794; // eax
  int v30; // ebp
  float *v31; // ebx
  int i; // kr10_4
  int v33; // kr14_4
  char *v34; // ecx
  double v35; // st7
  double v36; // st7
  char *v37; // ecx
  int v38; // ebx
  int v39; // edx
  char v40; // cl
  char *v41; // eax
  int v42; // ebp
  int v43; // eax
  char v44; // ch
  char *v45; // edx
  int v46; // ebp
  int v47; // ebx
  char v48; // bh
  int v49; // edi
  char *v50; // kr30_4
  char blackSquaresNum_high; // dh
  int v52; // edx
  char v53; // al
  float *v54; // ebx
  T_Vector3D *p_position; // edx
  char v56; // ch
  int v57; // eax
  int v58; // edx
  int v59; // eax
  int j; // ebx
  float x_4; // [esp+4h] [ebp-524h]
  void *v62[107]; // [esp+8h] [ebp-520h] BYREF
  P_Ship v63[132]; // [esp+1B4h] [ebp-374h] BYREF
  T_Vector3D v64; // [esp+3C4h] [ebp-164h] BYREF
  float v65; // [esp+3D0h] [ebp-158h] BYREF
  float v66; // [esp+3D4h] [ebp-154h]
  float v67; // [esp+3D8h] [ebp-150h]
  float v68; // [esp+3DCh] [ebp-14Ch] BYREF
  float v69; // [esp+3E0h] [ebp-148h]
  float v70; // [esp+3E4h] [ebp-144h]
  T_Vector3D v71; // [esp+3E8h] [ebp-140h] BYREF
  float v72; // [esp+3F4h] [ebp-134h] BYREF
  float v73; // [esp+3F8h] [ebp-130h]
  float v74; // [esp+3FCh] [ebp-12Ch]
  T_Vector3D v75; // [esp+400h] [ebp-128h] BYREF
  T_Vector3D v76; // [esp+40Ch] [ebp-11Ch] BYREF
  float v77; // [esp+418h] [ebp-110h]
  float v78; // [esp+41Ch] [ebp-10Ch]
  float v79; // [esp+420h] [ebp-108h]
  T_Vector3D v80; // [esp+424h] [ebp-104h] BYREF
  float v81; // [esp+430h] [ebp-F8h]
  float v82; // [esp+434h] [ebp-F4h]
  float v83; // [esp+438h] [ebp-F0h]
  T_Vector3D v84; // [esp+43Ch] [ebp-ECh] BYREF
  int v85[3]; // [esp+448h] [ebp-E0h] BYREF
  float v86; // [esp+454h] [ebp-D4h]
  float v87; // [esp+458h] [ebp-D0h]
  float v88; // [esp+45Ch] [ebp-CCh]
  float v89; // [esp+460h] [ebp-C8h] BYREF
  float v90; // [esp+464h] [ebp-C4h]
  float v91; // [esp+468h] [ebp-C0h]
  float v92; // [esp+46Ch] [ebp-BCh]
  float v93; // [esp+470h] [ebp-B8h]
  float v94; // [esp+474h] [ebp-B4h]
  T_Vector3D v95; // [esp+478h] [ebp-B0h] BYREF
  float v96; // [esp+484h] [ebp-A4h]
  float v97; // [esp+488h] [ebp-A0h]
  float v98; // [esp+48Ch] [ebp-9Ch]
  T_Vector3D v99; // [esp+490h] [ebp-98h] BYREF
  float x; // [esp+49Ch] [ebp-8Ch]
  float y; // [esp+4A0h] [ebp-88h]
  float v102; // [esp+4A4h] [ebp-84h]
  int *v103; // [esp+4A8h] [ebp-80h]
  float *v104; // [esp+4ACh] [ebp-7Ch]
  T_Vector3D *v105; // [esp+4B0h] [ebp-78h]
  T_Vector3D *v106; // [esp+4B4h] [ebp-74h]
  float *v107; // [esp+4B8h] [ebp-70h]
  float *v108; // [esp+4BCh] [ebp-6Ch]
  T_Vector3D *v109; // [esp+4C0h] [ebp-68h]
  T_Vector3D *v110; // [esp+4C8h] [ebp-60h]
  float *v111; // [esp+4CCh] [ebp-5Ch]
  int v112; // [esp+4D0h] [ebp-58h]
  int v113; // [esp+4D4h] [ebp-54h]
  int power; // [esp+4D8h] [ebp-50h]
  float v115; // [esp+4DCh] [ebp-4Ch]
  float v116; // [esp+4E0h] [ebp-48h]
  float v117; // [esp+4E4h] [ebp-44h]
  int v118; // [esp+4E8h] [ebp-40h]
  int v119; // [esp+4ECh] [ebp-3Ch]
  int v120; // [esp+4F0h] [ebp-38h]
  float v121; // [esp+4F4h] [ebp-34h]
  float v122; // [esp+4F8h] [ebp-30h]
  float v123; // [esp+4FCh] [ebp-2Ch]
  float v124; // [esp+500h] [ebp-28h]
  int v125; // [esp+508h] [ebp-20h]
  char gizmoIndex; // [esp+50Ch] [ebp-1Ch]
  char v127; // [esp+510h] [ebp-18h]

  v113 = a2;
  pCurHullCell = pShip->pCurHullCell;
  v112 = 0xFFFFFFFF;
  v4 = 0xFFFFFFFF;
  gizmoIndex = pCurHullCell->gizmoIndex;
  if ( gizmoIndex == (char)0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0xA2);
  }
  power = 0;
  v118 = 0;
  v5 = &V_Gizmos[gizmoIndex];
  if ( v5->power > pShip->availablePower )
  {
    v112 = 0;
  }
  else
  {
    power = v5->power;
  }
  v6.pPlanet = (P_Planet)pShip->_target.pObject;
  if ( !v6.pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0xAD);
  }
  if ( pShip->locationType != 4 || v6.pPlanet->byte58 != 4 || pShip->pLocation.pPlanet != *(P_Planet *)&v6.pPlanet->byte59 )
  {
    goto LABEL_18;
  }
  if ( v5->range )
  {
    v103 = v85;
    v92 = 0.0;
    v93 = 0.0;
    v94 = 0.0;
    v92 = *(float *)((char *)&v6.pPlanet[1].z5 + 1) - pShip->position.x;
    v93 = *(float *)&v6.pPlanet[1].name[3] - pShip->position.y;
    v94 = *(float *)&v6.pPlanet[1].name[7] - pShip->position.z;
    *(float *)v85 = v92;
    *(float *)&v85[1] = v93;
    *(float *)&v85[2] = v94;
    v7 = sqrt(v93 * v93 + v92 * v92 + v94 * v94);
    v125 = 0x20 * v5->range;
    specialEffects = pShip->specialEffects;
    v115 = v7;
    v117 = (float)v125;
    if ( (specialEffects & 4) != 0 )
    {
      v117 = v117 * 2.0;
    }
    if ( v115 > (double)v117 )
    {
      v4 = 0;
    }
    if ( gizmoIndex == 0x2F && v117 * 0.75 > v115 )
    {
LABEL_18:
      v4 = 0;
    }
  }
  v9 = v112 && v4 && v6.pShip != pShip && (v5->flags & 1) != 0;
  v118 |= v9;
  if ( (v118 & 1) == 0 )
  {
    return v118;
  }
  pShip->Unknown_78 = *(T_Vector3D *)((char *)&v6.pPlanet[1].z5 + 1);
  weaponDamage = 0;
  if ( !v5->cat )
  {
    weaponDamage = v5->weaponDamage;
  }
  if ( gizmoIndex == 0x2F )
  {
    weaponDamage = v5->special1;
  }
  if ( weaponDamage )
  {
    v11 = Q_Ship_ApplyDamage_sub_4B7A0(v6.pShip, v113, weaponDamage, pShip->raceIndex);
    v118 |= v11;
  }
  else
  {
    LOBYTE(v118) = v118 | 0x10;
  }
  if ( v113 != 1 )
  {
    return v118;
  }
  v52 = pShip->availablePower - power;
  v53 = gizmoIndex;
  pShip->availablePower = v52;
  if ( (unsigned __int8)v53 < 0x32u )
  {
    if ( (unsigned __int8)v53 < 0x25u )
    {
      if ( (unsigned __int8)v53 >= 0x22u )
      {
        if ( (unsigned __int8)v53 <= 0x22u )
        {
          *(_DWORD *)&v6.pPlanet->_squareIndex = V_Game.day;
          return v118;
        }
        else
        {
          if ( v53 == 0x23 )
          {
            *(_DWORD *)((char *)&v6.pPlanet[1].starIndex + 1) = 0;
          }
          return v118;
        }
      }
      if ( v53 == 0x21 )
      {
        blackSquaresNum_high = HIBYTE(v6.pPlanet[1].blackSquaresNum);
        *(_DWORD *)((char *)&v6.pPlanet[1].surfaceSquaresNum + 1) = 0;
        HIBYTE(v6.pPlanet[1].blackSquaresNum) = blackSquaresNum_high | 1;
        return v118;
      }
      return v118;
    }
    if ( (unsigned __int8)v53 > 0x25u )
    {
      if ( (unsigned __int8)v53 < 0x2Du )
      {
        if ( v53 != 0x28 )
        {
          return v118;
        }
        ShipsAtLocation_sub_1D794 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, (P_Ship *)v62);
        v30 = 0;
        if ( ShipsAtLocation_sub_1D794 > 0 )
        {
          v31 = (float *)((char *)&v6.pPlanet[1].z5 + 1);
          v119 = 4 * ShipsAtLocation_sub_1D794;
          v33 = ShipsAtLocation_sub_1D794;
          for ( i = 0; i < v33; ++i )
          {
            v34 = (char *)v62[i];
            if ( (char *)v6.pPlanet != v34 )
            {
              v109 = &v76;
              memset(&v75, 0, sizeof(v75));
              v75.x = *(float *)(v34 + 0x9E) - *v31;
              v75.y = *(float *)(v34 + 0xA2) - *(float *)&v6.pPlanet[1].name[3];
              v75.z = *(float *)(v34 + 0xA6) - *(float *)&v6.pPlanet[1].name[7];
              v76 = v75;
              v35 = sqrt(v75.y * v75.y + v75.x * v75.x + v75.z * v75.z);
              v125 = 0x20 * v5->special1;
              v121 = (float)v125;
              if ( v35 < v121 )
              {
                Q_Vector3D_SetLength_sub_53054(&v76, v121);
                v81 = 0.0;
                v82 = 0.0;
                v83 = 0.0;
                v107 = &v68;
                v81 = *v31 + v76.x;
                v82 = *(float *)&v6.pPlanet[1].name[3] + v76.y;
                v36 = *(float *)&v6.pPlanet[1].name[7];
                v68 = v81;
                v83 = v36 + v76.z;
                v69 = v82;
                v37 = (char *)v62[i];
                v70 = v83;
                *(float *)(v37 + 0x9E) = v81;
                *(float *)(v37 + 0xA2) = v69;
                *(float *)(v37 + 0xA6) = v70;
              }
            }
            ++v30;
          }
        }
      }
      else
      {
        if ( (unsigned __int8)v53 <= 0x2Du )
        {
          v105 = &v64;
          memset(&v84, 0, sizeof(v84));
          v84.x = *(float *)((char *)&v6.pPlanet[1].z5 + 1) - pShip->position.x;
          v84.y = *(float *)&v6.pPlanet[1].name[3] - pShip->position.y;
          v13 = *(float *)&v6.pPlanet[1].name[7] - pShip->position.z;
          v64 = v84;
          v84.z = v13;
          v125 = 0x20 * v5->special1;
          x_4 = (float)v125;
          Q_Vector3D_SetLength_sub_53054(&v64, x_4);
          v104 = &v72;
          v96 = 0.0;
          v97 = 0.0;
          v98 = 0.0;
          v96 = *(float *)((char *)&v6.pPlanet[1].z5 + 1) + v64.x;
          v97 = *(float *)&v6.pPlanet[1].name[3] + v64.y;
          v14 = *(float *)&v6.pPlanet[1].name[7] + v64.z;
          v72 = v96;
          v98 = v14;
          v73 = v97;
          v74 = v98;
          *(float *)((char *)&v6.pPlanet[1].z5 + 1) = v96;
          *(float *)&v6.pPlanet[1].name[3] = v73;
          *(float *)&v6.pPlanet[1].name[7] = v74;
          return v118;
        }
        if ( (unsigned __int8)v53 >= 0x30u )
        {
          if ( (unsigned __int8)v53 > 0x30u )
          {
            v56 = HIBYTE(v6.pPlanet[1].blackSquaresNum);
            *(_DWORD *)((char *)&v6.pPlanet[1].size + 1) = 0;
            HIBYTE(v6.pPlanet[1].blackSquaresNum) = v56 | 8;
            return v118;
          }
          v49 = *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2);
          v50 = &v6.pPlanet[1].name[0xC];
          for ( j = 0; j < v49; ++j )
          {
            if ( v50[7 * j] == 0x47 || v50[7 * j] == 0x49 )
            {
              Q_Ship_RemoveGizmoFromCell_sub_492F8(v6.pShip, j);
            }
            v49 = *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2);
          }
        }
      }
      return v118;
    }
LABEL_84:
    v127 = 0;
    if ( gizmoIndex == 0x42 )
    {
      v127 = 5;
    }
    v46 = 0;
    if ( *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2) > 0 )
    {
      v45 = &v6.pPlanet[1].name[0xC];
      v47 = 0;
      v59 = 0;
      do
      {
        if ( v45[7 * v59] != (char)0xFF && V_Gizmos[v45[7 * v59]].cat == v127 )
        {
          ++v46;
          v63[v47 + 0x6B] = (P_Ship)v59;
          ++v47;
        }
        ++v59;
      }
      while ( v59 < *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2) );
    }
    if ( v46 )
    {
      Q_Ship_RemoveGizmoFromCell_sub_492F8(v6.pShip, (int)v63[V_Game.day % v46 + 0x6B]);
      return v118;
    }
    return v118;
  }
  if ( (unsigned __int8)v53 <= 0x32u )
  {
LABEL_74:
    v40 = 5;
    if ( gizmoIndex == 0x32 )
    {
      v40 = 0;
    }
    v42 = 0;
    if ( *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2) > 0 )
    {
      v41 = &v6.pPlanet[1].name[0xC];
      v58 = 0;
      do
      {
        if ( v41[7 * v58] != (char)0xFF && v40 == V_Gizmos[v41[7 * v58]].cat )
        {
          ++v42;
        }
        ++v58;
      }
      while ( v58 < *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2) );
    }
    v43 = *(int *)((char *)&v6.pPlanet[1].pSquares + 1) - v42;
    *(P_Square *)((char *)&v6.pPlanet[1].pSquares + 1) = (P_Square)v43;
    if ( v43 < 1 )
    {
      v44 = v118 | 4;
      Q_Ship_RemoveFromTheGame_sub_49940(v6.pShip);
      LOBYTE(v118) = v44;
      return v118;
    }
    return v118;
  }
  v54 = (float *)((char *)&v6.pPlanet[1].z5 + 1);
  if ( (unsigned __int8)v53 < 0x3Du )
  {
    p_position = &pShip->position;
    if ( (unsigned __int8)v53 < 0x36u )
    {
      if ( v53 != 0x34 )
      {
        return v118;
      }
      v110 = &v99;
      memset(&v71, 0, sizeof(v71));
      v71.x = *v54 - p_position->x;
      v71.y = *(float *)&v6.pPlanet[1].name[3] - pShip->position.y;
      v71.z = *(float *)&v6.pPlanet[1].name[7] - pShip->position.z;
      v99 = v71;
      v15 = sqrt(v71.y * v71.y + v71.x * v71.x + v71.z * v71.z);
      v125 = 0x20 * v5->special1;
      v16 = v15 - (double)v125;
      v116 = v16;
      if ( v16 < 64.0 )
      {
        v116 = 64.0;
      }
      Q_Vector3D_SetLength_sub_53054(&v99, v116);
      v86 = 0.0;
      v87 = 0.0;
      v88 = 0.0;
      v111 = &v89;
      v86 = pShip->position.x + v99.x;
      v87 = pShip->position.y + v99.y;
      z = pShip->position.z;
      v89 = v86;
      v88 = z + v99.z;
      v90 = v87;
      v91 = v88;
      *(float *)((char *)&v6.pPlanet[1].z5 + 1) = v86;
      *(float *)&v6.pPlanet[1].name[3] = v90;
      *(float *)&v6.pPlanet[1].name[7] = v91;
      return v118;
    }
    if ( (unsigned __int8)v53 > 0x36u )
    {
      if ( (unsigned __int8)v53 <= 0x37u )
      {
        x = p_position->x;
        y = pShip->position.y;
        v102 = pShip->position.z;
        p_position->x = *v54;
        pShip->position.y = *(float *)&v6.pPlanet[1].name[3];
        pShip->position.z = *(float *)&v6.pPlanet[1].name[7];
        *v54 = x;
        *(float *)&v6.pPlanet[1].name[3] = y;
        *(float *)&v6.pPlanet[1].name[7] = v102;
        return v118;
      }
      if ( v53 != 0x3B )
      {
        return v118;
      }
      special1 = *(_DWORD *)((char *)&v6.pPlanet[1].freeSurfaceSquaresNum + 1) - *(unsigned int *)((char *)&v6.pPlanet[1].pSquares + 1);
      if ( special1 > v5->special1 )
      {
        special1 = v5->special1;
      }
      *(P_Square *)((char *)&v6.pPlanet[1].pSquares + 1) = (P_Square)(*(char **)((char *)&v6.pPlanet[1].pSquares + 1) + special1);
      v27 = pShip->hullIntegrity - special1;
      pShip->hullIntegrity = v27;
      if ( v27 < 1 )
      {
        Q_Ship_RemoveFromTheGame_sub_49940(pShip);
        return v118;
      }
      return v118;
    }
    goto LABEL_74;
  }
  if ( (unsigned __int8)v53 <= 0x3Du )
  {
    Q_Ship_RemoveFromTheGame_sub_49940(v6.pShip);
    v48 = v118 | 4;
    Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - pShip->hullCells);
    LOBYTE(v118) = v48;
    return v118;
  }
  if ( (unsigned __int8)v53 < 0x42u )
  {
    if ( v53 != 0x40 )
    {
      return v118;
    }
    v38 = *(int *)((char *)&v6.pPlanet[2].dayColonized + 1);
    if ( !v38 )
    {
      return v118;
    }
    if ( *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2) <= 0 )
    {
      return v118;
    }
    v39 = 0;
    v57 = 0;
    do
    {
      if ( v6.pPlanet[1].name[7 * v57 + 0xC] != (char)0xFF )
      {
        if ( v39 == V_Game.day % v38 )
        {
          Q_Ship_RemoveGizmoFromCell_sub_492F8(v6.pShip, v57);
          return v118;
        }
        ++v39;
      }
      ++v57;
    }
    while ( v57 < *(int *)((char *)&v6.pPlanet[2].Unknown_62 + 2) );
    return v118;
  }
  if ( (unsigned __int8)v53 <= 0x42u )
  {
    goto LABEL_84;
  }
  if ( (unsigned __int8)v53 < 0x44u )
  {
    return v118;
  }
  if ( (unsigned __int8)v53 > 0x44u )
  {
    if ( v53 != 0x4A )
    {
      return v118;
    }
    v18 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, v63);
    if ( v18 > 0 )
    {
      v120 = 4 * v18;
      v20 = v18;
      for ( k = 0; k < v20; ++k )
      {
        v21 = v63[k];
        if ( v6.pShip != v21 )
        {
          v106 = &v80;
          memset(&v95, 0, sizeof(v95));
          v95.x = v21->position.x - *(float *)((char *)&v6.pPlanet[1].z5 + 1);
          v95.y = v21->position.y - *(float *)&v6.pPlanet[1].name[3];
          v95.z = v21->position.z - *(float *)&v6.pPlanet[1].name[7];
          v80 = v95;
          v22 = sqrt(v95.y * v95.y + v95.x * v95.x + v95.z * v95.z);
          v125 = 0x20 * v5->special2;
          v122 = v22;
          v123 = (float)v125;
          if ( v122 > (double)v123 )
          {
            v125 = 0x20 * v5->special1;
            v23 = v122 - (double)v125;
            v124 = v23;
            if ( v23 < v123 )
            {
              v124 = v123;
            }
            Q_Vector3D_SetLength_sub_53054(&v80, v124);
            v108 = &v65;
            v77 = 0.0;
            v78 = 0.0;
            v79 = 0.0;
            v77 = *(float *)((char *)&v6.pPlanet[1].z5 + 1) + v80.x;
            v78 = *(float *)&v6.pPlanet[1].name[3] + v80.y;
            v24 = *(float *)&v6.pPlanet[1].name[7];
            v65 = v77;
            v79 = v24 + v80.z;
            v66 = v78;
            v25 = v63[k];
            v67 = v79;
            v25->position.x = v77;
            v25->position.y = v66;
            v25->position.z = v67;
          }
        }
      }
    }
    return v118;
  }
  v28 = *(_DWORD *)&v6.pPlanet->surfaceSquaresNum - *(_DWORD *)((char *)&v6.pPlanet[1].starIndex + 1);
  if ( v28 > v52 )
  {
    v28 = v52;
  }
  *(_DWORD *)((char *)&v6.pPlanet[1].starIndex + 1) += v28;
  pShip->availablePower -= v28;
  return v118;
}
// 4B944: using guessed type P_Ship var_520[107];

//----- (0004C7FC) --------------------------------------------------------
// Function: Ship_ActivateGizmoOnPlanet
// Purpose: Handles the activation of a ship's gizmo (special ability/weapon) targeting a planet.
// Returns: TRUE (1) if activation was successful, FALSE (0) otherwise.
int __fastcall Q_Ship_ActivatePlanetGizmo_sub_4C7FC(P_Ship pShip, int bShouldConsumePower)
{
  signed __int8 gizmoIndex; // cl
  T_Gizmo *pGizmo; // esi
  MACRO_VFX_BOOL bInAreaOfEffect; // edi
  int availablePower; // ebp
  int gizmoPowerCost; // eax
  P_Planet pPlanet; // ebp
  P_Ship pShip__; // edx
  double distance_; // st7
  WORD specialEffects; // ax
  BOOL bCanActivateGizmo; // eax
  P_Square pSquares; // kr00_4
  int i; // edi
  float x; // [esp+8h] [ebp-60h]
  float y; // [esp+Ch] [ebp-5Ch]
  float z; // [esp+10h] [ebp-58h]
  T_Vector3D v18; // [esp+14h] [ebp-54h] BYREF
  T_Vector3D v19; // [esp+20h] [ebp-48h] BYREF
  T_Vector3D *v20; // [esp+2Ch] [ebp-3Ch]
  int gizmoBaseRange; // [esp+30h] [ebp-38h]
  int bShouldConsumePower_; // [esp+34h] [ebp-34h]
  float distance; // [esp+38h] [ebp-30h]
  int powerToConsume; // [esp+3Ch] [ebp-2Ch]
  MACRO_VFX_BOOL bHasEnoughPower; // [esp+40h] [ebp-28h]
  float gizmoEffectiveRange; // [esp+44h] [ebp-24h]
  int bActivationResult; // [esp+48h] [ebp-20h]
  P_Ship pShip_; // [esp+4Ch] [ebp-1Ch]
  int clearedSquaresCount; // [esp+50h] [ebp-18h]

  pShip_ = pShip;
  bShouldConsumePower_ = bShouldConsumePower;
  gizmoIndex = pShip->pCurHullCell->gizmoIndex;
  bActivationResult = 0;
  powerToConsume = 0;
  pGizmo = &V_Gizmos[gizmoIndex];
  bInAreaOfEffect = TRUE;
  availablePower = pShip->availablePower;
  gizmoPowerCost = pGizmo->power;
  bHasEnoughPower = TRUE;
  if ( gizmoPowerCost > availablePower )
  {
    bHasEnoughPower = FALSE;
  }
  else
  {
    powerToConsume = gizmoPowerCost;
  }
  pPlanet = pShip_->_target.pObject.pPlanet;
  if ( !pPlanet )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x217);
  }
  x = pPlanet->position.x;
  y = pPlanet->position.y;
  pShip__ = pShip_;
  z = pPlanet->position.z;
  pShip_->Unknown_78.x = pPlanet->position.x;
  pShip__->Unknown_78.y = y;
  pShip__->Unknown_78.z = z;
  if ( pGizmo->range )
  {
    v20 = &v18;
    memset(&v19, 0, sizeof(v19));
    v19.x = x - pShip_->position.x;
    v19.y = y - pShip_->position.y;
    v19.z = z - pShip_->position.z;
    v18 = v19;
    distance_ = sqrt(v19.y * v19.y + v19.x * v19.x + v19.z * v19.z);
    gizmoBaseRange = 32 * pGizmo->range;
    specialEffects = pShip_->specialEffects;
    distance = distance_;
    gizmoEffectiveRange = (float)gizmoBaseRange;
    if ( (specialEffects & ASCEND_EFFECT_WEAPONS_INCREASED_RANGE) != 0 )
    {
      gizmoEffectiveRange = gizmoEffectiveRange * 2.0;
    }
    if ( distance > (double)gizmoEffectiveRange )
    {
      bInAreaOfEffect = FALSE;
    }
    if ( gizmoIndex == ASCEND_GIZMO_47_MYRMIDONIC_CARBONIZER && gizmoEffectiveRange * 0.75 > distance )
    {
      bInAreaOfEffect = FALSE;
    }
  }
  bCanActivateGizmo = bHasEnoughPower && bInAreaOfEffect && (pGizmo->flags & 0xC) != 0;
  bActivationResult |= bCanActivateGizmo;
  // If activation failed or we're just testing (not consuming power), return the result
  if ( (bActivationResult & 1) == 0 || bShouldConsumePower_ != 1 )
  {
    return bActivationResult;
  }
  pShip_->availablePower -= powerToConsume;
  if ( !pGizmo->cat )
  {
    // ASCEND_GIZMO_CAT_WEAPON
    sub_36A5C(pPlanet, pGizmo->weaponDamage, pShip_->raceIndex);
    return bActivationResult;
  }
  if ( gizmoIndex != ASCEND_GIZMO_70_PHASE_BOMB )
  {
    return bActivationResult;
  }
  // 70. Phase Bomb
  // The %s is launched at a planet and destroys structures on the
  // planet's surface.  It can be used only once and must be launched at
  // short range.
  pSquares = pPlanet->pSquares;
  clearedSquaresCount = 0;
  for ( i = 0; i < pPlanet->surfaceSquaresNum && clearedSquaresCount < 5; ++i )
  {
    if ( pSquares[i].color != 0xFF
      && (pSquares[i].flags & ASCEND_SQUARE_FLAGS_COMPLETE) != 0
      && !V_PlanetItems.item[pSquares[i].planetItemIndex].mpop
      && Q_Planet_HandleItemConstruction_sub_34B0C(pPlanet, i, 0xFFu, 1u) == 0xFFFFFFFF )
    {
      ++clearedSquaresCount;
    }
  }
  Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip_, pShip_->pCurHullCell - pShip_->hullCells);
  return bActivationResult;
}

//----- (0004CAB8) --------------------------------------------------------
int __fastcall Q_Ship_ActivateLaneGizmo_sub_4CAB8(P_Ship pShip, int a2)
{
  signed __int8 gizmoIndex; // cl
  T_Gizmo *pGizmo; // ebp
  int availablePower; // edx
  int requiredPower; // eax
  P_Lane pTargetLane; // esi
  double distanceToLane; // st7
  int gizmoRange; // eax
  BOOL canActivate; // eax
  P_Star oppositeStar; // eax
  P_Star pStar2; // edx
  P_Star pStar1; // eax
  int shipsProcessed; // edx
  T_Star *destinationStar; // ecx
  int i; // ebx
  T_Vector3D v18; // [esp+8h] [ebp-78h] BYREF
  T_Vector3D v19; // [esp+14h] [ebp-6Ch] BYREF
  T_Vector3D laneDirection; // [esp+20h] [ebp-60h] BYREF
  T_Vector3D directionToLane; // [esp+2Ch] [ebp-54h] BYREF
  T_Vector3D laneVector; // [esp+38h] [ebp-48h]
  T_Vector3D *v23; // [esp+44h] [ebp-3Ch]
  int v24; // [esp+48h] [ebp-38h]
  T_Vector3D *v25; // [esp+4Ch] [ebp-34h]
  float v26; // [esp+50h] [ebp-30h]
  int v27; // [esp+54h] [ebp-2Ch]
  int powerCost; // [esp+58h] [ebp-28h]
  MACRO_VFX_BOOL v29; // [esp+5Ch] [ebp-24h]
  MACRO_VFX_BOOL v30; // [esp+60h] [ebp-20h]
  int v31; // [esp+64h] [ebp-1Ch]
  float laneLength; // [esp+68h] [ebp-18h]

  v27 = a2;
  gizmoIndex = pShip->pCurHullCell->gizmoIndex;
  v31 = 0;
  v30 = TRUE;
  pGizmo = &V_Gizmos[gizmoIndex];
  powerCost = 0;
  availablePower = pShip->availablePower;
  requiredPower = pGizmo->power;
  v29 = TRUE;
  if ( requiredPower > availablePower )
  {
    v29 = FALSE;
  }
  else
  {
    powerCost = requiredPower;
  }
  pTargetLane = pShip->_target.pObject.pLane;
  if ( !pTargetLane )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x275);
  }
  laneVector = pTargetLane->vector2;
  if ( pTargetLane->pStar1 == pShip->pLocation.pStar )
  {
    laneVector = pTargetLane->vector1;
  }
  pShip->Unknown_78 = laneVector;
  memset(&directionToLane, 0, sizeof(directionToLane));
  v23 = &v18;
  directionToLane.x = laneVector.x - pShip->position.x;
  directionToLane.y = laneVector.y - pShip->position.y;
  directionToLane.z = laneVector.z - pShip->position.z;
  v18 = directionToLane;
  distanceToLane = sqrt(directionToLane.y * directionToLane.y + directionToLane.x * directionToLane.x + directionToLane.z
                                                                                                      * directionToLane.z);
  gizmoRange = pGizmo->range;
  v26 = distanceToLane;
  if ( gizmoRange )
  {
    v24 = 32 * gizmoRange;
    if ( (double)(32 * gizmoRange) < v26 )
    {
      v30 = FALSE;
    }
  }
  canActivate = v29 && v30 && (pGizmo->flags & ASCEND_GZ_TARGETLANE) != 0;
  v31 |= canActivate;
  if ( v27 != 1 || (v31 & 1) == 0 )
  {
    return v31;
  }
  pShip->availablePower -= powerCost;
  if ( !pGizmo->cat && pGizmo->weaponDamage > 1 )
  {
    pTargetLane->flags &= ~2u;
    return v31;
  }
  if ( (unsigned __int8)gizmoIndex < (unsigned int)ASCEND_GIZMO_51_LANE_DESTABILIZER )
  {
    if ( gizmoIndex == ASCEND_GIZMO_32_LANE_BLOCKER )
    {
      // 32. Lane Blocker
      // The %s is fired into a star lane opening where it sits, elevating the
      // inherent gravitational turbulence of the opening to the point where
      // Star Lane Drives and Star Lane Hyperdrives can no longer overcome it.
      pTargetLane->flags |= ASCEND_LANE_FLAGS_2_BLOCKED;
      return v31;
    }
    return v31;
  }
  if ( (unsigned __int8)gizmoIndex <= (unsigned int)ASCEND_GIZMO_51_LANE_DESTABILIZER )
  {
    // 51. Lane Destabilizer
    // When fired at a star lane or red link opening, the %s induces gravity
    // waves at the resonant frequency of the star lane.  This causes the
    // ships inside the star lane to be thrown quickly toward their destination
    // point.  The Lane Destabilizer itself is destroyed in the process.
    pStar2 = pTargetLane->pStar2;
    pStar1 = pTargetLane->pStar1;
    v25 = &v19;
    memset(&laneDirection, 0, sizeof(laneDirection));
    laneDirection.x = pStar1->pos.x - pStar2->pos.x;
    laneDirection.y = pStar1->pos.y - pStar2->pos.y;
    laneDirection.z = pStar1->pos.z - pStar2->pos.z;
    v19 = laneDirection;
    shipsProcessed = 0;
    laneLength = sqrt(laneDirection.y * laneDirection.y + laneDirection.x * laneDirection.x + laneDirection.z * laneDirection.z);
    for ( i = 0; i < 107; ++i )
    {
      if ( shipsProcessed >= V_Game.shipsNum )
      {
        break;
      }
      if ( V_Game.ships[i].raceIndex != 0xFFFFFFFF )
      {
        if ( V_Game.ships[i].locationType == ASCEND_LOCATION_TYPE_STARLANE && pTargetLane == V_Game.ships[i].pLocation.pLane )
        {
          V_Game.ships[i].position.x = laneLength;
        }
        ++shipsProcessed;
      }
    }
    goto REMOVE_GIZMO_AND_EXIT;
  }
  if ( (unsigned __int8)gizmoIndex < (unsigned int)ASCEND_GIZMO_60_LANE_MAGNETRON )
  {
    return v31;
  }
  if ( (unsigned __int8)gizmoIndex <= (unsigned int)ASCEND_GIZMO_60_LANE_MAGNETRON )
  {
    // 60. Lane Magnetron
    // The %s frees the ship using it from the gravitational turbulence-induced drag
    // normally encountered in star lane space, allowing the ship to slip through the
    // star lane almost instantly.  The Lane Magnetron uses fully as much power as a
    // Nanotwirler produces and can be used only once.
    destinationStar = pTargetLane->pStar1;
    if ( pTargetLane->pStar1 == pShip->pLocation.pStar )
    {
      destinationStar = pTargetLane->pStar2;
    }
    Q_HandleShipDeparture_sub_1D538(pShip->pLocation, pShip);
    pShip->locationType = ASCEND_LOCATION_TYPE_STARLANE;
    pShip->pLocation.pLane = pTargetLane;
    Q_Star_HandleShipArrival_sub_1D3E8(destinationStar, pShip, 0);
REMOVE_GIZMO_AND_EXIT:
    Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - pShip->hullCells);
    return v31;
  }
  if ( gizmoIndex != ASCEND_GIZMO_62_LANE_ENDOSCOPE )
  {
    return v31;
  }
  // 62. Lane Endoscope
  // The %s allows astronomical instruments to penetrate star lane space and scan
  // the system at the other end of a star lane or red link opening.  It requires a
  // lot of power to use.
  oppositeStar = pTargetLane->pStar1;
  if ( pTargetLane->pStar1 == pShip->pLocation.pStar )
  {
    oppositeStar = pTargetLane->pStar2;
  }
  oppositeStar->exploredBits |= 1 << LOBYTE(pShip->raceIndex);
  return v31;
}

//----- (0004CDF8) --------------------------------------------------------
int __fastcall Q_Ship_ActivateNoTargetGizmo_sub_4CDF8(P_Ship pShip, int a2)
{
  int powerCost; // ebp
  UBYTE gizmoIndex; // cl
  T_Gizmo *pGizmo; // edi
  double v7; // st7
  int shipsCount56; // eax
  int shipsCount56_; // kr08_4
  int j; // kr04_4
  P_Ship pTargetShip56; // eax
  double v12; // st7
  double v13; // st7
  int v14; // edi
  int Unknown_98; // ebp
  T_Star *homeStar; // eax
  int targetCount; // eax
  int k; // kr10_4
  int targetCount_; // kr14_4
  P_Ship pBlastTargetShip; // edx
  double distance; // st7
  P_HullCell pCurrHullCell; // edx
  int hullIntegrity; // ecx
  signed __int8 v24; // bh
  int v25; // ebx
  int shipsCount38; // eax
  int shipsCount38_; // kr28_4
  P_Ship pTargetShip; // eax
  int atackerRaceIndex; // ecx
  int targetRaceIndex; // edx
  int v31; // ebp
  int shipsCount39; // eax
  T_Vector3D *p_position; // edx
  int shipsCount39_; // kr34_4
  P_Ship pTargetShip39; // ecx
  double distance_; // st7
  double z; // st7
  P_Ship v38; // ecx
  int driveHullCell; // eax
  T_HullCell *pShipHullCells; // eax
  int v41; // edx
  P_Ship shipsArray39[107]; // [esp+8h] [ebp-770h] BYREF
  P_Ship shipsArray38[107]; // [esp+1B4h] [ebp-5C4h] BYREF
  P_Ship shipsArray56[107]; // [esp+360h] [ebp-418h] BYREF
  P_Ship blastTargetShips[107]; // [esp+50Ch] [ebp-26Ch] BYREF
  T_Vector3D v46; // [esp+6B8h] [ebp-C0h] BYREF
  T_Vector3D v47; // [esp+6C4h] [ebp-B4h] BYREF
  float x; // [esp+6D0h] [ebp-A8h] BYREF
  float y; // [esp+6D4h] [ebp-A4h]
  float v50; // [esp+6D8h] [ebp-A0h]
  T_Vector3D v51; // [esp+6DCh] [ebp-9Ch] BYREF
  T_Vector3D v52; // [esp+6E8h] [ebp-90h] BYREF
  T_Vector3D v53; // [esp+6F4h] [ebp-84h] BYREF
  T_Vector3D v54; // [esp+700h] [ebp-78h] BYREF
  T_Vector3D v55; // [esp+70Ch] [ebp-6Ch] BYREF
  float *v56; // [esp+718h] [ebp-60h]
  T_Vector3D *v57; // [esp+71Ch] [ebp-5Ch]
  T_Vector3D *v58; // [esp+720h] [ebp-58h]
  T_Vector3D *v59; // [esp+728h] [ebp-50h]
  MACRO_VFX_BOOL activationSuccess; // [esp+730h] [ebp-48h]
  int statusFlags; // [esp+734h] [ebp-44h]
  int v62; // [esp+738h] [ebp-40h]
  int v63; // [esp+73Ch] [ebp-3Ch]
  int v64; // [esp+740h] [ebp-38h]
  int activationMode; // [esp+744h] [ebp-34h]
  int i; // [esp+748h] [ebp-30h]
  float effectRange_; // [esp+74Ch] [ebp-2Ch]
  float v68; // [esp+750h] [ebp-28h]
  T_Vector3D *epicenter; // [esp+754h] [ebp-24h]
  float gravimetricCondensorRange; // [esp+758h] [ebp-20h]
  float v71; // [esp+75Ch] [ebp-1Ch]
  int effectRange; // [esp+760h] [ebp-18h]

  activationMode = a2;
  gizmoIndex = pShip->pCurHullCell->gizmoIndex;
  activationSuccess = TRUE;
  if ( gizmoIndex == 0xFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipgiz.cpp", 0x2EA);
  }
  statusFlags = 0;
  powerCost = 0;
  pGizmo = &V_Gizmos[(char)gizmoIndex];
  if ( pGizmo->power > pShip->availablePower )
  {
    activationSuccess = FALSE;
  }
  else
  {
    powerCost = pGizmo->power;
  }
  statusFlags |= activationSuccess != FALSE;
  if ( (statusFlags & 1) == 0 )
  {
    return statusFlags;
  }
  if ( activationMode != 1 )
  {
    return statusFlags;
  }
  pShip->availablePower -= powerCost;
  if ( gizmoIndex < 0x39u )
  {
    if ( gizmoIndex < 0x27u )
    {
      if ( gizmoIndex >= 0x24u )
      {
        if ( gizmoIndex <= 0x24u )
        {
          // 36. Recaller
          // The %s creates an unstable shunt through star lane space to a ship's home
          // system.  The ship using the Recaller moves instantly into the shunt
          // and arrives immediately at its home system.
          Q_HandleShipDeparture_sub_1D538(pShip->pLocation, pShip);
          homeStar = V_Game.races[pShip->raceIndex]._homeStar;
          pShip->pLocation.pStar = homeStar;
          Q_Star_HandleShipArrival_sub_1D3E8(homeStar, pShip, 0);
          return statusFlags;
        }
        if ( gizmoIndex == ASCEND_GIZMO_38_SMART_BOMB )
        {
          // 38. Smart Bomb
          // The %s uses advanced empathic biosensor technology to determine the
          // relationships between the ship using it and the other ships
          // present in the star system.  Once activated, it fires in multiple directions
          // at every ship it has determined to be hostile, doing heavy damage comparable
          // to that of an Ueberlaser.  One use expends it.
          shipsCount38 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsArray38);
          if ( shipsCount38 > 0 )
          {
            v63 = 4 * shipsCount38;
            shipsCount38_ = shipsCount38;
            for ( i = 0; i < shipsCount38_; ++i )
            {
              pTargetShip = shipsArray38[i];
              atackerRaceIndex = pShip->raceIndex;
              targetRaceIndex = pTargetShip->raceIndex;
              // Damage only enemies
              if ( targetRaceIndex != atackerRaceIndex && V_Game.races[atackerRaceIndex].treaties[targetRaceIndex] == ASCEND_TREATY_WAR )
              {
                Q_Ship_ApplyDamage_sub_4B7A0(pTargetShip, activationMode, pGizmo->special1, atackerRaceIndex);
              }
            }
          }
          Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - pShip->hullCells);
          return statusFlags;
        }
      }
    }
    else if ( gizmoIndex <= 0x27u )
    {
      // 39. Gravity Distorter
      // The %s creates a gravitational wave front that
      // emanates from the ship using the device.  This pushes small objects, such as
      // space vessels, away from the ship that used the Distorter.
      shipsCount39 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsArray39);
      if ( shipsCount39 > 0 )
      {
        v31 = 0;
        p_position = &pShip->position;
        v64 = 4 * shipsCount39;
        shipsCount39_ = shipsCount39;
        do
        {
          pTargetShip39 = shipsArray39[v31];
          if ( pShip != pTargetShip39 )
          {
            v59 = &v51;
            memset(&v46, 0, sizeof(v46));
            v46.x = pTargetShip39->position.x - p_position->x;
            v46.y = pTargetShip39->position.y - pShip->position.y;
            v46.z = pTargetShip39->position.z - pShip->position.z;
            v51 = v46;
            distance_ = sqrt(v46.y * v46.y + v46.x * v46.x + v46.z * v46.z);
            effectRange = 0x20 * pGizmo->special1;
            effectRange_ = (float)effectRange;
            if ( distance_ < effectRange_ )
            {
              Q_Vector3D_SetLength_sub_53054(&v51, effectRange_);
              memset(&v52, 0, sizeof(v52));
              v56 = &x;
              v52.x = p_position->x + v51.x;
              v52.y = pShip->position.y + v51.y;
              z = pShip->position.z;
              x = v52.x;
              v52.z = z + v51.z;
              y = v52.y;
              v38 = shipsArray39[v31];
              v50 = v52.z;
              v38->position.x = v52.x;
              v38->position.y = y;
              v38->position.z = v50;
            }
          }
          ++v31;
        }
        while ( v31 < shipsCount39_ );
      }
    }
    else
    {
      if ( gizmoIndex < 53u )
      {
        if ( gizmoIndex == ASCEND_GIZMO_46_GRAVIMETRIC_CATAPULT )
        {
          // 46. Gravimetric Catapult
          // The %s causes the ship using it to experience temporarily exaggerated
          // gravitational force.  The ship is pulled toward the strongest gravity well in
          // the vicinity--the nearest sun.  The ship whips past the sun, stopping
          // opposite its previous position when it has run out of momentum.
          v57 = &v47;
          memset(&v55, 0, sizeof(v55));
          v55.x = -pShip->position.x;
          v55.y = -pShip->position.y;
          v7 = -pShip->position.z;
          v47 = v55;
          v55.z = v7;
          pShip->position.x = v55.x;
          pShip->position.y = v47.y;
          pShip->position.z = v47.z;
        }
        return statusFlags;
      }
      if ( gizmoIndex <= 53u )
      {
        // 53. Cannibalizer
        // The Cannibalizer is an emergency device that allows a ship to convert some of the mass
        // of its own hull into an energy reserve.  This is destructive to the
        // ship, so it is usually used only in a last ditch effort to survive.
        pShip->hullIntegrity -= pGizmo->special1;
        hullIntegrity = pShip->hullIntegrity;
        pShip->availablePower += pGizmo->special2;
        if ( hullIntegrity < 1 )
        {
          goto DESTROY_SHIP;
        }
      }
      else
      {
        if ( gizmoIndex != ASCEND_GIZMO_56_GRAVIMETRIC_CONDENSOR )
        {
          return statusFlags;
        }
        // 56. Gravimetric Condensor
        // The Gravimetric Condensor momentarily increases the gravitational field strength of a star,
        // causing all the ships in the system to be pulled toward the star with
        // great force. 
        shipsCount56 = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, shipsArray56);
        if ( shipsCount56 > 0 )
        {
          shipsCount56_ = shipsCount56;
          for ( j = 0; j < shipsCount56_; ++j )
          {
            pTargetShip56 = shipsArray56[j];
            if ( pTargetShip56->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
            {
              v12 = sqrt(
                      pTargetShip56->position.y * pTargetShip56->position.y
                    + pTargetShip56->position.x * pTargetShip56->position.x
                    + pTargetShip56->position.z * pTargetShip56->position.z);
              effectRange = 0x20 * pGizmo->special2;
              v68 = v12;
              gravimetricCondensorRange = (float)effectRange;
              if ( v68 > (double)gravimetricCondensorRange )
              {
                effectRange = 0x20 * pGizmo->special1;
                v13 = v68 - (double)effectRange;
                v71 = v13;
                if ( v13 < gravimetricCondensorRange )
                {
                  v71 = gravimetricCondensorRange;
                }
                Q_Vector3D_SetLength_sub_53054(&shipsArray56[j]->position, v71);
              }
            }
          }
        }
      }
    }
    return statusFlags;
  }
  if ( gizmoIndex <= 0x39u )
  {
    // 57. Accutron
    // The %s is a massive space analysis and targeting system that
    // increases the effective range of all the weapons on a ship.  It is fairly costly
    // to build, but can provide a strong advantage in battle.
    LOBYTE(pShip->specialEffects) |= ASCEND_EFFECT_WEAPONS_INCREASED_RANGE;
    return statusFlags;
  }
  if ( gizmoIndex < 0x41u )
  {
    if ( gizmoIndex <= 0x3Au )
    {
      // 58. Remote Repair Facility
      // The %s allows a ship to repair damage without having to enter
      // Orbital Docks.  It consists of automated systems spreading throughout the
      // ship, engineered so finely that the repair process resembles organic healing. 
      // It uses a lot of power when activated, and adding it to a ship is an
      // expensive project.
      v14 = pGizmo->special1 + pShip->hullIntegrity;
      Unknown_98 = pShip->Unknown_98;
      pShip->hullIntegrity = v14;
      if ( v14 > Unknown_98 )
      {
        pShip->hullIntegrity = Unknown_98;
        return statusFlags;
      }
    }
    else
    {
      if ( gizmoIndex != ASCEND_GIZMO_63_TOROIDAL_BLASTER )
      {
        return statusFlags;
      }
      // 63. Toroidal Blaster
      // The %s gives the ship using it a huge boost in engine performance,
      // but it is hard on the engines and usually damages some of them.  It
      // draws all the power it needs from the engines and needs no generator
      // power.
      driveHullCell = Q_Ship_FindFirstCellWithCat_sub_49328(pShip, ASCEND_GIZMO_CAT_DRIVE);
      if ( driveHullCell != 0xFFFFFFFF )
      {
        Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, driveHullCell);
        LOBYTE(pShip->specialEffects) |= ASCEND_EFFECT_ENGINES_BOOST;
        return statusFlags;
      }
    }
    return statusFlags;
  }
  pShipHullCells = pShip->hullCells;
  if ( gizmoIndex <= 0x41u )
  {
    // 65. Replenisher
    // The %s fully recharges all of the weapons aboard a ship.
    // Its installation is involved and expensive, but it can be a lifesaver in
    // an intense battle.
    if ( pShip->hullCellsNum > 0 )
    {
      v41 = 0;
      do
      {
        v24 = pShipHullCells[v41].gizmoIndex;
        if ( v24 != (signed __int8)0xFF && v24 != ASCEND_GIZMO_65_REPLENISHER )
        {
          v25 = v24;
          if ( V_Gizmos[v25].numUses )
          {
            pShipHullCells[v41]._usesPerTurnLeft = V_Gizmos[v25].numUses;
          }
        }
        ++v41;
      }
      while ( v41 < pShip->hullCellsNum );
    }
    return statusFlags;
  }
  if ( gizmoIndex >= 0x48u )
  {
    if ( gizmoIndex > 0x48u )
    {
      if ( gizmoIndex == ASCEND_GIZMO_75_HYPERFUEL )
      {
        // 75. Hyperfuel
        // %s is a one-time-use power reserve of great capacity.  It is a cheap,
        // disposable source of power.
        pCurrHullCell = pShip->pCurHullCell;
        pShip->availablePower += pGizmo->special1;
        Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pCurrHullCell - pShipHullCells);
      }
      return statusFlags;
    }
    // 72. Self Destructotron
    // The %s is a desperation device.  It destroys the ship using it by
    // converting most of the ship's mass to energy, creating a huge explosion that
    // greatly damages other ships nearby.
    targetCount = Q_FindShipsAtLocation_sub_1D794(pShip->pLocation, blastTargetShips);
    if ( targetCount > 0 )
    {
      epicenter = &pShip->position;
      v62 = 4 * targetCount;
      targetCount_ = targetCount;
      for ( k = 0; k < targetCount_; ++k )
      {
        pBlastTargetShip = blastTargetShips[k];
        if ( pShip != pBlastTargetShip )
        {
          memset(&v53, 0, sizeof(v53));
          v58 = &v54;
          v53.x = pBlastTargetShip->position.x - epicenter->x;
          v53.y = pBlastTargetShip->position.y - epicenter->y;
          v53.z = pBlastTargetShip->position.z - epicenter->z;
          v54 = v53;
          distance = sqrt(v53.y * v53.y + v53.x * v53.x + v53.z * v53.z);
          effectRange = 0x20 * pGizmo->range;
          if ( (double)effectRange >= distance )
          {
            Q_Ship_ApplyDamage_sub_4B7A0(blastTargetShips[k], activationMode, pGizmo->special1, pShip->raceIndex);
          }
        }
      }
    }
DESTROY_SHIP:
    Q_Ship_RemoveFromTheGame_sub_49940(pShip);
    return statusFlags;
  }
  if ( gizmoIndex == ASCEND_GIZMO_69_INVULNERABLIZER )
  {
    // 69. Invulnerablizer
    // The %s sets up a temporary high-magitechnology shield around the
    // ship using it.  While it lasts, the shield will not allow the
    // ship to come to harm.  It consumes little power but it is costly to
    // build and can be used only once.
    LOBYTE(pShip->specialEffects) |= ASCEND_EFFECT_INVULNERABLE;
    Q_Ship_RemoveGizmoFromCell_sub_492F8(pShip, pShip->pCurHullCell - pShipHullCells);
  }
  return statusFlags;
}

//----- (0004D700) --------------------------------------------------------
void sub_4D700()
{
  _wcpp_2_mod_register_(&dword_96AC0);
  Q_ShipCtor_sub_48B90(&stru_108FE8);
  dword_96AC8 = 1;
}
// 96AC0: using guessed type _DWORD dword_96AC0;
// 96AC8: using guessed type int dword_96AC8;

//----- (0004D724) --------------------------------------------------------
int __fastcall sub_4D724(T_Type5 *a1, int a2, LONG a3, int a4)
{
  void *ShapeTable_sub_1B084; // eax
  T_Rect *p_rect; // esi

  if ( a4 )
  {
    VFX_pane_wipe((PANE *)a1, 0x96);
  }
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x1C]);
  if ( !ShapeTable_sub_1B084 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x34);
  }
  VFX_shape_draw((PANE *)a1, ShapeTable_sub_1B084, a3, 0x3F, 0x2D);
  WinMgr.SmallFont.pane.window = &a1->a->window;
  p_rect = &a1->rect;
  WinMgr.SmallFont.pane.x0 = p_rect->x1;
  p_rect = (T_Rect *)((char *)p_rect + 4);
  WinMgr.SmallFont.pane.y0 = p_rect->x1;
  p_rect = (T_Rect *)((char *)p_rect + 4);
  WinMgr.SmallFont.pane.x1 = p_rect->x1;
  WinMgr.SmallFont.pane.y1 = p_rect->y1;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x3F, 2, V_Gizmos[a3].name, 8, 0xFFFF, 0xFF, 0x7A);
}

//----- (0004D7A8) --------------------------------------------------------
unsigned int __fastcall sub_4D7A8(int a1, int a2, int a3)
{
  unsigned int v3; // ebx
  __int64 v4; // rtt
  int i; // edi
  char v6; // al
  int j; // edx
  char v8; // al
  int v9; // edx
  int v12; // [esp+4h] [ebp-20h]
  int v13; // [esp+Ch] [ebp-18h]

  v3 = 0xFFFFFFFF;
  if ( a2 - 0x94 > 0 )
  {
    LODWORD(v4) = (a2 - 0x94 - (a1 - 0x16F) / 2 + 0x12) / 2;
    HIDWORD(v4) = v4;
    v13 = v4 / 0x12;
    v12 = (unsigned __int8)byte_969A8[v13];
    if ( v13 < 0xE
      && !byte_969A8[v13]
      && v12 + (unsigned __int8)byte_969B8[v13] > 0
      && ((1 << -(char)v12) & (unsigned __int8)byte_106FE0[4 * v13 + a3]) != 0 )
    {
      if ( v13 > 0 )
      {
        for ( i = 0; i < v13; ++i )
        {
          v6 = 1;
          for ( j = 0; j < (unsigned __int8)byte_969B8[i]; ++j )
          {
            if ( ((unsigned __int8)v6 & (unsigned __int8)byte_106FE0[a3]) != 0 )
            {
              ++v3;
            }
            v6 *= 2;
          }
        }
      }
      v8 = 1;
      v9 = 0;
      if ( !byte_969A8[v13] )
      {
        do
        {
          if ( ((unsigned __int8)v8 & (unsigned __int8)byte_106FE0[4 * v13 + a3]) != 0 )
          {
            ++v3;
          }
          ++v9;
          v8 *= 2;
        }
        while ( v9 <= -v12 );
      }
    }
  }
  return v3;
}

//----- (0004D92C) --------------------------------------------------------
P_Wnd08SW __fastcall Q_Wnd8SWCtor_sub_4D92C(P_Wnd08SW a1)
{
  Q_A2Ctor_sub_2C830(&a1->a);
  Q_ShipCtor_sub_48B90(&a1->Ship);
  a1->a.pProcs = &Wnd8SW_Procs;
  a1->Unknown_B8[0] = 0xFF;
  a1->Unknown_B8[1] = 0;
  *(_DWORD *)&a1->Unknown_B8[2] = 0xFFFFFFFF;
  *(_DWORD *)&a1->Unknown_B8[6] = 0xFFFFFFFF;
  *(_DWORD *)&a1->Unknown_B8[0xA] = 0;
  a1->pShip = 0;
  a1->Unknown_C9 = 0;
  sub_4DA5C(a1);
  return a1;
}
/* Orphan comments:
Need optimization:
remove here
lea     edx, [eax-0CDh]
*/

//----- (0004DA08) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd8SWDtor_sub_4DA08(int a1, char a2, int a3, int a4)
{
  char *v6; // eax
  T_WndA2 *v8; // eax
  T_WndA2 *v9; // ebx

  if ( (a2 & 4) != 0 )
  {
    v6 = _wcpp_2_dtor_array_store_((void *)a1, &C_Wnd8SW);
    operator delete[](v6);
    return (T_WndA2 *)a1;
  }
  else
  {
    *(_DWORD *)(a1 + 0xA7) = &Wnd8SW_Procs;
    v8 = (T_WndA2 *)(Q_ShipDtor_sub_48C58() - 0xCD);
    Q_A2Dtor_sub_2C848(v8, 1);
    v9 = v8;
    if ( (a2 & 2) != 0 )
    {
      operator delete(v8);
    }
    return v9;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0004DA5C) --------------------------------------------------------
void __fastcall __spoils<> sub_4DA5C(P_Wnd08SW result)
{
  if ( dword_96ACC )
  {
    result->Unknown_B7 = 0x4C;
    dword_96ACC = 0;
  }
}
// 96ACC: using guessed type int dword_96ACC;

//----- (0004DA7C) --------------------------------------------------------
int __fastcall sub_4DA7C(P_Wnd08SW pWnd8SW, P_Ship pShip, int a3, int a4)
{
  T_Ship *p_Ship; // ebp
  int result; // eax
  P_Ship pShip_; // [esp+8h] [ebp-10h]

  sub_4DA5C(pWnd8SW);
  pWnd8SW->pShip = pShip;
  pWnd8SW->Unknown_C9 = a3;
  if ( a3 == 0xFFFFFFFF )
  {
    p_Ship = &pWnd8SW->Ship;
    pShip_ = pWnd8SW->pShip;
    pWnd8SW->Ship.totalWeaponDamage = pShip_->totalWeaponDamage;
    pWnd8SW->Ship.totalShieldStrength = pShip_->totalShieldStrength;
    pWnd8SW->Ship.totalStarLaneDrivePotential = pShip_->totalStarLaneDrivePotential;
    pWnd8SW->Ship.totalStarLaneHyperdrivePotential = pShip_->totalStarLaneHyperdrivePotential;
    pWnd8SW->Ship.totalDriveMaxDistance = pShip_->totalDriveMaxDistance;
    pWnd8SW->Ship.Unknown_14 = pShip_->Unknown_14;
    pWnd8SW->Ship.totalGeneratorPower = pShip_->totalGeneratorPower;
    pWnd8SW->Ship.totalPowerForDrives = pShip_->totalPowerForDrives;
    pWnd8SW->Ship.totalScannerRangePerTurn = pShip_->totalScannerRangePerTurn;
    pWnd8SW->Ship.cloakingLevel = pShip_->cloakingLevel;
    pWnd8SW->Ship.hasColonizer = pShip_->hasColonizer;
    pWnd8SW->Ship.Unknown_2C = pShip_->Unknown_2C;
    pWnd8SW->Ship.Unknown_30 = pShip_->Unknown_30;
    qmemcpy(pWnd8SW->Ship.name, pShip_->name, 0x29u);
    pWnd8SW->Ship.pLocation.pPlanet = pShip_->pLocation.pPlanet;
    pWnd8SW->Ship.pLocation.pPlanet = pShip_->pLocation.pPlanet;
    pWnd8SW->Ship.order = pShip_->order;
    pWnd8SW->Ship._orderTargetObject.pPlanet = pShip_->_orderTargetObject.pPlanet;
    pWnd8SW->Ship.Unknown_62 = pShip_->Unknown_62;
    pWnd8SW->Ship.pCurHullCell = pShip_->pCurHullCell;
    pWnd8SW->Ship._target = pShip_->_target;
    pWnd8SW->Ship._target.pObject.pPlanet = pShip_->_target.pObject.pPlanet;
    pWnd8SW->Ship._target.pObject.pPlanet = pShip_->_target.pObject.pPlanet;
    pWnd8SW->Ship._target.pObject.pPlanet = pShip_->_target.pObject.pPlanet;
    pWnd8SW->Ship.Unknown_6C = pShip_->Unknown_6C;
    pWnd8SW->Ship.Unknown_78 = pShip_->Unknown_78;
    pWnd8SW->Ship.Unknown_84 = pShip_->Unknown_84;
    pWnd8SW->Ship.availablePower = pShip_->availablePower;
    pWnd8SW->Ship.hullIntegrity = pShip_->hullIntegrity;
    pWnd8SW->Ship._currentShieldStrength = pShip_->_currentShieldStrength;
    pWnd8SW->Ship.availableMoves = pShip_->availableMoves;
    pWnd8SW->Ship.Unknown_98 = pShip_->Unknown_98;
    pWnd8SW->Ship.specialEffects = pShip_->specialEffects;
    pWnd8SW->Ship.position = pShip_->position;
    pWnd8SW->Ship.hullSize = pShip_->hullSize;
    _wcpp_2_assign_array_(sub_4B780);
    p_Ship->hullCellsNum = pShip_->hullCellsNum;
    p_Ship->gizmosNum = pShip_->gizmosNum;
  }
  result = a4;
  pWnd8SW->Unknown_233 = a4;
  return result;
}
// 78B30: using guessed type _DWORD __stdcall _wcpp_2_assign_array_(_DWORD);

//----- (0004DD14) --------------------------------------------------------
void __fastcall sub_4DD14(int a1)
{
  int resReq; // eax
  unsigned __int16 v3; // ax
  int v4; // edi

  sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xC5));
  if ( *(int *)(a1 + 0xB7) > 0 )
  {
    v4 = 0;
    do
    {
      if ( V_Gizmos[v4].cat == *(_BYTE *)(a1 + 0xBC) )
      {
        resReq = V_Gizmos[v4].resReq;
        if ( resReq == 0xFF || ((1 << V_PlayerRaceIndex) & V_Research.techs[resReq].knownToRace) != 0 )
        {
          v3 = Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(a1 + 0xC5), (BYTE *)a1, 0xFFFFFFFF, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xC5), v3, v4);
        }
      }
      ++v4;
    }
    while ( v4 < *(_DWORD *)(a1 + 0xB7) );
  }
}

//----- (0004DDB0) --------------------------------------------------------
unsigned int __fastcall sub_4DDB0(P_Wnd08SW a1, __int16 a2, int a3, int a4)
{
  char v5; // al
  P_Procs v6; // ebx
  LONG v7; // ebx
  unsigned int result; // eax
  T_WndA2 *Wnd_sub_56DA8; // eax
  P_Ship pShip; // ecx
  double z; // st7
  double v12; // st7
  int i; // esi
  int magic12345678; // edi
  int v15; // edx
  P_Procs v16; // ebx
  int Unknown_59; // edx
  P_Procs pProcs; // ebx

  if ( (unsigned __int16)a2 < 0x32u )
  {
    if ( (unsigned __int16)a2 >= 5u )
    {
      if ( (unsigned __int16)a2 <= 5u )
      {
        if ( a1->a.a1.Unknown_35 && a3 >= a1->a.a1.pane.x0 && a3 <= a1->a.a1.pane.x1 && a4 >= a1->a.a1.pane.y0 && a4 <= a1->a.a1.pane.y1 )
        {
          if ( a1->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          if ( dword_96AD0 >= 0 )
          {
            if ( !a1->pShip )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x1D8);
            }
            if ( Q_Ship_RemoveGizmoFromCell_sub_492F8(a1->pShip, dword_96AD0) )
            {
              Unknown_59 = (__int16)a1->a.a1.Unknown_59;
              if ( Unknown_59 != 0xFFFFFFFF )
              {
                Q_StartSample_sub_4FB90(&V_SoundSystem, Unknown_59);
              }
              *(_DWORD *)&a1->Unknown_B8[2] = 0xFFFFFFFF;
              pProcs = a1->a.pProcs;
              *(_DWORD *)a1->Unknown_D1 = 0xFFFFFFFF;
              ((void (*)(void))pProcs->proc4_draw)();
            }
          }
          return 0xFFFFFFFF;
        }
      }
      else
      {
        if ( (unsigned __int16)a2 < 7u )
        {
          if ( a1->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          sub_567BC(&WinMgr, a1->a.a1.index, 8);
          if ( a1->a.a1.Unknown_39 && a1->a.a1.Unknown_35 && (dword_96AD0 >= 0 || a1->a.a1._mouseFocus) )
          {
            dword_96AD0 = 0xFFFFFFFF;
            a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
          }
          else
          {
            dword_96AD0 = 0xFFFFFFFF;
          }
          return 0xFFFFFFFF;
        }
        if ( (unsigned __int16)a2 <= 7u )
        {
          if ( a1->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          sub_56728(&WinMgr, a1->a.a1.index, 4, 8, 0, 0);
          if ( (a1->a.a1._mouseFocus & a1->a.a1.Unknown_35 & a1->a.a1.Unknown_39) == 0xFFFFFFFF )
          {
            ((void (*)(void))a1->a.pProcs->proc5)();
          }
          return 0xFFFFFFFF;
        }
        if ( a2 != 8 )
        {
          return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
        }
        if ( a1->Unknown_233 != 0xFFFFFFFF )
        {
          if ( !a1->pShip )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x13D);
          }
          dword_96AD0 = sub_4D7A8(a3, a4, a1->pShip->hullSize);
          a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
          return 0;
        }
      }
      return 0;
    }
    if ( (unsigned __int16)a2 < 2u )
    {
      if ( a2 == 1 )
      {
        if ( a1->pShip )
        {
          sub_4DA5C(a1);
        }
        else
        {
          a1->pShip = &stru_108FE8;
        }
        *(_DWORD *)&a1->Unknown_B8[6] = 0xFFFFFFFF;
        *(_DWORD *)a1->Unknown_D1 = 0;
        Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "GIZLIST", 0);
        *(_DWORD *)&a1->Unknown_B8[0xA] = Wnd_sub_56DA8;
        if ( !Wnd_sub_56DA8 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x153);
        }
        *(_DWORD *)(*(_DWORD *)&a1->Unknown_B8[0xA] + 0xAB) = 0;
        Q_Wnd10LB_SetProc1_sub_2F1C8(*(P_Wnd10LB *)&a1->Unknown_B8[0xA], sub_4D724);
        *(_WORD *)(*(_DWORD *)&a1->Unknown_B8[0xA] + 0x8C9) = 0x40;
        sub_2E9CC(*(P_Wnd10LB *)&a1->Unknown_B8[0xA], 0);
        *(_BYTE *)(*(_DWORD *)&a1->Unknown_B8[0xA] + 0xC6) = 0xF2;
        if ( a1->Unknown_B8[0] == (char)0xFF )
        {
          sub_4E644((int)a1, 4, 0, a4);
        }
        else
        {
          sub_4DD14((int)a1);
        }
        *(_DWORD *)&a1->Unknown_B8[2] = 0xFFFFFFFF;
        a1->a.a1.Unknown_39 = 0xFFFFFFFF;
        a1->a.a1.Unknown_35 = 0xFFFFFFFF;
        a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
        sub_2D258(&a1->a, a2);
        return 0;
      }
    }
    else
    {
      if ( (unsigned __int16)a2 <= 2u )
      {
        a1->a.a1.Unknown_39 = 0;
        a1->a.a1.Unknown_35 = 0;
        pShip = a1->pShip;
        dword_96AD0 = 0xFFFFFFFF;
        if ( &stru_108FE8 != pShip )
        {
          stru_108FE8.totalWeaponDamage = pShip->totalWeaponDamage;
          stru_108FE8.totalShieldStrength = pShip->totalShieldStrength;
          stru_108FE8.totalStarLaneDrivePotential = pShip->totalStarLaneDrivePotential;
          stru_108FE8.totalStarLaneHyperdrivePotential = pShip->totalStarLaneHyperdrivePotential;
          stru_108FE8.totalDriveMaxDistance = pShip->totalDriveMaxDistance;
          stru_108FE8.Unknown_14 = pShip->Unknown_14;
          stru_108FE8.totalGeneratorPower = pShip->totalGeneratorPower;
          stru_108FE8.totalPowerForDrives = pShip->totalPowerForDrives;
          stru_108FE8.totalScannerRangePerTurn = pShip->totalScannerRangePerTurn;
          stru_108FE8.cloakingLevel = pShip->cloakingLevel;
          stru_108FE8.hasColonizer = pShip->hasColonizer;
          stru_108FE8.Unknown_2C = pShip->Unknown_2C;
          stru_108FE8.Unknown_30 = pShip->Unknown_30;
          qmemcpy(stru_108FE8.name, pShip->name, 0x1Eu);
          stru_108FE8._dayBuilt = pShip->_dayBuilt;
          stru_108FE8.raceIndex = pShip->raceIndex;
          stru_108FE8.locationType = pShip->locationType;
          stru_108FE8.pLocation.pPlanet = pShip->pLocation.pPlanet;
          stru_108FE8.pLocation.pPlanet = pShip->pLocation.pPlanet;
          stru_108FE8.pLocation.pPlanet = pShip->pLocation.pPlanet;
          stru_108FE8.order = pShip->order;
          stru_108FE8._orderTargetObject.pPlanet = pShip->_orderTargetObject.pPlanet;
          stru_108FE8.Unknown_62 = pShip->Unknown_62;
          stru_108FE8.pCurHullCell = pShip->pCurHullCell;
          stru_108FE8._target = pShip->_target;
          stru_108FE8._target.pObject.pPlanet = pShip->_target.pObject.pPlanet;
          stru_108FE8._target.pObject.pPlanet = pShip->_target.pObject.pPlanet;
          stru_108FE8._target.pObject.pPlanet = pShip->_target.pObject.pPlanet;
          stru_108FE8.Unknown_6C.x = pShip->Unknown_6C.x;
          stru_108FE8.Unknown_6C.y = pShip->Unknown_6C.y;
          stru_108FE8.Unknown_6C.z = pShip->Unknown_6C.z;
          stru_108FE8.Unknown_78.x = pShip->Unknown_78.x;
          stru_108FE8.Unknown_78.y = pShip->Unknown_78.y;
          z = pShip->Unknown_78.z;
          stru_108FE8.Unknown_84 = pShip->Unknown_84;
          stru_108FE8.availablePower = pShip->availablePower;
          stru_108FE8.hullIntegrity = pShip->hullIntegrity;
          stru_108FE8._currentShieldStrength = pShip->_currentShieldStrength;
          stru_108FE8.availableMoves = pShip->availableMoves;
          stru_108FE8.Unknown_98 = pShip->Unknown_98;
          stru_108FE8.specialEffects = pShip->specialEffects;
          stru_108FE8.Unknown_78.z = z;
          stru_108FE8.position.x = pShip->position.x;
          stru_108FE8.position.y = pShip->position.y;
          v12 = pShip->position.z;
          stru_108FE8.hullSize = pShip->hullSize;
          stru_108FE8.position.z = v12;
          _wcpp_2_assign_array_(sub_4B780);
          stru_108FE8.hullCellsNum = pShip->hullCellsNum;
          stru_108FE8.gizmosNum = pShip->gizmosNum;
        }
        for ( i = 0; (__int16)i < a1->a.a1.childrenNum; ++i )
        {
          magic12345678 = (*a1->a.a1.children)[(__int16)i][1].magic12345678;
          (*(void (**)(void))(magic12345678 + 8))();
        }
        if ( !*(_DWORD *)a1->Unknown_D1 )
        {
          a1->pShip = 0;
          return 0;
        }
        return 0;
      }
      if ( a2 == 4 )
      {
        result = a1->a.a1.Unknown_35;
        if ( !result )
        {
          return result;
        }
        if ( a3 >= a1->a.a1.pane.x0 && a3 <= a1->a.a1.pane.x1 && a4 >= a1->a.a1.pane.y0 && a4 <= a1->a.a1.pane.y1 )
        {
          if ( a1->Unknown_233 == 0xFFFFFFFF )
          {
            return 0xFFFFFFFF;
          }
          if ( dword_96AD0 >= 0 )
          {
            if ( !a1->pShip )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x1B2);
            }
            if ( Q_Ship_PutNewGizmoIntoCell_sub_492AC(a1->pShip, a1->Unknown_B8[0], dword_96AD0) )
            {
              v15 = (__int16)a1->a.a1.Unknown_59;
              if ( v15 != 0xFFFFFFFF )
              {
                Q_StartSample_sub_4FB90(&V_SoundSystem, v15);
              }
              *(_DWORD *)&a1->Unknown_B8[2] = 0xFFFFFFFF;
              v16 = a1->a.pProcs;
              *(_DWORD *)a1->Unknown_D1 = 0xFFFFFFFF;
              ((void (*)(void))v16->proc4_draw)();
            }
          }
          return 0xFFFFFFFF;
        }
        return 0;
      }
    }
    return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
  }
  if ( (unsigned __int16)a2 <= 0x32u )
  {
    if ( a1->Unknown_233 != 0xFFFFFFFF )
    {
      if ( sub_4E69C((int)a1) )
      {
        *(_DWORD *)&a1->Unknown_B8[6] = 0xFFFFFFFF;
      }
      a1->a.pProcs->proc4_draw((P_Wnd)a1, 0);
      return 0;
    }
    return 0;
  }
  if ( (unsigned __int16)a2 >= 0x36u )
  {
    if ( (unsigned __int16)a2 <= 0x36u )
    {
      sub_4E644((int)a1, 2, a3, a4);
      return 0;
    }
    if ( (unsigned __int16)a2 < 0x39u )
    {
      if ( a2 == 0x37 )
      {
        sub_4E644((int)a1, 4, a3, a4);
        return 0;
      }
      return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
    }
    if ( (unsigned __int16)a2 <= 0x39u )
    {
      sub_4E644((int)a1, 5, a3, a4);
      return 0;
    }
    if ( (unsigned __int16)a2 < 0x1C01u )
    {
      return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
    }
    if ( (unsigned __int16)a2 > 0x1C01u )
    {
      if ( a2 == 0x1C02 )
      {
        v7 = (char)sub_2ECA4(*(_DWORD *)&a1->Unknown_B8[0xA], a3);
        Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, v7, 4);
        return 0xFFFFFFFF;
      }
      return Q_WndA2_Proc3_sub_2F424(&a1->a, a2, a3, a4);
    }
    v5 = sub_2ECA4(*(_DWORD *)&a1->Unknown_B8[0xA], a3);
    if ( v5 != a1->Unknown_B8[0] )
    {
      v6 = a1->a.pProcs;
      a1->Unknown_B8[0] = v5;
      v6->proc4_draw(&a1->a.a1, 0);
    }
    return 0;
  }
  if ( (unsigned __int16)a2 < 0x34u )
  {
    sub_4E644((int)a1, 0, a3, a4);
    return 0;
  }
  else
  {
    if ( (unsigned __int16)a2 <= 0x34u )
    {
      sub_4E644((int)a1, 1, a3, a4);
    }
    else
    {
      sub_4E644((int)a1, 3, a3, a4);
    }
    return 0;
  }
}
// 78B30: using guessed type _DWORD __stdcall _wcpp_2_assign_array_(_DWORD);
// 96AD0: using guessed type int dword_96AD0;

//----- (0004E644) --------------------------------------------------------
int __fastcall sub_4E644(int result, char a2, int a3, int a4)
{
  int v4; // ebx
  int v5; // eax

  v4 = result;
  if ( a2 >= 0 && a2 < 6 && a2 != *(_BYTE *)(result + 0xBC) )
  {
    *(_BYTE *)(result + 0xBC) = a2;
    sub_4DD14(result);
    v5 = *(_DWORD *)(v4 + 0xC5);
    *(_BYTE *)(v4 + 0xBB) = 0xFF;
    if ( *(_WORD *)(v5 + 0x8C7) )
    {
      *(_BYTE *)(v4 + 0xBB) = sub_2ECA4(v5, 0);
    }
    return (*(int (**)(void))(*(_DWORD *)(v4 + 0xA7) + 0xC))();
  }
  return result;
}

//----- (0004E69C) --------------------------------------------------------
unsigned int __fastcall sub_4E69C(int a1)
{
  unsigned int v2; // ebp
  int v3; // ebx
  unsigned int v4; // esi
  T_Ship *v5; // eax

  v2 = 0;
  v3 = *(char *)(*(_DWORD *)(a1 + 0xAB) + 0xAA);
  v4 = 0;
  if ( !*(_DWORD *)(a1 + 0xC9) )
  {
    while ( !v4 )
    {
      if ( ++v3 >= 4 )
      {
        v3 = 0;
      }
      if ( (v3 != 2 || ((1 << V_PlayerRaceIndex) & V_Research.techs[0x13].knownToRace) != 0)
        && (v3 != 3 || ((1 << V_PlayerRaceIndex) & V_Research.techs[0x1F].knownToRace) != 0) )
      {
        v5 = *(T_Ship **)(a1 + 0xAB);
        if ( v3 == v5->hullSize )
        {
          v4 = 0xFFFFFFFF;
          v2 = 0;
        }
        else if ( Q_Ship_ChangeHullSize_sub_493BC(v5, v3) )
        {
          v4 = 0xFFFFFFFF;
          v2 = 0xFFFFFFFF;
          *(_DWORD *)(a1 + 0xBD) = 0xFFFFFFFF;
        }
      }
    }
  }
  return v2;
}

//----- (0004E758) --------------------------------------------------------
void __fastcall sub_4E758(P_Wnd08SW a1)
{
  int v1; // esi
  int v2; // kr00_4
  int v3; // eax
  int v4; // edi
  int v5; // esi
  int v6; // eax
  int v7; // kr0C_4
  UWORD v8; // dx
  UWORD v9; // ax
  char v10; // bh
  void *ShapeTable_sub_1B084; // eax
  void *v12; // eax
  void *v13; // ecx
  T_Wnd08SW *v14; // ebx
  P_Planet pCurPlanet; // edx
  int Cost_sub_4A18C; // eax
  int TurnsToComplete_sub_46C20; // eax
  int v18; // eax
  char *sub_1CEA8; // eax
  int v20; // eax
  int v21; // eax
  int v22; // edx
  int v23; // esi
  int j; // kr14_4
  LONG v25; // [esp-Ch] [ebp-7Eh]
  LONG v26; // [esp-Ch] [ebp-7Eh]
  WORD v27; // [esp-Ch] [ebp-7Eh]
  LONG v28; // [esp-8h] [ebp-7Ah]
  int v29; // [esp-8h] [ebp-7Ah]
  LONG v30; // [esp-4h] [ebp-76h]
  char s[52]; // [esp+0h] [ebp-72h] BYREF
  char v32[52]; // [esp+34h] [ebp-3Eh] BYREF
  PANE pane; // [esp+68h] [ebp-Ah] BYREF
  PANE v34; // [esp+7Ch] [ebp+Ah] BYREF
  int v35[5]; // [esp+90h] [ebp+1Eh]
  PANE a2; // [esp+A4h] [ebp+32h] BYREF
  _DWORD *p_magic12345678; // [esp+B8h] [ebp+46h]
  int v38; // [esp+BCh] [ebp+4Ah]
  int v39; // [esp+C0h] [ebp+4Eh]
  int v40; // [esp+C4h] [ebp+52h]
  int v41; // [esp+C8h] [ebp+56h]
  int v42; // [esp+CCh] [ebp+5Ah]
  int v43; // [esp+D0h] [ebp+5Eh]
  int i; // [esp+D4h] [ebp+62h]
  void *shape_table; // [esp+D8h] [ebp+66h]
  LONG shape_number; // [esp+DCh] [ebp+6Ah]
  int v47; // [esp+E0h] [ebp+6Eh]
  int v48; // [esp+E4h] [ebp+72h]
  LONG hotY; // [esp+E8h] [ebp+76h]
  int v50; // [esp+ECh] [ebp+7Ah]
  unsigned __int8 v51; // [esp+F0h] [ebp+7Eh]

  p_magic12345678 = &a1->a.a1.magic12345678;
  if ( !a1->pShip )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x24A);
  }
  v1 = *(char *)(*(_DWORD *)((char *)p_magic12345678 + 0xAB) + 0xAA);
  pane.window = (WINDOW *)&V_Type6_stru_D8654;
  pane.x0 = 0x14A;
  pane.y0 = 0x72;
  pane.x1 = 0x1DC;
  pane.y1 = 0x1D8;
  v42 = v1;
  v2 = v1;
  VFX_pane_wipe(&pane, 0);
  pane.y1 = 0x1D8;
  pane.x1 = 0x149;
  pane.x0 = 7;
  pane.y0 = 0x159;
  v3 = VFX_pane_wipe(&pane, 0);
  LOWORD(v3) = GwshareShpCacheIndexes[0x1C];
  v39 = 0;
  v50 = v3;
  for ( i = 0; i < 0xE; ++i )
  {
    v4 = 0x12 * (i + (unsigned __int8)byte_969A8[i]) + 0xA6;
    v5 = 0x24 * ((unsigned __int8)byte_969A8[i] - i) + 0x193;
    v6 = (unsigned __int8)byte_969B8[i];
    v51 = 1;
    v48 = v6;
    v38 = 0;
    if ( v6 > 0 )
    {
      v47 = v2 + 4 * i;
      v40 = 7 * v39;
      v7 = 0;
      while ( (v51 & (unsigned __int8)byte_106FE0[v47]) == 0 )
      {
LABEL_12:
        v51 *= 2;
        ++v38;
        ++v7;
        if ( v38 >= v48 )
        {
          goto LABEL_4;
        }
      }
      if ( dword_96AD0 >= 0 && dword_96AD0 == v39 )
      {
        if ( *((_BYTE *)p_magic12345678 + 0xBB) != 0xFF )
        {
          v30 = v4 + 0x12 * v7;
          v28 = v5 + 0x24 * v7;
          v25 = *((char *)p_magic12345678 + 0xBB);
          v8 = v50;
LABEL_23:
          ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v8);
          VFX_shape_draw(&V_Type6_stru_D8654.pane, ShapeTable_sub_1B084, v25, v28, v30);
          v40 += 7;
          ++v39;
          goto LABEL_12;
        }
        v30 = v4 + 0x12 * v7;
        v28 = v5 + 0x24 * v7;
        v9 = *((_WORD *)p_magic12345678 + 0xC);
        v25 = 1;
      }
      else
      {
        if ( !*(_DWORD *)((char *)p_magic12345678 + 0xAB) )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x28D);
        }
        v10 = *(_BYTE *)(v40 + *(_DWORD *)((char *)p_magic12345678 + 0xAB) + 0xAB);
        if ( v10 != (char)0xFF )
        {
          if ( v10 >= 0x4C )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x291);
          }
          v30 = v4 + 0x12 * v7;
          v28 = v5 + 0x24 * v7;
          v25 = *(char *)(v40 + *(_DWORD *)((char *)p_magic12345678 + 0xAB) + 0xAB);
          v8 = v50;
          goto LABEL_23;
        }
        v30 = v4 + 0x12 * v7;
        v28 = v5 + 0x24 * v7;
        v9 = *((_WORD *)p_magic12345678 + 0xC);
        v25 = 0;
      }
      v8 = v9;
      goto LABEL_23;
    }
LABEL_4:
    ;
  }
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, p_magic12345678[2], p_magic12345678[3], p_magic12345678[4], p_magic12345678[5]);
  if ( *((_BYTE *)p_magic12345678 + 0xBB) != 0xFF )
  {
    a2.window = (WINDOW *)&V_Type6_stru_D8654;
    a2.y1 = 105;
    a2.x0 = 315;
    a2.y0 = 7;
    a2.x1 = 476;
    VFX_pane_wipe(&a2, 0xF2);
    v29 = (a2.x1 - a2.x0) >> 1;
    v26 = *((char *)p_magic12345678 + 0xBB);
    v12 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v50);
    VFX_shape_draw(&a2, v12, v26, v29, 0x3A);
    WinMgr.SmallFont.pane = a2;
    sprintf(s, "%s", V_Gizmos[*((char *)p_magic12345678 + 0xBB)].name);
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 3, 3, s, 0x42, 0xF3, 0xFF, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &a2);
  }
  if ( *(_DWORD *)((char *)p_magic12345678 + 0xC1) )
  {
    pane.window = (WINDOW *)&V_Type6_stru_D8654;
    pane.x1 = 321;
    pane.x0 = 7;
    pane.y0 = 114;
    pane.y1 = 336;
    VFX_pane_wipe(&pane, 0);
    v13 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[V_PlayerRaceIndex + 0x15]);
    if ( !v13 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\shipwin.cpp", 0x2CB);
    }
    VFX_shape_draw(&pane, v13, *(char *)(*(_DWORD *)((char *)p_magic12345678 + 0xAB) + 0xAA), 0, 0);
    *(_DWORD *)((char *)p_magic12345678 + 0xC1) = 0;
  }
  if ( *(_DWORD *)((char *)p_magic12345678 + 0xBD) )
  {
    pane.window = (WINDOW *)&V_Type6_stru_D8654;
    pane.x1 = 304;
    pane.x0 = 7;
    pane.y0 = 7;
    pane.y1 = 102;
    VFX_pane_wipe(&pane, 0);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &pane);
    Q_WINMGR_CPP_sub_53E38(&pane, 3, 3, V_PlayerRaceIndex);
    qmemcpy(v32, &unk_96AD4, 0x32u);
    if ( *(T_Ship **)((char *)p_magic12345678 + 0xAB) != &stru_108FE8 && *(_DWORD *)((char *)p_magic12345678 + 0x22F) == 0xFFFFFFFF )
    {
      v14 = (T_Wnd08SW *)p_magic12345678;
      pCurPlanet = V_Game.pCurPlanet;
      Cost_sub_4A18C = Q_Ship_GetCost_sub_4A18C(*(P_Ship *)((char *)p_magic12345678 + 0xAB));
      if ( v14->Unknown_C9 == 0xFFFFFFFF )
      {
        Cost_sub_4A18C = sub_4EE00(v14);
      }
      TurnsToComplete_sub_46C20 = Q_GetTurnsToComplete_sub_46C20(Cost_sub_4A18C, pCurPlanet->buildingProgress, pCurPlanet->industry);
      if ( TurnsToComplete_sub_46C20 != 0xFFFF )
      {
        if ( TurnsToComplete_sub_46C20 == 1 )
        {
          v18 = 0x1C;                                  // 28: ""
        }
        else
        {
          v18 = 0x1D;                                  // 29: "s"
        }
        Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v18);
        sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x87);// 135: " (%d Day%s)"
        sprintf(v32, sub_1CEA8);
      }
    }
    sprintf(
      s,
      "%s \"%s\"%s",
      V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex],
      (const char *)(*(_DWORD *)((char *)p_magic12345678 + 0xAB) + 0x34),
      v32);
    v27 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
    WinMgr.LargeFont.pane = pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 3, s, 2, v27, 0xFFFF, 0);
    shape_table = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x23]);
    v35[0] = **(_DWORD **)((char *)p_magic12345678 + 0xAB);
    v35[1] = *(_DWORD *)(*(_DWORD *)((char *)p_magic12345678 + 0xAB) + 4);
    v35[2] = *(_DWORD *)(*(_DWORD *)((char *)p_magic12345678 + 0xAB) + 0x10);
    v35[3] = *(_DWORD *)(*(_DWORD *)((char *)p_magic12345678 + 0xAB) + 0x20);
    v20 = *(_DWORD *)((char *)p_magic12345678 + 0xAB);
    v41 = 7;
    v21 = *(_DWORD *)(v20 + 0x18);
    v34 = pane;
    v35[4] = v21;
    hotY = 0x14;
    v43 = 0;
    for ( j = 0; j != 5; ++j )
    {
      v34.x1 = v34.x0 + 0x27;
      v22 = v35[j];
      if ( v22 > 0 )
      {
        v34.x1 += 0xE * v22 / 4;
      }
      v23 = 0;
      shape_number = j + 7;
      do
      {
        VFX_shape_draw(&v34, shape_table, shape_number, 0xE * v23++ + 0x28, 0xE * j + 0x14);
      }
      while ( v23 < 0xF );
    }
    *(_DWORD *)((char *)p_magic12345678 + 0xBD) = 0;
  }
  sub_2D218(p_magic12345678);
}
// 96AD0: using guessed type int dword_96AD0;

//----- (0004EE00) --------------------------------------------------------
int __fastcall sub_4EE00(P_Wnd08SW pWnd08SW)
{
  int v2; // ebx
  int gizmosCost; // ecx
  int diff; // ecx

  v2 = 10000;
  if ( pWnd08SW->Unknown_C9 == 0xFFFFFFFF )
  {
    if ( pWnd08SW->pShip )
    {
      gizmosCost = Q_Ship_GetGizmosCost_sub_4A144(pWnd08SW->pShip);
      diff = gizmosCost - Q_Ship_GetGizmosCost_sub_4A144(&pWnd08SW->Ship);
      v2 = 30;
      if ( diff > 0 )
      {
        return diff + 30;
      }
    }
  }
  return v2;
}

//----- (0004EE50) --------------------------------------------------------
char *sub_4EE50()
{
  char *result; // eax

  _wcpp_2_mod_register_(&dword_96B08);
  result = (char *)sub_4EE74(&V_SoundSystem);
  dword_96B10 = 1;
  return result;
}
// 96B08: using guessed type _DWORD dword_96B08;
// 96B10: using guessed type int dword_96B10;

//----- (0004EE74) --------------------------------------------------------
P_SoundSystem __fastcall sub_4EE74(P_SoundSystem result)
{
  Q_CFile_Ctor_sub_1BB78(&result->cfile);
  result->MDI_installed = 0;
  result->DIG_installed = 0;
  result->AIL_started = 0;
  result->_notstarted1 = 0;
  result->_notstarted2 = 0;
  result->a = 0;
  result->playing = 0;
  result->c = 0xFFFFFFFF;
  result->z1[0] = 0;
  result->Unknown_FF[0] = 0;
  result->Unknown_1FE[0] = 0;
  result->mdidrv = 0;
  result->digdrv = 0;
  result->digitalMusicBuf1 = 0;
  result->digitalMusicBuf2 = 0;
  result->smplCnt = 0;
  result->Unknown_CA8 = 0;
  result->Unknown_CAA = 0;
  memset(result->Unknown_BB4, 0, sizeof(result->Unknown_BB4));
  memset(result->Unknown_C68, 0, sizeof(result->Unknown_C68));
  memset(result->files, 0, sizeof(result->files));
  result->tracks = 0;
  result->volume = 0x64;
  result->volume2 = 0x7F;
  result->Unknown_700 = 0;
  result->Unknown_BB2 = 0;
  return result;
}

//----- (0004EF94) --------------------------------------------------------
T_SoundSystem *__fastcall sub_4EF94(T_SoundSystem *a1)
{
  Q_StopSoundSystem_sub_4FE8C(a1);
  Q_CFile_Dtor_sub_1BBC8(&a1->cfile);
  return a1;
}

//----- (0004EFB0) --------------------------------------------------------
LONG __fastcall Q_StartSoundSystem_sub_4EFB0(T_SoundSystem *a1, int aDIG, int aMDI)
{
  LONG result; // eax

  AIL_startup();
  a1->AIL_started = TRUE;
  if ( aDIG == TRUE )
  {
    result = AIL_install_DIG_INI();
    a1->digdrv = (DIG_DRIVER *)result;
    if ( !result )
    {
      return result;
    }
    Q_AllocateSamples_sub_4F5E8(a1, 8);
    sub_4FF94(a1);
    a1->DIG_installed = TRUE;
  }
  if ( aMDI == TRUE )
  {
    result = AIL_install_MDI_INI();
    a1->mdidrv = (MDI_DRIVER *)result;
    if ( !result )
    {
      return result;
    }
    sub_4F184(a1, 8);
    a1->MDI_installed = TRUE;
  }
  return TRUE;
}

//----- (0004F088) --------------------------------------------------------
HMDIDRIVER __fastcall sub_4F088(char *path, char *a2, char *a3, char *a4)
{
  HMDIDRIVER result; // eax
  IO_PARMS v7; // [esp+0h] [ebp-24h] BYREF

  strcpy(path, a2);
  strcat(path, "\\");
  strcat(path, a3);
  strcpy(path + 0x1FE, a4);
  AIL_set_GTL_filename_prefix(path + 0x1FE);
  memset(&v7, 0, sizeof(v7));
  v7.IO = 0x240;
  v7.IRQ = 9;
  result = AIL_install_MDI_driver_file(path, &v7);
  *(_DWORD *)(path + 0x21B) = result;
  if ( result )
  {
    sub_4F184((P_SoundSystem)path, 8);
    result = (HMDIDRIVER)0xFFFFFFFF;
    *(_DWORD *)(path + 0x207) = 0xFFFFFFFF;
  }
  return result;
}

//----- (0004F184) --------------------------------------------------------
int __fastcall sub_4F184(P_SoundSystem a1, int a2)
{
  __int16 i; // si
  HSEQUENCE sequence_handle; // edx
  __int16 v6; // kr00_2

  if ( a1->Unknown_CA8 )
  {
    return 0;
  }
  if ( a2 > 8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0xDA);
  }
  for ( i = 0; i < a2; ++i )
  {
    sequence_handle = AIL_allocate_sequence_handle(a1->mdidrv);
    v6 = i;
    *(_DWORD *)&a1->Unknown_C68[8 * i] = sequence_handle;
    if ( !sequence_handle )
    {
      break;
    }
    *(_DWORD *)&a1->Unknown_C68[8 * v6 + 4] = 0;
  }
  a1->Unknown_CA8 = i;
  return a1->Unknown_CA8;
}

//----- (0004F32C) --------------------------------------------------------
void __fastcall Q_SSystem_StartSequence_sub_4F32C(P_SoundSystem a1, __int16 track, int a3)
{
  HSEQUENCE *v4; // [esp+0h] [ebp-14h]

  if ( a1->_notstarted2 != 0xFFFFFFFF && a1->MDI_installed )
  {
    if ( track < 0 || track >= a1->Unknown_CA8 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x12A);
    }
    if ( !*(_DWORD *)&a1->Unknown_C68[8 * track + 4] )
    {
      sprintf("Thank you for playing Ascendancy.", "Attempt play Sequence Track %d with NULL data.\n\n", track);
      Q_debugbreak_exit_sub_2624C();
    }
    v4 = (HSEQUENCE *)((char *)a1 + 8 * track);
    if ( AIL_sequence_status(v4[0x31A]) == 4 )
    {
      if ( a3 != 0xFFFFFFFF )
      {
        return;
      }
      AIL_stop_sequence(v4[0x31A]);
    }
    AIL_start_sequence(*(HSEQUENCE *)&a1->Unknown_C68[8 * track]);
  }
}
// 4F3A4: conditional instruction was optimized away because ecx.4!=0

//----- (0004F45C) --------------------------------------------------------
void __fastcall Q_SSystem_EndSequence_sub_4F45C(P_SoundSystem a1, __int16 index)
{
  if ( index < 0 || index >= a1->Unknown_CA8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x152);
  }
  if ( *(_DWORD *)&a1->Unknown_C68[8 * index + 4] )
  {
    AIL_end_sequence(*(HSEQUENCE *)&a1->Unknown_C68[8 * index]);
  }
}

//----- (0004F4D4) --------------------------------------------------------
void __fastcall sub_4F4D4(int a1, __int16 a2)
{
  int v2; // eax

  if ( a2 < 0 || a2 >= *(__int16 *)(a1 + 0xCA8) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x166);
  }
  if ( *(_DWORD *)(a1 + 8 * a2 + 0xC6C) )
  {
    AIL_end_sequence(*(HSEQUENCE *)(a1 + 8 * a2 + 0xC68));
    if ( *(_DWORD *)(v2 + 8 * a2 + 0xC6C) )
    {
      MEM_free(*(void **)(v2 + 8 * a2 + 0xC6C));
    }
  }
}
// 4F525: variable 'v2' is possibly undefined

//----- (0004F534) --------------------------------------------------------
HDIGDRIVER __fastcall sub_4F534(_DWORD *a1, char *a2, char *a3)
{
  BYTE *v4; // edx
  HDIGDRIVER result; // eax
  char *v6; // [esp-4h] [ebp-14h]

  v6 = (char *)a1 + 0xFF;
  v4 = strcpy((char *)a1 + 0xFF, a2) + 0xFF;
  strcat(v6, "\\");
  strcat(v6, a3);
  result = AIL_install_DIG_driver_file(v4, 0);
  *(_DWORD *)((char *)a1 + 0x21F) = result;
  if ( result )
  {
    Q_AllocateSamples_sub_4F5E8((P_SoundSystem)a1, 8);
    sub_4FF94((P_SoundSystem)a1);
    result = (HDIGDRIVER)0xFFFFFFFF;
    *(_DWORD *)((char *)a1 + 0x20B) = 0xFFFFFFFF;
  }
  return result;
}

//----- (0004F5E8) --------------------------------------------------------
int __fastcall Q_AllocateSamples_sub_4F5E8(P_SoundSystem a1, int a2)
{
  WORD i; // si
  SAMPLE *sample_handle; // eax

  if ( a1->smplCnt )
  {
    return 0;
  }
  if ( a2 > 8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x199);
  }
  for ( i = 0; i < a2; ++i )
  {
    sample_handle = AIL_allocate_sample_handle(a1->digdrv);
    a1->smpl[i] = sample_handle;
    if ( !sample_handle )
    {
      break;
    }
  }
  a1->smplCnt = i;
  return a1->smplCnt;
}

//----- (0004F65C) --------------------------------------------------------
unsigned int __fastcall Q_LoadMusic_sub_4F65C(P_SoundSystem a1, const char *aMusicFName)
{
  SAMPLE *smpl; // esi
  void *pBuf; // eax
  int v7; // edx
  void *digitalMusicBuf1; // ebx
  int v9; // ecx
  int v10; // eax
  __int16 i; // si
  DIG_DRIVER *digdrv; // [esp-Ch] [ebp-80h]
  char fname[80]; // [esp+0h] [ebp-74h] BYREF
  int lines; // [esp+50h] [ebp-24h] BYREF
  int bufSize; // [esp+54h] [ebp-20h]
  T_OpenedFile *files; // [esp+58h] [ebp-1Ch]
  FILE *fp; // [esp+5Ch] [ebp-18h]

  if ( a1->DIG_installed != TRUE )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1B4);
  }
  if ( a1->smplCnt <= 0 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1B5);
  }
  if ( !a1->DIG_installed || a1->smplCnt < 8 )
  {
    return 0;
  }
  if ( a1->a == 0xFFFFFFFF )
  {
    return 0xFFFFFFFF;
  }
  smpl = a1->smpl[0];
  AIL_init_sample(smpl);
  AIL_set_sample_type(smpl, 0, 0);
  AIL_set_sample_playback_rate(smpl, 22050);
  digdrv = a1->digdrv;
  bufSize = 0xC800;
  if ( AIL_minimum_sample_buffer_size(digdrv, 22050, 0) >= 0xC800 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1C9);
  }
  pBuf = Q_Allocate_sub_2628C(2 * bufSize, 4, "DigitalMusicBuf");
  v7 = bufSize;
  a1->digitalMusicBuf1 = pBuf;
  digitalMusicBuf1 = a1->digitalMusicBuf1;
  a1->digitalMusicBuf2 = (char *)pBuf + v7;
  if ( !digitalMusicBuf1 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1D0);
  }
  if ( !a1->digitalMusicBuf1 )
  {
    return 0;
  }
  if ( aMusicFName )
  {
    fp = Q_OpenFile_sub_1BB10(aMusicFName, 0);
    if ( !fp )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1DB);
    }
    fscanf(fp, "%d", &lines);
    if ( lines > 0x20 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1E2);
    }
    files = a1->files;
    for ( i = 0; i < lines; ++i )
    {
      fscanf(fp, "%s", fname);
      if ( strlen(fname) >= 0x18 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x1E8);
      }
      v9 = i;
      strncpy(files[v9].fname, fname, 0x18u);
      a1->files[v9].fname[0x17] = 0;
      a1->files[v9].fpos = 0;
    }
    a1->tracks = lines;
    fclose(fp);
  }
  a1->a = 0xFFFFFFFF;
  a1->c = 0;
  *(_DWORD *)&a1->z2[4] = 0;
  v10 = bufSize;
  a1->z2[8] = 0;
  *(_DWORD *)a1->z2 = v10;
  return 0xFFFFFFFF;
}
// 4F738: conditional instruction was optimized away because eax.4<C800

//----- (0004F8CC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_4F8CC(P_SoundSystem a1, __int16 track, int setpos)
{
  MACRO_VFX_BOOL result; // eax
  SAMPLE *v5; // ebp

  if ( a1->c == 0xFFFFFFFF || !a1->DIG_installed )
  {
    return FALSE;
  }
  if ( track < 0 || track >= a1->tracks )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x200);
  }
  if ( a1->current != 0xFFFFFFFF )
  {
    a1->files[a1->current].fpos = Q_GetFilePos_sub_1BEA0(&a1->cfile);
  }
  Q_StopSample_sub_4FA1C(a1);
  v5 = a1->smpl[0];
  AIL_init_sample(v5);
  AIL_set_sample_type(v5, 0, 0);
  AIL_set_sample_playback_rate(v5, 22050);
  Q_SetVolume_sub_4FF4C(a1, a1->volume);
  if ( Q_CFile_OpenFile_sub_1BBFC(&a1->cfile, a1->files[track].fname, O_BINARY, 0) )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x214);
  }
  if ( setpos == TRUE )
  {
    Q_SetFilePos_sub_1BF0C(&a1->cfile, a1->files[track].fpos);
  }
  a1->playing = TRUE;
  result = TRUE;
  a1->current = track;
  return result;
}

//----- (0004FA1C) --------------------------------------------------------
void __fastcall Q_StopSample_sub_4FA1C(P_SoundSystem a1)
{
  SAMPLE *v2; // [esp-10h] [ebp-14h]

  if ( a1->playing == TRUE )
  {
    v2 = a1->smpl[0];
    a1->playing = FALSE;
    AIL_stop_sample(v2);
    a1->files[a1->current].fpos = Q_GetFilePos_sub_1BEA0(&a1->cfile);
  }
}

//----- (0004FAB4) --------------------------------------------------------
void __fastcall sub_4FAB4(int a1)
{
  SAMPLE *v2; // edi
  LONG v3; // eax
  signed int v4; // ebx
  int File_sub_1BF94; // eax
  ULONG v6; // edx

  if ( *(_DWORD *)(a1 + 0x22B) != 0xFFFFFFFF && *(_DWORD *)(a1 + 0x20B) )
  {
    v2 = *(SAMPLE **)(a1 + 0x358);
    v3 = AIL_sample_buffer_ready(v2);
    if ( v3 != 0xFFFFFFFF )
    {
      *(_DWORD *)(a1 + 0x233) = 0;
      *(_BYTE *)(a1 + 0x237) = v3;
    }
    v4 = *(_DWORD *)(a1 + 0x22F) - *(_DWORD *)(a1 + 0x233);
    if ( v4 > 0x1400 )
    {
      v4 = 0x1400;
    }
    if ( v4 )
    {
      File_sub_1BF94 = Q_ReadFile_sub_1BF94(
                         (P_CFile)(a1 + 0x240),
                         (void *)(*(_DWORD *)(a1 + 0x233) + *(_DWORD *)(a1 + 4 * *(char *)(a1 + 0x237) + 0x238)),
                         v4);
      v6 = File_sub_1BF94 + *(_DWORD *)(a1 + 0x233);
      *(_DWORD *)(a1 + 0x233) = v6;
      if ( File_sub_1BF94 )
      {
        AIL_load_sample_buffer(v2, *(char *)(a1 + 0x237), *(void **)(a1 + 4 * *(char *)(a1 + 0x237) + 0x238), v6);
      }
      else
      {
        sub_1BECC((int *)(a1 + 0x240), 0, 0);
        Q_StopSample_sub_4FA1C((P_SoundSystem)a1);
      }
    }
  }
}

//----- (0004FB90) --------------------------------------------------------
void __fastcall Q_StartSample_sub_4FB90(P_SoundSystem a1, __int16 a2)
{
  SAMPLE *v2; // esi
  char *Unknown_BB4; // kr08_4
  int i; // kr04_4
  int j; // edx
  char *v6; // [esp+0h] [ebp-1Ch]

  if ( a1->_notstarted1 != 0xFFFFFFFF )
  {
    if ( a1->DIG_installed )
    {
      v6 = sub_50140(a1, a2);
      if ( v6 )
      {
        for ( i = 0; i + 1 < a1->smplCnt; ++i )
        {
          v2 = a1->smpl[i + 1];
          if ( AIL_sample_status(v2) != 4 )
          {
            AIL_init_sample(v2);
            AIL_set_sample_type(v2, *((__int16 *)v6 + 8), 0);
            AIL_set_sample_address(v2, *((void **)v6 + 2), *((_DWORD *)v6 + 3));
            AIL_set_sample_playback_rate(v2, *((__int16 *)v6 + 9));
            AIL_set_sample_volume(v2, a1->volume2);
            AIL_set_sample_loop_count(v2, 1);
            AIL_start_sample(v2);
            *(_DWORD *)v6 = v2;
            Unknown_BB4 = a1->Unknown_BB4;
            for ( j = 0; j < 6; ++j )
            {
              if ( &Unknown_BB4[0x16 * j] != v6 && v2 == *(SAMPLE **)&Unknown_BB4[0x16 * j] )
              {
                *(_DWORD *)&Unknown_BB4[0x16 * j] = 0;
              }
            }
            return;
          }
        }
      }
    }
  }
}

//----- (0004FE8C) --------------------------------------------------------
void __fastcall Q_StopSoundSystem_sub_4FE8C(P_SoundSystem a1)
{
  __int16 i; // bx
  int j; // ebp

  if ( a1->AIL_started == 0xFFFFFFFF )
  {
    for ( i = 0; i < a1->Unknown_CA8; ++i )
    {
      sub_4F4D4((int)a1, i);
    }
    for ( j = 0; j < a1->smplCnt; ++j )
    {
      AIL_stop_sample(a1->smpl[j]);
    }
    sub_262CC(*(void **)&a1->Unknown_BB4[4]);
    AIL_shutdown();
    a1->AIL_started = 0;
  }
}

//----- (0004FF08) --------------------------------------------------------
void __fastcall Q_SetNoSound_sub_4FF08(P_SoundSystem a1)
{
  sub_4FF1C(a1);
  sub_4FF28(a1);
}

//----- (0004FF1C) --------------------------------------------------------
void __fastcall sub_4FF1C(P_SoundSystem a1)
{
  a1->_notstarted2 = TRUE;
}

//----- (0004FF28) --------------------------------------------------------
void __fastcall sub_4FF28(P_SoundSystem a1)
{
  a1->_notstarted1 = TRUE;
}

//----- (0004FF4C) --------------------------------------------------------
void __fastcall Q_SetVolume_sub_4FF4C(P_SoundSystem a1, char a2)
{
  if ( a2 >= 0 )
  {
    a1->volume = a2;
  }
  AIL_set_sample_volume(a1->smpl[0], a1->volume);
}

//----- (0004FF94) --------------------------------------------------------
int __fastcall sub_4FF94(P_SoundSystem a1)
{
  int v2; // esi
  FILE *fp; // ebp
  char *sub_2628C; // eax
  P_SoundSystem v5; // edx
  char *v6; // ecx
  P_SoundSystem v7; // kr08_4
  char *Unknown_BB4; // kr18_4
  P_SoundSystem v9; // edx
  P_SoundSystem v10; // kr20_4
  P_SoundSystem v11; // esi
  __int16 *Unknown_702; // kr10_4
  int i; // edi
  int j; // ebx
  int k; // edx
  int v17; // [esp+0h] [ebp-28h] BYREF
  int v18; // [esp+4h] [ebp-24h] BYREF
  P_SoundSystem v19; // [esp+8h] [ebp-20h]
  int v20; // [esp+Ch] [ebp-1Ch]

  v19 = a1;
  v2 = 0;
  fp = Q_OpenFile_sub_1BB10("soundfx.txt", 0);
  v20 = 0;
  for ( i = 0; i < 3; ++i )
  {
    fscanf(fp, "%d %d", &v17, &v18);
    *(_DWORD *)&a1->Unknown_C38[4 * i + 0x18] = v2;
    *(_DWORD *)&a1->Unknown_C38[4 * i + 0x24] = v2 + v17 - 1;
    *(_DWORD *)&a1->Unknown_C38[4 * i + 0xC] = v18;
    v20 += v18 * v17;
    if ( i > 0 && *(_DWORD *)&a1->Unknown_C38[4 * i + 0xC] < *(_DWORD *)&a1->Unknown_C38[4 * i + 8] )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x347);
    }
    v2 += v17;
  }
  if ( v2 != 6 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x34D);
  }
  sub_2628C = (char *)Q_Allocate_sub_2628C(v20, 1, "SFX CACHE");
  v5 = v19;
  v6 = sub_2628C;
  v7 = v19;
  Unknown_BB4 = v19->Unknown_BB4;
  for ( j = 0; j < 6; ++j )
  {
    *(_DWORD *)&Unknown_BB4[0x16 * j] = 0;
    *(_WORD *)&Unknown_BB4[0x16 * j + 0x10] = 0;
    *(_WORD *)&Unknown_BB4[0x16 * j + 0x12] = 0x5622;
    *(_WORD *)&Unknown_BB4[0x16 * j + 0x14] = 0xFFFF;
    if ( j > *(_DWORD *)&v5->Unknown_C38[0x24] )
    {
      v5 = (P_SoundSystem)((char *)v5 + 4);
    }
    *(_DWORD *)&v7->Unknown_BB4[0x16 * j + 4] = v6;
    v6 += *(_DWORD *)&v5->Unknown_C38[0xC];
  }
  fscanf(fp, "%d", &v17);
  v9 = v19;
  v19->Unknown_700 = v17;
  if ( (unsigned __int16)v9->Unknown_700 >= 0x64u )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x369);
  }
  v10 = v19;
  v11 = v19;
  Unknown_702 = v19->Unknown_702;
  for ( k = 0; k < (unsigned __int16)v11->Unknown_700; ++k )
  {
    fscanf(fp, "%s", &Unknown_702[5 * k]);
    v10->Unknown_702[k + 0x1F4] = 0xFFFF;
  }
  return fclose(fp);
}

//----- (00050140) --------------------------------------------------------
char *__fastcall sub_50140(P_SoundSystem a1, __int16 a2)
{
  int v4; // edx
  P_SoundSystem v5; // kr00_4
  int v6; // edi
  int v7; // ecx
  unsigned int v8; // edx
  int v9; // kr18_4
  int v10; // edi
  int v11; // ebp
  unsigned __int16 Unknown_BB2; // di
  char *v13; // edx
  int n; // kr0C_4
  int k; // kr34_4
  int m; // eax
  int v17; // kr1C_4
  int i; // ebp
  int j; // eax
  T_CFile v20; // [esp+0h] [ebp-178h] BYREF
  char s[52]; // [esp+118h] [ebp-60h] BYREF
  int v22; // [esp+14Ch] [ebp-2Ch]
  char *v23; // [esp+150h] [ebp-28h]
  int v24; // [esp+154h] [ebp-24h]
  int FileLength_sub_1BE28; // [esp+158h] [ebp-20h]
  P_SoundSystem v26; // [esp+15Ch] [ebp-1Ch]
  int v27; // [esp+160h] [ebp-18h]

  LOWORD(v27) = a2;
  if ( a1->_notstarted1 == TRUE || !a1->DIG_installed )
  {
    return 0;
  }
  if ( (v27 & 0x8000u) != 0 || (__int16)v27 >= (int)(unsigned __int16)a1->Unknown_700 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x37B);
  }
  v23 = 0;
  if ( (v27 & 0x8000u) != 0 || (__int16)v27 >= (int)(unsigned __int16)a1->Unknown_700 )
  {
    return v23;
  }
  v4 = a1->Unknown_702[(__int16)v27 + 0x1F4];
  if ( v4 == 0xFFFFFFFF )
  {
    sprintf(s, "data\\%s.voc", (const char *)&a1->Unknown_702[5 * (__int16)v27]);
    Q_CFile_Ctor_sub_1BB78(&v20);
    Q_CFile_OpenFile_sub_1BBFC(&v20, s, 0x200, 0);
    v8 = 0;
    FileLength_sub_1BE28 = Q_GetFileLength_sub_1BE28(&v20);
    v7 = 0;
    while ( FileLength_sub_1BE28 >= *(_DWORD *)&a1->Unknown_C38[4 * v7 + 0xC] )
    {
      if ( ++v7 >= 3 )
      {
        goto LABEL_23;
      }
    }
    v8 = 0xFFFFFFFF;
LABEL_23:
    if ( v8 != 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\ssystem.cpp", 0x3AD);
    }
    v9 = *(_DWORD *)&a1->Unknown_C38[4 * v7 + 0x18];
    v22 = 0xFFFFFFFF;
    v17 = 0;
    if ( v9 <= *(_DWORD *)&a1->Unknown_C38[4 * v7 + 0x24] )
    {
      while ( *(__int16 *)&a1->Unknown_BB4[0x16 * v9 + 0x14 + 0x16 * v17] != 0xFFFFFFFF )
      {
        ++v17;
        if ( v9 + v17 > *(_DWORD *)&a1->Unknown_C38[4 * v7 + 0x24] )
        {
          goto LABEL_30;
        }
      }
      v22 = v9 + v17;
    }
LABEL_30:
    if ( v22 == 0xFFFFFFFF )
    {
      v26 = a1;
      v24 = 4 * v7;
      for ( i = 0; i < (unsigned __int16)a1->Unknown_BB2; ++i )
      {
        v10 = a1->Unknown_702[*(unsigned __int16 *)&a1->Unknown_C38[2 * i] + 0x1F4];
        if ( v10 >= *(_DWORD *)&a1->Unknown_C38[v24 + 0x18]
          && v10 <= *(_DWORD *)&a1->Unknown_C38[v24 + 0x24]
          && (!*(_DWORD *)&a1->Unknown_BB4[0x16 * v10] || AIL_sample_status(*(HSAMPLE *)&a1->Unknown_BB4[0x16 * v10]) != 4) )
        {
          v22 = v10;
          break;
        }
      }
    }
    if ( v22 != 0xFFFFFFFF )
    {
      v11 = *(__int16 *)&a1->Unknown_BB4[0x16 * v22 + 0x14];
      v23 = &a1->Unknown_BB4[0x16 * v22];
      if ( v11 != 0xFFFFFFFF )
      {
        for ( j = 0; j < (unsigned __int16)a1->Unknown_BB2 && *(unsigned __int16 *)&a1->Unknown_C38[2 * j] != v11; ++j )
        {
          ;
        }
        for ( k = 0; ; ++k )
        {
          Unknown_BB2 = a1->Unknown_BB2;
          if ( j + k >= Unknown_BB2 )
          {
            break;
          }
          *(_WORD *)&a1->Unknown_C38[2 * j + 2 * k] = *(_WORD *)&a1->Unknown_C38[2 * j + 2 + 2 * k];
        }
        a1->Unknown_BB2 = Unknown_BB2 - 1;
        a1->Unknown_702[v11 + 0x1F4] = 0xFFFF;
      }
      Q_CFile_Load_sub_1BF1C(&v20, *((void **)v23 + 1));
      v13 = v23;
      *((_DWORD *)v23 + 2) = *((_DWORD *)v23 + 1) + 0x2A;
      *((_DWORD *)v13 + 3) = FileLength_sub_1BE28 - 0x2B;
      *((_WORD *)v13 + 0xA) = v27;
      a1->Unknown_702[(__int16)v27 + 0x1F4] = v22;
      LOWORD(v13) = a1->Unknown_BB2;
      a1->Unknown_BB2 = (_WORD)v13 + 1;
      *(_WORD *)&a1->Unknown_C38[2 * (unsigned __int16)v13] = v27;
    }
    Q_CFile_Dtor_sub_1BBC8(&v20);
    return v23;
  }
  v5 = a1;
  v23 = &a1->Unknown_BB4[0x16 * v4];
  for ( m = 0; m < (unsigned __int16)a1->Unknown_BB2 && *(unsigned __int16 *)&v5->Unknown_C38[2 * m] != (__int16)v27; ++m )
  {
    ;
  }
  for ( n = 0; ; ++n )
  {
    v6 = (unsigned __int16)a1->Unknown_BB2;
    if ( m + n >= (unsigned __int16)v6 )
    {
      break;
    }
    *(_WORD *)&a1->Unknown_C38[2 * m + 2 * n] = *(_WORD *)&a1->Unknown_C38[2 * m + 2 + 2 * n];
  }
  *(_WORD *)&a1->Unknown_BB4[2 * v6 + 0x82] = v27;
  return v23;
}

//----- (00050530) --------------------------------------------------------
UWORD __fastcall sub_50530(T_Type5 *a1, P_Planet pPlanet, int a3, int a4)
{
  T_Star *v6; // esi
  void *ShapeTable_sub_1B084; // eax
  void *v8; // ecx
  int racesBits; // edi
  char *name; // ecx
  WORD v11; // ax
  LONG *p_x0; // esi
  LONG *v13; // esi
  int v14; // edx
  char *sub_1CEA8; // eax
  LONG *v16; // esi
  int z7; // ebx
  PANE *v18; // esi
  WORD v19; // cx
  char *v20; // eax
  int DaysToCompleteItem_sub_358BC; // edx
  char *v22; // kr00_4
  int v23; // eax
  char *v24; // eax
  char *v25; // eax
  char *v26; // kr08_4
  int v27; // ebx
  LONG *v28; // esi
  UWORD v29; // di
  int SquareWithItem_sub_35930; // eax
  void *v31; // eax
  void *v32; // eax
  int v33; // eax
  void *v34; // eax
  int v35; // eax
  void *v36; // eax
  LONG v37; // edi
  int v38; // eax
  int j; // esi
  UWORD result; // ax
  void *v41; // eax
  int i; // esi
  LONG v43; // [esp-10h] [ebp-F4h]
  LONG v44; // [esp-10h] [ebp-F4h]
  LONG v45; // [esp-10h] [ebp-F4h]
  LONG v46; // [esp-10h] [ebp-F4h]
  LONG v47; // [esp-8h] [ebp-ECh]
  WORD x_4; // [esp+4h] [ebp-E0h]
  WORD x_4a; // [esp+4h] [ebp-E0h]
  WORD x_4b; // [esp+4h] [ebp-E0h]
  LONG x_4c; // [esp+4h] [ebp-E0h]
  char *v52; // [esp+8h] [ebp-DCh]
  char *v53; // [esp+8h] [ebp-DCh]
  char *v54; // [esp+Ch] [ebp-D8h]
  char *v55; // [esp+Ch] [ebp-D8h]
  LONG v56; // [esp+Ch] [ebp-D8h]
  char s[100]; // [esp+10h] [ebp-D4h] BYREF
  char v58[60]; // [esp+74h] [ebp-70h] BYREF
  LONG v59; // [esp+B0h] [ebp-34h]
  LONG hotY; // [esp+B4h] [ebp-30h]
  int v61; // [esp+B8h] [ebp-2Ch]
  int v62; // [esp+BCh] [ebp-28h]
  PANE *pane; // [esp+C0h] [ebp-24h]
  int v64; // [esp+C4h] [ebp-20h]
  char *string; // [esp+C8h] [ebp-1Ch]
  char a2[4]; // [esp+CCh] [ebp-18h]
  int v67; // [esp+D0h] [ebp-14h]
  LONG shape_number; // [esp+D4h] [ebp-10h]

  pane = (PANE *)a1;
  v6 = &V_Game.stars[pPlanet->starIndex];
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, word_96B2A);
  if ( !ShapeTable_sub_1B084 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x41);
  }
  VFX_shape_draw(pane, ShapeTable_sub_1B084, v6->type, 0x4B, 0x4B);
  v8 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, word_96B2C);
  if ( !v8 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x45);
  }
  VFX_shape_draw(pane, v8, pPlanet->size + 5 * pPlanet->type, 0xC8, 0x4B);
  v64 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  v61 = v64;
  if ( a4 )
  {
    if ( V_Mouse.x >= 0x96 )
    {
      v64 = 0xF3;
    }
    else
    {
      v61 = 0xF3;
    }
  }
  racesBits = v6->racesBits;
  if ( racesBits == 1 << V_PlayerRaceIndex || v6 == V_Game.races[V_PlayerRaceIndex]._homeStar && ((1 << V_PlayerRaceIndex) & racesBits) != 0 )
  {
    Q_WINMGR_CPP_sub_53E38(pane, 4, 0xA, V_PlayerRaceIndex);
  }
  name = V_Game.stars[pPlanet->starIndex].name;
  v11 = v61;
  WinMgr.SmallFont.pane.window = pane->window;
  p_x0 = &pane->x0;
  WinMgr.SmallFont.pane.x0 = pane->x0;
  WinMgr.SmallFont.pane.y0 = *++p_x0;
  WinMgr.SmallFont.pane.x1 = *++p_x0;
  WinMgr.SmallFont.pane.y1 = p_x0[1];
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x78, 0x12, name, 0, v11, 0xFF, 0);
  string = pPlanet->name;
  x_4 = v64;
  v62 = (__int16)v64;
  WinMgr.LargeFont.pane.window = pane->window;
  v13 = &pane->x0;
  WinMgr.LargeFont.pane.x0 = pane->x0;
  WinMgr.LargeFont.pane.y0 = *++v13;
  WinMgr.LargeFont.pane.x1 = *++v13;
  WinMgr.LargeFont.pane.y1 = v13[1];
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x113, 0xF, pPlanet->name, 0, x_4, 0xFF, 0);
  v14 = Q_Font_GetTextWidth_sub_2B4F4(&WinMgr.LargeFont, string) + 0x127;
  v54 = PlanetTypeTexts[pPlanet->type];
  v52 = PlanetSizeTexts[pPlanet->size];
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x88);// 136: "(%s %s Planet)"
  sprintf(s, sub_1CEA8, v52, v54);
  x_4a = v62;
  WinMgr.SmallFont.pane.window = pane->window;
  v16 = &pane->x0;
  WinMgr.SmallFont.pane.x0 = pane->x0;
  WinMgr.SmallFont.pane.y0 = *++v16;
  WinMgr.SmallFont.pane.x1 = *++v16;
  WinMgr.SmallFont.pane.y1 = v16[1];
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, v14, 0x10, s, 0, x_4a, 0xFF, 0);
  z7 = pPlanet->z7;
  v59 = 0x1E;
  if ( z7 == 0xFFFFFFFF )
  {
    v18 = pane;
    v19 = v62;
    v20 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x89);    // 137: "Self-Managed"
    WinMgr.SmallFont.pane.window = v18->window;
    v18 = (PANE *)((char *)v18 + 4);
    WinMgr.SmallFont.pane.x0 = (LONG)v18->window;
    v18 = (PANE *)((char *)v18 + 4);
    WinMgr.SmallFont.pane.y0 = (LONG)v18->window;
    v18 = (PANE *)((char *)v18 + 4);
    WinMgr.SmallFont.pane.x1 = (LONG)v18->window;
    WinMgr.SmallFont.pane.y1 = v18->x0;
    v59 = 0x27;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x113, 0x1E, v20, 0, v19, 0xFF, 0);
  }
  if ( pPlanet->buildingPlanetItemIndex == 0xFF )
  {
    v26 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8D);
    strcpy(s, v26);
    if ( pPlanet->word42 == pPlanet->word4C )
    {
      strcat(s, Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8E));
    }
    v64 = 0xF3;
  }
  else
  {
    qmemcpy(v58, &unk_96B30, sizeof(v58));
    if ( (V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].flags & 2) == 0 )
    {
      DaysToCompleteItem_sub_358BC = (unsigned __int16)Q_Planet_GetDaysToCompleteItem_sub_358BC(pPlanet);
      if ( (unsigned __int16)DaysToCompleteItem_sub_358BC == 0xFFFF )
      {
        v22 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8A);
        strcpy(v58, v22);
      }
      else
      {
        if ( DaysToCompleteItem_sub_358BC == 1 )
        {
          v23 = 0x1C;                                  // 28: ""
        }
        else
        {
          v23 = 0x1D;                                  // 29: "s"
        }
        v55 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v23);
        v24 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8B);// 139: " - %d day%s until completion"
        sprintf(v58, v24, DaysToCompleteItem_sub_358BC, v55);
      }
    }
    v53 = V_PlanetItems.item[pPlanet->buildingPlanetItemIndex].name;
    v25 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8C);    // 140: "Building %s%s"
    sprintf(s, v25, v53, v58);
  }
  v27 = v59;
  x_4b = v64;
  WinMgr.SmallFont.pane.window = pane->window;
  v28 = &pane->x0;
  WinMgr.SmallFont.pane.x0 = pane->x0;
  WinMgr.SmallFont.pane.y0 = *++v28;
  WinMgr.SmallFont.pane.x1 = *++v28;
  WinMgr.SmallFont.pane.y1 = v28[1];
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x113, v27, s, 0, x_4b, 0xFF, 0);
  v59 = 0x19;
  v29 = GwshareShpCacheIndexes[0x1E];
  *(_DWORD *)a2 = (unsigned __int16)word_96B6C;
  for ( i = 0; i < 2; ++i )
  {
    SquareWithItem_sub_35930 = Q_Planet_GetSquareWithItem_sub_35930(pPlanet, a2[i]);
    if ( SquareWithItem_sub_35930 != 0xFFFF )
    {
      SquareWithItem_sub_35930 = pPlanet->pSquares[SquareWithItem_sub_35930].flags & 1;
      if ( SquareWithItem_sub_35930 )
      {
        v47 = v59;
        v43 = (unsigned __int8)a2[i];
        v31 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v29);
        VFX_shape_transform(pane, v31, v43, 0xF5, v47, V_BigBuffer, 0, 0x4000, 0x4000, 0);
        v59 += 0x19;
      }
    }
  }
  LOWORD(SquareWithItem_sub_35930) = GwshareShpCacheIndexes[0x26];
  v67 = SquareWithItem_sub_35930;
  string = (char *)pPlanet->research;
  string = (char *)(int)pow((double)(int)string, 0.75);
  shape_number = (LONG)string;
  if ( (unsigned __int16)string > 0x14u )
  {
    shape_number = 0x14;
  }
  v44 = (unsigned __int16)shape_number;
  v32 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v67);
  VFX_shape_transform(pane, v32, v44, 0x118, 0x3C, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  LOWORD(v33) = GwshareShpCacheIndexes[0x27];
  v67 = v33;
  string = (char *)pPlanet->industry;
  string = (char *)(int)pow((double)(int)string, 0.75);
  shape_number = (LONG)string;
  if ( (unsigned __int16)string > 0x14u )
  {
    shape_number = 0x14;
  }
  v45 = (unsigned __int16)shape_number;
  v34 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v67);
  VFX_shape_transform(pane, v34, v45, 0x15E, 0x3C, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  LOWORD(v35) = GwshareShpCacheIndexes[0x28];
  v67 = v35;
  LOWORD(v35) = pPlanet->prosperity;
  shape_number = v35;
  if ( (unsigned __int16)v35 > 0x14u )
  {
    shape_number = 0x14;
  }
  v46 = (unsigned __int16)shape_number;
  v36 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v67);
  v37 = 0x1EA;
  VFX_shape_transform(pane, v36, v46, 0x1A4, 0x3C, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  LOWORD(v38) = GwshareShpCacheIndexes[0x2C];
  hotY = 0x3C;
  v67 = v38;
  shape_number = 6;
  for ( j = 0; ; ++j )
  {
    result = pPlanet->maximumPopulation;
    if ( j >= result )
    {
      break;
    }
    if ( j == pPlanet->word4C )
    {
      shape_number = 7;
    }
    if ( j == pPlanet->word42 )
    {
      shape_number = 8;
    }
    v56 = hotY;
    x_4c = (unsigned __int16)shape_number;
    v41 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, v67);
    VFX_shape_draw(pane, v41, x_4c, v37, v56);
    v37 += 5;
    if ( j % 0xA == 9 )
    {
      v37 = 0x1EA;
      hotY += 5;
    }
  }
  return result;
}
/* Orphan comments:
138: " - No Progress"
141: "No Project"
142: "   (No Free Population)"
*/
// 50A78: variable 'SquareWithItem_sub_35930' is possibly undefined
// 50B38: variable 'v33' is possibly undefined
// 50BF8: variable 'v35' is possibly undefined
// 50C99: variable 'v38' is possibly undefined
// 96B6C: using guessed type __int16 word_96B6C;
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];
// 50530: using guessed type char s[100];
// 50530: using guessed type char var_70[60];

//----- (00050D70) --------------------------------------------------------
void __fastcall sub_50D70(PPANE pPANE, P_Ship pShip, int a3, int a4)
{
  void *smshipShape; // eax
  P_Planet pvPlanet3; // esi
  char *v7; // eax
  void *v8; // eax
  P_Star vpStar; // ecx
  char *v10; // eax
  void *v11; // eax
  P_Lane pLane; // edx
  P_Star pStar2; // esi
  P_Star pStar1; // eax
  P_Ship v15; // ebx
  double v16; // st7
  char flags; // ah
  char *name; // edi
  int etaDays; // esi
  P_Star destStar; // eax
  int v21; // eax
  char *v22; // eax
  P_Planet pvPlanet1; // esi
  char *sub_1CEA8; // eax
  void *ShapeTable_sub_1B084; // eax
  P_Planet pvPlanet2; // esi
  char *v27; // eax
  void *v28; // eax
  BYTE order; // bh
  P_Ship v30; // edx
  char *v31; // eax
  int tmp; // eax
  void *shpTable; // eax
  int v34; // edi
  int v35; // edi
  void *v36; // eax
  int Unknown_98; // eax
  int v38; // ebx
  void *v39; // eax
  int i; // esi
  int j; // kr10_4
  int k; // kr20_4
  __int16 m; // si
  LONG v44; // [esp-4h] [ebp-174h]
  LONG v45; // [esp-4h] [ebp-174h]
  char *v46; // [esp+4h] [ebp-16Ch]
  WORD raceIndex; // [esp+4h] [ebp-16Ch]
  LONG hotY_1; // [esp+4h] [ebp-16Ch]
  char s[200]; // [esp+8h] [ebp-168h] BYREF
  PANE pane; // [esp+D0h] [ebp-A0h] BYREF
  int shipIcons[5]; // [esp+E4h] [ebp-8Ch]
  T_Vector3D v52; // [esp+F8h] [ebp-78h] BYREF
  T_Vector3D v53; // [esp+104h] [ebp-6Ch] BYREF
  LONG v54[2]; // [esp+110h] [ebp-60h]
  int v55[2]; // [esp+118h] [ebp-58h]
  int v56[2]; // [esp+120h] [ebp-50h]
  T_Vector3D *v57; // [esp+128h] [ebp-48h]
  int v58; // [esp+12Ch] [ebp-44h]
  float laneDistance; // [esp+130h] [ebp-40h]
  float travelSpeed; // [esp+134h] [ebp-3Ch]
  int shipRank; // [esp+138h] [ebp-38h]
  P_Ship vpShip; // [esp+13Ch] [ebp-34h]
  int v63; // [esp+140h] [ebp-30h]
  LONG x1; // [esp+144h] [ebp-2Ch]
  int v65; // [esp+148h] [ebp-28h]
  int v66; // [esp+14Ch] [ebp-24h]
  LONG shape_number; // [esp+150h] [ebp-20h]
  LONG hotY; // [esp+154h] [ebp-1Ch]
  unsigned int v69; // [esp+158h] [ebp-18h]
  int v70; // [esp+15Ch] [ebp-14h]
  int index; // [esp+160h] [ebp-10h]

  vpShip = pShip;
  smshipShape = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, smshipShpCacheIndex);
  VFX_shape_draw(pPANE, smshipShape, pShip->hullSize, 65, 50);
  v70 = 4 * V_Game.races[V_PlayerRaceIndex].Unknown_02 + 0x13;
  if ( a4 )
  {
    v70 = 243;
  }
  switch ( vpShip->locationType )
  {
    case ASCEND_LOCATION_TYPE_SHIPYARD:
      pvPlanet1 = vpShip->pLocation.pPlanet;
      sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x93);// 147: "Under Construction at %s"
      sprintf(s, sub_1CEA8, pvPlanet1->name);
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planetsShpCacheIndex);
      VFX_shape_draw(pPANE, ShapeTable_sub_1B084, pvPlanet1->size + 5 * pvPlanet1->type, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_SHIPDOCK:
      pvPlanet2 = vpShip->pLocation.pPlanet;
      v27 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x94);  // 148: "Being Refitted at %s"
      sprintf(s, v27, pvPlanet2->name);
      v28 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planetsShpCacheIndex);
      VFX_shape_draw(pPANE, v28, 5 * pvPlanet2->type + pvPlanet2->size, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_ORBIT:
      pvPlanet3 = vpShip->pLocation.pPlanet;
      v7 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x8F);   // 143: "Orbiting %s"
      sprintf(s, v7, pvPlanet3->name);
      v8 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, planetsShpCacheIndex);
      VFX_shape_draw(pPANE, v8, pvPlanet3->size + 5 * pvPlanet3->type, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_SYSTEM:
      vpStar = vpShip->pLocation.pStar;
      v10 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x90);  // 144: "in %s System"
      sprintf(s, v10, vpStar->name);
      v11 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, sunsShpCacheIndex);
      VFX_shape_draw(pPANE, v11, vpStar->type, 0x24E, 0x31);
      break;
    case ASCEND_LOCATION_TYPE_STARLANE:
      pLane = vpShip->pLocation.pLane;
      pStar2 = pLane->pStar2;
      pStar1 = pLane->pStar1;
      v57 = &v52;
      memset(&v53, 0, sizeof(v53));
      v53.x = pStar1->pos.x - pStar2->pos.x;
      v53.y = pStar1->pos.y - pStar2->pos.y;
      v53.z = pStar1->pos.z - pStar2->pos.z;
      v52 = v53;
      v15 = vpShip;
      v16 = sqrt(v53.y * v53.y + v53.x * v53.x + v53.z * v53.z);
      v58 = v15->totalStarLaneHyperdrivePotential + vpShip->totalStarLaneDrivePotential;
      laneDistance = v16;
      flags = pLane->flags;
      travelSpeed = (float)v58;
      if ( (flags & 1) != 0 )
      {
        // Red lanes
        travelSpeed = travelSpeed * 0.33333334;
      }
      if ( V_Game.races[vpShip->raceIndex].ability == ASCEND_SA_FAST_LANE_TRAVEL )
      {
        if ( travelSpeed < 1.0 )
        {
          travelSpeed = 1.0;
        }
        travelSpeed = travelSpeed * 2.0;
      }
      v58 = (int)((laneDistance - vpShip->position.x) / travelSpeed);
      name = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x91); // 145: "Unknown"
      etaDays = v58 + 1;
      // Check travel direction
      if ( (LODWORD(vpShip->position.y) & 0x7FFFFFFF) != 0 )
      {
        destStar = pLane->pStar2;
      }
      else
      {
        destStar = pLane->pStar1;
      }
      if ( ((1 << V_PlayerRaceIndex) & destStar->exploredBits) != 0 )
      {
        name = destStar->name;
      }
      if ( v58 )
      {
        v21 = 0x1D;                                    // 29: "s"
      }
      else
      {
        v21 = 0x1C;                                    // 28: ""
      }
      v46 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v21);
      v22 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x92);  // 146: "In Starlane to %s System\nETA - %d Day%s"
      sprintf(s, v22, name, etaDays, v46);
      break;
    default:
      sprintf(s, "Bad m_LocationType");
      break;
  }
  order = vpShip->order;
  if ( order && order != 7 && vpShip->locationType == ASCEND_LOCATION_TYPE_SYSTEM )
  {
    v30 = vpShip;
    v31 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x95);    // 149: "\nMoving to Planet"
    if ( v30->order == 1 )
    {
      v31 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x96);  // 150: "\nMoving to Starlane"
    }
    strcat(s, v31);
  }
  v58 = (__int16)v70;
  WinMgr.SmallFont.pane = *pPANE;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0x17C, 5, s, 0, v70, 0xFF, 0x8E);
  sprintf(s, "%s", vpShip->name);
  WinMgr.LargeFont.pane = *pPANE;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x96, 5, s, 0, v58, 0xFF, 0);
  shipRank = Q_GetShipRank_sub_4A8CC(vpShip);
  for ( i = 0; i < 9; ++i )
  {
    if ( i >= shipRank )
    {
      break;
    }
    raceIndex = vpShip->raceIndex;
    // data\shipicon.shp
    shpTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x23]);
    Q_DrawRaceTintedShape_sub_53EB8(pPANE, shpTable, 6, 9 * i + 259, 6, raceIndex);
  }
  shipIcons[0] = vpShip->totalWeaponDamage;
  shipIcons[1] = vpShip->totalShieldStrength;
  shipIcons[2] = vpShip->totalDriveMaxDistance;
  shipIcons[3] = vpShip->totalScannerRangePerTurn;
  tmp = vpShip->totalGeneratorPower;
  hotY = 25;
  shipIcons[4] = tmp;
  v65 = 0;
  pane = *pPANE;
  // data\shipicon.shp
  LOWORD(tmp) = GwshareShpCacheIndexes[0x23];
  index = tmp;
  v63 = 7;
  for ( j = 0; j != 5; ++j )
  {
    pane.x1 = pane.x0 + 149;
    v34 = shipIcons[j];
    if ( v34 > 0 )
    {
      pane.x1 += 0xE * v34 / 4;
    }
    v35 = 0;
    shape_number = j + 7;
    do
    {
      v44 = shape_number;
      v36 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index);
      VFX_shape_draw(&pane, v36, v44, 0xE * v35++ + 0x96, 0xE * j + 25);
    }
    while ( v35 < 14 );
  }
  v56[0] = vpShip->hullIntegrity;
  v56[1] = vpShip->availablePower;
  Unknown_98 = vpShip->Unknown_98;
  v66 = 0;
  v55[0] = Unknown_98;
  x1 = 0x16B;
  v55[1] = Q_Ship_GetEffectveGeneratorsPower_sub_4A8FC(vpShip);
  v54[1] = 11;
  v54[0] = 8;
  for ( k = 0; k != 2; ++k )
  {
    if ( v55[k] > 0 )
    {
      if ( v56[k] >= 0 )
      {
        v38 = v55[k];
        if ( v56[k] > v38 )
        {
          v56[k] = v38;
        }
      }
      else
      {
        v56[k] = 0;
      }
      v69 = 4 * k;
      for ( m = 0; m < 7; ++m )
      {
        hotY_1 = 14 * m + 5;
        v45 = v54[v69 / 4];
        v39 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, index);
        VFX_shape_draw(pPANE, v39, v45, 0x15E, hotY_1);
      }
      Q_Pane_CopyOrDrawRectangle_sub_2BB74(
        pPANE,
        0xE * k + 0x15E,
        4,
        0xE * k + 0x16B,
        0x66 - 0x62 * v56[v69 / 4] / v55[v69 / 4],
        0,
        0xFFFFFFFF);
    }
  }
}
// 50D70: using guessed type char s[200];

//----- (00051610) --------------------------------------------------------
void __fastcall sub_51610(T_Type5 *a1, LONG a2, int a3, int a4)
{
  void *ShapeTable_sub_1B084; // eax
  void *v6; // eax

  if ( a4 == 0xFFFFFFFF )
  {
    VFX_pane_wipe((PANE *)a1, 0x96);
  }
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);
  VFX_shape_draw((PANE *)a1, ShapeTable_sub_1B084, a2, 0x38, 0x37);
  v6 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x21]);
  VFX_shape_draw((PANE *)a1, v6, 7, 0x38, 0x37);
}

//----- (00051674) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd16SW_Ctor_sub_51674(P_Wnd16SW a1)
{
  Q_A2Ctor_sub_2C830(&a1->a.a);
  a1->a.a.pProcs = (P_Procs)&Wnd16SW_Procs;
  Q_A11_sub_516D4(&a1->a);
}
// 96128: using guessed type int (__fastcall *Wnd16SW_Procs)(P_WndA2 a1);

//----- (00051690) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd16SW_Dtor_sub_51690(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd16SW);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&Wnd16SW_Procs;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 96128: using guessed type int (__fastcall *Wnd16SW_Procs)(P_WndA2 a1);

//----- (000516D4) --------------------------------------------------------
void __fastcall __spoils<> Q_A11_sub_516D4(P_TypeA11 result)
{
  result->pListBox = 0;
}

//----- (000516E0) --------------------------------------------------------
void __fastcall Q_Wnd16SW_Proc4_sub_516E0(_DWORD *a1)
{
  int v1; // ebx
  int v2; // eax
  int v3; // eax
  char *v4; // eax
  UBYTE Unknown_02; // al
  LONG *v6; // esi
  int v7; // edx
  char *v8; // [esp-14h] [ebp-6Ch]
  int v9; // [esp-10h] [ebp-68h]
  char *v10; // [esp-Ch] [ebp-64h]
  char *sub_1CEA8; // [esp-4h] [ebp-5Ch]
  char s[80]; // [esp+0h] [ebp-58h] BYREF
  PANE *p_x0; // [esp+50h] [ebp-8h]
  _DWORD *v14; // [esp+54h] [ebp-4h]

  v14 = a1;
  v1 = 0;
  if ( V_Game.starsNum > 0 )
  {
    v7 = 0;
    do
    {
      if ( V_Game.stars[v7].racesBits == 1 << V_PlayerRaceIndex && &V_Game.stars[v7] != V_Game.races[V_PlayerRaceIndex]._homeStar )
      {
        ++v1;
      }
      ++v7;
    }
    while ( (__int16)v7 < V_Game.starsNum );
  }
  if ( ((1 << V_PlayerRaceIndex) & V_Game.races[V_PlayerRaceIndex]._homeStar->racesBits) != 0 )
  {
    ++v1;
  }
  if ( v1 == 1 )
  {
    v2 = 0x1C;
  }
  else
  {
    v2 = 0x1D;
  }
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v2);
  if ( *(_WORD *)(*(_DWORD *)((char *)v14 + 0xAB) + 0x8C7) == 1 )
  {
    v3 = 0x1C;
  }
  else
  {
    v3 = 0x1D;
  }
  v10 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(v3);
  v9 = *(unsigned __int16 *)(*(_DWORD *)((char *)v14 + 0xAB) + 0x8C7);
  v8 = V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex];
  v4 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x97);
  sprintf(s, v4, v8, v9, v10, v1, sub_1CEA8);
  Unknown_02 = V_Game.races[V_PlayerRaceIndex].Unknown_02;
  p_x0 = (PANE *)&CONTAINING_RECORD(v14, PANE, window)->x0;
  WinMgr.LargeFont.pane.window = (WINDOW *)v14[1];
  v6 = v14 + 2;
  WinMgr.LargeFont.pane.x0 = v14[2];
  WinMgr.LargeFont.pane.y0 = *++v6;
  WinMgr.LargeFont.pane.x1 = *++v6;
  WinMgr.LargeFont.pane.y1 = v6[1];
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x19, 9, s, 2, 4 * Unknown_02 + 0x13, 0xFF, 0);
  Q_WINMGR_CPP_sub_53E38(p_x0, 3, 3, V_PlayerRaceIndex);
  sub_2D218(v14);
}

//----- (00051894) --------------------------------------------------------
int __fastcall Q_Wnd16SW_Proc3_sub_51894(int a1, __int16 a2, __int16 a3, LONG a4)
{
  T_WndA2 *Wnd_sub_56DA8; // eax
  WORD v7; // di
  T_Planet *v8; // esi
  unsigned __int16 v9; // ax
  T_Planet *ItemData_sub_2ED14; // eax

  if ( (unsigned __int16)a2 < 2u )
  {
    if ( a2 != 1 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
    }
    if ( !*(_DWORD *)(a1 + 0xAB) )
    {
      Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "STATPLANLST", 0);
      *(_DWORD *)(a1 + 0xAB) = Wnd_sub_56DA8;
      if ( !Wnd_sub_56DA8 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x1CB);
      }
      *(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xAB) = 0;
      *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8C9) = 0x8D;
      Q_Wnd10LB_SetProc1_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), sub_50530);
      Q_Wnd10LB_SetCompareProc_sub_2F1D8(*(P_Wnd10LB *)(a1 + 0xAB), Q_CompareListBoxItems_sub_10A14);
      *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + 0xC5) = 0;
      *(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xBB) = 0xFFFFFFFF;
    }
    if ( (unsigned __int16)word_96B2C == 0xFFFF )
    {
      LOWORD(word_96B2C) = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\planets.shp", 0);
      if ( (unsigned __int16)word_96B2C == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x1D9);
      }
    }
    if ( (unsigned __int16)word_96B2A == 0xFFFF )
    {
      LOWORD(word_96B2A) = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\suns.shp", 0);
      if ( (unsigned __int16)word_96B2A == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x1E0);
      }
    }
    sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xAB));
    if ( V_Game.planetsNum > 0 )
    {
      v7 = 0;
      do
      {
        v8 = &V_Game.planets[v7];
        if ( v8->raceIndex == V_PlayerRaceIndex )
        {
          v9 = Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(a1 + 0xAB), (BYTE *)v8, 0x96, 0);
          Q_Wnd10LB_SetItemValue_sub_2EC50(*(P_Wnd10LB *)(a1 + 0xAB), v9, v8->dayColonized);
        }
        ++v7;
      }
      while ( v7 < V_Game.planetsNum );
    }
    Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(*(P_Wnd10LB *)(a1 + 0xAB));
    sub_2ECDC(*(P_Wnd10LB *)(a1 + 0xAB), *(_WORD *)(a1 + 0xAF));
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  else if ( (unsigned __int16)a2 <= 2u )
  {
    *(_WORD *)(a1 + 0xAF) = *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8CD);
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
  }
  else
  {
    if ( a2 != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
    }
    ItemData_sub_2ED14 = (T_Planet *)Q_Wnd10LB_GetItemData_sub_2ED14(*(P_Wnd10LB *)(a1 + 0xAB), a3);
    if ( V_Mouse.x <= 0x96 )
    {
      V_Game.pCurStar = &V_Game.stars[ItemData_sub_2ED14->starIndex];
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 1);
    }
    else
    {
      V_Game.pCurPlanet = ItemData_sub_2ED14;
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
    }
    *(_WORD *)(a1 + 0xAF) = *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8CD);
    return 0;
  }
}

//----- (00051B64) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd17FW_Ctor_sub_51B64(P_Wnd17FW a1)
{
  Q_A2Ctor_sub_2C830(&a1->a11.a);
  a1->a11.a.pProcs = &Wnd17FW_Procs;
  Q_A11_sub_516D4(&a1->a11);
}

//----- (00051B80) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd17FW_Dtor_sub_51B80(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd17FW);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = &Wnd17FW_Procs;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (00051BC4) --------------------------------------------------------
void __fastcall Q_Wnd17FW_Proc4_sub_51BC4(P_Wnd17FW pWnd, int a2)
{
  int MoreAllowedShips_sub_3EFE0; // eax
  int v3; // edx
  const char *v4; // eax
  char *sub_1CEA8; // eax
  UBYTE Unknown_02; // al
  LONG *p_x0; // esi
  char *v8; // [esp-10h] [ebp-68h]
  int itemCount; // [esp-Ch] [ebp-64h]
  const char *v10; // [esp-8h] [ebp-60h]
  char s[80]; // [esp+0h] [ebp-58h] BYREF
  P_Wnd17FW v12; // [esp+50h] [ebp-8h]
  PANE *p_pane; // [esp+54h] [ebp-4h]

  v12 = pWnd;
  MoreAllowedShips_sub_3EFE0 = Q_Race_GetMoreAllowedShips_sub_3EFE0(&V_Game.races[V_PlayerRaceIndex]);
  v3 = MoreAllowedShips_sub_3EFE0;
  if ( MoreAllowedShips_sub_3EFE0 >= 0 )
  {
    if ( MoreAllowedShips_sub_3EFE0 > 100 )
    {
      v3 = 100;
    }
  }
  else
  {
    v3 = 0;
  }
  if ( v12->a11.pListBox->itemCount == 1 )
  {
    v4 = (_BYTE *)&unk_92C97;
  }
  else
  {
    v4 = "s";
  }
  v10 = v4;
  itemCount = v12->a11.pListBox->itemCount;
  v8 = V_SpecNames[V_Game.races[V_PlayerRaceIndex]._nameIndex];
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x98);// 152: "%s  (%d Ship%s, %d more allowed)"
  sprintf(s, sub_1CEA8, v8, itemCount, v10, v3);
  Unknown_02 = V_Game.races[V_PlayerRaceIndex].Unknown_02;
  p_pane = &v12->a11.a.a1.pane;
  WinMgr.LargeFont.pane.window = v12->a11.a.a1.pane.window;
  p_x0 = &v12->a11.a.a1.pane.x0;
  WinMgr.LargeFont.pane.x0 = v12->a11.a.a1.pane.x0;
  WinMgr.LargeFont.pane.y0 = *++p_x0;
  WinMgr.LargeFont.pane.x1 = *++p_x0;
  WinMgr.LargeFont.pane.y1 = p_x0[1];
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x19, 9, s, 2, 4 * Unknown_02 + 0x13, 0xFF, 0);
  Q_WINMGR_CPP_sub_53E38(p_pane, 3, 3, V_PlayerRaceIndex);
  sub_2D218(v12);
}

//----- (00051D24) --------------------------------------------------------
int __fastcall Q_Wnd17FW_Proc3_sub_51D24(P_Wnd17FW pWnd, UWORD message, int param1, int param2)
{
  int result; // eax
  P_Wnd10LB pWnd10LB; // eax
  int shipsNum; // ebp
  P_Ship pShip; // esi
  unsigned __int16 newItemIndex; // ax
  int v10; // ecx
  int v11; // ebx
  UWORD v12; // dx
  T_Ship *pShip_1; // eax
  T_Ship *v14; // esi
  T_Wnd08SW *Wnd_sub_56DA8; // eax
  P_Ship shipsList[107]; // [esp+0h] [ebp-1C8h] BYREF
  int param2a; // [esp+1ACh] [ebp-1Ch]
  int param1a; // [esp+1B0h] [ebp-18h]
  UWORD v19; // [esp+1B4h] [ebp-14h]
  __int16 i; // [esp+1B8h] [ebp-10h]

  v19 = message;
  param1a = param1;
  param2a = param2;
  if ( message < 2u )
  {
    if ( message != 1 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v19, param1a, param2a);
    }
    if ( !pWnd->a11.pListBox )
    {
      pWnd10LB = (P_Wnd10LB)Q_FindWnd_sub_56DA8(&WinMgr, "STATSHIPLST", 0);
      pWnd->a11.pListBox = pWnd10LB;
      if ( !pWnd10LB )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x259);
      }
      pWnd->a11.pListBox->Unknown_AB = 0;
      pWnd->a11.pListBox->Unknown_8C9 = 106;
      Q_Wnd10LB_SetProc1_sub_2F1C8(pWnd->a11.pListBox, sub_50D70);
      Q_Wnd10LB_SetCompareProc_sub_2F1D8(pWnd->a11.pListBox, Q_CompareListBoxItems_sub_10A14);
      pWnd->a11.pListBox->Unknown_C5 = 0;
    }
    // data\smship00.shp .. data\smship06.shp
    smshipShpCacheIndex = GwshareShpCacheIndexes[V_PlayerRaceIndex + 14];
    if ( planetsShpCacheIndex == 0xFFFF )
    {
      planetsShpCacheIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\planets.shp", 0);
      if ( planetsShpCacheIndex == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x269);
      }
    }
    if ( sunsShpCacheIndex == 0xFFFF )
    {
      sunsShpCacheIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\suns.shp", 0);
      if ( sunsShpCacheIndex == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x270);
      }
    }
    sub_2ED4C(pWnd->a11.pListBox);
    shipsNum = Q_Race_GetShips_sub_40224(&V_Game.races[V_PlayerRaceIndex], shipsList, 0);
    for ( i = 0; i < shipsNum; ++i )
    {
      pShip = shipsList[i];
      newItemIndex = Q_Wnd10LB_AddItem_sub_2EA8C(pWnd->a11.pListBox, (BYTE *)pShip, 100, FALSE);
      Q_Wnd10LB_SetItemValue_sub_2EC50(pWnd->a11.pListBox, newItemIndex, pShip->_dayBuilt);
    }
    v10 = param2a;
    Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(pWnd->a11.pListBox);
    v11 = param1a;
    sub_2ECDC(pWnd->a11.pListBox, pWnd->Unknown_AF);
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v19, v11, v10);
  }
  else if ( message <= 2u )
  {
    v12 = v19;
    pWnd->Unknown_AF = pWnd->a11.pListBox->Unknown_8CD;
    return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v12, param1, param2);
  }
  else
  {
    if ( message != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424(&pWnd->a11.a, v19, param1a, param2a);
    }
    pShip_1 = (T_Ship *)Q_Wnd10LB_GetItemData_sub_2ED14(pWnd->a11.pListBox, param1a);
    v14 = pShip_1;
    if ( param2 == 5 )
    {
      Wnd_sub_56DA8 = (T_Wnd08SW *)Q_FindWnd_sub_56DA8(&WinMgr, "SHIPDESSCREEN", 0);
      sub_4DA7C(Wnd_sub_56DA8, v14, 0, 0xFFFFFFFF);
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 8, 1);
      pWnd->Unknown_AF = pWnd->a11.pListBox->Unknown_8CD;
      return 0xFFFFFFFF;
    }
    else
    {
      switch ( pShip_1->locationType )
      {
        case ASCEND_LOCATION_TYPE_SHIPYARD:
        case ASCEND_LOCATION_TYPE_SHIPDOCK:
        case ASCEND_LOCATION_TYPE_ORBIT:
          V_Game.pCurPlanet = pShip_1->pLocation.pPlanet;
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x11, 1);
          pWnd->Unknown_AF = pWnd->a11.pListBox->Unknown_8CD;
          result = 0xFFFFFFFF;
          break;
        case ASCEND_LOCATION_TYPE_SYSTEM:
          V_Game.pCurStar = pShip_1->pLocation.pStar;
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0x10, 1);
          pWnd->Unknown_AF = pWnd->a11.pListBox->Unknown_8CD;
          result = 0xFFFFFFFF;
          break;
        case ASCEND_LOCATION_TYPE_STARLANE:
          Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 3, 0, 0);
          result = 0xFFFFFFFF;
          break;
        default:
          result = 0;
          break;
      }
    }
  }
  return result;
}

//----- (000520EC) --------------------------------------------------------
void __fastcall __spoils<> Q_WndNGCtor_sub_520EC(P_WndNG a1)
{
  Q_A2Ctor_sub_2C830(&a1->a);
  a1->a.pProcs = (P_Procs)&off_960F8;
  Q_WndNG_sub_5214C(a1);
}
// 960F8: using guessed type int (__fastcall *off_960F8)(P_WndA2 a1);

//----- (00052108) --------------------------------------------------------
T_WndA2 *__fastcall Q_WndNGDtor_sub_52108(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_WndNG);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_960F8;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 960F8: using guessed type int (__fastcall *off_960F8)(P_WndA2 a1);

//----- (0005214C) --------------------------------------------------------
void __fastcall Q_WndNG_sub_5214C(P_WndNG result)
{
  result->Unknown_AF = 0;
  result->Unknown_AB = 0;
  result->Unknown_B3 = 0;
  result->Unknown_B5 = 0;
}

//----- (00052174) --------------------------------------------------------
int __fastcall sub_52174(int a1)
{
  int v1; // kr00_4
  FILE *v2; // edi
  int i; // esi

  *(_DWORD *)(a1 + 0xAF) = &unk_109DF8;
  v1 = *(_DWORD *)(a1 + 0xAF);
  v2 = Q_OpenFile_sub_1BB10("newgame.txt", 0);
  for ( i = 0; i < 0x15; ++i )
  {
    fgets((char *)(v1 + 0xC8 * i), 0xC7, v2);
  }
  return fclose(v2);
}

//----- (000521C0) --------------------------------------------------------
void __fastcall sub_521C0(int a1, int edx0)
{
  char *sub_1CEA8; // eax
  int v4; // edi
  void *ShapeTable_sub_1B084; // ecx
  void *v6; // ecx
  UWORD ItemIndex_sub_1B270; // ax
  void *v8; // eax
  int v9; // ebx
  char *v10; // eax
  int v11; // eax
  char *v12; // eax
  int v13; // kr1C_4
  int v14; // kr3C_4
  LONG v15; // ebx
  void *v16; // eax
  int i; // kr04_4
  int j; // kr0C_4
  int k; // kr14_4
  __int16 m; // si
  LONG v21; // [esp-Ch] [ebp-15Ch]
  int v22; // [esp-Ch] [ebp-15Ch]
  int v23; // [esp-8h] [ebp-158h]
  int v24; // [esp-4h] [ebp-154h]
  int v25; // [esp-4h] [ebp-154h]
  char s[280]; // [esp+0h] [ebp-150h] BYREF
  PANE pane; // [esp+118h] [ebp-38h] BYREF
  int a2[3]; // [esp+12Ch] [ebp-24h]
  int v29; // [esp+138h] [ebp-18h]

  v29 = edx0;
  sub_52714(a1);
  pane.window = *(WINDOW **)(a1 + 4);
  pane.x0 = 0x1F6;
  pane.y0 = 7;
  pane.x1 = 0x278;
  pane.y1 = 0x24;
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x99);// 153: "Player Species"
  sprintf(s, sub_1CEA8);
  WinMgr.LargeFont.pane = pane;
  v4 = v29;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, s, 3, 0xF3, 0xFF, 0x6E);
  if ( !v4 )
  {
    pane = *(PANE *)(a1 + 4);
    VFX_pane_wipe((PANE *)(a1 + 4), 0);
    pane.y1 = 0x23;
    WinMgr.LargeFont.pane = pane;
    Q_Font_DrawFormattedText_sub_2B8A8(
      &WinMgr.LargeFont,
      0,
      0,
      V_SpecNames[*(__int16 *)(a1 + 0xB3)],
      3,
      (unsigned __int8)byte_96779[*(__int16 *)(a1 + 0xB5)],
      0xFF,
      0);
    ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);
    if ( !ShapeTable_sub_1B084 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x325);
    }
    VFX_shape_draw((PANE *)(a1 + 4), ShapeTable_sub_1B084, *(__int16 *)(a1 + 0xB3), 0x4B, 0x55);
    v6 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x21]);
    if ( !v6 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x329);
    }
    VFX_shape_draw((PANE *)(a1 + 4), v6, *(__int16 *)(a1 + 0xB5), 0x4B, 0x55);
    ItemIndex_sub_1B270 = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\smhome.shp", 0xFFFFFFFF);
    if ( ItemIndex_sub_1B270 == 0xFFFF )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x334);
    }
    v21 = *(__int16 *)(a1 + 0xB3);
    v8 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, ItemIndex_sub_1B270);
    VFX_shape_draw((PANE *)(a1 + 4), v8, v21, 0x48, 0xCD);
    Q_WINMGR_CPP_sub_53E38((PANE *)(a1 + 4), 0x6B, 0xC1, V_PlayerRaceIndex);
    if ( !*(_DWORD *)(a1 + 0xAF) )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x340);
    }
    if ( *(__int16 *)(a1 + 0xB3) >= 0x15 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x341);
    }
    v9 = *(__int16 *)(a1 + 0xB3);
    v24 = *(_DWORD *)(a1 + 0xAF) + 0xC8 * v9;
    v10 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x9A);    // 154: "The %s %s"
    sprintf(s, v10, V_SpecNames[v9], v24);
    pane.y0 = 0x109;
    pane.y1 = *(_DWORD *)(a1 + 0x14);
    v11 = *(__int16 *)(a1 + 0xB5);
    WinMgr.SmallFont.pane = pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.SmallFont, 0, 0, s, 0, (unsigned __int8)byte_96779[v11], 0xFF, 0x96);
    for ( i = 0; i != 5; ++i )
    {
      *(_DWORD *)&s[4 * i + 0xF0] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(i + 0x9B);
    }
    for ( j = 0; j != 3; ++j )
    {
      a2[j] = (int)Q_CORN_CPP_StaticTxtRead_sub_1CEA8(j + 0xA0);
    }
    for ( k = 0; k != 5; ++k )
    {
      *(_DWORD *)&s[4 * k + 0x104] = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(k + 0xA3);
    }
    pane.x0 = 0x11;
    pane.y0 = 0x145;
    pane.x1 = 0x144;
    pane.y1 = 0x172;
    v25 = a2[*(__int16 *)(a1 + 0xBB)];
    v23 = *(_DWORD *)&s[4 * *(__int16 *)(a1 + 0xB9) + 0xF8];
    v22 = *(_DWORD *)&s[4 * *(__int16 *)(a1 + 0xB7) + 0xF0];
    v12 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xA8);    // 168: "%s Star Cluster\n%s Species\n%s Atmosphere"
    sprintf(s, v12, v22, v23, v25);
    WinMgr.LargeFont.pane = pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, s, 0x82, 0xFFFF, 0, 0xFA);
    Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, (PANE *)(a1 + 4));
    pane.window = V_Type6_stru_D8654.pane.window;
    pane.x1 = 0x18B;
    pane.y1 = 0x1CF;
    pane.x0 = 0x17D;
    pane.y0 = 0x1B1;
    v13 = 0;
    v14 = 0;
    for ( m = 0; m < 7; ++m )
    {
      v15 = *(__int16 *)(a1 + 0xB3);
      v16 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x20]);
      sub_53F40((T_Type5 *)&pane, v16, v15, 0, 0, m);
      if ( m == *(_WORD *)(a1 + 0xB5) )
      {
        Q_Pane_CopyOrDrawRectangle_sub_2BB74(&pane, 0, 0, 0xE, 0x18, 0xF3u, 0);
      }
      ++v13;
      ++v14;
    }
    Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, 0x17B, 0x1A4, 0x1ED, 0x1D8);
  }
}
/* Orphan comments:
155: "Vacuous"
160: "Peaceful"
163: "Three"
*/
// 521C0: using guessed type int a2[3];

//----- (000526D8) --------------------------------------------------------
unsigned int sub_526D8()
{
  if ( V_Mouse.x <= 0x1F6 || V_Mouse.x >= 0x278 || V_Mouse.y <= 0x17D || V_Mouse.y >= 0x1D8 )
  {
    return 0;
  }
  else
  {
    return 0xFFFFFFFF;
  }
}

//----- (00052714) --------------------------------------------------------
int __fastcall sub_52714(int a1)
{
  LONG v1; // edx
  int v2; // eax
  char *v3; // esi
  int v4; // ecx
  int v5; // edx
  int v6; // ebx
  char v7; // ah
  _DWORD *v8; // ebp
  void *ShapeTable_sub_1B084; // eax
  void *v10; // eax
  char *sub_1CEA8; // eax
  int v13; // edi
  LONG v14; // [esp-20h] [ebp-60h]
  PANE pane; // [esp+0h] [ebp-40h] BYREF
  int v16; // [esp+14h] [ebp-2Ch]
  int v17; // [esp+18h] [ebp-28h]
  T_WndA2 *v18; // [esp+1Ch] [ebp-24h]
  int v19; // [esp+20h] [ebp-20h]
  int v20; // [esp+24h] [ebp-1Ch]

  v16 = a1;
  pane.window = V_Type6_stru_D8654.pane.window;
  pane.x0 = 0x1F6;
  pane.y0 = 0x17D;
  pane.x1 = 0x278;
  v1 = 0xF2;
  pane.y1 = 0x1D8;
  if ( sub_526D8() == 0xFFFFFFFF )
  {
    v1 = 0x96;
  }
  VFX_pane_wipe(&pane, v1);
  Q_WinMgr_AddDirtyArea_sub_55274(&WinMgr, 0x1F6, 0x17D, 0x278, 0x1D8);
  v18 = sub_56E18(&WinMgr, "COSMOSWnd", 3, 0);
  if ( !v18 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x3BB);
  }
  HIWORD(v2) = HIWORD(v18);
  LOWORD(v2) = v18[8].a1.Unknown_1A;
  v20 = v2;
  if ( (__int16)v2 > 0 )
  {
    v3 = (char *)&v18[2].a1.Unknown_1A + 2;
    v13 = 0;
    do
    {
      v6 = *(_DWORD *)&v3[4 * v13];
      v7 = *(_BYTE *)(v6 + 4);
      v19 = (int)(*(float *)(v6 + 0xD) + -1500.0);
      if ( !v7 )
      {
        v4 = 3;
        v8 = *(_DWORD **)v6;
        if ( v19 <= 0xDC )
        {
          if ( v19 <= 0 )
          {
            if ( v19 > (int)0xFFFFFF24 )
            {
              v4 = 2;
            }
          }
          else
          {
            v4 = 1;
          }
        }
        else
        {
          v4 = 0;
        }
        v5 = *(__int16 *)(v6 + 7);
        v17 = 5;
        VFX_shape_draw(&pane, (void *)v18[1].a1.magic12345678, 4 * *v8 + v4, *(__int16 *)(v6 + 5) / 5 + 5, v5 / 5 + 5);
      }
      ++v13;
    }
    while ( (__int16)v13 < (__int16)v20 );
  }
  v14 = *(__int16 *)(v16 + 0xB3);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x2A]);
  VFX_shape_transform(&pane, ShapeTable_sub_1B084, v14, 0x62, 0x24, V_BigBuffer, 0, 0x8000, 0x8000, 0);
  v10 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x29]);
  Q_DrawRaceTintedShape_sub_53EB8(&pane, v10, 3, 0x62, 0x24, 0);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xA9);// 169: "Begin New Game"
  WinMgr.LargeFont.pane = pane;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0x41, 0x50, sub_1CEA8, 0xC, 0xFFFF, 0xFF, 0);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (0005294C) --------------------------------------------------------
int __fastcall sub_5294C(int a1, __int16 dx0, LONG a3, LONG a4)
{
  T_WndA2 *v6; // kr00_4
  int j; // kr04_4
  T_Wnd02COSW *v8; // eax
  _DWORD *v9; // eax
  T_WndA2 *v10; // eax
  int v11; // eax
  T_WndA2 *Wnd_sub_56DA8; // eax
  __int16 i; // si
  int v14; // eax
  int v15; // eax
  int v16; // eax
  WORD v17; // bx
  UWORD v18; // dx
  int v19; // ecx
  int v20; // ebx
  WORD v21; // dx
  int v22; // ecx
  int v23; // ebx
  int v24; // ebx
  _WORD v25[3]; // [esp+0h] [ebp-42h]
  int v26; // [esp+6h] [ebp-3Ch]
  int v27; // [esp+Ah] [ebp-38h]
  int v28; // [esp+Eh] [ebp-34h]
  int v29; // [esp+12h] [ebp-30h]
  PANE a2; // [esp+16h] [ebp-2Ch] BYREF
  int param2; // [esp+2Ah] [ebp-18h]
  int param1; // [esp+2Eh] [ebp-14h]
  __int16 v33; // [esp+32h] [ebp-10h]

  v33 = dx0;
  param1 = a3;
  param2 = a4;
  *(_DWORD *)&v25[1] = dword_96B74[0];
  v26 = dword_96B74[1];
  v27 = dword_96B74[2];
  v28 = dword_96B74[3];
  v29 = dword_96B74[4];
  if ( (unsigned __int16)dx0 < 0x1F5u )
  {
    if ( (unsigned __int16)dx0 < 2u )
    {
      if ( dx0 == 1 )
      {
        Q_SaveGam_sub_54048("resume.gam");
        dword_96BC0 = 0xFFFFFFFF;
        v11 = *(_DWORD *)(a1 + 0xAB);
        WinMgr.Unknown_24DA0 = 0;
        if ( !v11 )
        {
          Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(&WinMgr, "RACELIST", 0);
          *(_DWORD *)(a1 + 0xAB) = Wnd_sub_56DA8;
          if ( !Wnd_sub_56DA8 )
          {
            Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x463);
          }
          *(_DWORD *)(*(_DWORD *)(a1 + 0xAB) + 0xAB) = 0;
          *(_WORD *)(*(_DWORD *)(a1 + 0xAB) + 0x8C9) = 0x6D;
          Q_Wnd10LB_SetProc1_sub_2F1C8(*(P_Wnd10LB *)(a1 + 0xAB), sub_51610);
          sub_2E9CC(*(P_Wnd10LB *)(a1 + 0xAB), 0);
          *(_BYTE *)(*(_DWORD *)(a1 + 0xAB) + 0xC6) = 0xF2;
        }
        sub_2ED4C(*(P_Wnd10LB *)(a1 + 0xAB));
        for ( i = 0; i < 0x15; ++i )
        {
          Q_Wnd10LB_AddItem_sub_2EA8C(*(P_Wnd10LB *)(a1 + 0xAB), (BYTE *)i, 0x73, 0);
        }
        v14 = *(_DWORD *)(a1 + 0x67);
        *(_WORD *)(a1 + 0xB7) = 2;
        *(_DWORD *)(*(_DWORD *)v14 + 0x72) = 2;
        v15 = *(_DWORD *)(a1 + 0x67);
        *(_WORD *)(a1 + 0xB9) = 5;
        *(_DWORD *)(*(_DWORD *)(v15 + 4) + 0x72) = 7;
        v16 = *(_DWORD *)(a1 + 0x67);
        *(_WORD *)(a1 + 0xBB) = 1;
        *(_DWORD *)(*(_DWORD *)(v16 + 8) + 0x72) = 0xB;
        v17 = *(_WORD *)(a1 + 0xB9);
        V_Game.atmosphere = 1;
        *(_WORD *)(a1 + 0xB3) = 0;
        sub_1E10C(&V_Game, v25[2 * *(__int16 *)(a1 + 0xB7) + 1], v17, *(_WORD *)(a1 + 0xB3));
        *(_WORD *)(a1 + 0xB5) = 0;
        V_PlayerRaceIndex = 0;
        V_Game.races[0]._nameIndex = 0;
        sub_1EE08((int)&V_Game, *(_WORD *)(a1 + 0xB5));
        a2.window = *(WINDOW **)(a1 + 4);
        a2.y1 = 0x1D8;
        a2.x0 = 0x17B;
        a2.y0 = 0x1A4;
        a2.x1 = 0x1ED;
        VFX_pane_wipe(&a2, 0xF2);
        Q_WinMgr_AddDirtyArea_sub_552CC(&WinMgr, &a2);
        v18 = v33;
        v19 = param2;
        v20 = param1;
        sub_52174(a1);
        return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v18, v20, v19);
      }
    }
    else
    {
      if ( (unsigned __int16)dx0 <= 2u )
      {
        return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v33, a3, a4);
      }
      if ( (unsigned __int16)dx0 >= 4u )
      {
        if ( (unsigned __int16)dx0 <= 5u )
        {
          if ( a3 <= 0x17B || a3 >= 0x1ED || a4 <= 0x1A4 || a4 >= 0x1D8 )
          {
            if ( sub_526D8() == 0xFFFFFFFF )
            {
              Q_StartSample_sub_4FB90(&V_SoundSystem, 0);
              sub_1F404(&V_Game);
              sub_1F038(&V_Game);
              v6 = Q_FindWnd_sub_56DA8(&WinMgr, "BatModeWnd", 0);
              for ( j = 0; j != 0x64; ++j )
              {
                *(_DWORD *)((char *)&v6[0x1D].a1.shapeFrame + 4 * j + 1) = 0;
              }
              v8 = (T_Wnd02COSW *)Q_FindWnd_sub_56DA8(&WinMgr, "COSMOSWnd", 0);
              sub_2280C(v8);
              v9 = (int *)((char *)&Q_FindWnd_sub_56DA8(&WinMgr, "RESWIN", 0)[1].a1._t19[0]._shapeNumber + 2);
              v9[1] = 0;
              v9[2] = 0;
              *v9 = 0x3F800000;
              v9[3] = 0;
              v9[4] = 0x3F800000;
              v9[5] = 0;
              v9[6] = 0;
              v9[7] = 0;
              v9[8] = 0x3F800000;
              v10 = Q_FindWnd_sub_56DA8(&WinMgr, "RACECONTROLS", 0);
              if ( !v10 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\status.cpp", 0x444);
              }
              sub_2DD70((int)v10);
              V_Game.atmosphere = *(_BYTE *)(a1 + 0xBB);
              sub_1EEA4(&V_Game);
              dword_96BC0 = 0;
              Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 1, 0xC, 0);
              return 0xFFFFFFFF;
            }
            else
            {
              return 0;
            }
          }
          else
          {
            Q_StartSample_sub_4FB90(&V_SoundSystem, 0);
            *(_WORD *)(a1 + 0xB5) = (a3 - 0x17B) / 0x10;
            sub_1EE08((int)&V_Game, *(_WORD *)(a1 + 0xB5));
            (*(void (__cdecl **)(_DWORD, int, int, int, int))(*(_DWORD *)(a1 + 0xA7) + 0xC))(*(_DWORD *)&v25[1], v26, v27, v28, v29);
            return 0xFFFFFFFF;
          }
        }
        if ( dx0 == 0xC )
        {
          if ( a3 > 0x17B && a3 < 0x1ED && a4 > 0x1A4 && a4 < 0x1D8 )
          {
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)"pcolor", 0);
            return 0xFFFFFFFF;
          }
          if ( sub_526D8() == 0xFFFFFFFF )
          {
            Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 5, (LONG)"beghelp", 0);
            return 0xFFFFFFFF;
          }
        }
      }
    }
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v33, param1, param2);
  }
  if ( (unsigned __int16)dx0 <= 0x1F5u )
  {
    if ( ++*(_WORD *)(a1 + 0xB7) == 5 )
    {
      *(_WORD *)(a1 + 0xB7) = 0;
    }
    v22 = *(__int16 *)(a1 + 0xB3);
    v23 = *(__int16 *)(a1 + 0xB9);
    sub_1E10C(&V_Game, v25[2 * *(__int16 *)(a1 + 0xB7) + 1], v23, v22);
    sub_24D30((int)WinMgr.wnds[dword_96BAC].pWndA2, dword_96BAC, v23, v22);
    (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
    *(_DWORD *)(**(_DWORD **)(a1 + 0x67) + 0x72) = *(__int16 *)(a1 + 0xB7);
    (*(void (__cdecl **)(_DWORD, int, int, int, int))(*(_DWORD *)(**(_DWORD **)(a1 + 0x67) + 0xA7) + 0xC))(
      *(_DWORD *)&v25[1],
      v26,
      v27,
      v28,
      v29);
    return 0xFFFFFFFF;
  }
  if ( (unsigned __int16)dx0 < 0x1F9u )
  {
    if ( dx0 == 0x1F7 )
    {
      if ( ++*(_WORD *)(a1 + 0xB9) == 8 )
      {
        *(_WORD *)(a1 + 0xB9) = 3;
      }
      v24 = *(__int16 *)(a1 + 0xB3);
      sub_1E70C(&V_Game, *(_WORD *)(a1 + 0xB9), v24);
      sub_24D30((int)WinMgr.wnds[dword_96BAC].pWndA2, dword_96BAC, v24, a4);
      (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
      *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a1 + 0x67) + 4) + 0x72) = *(__int16 *)(a1 + 0xB9) + 2;
      (*(void (__cdecl **)(_DWORD, int, int, int, int))(*(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a1 + 0x67) + 4) + 0xA7) + 0xC))(
        *(_DWORD *)&v25[1],
        v26,
        v27,
        v28,
        v29);
      return 0xFFFFFFFF;
    }
    return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v33, param1, param2);
  }
  if ( (unsigned __int16)dx0 <= 0x1F9u )
  {
    if ( ++*(_WORD *)(a1 + 0xBB) == 3 )
    {
      *(_WORD *)(a1 + 0xBB) = 0;
    }
    (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
    *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a1 + 0x67) + 8) + 0x72) = *(__int16 *)(a1 + 0xBB) + 0xA;
    (*(void (__cdecl **)(_DWORD, int, int, int, int))(*(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a1 + 0x67) + 8) + 0xA7) + 0xC))(
      *(_DWORD *)&v25[1],
      v26,
      v27,
      v28,
      v29);
    return 0xFFFFFFFF;
  }
  else
  {
    if ( (unsigned __int16)dx0 <= 0x1FAu || dx0 != 0x1C01 )
    {
      return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, v33, param1, param2);
    }
    if ( *(__int16 *)(a1 + 0xB3) != a3 )
    {
      v21 = *(_WORD *)(a1 + 0xB9);
      *(_WORD *)(a1 + 0xB3) = param1;
      sub_1E70C(&V_Game, v21, *(_WORD *)(a1 + 0xB3));
      (*(void (__cdecl **)(_DWORD, int, int, int, int))(*(_DWORD *)(a1 + 0xA7) + 0xC))(*(_DWORD *)&v25[1], v26, v27, v28, v29);
    }
    return 0xFFFFFFFF;
  }
}
// 96B74: using guessed type _DWORD dword_96B74[5];
// 96BAC: using guessed type int dword_96BAC;
// 96BC0: using guessed type int dword_96BC0;

//----- (00053000) --------------------------------------------------------
void __fastcall Q_Vector3D_Normalize_sub_53000(P_Vector3D pVector)
{
  double invLength; // st7
  float length; // [esp+Ch] [ebp-8h]

  length = sqrt(pVector->y * pVector->y + pVector->x * pVector->x + pVector->z * pVector->z);
  if ( length > 0.0 )
  {
    invLength = 1.0 / length;
    pVector->x = pVector->x * invLength;
    pVector->y = pVector->y * invLength;
    pVector->z = invLength * pVector->z;
  }
}

//----- (00053054) --------------------------------------------------------
void __fastcall Q_Vector3D_SetLength_sub_53054(P_Vector3D pVector, float length)
{
  Q_Vector3D_Normalize_sub_53000(pVector);
  pVector->x = pVector->x * length;
  pVector->y = pVector->y * length;
  pVector->z = length * pVector->z;
}

//----- (00053078) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_IsZeroVector_sub_53078(P_Vector3D v)
{
  if ( (LODWORD(v->x) & 0x7FFFFFFF) != 0 || (LODWORD(v->y) & 0x7FFFFFFF) != 0 || (LODWORD(v->z) & 0x7FFFFFFF) != 0 )
  {
    return FALSE;
  }
  else
  {
    return TRUE;
  }
}

//----- (0005309C) --------------------------------------------------------
double __fastcall sub_5309C(float *a1, float *a2)
{
  double x; // st7
  float v4; // [esp+8h] [ebp-4h]
  float v5; // [esp+8h] [ebp-4h]

  v4 = a1[1] * a2[1] + *a1 * *a2 + a1[2] * a2[2];
  v5 = v4 / sqrt(a1[1] * a1[1] + *a1 * *a1 + a1[2] * a1[2]);
  x = v5 / sqrt(a2[1] * a2[1] + *a2 * *a2 + a2[2] * a2[2]);
  return acos(x) * 57.29578;
}

//----- (00053114) --------------------------------------------------------
void __fastcall __spoils<> Q_M33xV_sub_53114(P_Vector3D v, T_Matrix3x3 *m)
{
  T_Vector3D v0; // [esp+0h] [ebp-1Ch]

  v0 = *v;
  v->x = v0.y * m->_[0][1] + v->x * m->_[0][0] + v0.z * m->_[0][2];
  v->y = v0.y * m->_[1][1] + v0.x * m->_[1][0] + v0.z * m->_[1][2];
  v->z = v0.y * m->_[2][1] + v0.x * m->_[2][0] + v0.z * m->_[2][2];
}

//----- (0005323C) --------------------------------------------------------
P_Vector3D __fastcall sub_5323C(P_Vector3D result, float a2)
{
  P_Vector3D v5; // edx
  double v6; // st7
  float v7; // [esp+Ch] [ebp-14h]

  v5 = result;
  if ( (LODWORD(a2) & 0x7FFFFFFF) != 0 )
  {
    v7 = cos(a2 * 0.017453292);
    v6 = sin(a2 * 0.017453292);
    result = (P_Vector3D)LODWORD(v5->y);
    v5->y = *(float *)&result * v7 - v5->z * v6;
    v5->z = v6 * *(float *)&result + v5->z * v7;
  }
  return result;
}
// 5323C: could not find valid save-restore pair for esi

//----- (000532AC) --------------------------------------------------------
void __fastcall Q_RotateVectorY_sub_532AC(T_Vector3D *vector, float degrees)
{
  double b; // st7
  float x; // [esp+8h] [ebp-18h]
  float a; // [esp+Ch] [ebp-14h]

  if ( (LODWORD(degrees) & 0x7FFFFFFF) != 0 )
  {
    a = cos(degrees * 0.017453292);
    b = sin(degrees * 0.017453292);
    x = vector->x;
    vector->x = vector->z * b + vector->x * a;
    vector->z = vector->z * a - b * x;
  }
}
// 532AC: could not find valid save-restore pair for esi

//----- (00053318) --------------------------------------------------------
float *__fastcall sub_53318(float *result, float a2)
{
  float *v5; // edx
  double v6; // st7
  float v7; // [esp+8h] [ebp-18h]
  float v8; // [esp+Ch] [ebp-14h]

  v5 = result;
  if ( (LODWORD(a2) & 0x7FFFFFFF) != 0 )
  {
    v8 = cos(a2 * 0.017453292);
    v6 = sin(a2 * 0.017453292);
    result = *(float **)v5;
    v7 = *v5;
    *v5 = *v5 * v8 - v5[1] * v6;
    v5[1] = v6 * v7 + v5[1] * v8;
  }
  return result;
}
// 53318: could not find valid save-restore pair for esi

//----- (00053384) --------------------------------------------------------
void __fastcall __spoils<> Q_M34xV_sub_53384(P_Vector3D v, T_Matrix3x4 *trs, P_Vector3D result)
{
  result->x = trs->_[0][1] * v->y + trs->_[0][0] * v->x + trs->_[0][2] * v->z + trs->_[0][3];
  result->y = trs->_[1][1] * v->y + trs->_[1][0] * v->x + trs->_[1][2] * v->z + trs->_[1][3];
  result->z = trs->_[2][1] * v->y + trs->_[2][0] * v->x + trs->_[2][2] * v->z + trs->_[2][3];
}

//----- (000533D4) --------------------------------------------------------
void __fastcall Q_Project3DTo2D_sub_533D4(P_Vector3D v, float scaleFactor, int xOffset, int yOffset, WORD *outX, WORD *outY)
{
  double zreciprocal; // st5
  double v7; // st7

  zreciprocal = 1.0 / v->z;
  v7 = scaleFactor * v->y * zreciprocal;
  *outX = (int)(v->x * scaleFactor * zreciprocal + 0.5);
  *outY = (int)(v7 + 0.5);
  *outX += xOffset;
  *outY += yOffset;
}

//----- (00053440) --------------------------------------------------------
// Snaps a 3D vector's components to a grid of specified size
void __fastcall Q_Vector3D_SnapToGrid_sub_53440(P_Vector3D pVector)
{
  int gridSize; // ebx
  int xOffset; // eax
  int v1; // ett
  int yOffset; // eax
  int v2; // ett
  int zOffset; // eax
  int v3; // ett

  gridSize = V_GridSize;
  // Process X component
  if ( pVector->x < 0.0 )
  {
    xOffset = -V_GridSize;
  }
  else
  {
    xOffset = V_GridSize;
  }
  v1 = (int)((double)(xOffset / 2) + pVector->x);
  pVector->x = (float)(V_GridSize * (v1 / V_GridSize));
  // Process Y component
  if ( pVector->y < 0.0 )
  {
    yOffset = -gridSize;
  }
  else
  {
    yOffset = gridSize;
  }
  v2 = (int)((double)(yOffset / 2) + pVector->y);
  pVector->y = (float)(gridSize * (v2 / gridSize));
  // Process Z component
  if ( pVector->z < 0.0 )
  {
    zOffset = -gridSize;
  }
  else
  {
    zOffset = gridSize;
  }
  v3 = (int)((double)(zOffset / 2) + pVector->z);
  pVector->z = (float)(gridSize * (v3 / gridSize));
  V_GridSize = gridSize;
}
// 96B88: using guessed type int V_GridSize;

//----- (0005353C) --------------------------------------------------------
void __fastcall sub_5353C(float *a1, int a2, int a3, int a4, int a5)
{
  if ( (a5 & 0x7FFFFFFF) != 0 )
  {
    sub_5323C((P_Vector3D)a1 + 2, *(float *)&a5);
    sub_53644(a1, (int)a1, a5, a4);
  }
}

//----- (00053564) --------------------------------------------------------
void __fastcall sub_53564(float *a1, int edx0, int a3, int a4, int a2)
{
  if ( (a2 & 0x7FFFFFFF) != 0 )
  {
    Q_RotateVectorY_sub_532AC((T_Vector3D *)a1 + 2, *(float *)&a2);
    sub_53754(a1, (int)a1, a2, a4);
  }
}

//----- (0005358C) --------------------------------------------------------
void __userpurge sub_5358C(P_Matrices a1@<eax>, float a2)
{
  if ( (LODWORD(a2) & 0x7FFFFFFF) != 0 )
  {
    sub_53318(a1->matrix_00._[1], a2);
    sub_53864((P_Matrix)a1);
  }
}

//----- (000535B4) --------------------------------------------------------
void __fastcall sub_535B4(P_Matrices a1, float a2)
{
  if ( (LODWORD(a2) & 0x7FFFFFFF) != 0 )
  {
    sub_5323C((P_Vector3D)a1->matrix_00._[2], a2);
    sub_5323C((P_Vector3D)a1->matrix_00._[1], a2);
    sub_53864((P_Matrix)a1);
  }
}

//----- (000535E4) --------------------------------------------------------
void __userpurge sub_535E4(P_Matrices a1@<eax>, float degrees)
{
  if ( (LODWORD(degrees) & 0x7FFFFFFF) != 0 )
  {
    Q_RotateVectorY_sub_532AC((T_Vector3D *)a1->matrix_00._[2], degrees);
    Q_RotateVectorY_sub_532AC((T_Vector3D *)a1->matrix_00._[1], degrees);
    sub_53864((P_Matrix)a1);
  }
}

//----- (00053644) --------------------------------------------------------
void __fastcall sub_53644(float *a1, int a2, int a3, int a4)
{
  double v5; // st7
  double v6; // st6
  double v7; // st7
  double v8; // st6
  float v9; // [esp+0h] [ebp-48h]
  float v10; // [esp+4h] [ebp-44h]
  float v11; // [esp+8h] [ebp-40h]
  float v12; // [esp+Ch] [ebp-3Ch] BYREF
  float v13; // [esp+10h] [ebp-38h]
  float v14; // [esp+14h] [ebp-34h]
  float v15; // [esp+18h] [ebp-30h]
  float v16; // [esp+1Ch] [ebp-2Ch]
  float v17; // [esp+20h] [ebp-28h]
  float v18; // [esp+24h] [ebp-24h] BYREF
  float v19; // [esp+28h] [ebp-20h]
  float v20; // [esp+2Ch] [ebp-1Ch]
  float *v21; // [esp+30h] [ebp-18h]
  float *v22; // [esp+34h] [ebp-14h]

  Q_Vector3D_Normalize_sub_53000((P_Vector3D)a1);
  v21 = &v12;
  v15 = 0.0;
  v16 = 0.0;
  v17 = 0.0;
  v15 = a1[7] * a1[2] - a1[8] * a1[1];
  v16 = a1[8] * *a1 - a1[6] * a1[2];
  v5 = a1[6] * a1[1];
  v6 = a1[7] * *a1;
  v12 = v15;
  v17 = v5 - v6;
  v13 = v16;
  v14 = v17;
  a1[3] = v15;
  a1[4] = v13;
  a1[5] = v14;
  Q_Vector3D_Normalize_sub_53000((P_Vector3D)a1 + 1);
  v22 = &v18;
  v9 = a1[1] * a1[5] - a1[2] * a1[4];
  v10 = a1[2] * a1[3] - *a1 * a1[5];
  v7 = *a1 * a1[4];
  v8 = a1[1] * a1[3];
  v18 = v9;
  v11 = v7 - v8;
  v19 = v10;
  v20 = v11;
  a1[6] = v9;
  a1[7] = v19;
  a1[8] = v20;
  Q_Vector3D_Normalize_sub_53000((P_Vector3D)a1 + 2);
}

//----- (00053754) --------------------------------------------------------
void __fastcall sub_53754(float *a1, int a2, int a3, int a4)
{
  float *v5; // edx
  double v6; // st7
  double v7; // st6
  double v8; // st7
  double v9; // st6
  float v10; // [esp+0h] [ebp-48h]
  float v11; // [esp+4h] [ebp-44h]
  float v12; // [esp+8h] [ebp-40h]
  float v13; // [esp+Ch] [ebp-3Ch] BYREF
  float v14; // [esp+10h] [ebp-38h]
  float v15; // [esp+14h] [ebp-34h]
  float v16; // [esp+18h] [ebp-30h]
  float v17; // [esp+1Ch] [ebp-2Ch]
  float v18; // [esp+20h] [ebp-28h]
  float v19; // [esp+24h] [ebp-24h] BYREF
  float v20; // [esp+28h] [ebp-20h]
  float v21; // [esp+2Ch] [ebp-1Ch]
  float *v22; // [esp+30h] [ebp-18h]
  float *v23; // [esp+34h] [ebp-14h]

  v5 = a1 + 3;
  Q_Vector3D_Normalize_sub_53000((P_Vector3D)a1 + 1);
  v16 = 0.0;
  v17 = 0.0;
  v18 = 0.0;
  v22 = &v13;
  v16 = v5[1] * a1[8] - v5[2] * a1[7];
  v17 = v5[2] * a1[6] - *v5 * a1[8];
  v6 = *v5 * a1[7];
  v7 = v5[1] * a1[6];
  v13 = v16;
  v18 = v6 - v7;
  v14 = v17;
  v15 = v18;
  *a1 = v16;
  a1[1] = v14;
  a1[2] = v15;
  Q_Vector3D_Normalize_sub_53000((P_Vector3D)a1);
  v23 = &v19;
  v10 = a1[1] * v5[2] - a1[2] * v5[1];
  v11 = a1[2] * *v5 - *a1 * v5[2];
  v8 = *a1 * v5[1];
  v9 = a1[1] * *v5;
  v19 = v10;
  v12 = v8 - v9;
  v20 = v11;
  v21 = v12;
  a1[6] = v10;
  a1[7] = v20;
  a1[8] = v21;
  Q_Vector3D_Normalize_sub_53000((P_Vector3D)a1 + 2);
}

//----- (00053864) --------------------------------------------------------
void __fastcall sub_53864(P_Matrix a1)
{
  T_Vector3D *p_vector3; // edx
  T_Vector3D *p_vector2; // ecx
  double v4; // st7
  double v5; // st6
  double v6; // st7
  double v7; // st6
  float v8; // [esp+0h] [ebp-48h]
  float v9; // [esp+4h] [ebp-44h]
  float v10; // [esp+8h] [ebp-40h]
  float v11; // [esp+Ch] [ebp-3Ch] BYREF
  float v12; // [esp+10h] [ebp-38h]
  float v13; // [esp+14h] [ebp-34h]
  float v14; // [esp+18h] [ebp-30h]
  float v15; // [esp+1Ch] [ebp-2Ch]
  float v16; // [esp+20h] [ebp-28h]
  float v17; // [esp+24h] [ebp-24h] BYREF
  float v18; // [esp+28h] [ebp-20h]
  float v19; // [esp+2Ch] [ebp-1Ch]
  float *v20; // [esp+30h] [ebp-18h]
  float *v21; // [esp+34h] [ebp-14h]

  p_vector3 = &a1->vector3;
  p_vector2 = &a1->vector2;
  Q_Vector3D_Normalize_sub_53000(&a1->vector3);
  v14 = 0.0;
  v15 = 0.0;
  v16 = 0.0;
  v20 = &v11;
  v14 = p_vector2->y * p_vector3->z - p_vector2->z * p_vector3->y;
  v15 = p_vector2->z * p_vector3->x - p_vector2->x * p_vector3->z;
  v4 = p_vector2->x * p_vector3->y;
  v5 = p_vector2->y * p_vector3->x;
  v11 = v14;
  v16 = v4 - v5;
  v12 = v15;
  v13 = v16;
  a1->vector1.x = v14;
  a1->vector1.y = v12;
  a1->vector1.z = v13;
  Q_Vector3D_Normalize_sub_53000(&a1->vector1);
  v21 = &v17;
  v8 = p_vector3->y * a1->vector1.z - p_vector3->z * a1->vector1.y;
  v9 = p_vector3->z * a1->vector1.x - p_vector3->x * a1->vector1.z;
  v6 = p_vector3->x * a1->vector1.y;
  v7 = p_vector3->y * a1->vector1.x;
  v17 = v8;
  v10 = v6 - v7;
  v18 = v9;
  v19 = v10;
  p_vector2->x = v8;
  p_vector2->y = v18;
  p_vector2->z = v19;
  Q_Vector3D_Normalize_sub_53000(p_vector2);
}

//----- (00053B08) --------------------------------------------------------
void __fastcall __spoils<> sub_53B08(T_Matrix3x4 *trs, T_Matrix3x3 *a, T_Matrix3x3 *r, P_Vector3D t)
{
  trs->_[0][0] = r->_[0][1] * a->_[0][1] + r->_[0][0] * a->_[0][0] + r->_[0][2] * a->_[0][2];
  trs->_[0][1] = r->_[1][1] * a->_[0][1] + r->_[1][0] * a->_[0][0] + r->_[1][2] * a->_[0][2];
  trs->_[0][2] = r->_[2][1] * a->_[0][1] + r->_[2][0] * a->_[0][0] + r->_[2][2] * a->_[0][2];
  trs->_[1][0] = r->_[0][1] * a->_[1][1] + r->_[0][0] * a->_[1][0] + r->_[0][2] * a->_[1][2];
  trs->_[1][1] = r->_[1][0] * a->_[1][0] + r->_[1][1] * a->_[1][1] + r->_[1][2] * a->_[1][2];
  trs->_[1][2] = r->_[2][0] * a->_[1][0] + r->_[2][1] * a->_[1][1] + r->_[2][2] * a->_[1][2];
  trs->_[2][0] = r->_[0][1] * a->_[2][1] + r->_[0][0] * a->_[2][0] + r->_[0][2] * a->_[2][2];
  trs->_[2][1] = r->_[1][0] * a->_[2][0] + r->_[1][1] * a->_[2][1] + r->_[1][2] * a->_[2][2];
  trs->_[2][2] = r->_[2][0] * a->_[2][0] + r->_[2][1] * a->_[2][1] + r->_[2][2] * a->_[2][2];
  trs->_[0][3] = t->y * a->_[0][1] + t->x * a->_[0][0] + t->z * a->_[0][2];
  trs->_[1][3] = t->y * a->_[1][1] + t->x * a->_[1][0] + t->z * a->_[1][2];
  trs->_[2][3] = t->y * a->_[2][1] + t->x * a->_[2][0] + t->z * a->_[2][2];
}

//----- (00053D22) --------------------------------------------------------
// write access to const memory has been detected, the output may be wrong!
int __cdecl sub_53D22(int a1)
{
  int v5; // edx
  unsigned int v6; // kr00_4
  int result; // eax
  __int16 v8; // [esp-Ah] [ebp-16h]
  void *retaddr; // [esp+10h] [ebp+4h]

  v6 = __readeflags();
  _disable();
  __asm { int     31h; DPMI Services   ax=func xxxxh }
  DMPI_selector_dword_53D1C = v5;
  DMPI_real_mode_segment_base_word_53D0C = 0x100;
  word_53CEA = 0;
  word_53D06 = 0x4F01;
  word_53D02 = a1;
  word_53D0E = 0;
  __asm { pushfw }
  word_53D0A = v8;
  __asm
  {
    int     31h; DPMI Services   ax=func xxxxh
    int     31h; DPMI Services   ax=func xxxxh
  }
  result = 0;
  _ZF = (BYTE1(retaddr) & 2) == 0;
  _disable();
  if ( !_ZF )
  {
    _enable();
  }
  __writeeflags(v6);
  return result;
}
// 53D37: write access to const memory at 53D1C has been detected
// 53D3D: write access to const memory at 53D0C has been detected
// 53D43: write access to const memory at 53CEA has been detected
// 53D51: write access to const memory at 53D06 has been detected
// 53D5A: write access to const memory at 53D02 has been detected
// 53D60: write access to const memory at 53D0E has been detected
// 53D6D: write access to const memory at 53D0A has been detected
// 53D37: variable 'v5' is possibly undefined
// 53D6D: variable 'v8' is possibly undefined
// 53CEA: using guessed type __int16 word_53CEA;
// 53D02: using guessed type __int16 word_53D02;
// 53D06: using guessed type __int16 word_53D06;
// 53D0A: using guessed type __int16 word_53D0A;
// 53D0C: using guessed type __int16 DMPI_real_mode_segment_base_word_53D0C;
// 53D0E: using guessed type __int16 word_53D0E;
// 53D1C: using guessed type int DMPI_selector_dword_53D1C;

//----- (00053DC0) --------------------------------------------------------
void sub_53DC0()
{
  _wcpp_2_mod_register_(&dword_96B8C);
  Q_WinMgr_Ctor_sub_54344(&WinMgr);
  dword_96B94 = 1;
}
// 96B8C: using guessed type _DWORD dword_96B8C;
// 96B94: using guessed type int dword_96B94;

//----- (00053DE4) --------------------------------------------------------
void __cdecl Q_Timer_sub_53DE4()
{
  ++V_Timer_dword_132B58;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00053DEC) --------------------------------------------------------
int Q_CheckFreeMemory_sub_53DEC()
{
  int chunk; // edx
  int largest; // ecx
  MACRO_VFX_BOOL finished; // edi
  void *tmp; // eax

  chunk = 0x2000000;
  largest = 0;
  finished = FALSE;
  do
  {
    tmp = malloc(largest + chunk);
    if ( tmp )
    {
      largest += chunk;
    }
    if ( largest == 0x2000000 || chunk < 0x1000 )
    {
      finished = TRUE;
    }
    free(tmp);
    chunk >>= 1;
  }
  while ( finished == FALSE );
  return largest;
}

//----- (00053E38) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_sub_53E38(PANE *pane, LONG hotX, LONG hotY, __int16 a4)
{
  void *shapeTable; // ebp

  if ( a4 >= V_Game.racesNum )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD0);
  }
  shapeTable = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x20]);
  if ( !shapeTable )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD5);
  }
  Q_DrawRaceTintedShape_sub_53EB8(pane, shapeTable, V_Game.races[a4]._nameIndex, hotX, hotY, a4);
}

//----- (00053EB8) --------------------------------------------------------
// Draws a shape with color tinting for a specific race.
void __fastcall Q_DrawRaceTintedShape_sub_53EB8(PANE *pane, void *shape_table, LONG shape_number, LONG hotX, LONG hotY, WORD raceIndex)
{
  UBYTE baseTintColor; // dl
  int colorIndex; // ecx
  __int16 i; // ax

  // Calculate base tint color for this race (scaled by 4 for intensity)
  baseTintColor = 4 * V_Game.races[raceIndex].Unknown_02 + 0x13;
  // Create a 4-color gradient in the lookaside table (indices 0x10-0x13)
  for ( i = 0; i < 4; ++i )
  {
    // Fill the table from high to low (0x13 -> 0x10)
    colorIndex = 0x13 - i;
    (*WinMgr.hazeTableMapRaces)[colorIndex] = baseTintColor--;
  }
  // Register our custom color translation table
  VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapRaces);
  // Draw the shape with color translation applied
  VFX_shape_translate_draw(pane, shape_table, shape_number, hotX, hotY);
}

//----- (00053F40) --------------------------------------------------------
void __fastcall sub_53F40(T_Type5 *a1, void *a2, LONG a3, LONG a4, int a5, char a6)
{
  UBYTE v8; // dl
  int v9; // ecx
  __int16 i; // ax

  v8 = 4 * a6 + 0x13;
  for ( i = 0; i < 4; ++i )
  {
    v9 = 0x13 - i;
    (*WinMgr.hazeTableMapRaces)[v9] = v8--;
  }
  VFX_shape_lookaside((UBYTE *)WinMgr.hazeTableMapRaces);
  VFX_shape_translate_draw((PANE *)a1, a2, a3, a4, a5);
}

//----- (00053FB0) --------------------------------------------------------
void __fastcall Q_LoadGam_sub_53FB0(const char *fname)
{
  char *sub_1CEA8; // eax
  T_CFile fi; // [esp+0h] [ebp-18Ch] BYREF
  char buf[116]; // [esp+118h] [ebp-74h] BYREF

  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( Q_CFile_OpenFile_sub_1BBFC(&fi, fname, O_BINARY, 0) )
  {
    sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAA);// 170: "Unable to open file."
    Q_ShowMsgBox_sub_556CC(&WinMgr, sub_1CEA8);
  }
  else
  {
    Q_ReadFile_sub_1BF94(&fi, buf, 0x74u);
    Q_Game_LoadGam_sub_21AA0(&V_Game, &fi);
    sub_56BE8(&WinMgr, 0xD, 0, 0, 0);
    Q_WinMgr_CallProc6_sub_5A294(&WinMgr, &fi, TRUE);
  }
  Q_CFile_Dtor_sub_1BBC8(&fi);
}

//----- (00054048) --------------------------------------------------------
T_CFile *__fastcall Q_SaveGam_sub_54048(const char *fname)
{
  T_CFile *result; // eax
  char *v1; // eax
  int i; // edx
  int j; // eax
  int k; // eax
  T_CFile fi; // [esp-118h] [ebp-198h] BYREF
  T_SavBlock0Header v7; // [esp+0h] [ebp-80h] BYREF

  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( Q_OpenFile_sub_1BCA8(&fi, fname) )
  {
    v1 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0xAA);     // 170: "Unable to open file."
    Q_ShowMsgBox_sub_556CC(&WinMgr, v1);
    result = &fi;
    Q_CFile_Dtor_sub_1BBC8(&fi);
  }
  else
  {
    v7.day = V_Game.day;
    v7.races = V_Game.racesNum;
    v7._playerRaceIndex = V_PlayerRaceIndex;
    for ( i = 0; i < V_Game.racesNum; ++i )
    {
      v7.z1[i] = V_Game.races[i]._nameIndex;
    }
    for ( j = 0; j < V_Game.racesNum; ++j )
    {
      v7.z2[j] = V_Game.races[j].Unknown_02;
    }
    for ( k = 0; k < V_Game.racesNum; ++k )
    {
      v7.z3[k] = V_Game.races[V_PlayerRaceIndex].treaties[k];
    }
    v7.playerShipsNum = Q_Race_GetShips_sub_40224(&V_Game.races[V_PlayerRaceIndex], 0, 0);
    v7.playerPlanetsNum = Q_Race_GetPlanetsNum_sub_402E0(&V_Game.races[V_PlayerRaceIndex]);
    v7.playerTechsNum = Q_Race_GetTechsNum_sub_40664(&V_Game.races[V_PlayerRaceIndex]);
    Q_CFile_DosWrite_sub_1C098(&fi, &v7, 0x74u);
    Q_Game_SaveGam_sub_21374(&V_Game, &fi);
    Q_WinMgr_CallProc6_sub_5A294(&WinMgr, &fi, FALSE);
    result = &fi;
    Q_CFile_Dtor_sub_1BBC8(&fi);
  }
  return result;
}
// 541F4: returning address of temporary local variable '%0x0'

//----- (00054208) --------------------------------------------------------
LONG __fastcall sub_54208(PANE *source)
{
  LONG result; // eax
  UBYTE *v2; // [esp+0h] [ebp-3Ch] BYREF
  LONG v3; // [esp+4h] [ebp-38h]
  LONG v4; // [esp+8h] [ebp-34h]
  int v5; // [esp+Ch] [ebp-30h]
  int v6; // [esp+10h] [ebp-2Ch]
  PANE target; // [esp+14h] [ebp-28h] BYREF

  v2 = V_BigBuffer;
  v3 = source->x1 - source->x0;
  v4 = source->y1 - source->y0;
  v5 = 0;
  v6 = 0;
  if ( v4 * v3 >= 160000 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x13E);
  }
  target.x1 = v3;
  target.y1 = v4;
  target.window = (WINDOW *)&v2;
  target.x0 = 0;
  target.y0 = 0;
  result = VFX_pane_copy(source, 0, 0, &target, 0, 0, 0xFFFFFFFF);
  if ( result )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x147);
  }
  return result;
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (000542B0) --------------------------------------------------------
LONG __fastcall Q_WINMGR_CPP_sub_542B0(PANE *target)
{
  UBYTE *v2; // [esp+0h] [ebp-3Ch] BYREF
  LONG v3; // [esp+4h] [ebp-38h]
  LONG v4; // [esp+8h] [ebp-34h]
  int v5; // [esp+Ch] [ebp-30h]
  int v6; // [esp+10h] [ebp-2Ch]
  PANE source; // [esp+14h] [ebp-28h] BYREF

  v2 = V_BigBuffer;
  v3 = target->x1 - target->x0;
  v4 = target->y1 - target->y0;
  v5 = 0;
  v6 = 0;
  if ( v4 * v3 >= 160000 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x158);
  }
  source.x1 = v3;
  source.y1 = v4;
  source.window = (WINDOW *)&v2;
  source.x0 = 0;
  source.y0 = 0;
  return VFX_pane_copy(&source, 0, 0, target, 0, 0, 0xFFFFFFFF);
}
// D8DA0: using guessed type UBYTE V_BigBuffer[94816];

//----- (00054344) --------------------------------------------------------
void __fastcall __spoils<> Q_WinMgr_Ctor_sub_54344(P_WinMgr a1)
{
  Q_Font_Init_sub_2B2C0(&a1->SmallFont);
  Q_Font_Init_sub_2B2C0(&a1->LargeFont);
  Q_Cache_Init_sub_1ACC0(&a1->cache);
  Q_WinMgr_Init_sub_54448(a1);
}

//----- (00054374) --------------------------------------------------------
void __fastcall Q_WinMgrDtor_sub_54374(P_WinMgr pWinMgr)
{
  __int16 i; // cx
  T_WndA2 *pWndA2; // eax
  __int16 j; // dx
  int v5; // edx
  T_WinMgr *v6; // eax

  for ( i = 0; i < 0x400; ++i )
  {
    if ( pWinMgr->wnds[i].pWndA2 )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(pWinMgr->wnds[i].pWndA2);
    }
    pWndA2 = pWinMgr->wnds[i].pWndA2;
    if ( pWndA2 )
    {
      pWndA2->pProcs->proc1(pWndA2, 2);
    }
  }
  for ( j = 0; j < 6; ++j )
  {
    if ( *(_DWORD *)&pWinMgr->z1c[4 * j] )
    {
      Q_RemoveWinDataFromWinMgr_sub_2627C(*(void **)&pWinMgr->z1c[4 * j]);
    }
    operator delete[](*(void **)&pWinMgr->z1c[4 * j]);
  }
  if ( pWinMgr->aaa == 0xFFFFFFFF )
  {
    v5 = 0xFFFFFFFF;
    v6 = pWinMgr;
LABEL_17:
    sub_59934(v6, v5);
    goto LABEL_18;
  }
  if ( pWinMgr->bbb == 0xFFFFFFFF )
  {
    v6 = pWinMgr;
    v5 = 0;
    goto LABEL_17;
  }
LABEL_18:
  sub_54664(pWinMgr);
  sub_1ACF4(&pWinMgr->cache);
  sub_2B2E0(&pWinMgr->LargeFont);
  sub_2B2E0(&pWinMgr->SmallFont);
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);

//----- (00054448) --------------------------------------------------------
T_WinData *__fastcall Q_WinMgr_Init_sub_54448(P_WinMgr pWinMgr)
{
  __int16 i; // ax
  int v3; // edx
  T_WinData *result; // eax

  pWinMgr->_activeStateCount = 0;
  pWinMgr->wndsCnt = 0;
  pWinMgr->state = 0xFFFF;
  pWinMgr->Unknown_4756 = 0;
  pWinMgr->Unknown_4758 = 0;
  pWinMgr->messageQueueCount = 0;
  pWinMgr->counter1 = 0;
  pWinMgr->winEventSmallNum = 0;
  pWinMgr->_wndIndex = 0xFFFFFFFF;
  pWinMgr->timer = 0xFFFFFFFF;
  pWinMgr->gameEventsNum = 0;
  pWinMgr->Unknown_475C = 0;
  pWinMgr->j = 1.0;
  V_Timer_dword_132B58 = 0;
  memset(pWinMgr->winStates, 0, sizeof(pWinMgr->winStates));
  memset(pWinMgr, 0, 0x3000u);                         // pWinMgr->wnds
  memset(pWinMgr->b1, 0, sizeof(pWinMgr->b1));
  memset(pWinMgr->winEventsSmall, 0, sizeof(pWinMgr->winEventsSmall));
  memset(pWinMgr->z1c, 0, 0x18u);
  memset(pWinMgr->Unknown_4736, 0xFFFFFFFF, sizeof(pWinMgr->Unknown_4736));
  for ( i = 0; i < 32; ++i )
  {
    v3 = i;
    pWinMgr->winStates[v3].Unknown_0 = 0xFFFF;
    pWinMgr->winStates[v3].Unknown_84 = 0xFFFF;
  }
  pWinMgr->Unknown_489E = 0;
  pWinMgr->Unknown_48A2 = 0;
  pWinMgr->Unknown_24D9C = 0;
  pWinMgr->Unknown_24DA0 = 0;
  pWinMgr->h = 0;
  pWinMgr->i = 0xFFFFFFFF;
  pWinMgr->aaa = 0;
  pWinMgr->bbb = 0;
  pWinMgr->Unknown_48AE = 0;
  memset(pWinMgr->Unknown_21D82, 0x10, 0);             // BUG? 0x10 <-> 0
  result = pWinMgr->winDatas;
  pWinMgr->Unknown_21D82[0] = 0x3C;
  pWinMgr->winDatasNum = 0;
  memset(pWinMgr->winDatas, 0, sizeof(pWinMgr->winDatas));
  return result;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (000545EC) --------------------------------------------------------
unsigned int __fastcall Q_WINMGR_CPP_StartTimer_sub_545EC(P_WinMgr a1)
{
  HTIMER timer; // ebx
  HTIMER v3; // eax
  HTIMER v4; // edi

  timer = a1->timer;
  V_Timer_dword_132B58 = 0;
  if ( timer == 0xFFFFFFFF )
  {
    v3 = AIL_register_timer((AILTIMERCB)Q_Timer_sub_53DE4);
    a1->timer = v3;
    if ( v3 == 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x1E5);
    }
    v4 = a1->timer;
    if ( v4 == 0xFFFFFFFF )
    {
      return 0;
    }
    AIL_set_timer_frequency(v4, 100u);
    AIL_start_timer(a1->timer);
  }
  return 0xFFFFFFFF;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00054664) --------------------------------------------------------
void __fastcall sub_54664(P_WinMgr a1)
{
  if ( a1->timer != 0xFFFFFFFF )
  {
    AIL_stop_timer(a1->timer);
    AIL_release_timer_handle(a1->timer);
    a1->timer = 0xFFFFFFFF;
  }
}

//----- (0005469C) --------------------------------------------------------
int __fastcall sub_5469C(P_WinMgr pWinMgr)
{
  int Shift; // edi
  int wndIndex; // ecx
  int v4; // eax
  int v5; // edx
  T_Wnd20HW *Wnd_sub_56DA8; // ecx
  LONG right; // eax
  unsigned int v8; // eax
  WORD v9; // ax
  P_Wnd13DBGWND pWnd13DBGWND; // eax
  int aaa; // edx
  int state; // eax
  unsigned int v13; // esi
  int v14; // ebx
  char v15; // dl
  int result; // eax
  int v17; // [esp-4h] [ebp-30h]
  char s[44]; // [esp+0h] [ebp-2Ch] BYREF

  if ( pWinMgr->aaa == 0xFFFFFFFF || pWinMgr->bbb == 0xFFFFFFFF )
  {
    ++pWinMgr->_time;
  }
  Shift = V_Keyboard.Shift;
  pWinMgr->Unknown_48B2 = 0xFFFFFFFF;
  if ( !Shift || *(_DWORD *)((char *)&loc_24DA4 + (_DWORD)pWinMgr) || pWinMgr->Unknown_489E )
  {
    if ( *(_DWORD *)((char *)&loc_24DA4 + (_DWORD)pWinMgr) )
    {
      if ( !V_Keyboard.Shift )
      {
        pWinMgr->h = 0;
        Q_GSYSTEM_CPP_sub_2C7D0(&V_Type6_stru_D8654, 0, 0);
        wndIndex = pWinMgr->_wndIndex;
        if ( wndIndex != 0xFFFFFFFF )
        {
          Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, 6, 0, 0);
          Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 7, 0, 0);
        }
      }
    }
  }
  else
  {
    pWinMgr->h = 0xFFFFFFFF;
    Q_GSYSTEM_CPP_sub_2C7D0(&V_Type6_stru_D8654, 1, 0);
  }
  v4 = 0xFFFFFFFF;
  if ( !pWinMgr->h && !pWinMgr->Unknown_489E && pWinMgr->state )
  {
    if ( V_Mouse.y )
    {
      if ( V_Mouse.y == 0x1DF )
      {
        if ( V_Mouse.x )
        {
          if ( V_Mouse.x == 0x27F )
          {
            v4 = 3;
          }
        }
        else
        {
          v4 = 2;
        }
      }
    }
    else if ( V_Mouse.x )
    {
      if ( V_Mouse.x == 0x27F )
      {
        v4 = 1;
      }
    }
    else
    {
      v4 = 0;
    }
  }
  if ( v4 != pWinMgr->i )
  {
    v5 = 0;
    pWinMgr->i = v4;
    if ( v4 != 0xFFFFFFFF )
    {
      v5 = v4 + 4;
    }
    sub_5A270(pWinMgr, v5, 0, 0);
  }
  if ( V_Mouse.moved == 0xFFFFFFFF )
  {
    if ( V_Mouse.moved == pWinMgr->aaa && pWinMgr->Unknown_48B2 )
    {
      sub_59C80(pWinMgr, 0, 1, 0, V_Mouse.x, V_Mouse.y, 0);
      pWinMgr->Unknown_48B2 = 0;
    }
    sub_5691C(pWinMgr);
  }
  if ( !pWinMgr->Unknown_489E )
  {
    if ( pWinMgr->winEventSmallNum )
    {
      sub_56824(pWinMgr);
    }
    if ( pWinMgr->counter1 )
    {
      sub_56694(pWinMgr);
    }
  }
  if ( V_Keyboard.Pressed == 0xFFFFFFFF )
  {
    if ( V_Keyboard.Pressed == pWinMgr->aaa && (!V_Keyboard.Alt || V_Keyboard.ScanCode != 0x13 && V_Keyboard.ScanCode != 0x19) )
    {
      sub_59C80(
        pWinMgr,
        0,
        3,
        V_Keyboard.Flags,
        (unsigned __int16)V_Keyboard.ScanCode,
        (unsigned __int16)V_Keyboard.ASCIIChar,
        V_Keyboard.Alt);
    }
    if ( pWinMgr->bbb == 0xFFFFFFFF && V_Keyboard.Ctrl && V_Keyboard.ScanCode == 0x19 )
    {
      v17 = dword_132B1C;
      pWinMgr->bbb = 0;
      sprintf(s, "info%02d", v17);
      Wnd_sub_56DA8 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
      Q_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, byte_132B20, s);
      sub_552F8(pWinMgr, &Wnd_sub_56DA8->a2, 0);
      V_Keyboard.Alt = 0;
      dword_132B14 = V_Mouse.left;
      right = V_Mouse.right;
      pWinMgr->bbb = 0xFFFFFFFF;
      dword_132B18 = right;
      V_Keyboard.ScanCode = 0;
      ++dword_132B1C;
    }
    v8 = 0xFFFFFFFF;
    if ( V_Keyboard.Alt == 0xFFFFFFFF || V_Keyboard.ScanCode == 1 )
    {
      v8 = sub_54D64(pWinMgr);
    }
    if ( v8 == 0xFFFFFFFF )
    {
      sub_56BE8(pWinMgr, 3, (unsigned __int16)V_Keyboard.ASCIIChar, (unsigned __int16)V_Keyboard.ScanCode, 0);
    }
  }
  if ( V_Mouse.leftClicked == 0xFFFFFFFF )
  {
    if ( V_Mouse.leftClicked == pWinMgr->aaa && !V_Keyboard.Alt )
    {
      v9 = 0;
      if ( V_Mouse.left && V_Keyboard.Shift )
      {
        v9 = 1;
      }
      sub_59C80(pWinMgr, 0, 2, v9, 0, V_Mouse.left, 0);
    }
    if ( V_Mouse.left )
    {
      if ( pWinMgr->i == 0xFFFFFFFF )
      {
        if ( V_Keyboard.Alt == 0xFFFFFFFF )
        {
          *(_DWORD *)&dword_132B10 = VFX_pixel_read(&V_Type6_stru_D8654.pane, V_Mouse.x, V_Mouse.y);
          pWnd13DBGWND = pWinMgr->pWnd13DBGWND;
          if ( pWnd13DBGWND->a2.a1.Unknown_39 )
          {
            ((void (*)(void))pWnd13DBGWND->a2.pProcs->proc3)();
          }
        }
        else if ( pWinMgr->h != 0xFFFFFFFF || pWinMgr->Unknown_489E )
        {
          sub_56BE8(pWinMgr, 4, V_Mouse.x, V_Mouse.y, 0);
        }
        else
        {
          sub_56BE8(pWinMgr, 0xC, V_Mouse.x, V_Mouse.y, 0);
        }
      }
      else if ( pWinMgr->Unknown_489E )
      {
        pWinMgr->Unknown_489E = 0;
        pWinMgr->Unknown_48A2 = 0xFFFFFFFF;
      }
      else
      {
        Q_StartSample_sub_4FB90(&V_SoundSystem, 0);
        sub_5A270(pWinMgr, 0, 0, 0);
        pWinMgr->i = 0xFFFFFFFF;
        sub_570AC(pWinMgr, 0xFFFFFFFF);
      }
    }
  }
  if ( V_Mouse.rightClicked == 0xFFFFFFFF )
  {
    aaa = pWinMgr->aaa;
    if ( aaa == V_Mouse.rightClicked )
    {
      sub_59C80(pWinMgr, V_Mouse.rightClicked ^ aaa, 2, 0, 1, V_Mouse.right, 0);
    }
    if ( V_Mouse.right )
    {
      if ( pWinMgr->h == 0xFFFFFFFF )
      {
        pWinMgr->h = 0;
        Q_GSYSTEM_CPP_PreloadMouseShp_sub_2C744(&V_Type6_stru_D8654);
      }
      else
      {
        sub_56BE8(pWinMgr, 5, V_Mouse.x, V_Mouse.y, 0);
      }
    }
  }
  while ( pWinMgr->messageQueueCount > 0 )
  {
    sub_55E80(pWinMgr);
  }
  if ( pWinMgr->gameEventsNum && pWinMgr->state == 1 && !pWinMgr->Unknown_489E )
  {
    sub_55B74(pWinMgr);
  }
  if ( *(int *)((char *)&pWinMgr->wnds[0].activeCount + (_DWORD)&loc_24D9B + 1) == 0xFFFFFFFF
    && !pWinMgr->gameEventsNum
    && !pWinMgr->Unknown_489E )
  {
    Q_WinMgr_QueueMessage_sub_56B60(pWinMgr, 7, 0, 0);
  }
  if ( V_SoundSystem.a == 0xFFFFFFFF && !V_SoundSystem.c )
  {
    if ( !V_SoundSystem.playing )
    {
      state = pWinMgr->state;
      if ( state != 7 && state != 0xD && state != 6 )
      {
        LOWORD(v13) = 0xFFFF;
        v14 = 0;
        if ( word_96BB0 != 0xFFFFFFFF && V_SoundSystem.files[word_96BB0].fpos )
        {
          v14 = 0xFFFFFFFF;
          LOWORD(v13) = word_96BB0;
          dword_96BB4 = 0;
        }
        if ( (__int16)v13 == 0xFFFFFFFF )
        {
          if ( word_96BB0 == 0xFFFFFFFF )
          {
            LOWORD(v13) = 0;
          }
          else
          {
            v13 = (V_Mouse.x + V_Timer_dword_132B58) % 5u;
            if ( (_WORD)v13 == word_96BB0 )
            {
              v13 = (word_96BB0 + 1) % 5;
            }
          }
        }
        sub_4F8CC(&V_SoundSystem, v13, v14);
        word_96BB0 = v13;
      }
    }
    if ( dword_96BB4 != 0xFFFFFFFF )
    {
      v15 = dword_96BB4++;
      Q_SetVolume_sub_4FF4C(&V_SoundSystem, v15);
      if ( dword_96BB4 == 0x64 )
      {
        dword_96BB4 = 0xFFFFFFFF;
      }
    }
  }
  do
  {
    if ( V_SoundSystem.a == 0xFFFFFFFF && V_SoundSystem.a == V_SoundSystem.playing )
    {
      if ( V_SoundSystem.playing == V_SoundSystem.c )
      {
        Q_StopSample_sub_4FA1C(&V_SoundSystem);
      }
      else
      {
        sub_4FAB4((int)&V_SoundSystem);
      }
    }
  }
  while ( (unsigned int)(V_Timer_dword_132B58 - dword_132B34) < 3 );
  result = V_Timer_dword_132B58;
  dword_132B34 = V_Timer_dword_132B58;
  return result;
}
// 96BB0: using guessed type __int16 word_96BB0;
// 96BB4: using guessed type int dword_96BB4;
// 132B14: using guessed type int dword_132B14;
// 132B18: using guessed type int dword_132B18;
// 132B1C: using guessed type int dword_132B1C;
// 132B34: using guessed type int dword_132B34;
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00054D64) --------------------------------------------------------
unsigned int __fastcall sub_54D64(P_WinMgr a1)
{
  if ( V_Keyboard.ScanCode >= 0x20u )
  {
    if ( V_Keyboard.ScanCode <= 0x20u )
    {
      if ( V_NougatLfExists_dword_A0CFC == 0xFFFFFFFF )
      {
        dword_132B5C = ~dword_132B5C;
      }
    }
    else
    {
      if ( V_Keyboard.ScanCode >= 0x26u )
      {
        if ( V_Keyboard.ScanCode <= 0x26u )
        {
          if ( !a1->Unknown_489E && a1->state != 8 )
          {
            sub_56E9C(a1, 4, 0xFFFFFFFF);
            return 0;
          }
        }
        else
        {
          if ( V_Keyboard.ScanCode >= 0x31u )
          {
            if ( V_Keyboard.ScanCode <= 0x31u )
            {
              V_SoundSystem._notstarted1 = ~V_SoundSystem._notstarted1;
              return 0;
            }
            if ( V_Keyboard.ScanCode == 0x32 )
            {
              V_SoundSystem.c = ~V_SoundSystem.c;
              return 0;
            }
            return 0xFFFFFFFF;
          }
          if ( V_Keyboard.ScanCode != 0x2D )
          {
            return 0xFFFFFFFF;
          }
          if ( !a1->Unknown_489E )
          {
            Q_GameLoop_dword_96774 = 0;
            return 0;
          }
        }
        return 0;
      }
      if ( V_Keyboard.ScanCode > 0x21u )
      {
        if ( V_Keyboard.ScanCode != 0x22 )
        {
          return 0xFFFFFFFF;
        }
        sub_1B4D0(&a1->cache);
        sub_31C18((int)a1->cache.pShapeCache, a1->cache.size);
        sub_1ACE8(&a1->cache);
        return 0;
      }
      if ( V_NougatLfExists_dword_A0CFC == 0xFFFFFFFF )
      {
        if ( V_NougatLfExists_dword_A0CFC == *(_DWORD *)((char *)&loc_24D98 + (_DWORD)a1) )
        {
          *(_DWORD *)((char *)&loc_24D98 + (_DWORD)a1) = 0;
        }
        else
        {
          *(_DWORD *)((char *)&loc_24D98 + (_DWORD)a1) = V_NougatLfExists_dword_A0CFC;
        }
        return 0;
      }
    }
    return 0;
  }
  if ( V_Keyboard.ScanCode < 0x12u )
  {
    if ( V_Keyboard.ScanCode )
    {
      if ( V_Keyboard.ScanCode > 1u )
      {
        if ( V_Keyboard.ScanCode != 0x11 )
        {
          return 0xFFFFFFFF;
        }
        if ( V_NougatLfExists_dword_A0CFC == 0xFFFFFFFF )
        {
          sub_552F8(a1, *(P_WndA2 *)((char *)&a1->wnds[0].activeCount + (_DWORD)&loc_21D90 + 2), 0);
          return 0;
        }
        return 0;
      }
      if ( a1->Unknown_489E )
      {
        a1->Unknown_489E = 0;
        a1->Unknown_48A2 = 0;
        return 0;
      }
      if ( a1->state != 0x11 )
      {
        sub_570AC(a1, 0xFFFFFFFF);
        return 0;
      }
    }
    return 0xFFFFFFFF;
  }
  if ( V_Keyboard.ScanCode <= 0x12u )
  {
    if ( V_NougatLfExists_dword_A0CFC == 0xFFFFFFFF )
    {
      *(int *)((char *)&a1->wnds[0].activeCount + (_DWORD)&loc_24D9E + 2) = ~*(int *)((char *)&a1->wnds[0].activeCount
                                                                                    + (_DWORD)&loc_24D9E
                                                                                    + 2);
      return 0;
    }
    return 0;
  }
  if ( V_Keyboard.ScanCode < 0x19u )
  {
    if ( V_Keyboard.ScanCode != 0x13 )
    {
      return 0xFFFFFFFF;
    }
    if ( a1->bbb || V_NougatLfExists_dword_A0CFC != 0xFFFFFFFF )
    {
      return 0;
    }
    if ( a1->aaa )
    {
      sub_59934(a1, V_NougatLfExists_dword_A0CFC);
    }
    else
    {
      srand(0);
      *(int *)((char *)&a1->wnds[0].activeCount + (_DWORD)&loc_24DAA + 2) = 0x3F800000;
      sub_59908((int)a1);
    }
    return 0;
  }
  else
  {
    if ( V_Keyboard.ScanCode > 0x19u )
    {
      if ( V_Keyboard.ScanCode != 0x1F )
      {
        return 0xFFFFFFFF;
      }
      if ( !a1->Unknown_489E && a1->state != 8 )
      {
        sub_56E9C(a1, 2, 0xFFFFFFFF);
      }
      return 0;
    }
    if ( a1->aaa || V_NougatLfExists_dword_A0CFC != 0xFFFFFFFF )
    {
      return 0;
    }
    if ( a1->bbb )
    {
      sub_59934(a1, 0);
    }
    else
    {
      sub_59988(a1, "WINEVENT.BIN", 0);
    }
    return 0;
  }
}
// 54D64: could not find valid save-restore pair for esi
// 96774: using guessed type int Q_GameLoop_dword_96774;
// 132B5C: using guessed type int dword_132B5C;

//----- (0005508C) --------------------------------------------------------
void __fastcall sub_5508C(P_WinMgr a1)
{
  int v1; // esi
  unsigned int v2; // ebx
  int v3; // ebx
  char s[40]; // [esp+0h] [ebp-2Ch] BYREF
  P_WinMgr v5; // [esp+28h] [ebp-4h]

  v5 = a1;
  if ( *(_DWORD *)a1->z5 == 0xFFFFFFFF )
  {
    if ( ++dword_10AE60 == 0xA )
    {
      v1 = dword_10AE68;
      dword_10AE64 = V_Timer_dword_132B58;
      dword_10AE68 = V_Timer_dword_132B58;
      v2 = V_Timer_dword_132B58 - v1;
      dword_10AE60 = 0;
      if ( V_Timer_dword_132B58 == v1 )
      {
        v2 = 1;
      }
      sprintf("FPS DUDE", "FPS %lu  %lu", 0x3E8 / v2, v2);
    }
    sub_2B3E0(&WinMgr.LargeFont, 25, 10, 150, 30);
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, 0, "FPS DUDE", 0, 0xFFFF, 0xFFFF, 0);
  }
  if ( dword_132B5C )
  {
    v3 = 0;
    if ( V_Mouse.y < 0xF0 )
    {
      v3 = 0x1CC;
    }
    sprintf(s, "(%d,%d)", V_Mouse.x, V_Mouse.y);
    WinMgr.LargeFont.pane = V_Type6_stru_D8654.pane;
    Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 0, v3, s, 0, 0xFFFF, 0xFFFF, 0);
  }
  if ( V_Mouse.initialized == 1 )
  {
    MOUSE_pane_list_refresh(v5->pPaneList);
  }
  else
  {
    VFX_pane_list_refresh(v5->pPaneList);
  }
  VFX_pane_list_clear(v5->pPaneList);
  if ( dword_132B60 == 0xFFFFFFFF )
  {
    Q_FadePalette_sub_2C5E4(&V_Type6_stru_D8654, dword_132B64);
    if ( ++dword_132B64 > 0x40 )
    {
      dword_132B64 = 0;
      dword_132B60 = 0;
    }
  }
}
// 10AE60: using guessed type int dword_10AE60;
// 10AE64: using guessed type int dword_10AE64;
// 10AE68: using guessed type int dword_10AE68;
// 132B58: using guessed type int V_Timer_dword_132B58;
// 132B5C: using guessed type int dword_132B5C;
// 132B60: using guessed type int dword_132B60;
// 132B64: using guessed type int dword_132B64;

//----- (00055214) --------------------------------------------------------
void __fastcall Q_WinMgr_WipeAndAddDirtyArea_sub_55214(P_WinMgr pWinMgr, LONG x0, LONG y0, LONG x1, int y1)
{
  PANE pane; // [esp+0h] [ebp-18h] BYREF
  P_WinMgr pWinMgr_; // [esp+14h] [ebp-4h]

  pWinMgr_ = pWinMgr;
  pane.x0 = x0;
  pane.y1 = y1;
  pane.y0 = y0;
  pane.x1 = x1;
  pane.window = pWinMgr->window;
  VFX_pane_wipe(&pane, 0);
  Q_WinMgr_AddDirtyArea_sub_55274(pWinMgr_, x0, y0, x1, y1);
}

//----- (00055274) --------------------------------------------------------
void __fastcall Q_WinMgr_AddDirtyArea_sub_55274(P_WinMgr pWinMgr, int x0, int y0, int x1, int y1)
{
  if ( VFX_pane_list_add_area(pWinMgr->pPaneList, pWinMgr->window, x0, y0, x1, y1) == -1u )
  {
    VFX_pane_list_clear(pWinMgr->pPaneList);
    VFX_pane_list_add_area(pWinMgr->pPaneList, pWinMgr->window, 0, 0, 639, 479);
  }
}

//----- (000552CC) --------------------------------------------------------
void __fastcall Q_WinMgr_AddDirtyArea_sub_552CC(P_WinMgr pWinMgr, PANE *pPane)
{
  if ( pPane )
  {
    Q_WinMgr_AddDirtyArea_sub_55274(pWinMgr, pPane->x0, pPane->y0, pPane->x1, pPane->y1);
  }
  else
  {
    Q_WinMgr_AddDirtyArea_sub_55274(pWinMgr, 0, 0, 639, 479);
  }
}

//----- (000552F8) --------------------------------------------------------
int __fastcall sub_552F8(P_WinMgr a1, P_WndA2 a2, int a3)
{
  MACRO_VFX_BOOL v4; // ebx
  P_Wnd25TW pWnd25TW; // eax
  P_Procs pProcs; // ebx
  int wndIndex; // ecx
  __int16 childrenNum; // di
  __int16 i; // cx
  __int16 j; // si
  int index; // edx
  int v12; // edi
  int result; // eax
  PANE pane; // [esp+0h] [ebp-20h] BYREF
  int Unknown_24D9C; // [esp+14h] [ebp-Ch]
  int v16; // [esp+18h] [ebp-8h]
  P_WndA2 v17; // [esp+1Ch] [ebp-4h]

  v17 = a2;
  v16 = a3;
  if ( a1->Unknown_489E )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x4CC);
  }
  v4 = V_FlashPopExists;
  Unknown_24D9C = a1->Unknown_24D9C;
  a1->Unknown_24D9C = 0;
  if ( v4 == FALSE )
  {
    pWnd25TW = (P_Wnd25TW)Q_FindWnd_sub_56DA8(a1, "NEXTTURNCONT", 0);
    pProcs = pWnd25TW->a2.pProcs;
    pWnd25TW->buttonState = 0;
    pProcs->proc4_draw(&pWnd25TW->a2.a1, 0);
  }
  wndIndex = a1->_wndIndex;
  if ( wndIndex != 0xFFFFFFFF )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(a1, wndIndex, 6, 0, 0);
  }
  a1->_wndIndex = 0xFFFFFFFF;
  memset(byte_132B38, 1, sizeof(byte_132B38));
  sub_56BE8(a1, 0xF, 0, 0, 0xFFFFFFFF);
  if ( dword_96BB8 == 0xFFFFFFFF )
  {
    sub_54208(&v17->a1.pane);
  }
  if ( Q_WinMgr_AddWindowToState_sub_57220(a1, v17->a1.index, a1->state) != 0xFFFFFFFF )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x4EE);
  }
  childrenNum = v17->a1.childrenNum;
  if ( childrenNum > 0 )
  {
    for ( i = 0; i < childrenNum; ++i )
    {
      if ( Q_WinMgr_AddWindowToState_sub_57220(a1, (*v17->a1.children)[i]->index, a1->state) != 0xFFFFFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x4F4);
      }
    }
  }
  v17->pProcs->proc3(v17, 0xC8, 0, 0);
  v17->pProcs->proc3(v17, 1, 0, 0);
  sub_55618(a1);
  v17->pProcs->proc3(v17, 2, 0, 0);
  for ( j = 0; j < childrenNum; ++j )
  {
    index = (*v17->a1.children)[j]->index;
    sub_57310(a1, index, a1->state, v16);
  }
  pane = v17->a1.pane;
  sub_57310(a1, v17->a1.index, a1->state, v16);
  v12 = dword_96BB8;
  a1->_wndIndex = 0xFFFFFFFF;
  if ( v12 == 0xFFFFFFFF )
  {
    Q_WINMGR_CPP_sub_542B0(&pane);
  }
  sub_56BE8(a1, 0xE, 0, 0, 0xFFFFFFFF);
  Q_WinMgr_AddDirtyArea_sub_552CC(a1, 0);
  if ( V_FlashPopExists == 0xFFFFFFFF )
  {
    a1->Unknown_24D9C = Unknown_24D9C;
  }
  result = a1->Unknown_48A2;
  dword_96BB8 = 0xFFFFFFFF;
  return result;
}
// 96BB8: using guessed type int dword_96BB8;

//----- (00055554) --------------------------------------------------------
void __fastcall sub_55554(int a1, _DWORD *a2)
{
  SCRNVERTEX vlist; // [esp+0h] [ebp-6Ch] BYREF
  int v3; // [esp+18h] [ebp-54h]
  int v4; // [esp+1Ch] [ebp-50h]
  int v5; // [esp+30h] [ebp-3Ch]
  int v6; // [esp+34h] [ebp-38h]
  int v7; // [esp+48h] [ebp-24h]
  int v8; // [esp+4Ch] [ebp-20h]

  v3 = 0x27F;
  v5 = 0x27F;
  v6 = 0x1DF;
  v8 = 0x1DF;
  vlist.x = 0;
  vlist.y = 0;
  v4 = 0;
  v7 = 0;
  VFX_translate_polygon(&V_Type6_stru_D8654.pane, 4, &vlist, V_Type6_stru_D8654.hazeTables);
  vlist.x = a2[1] + 0x14;
  vlist.y = a2[2] + 0x14;
  v3 = a2[3] + 0x14;
  v4 = a2[2] + 0x14;
  v5 = a2[3] + 0x14;
  v6 = a2[4] + 0x14;
  v7 = a2[1] + 0x14;
  v8 = a2[4] + 0x14;
  VFX_translate_polygon(&V_Type6_stru_D8654.pane, 4, &vlist, (*V_Type6_stru_D8654.hazeTables)[7]);
}

//----- (00055618) --------------------------------------------------------
void __fastcall sub_55618(P_WinMgr a1)
{
  int v2; // ebx

  if ( a1->Unknown_489E )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x57E);
  }
  a1->Unknown_489E = 0xFFFFFFFF;
  v2 = Q_GameLoop_dword_96774;
  a1->Unknown_48A2 = 0;
  if ( v2 == 0xFFFFFFFF )
  {
    do
    {
      if ( a1->Unknown_489E != 0xFFFFFFFF )
      {
        break;
      }
      if ( WinMgr.bbb == 0xFFFFFFFF )
      {
        sub_59B80(&WinMgr);
      }
      else
      {
        Q_ProcessInput_sub_2656C();
      }
      sub_5469C(&WinMgr);
      sub_5508C(&WinMgr);
      if ( WinMgr.bbb )
      {
        sub_59A54(&WinMgr);
      }
    }
    while ( Q_GameLoop_dword_96774 == 0xFFFFFFFF );
  }
  V_Mouse.leftClicked = 0;
  V_Mouse.rightClicked = 0;
  V_Keyboard.Pressed = 0;
}
// 96774: using guessed type int Q_GameLoop_dword_96774;

//----- (000556CC) --------------------------------------------------------
void __fastcall Q_ShowMsgBox_sub_556CC(P_WinMgr a1, char *a2)
{
  T_TypeA3 *ctrBox; // eax
  T_TypeA3 *v5; // edx
  T_WndA2 *ctrBox_1; // ecx
  T_WndA2 *ctrBut; // eax
  P_WndA2 ctrBut_1; // edx
  char *sub_1CEA8; // kr00_4
  WINDOW *window; // eax

  ctrBox = (T_TypeA3 *)operator new(0xB3u);
  if ( ctrBox )
  {
    Q_A3_sub_2FA18(ctrBox);
  }
  Q_RegisterData_sub_2625C(ctrBox, 2, "MSGBOX");
  v5 = ctrBox;
  ctrBox_1 = &ctrBox->a2;
  Q_WINMGR_CPP_RegisterWindow_sub_2C978(&ctrBox->a2.a1);
  v5->a2.a1._mouseFocus = 0;
  v5->a2.a1.pane.y0 = 0x32;
  v5->a2.a1.pane.y1 = 0x12C;
  v5->controls = a2;
  v5->a2.a1.pane.x0 = v5->a2.a1.pane.y0;
  v5->a2.a1.pane.x1 = v5->a2.a1.pane.y1;
  v5->a2.a1.pane.window = a1->window;
  ctrBut = (T_WndA2 *)operator new(0xABu);
  if ( ctrBut )
  {
    Q_A2Ctor_sub_2C830(ctrBut);
  }
  Q_RegisterData_sub_2625C(ctrBut, 2, "MSGBOXBUTTON");
  ctrBut_1 = ctrBut;
  Q_WINMGR_CPP_RegisterWindow_sub_2C978(&ctrBut->a1);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);
  strcpy(ctrBut_1->a1.name, sub_1CEA8);
  ctrBut_1->a1.pane.y0 = 0x104;
  ctrBut_1->a1.pane.y1 = 0x122;
  ctrBut_1->a1.pane.x0 = ctrBut_1->a1.pane.y0;
  ctrBut_1->a1.pane.x1 = ctrBut_1->a1.pane.y1;
  window = a1->window;
  ctrBut_1->a1._mouseFocus = 0xFFFFFFFF;
  ctrBut_1->a1.sendMessage = 0xC9;
  ctrBut_1->a1.pane.window = window;
  ctrBut_1->a1.parentIndex = ctrBox_1->a1.index;
  Q_GWINDOW_CPP_LinkChild_sub_2C990(&ctrBox_1->a1, &ctrBut_1->a1);
  sub_552F8(a1, ctrBox_1, 0xFFFFFFFF);
}
/* Orphan comments:
30: "OK"
*/

//----- (000557D4) --------------------------------------------------------
const char *__fastcall sub_557D4(T_WinMgr *eax0, char *s2, const char *a3, __int16 a4)
{
  T_WndA2 *v5; // eax
  T_WndA2 *v6; // ecx
  T_WndA2 *v7; // ebp
  int v8; // ebx
  int v9; // eax
  P_WinMgr v10; // eax
  T_WndA2 *v11; // eax
  T_Wnd *p_a1; // ebx
  char *sub_1CEA8; // kr00_4
  char *v14; // eax
  WINDOW *window; // eax
  T_WndA2 *v16; // eax
  P_Wnd v17; // edx
  P_Wnd v18; // edx
  LONG v19; // eax
  LONG v20; // ebx
  int index; // eax
  void *ShapeTable_sub_1B084; // eax
  PANE pane; // [esp+0h] [ebp-3Ch] BYREF
  T_WndA2 *v25; // [esp+14h] [ebp-28h]
  int v26; // [esp+18h] [ebp-24h]
  const char *v27; // [esp+1Ch] [ebp-20h]
  LONG Height_sub_2B594; // [esp+20h] [ebp-1Ch]
  P_WinMgr a1; // [esp+24h] [ebp-18h]
  P_Wnd v30; // [esp+28h] [ebp-14h]
  __int16 v31; // [esp+2Ch] [ebp-10h]

  a1 = eax0;
  v27 = a3;
  v31 = a4;
  Height_sub_2B594 = Q_Font_GetHeight_sub_2B594(&WinMgr.LargeFont);
  v26 = 5 * Height_sub_2B594 + 5;
  v5 = (T_WndA2 *)operator new(0xABu);
  if ( v5 )
  {
    Q_A2Ctor_sub_2C830(v5);
  }
  Q_RegisterData_sub_2625C(v5, 2, "INPUTBOX");
  v6 = v5;
  v7 = v5;
  Q_WINMGR_CPP_RegisterWindow_sub_2C978(&v5->a1);
  strncpy(v6->a1.name, s2, 0x13u);
  v8 = v26;
  v6->a1.pane.x0 = 0xF2;
  v6->a1.pane.x1 = 0x18D;
  v9 = (0x1E0 - v8) / 2;
  v6->a1.name[0x13] = 0;
  v6->a1._x = 0xFFFF;
  v6->a1.pane.y0 = v9;
  v6->a1.pane.y1 = v8 + v9;
  v10 = a1;
  v6->a1._y = 5;
  v6->a1.pane.window = v10->window;
  v11 = (T_WndA2 *)operator new(0xABu);
  if ( v11 )
  {
    Q_A2Ctor_sub_2C830(v11);
  }
  Q_RegisterData_sub_2625C(v11, 2, "MSGBOXBUTTON");
  p_a1 = &v11->a1;
  v25 = v11;
  Q_WINMGR_CPP_RegisterWindow_sub_2C978(&v11->a1);
  sub_1CEA8 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);
  strcpy(p_a1->name, sub_1CEA8);
  p_a1->_x = 0xFFFF;
  p_a1->_y = 2;
  v14 = Q_CORN_CPP_StaticTxtRead_sub_1CEA8(0x1E);      // 30: "OK"
  p_a1->pane.x0 = v7->a1.pane.x1 - Q_Font_GetTextWidth_sub_2B4F4(&WinMgr.LargeFont, v14) - 0xA;
  p_a1->pane.x1 = v7->a1.pane.x1 - 3;
  p_a1->pane.y0 = v7->a1.pane.y1 - Height_sub_2B594 - 5;
  p_a1->pane.y1 = v7->a1.pane.y1 - 2;
  window = a1->window;
  p_a1->_mouseFocus = 0xFFFFFFFF;
  p_a1->framed = 0xFFFFFFFF;
  p_a1->sendMessage = 0xC9;
  p_a1->pane.window = window;
  p_a1->parentIndex = v7->a1.index;
  Q_GWINDOW_CPP_LinkChild_sub_2C990(&v7->a1, p_a1);
  v16 = (T_WndA2 *)operator new(0xC1u);
  if ( v16 )
  {
    v16 = sub_2F48C(v16);
  }
  Q_RegisterData_sub_2625C(v16, 2, "EDITWND");
  v30 = &v16->a1;
  if ( !v16 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x5F7);
  }
  Q_WINMGR_CPP_RegisterWindow_sub_2C978(v30);
  v17 = v30;
  v30->pane.x0 = v7->a1.pane.x0 + 0xF;
  v17->pane.x1 = v7->a1.pane.x1 - 0xF;
  v18 = v30;
  v19 = Height_sub_2B594 + v7->a1.pane.y0 + 8;
  v20 = Height_sub_2B594;
  v30->pane.y0 = v19;
  v18->pane.y1 = v20 + v19 + 8;
  v18->pane.window = a1->window;
  LOWORD(v20) = v31;
  index = v7->a1.index;
  v18->sendMessage = 0;
  v18->parentIndex = index;
  sub_2F9A4((int)v18, v27, v20);
  Q_GWINDOW_CPP_LinkChild_sub_2C990(&v7->a1, v30);
  pane = v7->a1.pane;
  dword_96BB8 = 0;
  pane.x0 -= 8;
  pane.x1 += 8;
  pane.y0 -= 8;
  pane.y1 += 7;
  sub_54208(&pane);
  Q_WinMgr_AddDirtyArea_sub_552CC(a1, &pane);
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, GwshareShpCacheIndexes[0x25]);
  VFX_shape_draw(&pane, ShapeTable_sub_1B084, 1, 0, 0);
  sub_552F8(a1, v7, 0);
  Q_WINMGR_CPP_sub_542B0(&pane);
  Q_WinMgr_AddDirtyArea_sub_552CC(a1, &pane);
  sub_57530(a1, v25->a1.index, 0);
  sub_57530(a1, v30->index, 0);
  sub_57530(a1, v7->a1.index, 0);
  return v27;
}
/* Orphan comments:
30: "OK"
*/
// 96BB8: using guessed type int dword_96BB8;

//----- (00055AEC) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall Q_AddGameEvent_sub_55AEC(P_WinMgr pWinMgr, int eventId, int p1, int p2)
{
  int gameEventsNum; // edx

  if ( V_FlashPopExists == TRUE )
  {
    return FALSE;
  }
  gameEventsNum = pWinMgr->gameEventsNum;
  if ( gameEventsNum == 32 )
  {
    return FALSE;
  }
  pWinMgr->gameEvents[gameEventsNum].eventId = eventId;
  pWinMgr->gameEvents[pWinMgr->gameEventsNum].p1 = p1;
  pWinMgr->gameEvents[pWinMgr->gameEventsNum++].p2 = p2;
  return TRUE;
}

//----- (00055B74) --------------------------------------------------------
void __fastcall sub_55B74(P_WinMgr pWinMgr)
{
  P_Wnd23EW pWnd23EW; // eax
  P_Wnd23EW v3; // ebp
  __int16 v4; // di
  P_Location pLocation; // ebp
  unsigned int eventId; // ecx
  P_Ship pShip; // eax
  bool v8; // zf
  __int16 v9; // dx
  WORD gameEventsNum; // bx
  int v11; // [esp+8h] [ebp-20h]
  int p2; // [esp+Ch] [ebp-1Ch]

  if ( dword_10AE6C == 0xFFFFFFFF || !pWinMgr->gameEventsNum || pWinMgr->state != 1 )
  {
    return;
  }
  pWnd23EW = (P_Wnd23EW)Q_FindWnd_sub_56DA8(pWinMgr, "EVENTWIN", 0);
  v3 = pWnd23EW;
  if ( !pWnd23EW )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x63B);
  }
  sub_26874(pWnd23EW, &pWinMgr->gameEvents[pWinMgr->Unknown_475C]);
  dword_10AE6C = 0xFFFFFFFF;
  v11 = 0;
  if ( V_FlashPopExists == FALSE )
  {
    v11 = sub_552F8(pWinMgr, &v3->a2, 0);
  }
  v4 = 0;
  dword_10AE6C = 0;
  if ( !v11 )
  {
    goto LABEL_47;
  }
  eventId = pWinMgr->gameEvents[pWinMgr->Unknown_475C].eventId;
  pShip = (P_Ship)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
  p2 = pWinMgr->gameEvents[pWinMgr->Unknown_475C].p2;
  if ( eventId < ASCEND_EP_BADSHIPENTERS )
  {
    if ( eventId >= ASCEND_EP_SHIPARRIVE )
    {
      goto LABEL_16;
    }
    if ( !pWinMgr->gameEvents[pWinMgr->Unknown_475C].eventId )
    {
      v8 = 1;
      goto LABEL_45;
    }
    if ( eventId > 1 )
    {
      v4 = 0xD;
      byte_968DD = pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
      goto LABEL_47;
    }
    goto LABEL_10;
  }
  if ( eventId <= ASCEND_EP_BADSHIPENTERS )
  {
    goto LABEL_16;
  }
  if ( eventId >= 0x14 )
  {
    if ( eventId > 0x14 )
    {
      if ( eventId < 0x17 )
      {
        v8 = eventId == ASCEND_EP_22_XENO_COMPLETE;
      }
      else
      {
        if ( eventId <= 0x17 )
        {
          v4 = 0xD;
          byte_968DD = pWinMgr->gameEvents[pWinMgr->Unknown_475C].p2;
          goto LABEL_47;
        }
        v8 = eventId == ASCEND_EP_25_FIRST_LAB;
      }
LABEL_45:
      if ( v8 )
      {
        v4 = 0x14;
      }
      goto LABEL_47;
    }
LABEL_16:
    if ( pShip->locationType != ASCEND_LOCATION_TYPE_SYSTEM )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x6A8);
    }
    pLocation.pPlanet = (P_Planet)pShip->pLocation;
    if ( (eventId == ASCEND_EP_FINDRACE || eventId == ASCEND_EP_RACEFINDUS) && v11 != 2 )
    {
      v4 = 0xD;
      if ( Q_Race_CalculateShipsAtLocation_sub_45958(&V_Game.races[p2], ASCEND_TREATY_WAR, pLocation, 0) )
      {
        V_Game.races[p2].Unknown_1E9 = 1;
        V_Game.races[p2].Unknown_1EA = (int)pLocation.pPlanet;
      }
      else
      {
        V_Game.races[p2].Unknown_1E9 = 0;
      }
      byte_968DD = p2;
    }
    else
    {
      v4 = 0x10;
      V_Game.pCurStar = pShip->pLocation.pStar;
    }
    goto LABEL_47;
  }
  if ( eventId >= ASCEND_EP_16_ENTERED_ORBIT )
  {
    if ( eventId <= ASCEND_EP_18_REFIT_COMPLETE )
    {
      v4 = 0x11;
      V_Game.pCurPlanet = (P_Planet)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p2;
    }
    else if ( v11 == 1 )
    {
      v4 = 0x10;
      V_Game.pCurStar = (P_Star)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
    }
    else if ( p2 == 7 )
    {
      Q_WinMgr_QueueMessage_sub_56B60(pWinMgr, 7, 0, 0);
    }
    else
    {
      pWinMgr->Unknown_24D9C = 0xFFFFFFFF;
    }
    goto LABEL_47;
  }
  if ( eventId == ASCEND_EP_15_HAS_FREE_POPULATION )
  {
LABEL_10:
    v4 = 0x11;
    V_Game.pCurPlanet = (P_Planet)pWinMgr->gameEvents[pWinMgr->Unknown_475C].p1;
  }
LABEL_47:
  v9 = pWinMgr->Unknown_475C + 1;
  gameEventsNum = pWinMgr->gameEventsNum;
  pWinMgr->Unknown_475C = v9;
  if ( v9 == gameEventsNum )
  {
    pWinMgr->Unknown_475C = 0;
    pWinMgr->gameEventsNum = 0;
  }
  if ( v4 )
  {
    Q_WinMgr_QueueMessage_sub_56B60(pWinMgr, 1, v4, 1);
  }
}
// 968DD: using guessed type char byte_968DD;
// 10AE6C: using guessed type int dword_10AE6C;

//----- (00055E80) --------------------------------------------------------
void __fastcall sub_55E80(P_WinMgr pWinMgr)
{
  char *index; // edx
  WORD messageQueueCount; // ax
  int v4; // eax
  LONG param1; // ecx
  T_Star *v6; // ebx
  int v7; // ecx
  __int16 i; // si
  T_Star *v9; // eax
  T_Wnd20HW *v10; // ecx
  T_Wnd20HW *v11; // esi
  __int8 v12; // bl
  int v13; // eax
  T_Wnd20HW *v14; // esi
  __int8 v15; // dl
  int v16; // eax
  UBYTE v17; // al
  T_Wnd20HW *v18; // eax
  char format[600]; // [esp+0h] [ebp-53Ch] BYREF
  char v20[600]; // [esp+258h] [ebp-2E4h] BYREF
  char s[28]; // [esp+4B0h] [ebp-8Ch] BYREF
  char helptopic[28]; // [esp+4CCh] [ebp-70h] BYREF
  char v23[28]; // [esp+4E8h] [ebp-54h] BYREF
  char *Unknown_04; // [esp+504h] [ebp-38h]
  char *v25; // [esp+508h] [ebp-34h]
  __int8 *v26; // [esp+50Ch] [ebp-30h]
  __int8 *Unknown_C95; // [esp+510h] [ebp-2Ch]
  LONG param2; // [esp+514h] [ebp-28h]
  T_Wnd20HW *Wnd_sub_56DA8; // [esp+518h] [ebp-24h]
  int v30; // [esp+51Ch] [ebp-20h]
  int v31; // [esp+520h] [ebp-1Ch]

  HIWORD(index) = 0;
  qmemcpy(&pWinMgr->messageQueue[0x20], pWinMgr->messageQueue, 0x140u);
  messageQueueCount = pWinMgr->messageQueueCount;
  v30 = (unsigned __int16)messageQueueCount;
  pWinMgr->messageQueueCount = 0;
  LOWORD(v31) = 0;
  if ( messageQueueCount > 0 )
  {
    do
    {
      v4 = (__int16)v31;
      LOWORD(index) = pWinMgr->messageQueue[v4 + 0x20].message;
      param1 = pWinMgr->messageQueue[v4 + 0x20].param1;
      param2 = pWinMgr->messageQueue[v4 + 0x20].param2;
      switch ( (__int16)index )
      {
        case 0:
          break;
        case 1:
          index = (char *)(__int16)param1;
          sub_56E9C(pWinMgr, param1, (param2 == 0) - 1);
          break;
        case 2:
          HIWORD(index) = 0;
          Q_GameLoop_dword_96774 = 0;
          break;
        case 3:
          HIWORD(index) = 0xFFFF;
          sub_570AC(pWinMgr, 0xFFFFFFFF);
          break;
        case 4:
          if ( !pWinMgr->aaa && !pWinMgr->bbb )
          {
            index = "WINEVENT.BIN";
            sub_59988(pWinMgr, "WINEVENT.BIN", 0xFFFFFFFF);
          }
          break;
        case 5:
          switch ( param2 )
          {
            case 1:
              index = "ABILITYWIN";
              Wnd_sub_56DA8 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(pWinMgr, "ABILITYWIN", 0);
              Q_ShowHelpTopicAbil_sub_33884(Wnd_sub_56DA8, "ABILITYWIN", 0, param1);
              break;
            case 2:
              v10 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = v10;
              sprintf(s, "STATE%02d", pWinMgr->state);
              index = "help.txt";
              Q_ShowHelpTopic_sub_2FCB0(v10, "help.txt", s);
              break;
            case 3:
              index = "help.txt";
              Wnd_sub_56DA8 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Q_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, "help.txt", "NOINTRO");
              break;
            case 4:
              sprintf(helptopic, "gizmo%02d", param1);
              v11 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = v11;
              Q_ShowHelpTopic_sub_2FCB0(v11, "gizhelp.txt", helptopic);
              v12 = v11->Unknown_C95[0];
              Unknown_C95 = v11->Unknown_C95;
              Unknown_04 = v11->Unknown_C91[0].Unknown_04;
              if ( v12 != 1 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x784);
              }
              if ( *Unknown_04 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x785);
              }
              strcpy(format, *(const char **)(Unknown_C95 + 5));
              index = "gizhelp.txt";
              sprintf(*(char **)(Unknown_C95 + 5), format, &V_Gizmos[param1]);
              v13 = (int)Unknown_04;
              *(_WORD *)(Unknown_04 + 1) = 0x1C;
              *(_WORD *)(v13 + 3) = param1;
              break;
            case 5:
              sprintf(v23, "plitem%02d", param1);
              v14 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = v14;
              Q_ShowHelpTopic_sub_2FCB0(v14, "planhelp.txt", v23);
              v15 = v14->Unknown_C95[0];
              v26 = v14->Unknown_C95;
              v25 = v14->Unknown_C91[0].Unknown_04;
              if ( v15 != 1 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x79F);
              }
              if ( *v25 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x7A0);
              }
              strcpy(v20, *(const char **)(v26 + 5));
              index = *(char **)(v26 + 5);
              sprintf(index, v20, V_PlanetItems.item[param1].name);
              if ( param1 == 0x17 )
              {
                index = v25;
                v17 = V_PlayerRaceIndex;
                *(_WORD *)(v25 + 3) = 0;
                *(_WORD *)(index + 1) = v17 + 0xE;
              }
              else
              {
                v16 = (int)v25;
                *(_WORD *)(v25 + 1) = 0x1E;
                *(_WORD *)(v16 + 3) = param1;
              }
              break;
            default:
              index = "HELPWINDOW";
              v18 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(pWinMgr, "HELPWINDOW", 0);
              Wnd_sub_56DA8 = v18;
              if ( param1 )
              {
                index = "help.txt";
                Q_ShowHelpTopic_sub_2FCB0(v18, "help.txt", (char *)param1);
              }
              break;
          }
          if ( !pWinMgr->Unknown_489E )
          {
            HIWORD(index) = HIWORD(Wnd_sub_56DA8);
            sub_552F8(pWinMgr, &Wnd_sub_56DA8->a2, 0);
          }
          if ( param2 == 1 )
          {
            index = (char *)Q_FindWnd_sub_56DA8(pWinMgr, "COSMOSWnd", 0)->a1.index;
            Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, (int)index, 0xD, 0, 0);
          }
          break;
        case 6:
          pWinMgr->Unknown_489E = 0;
          pWinMgr->Unknown_48A2 = param1;
          break;
        case 7:
          v6 = sub_20B3C(&V_Game);
          if ( v6 )
          {
            v7 = 7;
            if ( *(int *)((char *)&pWinMgr->wnds[0].activeCount + (_DWORD)&loc_24D9B + 1) == 0xFFFFFFFF )
            {
              v7 = 8;
            }
            HIWORD(index) = 0;
            Q_AddGameEvent_sub_55AEC(pWinMgr, 0x13, (int)v6, v7);
          }
          else
          {
            sub_20C94(&V_Game, (int)index, 0, param1);
            if ( *(int *)((char *)&pWinMgr->wnds[0].activeCount + (_DWORD)&loc_24D9E + 2) == 0xFFFFFFFF )
            {
              for ( i = 0; i < V_Game.racesNum; ++i )
              {
                if ( i != V_PlayerRaceIndex )
                {
                  sub_46130(&V_Game.races[V_PlayerRaceIndex].index, i, 0xFFFFFFFF);
                  sub_45F60(&V_Game.races[V_PlayerRaceIndex].index, i, 0xFFFFFFFF);
                }
              }
            }
            HIWORD(index) = 0;
            sub_56BE8(pWinMgr, 0xD, 0, 0, 0);
            sub_5508C(pWinMgr);
          }
          break;
        case 8:
          v9 = sub_20B3C(&V_Game);
          if ( !v9 || V_FlashPopExists )
          {
            pWinMgr->Unknown_24D9C = ~pWinMgr->Unknown_24D9C;
          }
          else
          {
            HIWORD(index) = 0;
            Q_AddGameEvent_sub_55AEC(pWinMgr, 0x13, (int)v9, (__int16)index);
          }
          break;
        default:
          index = "..\\winmgr.cpp";
          Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x7D7);
          break;
      }
      LOWORD(v31) = v31 + 1;
    }
    while ( (__int16)v31 < (__int16)v30 );
  }
}
// 96774: using guessed type int Q_GameLoop_dword_96774;
// 55E80: using guessed type char format[600];
// 55E80: using guessed type char var_2E4[600];

//----- (00056400) --------------------------------------------------------
void __fastcall sub_56400(T_WinMgr *a1, int a2, __int16 a3, int a4, int a5, int a6)
{
  __int16 i; // kr00_2
  int v9; // eax

  if ( a1->counter1 == 0x10 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x7ED);
  }
  if ( a1->aaa == 0xFFFFFFFF || a1->bbb == 0xFFFFFFFF )
  {
    a6 = 0;
  }
  for ( i = 0; i < 0x10; ++i )
  {
    if ( !a1->b1[i].a )
    {
      a1->b1[i].a = a2;
      a1->b1[i].c = a4;
      a1->b1[i].b = a3;
      a1->b1[i].d = a5;
      v9 = V_Timer_dword_132B58;
      a1->b1[i].e = a6;
      a1->b1[i].f = a6 + v9;
      ++a1->counter1;
      break;
    }
  }
  sub_59C80(a1, a2, 4, a3, a4, a5, 0);
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (000564C0) --------------------------------------------------------
void __fastcall sub_564C0(T_WinMgr *a1, int a2, __int16 a3)
{
  __int16 i; // dx

  for ( i = 0; i < 0x10; ++i )
  {
    if ( a2 == a1->b1[i].a && (a3 == 0xFFFFFFFF || a3 == a1->b1[i].b) )
    {
      a1->b1[i].a = 0;
      --a1->counter1;
    }
  }
  sub_59C80(a1, a2, 5, a3, 0, 0, 0);
}

//----- (00056528) --------------------------------------------------------
int __fastcall sub_56528(int a1, int a2, __int16 a3)
{
  __int16 i; // ax

  for ( i = 0; i < 0x10; ++i )
  {
    if ( a2 == *(_DWORD *)(a1 + 0x16 * i + 0x44AE) && a3 == *(_WORD *)(a1 + 0x16 * i + 0x44B2) )
    {
      return *(_DWORD *)(a1 + 0x16 * i + 0x44BC);
    }
  }
  return 0xFFFF;
}

//----- (00056564) --------------------------------------------------------
unsigned int __fastcall sub_56564(int a1, int a2, __int16 a3, int a4)
{
  __int16 i; // dx

  for ( i = 0; i < 0x10; ++i )
  {
    if ( a2 == *(_DWORD *)(a1 + 0x16 * i + 0x44AE) && a3 == *(_WORD *)(a1 + 0x16 * i + 0x44B2) )
    {
      *(_DWORD *)(a1 + 0x16 * i + 0x44BC) = a4;
      return 0xFFFFFFFF;
    }
  }
  return 0;
}

//----- (00056694) --------------------------------------------------------
int __fastcall sub_56694(T_WinMgr *a1)
{
  __int16 counter1; // di
  int result; // eax
  T_SomeStruct5 *v4; // esi
  void (__fastcall *a)(int, int); // edx
  T_SomeStruct5 *b1; // [esp+4h] [ebp-20h]
  __int16 i; // [esp+8h] [ebp-1Ch]

  counter1 = a1->counter1;
  b1 = a1->b1;
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= 0x10 || counter1 <= 0 )
    {
      break;
    }
    v4 = &b1[i];
    a = (void (__fastcall *)(int, int))v4->a;
    if ( v4->a )
    {
      if ( (unsigned int)V_Timer_dword_132B58 >= v4->f )
      {
        if ( v4->b == 0x29A )
        {
          a(v4->c, v4->d);
        }
        else
        {
          Q_WinMgr_DispatchMessageProc3_sub_56D30(a1, (int)a, v4->b, v4->c, v4->d);
        }
        v4->f += v4->e;
      }
      --counter1;
    }
  }
  return result;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (00056728) --------------------------------------------------------
void __fastcall sub_56728(P_WinMgr a1, int hwnd, int f, WORD msg, int p1, int p2)
{
  __int16 i; // kr00_2

  if ( a1->winEventSmallNum == 16 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x8C6);
  }
  for ( i = 0; i < 16; ++i )
  {
    if ( !a1->winEventsSmall[i].hwnd )
    {
      a1->winEventsSmall[i].hwnd = hwnd;
      a1->winEventsSmall[i].f = f;
      a1->winEventsSmall[i].msg = msg;
      a1->winEventsSmall[i].p1 = p1;
      a1->winEventsSmall[i].p2 = p2;
      ++a1->winEventSmallNum;
      break;
    }
  }
  sub_59C80(a1, hwnd, 6, msg, p1, p2, f);
}

//----- (000567BC) --------------------------------------------------------
void __fastcall sub_567BC(P_WinMgr a1, int a2, __int16 a3)
{
  __int16 i; // dx

  for ( i = 0; i < 16; ++i )
  {
    if ( a2 == a1->winEventsSmall[i].hwnd && (a3 == 0xFFFFFFFF || a3 == a1->winEventsSmall[i].msg) )
    {
      a1->winEventsSmall[i].hwnd = 0;
      --a1->winEventSmallNum;
    }
  }
  sub_59C80(a1, a2, 7, a3, 0, 0, 0);
}

//----- (00056824) --------------------------------------------------------
void __fastcall sub_56824(T_WinMgr *a1)
{
  int hwnd; // edi
  int v3; // [esp+0h] [ebp-28h]
  int v4; // [esp+4h] [ebp-24h]
  __int16 i; // [esp+8h] [ebp-20h]
  WORD winEventSmallNum; // [esp+Ch] [ebp-1Ch]

  winEventSmallNum = a1->winEventSmallNum;
  v4 = 0;
  v3 = 0;
  if ( V_Mouse.leftClicked == 0xFFFFFFFF )
  {
    v4 = 1;
  }
  if ( V_Mouse.rightClicked == 0xFFFFFFFF )
  {
    LOBYTE(v4) = v4 | 2;
  }
  if ( V_Mouse.moved == 0xFFFFFFFF )
  {
    LOBYTE(v3) = 4;
  }
  for ( i = 0; i < 0x10 && winEventSmallNum > 0; ++i )
  {
    hwnd = a1->winEventsSmall[i].hwnd;
    if ( hwnd )
    {
      if ( (v4 & a1->winEventsSmall[i].f) != 0 )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(
          a1,
          a1->winEventsSmall[i].hwnd,
          a1->winEventsSmall[i].msg,
          a1->winEventsSmall[i].p1,
          a1->winEventsSmall[i].p2);
      }
      if ( (v3 & a1->winEventsSmall[i].f) != 0 )
      {
        Q_WinMgr_DispatchMessageProc3_sub_56D30(a1, hwnd, a1->winEventsSmall[i].msg, V_Mouse.x, V_Mouse.y);
      }
      --winEventSmallNum;
    }
  }
}

//----- (0005691C) --------------------------------------------------------
void __fastcall sub_5691C(P_WinMgr pWinMgr)
{
  LONG x; // edi
  int v3; // edx
  LONG y; // ebp
  T_WndA2 *pWndA2; // ecx
  __int16 v6; // dx
  P_Wnd v7; // eax
  LONG x1; // ebx
  PANE *p_pane; // eax
  int state; // edx
  __int16 v11; // cx
  int v12; // eax
  T_WndA2 *v13; // edx
  unsigned int v14; // [esp+4h] [ebp-28h]
  int wndIndex; // [esp+8h] [ebp-24h]
  P_Wnd v16; // [esp+Ch] [ebp-20h]
  WORD windowCount; // [esp+10h] [ebp-1Ch]

  x = V_Mouse.x;
  v3 = pWinMgr->_wndIndex;
  y = V_Mouse.y;
  if ( v3 == 0xFFFFFFFF )
  {
    goto LABEL_17;
  }
  pWndA2 = pWinMgr->wnds[v3].pWndA2;
  if ( V_Mouse.x > pWndA2->a1.pane.x1 || V_Mouse.x < pWndA2->a1.pane.x0 || V_Mouse.y > pWndA2->a1.pane.y1 || V_Mouse.y < pWndA2->a1.pane.y0 )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 8, V_Mouse.x, V_Mouse.y);
    Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 6, 0, 0);
    pWinMgr->_wndIndex = 0xFFFFFFFF;
LABEL_17:
    state = pWinMgr->state;
    if ( state >= 0 )
    {
      v11 = 0x1F;
      v14 = 0;
      windowCount = pWinMgr->winStates[state]._windowCount;
      while ( windowCount > 0 && !v14 )
      {
        if ( v11 < 0 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x992);
        }
        v12 = pWinMgr->winStates[pWinMgr->state]._wndIndexes[v11];
        wndIndex = v12;
        if ( v12 )
        {
          v13 = pWinMgr->wnds[v12].pWndA2;
          if ( v13->a1.Unknown_A3 == 0xFFFFFFFF
            && x <= v13->a1.pane.x1
            && x >= v13->a1.pane.x0
            && y <= v13->a1.pane.y1
            && y >= v13->a1.pane.y0
            && v13->a1.Unknown_35 == 0xFFFFFFFF )
          {
            v14 = 0xFFFFFFFF;
          }
          --windowCount;
        }
        --v11;
      }
      if ( v14 == 0xFFFFFFFF )
      {
        pWinMgr->_wndIndex = wndIndex;
        Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, 7, 0, 0);
      }
    }
    return;
  }
  if ( pWndA2->a1.childrenNum )
  {
    v6 = 0;
    if ( pWndA2->a1.childrenNum > 0 )
    {
      while ( 1 )
      {
        v7 = (*pWndA2->a1.children)[v6];
        v16 = v7;
        if ( v7->Unknown_35 )
        {
          x1 = v7->pane.x1;
          p_pane = &v7->pane;
          if ( V_Mouse.x <= x1 && V_Mouse.x >= p_pane->x0 && V_Mouse.y <= p_pane->y1 && V_Mouse.y >= p_pane->y0 )
          {
            break;
          }
        }
        if ( ++v6 >= pWndA2->a1.childrenNum )
        {
          return;
        }
      }
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 8, V_Mouse.x, V_Mouse.y);
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, pWinMgr->_wndIndex, 6, 0, 0);
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, v16->index, 7, 0, 0);
      pWinMgr->_wndIndex = v16->index;
    }
  }
}
// 56B46: variable 'wndIndex' is possibly undefined

//----- (00056B60) --------------------------------------------------------
void __fastcall Q_WinMgr_QueueMessage_sub_56B60(P_WinMgr pWinMgr, WORD message, LONG param1, LONG param2)
{
  if ( pWinMgr->messageQueueCount == 32 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x9B5);
  }
  pWinMgr->messageQueue[pWinMgr->messageQueueCount].message = message;
  pWinMgr->messageQueue[pWinMgr->messageQueueCount].param1 = param1;
  pWinMgr->messageQueue[pWinMgr->messageQueueCount++].param2 = param2;
}

//----- (00056BE8) --------------------------------------------------------
void __fastcall sub_56BE8(P_WinMgr pWinMgr, __int16 message, int param1, int param2, int a5)
{
  int state; // edx
  __int16 v7; // si
  int v8; // ecx
  int v9; // eax
  T_WndA2 *pWndA2; // eax
  unsigned int v11; // edx
  WORD windowCount; // [esp+Ch] [ebp-10h]

  state = pWinMgr->state;
  if ( state >= 0 )
  {
    v7 = 0x1F;
    v8 = 0;
    windowCount = pWinMgr->winStates[state]._windowCount;
    while ( windowCount > 0 && !v8 )
    {
      v8 = 0;
      if ( v7 < 0 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x9EA);
      }
      v9 = pWinMgr->winStates[pWinMgr->state]._wndIndexes[v7];
      if ( v9 )
      {
        pWndA2 = pWinMgr->wnds[v9].pWndA2;
        if ( !a5 || byte_132B38[v7] )
        {
          if ( (pWndA2->a1.Unknown_35 || message == 1 || message == 0xE) && (!pWndA2->a1.parentIndex || message > 2) )
          {
            v11 = 0xFFFFFFFF;
          }
          else
          {
            v11 = 0;
          }
          if ( v11 )
          {
            if ( a5 )
            {
              byte_132B38[v7] = 1;
            }
            v8 = pWndA2->pProcs->proc3(pWndA2, message, param1, param2);
          }
          else if ( a5 )
          {
            byte_132B38[v7] = 0;
          }
        }
        --windowCount;
      }
      --v7;
    }
  }
}

//----- (00056D30) --------------------------------------------------------
// Dispatches a message to a window's handler if the WinMgr is in a valid state
int __fastcall Q_WinMgr_DispatchMessageProc3_sub_56D30(P_WinMgr pWinMgr, int wndIndex, WORD message, LONG param1, LONG param2)
{
  int result; // eax

  if ( pWinMgr->state < 0 )
  {
    return 0;
  }
  pWinMgr->wnds[wndIndex].pWndA2->pProcs->proc3(pWinMgr->wnds[wndIndex].pWndA2, message, param1, param2);
  return result;
}

//----- (00056D70) --------------------------------------------------------
T_WndA2 *__fastcall sub_56D70(T_WinMgr *a1, char *a2, __int16 a3, LONG a4, int param2)
{
  T_WndA2 *result; // eax
  int v7; // [esp+0h] [ebp-Eh] BYREF

  result = Q_FindWnd_sub_56DA8(a1, a2, (_WORD *)&v7 + 1);
  if ( result )
  {
    Q_WinMgr_DispatchMessageProc3_sub_56D30(a1, SHIWORD(v7), a3, a4, param2);
    return (T_WndA2 *)0xFFFFFFFF;
  }
  return result;
}

//----- (00056DA8) --------------------------------------------------------
T_WndA2 *__fastcall Q_FindWnd_sub_56DA8(P_WinMgr pWinMgr, char *name, _WORD *pIndex)
{
  WORD j; // si
  __int16 i; // cx
  T_WndA2 *pWndA2; // edx

  j = 0;
  for ( i = 0; ; ++i )
  {
    if ( i >= 1024 || j > pWinMgr->wndsCnt )
    {
      return 0;
    }
    pWndA2 = pWinMgr->wnds[i].pWndA2;
    if ( pWndA2 )
    {
      ++j;
      if ( !strncmp(name, pWndA2->a1.name, 10u) )
      {
        break;
      }
    }
  }
  if ( pIndex )
  {
    *pIndex = i;
  }
  return pWinMgr->wnds[i].pWndA2;
}

//----- (00056E18) --------------------------------------------------------
T_WndA2 *__fastcall sub_56E18(P_WinMgr a1, char *s1, __int16 a3, _WORD *a4)
{
  WORD i; // cx
  int v7; // edi
  T_WndA2 *pWndA2; // edx

  if ( a3 < a1->_activeStateCount )
  {
    for ( i = 0; i < a1->winStates[a3]._windowCount; ++i )
    {
      v7 = a1->winStates[a3]._wndIndexes[i];
      pWndA2 = a1->wnds[v7].pWndA2;
      if ( pWndA2 && !strncmp(s1, pWndA2->a1.name, 0xAu) )
      {
        if ( a4 )
        {
          *a4 = v7;
        }
        return a1->wnds[v7].pWndA2;
      }
    }
  }
  return 0;
}

//----- (00056E9C) --------------------------------------------------------
void __fastcall sub_56E9C(P_WinMgr pWinMgr, WORD a2, int a3)
{
  int state; // ebx
  int Unknown_0; // edx
  int track; // edx
  int v8; // ebx
  int wndIndex; // eax
  __int16 Unknown_4758; // ax
  PANE_LIST *pPaneList; // eax
  int v12; // eax

  if ( a2 != pWinMgr->state )
  {
    if ( a2 < 0 || a2 >= 0x20 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xA9B);
    }
    state = pWinMgr->state;
    if ( state >= 0 )
    {
      Unknown_0 = pWinMgr->winStates[state].Unknown_0;
      if ( Unknown_0 != 0xFFFFFFFF )
      {
        Q_SSystem_EndSequence_sub_4F45C(&V_SoundSystem, Unknown_0);
      }
    }
    track = pWinMgr->winStates[a2].Unknown_0;
    if ( track != 0xFFFFFFFF )
    {
      Q_SSystem_StartSequence_sub_4F32C(&V_SoundSystem, track, 0);
    }
    v8 = pWinMgr->state;
    if ( v8 >= 0 && pWinMgr->winStates[v8].Proc2 )
    {
      ((void (__fastcall *)(_DWORD, T_WinState *))pWinMgr->winStates[v8].Proc2)(pWinMgr->state, &pWinMgr->winStates[v8]);
    }
    wndIndex = pWinMgr->_wndIndex;
    if ( wndIndex != 0xFFFFFFFF )
    {
      Q_WinMgr_DispatchMessageProc3_sub_56D30(pWinMgr, wndIndex, 6, 0, 0);
    }
    sub_56BE8(pWinMgr, 2, 0, 0, 0);
    if ( a3 == 0xFFFFFFFF && pWinMgr->state >= 0 )
    {
      Unknown_4758 = pWinMgr->Unknown_4758;
      pWinMgr->Unknown_4758 = Unknown_4758 + 1;
      pWinMgr->Unknown_4736[Unknown_4758] = pWinMgr->state;
      if ( pWinMgr->Unknown_4758 == 0x10 )
      {
        pWinMgr->Unknown_4758 = 0;
      }
      ++pWinMgr->Unknown_4756;
    }
    pWinMgr->state = a2;
    if ( !pWinMgr->state && dword_96BC0 == 0xFFFFFFFF && !access("resume.gam", 0) )
    {
      Q_LoadGam_sub_53FB0("resume.gam");
    }
    pPaneList = pWinMgr->pPaneList;
    dword_96BC0 = 0;
    VFX_pane_list_clear(pPaneList);
    Q_WinMgr_WipeAndAddDirtyArea_sub_55214(pWinMgr, 0, 0, 639, 479);
    v12 = a2;
    if ( pWinMgr->winStates[v12].Proc1 )
    {
      ((void (__fastcall *)(_DWORD, T_WinState *))pWinMgr->winStates[v12].Proc1)(a2, &pWinMgr->winStates[v12]);
    }
    sub_56BE8(pWinMgr, 1, 0, 0, 0);
    pWinMgr->_wndIndex = 0xFFFFFFFF;
    sub_5691C(pWinMgr);
  }
}
// 96BC0: using guessed type int dword_96BC0;

//----- (000570AC) --------------------------------------------------------
int __fastcall sub_570AC(P_WinMgr a1, int a2)
{
  __int16 v4; // dx
  int v5; // ecx

  if ( !a1->Unknown_4756 )
  {
    return 0;
  }
  if ( a1->Unknown_4758 )
  {
    v4 = a1->Unknown_4758 - 1;
  }
  else
  {
    v4 = 0xF;
  }
  v5 = v4;
  LOWORD(v5) = a1->Unknown_4736[v4];
  if ( a2 == 0xFFFFFFFF )
  {
    a1->Unknown_4758 = v4;
    a1->Unknown_4736[a1->Unknown_4758] = 0xFFFF;
    --a1->Unknown_4756;
    sub_56E9C(a1, v5, 0);
  }
  return v5;
}

//----- (000571B8) --------------------------------------------------------
int __fastcall Q_WinMgr_RegisterWindow_sub_571B8(P_WinMgr pWinMgr, P_Wnd pWnd)
{
  __int16 i; // dx
  int result; // eax
  T_WinEntry *winEntry; // ebx

  if ( !pWnd || pWinMgr->wndsCnt == 0x3FF )
  {
    return 0;
  }
  for ( i = 1; ; ++i )
  {
    result = i;
    if ( i >= 1024 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB37);
    }
    winEntry = &pWinMgr->wnds[i];
    if ( !winEntry->activeCount )
    {
      break;
    }
  }
  winEntry->activeCount = 1;
  winEntry->pWndA2 = (T_WndA2 *)pWnd;
  ++pWinMgr->wndsCnt;
  pWnd->magic12345678 = 0x12345678;
  return result;
}

//----- (00057220) --------------------------------------------------------
// Adds a window to a window manager state
// @param pWinMgr Window manager instance
// @param windowIndex Index of window to add (1-1023)
// @param state State to add window to (0-31)
// @return TRUE if window was added successfully, FALSE otherwise
MACRO_VFX_BOOL __fastcall Q_WinMgr_AddWindowToState_sub_57220(P_WinMgr pWinMgr, int windowIndex, WORD state)
{
  P_WinMgr pWinMgr_; // kr00_4
  __int16 slot; // ax

  // Validate state parameter
  if ( state < 0 || state >= 32 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB42);
  }
  // Validate window index
  if ( windowIndex >= 1024 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB43);
  }
  // Return FALSE for invalid window index 0
  if ( !windowIndex )
  {
    return FALSE;
  }
  pWinMgr_ = pWinMgr;
  // Check if state is full
  if ( pWinMgr->winStates[state]._windowCount == 32 )
  {
    return FALSE;
  }
  // Try to find empty slot in existing state
  slot = 0;
  if ( pWinMgr_->winStates[state]._windowCount )
  {
    while ( slot < 32 )
    {
      if ( !pWinMgr->winStates[state]._wndIndexes[slot] )
      {
        // Found empty slot
        pWinMgr->winStates[state]._wndIndexes[slot] = windowIndex;
        ++pWinMgr->winStates[state]._windowCount;
        break;
      }
      ++slot;
    }
  }
  else
  {
    // Initialize new state
    ++pWinMgr->_activeStateCount;
    pWinMgr_->winStates[state]._windowCount = 1;
    pWinMgr_->winStates[state]._wndIndexes[0] = windowIndex;
  }
  // Increment window's active count
  ++pWinMgr->wnds[windowIndex].activeCount;
  if ( slot >= 32 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB65);
  }
  return TRUE;
}

//----- (00057310) --------------------------------------------------------
unsigned int __fastcall sub_57310(P_WinMgr a1, int a2, __int16 a3, int a4)
{
  __int16 i; // cx
  int v7; // ebx

  if ( a3 < 0 || a3 >= 0x20 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB75);
  }
  if ( a2 >= 0x400 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xB76);
  }
  if ( !a2 || !a1->winStates[a3]._windowCount )
  {
    return 0;
  }
  for ( i = 0; i < 0x20; ++i )
  {
    v7 = a1->winStates[a3]._wndIndexes[i];
    if ( a2 == v7 )
    {
      a1->winStates[a3]._wndIndexes[i] = 0;
      --a1->winStates[a3]._windowCount;
      --a1->wnds[v7].activeCount;
      if ( a4 )
      {
        sub_57530(a1, a2, 0);
      }
      break;
    }
  }
  if ( i < 0x20 )
  {
    return 0xFFFFFFFF;
  }
  else
  {
    return 0;
  }
}

//----- (0005748C) --------------------------------------------------------
unsigned int __fastcall sub_5748C(P_WinMgr a1, __int16 stateNumber, __int16 a3)
{
  unsigned int result; // eax

  if ( stateNumber < 0 || stateNumber >= 0x20 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xBA8);
  }
  if ( (unsigned __int16)a1->winStates[stateNumber].Unknown_84 != 0xFFFF )
  {
    return 0;
  }
  result = 0xFFFFFFFF;
  a1->winStates[stateNumber].Unknown_84 = a3;
  return result;
}

//----- (000574F0) --------------------------------------------------------
void __fastcall Q_SetProc1_sub_574F0(P_WinMgr a1, __int16 index, void *proc)
{
  a1->winStates[index].Proc1 = proc;
}

//----- (00057510) --------------------------------------------------------
void __fastcall Q_SetProc2_sub_57510(P_WinMgr a1, __int16 index, void *proc)
{
  a1->winStates[index].Proc2 = proc;
}

//----- (00057530) --------------------------------------------------------
void __fastcall sub_57530(P_WinMgr a1, int wndIndex, int a3)
{
  int v5; // edx
  P_WinMgr v6; // kr00_4
  T_WndA2 *pWndA2; // eax
  int v8; // eax

  if ( wndIndex >= 1024 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xBDB);
  }
  if ( wndIndex )
  {
    v5 = a1->wnds[wndIndex].activeCount - 1;
    a1->wnds[wndIndex].activeCount = v5;
    if ( !v5 || a3 )
    {
      v6 = a1;
      Q_RemoveWinDataFromWinMgr_sub_2627C(a1->wnds[wndIndex].pWndA2);
      pWndA2 = v6->wnds[wndIndex].pWndA2;
      if ( pWndA2 )
      {
        ((void (*)(void))pWndA2->pProcs->proc1)();
      }
      v8 = wndIndex;
      a1->wnds[v8].pWndA2 = 0;
      a1->wnds[v8].activeCount = 0;
      --a1->wndsCnt;
    }
  }
}

//----- (000575BC) --------------------------------------------------------
void __fastcall sub_575BC(P_WinMgr a1)
{
  void *v2; // eax
  T_HazeTable *v3; // ecx
  _BYTE *v4; // kr00_4
  void *v5; // eax
  T_HazeTable *v6; // ecx
  _BYTE *v7; // kr08_4
  int i; // eax
  int j; // eax

  v2 = operator new[](0x100u);
  Q_RegisterData_sub_2625C(v2, 1, "WMGR MAPFOCUS");
  v3 = (T_HazeTable *)v2;
  if ( !v2 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xBF7);
  }
  v4 = v2;
  for ( i = 0; i < 0x100; ++i )
  {
    v4[i] = i;
  }
  (*v3)[0xF2] = 0x96;
  a1->hazeTableMapFocus = v3;
  v5 = operator new[](0x100u);
  Q_RegisterData_sub_2625C(v5, 1, "WMGR MAPRACES");
  v6 = (T_HazeTable *)v5;
  if ( !v5 )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xC01);
  }
  v7 = v5;
  for ( j = 0; j < 0x100; ++j )
  {
    v7[j] = j;
  }
  a1->hazeTableMapRaces = v6;
  a1->pPaneList = VFX_pane_list_construct(0x80);
  Q_WINMGR_CPP_LoadWindowsTxt_sub_57670(a1, "windows.txt");
}

//----- (00057670) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_LoadWindowsTxt_sub_57670(P_WinMgr pType3, const char *fname)
{
  FILE *fp0; // edx
  FILE *fp; // esi
  int largestMem; // ecx
  char *v6; // ebx
  T_Wnd *pTypeA1; // eax
  int v8; // edx
  T_Matrices *p_pane; // eax
  T_Matrices *v10; // eax
  T_Wnd *v11; // edx
  char *pName; // ebp
  T_WndA2 *v13; // ecx
  T_Wnd *v14; // edx
  __int16 mm; // cx
  P_Wnd v16; // edx
  WORD v17; // ax
  P_Wnd v18; // edx
  P_Wnd v19; // edx
  int t19; // ecx
  WORD *p_hotX; // ebp
  WORD *v22; // ebx
  T_Wnd01FLIC *v23; // eax
  int v24; // ebp
  char *name; // edx
  T_WndA2 *Wnd_sub_56DA8; // eax
  int i; // ecx
  int v28; // ebx
  int j; // ecx
  WINDOW *window; // eax
  WORD racesNum; // dx
  int v32; // eax
  WORD v33; // bx
  char v34; // dh
  T_TypeA3 *v35; // eax
  T_TypeA3 *v36; // ebp
  char *v37; // edx
  T_WndA2 *v38; // eax
  __int16 k; // cx
  WORD Unknown_84; // ax
  P_Wnd04BM v41; // eax
  P_Wnd04BM v42; // ebp
  char *v43; // edx
  T_WndA2 *v44; // eax
  int ii; // ecx
  WINDOW *v46; // eax
  __int16 jj; // cx
  WORD v48; // ax
  P_Wnd10LB vpWnd10LB; // eax
  P_Wnd10LB v50; // ebp
  char *v51; // edx
  T_WndA2 *v52; // eax
  int kk; // ecx
  __int16 v54; // ax
  signed __int16 l; // cx
  unsigned __int16 v56; // bx
  P_Wnd13DBGWND v57; // eax
  P_Wnd13DBGWND v58; // ecx
  WINDOW *v59; // eax
  P_Wnd08SW v60; // eax
  P_Wnd08SW v61; // ebp
  char *v62; // edx
  T_WndA2 *v63; // eax
  P_Wnd2COSW vpWnd2COSW; // eax
  char *v65; // edx
  P_Wnd2COSW vpWnd2COSW__; // ebp
  T_WndA2 *v67; // eax
  WORD *v68; // [esp-Ch] [ebp-3C8h]
  WORD *v69; // [esp-Ch] [ebp-3C8h]
  WORD *v70; // [esp-4h] [ebp-3C0h]
  WORD *v71; // [esp-4h] [ebp-3C0h]
  char v72[108]; // [esp+0h] [ebp-3BCh] BYREF
  char v73[108]; // [esp+80h] [ebp-33Ch] BYREF
  char bufc2[108]; // [esp+100h] [ebp-2BCh] BYREF
  char bufc4[108]; // [esp+180h] [ebp-23Ch] BYREF
  char bufc3[108]; // [esp+200h] [ebp-1BCh] BYREF
  char v77[108]; // [esp+280h] [ebp-13Ch] BYREF
  char v78[32]; // [esp+300h] [ebp-BCh] BYREF
  char bufc1[32]; // [esp+334h] [ebp-88h] BYREF
  WORD v80[7]; // [esp+368h] [ebp-54h] BYREF
  int bufi; // [esp+378h] [ebp-44h] BYREF
  P_Wnd a1a; // [esp+37Ch] [ebp-40h]
  int v83; // [esp+380h] [ebp-3Ch]
  P_Cache p_cache; // [esp+384h] [ebp-38h]
  P_Cache v85; // [esp+388h] [ebp-34h]
  T_Font *p_SmallFont; // [esp+38Ch] [ebp-30h]
  T_Font *p_LargeFont; // [esp+390h] [ebp-2Ch]
  WORD *p_hotY; // [esp+394h] [ebp-28h]
  WORD *p_shapeNumber; // [esp+398h] [ebp-24h]
  int m; // [esp+39Ch] [ebp-20h]
  int bufi2; // [esp+3A0h] [ebp-1Ch] BYREF
  int v92; // [esp+3A4h] [ebp-18h] BYREF
  __int16 wndType; // [esp+3A8h] [ebp-14h]
  int winItems; // [esp+3ACh] [ebp-10h]
  int v95; // [esp+3B0h] [ebp-Ch]
  __int16 numControls; // [esp+3B4h] [ebp-8h] BYREF
  WORD n; // [esp+3B8h] [ebp-4h]

  fp0 = Q_OpenFile_sub_1BB10(fname, 0);
  fp = fp0;
  if ( fp0 )
  {
    // MEM_REQ        2300000
    fscanf(fp0, "%s %d", bufc1, &bufi);
    largestMem = Q_CheckFreeMemory_sub_53DEC();
    if ( largestMem <= bufi )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xC27);
    }
    Q_Cache_RegisterShapeCache_sub_1AD1C(&pType3->cache, largestMem - 200000);
    Q_GWINDOW_CPP_LoadGwshareTxt_sub_2D2CC();
    p_cache = &pType3->cache;
    p_LargeFont = &pType3->LargeFont;
    v85 = &pType3->cache;
    p_SmallFont = &pType3->SmallFont;
    while ( 1 )
    {
      fscanf(fp, "%s %d", bufc1, &bufi);
      if ( bufi == 0xFFFFFFFF )
      {
        // END            -1
        fclose(fp);
        return;
      }
      wndType = bufi;
      if ( (unsigned int)bufi < 9 )
      {
        if ( (unsigned int)bufi < 3 )
        {
          if ( !bufi )
          {
            goto LABEL_16;
          }
          if ( (unsigned int)bufi <= 1 )
          {
            // TYPE           1
            // Intro
            v23 = (T_Wnd01FLIC *)operator new(0xA09u);
            if ( v23 )
            {
              Q_Wnd1FLICCtor_sub_2AE80(v23);
            }
            Q_RegisterData_sub_2625C(v23, 2, "FLIC");
            v24 = (int)v23;
            name = v23->a.a1.name;
            Q_WINMGR_CPP_RegisterWindow_sub_2C978(&v23->a.a1);
            // INTROFLIC
            fscanf(fp, "%s %s", bufc1, name);
            fscanf(fp, "%s", bufc1);
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              Wnd_sub_56DA8 = Q_FindWnd_sub_56DA8(pType3, bufc1, 0);
              if ( !Wnd_sub_56DA8 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xCF8);
              }
              *(_DWORD *)(v24 + 0x63) = Wnd_sub_56DA8->a1.index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(&Wnd_sub_56DA8->a1, (P_Wnd)v24);
            }
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( i = 0; (__int16)i < (__int16)bufi2; ++i )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pType3, *(_DWORD *)(v24 + 0x41), bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xD02);
              }
            }
            fscanf(fp, "%s %d", bufc1, v24 + 8);
            fscanf(fp, "%s %d", bufc1, v24 + 0xC);
            fscanf(fp, "%s %d", bufc1, v24 + 0x10);
            fscanf(fp, "%s %d", bufc1, v24 + 0x14);
            fscanf(fp, "%s %s", bufc1, v77);
            sub_2AF04(v24, v77);
            fscanf(fp, "%s %d", bufc1, &bufi);
            *(_WORD *)(v24 + 0xA01) = bufi;
            fscanf(fp, "%s %d", bufc1, &bufi);
            *(_WORD *)(v24 + 0xA03) = bufi;
            fscanf(fp, "%s %d", bufc1, &bufi);
            *(_WORD *)(v24 + 0xA05) = bufi;
            fscanf(fp, "%s %d", bufc1, &bufi);
            *(_WORD *)(v24 + 0xA07) = bufi;
            fscanf(fp, "%s %d", bufc1, &bufi);
            v28 = bufi;
            if ( bufi != 0xFFFFFFFF )
            {
              *(_DWORD *)(v24 + 0x9E5) = 0xFFFFFFFF;
              *(_DWORD *)(v24 + 0x9E9) = v28;
            }
            fscanf(fp, "%s %d", bufc1, v24 + 0x45);
            fscanf(fp, "%s %d", bufc1, v24 + 0x47);
            fscanf(fp, "%s %d", bufc1, v24 + 0x4B);
            fscanf(fp, "%s %s", bufc1, v24 + 0x4F);
            fscanf(fp, "%s %d", bufc1, &bufi);
            *(_WORD *)(v24 + 0x9F5) = bufi;
            fscanf(fp, "%s %d", bufc1, &bufi);
            if ( bufi )
            {
              *(_DWORD *)(v24 + 0x9F1) = 0xFFFFFFFF;
            }
            *(_DWORD *)(v24 + 4) = pType3->window;
          }
          else
          {
            // TYPE           2
            // Cosmos Window (Galactic Display)
            vpWnd2COSW = (P_Wnd2COSW)operator new(0x596u);
            if ( vpWnd2COSW )
            {
              Q_Wnd2COSWCtor_sub_224A4(vpWnd2COSW);
            }
            Q_RegisterData_sub_2625C(vpWnd2COSW, 2, "COSW");
            v65 = vpWnd2COSW->a.a1.name;
            vpWnd2COSW__ = vpWnd2COSW;
            Q_WINMGR_CPP_RegisterWindow_sub_2C978(&vpWnd2COSW->a.a1);
            dword_96BAC = *(_DWORD *)(v65 + 0x21);
            // NAME           COSMOSWnd
            fscanf(fp, "%s %s", bufc1, v65);
            // PARENT
            fscanf(fp, "%s", bufc1);
            // NONE
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              v67 = Q_FindWnd_sub_56DA8(pType3, bufc1, 0);
              if ( !v67 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD41);
              }
              vpWnd2COSW__->a.a1.parentIndex = v67->a1.index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(&v67->a1, &vpWnd2COSW__->a.a1);
            }
            // STATE          4 1 3 7 13
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( j = 0; (__int16)j < (__int16)bufi2; ++j )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pType3, vpWnd2COSW__->a.a1.index, bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xD4B);
              }
            }
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.a1.pane.x0);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.a1.pane.y0);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.a1.pane.x1);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.a1.pane.y1);
            // BACKGRNDCOLOR
            fscanf(fp, "%s %d", bufc1, &bufi);
            vpWnd2COSW__->backgroundColor = bufi;
            // STAR_SHAPES
            fscanf(fp, "%s %s", bufc1, v72);
            // SHIP_SHAPES
            fscanf(fp, "%s %s", bufc1, v73);
            Q_COSWND_CPP_sub_22644(vpWnd2COSW__, v72, v73);
            // NUM_STARS
            fscanf(fp, "%s %d", bufc1, &bufi);
            // NUM_LANES
            fscanf(fp, "%s %d", bufc1, &v92);
            // SMALLSEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // MEDIUMSEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // LARGESEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // HUGESEED
            fscanf(fp, "%s %d", bufc1, &bufi);
            // CURSORSHAPE
            fscanf(fp, "%s %d", bufc1, &bufi);
            vpWnd2COSW__->cursorShape = bufi;
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.a1.sendMessage);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.a1.sendParam1);
            fscanf(fp, "%s %d", bufc1, &vpWnd2COSW__->a.a1.sendParam2);
            fscanf(fp, "%s %s", bufc1, vpWnd2COSW__->a.a1.helpIndex);
            window = pType3->window;
            vpWnd2COSW__->a.a1.Unknown_18 = 0xFFFF;
            vpWnd2COSW__->a.a1.Unknown_1A = 0;
            racesNum = V_Game.racesNum;
            vpWnd2COSW__->Unknown_D9 = 0;
            vpWnd2COSW__->a.a1.pane.window = window;
            v32 = 0;
            if ( racesNum > 0 )
            {
              do
              {
                v33 = V_Game.racesNum;
                v34 = (1 << v32++) | vpWnd2COSW__->Unknown_D9;
                vpWnd2COSW__->Unknown_D9 = v34;
              }
              while ( (__int16)v32 < v33 );
            }
          }
        }
        else if ( (unsigned int)bufi <= 3 )
        {
          // TYPE           3
          v35 = (T_TypeA3 *)operator new(0xB3u);
          if ( v35 )
          {
            Q_A3_sub_2D9C4(v35);
          }
          Q_RegisterData_sub_2625C(v35, 2, "CTW");
          v36 = v35;
          v37 = v35->a2.a1.name;
          Q_WINMGR_CPP_RegisterWindow_sub_2DA68(&v35->a2.a1);
          // NAME = RACECONTROLS
          fscanf(fp, "%s %s", bufc1, v37);
          // PARENT
          fscanf(fp, "%s", bufc1);
          fscanf(fp, "%s", bufc1);
          if ( strcmp(bufc1, "NONE") )
          {
            v38 = Q_FindWnd_sub_56DA8(pType3, bufc1, 0);
            if ( !v38 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xD8D);
            }
            v36->a2.a1.parentIndex = v38->a1.index;
            Q_GWINDOW_CPP_LinkChild_sub_2C990(&v38->a1, &v36->a2.a1);
          }
          // STATE
          fscanf(fp, "%s %d", bufc1, &bufi2);
          for ( k = 0; k < (__int16)bufi2; ++k )
          {
            fscanf(fp, "%d", &bufi);
            if ( Q_WinMgr_AddWindowToState_sub_57220(pType3, v36->a2.a1.index, bufi) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xD97);
            }
            if ( !k )
            {
              Unknown_84 = pType3->winStates[bufi].Unknown_84;
              v36->a2.a1.Unknown_1A = 0;
              v36->a2.a1.Unknown_18 = Unknown_84;
            }
          }
          fscanf(fp, "%s %d", bufc1, &v36->a2.a1.pane.x0);
          fscanf(fp, "%s %d", bufc1, &v36->a2.a1.pane.y0);
          fscanf(fp, "%s %d", bufc1, &v36->a2.a1.pane.x1);
          fscanf(fp, "%s %d", bufc1, &v36->a2.a1.pane.y1);
          // SHAPEFRAME
          fscanf(fp, "%s %d", bufc1, &bufi);
          v36->a2.a1.shapeFrame = bufi;
          v36->a2.a1.Unknown_59 = 0;
          fscanf(fp, "%s %d", bufc1, &v36->a2.a1.sendMessage);
          fscanf(fp, "%s %d", bufc1, &v36->a2.a1.sendParam1);
          fscanf(fp, "%s %d", bufc1, &v36->a2.a1.sendParam2);
          fscanf(fp, "%s %s", bufc1, v36->a2.a1.helpIndex);
          v36->a2.a1.pane.window = pType3->window;
          // NUMCONTROLS
          fscanf(fp, "%s %d", bufc1, &numControls);
          if ( sub_2DA80(v36, numControls) == FALSE )
          {
            Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xDB9);
          }
          for ( m = 0; (__int16)m < numControls; ++m )
          {
            // RACE1CONTROL
            fscanf(fp, "%s %d", bufc1, &bufi);
            v80[0] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[1] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[3] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[2] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[4] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[5] = bufi;
            fscanf(fp, "%d", &bufi);
            v80[6] = bufi;
            if ( !sub_2DAC8(v36, 0, 0, v80) )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xDD4);
            }
          }
          for ( n = 0; n < V_Game.racesNum; ++n )
          {
            sub_2DAC8(v36, 1 << n, 1, 0);
          }
        }
        else if ( (unsigned int)bufi < 5 )
        {
          // TYPE           4
          // Battle Mode Window (System Display)
          v41 = (P_Wnd04BM)operator new(0x504Eu);
          if ( v41 )
          {
            Q_Wnd4BMCtor_sub_15ED4(v41);
          }
          Q_RegisterData_sub_2625C(v41, 2, "BM");
          v42 = v41;
          v43 = v41->a.a1.name;
          Q_WINMGR_CPP_RegisterWindow_sub_2C978(&v41->a.a1);
          // NAME           BatModeWnd
          fscanf(fp, "%s %s", bufc1, v43);
          // PARENT
          fscanf(fp, "%s", bufc1);
          fscanf(fp, "%s", bufc1);
          if ( strcmp(bufc1, "NONE") )
          {
            v44 = Q_FindWnd_sub_56DA8(pType3, bufc1, 0);
            if ( !v44 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xDE9);
            }
            v42->a.a1.parentIndex = v44->a1.index;
            Q_GWINDOW_CPP_LinkChild_sub_2C990(&v44->a1, &v42->a.a1);
          }
          fscanf(fp, "%s %d", bufc1, &bufi2);
          for ( ii = 0; (__int16)ii < (__int16)bufi2; ++ii )
          {
            fscanf(fp, "%d", &bufi);
            if ( Q_WinMgr_AddWindowToState_sub_57220(pType3, v42->a.a1.index, bufi) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xDF3);
            }
          }
          fscanf(fp, "%s %d", bufc1, &v42->a.a1.pane.x0);
          fscanf(fp, "%s %d", bufc1, &v42->a.a1.pane.y0);
          fscanf(fp, "%s %d", bufc1, &v42->a.a1.pane.x1);
          fscanf(fp, "%s %d", bufc1, &v42->a.a1.pane.y1);
          // BACKGRNDCOLOR
          fscanf(fp, "%s %d", bufc1, &bufi);
          v42->backgroundColor = bufi;
          // CURSORSHAPE
          fscanf(fp, "%s %d", bufc1, &bufi);
          v42->cursorShape = bufi;
          sub_18370(v42);
          fscanf(fp, "%s %d", bufc1, &v42->a.a1.sendMessage);
          fscanf(fp, "%s %d", bufc1, &v42->a.a1.sendParam1);
          fscanf(fp, "%s %d", bufc1, &v42->a.a1.sendParam2);
          fscanf(fp, "%s %s", bufc1, v42->a.a1.helpIndex);
          v46 = pType3->window;
          v42->a.a1.Unknown_18 = 0xFFFF;
          v42->a.a1.Unknown_1A = 0;
          v42->a.a1.pane.window = v46;
        }
        else
        {
          if ( (unsigned int)bufi <= 7 )
          {
            goto LABEL_16;
          }
          // TYPE           8
          // Ship Design Screen
          v60 = (P_Wnd08SW)operator new(0x237u);
          if ( v60 )
          {
            v60 = Q_Wnd8SWCtor_sub_4D92C(v60);
          }
          Q_RegisterData_sub_2625C(v60, 2, "SW");
          v61 = v60;
          v62 = v60->a.a1.name;
          Q_WINMGR_CPP_RegisterWindow_sub_2C978(&v60->a.a1);
          fscanf(fp, "%s %s", bufc1, v62);
          fscanf(fp, "%s", bufc1);
          fscanf(fp, "%s", bufc1);
          if ( strcmp(bufc1, "NONE") )
          {
            v63 = Q_FindWnd_sub_56DA8(pType3, bufc1, 0);
            if ( !v63 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xE21);
            }
            v61->a.a1.parentIndex = v63->a1.index;
            Q_GWINDOW_CPP_LinkChild_sub_2C990(&v63->a1, &v61->a.a1);
          }
          fscanf(fp, "%s %d", bufc1, &bufi2);
          for ( jj = 0; jj < (__int16)bufi2; ++jj )
          {
            fscanf(fp, "%d", &bufi);
            if ( Q_WinMgr_AddWindowToState_sub_57220(pType3, v61->a.a1.index, bufi) == FALSE )
            {
              Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xE2B);
            }
            if ( !jj )
            {
              v48 = pType3->winStates[bufi].Unknown_84;
              v61->a.a1.Unknown_1A = 0;
              v61->a.a1.Unknown_18 = v48;
            }
          }
          fscanf(fp, "%s %d", bufc1, &bufi);
          if ( bufi )
          {
            v61->a.a1._mouseFocus = 0xFFFFFFFF;
          }
          fscanf(fp, "%s %d", bufc1, &v61->a.a1.pane.x0);
          fscanf(fp, "%s %d", bufc1, &v61->a.a1.pane.y0);
          fscanf(fp, "%s %d", bufc1, &v61->a.a1.pane.x1);
          fscanf(fp, "%s %d", bufc1, &v61->a.a1.pane.y1);
          fscanf(fp, "%s %d", bufc1, &bufi);
          v61->a.a1.Unknown_59 = bufi;
          fscanf(fp, "%s %d", bufc1, &v61->a.a1.sendMessage);
          fscanf(fp, "%s %d", bufc1, &v61->a.a1.sendParam1);
          fscanf(fp, "%s %d", bufc1, &v61->a.a1.sendParam2);
          fscanf(fp, "%s %s", bufc1, v61->a.a1.helpIndex);
          v61->a.a1.pane.window = pType3->window;
        }
      }
      else
      {
        if ( (unsigned int)bufi <= 9 )
        {
          goto LABEL_16;
        }
        if ( (unsigned int)bufi < 14 )
        {
          if ( (unsigned int)bufi < 11 )
          {
            // TYPE           10
            // List
            vpWnd10LB = (P_Wnd10LB)operator new(0x902u);
            if ( vpWnd10LB )
            {
              Q_Wnd10LBCtor_sub_2E248(vpWnd10LB);
            }
            Q_RegisterData_sub_2625C(vpWnd10LB, 2, "LB");
            v50 = vpWnd10LB;
            v51 = vpWnd10LB->a.a1.name;
            Q_WINMGR_CPP_RegisterWindow_sub_2E3BC(&vpWnd10LB->a.a1);
            fscanf(fp, "%s %s", bufc1, v51);
            fscanf(fp, "%s", bufc1);
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              v52 = Q_FindWnd_sub_56DA8(pType3, bufc1, 0);
              if ( !v52 )
              {
                Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xE5E);
              }
              v50->a.a1.parentIndex = v52->a1.index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(&v52->a1, &v50->a.a1);
            }
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( kk = 0; (__int16)kk < (__int16)bufi2; ++kk )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pType3, v50->a.a1.index, bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xE68);
              }
            }
            fscanf(fp, "%s %d", bufc1, &bufi);
            if ( bufi )
            {
              v50->a.a1._mouseFocus = 0xFFFFFFFF;
            }
            fscanf(fp, "%s %d", bufc1, &v50->a.a1.pane.x0);
            fscanf(fp, "%s %d", bufc1, &v50->a.a1.pane.y0);
            fscanf(fp, "%s %d", bufc1, &v50->a.a1.pane.x1);
            fscanf(fp, "%s %d", bufc1, &v50->a.a1.pane.y1);
            fscanf(fp, "%s %d", bufc1, &bufi);
            v50->a.a1.shapeFrame = bufi;
            fscanf(fp, "%s %d", bufc1, &bufi);
            v50->a.a1.Unknown_59 = bufi;
            fscanf(fp, "%s %d", bufc1, &v50->a.a1.sendMessage);
            fscanf(fp, "%s %d", bufc1, &v50->a.a1.sendParam1);
            fscanf(fp, "%s %d", bufc1, &v50->a.a1.sendParam2);
            fscanf(fp, "%s %s", bufc1, v50->a.a1.helpIndex);
            v50->a.a1.pane.window = pType3->window;
          }
          else
          {
            if ( (unsigned int)bufi <= 12 )
            {
              goto LABEL_16;
            }
            // TYPE           13
            // Debug Window
            v57 = (P_Wnd13DBGWND)operator new(0xC0u);
            if ( v57 )
            {
              Q_Wnd13DBGWNDCtor_sub_5A594(v57);
            }
            Q_RegisterData_sub_2625C(v57, 2, "DBGWND");
            v58 = v57;
            if ( !v57 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xE8E);
            }
            Q_WINMGR_CPP_RegisterWindow_sub_5A5F4(&v57->a2.a1);
            pType3->pWnd13DBGWND = v58;
            // NAME           WMGRDEBUG
            fscanf(fp, "%s %s", bufc1, v58->a2.a1.name);
            fscanf(fp, "%s %d", bufc1, &v58->a2.a1.pane.x0);
            fscanf(fp, "%s %d", bufc1, &v58->a2.a1.pane.y0);
            fscanf(fp, "%s %d", bufc1, &v58->a2.a1.pane.x1);
            fscanf(fp, "%s %d", bufc1, &v58->a2.a1.pane.y1);
            fscanf(fp, "%s %d", bufc1, &v58->cX0);
            fscanf(fp, "%s %d", bufc1, &v58->cY0);
            fscanf(fp, "%s %d", bufc1, &v58->cX1);
            fscanf(fp, "%s %d", bufc1, &v58->cY1);
            fscanf(fp, "%s %s", bufc1, v78);
            v58->a2.a1.Unknown_18 = Q_Cache_AddFile_sub_1ADAC(p_cache, v78);
            v59 = pType3->window;
            v58->a2.a1.pane.window = v59;
            v58->window = v59;
          }
        }
        else
        {
          if ( (unsigned int)bufi <= 27 )
          {
            goto LABEL_16;
          }
          if ( (unsigned int)bufi < 100 )
          {
            if ( (unsigned int)bufi < 29 || (unsigned int)bufi > 32 )
            {
LABEL_262:
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xEF2);
            }
LABEL_16:
            if ( bufi )
            {
              switch ( bufi )
              {
                case 5:
                  // Races Window
                  v6 = "RW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    sub_25BF8((P_WndA2)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 6:
                  // Race Selection Window
                  v6 = "RSW";
                  pTypeA1 = (T_Wnd *)operator new(0xB1u);
                  if ( pTypeA1 )
                  {
                    Q_WndRSWCtor_sub_25CB8((P_WndRSW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 7:
                  // Planet Window
                  v6 = "PW";
                  pTypeA1 = (T_Wnd *)operator new(0x18Cu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd7PW_Ctor_sub_372B0((P_Wnd07PW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 11:
                  // Load Window
                  v6 = "LW";
                  pTypeA1 = (T_Wnd *)operator new(0xFE0u);
                  if ( pTypeA1 )
                  {
                    Q_WndLW_sub_31200((P_WndLW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 12:
                  // Intelligence Window
                  v6 = "IW";
                  pTypeA1 = (T_Wnd *)operator new(0xAFu);
                  if ( pTypeA1 )
                  {
                    Q_WndIW_sub_33598((P_WndIW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 9:
                  // Research Window
                  pTypeA1 = (T_Wnd *)operator new(0x9DDu);
                  v83 = 2;
                  if ( pTypeA1 )
                  {
                    Q_A2Ctor_sub_2C830((P_WndA2)pTypeA1);
                    p_pane = (T_Matrices *)&pTypeA1[1].pane;
                    sub_1B4F0(p_pane);
                    v10 = &p_pane[1];
                    _wcpp_2_ctor_array_(v10, 0x64u, &C_Vector3D);
                    v11 = (T_Wnd *)((char *)&v10[0xFFFFFFFD].matrix_74._[1][1] + 1);
                    LODWORD(v10[0xFFFFFFFE].matrix_74._[2][2]) = &Wnd9RW_Procs;
                    sub_46CAC((P_Wnd9RW)((char *)&v10[0xFFFFFFFD].matrix_74._[1][1] + 1));
                    pTypeA1 = v11;
                  }
                  v8 = v83;
                  v6 = "RW";
                  break;
                case 14:
                  // Planet Square Window
                  v6 = "PSW";
                  pTypeA1 = (T_Wnd *)operator new(0xADu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd14PSW_Ctor_sub_39D80((P_Wnd14PSW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 15:
                  // Number of turns
                  v6 = "NT";
                  pTypeA1 = (T_Wnd *)operator new(0xAFu);
                  if ( pTypeA1 )
                  {
                    Q_WndNT_sub_2F2F4((P_WndNT)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 16:
                  // Status Window (Planet Status Screen)
                  v6 = "SW";
                  pTypeA1 = (T_Wnd *)operator new(0xB1u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd16SW_Ctor_sub_51674((P_Wnd16SW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 17:
                  // Fleet Window (Ship Status Screen)
                  v6 = "FW";
                  pTypeA1 = (T_Wnd *)operator new(0xB1u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd17FW_Ctor_sub_51B64((P_Wnd17FW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 18:
                  // New Game Display
                  v6 = "NG";
                  pTypeA1 = (T_Wnd *)operator new(0xBDu);
                  if ( pTypeA1 )
                  {
                    Q_WndNGCtor_sub_520EC((P_WndNG)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 19:
                  // Battle Control Window
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0x108u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd19BC_Ctor_sub_10A3C((P_Wnd19BC)pTypeA1);
                  }
                  v6 = "BC";
                  break;
                case 20:
                  // Help Window
                  v6 = "HW";
                  pTypeA1 = (T_Wnd *)operator new(0xDAFu);
                  if ( pTypeA1 )
                  {
                    Q_A2_sub_2FC50((P_WndA2)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 21:
                  // Negotiation Window
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0xC3u);
                  if ( pTypeA1 )
                  {
                    Q_WndNW_sub_3201C((P_WndNW)pTypeA1);
                  }
                  v6 = "NW";
                  break;
                case 22:
                  // Ability Window
                  v6 = "AW";
                  pTypeA1 = (T_Wnd *)operator new(0xDAFu);
                  if ( pTypeA1 )
                  {
                    Q_WndAW_sub_33830((P_WndAW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 23:
                  // Event Window
                  v6 = "EW";
                  pTypeA1 = (T_Wnd *)operator new(0xDB3u);
                  if ( pTypeA1 )
                  {
                    Q_Wnd23EWCtor_sub_267A0((P_Wnd23EW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 24:
                  // End Game Window
                  v6 = "EW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_A2_sub_27BF8((P_WndA2)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 25:
                  // Toggle Window
                  v6 = "TW";
                  pTypeA1 = (T_Wnd *)operator new(0xAFu);
                  if ( pTypeA1 )
                  {
                    Q_Wnd25TW_Ctor_sub_2D464((P_Wnd25TW)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 26:
                  // Alien Diplomacy (Communication Display)
                  v6 = "MW";
                  pTypeA1 = (T_Wnd *)operator new(0xB3u);
                  if ( pTypeA1 )
                  {
                    Q_A3_sub_2FA18((P_TypeA3)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 29:
                  // Planet Research, Prosperity, Production, Industry, Population, Project
                  v6 = "GSW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_A2_sub_395EC((P_WndA2)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 30:
                  // Start Game
                  v6 = "EW";
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_A2_sub_2712C((T_WndA2 *)pTypeA1);
                  }
                  v8 = 2;
                  break;
                case 31:
                  // Abandon Button
                  v6 = "pcw";
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_A2Ctor_sub_2C830((P_WndA2)pTypeA1);
                    pTypeA1[1].magic12345678 = (int)&off_961DC;
                  }
                  break;
                case 32:
                  // My Items (Player Items in this system)
                  v6 = "miw";
                  v8 = 2;
                  pTypeA1 = (T_Wnd *)operator new(0xABu);
                  if ( pTypeA1 )
                  {
                    Q_A2Ctor_sub_2C830((P_WndA2)pTypeA1);
                    pTypeA1[1].magic12345678 = (int)&off_961C4;
                  }
                  break;
                default:
                  goto LABEL_111;
              }
            }
            else
            {
              // TYPE           0
              v6 = "GW";
              pTypeA1 = (T_Wnd *)operator new(0xABu);
              if ( pTypeA1 )
              {
                Q_A2Ctor_sub_2C830((P_WndA2)pTypeA1);
              }
              v8 = 2;
            }
            Q_RegisterData_sub_2625C(pTypeA1, v8, v6);
            a1a = pTypeA1;
LABEL_111:
            pName = a1a->name;
            Q_WINMGR_CPP_RegisterWindow_sub_2C978(a1a);
            // NAME
            fscanf(fp, "%s %s", bufc1, pName);
            // PARENT
            fscanf(fp, "%s", bufc1);
            fscanf(fp, "%s", bufc1);
            if ( strcmp(bufc1, "NONE") )
            {
              v13 = Q_FindWnd_sub_56DA8(pType3, bufc1, 0);
              if ( !v13 )
              {
                sub_2620C("%s bad parent", pName);
                Q_PrintFailAndExit_sub_261B8(0, "..\\winmgr.cpp", 0xC8D);
              }
              v14 = a1a;
              a1a->parentIndex = v13->a1.index;
              Q_GWINDOW_CPP_LinkChild_sub_2C990(&v13->a1, v14);
            }
            // STATE
            fscanf(fp, "%s %d", bufc1, &bufi2);
            for ( mm = 0; mm < (__int16)bufi2; ++mm )
            {
              fscanf(fp, "%d", &bufi);
              if ( Q_WinMgr_AddWindowToState_sub_57220(pType3, a1a->index, bufi) == FALSE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xC97);
              }
              if ( !mm )
              {
                v16 = a1a;
                v17 = pType3->winStates[bufi].Unknown_84;
                a1a->Unknown_1A = 0;
                v16->Unknown_18 = v17;
              }
            }
            // MOUSEFOCUS
            fscanf(fp, "%s %d", bufc1, &bufi);
            if ( bufi )
            {
              a1a->_mouseFocus = TRUE;
            }
            if ( wndType == 25 )
            {
              // BUTTONSTATE
              fscanf(fp, "%s %d", bufc1, &bufi);
              if ( bufi )
              {
                a1a[1].pane.window = (WINDOW *)0xFFFFFFFF;
              }
            }
            fscanf(fp, "%s %d", bufc1, &a1a->pane.x0);
            fscanf(fp, "%s %d", bufc1, &a1a->pane.y0);
            fscanf(fp, "%s %d", bufc1, &a1a->pane.x1);
            fscanf(fp, "%s %d", bufc1, &a1a->pane.y1);
            fscanf(fp, "%s %d", bufc1, &bufi);
            v18 = a1a;
            a1a->shapeFrame = bufi;
            if ( wndType == 0xF )
            {
              fscanf(fp, "%s %d", bufc1, &bufi);
              v18[1].pane.window = (WINDOW *)bufi;
            }
            fscanf(fp, "%s %d", bufc1, &bufi);
            v19 = a1a;
            a1a->Unknown_59 = bufi;
            fscanf(fp, "%s %d", bufc1, &v19->sendMessage);
            fscanf(fp, "%s %d", bufc1, &v19->sendParam1);
            fscanf(fp, "%s %d", bufc1, &v19->sendParam2);
            fscanf(fp, "%s %s", bufc1, v19->helpIndex);
            // WINITEMS
            fscanf(fp, "%s %d", bufc1, &bufi);
            t19 = (int)v19->_t19;
            v95 = 0;
            winItems = bufi;
            if ( (__int16)bufi > 0 )
            {
              p_hotX = &v19->_t19[0].hotX;
              p_hotY = &v19->_t19[0].hotY;
              p_shapeNumber = (WORD *)&v19->_t19[0]._shapeNumber;
              do
              {
                fscanf(fp, "%s %d", bufc1, &bufi);
                if ( bufi )
                {
                  if ( bufi == 1 )
                  {
                    // SHAPEITEM      1
                    v71 = p_hotY;
                    v69 = p_shapeNumber;
                    *(_BYTE *)t19 = 1;
                    fscanf(fp, "%s %d %d %d", bufc1, v69, p_hotX, v71);
                    *(_DWORD *)(t19 + 1) = (unsigned __int16)Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, bufc1, 0xFFFFFFFF);
                  }
                  else
                  {
                    Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xCE1);
                  }
                }
                else
                {
                  // TEXTITEM       0
                  v70 = p_hotY;
                  v68 = p_shapeNumber;
                  *(_BYTE *)t19 = 0;
                  fscanf(fp, "%s %d %d %d", bufc1, v68, p_hotX, v70);
                  *(_DWORD *)(t19 + 1) = sub_2D334(bufc1);
                }
                v22 = p_hotY;
                sub_2D400((int)a1a, t19);
                p_hotX = (WORD *)((char *)p_hotX + 0xD);
                t19 += 0xD;
                p_hotY = (WORD *)((char *)v22 + 0xD);
                ++v95;
                p_shapeNumber = (WORD *)((char *)p_shapeNumber + 0xD);
              }
              while ( (__int16)v95 < (__int16)winItems );
            }
            a1a->pane.window = pType3->window;
          }
          else if ( (unsigned int)bufi <= 100 )
          {
            // TYPE           100
            // STATENUMBER    0
            // SHAPEFILE      DATA\0OPENING.SHP
            fscanf(fp, "%s %d", bufc1, &bufi);
            fscanf(fp, "%s %s", bufc1, bufc4);
            v54 = Q_Cache_AddFile_sub_1ADAC(v85, bufc4);
            if ( !sub_5748C(pType3, bufi, v54) )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0xECA);
            }
          }
          else
          {
            if ( (unsigned int)bufi < 200 )
            {
              goto LABEL_262;
            }
            if ( (unsigned int)bufi <= 200 )
            {
              // HAZEVIBLES     200
              // NUMTABLES      23
              fscanf(fp, "%s %d", bufc1, &bufi);
              l = 0;
              Q_AllocateHazeTables_sub_2C08C(&V_Type6_stru_D8654, bufi);
              while ( l < bufi )
              {
                v56 = l;
                fscanf(fp, "%s %s", bufc1, bufc2);
                ++l;
                Q_LoadHazeTables_sub_2C0C0(&V_Type6_stru_D8654, bufc2, v56);
              }
            }
            else
            {
              if ( bufi != 300 )
              {
                goto LABEL_262;
              }
              // FONTS          300
              // SMALLFONT      DATA\SMFONT.FNT
              fscanf(fp, "%s %s", bufc1, bufc3);
              if ( sub_2B360((void **)&p_SmallFont->pVfxFont, bufc3) != TRUE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xEE6);
              }
              pType3->SmallFont._bgcolor = 0;
              // LARGEFONT      DATA\BIGFONT.FNT
              fscanf(fp, "%s %s", bufc1, bufc3);
              if ( sub_2B360((void **)&p_LargeFont->pVfxFont, bufc3) != TRUE )
              {
                Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0xEEB);
              }
              pType3->LargeFont._bgcolor = 0;
            }
          }
        }
      }
    }
  }
}
// 961C4: using guessed type int (__fastcall *off_961C4)(P_WndA2 a1);
// 961DC: using guessed type int (__fastcall *off_961DC)(P_WndA2 a1);
// 96BAC: using guessed type int dword_96BAC;
// 57670: using guessed type char anonymous_3[108];
// 57670: using guessed type char anonymous_4[108];
// 57670: using guessed type char bufc2[108];
// 57670: using guessed type char bufc4[108];
// 57670: using guessed type char anonymous_7[108];
// 57670: using guessed type char anonymous_8[32];

//----- (00059828) --------------------------------------------------------
void __fastcall Q_LoadAscendCfg_sub_59828(P_WinMgr a1)
{
  T_CFile v2; // [esp-124h] [ebp-128h] BYREF

  Q_CFile_Ctor_sub_1BB78(&v2);
  if ( !Q_CFile_OpenFile_sub_1BBFC(&v2, "ascend.cfg", O_BINARY, 0) )
  {
    Q_ReadFile_sub_1BF94(&v2, &V_SoundSystem._notstarted1, 4u);
    Q_ReadFile_sub_1BF94(&v2, &V_SoundSystem.c, 4u);
    Q_ReadFile_sub_1BF94(&v2, &a1->j, 4u);
  }
  Q_CFile_Dtor_sub_1BBC8(&v2);
}

//----- (0005989C) --------------------------------------------------------
T_CFile *__fastcall Q_SaveAscendCfg_sub_5989C(P_WinMgr a1)
{
  T_CFile *result; // eax
  T_CFile v3; // [esp-120h] [ebp-124h] BYREF

  Q_CFile_Ctor_sub_1BB78(&v3);
  if ( !Q_OpenFile_sub_1BCA8(&v3, "ascend.cfg") )
  {
    Q_CFile_DosWrite_sub_1C098(&v3, &V_SoundSystem._notstarted1, 4u);
    Q_CFile_DosWrite_sub_1C098(&v3, &V_SoundSystem.c, 4u);
    Q_CFile_DosWrite_sub_1C098(&v3, &a1->j, 4u);
  }
  result = &v3;
  Q_CFile_Dtor_sub_1BBC8(&v3);
  return result;
}
// 598F2: returning address of temporary local variable '%0x0'

//----- (00059908) --------------------------------------------------------
int __fastcall sub_59908(int result)
{
  if ( !*(_DWORD *)(result + 0x48A6) && !*(_DWORD *)(result + 0x48AA) )
  {
    *(_DWORD *)(result + 0x48A6) = 0xFFFFFFFF;
    *(_DWORD *)(result + 0x48BA) = 0;
    *(_DWORD *)(result + 0x48B6) = 0;
  }
  return result;
}

//----- (00059934) --------------------------------------------------------
void __fastcall sub_59934(P_WinMgr a1, int toTxt)
{
  if ( a1->aaa == 0xFFFFFFFF || a1->bbb == 0xFFFFFFFF )
  {
    if ( a1->aaa == 0xFFFFFFFF )
    {
      a1->aaa = 0;
      Q_WINMGR_CPP_WriteWinEventBin_sub_59DE0(a1);
      if ( toTxt )
      {
        Q_WINMGR_CPP_WinEventBinToTxt_sub_59E88(a1, "WINEVENT.BIN", "WINEVENT.TXT");
      }
    }
    a1->bbb = 0;
  }
}

//----- (00059988) --------------------------------------------------------
unsigned int __fastcall sub_59988(P_WinMgr a1, char *a2, int a3)
{
  int aaa; // ecx
  unsigned int result; // eax

  strcpy(byte_132B20, a2);
  strcpy(&byte_132B20[strlen(byte_132B20) - 4], ".txt");
  dword_132B14 = V_Mouse.left;
  aaa = a1->aaa;
  dword_132B18 = V_Mouse.right;
  if ( aaa == 0xFFFFFFFF || a1->bbb == 0xFFFFFFFF )
  {
    return 0;
  }
  result = sub_59CFC(a1, a2);
  if ( result )
  {
    a1->bbb = 0xFFFFFFFF;
    a1->_time = 0;
    result = 0xFFFFFFFF;
    a1->Unknown_48BE = 0;
    a1->Unknown_48AE = a3;
    dword_132B1C = 0;
  }
  return result;
}
// 132B14: using guessed type int dword_132B14;
// 132B18: using guessed type int dword_132B18;
// 132B1C: using guessed type int dword_132B1C;

//----- (00059A54) --------------------------------------------------------
P_WinMgr __fastcall sub_59A54(P_WinMgr a1)
{
  P_WinMgr v1; // ecx
  unsigned int v2; // edi
  LONG y; // ebp
  LONG v4; // eax
  int v5; // eax
  T_Wnd20HW *Wnd_sub_56DA8; // esi
  unsigned int v7; // eax
  LONG x; // [esp+0h] [ebp-1Ch]

  v1 = a1;
  if ( a1->bbb )
  {
    x = V_Mouse.x;
    V_Mouse.left = dword_132B14;
    v2 = 0xFFFFFFFF;
    V_Mouse.right = dword_132B18;
    y = V_Mouse.y;
    Q_ProcessInput_sub_2656C();
    if ( V_Keyboard.Pressed == 0xFFFFFFFF
      || V_Mouse.leftClicked == 0xFFFFFFFF && V_Mouse.left
      || V_Mouse.rightClicked == 0xFFFFFFFF && V_Mouse.right )
    {
      v4 = V_Mouse.x;
      v1->bbb = 0;
      y = V_Mouse.y;
      x = v4;
      v5 = 0;
      if ( !v1->Unknown_489E )
      {
        Wnd_sub_56DA8 = (T_Wnd20HW *)Q_FindWnd_sub_56DA8(v1, "HELPWINDOW", 0);
        Q_ShowHelpTopic_sub_2FCB0(Wnd_sub_56DA8, "help.txt", "endtut");
        v5 = sub_552F8(v1, &Wnd_sub_56DA8->a2, 0);
      }
      if ( v5 )
      {
        v7 = time(0);
        srand(v7);
        v2 = 0;
        LODWORD(v1->j) = dword_96BBC;
      }
      else
      {
        v1->bbb = 0xFFFFFFFF;
      }
    }
    if ( v2 )
    {
      V_Mouse.y = y;
      V_Mouse.moved = 0;
      V_Mouse.x = x;
    }
    dword_132B14 = V_Mouse.left;
    a1 = (P_WinMgr)V_Mouse.right;
    dword_132B18 = V_Mouse.right;
  }
  return a1;
}
// 96BBC: using guessed type int dword_96BBC;
// 132B14: using guessed type int dword_132B14;
// 132B18: using guessed type int dword_132B18;

//----- (00059B80) --------------------------------------------------------
void __fastcall sub_59B80(T_WinMgr *a1)
{
  T_WinEvent *winEvents; // esi
  int Unknown_48BE; // eax
  int v4; // eax
  unsigned __int16 v5; // dx
  int v6; // edx
  int winEventsNum; // ebx

  winEvents = a1->winEvents;
  V_Mouse.leftClicked = 0;
  V_Mouse.rightClicked = 0;
  V_Mouse.moved = 0;
  V_Keyboard.Pressed = 0;
  while ( 1 )
  {
    Unknown_48BE = a1->Unknown_48BE;
    if ( a1->_time < (unsigned int)a1->winEvents[Unknown_48BE].time )
    {
      break;
    }
    v4 = (int)&winEvents[Unknown_48BE];
    v5 = *(_WORD *)(v4 + 8);
    if ( !v5 )
    {
      goto LABEL_5;
    }
    if ( v5 <= 3u )
    {
      sub_265A8(v4);
    }
    else if ( v5 > 7u )
    {
LABEL_5:
      sprintf(
        "Thank you for playing Ascendancy.",
        "\nBad Trace Event: %d of %d\n\nEVENT[%d] HWND[%0d] MSG[%d] P1[%d] P2[%d]\n",
        a1->Unknown_48BE,
        a1->winEventsNum,
        *(__int16 *)(v4 + 8),
        *(_DWORD *)(v4 + 4),
        *(__int16 *)(v4 + 0xA),
        *(_DWORD *)(v4 + 0xC),
        *(_DWORD *)(v4 + 0x10));
      Q_debugbreak_exit_sub_2624C();
    }
    v6 = a1->Unknown_48BE + 1;
    winEventsNum = a1->winEventsNum;
    a1->Unknown_48BE = v6;
    if ( v6 >= winEventsNum )
    {
      if ( a1->Unknown_48AE != 0xFFFFFFFF )
      {
        sub_59934(a1, 0);
        return;
      }
      a1->Unknown_48BE = 0;
      a1->_time = 0;
    }
  }
}

//----- (00059C80) --------------------------------------------------------
void __fastcall sub_59C80(P_WinMgr a1, int hwnd, WORD eventType, WORD msg, int p1, int p2, int f)
{
  T_WinEvent *v8; // edx
  int v9; // edi

  if ( a1->aaa == 0xFFFFFFFF && !a1->bbb )
  {
    v8 = &a1->winEvents[a1->winEventsNum];
    v8->time = a1->_time;
    v8->hwnd = hwnd;
    v8->eventType = eventType;
    v8->msg = msg;
    v8->p1 = p1;
    v8->p2 = p2;
    v8->f = f;
    v9 = a1->winEventsNum + 1;
    a1->winEventsNum = v9;
    if ( v9 == 5000 )
    {
      sub_59934(a1, FALSE);
    }
  }
}

//----- (00059CFC) --------------------------------------------------------
unsigned int __fastcall sub_59CFC(P_WinMgr a1, const char *a2)
{
  unsigned int v3; // ebx
  unsigned int v4; // eax
  T_CFile v6; // [esp+0h] [ebp-124h] BYREF

  Q_CFile_Ctor_sub_1BB78(&v6);
  if ( a1->aaa == 0xFFFFFFFF )
  {
    Q_CFile_Dtor_sub_1BBC8(&v6);
    return 0;
  }
  else
  {
    if ( Q_CFile_OpenFile_sub_1BBFC(&v6, a2, 0x200, 0) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x104F);
    }
    if ( (unsigned int)Q_GetFileLength_sub_1BE28(&v6) > 0x1D4D0 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1052);
    }
    Q_ReadFile_sub_1BF94(&v6, a1->Unknown_21D82, 16u);
    v4 = Q_ReadFile_sub_1BF94(&v6, a1->winEvents, 120000u);
    a1->winEventsNum = v4 / 0x18;
    if ( v4 % 0x18 )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x1059);
    }
    v3 = 0xFFFFFFFF;
    a1->Unknown_48BE = 0;
    Q_CFile_Dtor_sub_1BBC8(&v6);
  }
  return v3;
}

//----- (00059DE0) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_WriteWinEventBin_sub_59DE0(P_WinMgr a1)
{
  T_CFile fi; // [esp-124h] [ebp-128h] BYREF

  Q_CFile_Ctor_sub_1BB78(&fi);
  if ( a1->aaa != 0xFFFFFFFF )
  {
    if ( Q_CFile_OpenFile_sub_1BBFC(&fi, "WINEVENT.BIN", 0x21, 0) )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x106C);
    }
    Q_CFile_DosWrite_sub_1C098(&fi, a1->Unknown_21D82, 0x10u);
    Q_CFile_DosWrite_sub_1C098(&fi, a1->winEvents, 0x18 * a1->winEventsNum);
  }
  Q_CFile_Dtor_sub_1BBC8(&fi);
}

//----- (00059E88) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_WinEventBinToTxt_sub_59E88(P_WinMgr a1, char *binname, char *txtname)
{
  FILE *fp; // ecx
  __int16 i; // bx
  const char *v6; // eax
  const char *v7; // eax
  const char *v8; // eax
  const char *v9; // eax
  T_WinEvent *vEvt; // edx
  const char *v11; // [esp-4h] [ebp-8h]

  if ( !a1->aaa && !a1->bbb )
  {
    fp = fopen(txtname, "w");
    if ( !fp )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x107D);
    }
    if ( sub_59CFC(a1, binname) != 0xFFFFFFFF )
    {
      Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x1080);
    }
    for ( i = 0; i < a1->winEventsNum; ++i )
    {
      vEvt = &a1->winEvents[i];
      switch ( vEvt->eventType )
      {
        case 1:
          fprintf(fp, " TIME[%05lu]  EVT_MOUSE_POS    : ", vEvt->time);
          fprintf(fp, " Moved to (%03d,%03d)\n", vEvt->p1, vEvt->p2);
          break;
        case 2:
          fprintf(fp, " TIME[%05lu]  EVT_MOUSE_BUTTON :  ", vEvt->time);
          if ( vEvt->p2 )
          {
            v6 = "DOWN";
          }
          else
          {
            v6 = "UP";
          }
          v11 = v6;
          if ( vEvt->p1 )
          {
            v7 = "Right";
          }
          else
          {
            v7 = "Left";
          }
          fprintf(fp, "%s Button %s\n", v7, v11);
          break;
        case 3:
          fprintf(fp, " TIME[%05lu]  EVT_KEYBOARD     : ", vEvt->time);
          fprintf(fp, " '%c'  (%04d)\n", SLOBYTE(vEvt->p2), vEvt->p1);
          break;
        case 4:
        case 5:
          if ( vEvt->eventType == 4 )
          {
            v8 = "EVT_REQ_CONT";
          }
          else
          {
            v8 = "EVT_CAN_CONT";
          }
          fprintf(fp, " TIME[%05lu]  %-15s: ", vEvt->time, v8);
          fprintf(fp, " HWND[%04d] MSG[%04d] P1[%04d] P2[%04d]\n", vEvt->hwnd, vEvt->msg, vEvt->p1, vEvt->p2);
          break;
        case 6:
        case 7:
          if ( vEvt->eventType == 6 )
          {
            v9 = "EVT_REQ_CHANGE";
          }
          else
          {
            v9 = "EVT_CAN_CHANGE";
          }
          fprintf(fp, " TIME[%05lu]  %-15s: ", vEvt->time, v9);
          fprintf(fp, " HWND[%04d] MSG[%04d] P1[%04d] P2[%04d] F[%04d]\n", vEvt->hwnd, vEvt->msg, vEvt->p1, vEvt->p2, vEvt->f);
          break;
        default:
          fprintf(fp, " *** Unrecognized event type : %d\n", vEvt->eventType);
          break;
      }
    }
    fclose(fp);
  }
}

//----- (0005A094) --------------------------------------------------------
void __fastcall Q_WinMgr_AddWinData_sub_5A094(P_WinMgr pWinMgr, void *pData, int category, char *name)
{
  __int16 i; // kr00_2
  char *v6; // edi

  if ( pWinMgr->winDatasNum == 384 )
  {
    Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x10CB);
  }
  for ( i = 0; ; ++i )
  {
    if ( i >= 384 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x10DD);
    }
    if ( !pWinMgr->winDatas[i].pData )
    {
      break;
    }
  }
  pWinMgr->winDatas[i].pData = pData;
  pWinMgr->winDatas[i].category = category;
  v6 = pWinMgr->winDatas[i].name;
  strncpy(v6, name, 19u);
  pWinMgr->winDatas[i].name[19] = 0;
  strupr(v6);
  pWinMgr->winDatas[i].time = V_Timer_dword_132B58;
  ++pWinMgr->winDatasNum;
}
// 132B58: using guessed type int V_Timer_dword_132B58;

//----- (0005A144) --------------------------------------------------------
void __fastcall Q_WinMgr_RemoveWinData_sub_5A144(P_WinMgr pWinMgr, void *pData)
{
  __int16 i; // kr00_2

  if ( pData )
  {
    for ( i = 0; i < 384; ++i )
    {
      if ( pData == pWinMgr->winDatas[i].pData )
      {
        pWinMgr->winDatas[i].pData = 0;
        --pWinMgr->winDatasNum;
        return;
      }
    }
    Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x10F1);
  }
}

//----- (0005A194) --------------------------------------------------------
char *__fastcall sub_5A194(int a1, int a2, _DWORD *a3, _DWORD *a4)
{
  __int16 v6; // dx
  __int16 v7; // ax

  v6 = *(_WORD *)(a1 + 0x24D96);
  v7 = 0;
  if ( v6 <= 0 )
  {
    return 0;
  }
  while ( a2 != *(_DWORD *)((char *)&loc_21DB2 + 0x20 * v7 + a1) )
  {
    if ( ++v7 >= *(__int16 *)(a1 + 0x24D96) )
    {
      return 0;
    }
  }
  if ( a3 )
  {
    *a3 = *(_DWORD *)((char *)&loc_21D96 + 0x20 * v7 + a1);
  }
  if ( a4 )
  {
    *a4 = *(_DWORD *)(0x20 * v7 + a1 + 0x21D9A);
  }
  return (char *)&loc_21D96 + 0x20 * v7 + a1 + 8;
}

//----- (0005A270) --------------------------------------------------------
void __fastcall sub_5A270(T_WinMgr *a1, int a2, int a3, int a4)
{
  if ( !a1->h || a4 == 0xFFFFFFFF )
  {
    Q_GSYSTEM_CPP_sub_2C7D0(&V_Type6_stru_D8654, a2, a3);
  }
}

//----- (0005A294) --------------------------------------------------------
void __fastcall Q_WinMgr_CallProc6_sub_5A294(P_WinMgr a1, P_CFile pfi, int read)
{
  int i; // kr04_4

  for ( i = 0; i != 0x400; ++i )
  {
    if ( a1->wnds[i].activeCount )
    {
      a1->wnds[i].pWndA2->pProcs->proc6(a1->wnds[i].pWndA2, pfi, read);
    }
  }
}

//----- (0005A320) --------------------------------------------------------
void __fastcall Q_Proc_sub_5A320(__int16 a1)
{
  UWORD itemIndex; // cx
  void *ShapeTable_sub_1B084; // eax

  switch ( a1 )
  {
    case 1:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\1starmap.tmp", TRUE);
      goto LABEL_12;
    case 2:
    case 4:
    case 0xA:
    case 0xE:
    case 0xF:
    case 0x12:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\10status.tmp", TRUE);
      goto LABEL_12;
    case 3:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\3cfgnew.tmp", TRUE);
      goto LABEL_12;
    case 7:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\7racesel.tmp", TRUE);
      goto LABEL_12;
    case 8:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\8shipdes.tmp", TRUE);
      goto LABEL_12;
    case 9:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\9ENDGAME.tmp", TRUE);
      goto LABEL_12;
    case 0xC:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\12start.tmp", TRUE);
      goto LABEL_12;
    case 0xD:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\13negot.tmp", TRUE);
      goto LABEL_12;
    case 0x10:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\16battle.tmp", TRUE);
      goto LABEL_12;
    case 0x14:
      itemIndex = Q_Cache_GetItemIndex_sub_1B270(&WinMgr.cache, "DATA\\20res.tmp", TRUE);
LABEL_12:
      if ( itemIndex == 0xFFFF )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1168);
      }
      ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, itemIndex);
      VFX_shape_draw(&V_Type6_stru_D8654.pane, ShapeTable_sub_1B084, 0, 0, 0);
      break;
    default:
      return;
  }
}

//----- (0005A47C) --------------------------------------------------------
int __fastcall sub_5A47C(T_Type5 *a1, const char *a2, int a3, int a4)
{
  __int16 v5; // ax
  T_Rect *p_rect; // esi
  WORD v8; // [esp+2h] [ebp-10h]

  v5 = 0xF2;
  v8 = word_96BC4[a3];
  if ( a4 == 0xFFFFFFFF )
  {
    v5 = 0x96;
  }
  VFX_pane_wipe((PANE *)a1, v5);
  WinMgr.LargeFont.pane.window = &a1->a->window;
  p_rect = &a1->rect;
  WinMgr.LargeFont.pane.x0 = p_rect->x1;
  p_rect = (T_Rect *)((char *)p_rect + 4);
  WinMgr.LargeFont.pane.y0 = p_rect->x1;
  p_rect = (T_Rect *)((char *)p_rect + 4);
  WinMgr.LargeFont.pane.x1 = p_rect->x1;
  WinMgr.LargeFont.pane.y1 = p_rect->y1;
  return Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, a2, 0x40, v8, 0xFF, 0);
}
// 96BC4: using guessed type __int16 word_96BC4[8];

//----- (0005A4E4) --------------------------------------------------------
LONG __fastcall sub_5A4E4(_DWORD *a1, LONG a2, int a3, int a4)
{
  WORD v5; // bx
  WORD v6; // ax
  PANE v8; // [esp+0h] [ebp-30h] BYREF
  char s[12]; // [esp+14h] [ebp-1Ch] BYREF
  LONG color; // [esp+20h] [ebp-10h]

  v5 = 0xF3;
  color = a2;
  sprintf(s, "%03d", a2);
  v6 = 0xF2;
  if ( a2 == *(_DWORD *)&dword_132B10 )
  {
    v6 = 0xFE;
    v5 = 0;
  }
  if ( a4 )
  {
    v6 = 0xF1;
  }
  WinMgr.LargeFont.pane = *(PANE *)a1;
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, s, 0x40, v5, v6, 0);
  v8 = *(PANE *)a1;
  v8.x0 += 0x23;
  --v8.y1;
  ++v8.y0;
  return VFX_pane_wipe(&v8, color);
}

//----- (0005A594) --------------------------------------------------------
void __fastcall __spoils<> Q_Wnd13DBGWNDCtor_sub_5A594(P_Wnd13DBGWND a1)
{
  Q_A2Ctor_sub_2C830(&a1->a2);
  a1->a2.pProcs = (P_Procs)&off_961AC;
}
// 961AC: using guessed type int (__fastcall *off_961AC)(P_WndA2 a1);

//----- (0005A5AC) --------------------------------------------------------
T_WndA2 *__fastcall Q_Wnd13DBGWNDDtor_sub_5A5AC(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, &C_Wnd13DBGWND);
    operator delete[](v4);
    return a1;
  }
  else
  {
    a1->pProcs = (P_Procs)&off_961AC;
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);
// 961AC: using guessed type int (__fastcall *off_961AC)(P_WndA2 a1);

//----- (0005A5F4) --------------------------------------------------------
void __fastcall Q_WINMGR_CPP_RegisterWindow_sub_5A5F4(P_Wnd a1)
{
  a1->index = Q_WinMgr_RegisterWindow_sub_571B8(&WinMgr, a1);
}

//----- (0005A60C) --------------------------------------------------------
int __fastcall sub_5A60C(int a1, __int16 a2, __int16 a3, LONG a4)
{
  T_Wnd10LB *Wnd_sub_56DA8; // eax
  T_Wnd10LB *v7; // ecx
  T_Wnd10LB *v8; // eax
  T_Wnd10LB *v9; // ecx
  T_Wnd10LB *v10; // eax
  T_Wnd10LB *v11; // ecx
  T_Wnd10LB *v12; // eax
  T_Wnd10LB *v13; // ecx
  T_Wnd10LB *v14; // eax
  T_Wnd10LB *v15; // ecx
  char v16; // ah
  T_Wnd10LB *v17; // eax
  T_Wnd10LB *v18; // eax
  T_Wnd10LB *v19; // ecx

  if ( (unsigned __int16)a2 < 0x3EBu )
  {
    if ( (unsigned __int16)a2 < 0xC8u )
    {
      if ( a2 && ((unsigned __int16)a2 <= 2u || (unsigned __int16)a2 >= 6u && (unsigned __int16)a2 <= 7u) )
      {
        return Q_WndA2_Proc3_sub_2F424((P_WndA2)a1, a2, a3, a4);
      }
      return 0;
    }
    if ( (unsigned __int16)a2 <= 0xC8u )
    {
      *(_BYTE *)(a1 + 0xBF) = 0;
      Wnd_sub_56DA8 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
      v7 = Wnd_sub_56DA8;
      if ( !Wnd_sub_56DA8 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x11D1);
      }
      sub_2ED4C(Wnd_sub_56DA8);
      v7->Unknown_AB = 0xFFFFFFFF;
      Q_Wnd10LB_SetProc1_sub_2F1C8(v7, sub_5A47C);
      if ( !v7->Unknown_8E6 && !sub_2F228((int)v7, 0x2000u, 0) )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x11D9);
      }
      sub_5AE68(a1, v7);
      return 0;
    }
    else if ( (unsigned __int16)a2 <= 0xCAu )
    {
      Q_WinMgr_QueueMessage_sub_56B60(&WinMgr, 6, a2, 0);
      return 0xFFFFFFFF;
    }
    else if ( a2 == 0x3EA )
    {
      if ( *(_BYTE *)(a1 + 0xBF) )
      {
        *(_BYTE *)(a1 + 0xBF) = 0;
        v8 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
        v9 = v8;
        if ( !v8 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x11F0);
        }
        v8->Unknown_AB = 0xFFFFFFFF;
        Q_Wnd10LB_SetProc1_sub_2F1C8(v8, sub_5A47C);
        sub_2ED4C(v8);
        sub_5AE68(a1, v9);
        (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
      }
      return 0xFFFFFFFF;
    }
    else
    {
      return 0;
    }
  }
  else if ( (unsigned __int16)a2 <= 0x3EBu )
  {
    if ( *(_BYTE *)(a1 + 0xBF) != 1 )
    {
      *(_BYTE *)(a1 + 0xBF) = 1;
      v10 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
      v11 = v10;
      if ( !v10 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1204);
      }
      v10->Unknown_AB = 0xFFFFFFFF;
      Q_Wnd10LB_SetProc1_sub_2F1C8(v10, sub_5A47C);
      sub_2ED4C(v10);
      sub_5AB2C(a1, v11);
      (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
    }
    return 0xFFFFFFFF;
  }
  else if ( (unsigned __int16)a2 < 0x3EEu )
  {
    if ( (unsigned __int16)a2 <= 0x3ECu )
    {
      if ( *(_BYTE *)(a1 + 0xBF) != 2 )
      {
        *(_BYTE *)(a1 + 0xBF) = 2;
        v12 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
        v13 = v12;
        if ( !v12 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1218);
        }
        v12->Unknown_AB = 0xFFFFFFFF;
        Q_Wnd10LB_SetProc1_sub_2F1C8(v12, sub_5A47C);
        sub_2ED4C(v12);
        sub_5AF30(a1, v13);
        (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
      }
      return 0xFFFFFFFF;
    }
    else
    {
      if ( *(_BYTE *)(a1 + 0xBF) != 3 )
      {
        *(_BYTE *)(a1 + 0xBF) = 3;
        v18 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
        v19 = v18;
        if ( !v18 )
        {
          Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x122B);
        }
        v18->Unknown_AB = 0;
        Q_Wnd10LB_SetProc1_sub_2F1C8(v18, sub_5A4E4);
        sub_2ED4C(v18);
        sub_5B200(a1, v19);
        (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
      }
      return 0xFFFFFFFF;
    }
  }
  else
  {
    if ( (unsigned __int16)a2 > 0x3EEu )
    {
      if ( (unsigned __int16)a2 >= 0x3F1u )
      {
        if ( (unsigned __int16)a2 <= 0x3F1u )
        {
          if ( *(_BYTE *)(a1 + 0xBF) == 3 )
          {
            v17 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
            if ( !v17 )
            {
              Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x1262);
            }
            sub_2ECDC(v17, dword_132B10);
            (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
          }
          return 0xFFFFFFFF;
        }
        else if ( a2 == 0x1C01 )
        {
          v16 = *(_BYTE *)(a1 + 0xBF);
          if ( v16 == 3 )
          {
            if ( a4 == 5 )
            {
              (*WinMgr.hazeTableMapFocus)[0xF2] = a3;
            }
          }
          else if ( v16 == 4 )
          {
            sub_4F8CC(&V_SoundSystem, a3, 0);
          }
          return 0xFFFFFFFF;
        }
        else
        {
          return 0;
        }
      }
      return 0;
    }
    if ( *(_BYTE *)(a1 + 0xBF) != 4 )
    {
      *(_BYTE *)(a1 + 0xBF) = 4;
      v14 = (T_Wnd10LB *)Q_FindWnd_sub_56DA8(&WinMgr, "DBGWNDLIST", 0);
      v15 = v14;
      if ( !v14 )
      {
        Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x123E);
      }
      v14->Unknown_AB = 0xFFFFFFFF;
      Q_Wnd10LB_SetProc1_sub_2F1C8(v14, sub_5A47C);
      sub_2ED4C(v14);
      sub_5B244(a1, v15);
      (*(void (__fastcall **)(int, _DWORD))(*(_DWORD *)(a1 + 0xA7) + 0xC))(a1, 0);
    }
    return 0xFFFFFFFF;
  }
}

//----- (0005AA08) --------------------------------------------------------
void __fastcall sub_5AA08(int a1)
{
  void *ShapeTable_sub_1B084; // eax
  char v2; // dl
  const char *v3; // esi
  char v4[20]; // [esp+0h] [ebp-18h] BYREF
  _DWORD *v5; // [esp+14h] [ebp-4h]

  v5 = (_DWORD *)a1;
  ShapeTable_sub_1B084 = Q_Cache_GetShapeTable_sub_1B084(&WinMgr.cache, *(_WORD *)(a1 + 0x18));
  VFX_shape_draw((PANE *)(v5 + 1), ShapeTable_sub_1B084, 0, 0, 0);
  VFX_pane_wipe((PANE *)((char *)v5 + 0xAB), 0xF2);
  v2 = *((_BYTE *)v5 + 0xBF);
  if ( v2 )
  {
    if ( v2 == 1 )
    {
      v3 = "MEMORY    ";
    }
    else if ( v2 == 2 )
    {
      v3 = "CACHE     ";
    }
    else
    {
      v3 = "PALETTE   ";
    }
  }
  else
  {
    v3 = "WINDOWS   ";
  }
  strcpy(v4, v3);
  sub_2B3E0(
    &WinMgr.LargeFont,
    *(_DWORD *)((char *)v5 + 0xAF),
    *(_DWORD *)((char *)v5 + 0xB3),
    *(_DWORD *)((char *)v5 + 0xB7),
    *(_DWORD *)((char *)v5 + 0xB3) + 0x32);
  Q_Font_DrawFormattedText_sub_2B8A8(&WinMgr.LargeFont, 1, 1, v4, 0, 0xFFFF, 0xFFFF, 0);
  sub_2D218(v5);
}
// 5AA08: using guessed type char var_18[20];

//----- (0005AB04) --------------------------------------------------------
int __fastcall sub_5AB04(const char **a1, const char **a2)
{
  return strncmp(*a1, *a2, 6u);
}

//----- (0005AB2C) --------------------------------------------------------
void __fastcall sub_5AB2C(int a1, T_Wnd10LB *a2)
{
  int v2; // ebp
  int v3; // edi
  char *v4; // eax
  unsigned __int16 v5; // ax
  __int16 v6; // cx
  unsigned __int16 v7; // ax
  int v8; // edi
  unsigned __int16 v9; // ax
  unsigned __int16 v10; // ax
  int v11; // ecx
  unsigned __int16 v12; // ax
  int v13; // edi
  unsigned __int16 v14; // ax
  unsigned __int16 v15; // ax
  unsigned __int16 v16; // ax
  char s[80]; // [esp+0h] [ebp-98h] BYREF
  struct _heapinfo v18; // [esp+50h] [ebp-48h] BYREF
  int v19; // [esp+60h] [ebp-38h] BYREF
  int v20; // [esp+64h] [ebp-34h] BYREF
  int v21; // [esp+68h] [ebp-30h]
  int v22; // [esp+6Ch] [ebp-2Ch]
  int v23; // [esp+70h] [ebp-28h]
  int v24; // [esp+74h] [ebp-24h]
  int v25; // [esp+78h] [ebp-20h]
  int v26; // [esp+7Ch] [ebp-1Ch]
  __int16 v27; // [esp+80h] [ebp-18h]

  *(_BYTE *)(a1 + 0xBF) = 1;
  v23 = 0;
  LOWORD(v25) = 0;
  if ( heapchk() )
  {
    Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x12A9);
  }
  LOWORD(v24) = 0;
  v27 = 0;
  LOWORD(v26) = 0;
  v21 = 0;
  v22 = 0;
  v2 = 0;
  HIWORD(v18._pentry) = 0;
  LODWORD(v18._pentry) = 0;
  while ( !heapwalk(&v18) )
  {
    if ( v18._useflag )
    {
      v2 += v18._size;
    }
    else
    {
      v3 = LODWORD(v18._pentry) + 4;
      v4 = sub_5A194((int)&WinMgr, LODWORD(v18._pentry) + 4, &v19, &v20);
      if ( v4 )
      {
        switch ( v19 )
        {
          case 1:
          case 4:
          case 5:
            sprintf(s, "%06lu S%07lu %s", v20, v18._size, v4);
            v9 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
            Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v9, v19);
            break;
          case 2:
            sprintf(s, "%06lu S%07lu WND[%s]", v20, v18._size, (const char *)(v3 + 0x20));
            v5 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
            v6 = v24;
            Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v5, v19);
            LOWORD(v24) = v6 + 1;
            v21 += v18._size;
            break;
          case 3:
            sprintf(s, "%06lu S%07lu %s", v20, v18._size, v4);
            v7 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
            v8 = v23;
            Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v7, v19);
            v23 = v18._size + v8;
            LOWORD(v25) = v25 + 1;
            break;
          default:
            Q_AssertLogBreakExit_sub_261A8(0, "..\\winmgr.cpp", 0x12E3);
            break;
        }
      }
      else
      {
        ++v27;
      }
      v22 += v18._size;
      LOWORD(v26) = v26 + 1;
    }
  }
  sprintf(s, "** %d WNDS USING %lu BYTES", (__int16)v24, v21);
  v10 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  v11 = v23;
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v10, 0);
  sprintf(s, "** %d SHAPES USING %lu BYTES", (__int16)v25, v11);
  v12 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  v13 = v22;
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v12, 0);
  sprintf(s, "** %d ITEMS IN HEAP USE %lu BYTES", (__int16)v26, v13);
  v14 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v14, 0);
  sprintf(s, "** %d ITEMS ARE UNIDENTIFIED", v27);
  v15 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v15, 0);
  sprintf(s, "** TOTAL FREE IN HEAP %lu BYTES", v2);
  v16 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v16, 0);
  Q_Wnd10LB_SetCompareProc_sub_2F1D8(a2, sub_5AB04);
  Q_Wnd10LB_SortItemsWithCompareProc_sub_2F1E0(a2);
}

//----- (0005AE68) --------------------------------------------------------
int __fastcall sub_5AE68(int a1, T_Wnd10LB *a2)
{
  int state; // edx
  __int16 v4; // si
  WORD windowCount; // di
  int result; // eax
  int v7; // eax
  T_WndA2 *pWndA2; // edx
  char v9; // bl
  char s[72]; // [esp+0h] [ebp-48h] BYREF

  state = WinMgr.state;
  *(_BYTE *)(a1 + 0xBF) = 0;
  v4 = 0x1F;
  windowCount = WinMgr.winStates[state]._windowCount;
  while ( 1 )
  {
    result = windowCount;
    if ( windowCount <= 0 )
    {
      break;
    }
    if ( v4 < 0 )
    {
      Q_AssertLogBreakExit_sub_26198(0, "..\\winmgr.cpp", 0x131E);
    }
    v7 = WinMgr.winStates[WinMgr.state]._wndIndexes[v4];
    if ( v7 )
    {
      pWndA2 = WinMgr.wnds[v7].pWndA2;
      if ( pWndA2->a1.parentIndex )
      {
        v9 = 0x43;
      }
      else
      {
        v9 = 0x20;
      }
      sprintf(s, "%c HWND%03d %s", v9, v7, pWndA2->a1.name);
      --windowCount;
      Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
    }
    --v4;
  }
  return result;
}

//----- (0005AF30) --------------------------------------------------------
MACRO_VFX_BOOL __fastcall sub_5AF30(int a1, T_Wnd10LB *a2)
{
  int v3; // edi
  int v4; // edx
  unsigned __int16 v5; // ax
  int v6; // ecx
  T_Cache *v7; // kr08_4
  T_Cache *v8; // kr18_4
  int v9; // edx
  unsigned __int16 v10; // ax
  unsigned __int16 v11; // ax
  unsigned __int16 v12; // ax
  unsigned __int16 v13; // ax
  unsigned __int16 v14; // ax
  unsigned __int16 v15; // dx
  int v17; // kr04_4
  int i; // ebp
  char s[100]; // [esp+0h] [ebp-94h] BYREF
  T_Cache *v20; // [esp+64h] [ebp-30h]
  T_Cache *names; // [esp+68h] [ebp-2Ch]
  T_Cache *v22; // [esp+6Ch] [ebp-28h]
  T_Cache *p_cache; // [esp+70h] [ebp-24h]
  T_Cache *v24; // [esp+74h] [ebp-20h]
  T_Cache *v25; // [esp+78h] [ebp-1Ch]
  int v26; // [esp+7Ch] [ebp-18h]

  v3 = 0;
  p_cache = &WinMgr.cache;
  v26 = 0;
  names = (T_Cache *)WinMgr.cache.names;
  v24 = &WinMgr.cache;
  v17 = 0;
  while ( p_cache->activeCount > v26 )
  {
    sprintf(
      s,
      "%07d %s",
      WinMgr.cache.sizes[(unsigned __int16)WinMgr.cache.usageOrder[v17]],
      (const char *)names + 0x32 * (unsigned __int16)WinMgr.cache.usageOrder[v17]);
    v4 = WinMgr.cache.sizes[v17];
    strupr(s);
    v3 += v4;
    v5 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
    v6 = v26;
    Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v5, 1);
    v26 = v6 + 1;
    ++v17;
  }
  Q_Wnd10LB_AddItem_sub_2EA8C(a2, " ", 0xFFFFFFFF, 0);
  v22 = (T_Cache *)p_cache->names;
  v20 = p_cache;
  v7 = p_cache;
  v25 = p_cache;
  v8 = p_cache;
  for ( i = 0; i < 0xC8; ++i )
  {
    if ( v7->names[i][0] )
    {
      sprintf(s, "%s", (const char *)v22 + 0x32 * i);
      v9 = v8->sizes[i];
      strupr(s);
      v3 += v9;
      v10 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
      Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v10, 0);
    }
  }
  Q_Wnd10LB_AddItem_sub_2EA8C(a2, " ", 0xFFFFFFFF, 0);
  sprintf(s, "%03d ITEMS IN CACHE", p_cache->count);
  v11 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v11, 0);
  sprintf(s, "%03d ITEMS LOADED", p_cache->activeCount);
  v12 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v12, 0);
  Q_Wnd10LB_AddItem_sub_2EA8C(a2, " ", 0xFFFFFFFF, 0);
  sprintf(s, "%07d TOTAL CACHE SIZE", p_cache->size);
  v13 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v13, 0);
  sprintf(s, "%07d USED", v3);
  v14 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v14, 0);
  sprintf(s, "%07d FREE", p_cache->size - v3);
  v15 = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0);
  return Q_Wnd10LB_SetItemValue_sub_2EC50(a2, v15, 0);
}

//----- (0005B200) --------------------------------------------------------
int __fastcall sub_5B200(int a1, T_Wnd10LB *a2)
{
  __int16 i; // si
  int result; // eax

  *(_BYTE *)(a1 + 0xBF) = 3;
  for ( i = 0; i < 0x100; result = Q_Wnd10LB_AddItem_sub_2EA8C(a2, (BYTE *)i++, 0xFFFFFFFF, 0) )
  {
    ;
  }
  return result;
}

//----- (0005B244) --------------------------------------------------------
int __fastcall sub_5B244(int result, T_Wnd10LB *a2)
{
  int i; // esi
  char s[96]; // [esp+0h] [ebp-60h] BYREF

  *(_BYTE *)(result + 0xBF) = 4;
  for ( i = 0; (__int16)i < V_SoundSystem.tracks; result = Q_Wnd10LB_AddItem_sub_2EA8C(a2, s, 0xFFFFFFFF, 0) )
  {
    sprintf(s, "%02d. %-24s (%d)", (__int16)i, V_SoundSystem.files[(__int16)i].fname, V_SoundSystem.files[(__int16)i].fpos);
    ++i;
  }
  return result;
}

//----- (0005B2B0) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B2B0(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_96184);
    operator delete[](v4);
    return a1;
  }
  else
  {
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0005B2F0) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B2F0(T_WndA2 *result)
{
  Q_A2Ctor_sub_2C830(result);
  result->pProcs = (P_Procs)&off_961C4;
  return result;
}
// 961C4: using guessed type int (__fastcall *off_961C4)(P_WndA2 a1);

//----- (0005B300) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B300(T_WndA2 *a1, char a2)
{
  char *v4; // eax

  if ( (a2 & 4) != 0 )
  {
    v4 = _wcpp_2_dtor_array_store_(a1, (rt_type_sig_clss *)&unk_96198);
    operator delete[](v4);
    return a1;
  }
  else
  {
    Q_A2Dtor_sub_2C848(a1, 1);
    if ( (a2 & 2) != 0 )
    {
      operator delete(a1);
    }
    return a1;
  }
}
// 76D5C: using guessed type void __fastcall operator delete[](void *);
// 76D64: using guessed type void __fastcall operator delete(void *);

//----- (0005B340) --------------------------------------------------------
T_WndA2 *__fastcall sub_5B340(T_WndA2 *result)
{
  Q_A2Ctor_sub_2C830(result);
  result->pProcs = (P_Procs)&off_961DC;
  return result;
}
// 961DC: using guessed type int (__fastcall *off_961DC)(P_WndA2 a1);

// nfuncs=1992 queued=822 decompiled=822 lumina nreq=0 worse=0 better=0
#error "There were 1 decompilation failure(s) on 822 function(s)"
